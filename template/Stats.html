<!--
# 
# Py-Phisher - A simple script for basic phishing by https://github.com/1mm0rt41PC
#
# Filename: Stats.html
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; see the file COPYING. If not, write to the
# Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr" >
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, user-scalable=yes" />
	<title>%date%_PhishingStats_%client%</title>
<!--<script type="text/javascript" src="Chart.bundle.js"></script>-->
<script type="text/javascript" src="data:text/javascript;base64,LyohCiAqIENoYXJ0LmpzCiAqIGh0dHA6Ly9jaGFydGpzLm9yZy8KICogVmVyc2lvbjogMi43LjIKICoKICogQ29weXJpZ2h0IDIwMTggQ2hhcnQuanMgQ29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogKiBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9ibG9iL21hc3Rlci9MSUNFTlNFLm1kCiAqLwooZnVuY3Rpb24oZil7aWYodHlwZW9mIGV4cG9ydHM9PT0ib2JqZWN0IiYmdHlwZW9mIG1vZHVsZSE9PSJ1bmRlZmluZWQiKXttb2R1bGUuZXhwb3J0cz1mKCl9ZWxzZSBpZih0eXBlb2YgZGVmaW5lPT09ImZ1bmN0aW9uIiYmZGVmaW5lLmFtZCl7ZGVmaW5lKFtdLGYpfWVsc2V7dmFyIGc7aWYodHlwZW9mIHdpbmRvdyE9PSJ1bmRlZmluZWQiKXtnPXdpbmRvd31lbHNlIGlmKHR5cGVvZiBnbG9iYWwhPT0idW5kZWZpbmVkIil7Zz1nbG9iYWx9ZWxzZSBpZih0eXBlb2Ygc2VsZiE9PSJ1bmRlZmluZWQiKXtnPXNlbGZ9ZWxzZXtnPXRoaXN9Zy5DaGFydCA9IGYoKX19KShmdW5jdGlvbigpe3ZhciBkZWZpbmUsbW9kdWxlLGV4cG9ydHM7cmV0dXJuIChmdW5jdGlvbigpe2Z1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpO3Rocm93IGYuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9cmV0dXJuIGV9KSgpKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyogTUlUIGxpY2Vuc2UgKi8KdmFyIGNvbG9yTmFtZXMgPSByZXF1aXJlKDUpOwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgIGdldFJnYmE6IGdldFJnYmEsCiAgIGdldEhzbGE6IGdldEhzbGEsCiAgIGdldFJnYjogZ2V0UmdiLAogICBnZXRIc2w6IGdldEhzbCwKICAgZ2V0SHdiOiBnZXRId2IsCiAgIGdldEFscGhhOiBnZXRBbHBoYSwKCiAgIGhleFN0cmluZzogaGV4U3RyaW5nLAogICByZ2JTdHJpbmc6IHJnYlN0cmluZywKICAgcmdiYVN0cmluZzogcmdiYVN0cmluZywKICAgcGVyY2VudFN0cmluZzogcGVyY2VudFN0cmluZywKICAgcGVyY2VudGFTdHJpbmc6IHBlcmNlbnRhU3RyaW5nLAogICBoc2xTdHJpbmc6IGhzbFN0cmluZywKICAgaHNsYVN0cmluZzogaHNsYVN0cmluZywKICAgaHdiU3RyaW5nOiBod2JTdHJpbmcsCiAgIGtleXdvcmQ6IGtleXdvcmQKfQoKZnVuY3Rpb24gZ2V0UmdiYShzdHJpbmcpIHsKICAgaWYgKCFzdHJpbmcpIHsKICAgICAgcmV0dXJuOwogICB9CiAgIHZhciBhYmJyID0gIC9eIyhbYS1mQS1GMC05XXszfSkkL2ksCiAgICAgICBoZXggPSAgL14jKFthLWZBLUYwLTldezZ9KSQvaSwKICAgICAgIHJnYmEgPSAvXnJnYmE/XChccyooWystXT9cZCspXHMqLFxzKihbKy1dP1xkKylccyosXHMqKFsrLV0/XGQrKVxzKig/OixccyooWystXT9bXGRcLl0rKVxzKik/XCkkL2ksCiAgICAgICBwZXIgPSAvXnJnYmE/XChccyooWystXT9bXGRcLl0rKVwlXHMqLFxzKihbKy1dP1tcZFwuXSspXCVccyosXHMqKFsrLV0/W1xkXC5dKylcJVxzKig/OixccyooWystXT9bXGRcLl0rKVxzKik/XCkkL2ksCiAgICAgICBrZXl3b3JkID0gLyhcdyspLzsKCiAgIHZhciByZ2IgPSBbMCwgMCwgMF0sCiAgICAgICBhID0gMSwKICAgICAgIG1hdGNoID0gc3RyaW5nLm1hdGNoKGFiYnIpOwogICBpZiAobWF0Y2gpIHsKICAgICAgbWF0Y2ggPSBtYXRjaFsxXTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZ2IubGVuZ3RoOyBpKyspIHsKICAgICAgICAgcmdiW2ldID0gcGFyc2VJbnQobWF0Y2hbaV0gKyBtYXRjaFtpXSwgMTYpOwogICAgICB9CiAgIH0KICAgZWxzZSBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2goaGV4KSkgewogICAgICBtYXRjaCA9IG1hdGNoWzFdOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJnYi5sZW5ndGg7IGkrKykgewogICAgICAgICByZ2JbaV0gPSBwYXJzZUludChtYXRjaC5zbGljZShpICogMiwgaSAqIDIgKyAyKSwgMTYpOwogICAgICB9CiAgIH0KICAgZWxzZSBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2gocmdiYSkpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZ2IubGVuZ3RoOyBpKyspIHsKICAgICAgICAgcmdiW2ldID0gcGFyc2VJbnQobWF0Y2hbaSArIDFdKTsKICAgICAgfQogICAgICBhID0gcGFyc2VGbG9hdChtYXRjaFs0XSk7CiAgIH0KICAgZWxzZSBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2gocGVyKSkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJnYi5sZW5ndGg7IGkrKykgewogICAgICAgICByZ2JbaV0gPSBNYXRoLnJvdW5kKHBhcnNlRmxvYXQobWF0Y2hbaSArIDFdKSAqIDIuNTUpOwogICAgICB9CiAgICAgIGEgPSBwYXJzZUZsb2F0KG1hdGNoWzRdKTsKICAgfQogICBlbHNlIGlmIChtYXRjaCA9IHN0cmluZy5tYXRjaChrZXl3b3JkKSkgewogICAgICBpZiAobWF0Y2hbMV0gPT0gInRyYW5zcGFyZW50IikgewogICAgICAgICByZXR1cm4gWzAsIDAsIDAsIDBdOwogICAgICB9CiAgICAgIHJnYiA9IGNvbG9yTmFtZXNbbWF0Y2hbMV1dOwogICAgICBpZiAoIXJnYikgewogICAgICAgICByZXR1cm47CiAgICAgIH0KICAgfQoKICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZ2IubGVuZ3RoOyBpKyspIHsKICAgICAgcmdiW2ldID0gc2NhbGUocmdiW2ldLCAwLCAyNTUpOwogICB9CiAgIGlmICghYSAmJiBhICE9IDApIHsKICAgICAgYSA9IDE7CiAgIH0KICAgZWxzZSB7CiAgICAgIGEgPSBzY2FsZShhLCAwLCAxKTsKICAgfQogICByZ2JbM10gPSBhOwogICByZXR1cm4gcmdiOwp9CgpmdW5jdGlvbiBnZXRIc2xhKHN0cmluZykgewogICBpZiAoIXN0cmluZykgewogICAgICByZXR1cm47CiAgIH0KICAgdmFyIGhzbCA9IC9eaHNsYT9cKFxzKihbKy1dP1xkKykoPzpkZWcpP1xzKixccyooWystXT9bXGRcLl0rKSVccyosXHMqKFsrLV0/W1xkXC5dKyklXHMqKD86LFxzKihbKy1dP1tcZFwuXSspXHMqKT9cKS87CiAgIHZhciBtYXRjaCA9IHN0cmluZy5tYXRjaChoc2wpOwogICBpZiAobWF0Y2gpIHsKICAgICAgdmFyIGFscGhhID0gcGFyc2VGbG9hdChtYXRjaFs0XSk7CiAgICAgIHZhciBoID0gc2NhbGUocGFyc2VJbnQobWF0Y2hbMV0pLCAwLCAzNjApLAogICAgICAgICAgcyA9IHNjYWxlKHBhcnNlRmxvYXQobWF0Y2hbMl0pLCAwLCAxMDApLAogICAgICAgICAgbCA9IHNjYWxlKHBhcnNlRmxvYXQobWF0Y2hbM10pLCAwLCAxMDApLAogICAgICAgICAgYSA9IHNjYWxlKGlzTmFOKGFscGhhKSA/IDEgOiBhbHBoYSwgMCwgMSk7CiAgICAgIHJldHVybiBbaCwgcywgbCwgYV07CiAgIH0KfQoKZnVuY3Rpb24gZ2V0SHdiKHN0cmluZykgewogICBpZiAoIXN0cmluZykgewogICAgICByZXR1cm47CiAgIH0KICAgdmFyIGh3YiA9IC9eaHdiXChccyooWystXT9cZCspKD86ZGVnKT9ccyosXHMqKFsrLV0/W1xkXC5dKyklXHMqLFxzKihbKy1dP1tcZFwuXSspJVxzKig/OixccyooWystXT9bXGRcLl0rKVxzKik/XCkvOwogICB2YXIgbWF0Y2ggPSBzdHJpbmcubWF0Y2goaHdiKTsKICAgaWYgKG1hdGNoKSB7CiAgICB2YXIgYWxwaGEgPSBwYXJzZUZsb2F0KG1hdGNoWzRdKTsKICAgICAgdmFyIGggPSBzY2FsZShwYXJzZUludChtYXRjaFsxXSksIDAsIDM2MCksCiAgICAgICAgICB3ID0gc2NhbGUocGFyc2VGbG9hdChtYXRjaFsyXSksIDAsIDEwMCksCiAgICAgICAgICBiID0gc2NhbGUocGFyc2VGbG9hdChtYXRjaFszXSksIDAsIDEwMCksCiAgICAgICAgICBhID0gc2NhbGUoaXNOYU4oYWxwaGEpID8gMSA6IGFscGhhLCAwLCAxKTsKICAgICAgcmV0dXJuIFtoLCB3LCBiLCBhXTsKICAgfQp9CgpmdW5jdGlvbiBnZXRSZ2Ioc3RyaW5nKSB7CiAgIHZhciByZ2JhID0gZ2V0UmdiYShzdHJpbmcpOwogICByZXR1cm4gcmdiYSAmJiByZ2JhLnNsaWNlKDAsIDMpOwp9CgpmdW5jdGlvbiBnZXRIc2woc3RyaW5nKSB7CiAgdmFyIGhzbGEgPSBnZXRIc2xhKHN0cmluZyk7CiAgcmV0dXJuIGhzbGEgJiYgaHNsYS5zbGljZSgwLCAzKTsKfQoKZnVuY3Rpb24gZ2V0QWxwaGEoc3RyaW5nKSB7CiAgIHZhciB2YWxzID0gZ2V0UmdiYShzdHJpbmcpOwogICBpZiAodmFscykgewogICAgICByZXR1cm4gdmFsc1szXTsKICAgfQogICBlbHNlIGlmICh2YWxzID0gZ2V0SHNsYShzdHJpbmcpKSB7CiAgICAgIHJldHVybiB2YWxzWzNdOwogICB9CiAgIGVsc2UgaWYgKHZhbHMgPSBnZXRId2Ioc3RyaW5nKSkgewogICAgICByZXR1cm4gdmFsc1szXTsKICAgfQp9CgovLyBnZW5lcmF0b3JzCmZ1bmN0aW9uIGhleFN0cmluZyhyZ2IpIHsKICAgcmV0dXJuICIjIiArIGhleERvdWJsZShyZ2JbMF0pICsgaGV4RG91YmxlKHJnYlsxXSkKICAgICAgICAgICAgICArIGhleERvdWJsZShyZ2JbMl0pOwp9CgpmdW5jdGlvbiByZ2JTdHJpbmcocmdiYSwgYWxwaGEpIHsKICAgaWYgKGFscGhhIDwgMSB8fCAocmdiYVszXSAmJiByZ2JhWzNdIDwgMSkpIHsKICAgICAgcmV0dXJuIHJnYmFTdHJpbmcocmdiYSwgYWxwaGEpOwogICB9CiAgIHJldHVybiAicmdiKCIgKyByZ2JhWzBdICsgIiwgIiArIHJnYmFbMV0gKyAiLCAiICsgcmdiYVsyXSArICIpIjsKfQoKZnVuY3Rpb24gcmdiYVN0cmluZyhyZ2JhLCBhbHBoYSkgewogICBpZiAoYWxwaGEgPT09IHVuZGVmaW5lZCkgewogICAgICBhbHBoYSA9IChyZ2JhWzNdICE9PSB1bmRlZmluZWQgPyByZ2JhWzNdIDogMSk7CiAgIH0KICAgcmV0dXJuICJyZ2JhKCIgKyByZ2JhWzBdICsgIiwgIiArIHJnYmFbMV0gKyAiLCAiICsgcmdiYVsyXQogICAgICAgICAgICsgIiwgIiArIGFscGhhICsgIikiOwp9CgpmdW5jdGlvbiBwZXJjZW50U3RyaW5nKHJnYmEsIGFscGhhKSB7CiAgIGlmIChhbHBoYSA8IDEgfHwgKHJnYmFbM10gJiYgcmdiYVszXSA8IDEpKSB7CiAgICAgIHJldHVybiBwZXJjZW50YVN0cmluZyhyZ2JhLCBhbHBoYSk7CiAgIH0KICAgdmFyIHIgPSBNYXRoLnJvdW5kKHJnYmFbMF0vMjU1ICogMTAwKSwKICAgICAgIGcgPSBNYXRoLnJvdW5kKHJnYmFbMV0vMjU1ICogMTAwKSwKICAgICAgIGIgPSBNYXRoLnJvdW5kKHJnYmFbMl0vMjU1ICogMTAwKTsKCiAgIHJldHVybiAicmdiKCIgKyByICsgIiUsICIgKyBnICsgIiUsICIgKyBiICsgIiUpIjsKfQoKZnVuY3Rpb24gcGVyY2VudGFTdHJpbmcocmdiYSwgYWxwaGEpIHsKICAgdmFyIHIgPSBNYXRoLnJvdW5kKHJnYmFbMF0vMjU1ICogMTAwKSwKICAgICAgIGcgPSBNYXRoLnJvdW5kKHJnYmFbMV0vMjU1ICogMTAwKSwKICAgICAgIGIgPSBNYXRoLnJvdW5kKHJnYmFbMl0vMjU1ICogMTAwKTsKICAgcmV0dXJuICJyZ2JhKCIgKyByICsgIiUsICIgKyBnICsgIiUsICIgKyBiICsgIiUsICIgKyAoYWxwaGEgfHwgcmdiYVszXSB8fCAxKSArICIpIjsKfQoKZnVuY3Rpb24gaHNsU3RyaW5nKGhzbGEsIGFscGhhKSB7CiAgIGlmIChhbHBoYSA8IDEgfHwgKGhzbGFbM10gJiYgaHNsYVszXSA8IDEpKSB7CiAgICAgIHJldHVybiBoc2xhU3RyaW5nKGhzbGEsIGFscGhhKTsKICAgfQogICByZXR1cm4gImhzbCgiICsgaHNsYVswXSArICIsICIgKyBoc2xhWzFdICsgIiUsICIgKyBoc2xhWzJdICsgIiUpIjsKfQoKZnVuY3Rpb24gaHNsYVN0cmluZyhoc2xhLCBhbHBoYSkgewogICBpZiAoYWxwaGEgPT09IHVuZGVmaW5lZCkgewogICAgICBhbHBoYSA9IChoc2xhWzNdICE9PSB1bmRlZmluZWQgPyBoc2xhWzNdIDogMSk7CiAgIH0KICAgcmV0dXJuICJoc2xhKCIgKyBoc2xhWzBdICsgIiwgIiArIGhzbGFbMV0gKyAiJSwgIiArIGhzbGFbMl0gKyAiJSwgIgogICAgICAgICAgICsgYWxwaGEgKyAiKSI7Cn0KCi8vIGh3YiBpcyBhIGJpdCBkaWZmZXJlbnQgdGhhbiByZ2IoYSkgJiBoc2woYSkgc2luY2UgdGhlcmUgaXMgbm8gYWxwaGEgc3BlY2lmaWMgc3ludGF4Ci8vIChod2IgaGF2ZSBhbHBoYSBvcHRpb25hbCAmIDEgaXMgZGVmYXVsdCB2YWx1ZSkKZnVuY3Rpb24gaHdiU3RyaW5nKGh3YiwgYWxwaGEpIHsKICAgaWYgKGFscGhhID09PSB1bmRlZmluZWQpIHsKICAgICAgYWxwaGEgPSAoaHdiWzNdICE9PSB1bmRlZmluZWQgPyBod2JbM10gOiAxKTsKICAgfQogICByZXR1cm4gImh3YigiICsgaHdiWzBdICsgIiwgIiArIGh3YlsxXSArICIlLCAiICsgaHdiWzJdICsgIiUiCiAgICAgICAgICAgKyAoYWxwaGEgIT09IHVuZGVmaW5lZCAmJiBhbHBoYSAhPT0gMSA/ICIsICIgKyBhbHBoYSA6ICIiKSArICIpIjsKfQoKZnVuY3Rpb24ga2V5d29yZChyZ2IpIHsKICByZXR1cm4gcmV2ZXJzZU5hbWVzW3JnYi5zbGljZSgwLCAzKV07Cn0KCi8vIGhlbHBlcnMKZnVuY3Rpb24gc2NhbGUobnVtLCBtaW4sIG1heCkgewogICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgobWluLCBudW0pLCBtYXgpOwp9CgpmdW5jdGlvbiBoZXhEb3VibGUobnVtKSB7CiAgdmFyIHN0ciA9IG51bS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICByZXR1cm4gKHN0ci5sZW5ndGggPCAyKSA/ICIwIiArIHN0ciA6IHN0cjsKfQoKCi8vY3JlYXRlIGEgbGlzdCBvZiByZXZlcnNlIGNvbG9yIG5hbWVzCnZhciByZXZlcnNlTmFtZXMgPSB7fTsKZm9yICh2YXIgbmFtZSBpbiBjb2xvck5hbWVzKSB7CiAgIHJldmVyc2VOYW1lc1tjb2xvck5hbWVzW25hbWVdXSA9IG5hbWU7Cn0KCn0seyI1Ijo1fV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIE1JVCBsaWNlbnNlICovCnZhciBjb252ZXJ0ID0gcmVxdWlyZSg0KTsKdmFyIHN0cmluZyA9IHJlcXVpcmUoMSk7Cgp2YXIgQ29sb3IgPSBmdW5jdGlvbiAob2JqKSB7CglpZiAob2JqIGluc3RhbmNlb2YgQ29sb3IpIHsKCQlyZXR1cm4gb2JqOwoJfQoJaWYgKCEodGhpcyBpbnN0YW5jZW9mIENvbG9yKSkgewoJCXJldHVybiBuZXcgQ29sb3Iob2JqKTsKCX0KCgl0aGlzLnZhbGlkID0gZmFsc2U7Cgl0aGlzLnZhbHVlcyA9IHsKCQlyZ2I6IFswLCAwLCAwXSwKCQloc2w6IFswLCAwLCAwXSwKCQloc3Y6IFswLCAwLCAwXSwKCQlod2I6IFswLCAwLCAwXSwKCQljbXlrOiBbMCwgMCwgMCwgMF0sCgkJYWxwaGE6IDEKCX07CgoJLy8gcGFyc2UgQ29sb3IoKSBhcmd1bWVudAoJdmFyIHZhbHM7CglpZiAodHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIHsKCQl2YWxzID0gc3RyaW5nLmdldFJnYmEob2JqKTsKCQlpZiAodmFscykgewoJCQl0aGlzLnNldFZhbHVlcygncmdiJywgdmFscyk7CgkJfSBlbHNlIGlmICh2YWxzID0gc3RyaW5nLmdldEhzbGEob2JqKSkgewoJCQl0aGlzLnNldFZhbHVlcygnaHNsJywgdmFscyk7CgkJfSBlbHNlIGlmICh2YWxzID0gc3RyaW5nLmdldEh3YihvYmopKSB7CgkJCXRoaXMuc2V0VmFsdWVzKCdod2InLCB2YWxzKTsKCQl9Cgl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICdvYmplY3QnKSB7CgkJdmFscyA9IG9iajsKCQlpZiAodmFscy5yICE9PSB1bmRlZmluZWQgfHwgdmFscy5yZWQgIT09IHVuZGVmaW5lZCkgewoJCQl0aGlzLnNldFZhbHVlcygncmdiJywgdmFscyk7CgkJfSBlbHNlIGlmICh2YWxzLmwgIT09IHVuZGVmaW5lZCB8fCB2YWxzLmxpZ2h0bmVzcyAhPT0gdW5kZWZpbmVkKSB7CgkJCXRoaXMuc2V0VmFsdWVzKCdoc2wnLCB2YWxzKTsKCQl9IGVsc2UgaWYgKHZhbHMudiAhPT0gdW5kZWZpbmVkIHx8IHZhbHMudmFsdWUgIT09IHVuZGVmaW5lZCkgewoJCQl0aGlzLnNldFZhbHVlcygnaHN2JywgdmFscyk7CgkJfSBlbHNlIGlmICh2YWxzLncgIT09IHVuZGVmaW5lZCB8fCB2YWxzLndoaXRlbmVzcyAhPT0gdW5kZWZpbmVkKSB7CgkJCXRoaXMuc2V0VmFsdWVzKCdod2InLCB2YWxzKTsKCQl9IGVsc2UgaWYgKHZhbHMuYyAhPT0gdW5kZWZpbmVkIHx8IHZhbHMuY3lhbiAhPT0gdW5kZWZpbmVkKSB7CgkJCXRoaXMuc2V0VmFsdWVzKCdjbXlrJywgdmFscyk7CgkJfQoJfQp9OwoKQ29sb3IucHJvdG90eXBlID0gewoJaXNWYWxpZDogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnZhbGlkOwoJfSwKCXJnYjogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnNldFNwYWNlKCdyZ2InLCBhcmd1bWVudHMpOwoJfSwKCWhzbDogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnNldFNwYWNlKCdoc2wnLCBhcmd1bWVudHMpOwoJfSwKCWhzdjogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnNldFNwYWNlKCdoc3YnLCBhcmd1bWVudHMpOwoJfSwKCWh3YjogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnNldFNwYWNlKCdod2InLCBhcmd1bWVudHMpOwoJfSwKCWNteWs6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5zZXRTcGFjZSgnY215aycsIGFyZ3VtZW50cyk7Cgl9LAoKCXJnYkFycmF5OiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHRoaXMudmFsdWVzLnJnYjsKCX0sCgloc2xBcnJheTogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnZhbHVlcy5oc2w7Cgl9LAoJaHN2QXJyYXk6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy52YWx1ZXMuaHN2OwoJfSwKCWh3YkFycmF5OiBmdW5jdGlvbiAoKSB7CgkJdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzOwoJCWlmICh2YWx1ZXMuYWxwaGEgIT09IDEpIHsKCQkJcmV0dXJuIHZhbHVlcy5od2IuY29uY2F0KFt2YWx1ZXMuYWxwaGFdKTsKCQl9CgkJcmV0dXJuIHZhbHVlcy5od2I7Cgl9LAoJY215a0FycmF5OiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHRoaXMudmFsdWVzLmNteWs7Cgl9LAoJcmdiYUFycmF5OiBmdW5jdGlvbiAoKSB7CgkJdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzOwoJCXJldHVybiB2YWx1ZXMucmdiLmNvbmNhdChbdmFsdWVzLmFscGhhXSk7Cgl9LAoJaHNsYUFycmF5OiBmdW5jdGlvbiAoKSB7CgkJdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzOwoJCXJldHVybiB2YWx1ZXMuaHNsLmNvbmNhdChbdmFsdWVzLmFscGhhXSk7Cgl9LAoJYWxwaGE6IGZ1bmN0aW9uICh2YWwpIHsKCQlpZiAodmFsID09PSB1bmRlZmluZWQpIHsKCQkJcmV0dXJuIHRoaXMudmFsdWVzLmFscGhhOwoJCX0KCQl0aGlzLnNldFZhbHVlcygnYWxwaGEnLCB2YWwpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWQ6IGZ1bmN0aW9uICh2YWwpIHsKCQlyZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdyZ2InLCAwLCB2YWwpOwoJfSwKCWdyZWVuOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgncmdiJywgMSwgdmFsKTsKCX0sCglibHVlOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgncmdiJywgMiwgdmFsKTsKCX0sCglodWU6IGZ1bmN0aW9uICh2YWwpIHsKCQlpZiAodmFsKSB7CgkJCXZhbCAlPSAzNjA7CgkJCXZhbCA9IHZhbCA8IDAgPyAzNjAgKyB2YWwgOiB2YWw7CgkJfQoJCXJldHVybiB0aGlzLnNldENoYW5uZWwoJ2hzbCcsIDAsIHZhbCk7Cgl9LAoJc2F0dXJhdGlvbjogZnVuY3Rpb24gKHZhbCkgewoJCXJldHVybiB0aGlzLnNldENoYW5uZWwoJ2hzbCcsIDEsIHZhbCk7Cgl9LAoJbGlnaHRuZXNzOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnaHNsJywgMiwgdmFsKTsKCX0sCglzYXR1cmF0aW9udjogZnVuY3Rpb24gKHZhbCkgewoJCXJldHVybiB0aGlzLnNldENoYW5uZWwoJ2hzdicsIDEsIHZhbCk7Cgl9LAoJd2hpdGVuZXNzOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnaHdiJywgMSwgdmFsKTsKCX0sCglibGFja25lc3M6IGZ1bmN0aW9uICh2YWwpIHsKCQlyZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdod2InLCAyLCB2YWwpOwoJfSwKCXZhbHVlOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnaHN2JywgMiwgdmFsKTsKCX0sCgljeWFuOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnY215aycsIDAsIHZhbCk7Cgl9LAoJbWFnZW50YTogZnVuY3Rpb24gKHZhbCkgewoJCXJldHVybiB0aGlzLnNldENoYW5uZWwoJ2NteWsnLCAxLCB2YWwpOwoJfSwKCXllbGxvdzogZnVuY3Rpb24gKHZhbCkgewoJCXJldHVybiB0aGlzLnNldENoYW5uZWwoJ2NteWsnLCAyLCB2YWwpOwoJfSwKCWJsYWNrOiBmdW5jdGlvbiAodmFsKSB7CgkJcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnY215aycsIDMsIHZhbCk7Cgl9LAoKCWhleFN0cmluZzogZnVuY3Rpb24gKCkgewoJCXJldHVybiBzdHJpbmcuaGV4U3RyaW5nKHRoaXMudmFsdWVzLnJnYik7Cgl9LAoJcmdiU3RyaW5nOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHN0cmluZy5yZ2JTdHJpbmcodGhpcy52YWx1ZXMucmdiLCB0aGlzLnZhbHVlcy5hbHBoYSk7Cgl9LAoJcmdiYVN0cmluZzogZnVuY3Rpb24gKCkgewoJCXJldHVybiBzdHJpbmcucmdiYVN0cmluZyh0aGlzLnZhbHVlcy5yZ2IsIHRoaXMudmFsdWVzLmFscGhhKTsKCX0sCglwZXJjZW50U3RyaW5nOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHN0cmluZy5wZXJjZW50U3RyaW5nKHRoaXMudmFsdWVzLnJnYiwgdGhpcy52YWx1ZXMuYWxwaGEpOwoJfSwKCWhzbFN0cmluZzogZnVuY3Rpb24gKCkgewoJCXJldHVybiBzdHJpbmcuaHNsU3RyaW5nKHRoaXMudmFsdWVzLmhzbCwgdGhpcy52YWx1ZXMuYWxwaGEpOwoJfSwKCWhzbGFTdHJpbmc6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gc3RyaW5nLmhzbGFTdHJpbmcodGhpcy52YWx1ZXMuaHNsLCB0aGlzLnZhbHVlcy5hbHBoYSk7Cgl9LAoJaHdiU3RyaW5nOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHN0cmluZy5od2JTdHJpbmcodGhpcy52YWx1ZXMuaHdiLCB0aGlzLnZhbHVlcy5hbHBoYSk7Cgl9LAoJa2V5d29yZDogZnVuY3Rpb24gKCkgewoJCXJldHVybiBzdHJpbmcua2V5d29yZCh0aGlzLnZhbHVlcy5yZ2IsIHRoaXMudmFsdWVzLmFscGhhKTsKCX0sCgoJcmdiTnVtYmVyOiBmdW5jdGlvbiAoKSB7CgkJdmFyIHJnYiA9IHRoaXMudmFsdWVzLnJnYjsKCQlyZXR1cm4gKHJnYlswXSA8PCAxNikgfCAocmdiWzFdIDw8IDgpIHwgcmdiWzJdOwoJfSwKCglsdW1pbm9zaXR5OiBmdW5jdGlvbiAoKSB7CgkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvV0NBRzIwLyNyZWxhdGl2ZWx1bWluYW5jZWRlZgoJCXZhciByZ2IgPSB0aGlzLnZhbHVlcy5yZ2I7CgkJdmFyIGx1bSA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgcmdiLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBjaGFuID0gcmdiW2ldIC8gMjU1OwoJCQlsdW1baV0gPSAoY2hhbiA8PSAwLjAzOTI4KSA/IGNoYW4gLyAxMi45MiA6IE1hdGgucG93KCgoY2hhbiArIDAuMDU1KSAvIDEuMDU1KSwgMi40KTsKCQl9CgkJcmV0dXJuIDAuMjEyNiAqIGx1bVswXSArIDAuNzE1MiAqIGx1bVsxXSArIDAuMDcyMiAqIGx1bVsyXTsKCX0sCgoJY29udHJhc3Q6IGZ1bmN0aW9uIChjb2xvcjIpIHsKCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9XQ0FHMjAvI2NvbnRyYXN0LXJhdGlvZGVmCgkJdmFyIGx1bTEgPSB0aGlzLmx1bWlub3NpdHkoKTsKCQl2YXIgbHVtMiA9IGNvbG9yMi5sdW1pbm9zaXR5KCk7CgkJaWYgKGx1bTEgPiBsdW0yKSB7CgkJCXJldHVybiAobHVtMSArIDAuMDUpIC8gKGx1bTIgKyAwLjA1KTsKCQl9CgkJcmV0dXJuIChsdW0yICsgMC4wNSkgLyAobHVtMSArIDAuMDUpOwoJfSwKCglsZXZlbDogZnVuY3Rpb24gKGNvbG9yMikgewoJCXZhciBjb250cmFzdFJhdGlvID0gdGhpcy5jb250cmFzdChjb2xvcjIpOwoJCWlmIChjb250cmFzdFJhdGlvID49IDcuMSkgewoJCQlyZXR1cm4gJ0FBQSc7CgkJfQoKCQlyZXR1cm4gKGNvbnRyYXN0UmF0aW8gPj0gNC41KSA/ICdBQScgOiAnJzsKCX0sCgoJZGFyazogZnVuY3Rpb24gKCkgewoJCS8vIFlJUSBlcXVhdGlvbiBmcm9tIGh0dHA6Ly8yNHdheXMub3JnLzIwMTAvY2FsY3VsYXRpbmctY29sb3ItY29udHJhc3QKCQl2YXIgcmdiID0gdGhpcy52YWx1ZXMucmdiOwoJCXZhciB5aXEgPSAocmdiWzBdICogMjk5ICsgcmdiWzFdICogNTg3ICsgcmdiWzJdICogMTE0KSAvIDEwMDA7CgkJcmV0dXJuIHlpcSA8IDEyODsKCX0sCgoJbGlnaHQ6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gIXRoaXMuZGFyaygpOwoJfSwKCgluZWdhdGU6IGZ1bmN0aW9uICgpIHsKCQl2YXIgcmdiID0gW107CgkJZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspIHsKCQkJcmdiW2ldID0gMjU1IC0gdGhpcy52YWx1ZXMucmdiW2ldOwoJCX0KCQl0aGlzLnNldFZhbHVlcygncmdiJywgcmdiKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJbGlnaHRlbjogZnVuY3Rpb24gKHJhdGlvKSB7CgkJdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKCQloc2xbMl0gKz0gaHNsWzJdICogcmF0aW87CgkJdGhpcy5zZXRWYWx1ZXMoJ2hzbCcsIGhzbCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWRhcmtlbjogZnVuY3Rpb24gKHJhdGlvKSB7CgkJdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKCQloc2xbMl0gLT0gaHNsWzJdICogcmF0aW87CgkJdGhpcy5zZXRWYWx1ZXMoJ2hzbCcsIGhzbCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNhdHVyYXRlOiBmdW5jdGlvbiAocmF0aW8pIHsKCQl2YXIgaHNsID0gdGhpcy52YWx1ZXMuaHNsOwoJCWhzbFsxXSArPSBoc2xbMV0gKiByYXRpbzsKCQl0aGlzLnNldFZhbHVlcygnaHNsJywgaHNsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGVzYXR1cmF0ZTogZnVuY3Rpb24gKHJhdGlvKSB7CgkJdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKCQloc2xbMV0gLT0gaHNsWzFdICogcmF0aW87CgkJdGhpcy5zZXRWYWx1ZXMoJ2hzbCcsIGhzbCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXdoaXRlbjogZnVuY3Rpb24gKHJhdGlvKSB7CgkJdmFyIGh3YiA9IHRoaXMudmFsdWVzLmh3YjsKCQlod2JbMV0gKz0gaHdiWzFdICogcmF0aW87CgkJdGhpcy5zZXRWYWx1ZXMoJ2h3YicsIGh3Yik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWJsYWNrZW46IGZ1bmN0aW9uIChyYXRpbykgewoJCXZhciBod2IgPSB0aGlzLnZhbHVlcy5od2I7CgkJaHdiWzJdICs9IGh3YlsyXSAqIHJhdGlvOwoJCXRoaXMuc2V0VmFsdWVzKCdod2InLCBod2IpOwoJCXJldHVybiB0aGlzOwoJfSwKCglncmV5c2NhbGU6IGZ1bmN0aW9uICgpIHsKCQl2YXIgcmdiID0gdGhpcy52YWx1ZXMucmdiOwoJCS8vIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvR3JheXNjYWxlI0NvbnZlcnRpbmdfY29sb3JfdG9fZ3JheXNjYWxlCgkJdmFyIHZhbCA9IHJnYlswXSAqIDAuMyArIHJnYlsxXSAqIDAuNTkgKyByZ2JbMl0gKiAwLjExOwoJCXRoaXMuc2V0VmFsdWVzKCdyZ2InLCBbdmFsLCB2YWwsIHZhbF0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbGVhcmVyOiBmdW5jdGlvbiAocmF0aW8pIHsKCQl2YXIgYWxwaGEgPSB0aGlzLnZhbHVlcy5hbHBoYTsKCQl0aGlzLnNldFZhbHVlcygnYWxwaGEnLCBhbHBoYSAtIChhbHBoYSAqIHJhdGlvKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCW9wYXF1ZXI6IGZ1bmN0aW9uIChyYXRpbykgewoJCXZhciBhbHBoYSA9IHRoaXMudmFsdWVzLmFscGhhOwoJCXRoaXMuc2V0VmFsdWVzKCdhbHBoYScsIGFscGhhICsgKGFscGhhICogcmF0aW8pKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcm90YXRlOiBmdW5jdGlvbiAoZGVncmVlcykgewoJCXZhciBoc2wgPSB0aGlzLnZhbHVlcy5oc2w7CgkJdmFyIGh1ZSA9IChoc2xbMF0gKyBkZWdyZWVzKSAlIDM2MDsKCQloc2xbMF0gPSBodWUgPCAwID8gMzYwICsgaHVlIDogaHVlOwoJCXRoaXMuc2V0VmFsdWVzKCdoc2wnLCBoc2wpOwoJCXJldHVybiB0aGlzOwoJfSwKCgkvKioKCSAqIFBvcnRlZCBmcm9tIHNhc3MgaW1wbGVtZW50YXRpb24gaW4gQwoJICogaHR0cHM6Ly9naXRodWIuY29tL3Nhc3MvbGlic2Fzcy9ibG9iLzBlNmI0YTI4NTAwOTIzNTZhYTNlY2UwN2M2YjI0OWYwMjIxY2FjZWQvZnVuY3Rpb25zLmNwcCNMMjA5CgkgKi8KCW1peDogZnVuY3Rpb24gKG1peGluQ29sb3IsIHdlaWdodCkgewoJCXZhciBjb2xvcjEgPSB0aGlzOwoJCXZhciBjb2xvcjIgPSBtaXhpbkNvbG9yOwoJCXZhciBwID0gd2VpZ2h0ID09PSB1bmRlZmluZWQgPyAwLjUgOiB3ZWlnaHQ7CgoJCXZhciB3ID0gMiAqIHAgLSAxOwoJCXZhciBhID0gY29sb3IxLmFscGhhKCkgLSBjb2xvcjIuYWxwaGEoKTsKCgkJdmFyIHcxID0gKCgodyAqIGEgPT09IC0xKSA/IHcgOiAodyArIGEpIC8gKDEgKyB3ICogYSkpICsgMSkgLyAyLjA7CgkJdmFyIHcyID0gMSAtIHcxOwoKCQlyZXR1cm4gdGhpcwoJCQkucmdiKAoJCQkJdzEgKiBjb2xvcjEucmVkKCkgKyB3MiAqIGNvbG9yMi5yZWQoKSwKCQkJCXcxICogY29sb3IxLmdyZWVuKCkgKyB3MiAqIGNvbG9yMi5ncmVlbigpLAoJCQkJdzEgKiBjb2xvcjEuYmx1ZSgpICsgdzIgKiBjb2xvcjIuYmx1ZSgpCgkJCSkKCQkJLmFscGhhKGNvbG9yMS5hbHBoYSgpICogcCArIGNvbG9yMi5hbHBoYSgpICogKDEgLSBwKSk7Cgl9LAoKCXRvSlNPTjogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLnJnYigpOwoJfSwKCgljbG9uZTogZnVuY3Rpb24gKCkgewoJCS8vIE5PVEUoU0IpOiB1c2luZyBub2RlLWNsb25lIGNyZWF0ZXMgYSBkZXBlbmRlbmN5IHRvIEJ1ZmZlciB3aGVuIHVzaW5nIGJyb3dzZXJpZnksCgkJLy8gbWFraW5nIHRoZSBmaW5hbCBidWlsZCB3YXkgdG8gYmlnIHRvIGVtYmVkIGluIENoYXJ0LmpzLiBTbyBsZXQncyBkbyBpdCBtYW51YWxseSwKCQkvLyBhc3N1bWluZyB0aGF0IHZhbHVlcyB0byBjbG9uZSBhcmUgMSBkaW1lbnNpb24gYXJyYXlzIGNvbnRhaW5pbmcgb25seSBudW1iZXJzLAoJCS8vIGV4Y2VwdCAnYWxwaGEnIHdoaWNoIGlzIGEgbnVtYmVyLgoJCXZhciByZXN1bHQgPSBuZXcgQ29sb3IoKTsKCQl2YXIgc291cmNlID0gdGhpcy52YWx1ZXM7CgkJdmFyIHRhcmdldCA9IHJlc3VsdC52YWx1ZXM7CgkJdmFyIHZhbHVlLCB0eXBlOwoKCQlmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewoJCQlpZiAoc291cmNlLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkJCQl2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKCQkJCXR5cGUgPSAoe30pLnRvU3RyaW5nLmNhbGwodmFsdWUpOwoJCQkJaWYgKHR5cGUgPT09ICdbb2JqZWN0IEFycmF5XScpIHsKCQkJCQl0YXJnZXRbcHJvcF0gPSB2YWx1ZS5zbGljZSgwKTsKCQkJCX0gZWxzZSBpZiAodHlwZSA9PT0gJ1tvYmplY3QgTnVtYmVyXScpIHsKCQkJCQl0YXJnZXRbcHJvcF0gPSB2YWx1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJY29uc29sZS5lcnJvcigndW5leHBlY3RlZCBjb2xvciB2YWx1ZTonLCB2YWx1ZSk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiByZXN1bHQ7Cgl9Cn07CgpDb2xvci5wcm90b3R5cGUuc3BhY2VzID0gewoJcmdiOiBbJ3JlZCcsICdncmVlbicsICdibHVlJ10sCgloc2w6IFsnaHVlJywgJ3NhdHVyYXRpb24nLCAnbGlnaHRuZXNzJ10sCgloc3Y6IFsnaHVlJywgJ3NhdHVyYXRpb24nLCAndmFsdWUnXSwKCWh3YjogWydodWUnLCAnd2hpdGVuZXNzJywgJ2JsYWNrbmVzcyddLAoJY215azogWydjeWFuJywgJ21hZ2VudGEnLCAneWVsbG93JywgJ2JsYWNrJ10KfTsKCkNvbG9yLnByb3RvdHlwZS5tYXhlcyA9IHsKCXJnYjogWzI1NSwgMjU1LCAyNTVdLAoJaHNsOiBbMzYwLCAxMDAsIDEwMF0sCgloc3Y6IFszNjAsIDEwMCwgMTAwXSwKCWh3YjogWzM2MCwgMTAwLCAxMDBdLAoJY215azogWzEwMCwgMTAwLCAxMDAsIDEwMF0KfTsKCkNvbG9yLnByb3RvdHlwZS5nZXRWYWx1ZXMgPSBmdW5jdGlvbiAoc3BhY2UpIHsKCXZhciB2YWx1ZXMgPSB0aGlzLnZhbHVlczsKCXZhciB2YWxzID0ge307CgoJZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFjZS5sZW5ndGg7IGkrKykgewoJCXZhbHNbc3BhY2UuY2hhckF0KGkpXSA9IHZhbHVlc1tzcGFjZV1baV07Cgl9CgoJaWYgKHZhbHVlcy5hbHBoYSAhPT0gMSkgewoJCXZhbHMuYSA9IHZhbHVlcy5hbHBoYTsKCX0KCgkvLyB7cjogMjU1LCBnOiAyNTUsIGI6IDI1NSwgYTogMC40fQoJcmV0dXJuIHZhbHM7Cn07CgpDb2xvci5wcm90b3R5cGUuc2V0VmFsdWVzID0gZnVuY3Rpb24gKHNwYWNlLCB2YWxzKSB7Cgl2YXIgdmFsdWVzID0gdGhpcy52YWx1ZXM7Cgl2YXIgc3BhY2VzID0gdGhpcy5zcGFjZXM7Cgl2YXIgbWF4ZXMgPSB0aGlzLm1heGVzOwoJdmFyIGFscGhhID0gMTsKCXZhciBpOwoKCXRoaXMudmFsaWQgPSB0cnVlOwoKCWlmIChzcGFjZSA9PT0gJ2FscGhhJykgewoJCWFscGhhID0gdmFsczsKCX0gZWxzZSBpZiAodmFscy5sZW5ndGgpIHsKCQkvLyBbMTAsIDEwLCAxMF0KCQl2YWx1ZXNbc3BhY2VdID0gdmFscy5zbGljZSgwLCBzcGFjZS5sZW5ndGgpOwoJCWFscGhhID0gdmFsc1tzcGFjZS5sZW5ndGhdOwoJfSBlbHNlIGlmICh2YWxzW3NwYWNlLmNoYXJBdCgwKV0gIT09IHVuZGVmaW5lZCkgewoJCS8vIHtyOiAxMCwgZzogMTAsIGI6IDEwfQoJCWZvciAoaSA9IDA7IGkgPCBzcGFjZS5sZW5ndGg7IGkrKykgewoJCQl2YWx1ZXNbc3BhY2VdW2ldID0gdmFsc1tzcGFjZS5jaGFyQXQoaSldOwoJCX0KCgkJYWxwaGEgPSB2YWxzLmE7Cgl9IGVsc2UgaWYgKHZhbHNbc3BhY2VzW3NwYWNlXVswXV0gIT09IHVuZGVmaW5lZCkgewoJCS8vIHtyZWQ6IDEwLCBncmVlbjogMTAsIGJsdWU6IDEwfQoJCXZhciBjaGFucyA9IHNwYWNlc1tzcGFjZV07CgoJCWZvciAoaSA9IDA7IGkgPCBzcGFjZS5sZW5ndGg7IGkrKykgewoJCQl2YWx1ZXNbc3BhY2VdW2ldID0gdmFsc1tjaGFuc1tpXV07CgkJfQoKCQlhbHBoYSA9IHZhbHMuYWxwaGE7Cgl9CgoJdmFsdWVzLmFscGhhID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgKGFscGhhID09PSB1bmRlZmluZWQgPyB2YWx1ZXMuYWxwaGEgOiBhbHBoYSkpKTsKCglpZiAoc3BhY2UgPT09ICdhbHBoYScpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJdmFyIGNhcHBlZDsKCgkvLyBjYXAgdmFsdWVzIG9mIHRoZSBzcGFjZSBwcmlvciBjb252ZXJ0aW5nIGFsbCB2YWx1ZXMKCWZvciAoaSA9IDA7IGkgPCBzcGFjZS5sZW5ndGg7IGkrKykgewoJCWNhcHBlZCA9IE1hdGgubWF4KDAsIE1hdGgubWluKG1heGVzW3NwYWNlXVtpXSwgdmFsdWVzW3NwYWNlXVtpXSkpOwoJCXZhbHVlc1tzcGFjZV1baV0gPSBNYXRoLnJvdW5kKGNhcHBlZCk7Cgl9CgoJLy8gY29udmVydCB0byBhbGwgdGhlIG90aGVyIGNvbG9yIHNwYWNlcwoJZm9yICh2YXIgc25hbWUgaW4gc3BhY2VzKSB7CgkJaWYgKHNuYW1lICE9PSBzcGFjZSkgewoJCQl2YWx1ZXNbc25hbWVdID0gY29udmVydFtzcGFjZV1bc25hbWVdKHZhbHVlc1tzcGFjZV0pOwoJCX0KCX0KCglyZXR1cm4gdHJ1ZTsKfTsKCkNvbG9yLnByb3RvdHlwZS5zZXRTcGFjZSA9IGZ1bmN0aW9uIChzcGFjZSwgYXJncykgewoJdmFyIHZhbHMgPSBhcmdzWzBdOwoKCWlmICh2YWxzID09PSB1bmRlZmluZWQpIHsKCQkvLyBjb2xvci5yZ2IoKQoJCXJldHVybiB0aGlzLmdldFZhbHVlcyhzcGFjZSk7Cgl9CgoJLy8gY29sb3IucmdiKDEwLCAxMCwgMTApCglpZiAodHlwZW9mIHZhbHMgPT09ICdudW1iZXInKSB7CgkJdmFscyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3MpOwoJfQoKCXRoaXMuc2V0VmFsdWVzKHNwYWNlLCB2YWxzKTsKCXJldHVybiB0aGlzOwp9OwoKQ29sb3IucHJvdG90eXBlLnNldENoYW5uZWwgPSBmdW5jdGlvbiAoc3BhY2UsIGluZGV4LCB2YWwpIHsKCXZhciBzdmFsdWVzID0gdGhpcy52YWx1ZXNbc3BhY2VdOwoJaWYgKHZhbCA9PT0gdW5kZWZpbmVkKSB7CgkJLy8gY29sb3IucmVkKCkKCQlyZXR1cm4gc3ZhbHVlc1tpbmRleF07Cgl9IGVsc2UgaWYgKHZhbCA9PT0gc3ZhbHVlc1tpbmRleF0pIHsKCQkvLyBjb2xvci5yZWQoY29sb3IucmVkKCkpCgkJcmV0dXJuIHRoaXM7Cgl9CgoJLy8gY29sb3IucmVkKDEwMCkKCXN2YWx1ZXNbaW5kZXhdID0gdmFsOwoJdGhpcy5zZXRWYWx1ZXMoc3BhY2UsIHN2YWx1ZXMpOwoKCXJldHVybiB0aGlzOwp9OwoKaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7Cgl3aW5kb3cuQ29sb3IgPSBDb2xvcjsKfQoKbW9kdWxlLmV4cG9ydHMgPSBDb2xvcjsKCn0seyIxIjoxLCI0Ijo0fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIE1JVCBsaWNlbnNlICovCgptb2R1bGUuZXhwb3J0cyA9IHsKICByZ2IyaHNsOiByZ2IyaHNsLAogIHJnYjJoc3Y6IHJnYjJoc3YsCiAgcmdiMmh3YjogcmdiMmh3YiwKICByZ2IyY215azogcmdiMmNteWssCiAgcmdiMmtleXdvcmQ6IHJnYjJrZXl3b3JkLAogIHJnYjJ4eXo6IHJnYjJ4eXosCiAgcmdiMmxhYjogcmdiMmxhYiwKICByZ2IybGNoOiByZ2IybGNoLAoKICBoc2wycmdiOiBoc2wycmdiLAogIGhzbDJoc3Y6IGhzbDJoc3YsCiAgaHNsMmh3YjogaHNsMmh3YiwKICBoc2wyY215azogaHNsMmNteWssCiAgaHNsMmtleXdvcmQ6IGhzbDJrZXl3b3JkLAoKICBoc3YycmdiOiBoc3YycmdiLAogIGhzdjJoc2w6IGhzdjJoc2wsCiAgaHN2Mmh3YjogaHN2Mmh3YiwKICBoc3YyY215azogaHN2MmNteWssCiAgaHN2MmtleXdvcmQ6IGhzdjJrZXl3b3JkLAoKICBod2IycmdiOiBod2IycmdiLAogIGh3YjJoc2w6IGh3YjJoc2wsCiAgaHdiMmhzdjogaHdiMmhzdiwKICBod2IyY215azogaHdiMmNteWssCiAgaHdiMmtleXdvcmQ6IGh3YjJrZXl3b3JkLAoKICBjbXlrMnJnYjogY215azJyZ2IsCiAgY215azJoc2w6IGNteWsyaHNsLAogIGNteWsyaHN2OiBjbXlrMmhzdiwKICBjbXlrMmh3YjogY215azJod2IsCiAgY215azJrZXl3b3JkOiBjbXlrMmtleXdvcmQsCgogIGtleXdvcmQycmdiOiBrZXl3b3JkMnJnYiwKICBrZXl3b3JkMmhzbDoga2V5d29yZDJoc2wsCiAga2V5d29yZDJoc3Y6IGtleXdvcmQyaHN2LAogIGtleXdvcmQyaHdiOiBrZXl3b3JkMmh3YiwKICBrZXl3b3JkMmNteWs6IGtleXdvcmQyY215aywKICBrZXl3b3JkMmxhYjoga2V5d29yZDJsYWIsCiAga2V5d29yZDJ4eXo6IGtleXdvcmQyeHl6LAoKICB4eXoycmdiOiB4eXoycmdiLAogIHh5ejJsYWI6IHh5ejJsYWIsCiAgeHl6MmxjaDogeHl6MmxjaCwKCiAgbGFiMnh5ejogbGFiMnh5eiwKICBsYWIycmdiOiBsYWIycmdiLAogIGxhYjJsY2g6IGxhYjJsY2gsCgogIGxjaDJsYWI6IGxjaDJsYWIsCiAgbGNoMnh5ejogbGNoMnh5eiwKICBsY2gycmdiOiBsY2gycmdiCn0KCgpmdW5jdGlvbiByZ2IyaHNsKHJnYikgewogIHZhciByID0gcmdiWzBdLzI1NSwKICAgICAgZyA9IHJnYlsxXS8yNTUsCiAgICAgIGIgPSByZ2JbMl0vMjU1LAogICAgICBtaW4gPSBNYXRoLm1pbihyLCBnLCBiKSwKICAgICAgbWF4ID0gTWF0aC5tYXgociwgZywgYiksCiAgICAgIGRlbHRhID0gbWF4IC0gbWluLAogICAgICBoLCBzLCBsOwoKICBpZiAobWF4ID09IG1pbikKICAgIGggPSAwOwogIGVsc2UgaWYgKHIgPT0gbWF4KQogICAgaCA9IChnIC0gYikgLyBkZWx0YTsKICBlbHNlIGlmIChnID09IG1heCkKICAgIGggPSAyICsgKGIgLSByKSAvIGRlbHRhOwogIGVsc2UgaWYgKGIgPT0gbWF4KQogICAgaCA9IDQgKyAociAtIGcpLyBkZWx0YTsKCiAgaCA9IE1hdGgubWluKGggKiA2MCwgMzYwKTsKCiAgaWYgKGggPCAwKQogICAgaCArPSAzNjA7CgogIGwgPSAobWluICsgbWF4KSAvIDI7CgogIGlmIChtYXggPT0gbWluKQogICAgcyA9IDA7CiAgZWxzZSBpZiAobCA8PSAwLjUpCiAgICBzID0gZGVsdGEgLyAobWF4ICsgbWluKTsKICBlbHNlCiAgICBzID0gZGVsdGEgLyAoMiAtIG1heCAtIG1pbik7CgogIHJldHVybiBbaCwgcyAqIDEwMCwgbCAqIDEwMF07Cn0KCmZ1bmN0aW9uIHJnYjJoc3YocmdiKSB7CiAgdmFyIHIgPSByZ2JbMF0sCiAgICAgIGcgPSByZ2JbMV0sCiAgICAgIGIgPSByZ2JbMl0sCiAgICAgIG1pbiA9IE1hdGgubWluKHIsIGcsIGIpLAogICAgICBtYXggPSBNYXRoLm1heChyLCBnLCBiKSwKICAgICAgZGVsdGEgPSBtYXggLSBtaW4sCiAgICAgIGgsIHMsIHY7CgogIGlmIChtYXggPT0gMCkKICAgIHMgPSAwOwogIGVsc2UKICAgIHMgPSAoZGVsdGEvbWF4ICogMTAwMCkvMTA7CgogIGlmIChtYXggPT0gbWluKQogICAgaCA9IDA7CiAgZWxzZSBpZiAociA9PSBtYXgpCiAgICBoID0gKGcgLSBiKSAvIGRlbHRhOwogIGVsc2UgaWYgKGcgPT0gbWF4KQogICAgaCA9IDIgKyAoYiAtIHIpIC8gZGVsdGE7CiAgZWxzZSBpZiAoYiA9PSBtYXgpCiAgICBoID0gNCArIChyIC0gZykgLyBkZWx0YTsKCiAgaCA9IE1hdGgubWluKGggKiA2MCwgMzYwKTsKCiAgaWYgKGggPCAwKQogICAgaCArPSAzNjA7CgogIHYgPSAoKG1heCAvIDI1NSkgKiAxMDAwKSAvIDEwOwoKICByZXR1cm4gW2gsIHMsIHZdOwp9CgpmdW5jdGlvbiByZ2IyaHdiKHJnYikgewogIHZhciByID0gcmdiWzBdLAogICAgICBnID0gcmdiWzFdLAogICAgICBiID0gcmdiWzJdLAogICAgICBoID0gcmdiMmhzbChyZ2IpWzBdLAogICAgICB3ID0gMS8yNTUgKiBNYXRoLm1pbihyLCBNYXRoLm1pbihnLCBiKSksCiAgICAgIGIgPSAxIC0gMS8yNTUgKiBNYXRoLm1heChyLCBNYXRoLm1heChnLCBiKSk7CgogIHJldHVybiBbaCwgdyAqIDEwMCwgYiAqIDEwMF07Cn0KCmZ1bmN0aW9uIHJnYjJjbXlrKHJnYikgewogIHZhciByID0gcmdiWzBdIC8gMjU1LAogICAgICBnID0gcmdiWzFdIC8gMjU1LAogICAgICBiID0gcmdiWzJdIC8gMjU1LAogICAgICBjLCBtLCB5LCBrOwoKICBrID0gTWF0aC5taW4oMSAtIHIsIDEgLSBnLCAxIC0gYik7CiAgYyA9ICgxIC0gciAtIGspIC8gKDEgLSBrKSB8fCAwOwogIG0gPSAoMSAtIGcgLSBrKSAvICgxIC0gaykgfHwgMDsKICB5ID0gKDEgLSBiIC0gaykgLyAoMSAtIGspIHx8IDA7CiAgcmV0dXJuIFtjICogMTAwLCBtICogMTAwLCB5ICogMTAwLCBrICogMTAwXTsKfQoKZnVuY3Rpb24gcmdiMmtleXdvcmQocmdiKSB7CiAgcmV0dXJuIHJldmVyc2VLZXl3b3Jkc1tKU09OLnN0cmluZ2lmeShyZ2IpXTsKfQoKZnVuY3Rpb24gcmdiMnh5eihyZ2IpIHsKICB2YXIgciA9IHJnYlswXSAvIDI1NSwKICAgICAgZyA9IHJnYlsxXSAvIDI1NSwKICAgICAgYiA9IHJnYlsyXSAvIDI1NTsKCiAgLy8gYXNzdW1lIHNSR0IKICByID0gciA+IDAuMDQwNDUgPyBNYXRoLnBvdygoKHIgKyAwLjA1NSkgLyAxLjA1NSksIDIuNCkgOiAociAvIDEyLjkyKTsKICBnID0gZyA+IDAuMDQwNDUgPyBNYXRoLnBvdygoKGcgKyAwLjA1NSkgLyAxLjA1NSksIDIuNCkgOiAoZyAvIDEyLjkyKTsKICBiID0gYiA+IDAuMDQwNDUgPyBNYXRoLnBvdygoKGIgKyAwLjA1NSkgLyAxLjA1NSksIDIuNCkgOiAoYiAvIDEyLjkyKTsKCiAgdmFyIHggPSAociAqIDAuNDEyNCkgKyAoZyAqIDAuMzU3NikgKyAoYiAqIDAuMTgwNSk7CiAgdmFyIHkgPSAociAqIDAuMjEyNikgKyAoZyAqIDAuNzE1MikgKyAoYiAqIDAuMDcyMik7CiAgdmFyIHogPSAociAqIDAuMDE5MykgKyAoZyAqIDAuMTE5MikgKyAoYiAqIDAuOTUwNSk7CgogIHJldHVybiBbeCAqIDEwMCwgeSAqMTAwLCB6ICogMTAwXTsKfQoKZnVuY3Rpb24gcmdiMmxhYihyZ2IpIHsKICB2YXIgeHl6ID0gcmdiMnh5eihyZ2IpLAogICAgICAgIHggPSB4eXpbMF0sCiAgICAgICAgeSA9IHh5elsxXSwKICAgICAgICB6ID0geHl6WzJdLAogICAgICAgIGwsIGEsIGI7CgogIHggLz0gOTUuMDQ3OwogIHkgLz0gMTAwOwogIHogLz0gMTA4Ljg4MzsKCiAgeCA9IHggPiAwLjAwODg1NiA/IE1hdGgucG93KHgsIDEvMykgOiAoNy43ODcgKiB4KSArICgxNiAvIDExNik7CiAgeSA9IHkgPiAwLjAwODg1NiA/IE1hdGgucG93KHksIDEvMykgOiAoNy43ODcgKiB5KSArICgxNiAvIDExNik7CiAgeiA9IHogPiAwLjAwODg1NiA/IE1hdGgucG93KHosIDEvMykgOiAoNy43ODcgKiB6KSArICgxNiAvIDExNik7CgogIGwgPSAoMTE2ICogeSkgLSAxNjsKICBhID0gNTAwICogKHggLSB5KTsKICBiID0gMjAwICogKHkgLSB6KTsKCiAgcmV0dXJuIFtsLCBhLCBiXTsKfQoKZnVuY3Rpb24gcmdiMmxjaChhcmdzKSB7CiAgcmV0dXJuIGxhYjJsY2gocmdiMmxhYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGhzbDJyZ2IoaHNsKSB7CiAgdmFyIGggPSBoc2xbMF0gLyAzNjAsCiAgICAgIHMgPSBoc2xbMV0gLyAxMDAsCiAgICAgIGwgPSBoc2xbMl0gLyAxMDAsCiAgICAgIHQxLCB0MiwgdDMsIHJnYiwgdmFsOwoKICBpZiAocyA9PSAwKSB7CiAgICB2YWwgPSBsICogMjU1OwogICAgcmV0dXJuIFt2YWwsIHZhbCwgdmFsXTsKICB9CgogIGlmIChsIDwgMC41KQogICAgdDIgPSBsICogKDEgKyBzKTsKICBlbHNlCiAgICB0MiA9IGwgKyBzIC0gbCAqIHM7CiAgdDEgPSAyICogbCAtIHQyOwoKICByZ2IgPSBbMCwgMCwgMF07CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgIHQzID0gaCArIDEgLyAzICogLSAoaSAtIDEpOwogICAgdDMgPCAwICYmIHQzKys7CiAgICB0MyA+IDEgJiYgdDMtLTsKCiAgICBpZiAoNiAqIHQzIDwgMSkKICAgICAgdmFsID0gdDEgKyAodDIgLSB0MSkgKiA2ICogdDM7CiAgICBlbHNlIGlmICgyICogdDMgPCAxKQogICAgICB2YWwgPSB0MjsKICAgIGVsc2UgaWYgKDMgKiB0MyA8IDIpCiAgICAgIHZhbCA9IHQxICsgKHQyIC0gdDEpICogKDIgLyAzIC0gdDMpICogNjsKICAgIGVsc2UKICAgICAgdmFsID0gdDE7CgogICAgcmdiW2ldID0gdmFsICogMjU1OwogIH0KCiAgcmV0dXJuIHJnYjsKfQoKZnVuY3Rpb24gaHNsMmhzdihoc2wpIHsKICB2YXIgaCA9IGhzbFswXSwKICAgICAgcyA9IGhzbFsxXSAvIDEwMCwKICAgICAgbCA9IGhzbFsyXSAvIDEwMCwKICAgICAgc3YsIHY7CgogIGlmKGwgPT09IDApIHsKICAgICAgLy8gbm8gbmVlZCB0byBkbyBjYWxjIG9uIGJsYWNrCiAgICAgIC8vIGFsc28gYXZvaWRzIGRpdmlkZSBieSAwIGVycm9yCiAgICAgIHJldHVybiBbMCwgMCwgMF07CiAgfQoKICBsICo9IDI7CiAgcyAqPSAobCA8PSAxKSA/IGwgOiAyIC0gbDsKICB2ID0gKGwgKyBzKSAvIDI7CiAgc3YgPSAoMiAqIHMpIC8gKGwgKyBzKTsKICByZXR1cm4gW2gsIHN2ICogMTAwLCB2ICogMTAwXTsKfQoKZnVuY3Rpb24gaHNsMmh3YihhcmdzKSB7CiAgcmV0dXJuIHJnYjJod2IoaHNsMnJnYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGhzbDJjbXlrKGFyZ3MpIHsKICByZXR1cm4gcmdiMmNteWsoaHNsMnJnYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGhzbDJrZXl3b3JkKGFyZ3MpIHsKICByZXR1cm4gcmdiMmtleXdvcmQoaHNsMnJnYihhcmdzKSk7Cn0KCgpmdW5jdGlvbiBoc3YycmdiKGhzdikgewogIHZhciBoID0gaHN2WzBdIC8gNjAsCiAgICAgIHMgPSBoc3ZbMV0gLyAxMDAsCiAgICAgIHYgPSBoc3ZbMl0gLyAxMDAsCiAgICAgIGhpID0gTWF0aC5mbG9vcihoKSAlIDY7CgogIHZhciBmID0gaCAtIE1hdGguZmxvb3IoaCksCiAgICAgIHAgPSAyNTUgKiB2ICogKDEgLSBzKSwKICAgICAgcSA9IDI1NSAqIHYgKiAoMSAtIChzICogZikpLAogICAgICB0ID0gMjU1ICogdiAqICgxIC0gKHMgKiAoMSAtIGYpKSksCiAgICAgIHYgPSAyNTUgKiB2OwoKICBzd2l0Y2goaGkpIHsKICAgIGNhc2UgMDoKICAgICAgcmV0dXJuIFt2LCB0LCBwXTsKICAgIGNhc2UgMToKICAgICAgcmV0dXJuIFtxLCB2LCBwXTsKICAgIGNhc2UgMjoKICAgICAgcmV0dXJuIFtwLCB2LCB0XTsKICAgIGNhc2UgMzoKICAgICAgcmV0dXJuIFtwLCBxLCB2XTsKICAgIGNhc2UgNDoKICAgICAgcmV0dXJuIFt0LCBwLCB2XTsKICAgIGNhc2UgNToKICAgICAgcmV0dXJuIFt2LCBwLCBxXTsKICB9Cn0KCmZ1bmN0aW9uIGhzdjJoc2woaHN2KSB7CiAgdmFyIGggPSBoc3ZbMF0sCiAgICAgIHMgPSBoc3ZbMV0gLyAxMDAsCiAgICAgIHYgPSBoc3ZbMl0gLyAxMDAsCiAgICAgIHNsLCBsOwoKICBsID0gKDIgLSBzKSAqIHY7CiAgc2wgPSBzICogdjsKICBzbCAvPSAobCA8PSAxKSA/IGwgOiAyIC0gbDsKICBzbCA9IHNsIHx8IDA7CiAgbCAvPSAyOwogIHJldHVybiBbaCwgc2wgKiAxMDAsIGwgKiAxMDBdOwp9CgpmdW5jdGlvbiBoc3YyaHdiKGFyZ3MpIHsKICByZXR1cm4gcmdiMmh3Yihoc3YycmdiKGFyZ3MpKQp9CgpmdW5jdGlvbiBoc3YyY215ayhhcmdzKSB7CiAgcmV0dXJuIHJnYjJjbXlrKGhzdjJyZ2IoYXJncykpOwp9CgpmdW5jdGlvbiBoc3Yya2V5d29yZChhcmdzKSB7CiAgcmV0dXJuIHJnYjJrZXl3b3JkKGhzdjJyZ2IoYXJncykpOwp9CgovLyBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3MtY29sb3IvI2h3Yi10by1yZ2IKZnVuY3Rpb24gaHdiMnJnYihod2IpIHsKICB2YXIgaCA9IGh3YlswXSAvIDM2MCwKICAgICAgd2ggPSBod2JbMV0gLyAxMDAsCiAgICAgIGJsID0gaHdiWzJdIC8gMTAwLAogICAgICByYXRpbyA9IHdoICsgYmwsCiAgICAgIGksIHYsIGYsIG47CgogIC8vIHdoICsgYmwgY2FudCBiZSA+IDEKICBpZiAocmF0aW8gPiAxKSB7CiAgICB3aCAvPSByYXRpbzsKICAgIGJsIC89IHJhdGlvOwogIH0KCiAgaSA9IE1hdGguZmxvb3IoNiAqIGgpOwogIHYgPSAxIC0gYmw7CiAgZiA9IDYgKiBoIC0gaTsKICBpZiAoKGkgJiAweDAxKSAhPSAwKSB7CiAgICBmID0gMSAtIGY7CiAgfQogIG4gPSB3aCArIGYgKiAodiAtIHdoKTsgIC8vIGxpbmVhciBpbnRlcnBvbGF0aW9uCgogIHN3aXRjaCAoaSkgewogICAgZGVmYXVsdDoKICAgIGNhc2UgNjoKICAgIGNhc2UgMDogciA9IHY7IGcgPSBuOyBiID0gd2g7IGJyZWFrOwogICAgY2FzZSAxOiByID0gbjsgZyA9IHY7IGIgPSB3aDsgYnJlYWs7CiAgICBjYXNlIDI6IHIgPSB3aDsgZyA9IHY7IGIgPSBuOyBicmVhazsKICAgIGNhc2UgMzogciA9IHdoOyBnID0gbjsgYiA9IHY7IGJyZWFrOwogICAgY2FzZSA0OiByID0gbjsgZyA9IHdoOyBiID0gdjsgYnJlYWs7CiAgICBjYXNlIDU6IHIgPSB2OyBnID0gd2g7IGIgPSBuOyBicmVhazsKICB9CgogIHJldHVybiBbciAqIDI1NSwgZyAqIDI1NSwgYiAqIDI1NV07Cn0KCmZ1bmN0aW9uIGh3YjJoc2woYXJncykgewogIHJldHVybiByZ2IyaHNsKGh3YjJyZ2IoYXJncykpOwp9CgpmdW5jdGlvbiBod2IyaHN2KGFyZ3MpIHsKICByZXR1cm4gcmdiMmhzdihod2IycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gaHdiMmNteWsoYXJncykgewogIHJldHVybiByZ2IyY215ayhod2IycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gaHdiMmtleXdvcmQoYXJncykgewogIHJldHVybiByZ2Iya2V5d29yZChod2IycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gY215azJyZ2IoY215aykgewogIHZhciBjID0gY215a1swXSAvIDEwMCwKICAgICAgbSA9IGNteWtbMV0gLyAxMDAsCiAgICAgIHkgPSBjbXlrWzJdIC8gMTAwLAogICAgICBrID0gY215a1szXSAvIDEwMCwKICAgICAgciwgZywgYjsKCiAgciA9IDEgLSBNYXRoLm1pbigxLCBjICogKDEgLSBrKSArIGspOwogIGcgPSAxIC0gTWF0aC5taW4oMSwgbSAqICgxIC0gaykgKyBrKTsKICBiID0gMSAtIE1hdGgubWluKDEsIHkgKiAoMSAtIGspICsgayk7CiAgcmV0dXJuIFtyICogMjU1LCBnICogMjU1LCBiICogMjU1XTsKfQoKZnVuY3Rpb24gY215azJoc2woYXJncykgewogIHJldHVybiByZ2IyaHNsKGNteWsycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gY215azJoc3YoYXJncykgewogIHJldHVybiByZ2IyaHN2KGNteWsycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gY215azJod2IoYXJncykgewogIHJldHVybiByZ2IyaHdiKGNteWsycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gY215azJrZXl3b3JkKGFyZ3MpIHsKICByZXR1cm4gcmdiMmtleXdvcmQoY215azJyZ2IoYXJncykpOwp9CgoKZnVuY3Rpb24geHl6MnJnYih4eXopIHsKICB2YXIgeCA9IHh5elswXSAvIDEwMCwKICAgICAgeSA9IHh5elsxXSAvIDEwMCwKICAgICAgeiA9IHh5elsyXSAvIDEwMCwKICAgICAgciwgZywgYjsKCiAgciA9ICh4ICogMy4yNDA2KSArICh5ICogLTEuNTM3MikgKyAoeiAqIC0wLjQ5ODYpOwogIGcgPSAoeCAqIC0wLjk2ODkpICsgKHkgKiAxLjg3NTgpICsgKHogKiAwLjA0MTUpOwogIGIgPSAoeCAqIDAuMDU1NykgKyAoeSAqIC0wLjIwNDApICsgKHogKiAxLjA1NzApOwoKICAvLyBhc3N1bWUgc1JHQgogIHIgPSByID4gMC4wMDMxMzA4ID8gKCgxLjA1NSAqIE1hdGgucG93KHIsIDEuMCAvIDIuNCkpIC0gMC4wNTUpCiAgICA6IHIgPSAociAqIDEyLjkyKTsKCiAgZyA9IGcgPiAwLjAwMzEzMDggPyAoKDEuMDU1ICogTWF0aC5wb3coZywgMS4wIC8gMi40KSkgLSAwLjA1NSkKICAgIDogZyA9IChnICogMTIuOTIpOwoKICBiID0gYiA+IDAuMDAzMTMwOCA/ICgoMS4wNTUgKiBNYXRoLnBvdyhiLCAxLjAgLyAyLjQpKSAtIDAuMDU1KQogICAgOiBiID0gKGIgKiAxMi45Mik7CgogIHIgPSBNYXRoLm1pbihNYXRoLm1heCgwLCByKSwgMSk7CiAgZyA9IE1hdGgubWluKE1hdGgubWF4KDAsIGcpLCAxKTsKICBiID0gTWF0aC5taW4oTWF0aC5tYXgoMCwgYiksIDEpOwoKICByZXR1cm4gW3IgKiAyNTUsIGcgKiAyNTUsIGIgKiAyNTVdOwp9CgpmdW5jdGlvbiB4eXoybGFiKHh5eikgewogIHZhciB4ID0geHl6WzBdLAogICAgICB5ID0geHl6WzFdLAogICAgICB6ID0geHl6WzJdLAogICAgICBsLCBhLCBiOwoKICB4IC89IDk1LjA0NzsKICB5IC89IDEwMDsKICB6IC89IDEwOC44ODM7CgogIHggPSB4ID4gMC4wMDg4NTYgPyBNYXRoLnBvdyh4LCAxLzMpIDogKDcuNzg3ICogeCkgKyAoMTYgLyAxMTYpOwogIHkgPSB5ID4gMC4wMDg4NTYgPyBNYXRoLnBvdyh5LCAxLzMpIDogKDcuNzg3ICogeSkgKyAoMTYgLyAxMTYpOwogIHogPSB6ID4gMC4wMDg4NTYgPyBNYXRoLnBvdyh6LCAxLzMpIDogKDcuNzg3ICogeikgKyAoMTYgLyAxMTYpOwoKICBsID0gKDExNiAqIHkpIC0gMTY7CiAgYSA9IDUwMCAqICh4IC0geSk7CiAgYiA9IDIwMCAqICh5IC0geik7CgogIHJldHVybiBbbCwgYSwgYl07Cn0KCmZ1bmN0aW9uIHh5ejJsY2goYXJncykgewogIHJldHVybiBsYWIybGNoKHh5ejJsYWIoYXJncykpOwp9CgpmdW5jdGlvbiBsYWIyeHl6KGxhYikgewogIHZhciBsID0gbGFiWzBdLAogICAgICBhID0gbGFiWzFdLAogICAgICBiID0gbGFiWzJdLAogICAgICB4LCB5LCB6LCB5MjsKCiAgaWYgKGwgPD0gOCkgewogICAgeSA9IChsICogMTAwKSAvIDkwMy4zOwogICAgeTIgPSAoNy43ODcgKiAoeSAvIDEwMCkpICsgKDE2IC8gMTE2KTsKICB9IGVsc2UgewogICAgeSA9IDEwMCAqIE1hdGgucG93KChsICsgMTYpIC8gMTE2LCAzKTsKICAgIHkyID0gTWF0aC5wb3coeSAvIDEwMCwgMS8zKTsKICB9CgogIHggPSB4IC8gOTUuMDQ3IDw9IDAuMDA4ODU2ID8geCA9ICg5NS4wNDcgKiAoKGEgLyA1MDApICsgeTIgLSAoMTYgLyAxMTYpKSkgLyA3Ljc4NyA6IDk1LjA0NyAqIE1hdGgucG93KChhIC8gNTAwKSArIHkyLCAzKTsKCiAgeiA9IHogLyAxMDguODgzIDw9IDAuMDA4ODU5ID8geiA9ICgxMDguODgzICogKHkyIC0gKGIgLyAyMDApIC0gKDE2IC8gMTE2KSkpIC8gNy43ODcgOiAxMDguODgzICogTWF0aC5wb3coeTIgLSAoYiAvIDIwMCksIDMpOwoKICByZXR1cm4gW3gsIHksIHpdOwp9CgpmdW5jdGlvbiBsYWIybGNoKGxhYikgewogIHZhciBsID0gbGFiWzBdLAogICAgICBhID0gbGFiWzFdLAogICAgICBiID0gbGFiWzJdLAogICAgICBociwgaCwgYzsKCiAgaHIgPSBNYXRoLmF0YW4yKGIsIGEpOwogIGggPSBociAqIDM2MCAvIDIgLyBNYXRoLlBJOwogIGlmIChoIDwgMCkgewogICAgaCArPSAzNjA7CiAgfQogIGMgPSBNYXRoLnNxcnQoYSAqIGEgKyBiICogYik7CiAgcmV0dXJuIFtsLCBjLCBoXTsKfQoKZnVuY3Rpb24gbGFiMnJnYihhcmdzKSB7CiAgcmV0dXJuIHh5ejJyZ2IobGFiMnh5eihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGxjaDJsYWIobGNoKSB7CiAgdmFyIGwgPSBsY2hbMF0sCiAgICAgIGMgPSBsY2hbMV0sCiAgICAgIGggPSBsY2hbMl0sCiAgICAgIGEsIGIsIGhyOwoKICBociA9IGggLyAzNjAgKiAyICogTWF0aC5QSTsKICBhID0gYyAqIE1hdGguY29zKGhyKTsKICBiID0gYyAqIE1hdGguc2luKGhyKTsKICByZXR1cm4gW2wsIGEsIGJdOwp9CgpmdW5jdGlvbiBsY2gyeHl6KGFyZ3MpIHsKICByZXR1cm4gbGFiMnh5eihsY2gybGFiKGFyZ3MpKTsKfQoKZnVuY3Rpb24gbGNoMnJnYihhcmdzKSB7CiAgcmV0dXJuIGxhYjJyZ2IobGNoMmxhYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGtleXdvcmQycmdiKGtleXdvcmQpIHsKICByZXR1cm4gY3NzS2V5d29yZHNba2V5d29yZF07Cn0KCmZ1bmN0aW9uIGtleXdvcmQyaHNsKGFyZ3MpIHsKICByZXR1cm4gcmdiMmhzbChrZXl3b3JkMnJnYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGtleXdvcmQyaHN2KGFyZ3MpIHsKICByZXR1cm4gcmdiMmhzdihrZXl3b3JkMnJnYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGtleXdvcmQyaHdiKGFyZ3MpIHsKICByZXR1cm4gcmdiMmh3YihrZXl3b3JkMnJnYihhcmdzKSk7Cn0KCmZ1bmN0aW9uIGtleXdvcmQyY215ayhhcmdzKSB7CiAgcmV0dXJuIHJnYjJjbXlrKGtleXdvcmQycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24ga2V5d29yZDJsYWIoYXJncykgewogIHJldHVybiByZ2IybGFiKGtleXdvcmQycmdiKGFyZ3MpKTsKfQoKZnVuY3Rpb24ga2V5d29yZDJ4eXooYXJncykgewogIHJldHVybiByZ2IyeHl6KGtleXdvcmQycmdiKGFyZ3MpKTsKfQoKdmFyIGNzc0tleXdvcmRzID0gewogIGFsaWNlYmx1ZTogIFsyNDAsMjQ4LDI1NV0sCiAgYW50aXF1ZXdoaXRlOiBbMjUwLDIzNSwyMTVdLAogIGFxdWE6IFswLDI1NSwyNTVdLAogIGFxdWFtYXJpbmU6IFsxMjcsMjU1LDIxMl0sCiAgYXp1cmU6ICBbMjQwLDI1NSwyNTVdLAogIGJlaWdlOiAgWzI0NSwyNDUsMjIwXSwKICBiaXNxdWU6IFsyNTUsMjI4LDE5Nl0sCiAgYmxhY2s6ICBbMCwwLDBdLAogIGJsYW5jaGVkYWxtb25kOiBbMjU1LDIzNSwyMDVdLAogIGJsdWU6IFswLDAsMjU1XSwKICBibHVldmlvbGV0OiBbMTM4LDQzLDIyNl0sCiAgYnJvd246ICBbMTY1LDQyLDQyXSwKICBidXJseXdvb2Q6ICBbMjIyLDE4NCwxMzVdLAogIGNhZGV0Ymx1ZTogIFs5NSwxNTgsMTYwXSwKICBjaGFydHJldXNlOiBbMTI3LDI1NSwwXSwKICBjaG9jb2xhdGU6ICBbMjEwLDEwNSwzMF0sCiAgY29yYWw6ICBbMjU1LDEyNyw4MF0sCiAgY29ybmZsb3dlcmJsdWU6IFsxMDAsMTQ5LDIzN10sCiAgY29ybnNpbGs6IFsyNTUsMjQ4LDIyMF0sCiAgY3JpbXNvbjogIFsyMjAsMjAsNjBdLAogIGN5YW46IFswLDI1NSwyNTVdLAogIGRhcmtibHVlOiBbMCwwLDEzOV0sCiAgZGFya2N5YW46IFswLDEzOSwxMzldLAogIGRhcmtnb2xkZW5yb2Q6ICBbMTg0LDEzNCwxMV0sCiAgZGFya2dyYXk6IFsxNjksMTY5LDE2OV0sCiAgZGFya2dyZWVuOiAgWzAsMTAwLDBdLAogIGRhcmtncmV5OiBbMTY5LDE2OSwxNjldLAogIGRhcmtraGFraTogIFsxODksMTgzLDEwN10sCiAgZGFya21hZ2VudGE6ICBbMTM5LDAsMTM5XSwKICBkYXJrb2xpdmVncmVlbjogWzg1LDEwNyw0N10sCiAgZGFya29yYW5nZTogWzI1NSwxNDAsMF0sCiAgZGFya29yY2hpZDogWzE1Myw1MCwyMDRdLAogIGRhcmtyZWQ6ICBbMTM5LDAsMF0sCiAgZGFya3NhbG1vbjogWzIzMywxNTAsMTIyXSwKICBkYXJrc2VhZ3JlZW46IFsxNDMsMTg4LDE0M10sCiAgZGFya3NsYXRlYmx1ZTogIFs3Miw2MSwxMzldLAogIGRhcmtzbGF0ZWdyYXk6ICBbNDcsNzksNzldLAogIGRhcmtzbGF0ZWdyZXk6ICBbNDcsNzksNzldLAogIGRhcmt0dXJxdW9pc2U6ICBbMCwyMDYsMjA5XSwKICBkYXJrdmlvbGV0OiBbMTQ4LDAsMjExXSwKICBkZWVwcGluazogWzI1NSwyMCwxNDddLAogIGRlZXBza3libHVlOiAgWzAsMTkxLDI1NV0sCiAgZGltZ3JheTogIFsxMDUsMTA1LDEwNV0sCiAgZGltZ3JleTogIFsxMDUsMTA1LDEwNV0sCiAgZG9kZ2VyYmx1ZTogWzMwLDE0NCwyNTVdLAogIGZpcmVicmljazogIFsxNzgsMzQsMzRdLAogIGZsb3JhbHdoaXRlOiAgWzI1NSwyNTAsMjQwXSwKICBmb3Jlc3RncmVlbjogIFszNCwxMzksMzRdLAogIGZ1Y2hzaWE6ICBbMjU1LDAsMjU1XSwKICBnYWluc2Jvcm86ICBbMjIwLDIyMCwyMjBdLAogIGdob3N0d2hpdGU6IFsyNDgsMjQ4LDI1NV0sCiAgZ29sZDogWzI1NSwyMTUsMF0sCiAgZ29sZGVucm9kOiAgWzIxOCwxNjUsMzJdLAogIGdyYXk6IFsxMjgsMTI4LDEyOF0sCiAgZ3JlZW46ICBbMCwxMjgsMF0sCiAgZ3JlZW55ZWxsb3c6ICBbMTczLDI1NSw0N10sCiAgZ3JleTogWzEyOCwxMjgsMTI4XSwKICBob25leWRldzogWzI0MCwyNTUsMjQwXSwKICBob3RwaW5rOiAgWzI1NSwxMDUsMTgwXSwKICBpbmRpYW5yZWQ6ICBbMjA1LDkyLDkyXSwKICBpbmRpZ286IFs3NSwwLDEzMF0sCiAgaXZvcnk6ICBbMjU1LDI1NSwyNDBdLAogIGtoYWtpOiAgWzI0MCwyMzAsMTQwXSwKICBsYXZlbmRlcjogWzIzMCwyMzAsMjUwXSwKICBsYXZlbmRlcmJsdXNoOiAgWzI1NSwyNDAsMjQ1XSwKICBsYXduZ3JlZW46ICBbMTI0LDI1MiwwXSwKICBsZW1vbmNoaWZmb246IFsyNTUsMjUwLDIwNV0sCiAgbGlnaHRibHVlOiAgWzE3MywyMTYsMjMwXSwKICBsaWdodGNvcmFsOiBbMjQwLDEyOCwxMjhdLAogIGxpZ2h0Y3lhbjogIFsyMjQsMjU1LDI1NV0sCiAgbGlnaHRnb2xkZW5yb2R5ZWxsb3c6IFsyNTAsMjUwLDIxMF0sCiAgbGlnaHRncmF5OiAgWzIxMSwyMTEsMjExXSwKICBsaWdodGdyZWVuOiBbMTQ0LDIzOCwxNDRdLAogIGxpZ2h0Z3JleTogIFsyMTEsMjExLDIxMV0sCiAgbGlnaHRwaW5rOiAgWzI1NSwxODIsMTkzXSwKICBsaWdodHNhbG1vbjogIFsyNTUsMTYwLDEyMl0sCiAgbGlnaHRzZWFncmVlbjogIFszMiwxNzgsMTcwXSwKICBsaWdodHNreWJsdWU6IFsxMzUsMjA2LDI1MF0sCiAgbGlnaHRzbGF0ZWdyYXk6IFsxMTksMTM2LDE1M10sCiAgbGlnaHRzbGF0ZWdyZXk6IFsxMTksMTM2LDE1M10sCiAgbGlnaHRzdGVlbGJsdWU6IFsxNzYsMTk2LDIyMl0sCiAgbGlnaHR5ZWxsb3c6ICBbMjU1LDI1NSwyMjRdLAogIGxpbWU6IFswLDI1NSwwXSwKICBsaW1lZ3JlZW46ICBbNTAsMjA1LDUwXSwKICBsaW5lbjogIFsyNTAsMjQwLDIzMF0sCiAgbWFnZW50YTogIFsyNTUsMCwyNTVdLAogIG1hcm9vbjogWzEyOCwwLDBdLAogIG1lZGl1bWFxdWFtYXJpbmU6IFsxMDIsMjA1LDE3MF0sCiAgbWVkaXVtYmx1ZTogWzAsMCwyMDVdLAogIG1lZGl1bW9yY2hpZDogWzE4Niw4NSwyMTFdLAogIG1lZGl1bXB1cnBsZTogWzE0NywxMTIsMjE5XSwKICBtZWRpdW1zZWFncmVlbjogWzYwLDE3OSwxMTNdLAogIG1lZGl1bXNsYXRlYmx1ZTogIFsxMjMsMTA0LDIzOF0sCiAgbWVkaXVtc3ByaW5nZ3JlZW46ICBbMCwyNTAsMTU0XSwKICBtZWRpdW10dXJxdW9pc2U6ICBbNzIsMjA5LDIwNF0sCiAgbWVkaXVtdmlvbGV0cmVkOiAgWzE5OSwyMSwxMzNdLAogIG1pZG5pZ2h0Ymx1ZTogWzI1LDI1LDExMl0sCiAgbWludGNyZWFtOiAgWzI0NSwyNTUsMjUwXSwKICBtaXN0eXJvc2U6ICBbMjU1LDIyOCwyMjVdLAogIG1vY2Nhc2luOiBbMjU1LDIyOCwxODFdLAogIG5hdmFqb3doaXRlOiAgWzI1NSwyMjIsMTczXSwKICBuYXZ5OiBbMCwwLDEyOF0sCiAgb2xkbGFjZTogIFsyNTMsMjQ1LDIzMF0sCiAgb2xpdmU6ICBbMTI4LDEyOCwwXSwKICBvbGl2ZWRyYWI6ICBbMTA3LDE0MiwzNV0sCiAgb3JhbmdlOiBbMjU1LDE2NSwwXSwKICBvcmFuZ2VyZWQ6ICBbMjU1LDY5LDBdLAogIG9yY2hpZDogWzIxOCwxMTIsMjE0XSwKICBwYWxlZ29sZGVucm9kOiAgWzIzOCwyMzIsMTcwXSwKICBwYWxlZ3JlZW46ICBbMTUyLDI1MSwxNTJdLAogIHBhbGV0dXJxdW9pc2U6ICBbMTc1LDIzOCwyMzhdLAogIHBhbGV2aW9sZXRyZWQ6ICBbMjE5LDExMiwxNDddLAogIHBhcGF5YXdoaXA6IFsyNTUsMjM5LDIxM10sCiAgcGVhY2hwdWZmOiAgWzI1NSwyMTgsMTg1XSwKICBwZXJ1OiBbMjA1LDEzMyw2M10sCiAgcGluazogWzI1NSwxOTIsMjAzXSwKICBwbHVtOiBbMjIxLDE2MCwyMjFdLAogIHBvd2RlcmJsdWU6IFsxNzYsMjI0LDIzMF0sCiAgcHVycGxlOiBbMTI4LDAsMTI4XSwKICByZWJlY2NhcHVycGxlOiBbMTAyLCA1MSwgMTUzXSwKICByZWQ6ICBbMjU1LDAsMF0sCiAgcm9zeWJyb3duOiAgWzE4OCwxNDMsMTQzXSwKICByb3lhbGJsdWU6ICBbNjUsMTA1LDIyNV0sCiAgc2FkZGxlYnJvd246ICBbMTM5LDY5LDE5XSwKICBzYWxtb246IFsyNTAsMTI4LDExNF0sCiAgc2FuZHlicm93bjogWzI0NCwxNjQsOTZdLAogIHNlYWdyZWVuOiBbNDYsMTM5LDg3XSwKICBzZWFzaGVsbDogWzI1NSwyNDUsMjM4XSwKICBzaWVubmE6IFsxNjAsODIsNDVdLAogIHNpbHZlcjogWzE5MiwxOTIsMTkyXSwKICBza3libHVlOiAgWzEzNSwyMDYsMjM1XSwKICBzbGF0ZWJsdWU6ICBbMTA2LDkwLDIwNV0sCiAgc2xhdGVncmF5OiAgWzExMiwxMjgsMTQ0XSwKICBzbGF0ZWdyZXk6ICBbMTEyLDEyOCwxNDRdLAogIHNub3c6IFsyNTUsMjUwLDI1MF0sCiAgc3ByaW5nZ3JlZW46ICBbMCwyNTUsMTI3XSwKICBzdGVlbGJsdWU6ICBbNzAsMTMwLDE4MF0sCiAgdGFuOiAgWzIxMCwxODAsMTQwXSwKICB0ZWFsOiBbMCwxMjgsMTI4XSwKICB0aGlzdGxlOiAgWzIxNiwxOTEsMjE2XSwKICB0b21hdG86IFsyNTUsOTksNzFdLAogIHR1cnF1b2lzZTogIFs2NCwyMjQsMjA4XSwKICB2aW9sZXQ6IFsyMzgsMTMwLDIzOF0sCiAgd2hlYXQ6ICBbMjQ1LDIyMiwxNzldLAogIHdoaXRlOiAgWzI1NSwyNTUsMjU1XSwKICB3aGl0ZXNtb2tlOiBbMjQ1LDI0NSwyNDVdLAogIHllbGxvdzogWzI1NSwyNTUsMF0sCiAgeWVsbG93Z3JlZW46ICBbMTU0LDIwNSw1MF0KfTsKCnZhciByZXZlcnNlS2V5d29yZHMgPSB7fTsKZm9yICh2YXIga2V5IGluIGNzc0tleXdvcmRzKSB7CiAgcmV2ZXJzZUtleXdvcmRzW0pTT04uc3RyaW5naWZ5KGNzc0tleXdvcmRzW2tleV0pXSA9IGtleTsKfQoKfSx7fV0sNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBjb252ZXJzaW9ucyA9IHJlcXVpcmUoMyk7Cgp2YXIgY29udmVydCA9IGZ1bmN0aW9uKCkgewogICByZXR1cm4gbmV3IENvbnZlcnRlcigpOwp9Cgpmb3IgKHZhciBmdW5jIGluIGNvbnZlcnNpb25zKSB7CiAgLy8gZXhwb3J0IFJhdyB2ZXJzaW9ucwogIGNvbnZlcnRbZnVuYyArICJSYXciXSA9ICAoZnVuY3Rpb24oZnVuYykgewogICAgLy8gYWNjZXB0IGFycmF5IG9yIHBsYWluIGFyZ3MKICAgIHJldHVybiBmdW5jdGlvbihhcmcpIHsKICAgICAgaWYgKHR5cGVvZiBhcmcgPT0gIm51bWJlciIpCiAgICAgICAgYXJnID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIGNvbnZlcnNpb25zW2Z1bmNdKGFyZyk7CiAgICB9CiAgfSkoZnVuYyk7CgogIHZhciBwYWlyID0gLyhcdyspMihcdyspLy5leGVjKGZ1bmMpLAogICAgICBmcm9tID0gcGFpclsxXSwKICAgICAgdG8gPSBwYWlyWzJdOwoKICAvLyBleHBvcnQgcmdiMmhzbCBhbmQgWyJyZ2IiXVsiaHNsIl0KICBjb252ZXJ0W2Zyb21dID0gY29udmVydFtmcm9tXSB8fCB7fTsKCiAgY29udmVydFtmcm9tXVt0b10gPSBjb252ZXJ0W2Z1bmNdID0gKGZ1bmN0aW9uKGZ1bmMpIHsgCiAgICByZXR1cm4gZnVuY3Rpb24oYXJnKSB7CiAgICAgIGlmICh0eXBlb2YgYXJnID09ICJudW1iZXIiKQogICAgICAgIGFyZyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIAogICAgICB2YXIgdmFsID0gY29udmVyc2lvbnNbZnVuY10oYXJnKTsKICAgICAgaWYgKHR5cGVvZiB2YWwgPT0gInN0cmluZyIgfHwgdmFsID09PSB1bmRlZmluZWQpCiAgICAgICAgcmV0dXJuIHZhbDsgLy8ga2V5d29yZAoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWwubGVuZ3RoOyBpKyspCiAgICAgICAgdmFsW2ldID0gTWF0aC5yb3VuZCh2YWxbaV0pOwogICAgICByZXR1cm4gdmFsOwogICAgfQogIH0pKGZ1bmMpOwp9CgoKLyogQ29udmVydGVyIGRvZXMgbGF6eSBjb252ZXJzaW9uIGFuZCBjYWNoaW5nICovCnZhciBDb252ZXJ0ZXIgPSBmdW5jdGlvbigpIHsKICAgdGhpcy5jb252cyA9IHt9Owp9OwoKLyogRWl0aGVyIGdldCB0aGUgdmFsdWVzIGZvciBhIHNwYWNlIG9yCiAgc2V0IHRoZSB2YWx1ZXMgZm9yIGEgc3BhY2UsIGRlcGVuZGluZyBvbiBhcmdzICovCkNvbnZlcnRlci5wcm90b3R5cGUucm91dGVTcGFjZSA9IGZ1bmN0aW9uKHNwYWNlLCBhcmdzKSB7CiAgIHZhciB2YWx1ZXMgPSBhcmdzWzBdOwogICBpZiAodmFsdWVzID09PSB1bmRlZmluZWQpIHsKICAgICAgLy8gY29sb3IucmdiKCkKICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWVzKHNwYWNlKTsKICAgfQogICAvLyBjb2xvci5yZ2IoMTAsIDEwLCAxMCkKICAgaWYgKHR5cGVvZiB2YWx1ZXMgPT0gIm51bWJlciIpIHsKICAgICAgdmFsdWVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJncyk7ICAgICAgICAKICAgfQoKICAgcmV0dXJuIHRoaXMuc2V0VmFsdWVzKHNwYWNlLCB2YWx1ZXMpOwp9OwogIAovKiBTZXQgdGhlIHZhbHVlcyBmb3IgYSBzcGFjZSwgaW52YWxpZGF0aW5nIGNhY2hlICovCkNvbnZlcnRlci5wcm90b3R5cGUuc2V0VmFsdWVzID0gZnVuY3Rpb24oc3BhY2UsIHZhbHVlcykgewogICB0aGlzLnNwYWNlID0gc3BhY2U7CiAgIHRoaXMuY29udnMgPSB7fTsKICAgdGhpcy5jb252c1tzcGFjZV0gPSB2YWx1ZXM7CiAgIHJldHVybiB0aGlzOwp9OwoKLyogR2V0IHRoZSB2YWx1ZXMgZm9yIGEgc3BhY2UuIElmIHRoZXJlJ3MgYWxyZWFkeQogIGEgY29udmVyc2lvbiBmb3IgdGhlIHNwYWNlLCBmZXRjaCBpdCwgb3RoZXJ3aXNlCiAgY29tcHV0ZSBpdCAqLwpDb252ZXJ0ZXIucHJvdG90eXBlLmdldFZhbHVlcyA9IGZ1bmN0aW9uKHNwYWNlKSB7CiAgIHZhciB2YWxzID0gdGhpcy5jb252c1tzcGFjZV07CiAgIGlmICghdmFscykgewogICAgICB2YXIgZnNwYWNlID0gdGhpcy5zcGFjZSwKICAgICAgICAgIGZyb20gPSB0aGlzLmNvbnZzW2ZzcGFjZV07CiAgICAgIHZhbHMgPSBjb252ZXJ0W2ZzcGFjZV1bc3BhY2VdKGZyb20pOwoKICAgICAgdGhpcy5jb252c1tzcGFjZV0gPSB2YWxzOwogICB9CiAgcmV0dXJuIHZhbHM7Cn07CgpbInJnYiIsICJoc2wiLCAiaHN2IiwgImNteWsiLCAia2V5d29yZCJdLmZvckVhY2goZnVuY3Rpb24oc3BhY2UpIHsKICAgQ29udmVydGVyLnByb3RvdHlwZVtzcGFjZV0gPSBmdW5jdGlvbih2YWxzKSB7CiAgICAgIHJldHVybiB0aGlzLnJvdXRlU3BhY2Uoc3BhY2UsIGFyZ3VtZW50cyk7CiAgIH0KfSk7Cgptb2R1bGUuZXhwb3J0cyA9IGNvbnZlcnQ7Cn0seyIzIjozfV0sNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0Jw0KDQptb2R1bGUuZXhwb3J0cyA9IHsNCgkiYWxpY2VibHVlIjogWzI0MCwgMjQ4LCAyNTVdLA0KCSJhbnRpcXVld2hpdGUiOiBbMjUwLCAyMzUsIDIxNV0sDQoJImFxdWEiOiBbMCwgMjU1LCAyNTVdLA0KCSJhcXVhbWFyaW5lIjogWzEyNywgMjU1LCAyMTJdLA0KCSJhenVyZSI6IFsyNDAsIDI1NSwgMjU1XSwNCgkiYmVpZ2UiOiBbMjQ1LCAyNDUsIDIyMF0sDQoJImJpc3F1ZSI6IFsyNTUsIDIyOCwgMTk2XSwNCgkiYmxhY2siOiBbMCwgMCwgMF0sDQoJImJsYW5jaGVkYWxtb25kIjogWzI1NSwgMjM1LCAyMDVdLA0KCSJibHVlIjogWzAsIDAsIDI1NV0sDQoJImJsdWV2aW9sZXQiOiBbMTM4LCA0MywgMjI2XSwNCgkiYnJvd24iOiBbMTY1LCA0MiwgNDJdLA0KCSJidXJseXdvb2QiOiBbMjIyLCAxODQsIDEzNV0sDQoJImNhZGV0Ymx1ZSI6IFs5NSwgMTU4LCAxNjBdLA0KCSJjaGFydHJldXNlIjogWzEyNywgMjU1LCAwXSwNCgkiY2hvY29sYXRlIjogWzIxMCwgMTA1LCAzMF0sDQoJImNvcmFsIjogWzI1NSwgMTI3LCA4MF0sDQoJImNvcm5mbG93ZXJibHVlIjogWzEwMCwgMTQ5LCAyMzddLA0KCSJjb3Juc2lsayI6IFsyNTUsIDI0OCwgMjIwXSwNCgkiY3JpbXNvbiI6IFsyMjAsIDIwLCA2MF0sDQoJImN5YW4iOiBbMCwgMjU1LCAyNTVdLA0KCSJkYXJrYmx1ZSI6IFswLCAwLCAxMzldLA0KCSJkYXJrY3lhbiI6IFswLCAxMzksIDEzOV0sDQoJImRhcmtnb2xkZW5yb2QiOiBbMTg0LCAxMzQsIDExXSwNCgkiZGFya2dyYXkiOiBbMTY5LCAxNjksIDE2OV0sDQoJImRhcmtncmVlbiI6IFswLCAxMDAsIDBdLA0KCSJkYXJrZ3JleSI6IFsxNjksIDE2OSwgMTY5XSwNCgkiZGFya2toYWtpIjogWzE4OSwgMTgzLCAxMDddLA0KCSJkYXJrbWFnZW50YSI6IFsxMzksIDAsIDEzOV0sDQoJImRhcmtvbGl2ZWdyZWVuIjogWzg1LCAxMDcsIDQ3XSwNCgkiZGFya29yYW5nZSI6IFsyNTUsIDE0MCwgMF0sDQoJImRhcmtvcmNoaWQiOiBbMTUzLCA1MCwgMjA0XSwNCgkiZGFya3JlZCI6IFsxMzksIDAsIDBdLA0KCSJkYXJrc2FsbW9uIjogWzIzMywgMTUwLCAxMjJdLA0KCSJkYXJrc2VhZ3JlZW4iOiBbMTQzLCAxODgsIDE0M10sDQoJImRhcmtzbGF0ZWJsdWUiOiBbNzIsIDYxLCAxMzldLA0KCSJkYXJrc2xhdGVncmF5IjogWzQ3LCA3OSwgNzldLA0KCSJkYXJrc2xhdGVncmV5IjogWzQ3LCA3OSwgNzldLA0KCSJkYXJrdHVycXVvaXNlIjogWzAsIDIwNiwgMjA5XSwNCgkiZGFya3Zpb2xldCI6IFsxNDgsIDAsIDIxMV0sDQoJImRlZXBwaW5rIjogWzI1NSwgMjAsIDE0N10sDQoJImRlZXBza3libHVlIjogWzAsIDE5MSwgMjU1XSwNCgkiZGltZ3JheSI6IFsxMDUsIDEwNSwgMTA1XSwNCgkiZGltZ3JleSI6IFsxMDUsIDEwNSwgMTA1XSwNCgkiZG9kZ2VyYmx1ZSI6IFszMCwgMTQ0LCAyNTVdLA0KCSJmaXJlYnJpY2siOiBbMTc4LCAzNCwgMzRdLA0KCSJmbG9yYWx3aGl0ZSI6IFsyNTUsIDI1MCwgMjQwXSwNCgkiZm9yZXN0Z3JlZW4iOiBbMzQsIDEzOSwgMzRdLA0KCSJmdWNoc2lhIjogWzI1NSwgMCwgMjU1XSwNCgkiZ2FpbnNib3JvIjogWzIyMCwgMjIwLCAyMjBdLA0KCSJnaG9zdHdoaXRlIjogWzI0OCwgMjQ4LCAyNTVdLA0KCSJnb2xkIjogWzI1NSwgMjE1LCAwXSwNCgkiZ29sZGVucm9kIjogWzIxOCwgMTY1LCAzMl0sDQoJImdyYXkiOiBbMTI4LCAxMjgsIDEyOF0sDQoJImdyZWVuIjogWzAsIDEyOCwgMF0sDQoJImdyZWVueWVsbG93IjogWzE3MywgMjU1LCA0N10sDQoJImdyZXkiOiBbMTI4LCAxMjgsIDEyOF0sDQoJImhvbmV5ZGV3IjogWzI0MCwgMjU1LCAyNDBdLA0KCSJob3RwaW5rIjogWzI1NSwgMTA1LCAxODBdLA0KCSJpbmRpYW5yZWQiOiBbMjA1LCA5MiwgOTJdLA0KCSJpbmRpZ28iOiBbNzUsIDAsIDEzMF0sDQoJIml2b3J5IjogWzI1NSwgMjU1LCAyNDBdLA0KCSJraGFraSI6IFsyNDAsIDIzMCwgMTQwXSwNCgkibGF2ZW5kZXIiOiBbMjMwLCAyMzAsIDI1MF0sDQoJImxhdmVuZGVyYmx1c2giOiBbMjU1LCAyNDAsIDI0NV0sDQoJImxhd25ncmVlbiI6IFsxMjQsIDI1MiwgMF0sDQoJImxlbW9uY2hpZmZvbiI6IFsyNTUsIDI1MCwgMjA1XSwNCgkibGlnaHRibHVlIjogWzE3MywgMjE2LCAyMzBdLA0KCSJsaWdodGNvcmFsIjogWzI0MCwgMTI4LCAxMjhdLA0KCSJsaWdodGN5YW4iOiBbMjI0LCAyNTUsIDI1NV0sDQoJImxpZ2h0Z29sZGVucm9keWVsbG93IjogWzI1MCwgMjUwLCAyMTBdLA0KCSJsaWdodGdyYXkiOiBbMjExLCAyMTEsIDIxMV0sDQoJImxpZ2h0Z3JlZW4iOiBbMTQ0LCAyMzgsIDE0NF0sDQoJImxpZ2h0Z3JleSI6IFsyMTEsIDIxMSwgMjExXSwNCgkibGlnaHRwaW5rIjogWzI1NSwgMTgyLCAxOTNdLA0KCSJsaWdodHNhbG1vbiI6IFsyNTUsIDE2MCwgMTIyXSwNCgkibGlnaHRzZWFncmVlbiI6IFszMiwgMTc4LCAxNzBdLA0KCSJsaWdodHNreWJsdWUiOiBbMTM1LCAyMDYsIDI1MF0sDQoJImxpZ2h0c2xhdGVncmF5IjogWzExOSwgMTM2LCAxNTNdLA0KCSJsaWdodHNsYXRlZ3JleSI6IFsxMTksIDEzNiwgMTUzXSwNCgkibGlnaHRzdGVlbGJsdWUiOiBbMTc2LCAxOTYsIDIyMl0sDQoJImxpZ2h0eWVsbG93IjogWzI1NSwgMjU1LCAyMjRdLA0KCSJsaW1lIjogWzAsIDI1NSwgMF0sDQoJImxpbWVncmVlbiI6IFs1MCwgMjA1LCA1MF0sDQoJImxpbmVuIjogWzI1MCwgMjQwLCAyMzBdLA0KCSJtYWdlbnRhIjogWzI1NSwgMCwgMjU1XSwNCgkibWFyb29uIjogWzEyOCwgMCwgMF0sDQoJIm1lZGl1bWFxdWFtYXJpbmUiOiBbMTAyLCAyMDUsIDE3MF0sDQoJIm1lZGl1bWJsdWUiOiBbMCwgMCwgMjA1XSwNCgkibWVkaXVtb3JjaGlkIjogWzE4NiwgODUsIDIxMV0sDQoJIm1lZGl1bXB1cnBsZSI6IFsxNDcsIDExMiwgMjE5XSwNCgkibWVkaXVtc2VhZ3JlZW4iOiBbNjAsIDE3OSwgMTEzXSwNCgkibWVkaXVtc2xhdGVibHVlIjogWzEyMywgMTA0LCAyMzhdLA0KCSJtZWRpdW1zcHJpbmdncmVlbiI6IFswLCAyNTAsIDE1NF0sDQoJIm1lZGl1bXR1cnF1b2lzZSI6IFs3MiwgMjA5LCAyMDRdLA0KCSJtZWRpdW12aW9sZXRyZWQiOiBbMTk5LCAyMSwgMTMzXSwNCgkibWlkbmlnaHRibHVlIjogWzI1LCAyNSwgMTEyXSwNCgkibWludGNyZWFtIjogWzI0NSwgMjU1LCAyNTBdLA0KCSJtaXN0eXJvc2UiOiBbMjU1LCAyMjgsIDIyNV0sDQoJIm1vY2Nhc2luIjogWzI1NSwgMjI4LCAxODFdLA0KCSJuYXZham93aGl0ZSI6IFsyNTUsIDIyMiwgMTczXSwNCgkibmF2eSI6IFswLCAwLCAxMjhdLA0KCSJvbGRsYWNlIjogWzI1MywgMjQ1LCAyMzBdLA0KCSJvbGl2ZSI6IFsxMjgsIDEyOCwgMF0sDQoJIm9saXZlZHJhYiI6IFsxMDcsIDE0MiwgMzVdLA0KCSJvcmFuZ2UiOiBbMjU1LCAxNjUsIDBdLA0KCSJvcmFuZ2VyZWQiOiBbMjU1LCA2OSwgMF0sDQoJIm9yY2hpZCI6IFsyMTgsIDExMiwgMjE0XSwNCgkicGFsZWdvbGRlbnJvZCI6IFsyMzgsIDIzMiwgMTcwXSwNCgkicGFsZWdyZWVuIjogWzE1MiwgMjUxLCAxNTJdLA0KCSJwYWxldHVycXVvaXNlIjogWzE3NSwgMjM4LCAyMzhdLA0KCSJwYWxldmlvbGV0cmVkIjogWzIxOSwgMTEyLCAxNDddLA0KCSJwYXBheWF3aGlwIjogWzI1NSwgMjM5LCAyMTNdLA0KCSJwZWFjaHB1ZmYiOiBbMjU1LCAyMTgsIDE4NV0sDQoJInBlcnUiOiBbMjA1LCAxMzMsIDYzXSwNCgkicGluayI6IFsyNTUsIDE5MiwgMjAzXSwNCgkicGx1bSI6IFsyMjEsIDE2MCwgMjIxXSwNCgkicG93ZGVyYmx1ZSI6IFsxNzYsIDIyNCwgMjMwXSwNCgkicHVycGxlIjogWzEyOCwgMCwgMTI4XSwNCgkicmViZWNjYXB1cnBsZSI6IFsxMDIsIDUxLCAxNTNdLA0KCSJyZWQiOiBbMjU1LCAwLCAwXSwNCgkicm9zeWJyb3duIjogWzE4OCwgMTQzLCAxNDNdLA0KCSJyb3lhbGJsdWUiOiBbNjUsIDEwNSwgMjI1XSwNCgkic2FkZGxlYnJvd24iOiBbMTM5LCA2OSwgMTldLA0KCSJzYWxtb24iOiBbMjUwLCAxMjgsIDExNF0sDQoJInNhbmR5YnJvd24iOiBbMjQ0LCAxNjQsIDk2XSwNCgkic2VhZ3JlZW4iOiBbNDYsIDEzOSwgODddLA0KCSJzZWFzaGVsbCI6IFsyNTUsIDI0NSwgMjM4XSwNCgkic2llbm5hIjogWzE2MCwgODIsIDQ1XSwNCgkic2lsdmVyIjogWzE5MiwgMTkyLCAxOTJdLA0KCSJza3libHVlIjogWzEzNSwgMjA2LCAyMzVdLA0KCSJzbGF0ZWJsdWUiOiBbMTA2LCA5MCwgMjA1XSwNCgkic2xhdGVncmF5IjogWzExMiwgMTI4LCAxNDRdLA0KCSJzbGF0ZWdyZXkiOiBbMTEyLCAxMjgsIDE0NF0sDQoJInNub3ciOiBbMjU1LCAyNTAsIDI1MF0sDQoJInNwcmluZ2dyZWVuIjogWzAsIDI1NSwgMTI3XSwNCgkic3RlZWxibHVlIjogWzcwLCAxMzAsIDE4MF0sDQoJInRhbiI6IFsyMTAsIDE4MCwgMTQwXSwNCgkidGVhbCI6IFswLCAxMjgsIDEyOF0sDQoJInRoaXN0bGUiOiBbMjE2LCAxOTEsIDIxNl0sDQoJInRvbWF0byI6IFsyNTUsIDk5LCA3MV0sDQoJInR1cnF1b2lzZSI6IFs2NCwgMjI0LCAyMDhdLA0KCSJ2aW9sZXQiOiBbMjM4LCAxMzAsIDIzOF0sDQoJIndoZWF0IjogWzI0NSwgMjIyLCAxNzldLA0KCSJ3aGl0ZSI6IFsyNTUsIDI1NSwgMjU1XSwNCgkid2hpdGVzbW9rZSI6IFsyNDUsIDI0NSwgMjQ1XSwNCgkieWVsbG93IjogWzI1NSwgMjU1LCAwXSwNCgkieWVsbG93Z3JlZW4iOiBbMTU0LCAyMDUsIDUwXQ0KfTsNCgp9LHt9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8hIG1vbWVudC5qcwovLyEgdmVyc2lvbiA6IDIuMjAuMQovLyEgYXV0aG9ycyA6IFRpbSBXb29kLCBJc2tyZW4gQ2hlcm5ldiwgTW9tZW50LmpzIGNvbnRyaWJ1dG9ycwovLyEgbGljZW5zZSA6IE1JVAovLyEgbW9tZW50anMuY29tCgo7KGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICAgIHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyA/IG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpIDoKICAgIHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCA/IGRlZmluZShmYWN0b3J5KSA6CiAgICBnbG9iYWwubW9tZW50ID0gZmFjdG9yeSgpCn0odGhpcywgKGZ1bmN0aW9uICgpIHsgJ3VzZSBzdHJpY3QnOwoKdmFyIGhvb2tDYWxsYmFjazsKCmZ1bmN0aW9uIGhvb2tzICgpIHsKICAgIHJldHVybiBob29rQ2FsbGJhY2suYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQoKLy8gVGhpcyBpcyBkb25lIHRvIHJlZ2lzdGVyIHRoZSBtZXRob2QgY2FsbGVkIHdpdGggbW9tZW50KCkKLy8gd2l0aG91dCBjcmVhdGluZyBjaXJjdWxhciBkZXBlbmRlbmNpZXMuCmZ1bmN0aW9uIHNldEhvb2tDYWxsYmFjayAoY2FsbGJhY2spIHsKICAgIGhvb2tDYWxsYmFjayA9IGNhbGxiYWNrOwp9CgpmdW5jdGlvbiBpc0FycmF5KGlucHV0KSB7CiAgICByZXR1cm4gaW5wdXQgaW5zdGFuY2VvZiBBcnJheSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBBcnJheV0nOwp9CgpmdW5jdGlvbiBpc09iamVjdChpbnB1dCkgewogICAgLy8gSUU4IHdpbGwgdHJlYXQgdW5kZWZpbmVkIGFuZCBudWxsIGFzIG9iamVjdCBpZiBpdCB3YXNuJ3QgZm9yCiAgICAvLyBpbnB1dCAhPSBudWxsCiAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBPYmplY3RdJzsKfQoKZnVuY3Rpb24gaXNPYmplY3RFbXB0eShvYmopIHsKICAgIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcykgewogICAgICAgIHJldHVybiAoT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKS5sZW5ndGggPT09IDApOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgazsKICAgICAgICBmb3IgKGsgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkoaykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQoKZnVuY3Rpb24gaXNVbmRlZmluZWQoaW5wdXQpIHsKICAgIHJldHVybiBpbnB1dCA9PT0gdm9pZCAwOwp9CgpmdW5jdGlvbiBpc051bWJlcihpbnB1dCkgewogICAgcmV0dXJuIHR5cGVvZiBpbnB1dCA9PT0gJ251bWJlcicgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgTnVtYmVyXSc7Cn0KCmZ1bmN0aW9uIGlzRGF0ZShpbnB1dCkgewogICAgcmV0dXJuIGlucHV0IGluc3RhbmNlb2YgRGF0ZSB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoaW5wdXQpID09PSAnW29iamVjdCBEYXRlXSc7Cn0KCmZ1bmN0aW9uIG1hcChhcnIsIGZuKSB7CiAgICB2YXIgcmVzID0gW10sIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcmVzLnB1c2goZm4oYXJyW2ldLCBpKSk7CiAgICB9CiAgICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBoYXNPd25Qcm9wKGEsIGIpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoYSwgYik7Cn0KCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgICBmb3IgKHZhciBpIGluIGIpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcChiLCBpKSkgewogICAgICAgICAgICBhW2ldID0gYltpXTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKGhhc093blByb3AoYiwgJ3RvU3RyaW5nJykpIHsKICAgICAgICBhLnRvU3RyaW5nID0gYi50b1N0cmluZzsKICAgIH0KCiAgICBpZiAoaGFzT3duUHJvcChiLCAndmFsdWVPZicpKSB7CiAgICAgICAgYS52YWx1ZU9mID0gYi52YWx1ZU9mOwogICAgfQoKICAgIHJldHVybiBhOwp9CgpmdW5jdGlvbiBjcmVhdGVVVEMgKGlucHV0LCBmb3JtYXQsIGxvY2FsZSwgc3RyaWN0KSB7CiAgICByZXR1cm4gY3JlYXRlTG9jYWxPclVUQyhpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCwgdHJ1ZSkudXRjKCk7Cn0KCmZ1bmN0aW9uIGRlZmF1bHRQYXJzaW5nRmxhZ3MoKSB7CiAgICAvLyBXZSBuZWVkIHRvIGRlZXAgY2xvbmUgdGhpcyBvYmplY3QuCiAgICByZXR1cm4gewogICAgICAgIGVtcHR5ICAgICAgICAgICA6IGZhbHNlLAogICAgICAgIHVudXNlZFRva2VucyAgICA6IFtdLAogICAgICAgIHVudXNlZElucHV0ICAgICA6IFtdLAogICAgICAgIG92ZXJmbG93ICAgICAgICA6IC0yLAogICAgICAgIGNoYXJzTGVmdE92ZXIgICA6IDAsCiAgICAgICAgbnVsbElucHV0ICAgICAgIDogZmFsc2UsCiAgICAgICAgaW52YWxpZE1vbnRoICAgIDogbnVsbCwKICAgICAgICBpbnZhbGlkRm9ybWF0ICAgOiBmYWxzZSwKICAgICAgICB1c2VySW52YWxpZGF0ZWQgOiBmYWxzZSwKICAgICAgICBpc28gICAgICAgICAgICAgOiBmYWxzZSwKICAgICAgICBwYXJzZWREYXRlUGFydHMgOiBbXSwKICAgICAgICBtZXJpZGllbSAgICAgICAgOiBudWxsLAogICAgICAgIHJmYzI4MjIgICAgICAgICA6IGZhbHNlLAogICAgICAgIHdlZWtkYXlNaXNtYXRjaCA6IGZhbHNlCiAgICB9Owp9CgpmdW5jdGlvbiBnZXRQYXJzaW5nRmxhZ3MobSkgewogICAgaWYgKG0uX3BmID09IG51bGwpIHsKICAgICAgICBtLl9wZiA9IGRlZmF1bHRQYXJzaW5nRmxhZ3MoKTsKICAgIH0KICAgIHJldHVybiBtLl9wZjsKfQoKdmFyIHNvbWU7CmlmIChBcnJheS5wcm90b3R5cGUuc29tZSkgewogICAgc29tZSA9IEFycmF5LnByb3RvdHlwZS5zb21lOwp9IGVsc2UgewogICAgc29tZSA9IGZ1bmN0aW9uIChmdW4pIHsKICAgICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKTsKICAgICAgICB2YXIgbGVuID0gdC5sZW5ndGggPj4+IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKGkgaW4gdCAmJiBmdW4uY2FsbCh0aGlzLCB0W2ldLCBpLCB0KSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH07Cn0KCmZ1bmN0aW9uIGlzVmFsaWQobSkgewogICAgaWYgKG0uX2lzVmFsaWQgPT0gbnVsbCkgewogICAgICAgIHZhciBmbGFncyA9IGdldFBhcnNpbmdGbGFncyhtKTsKICAgICAgICB2YXIgcGFyc2VkUGFydHMgPSBzb21lLmNhbGwoZmxhZ3MucGFyc2VkRGF0ZVBhcnRzLCBmdW5jdGlvbiAoaSkgewogICAgICAgICAgICByZXR1cm4gaSAhPSBudWxsOwogICAgICAgIH0pOwogICAgICAgIHZhciBpc05vd1ZhbGlkID0gIWlzTmFOKG0uX2QuZ2V0VGltZSgpKSAmJgogICAgICAgICAgICBmbGFncy5vdmVyZmxvdyA8IDAgJiYKICAgICAgICAgICAgIWZsYWdzLmVtcHR5ICYmCiAgICAgICAgICAgICFmbGFncy5pbnZhbGlkTW9udGggJiYKICAgICAgICAgICAgIWZsYWdzLmludmFsaWRXZWVrZGF5ICYmCiAgICAgICAgICAgICFmbGFncy53ZWVrZGF5TWlzbWF0Y2ggJiYKICAgICAgICAgICAgIWZsYWdzLm51bGxJbnB1dCAmJgogICAgICAgICAgICAhZmxhZ3MuaW52YWxpZEZvcm1hdCAmJgogICAgICAgICAgICAhZmxhZ3MudXNlckludmFsaWRhdGVkICYmCiAgICAgICAgICAgICghZmxhZ3MubWVyaWRpZW0gfHwgKGZsYWdzLm1lcmlkaWVtICYmIHBhcnNlZFBhcnRzKSk7CgogICAgICAgIGlmIChtLl9zdHJpY3QpIHsKICAgICAgICAgICAgaXNOb3dWYWxpZCA9IGlzTm93VmFsaWQgJiYKICAgICAgICAgICAgICAgIGZsYWdzLmNoYXJzTGVmdE92ZXIgPT09IDAgJiYKICAgICAgICAgICAgICAgIGZsYWdzLnVudXNlZFRva2Vucy5sZW5ndGggPT09IDAgJiYKICAgICAgICAgICAgICAgIGZsYWdzLmJpZ0hvdXIgPT09IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGlmIChPYmplY3QuaXNGcm96ZW4gPT0gbnVsbCB8fCAhT2JqZWN0LmlzRnJvemVuKG0pKSB7CiAgICAgICAgICAgIG0uX2lzVmFsaWQgPSBpc05vd1ZhbGlkOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGlzTm93VmFsaWQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG0uX2lzVmFsaWQ7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUludmFsaWQgKGZsYWdzKSB7CiAgICB2YXIgbSA9IGNyZWF0ZVVUQyhOYU4pOwogICAgaWYgKGZsYWdzICE9IG51bGwpIHsKICAgICAgICBleHRlbmQoZ2V0UGFyc2luZ0ZsYWdzKG0pLCBmbGFncyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBnZXRQYXJzaW5nRmxhZ3MobSkudXNlckludmFsaWRhdGVkID0gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gbTsKfQoKLy8gUGx1Z2lucyB0aGF0IGFkZCBwcm9wZXJ0aWVzIHNob3VsZCBhbHNvIGFkZCB0aGUga2V5IGhlcmUgKG51bGwgdmFsdWUpLAovLyBzbyB3ZSBjYW4gcHJvcGVybHkgY2xvbmUgb3Vyc2VsdmVzLgp2YXIgbW9tZW50UHJvcGVydGllcyA9IGhvb2tzLm1vbWVudFByb3BlcnRpZXMgPSBbXTsKCmZ1bmN0aW9uIGNvcHlDb25maWcodG8sIGZyb20pIHsKICAgIHZhciBpLCBwcm9wLCB2YWw7CgogICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl9pc0FNb21lbnRPYmplY3QpKSB7CiAgICAgICAgdG8uX2lzQU1vbWVudE9iamVjdCA9IGZyb20uX2lzQU1vbWVudE9iamVjdDsKICAgIH0KICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5faSkpIHsKICAgICAgICB0by5faSA9IGZyb20uX2k7CiAgICB9CiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX2YpKSB7CiAgICAgICAgdG8uX2YgPSBmcm9tLl9mOwogICAgfQogICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl9sKSkgewogICAgICAgIHRvLl9sID0gZnJvbS5fbDsKICAgIH0KICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5fc3RyaWN0KSkgewogICAgICAgIHRvLl9zdHJpY3QgPSBmcm9tLl9zdHJpY3Q7CiAgICB9CiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX3R6bSkpIHsKICAgICAgICB0by5fdHptID0gZnJvbS5fdHptOwogICAgfQogICAgaWYgKCFpc1VuZGVmaW5lZChmcm9tLl9pc1VUQykpIHsKICAgICAgICB0by5faXNVVEMgPSBmcm9tLl9pc1VUQzsKICAgIH0KICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5fb2Zmc2V0KSkgewogICAgICAgIHRvLl9vZmZzZXQgPSBmcm9tLl9vZmZzZXQ7CiAgICB9CiAgICBpZiAoIWlzVW5kZWZpbmVkKGZyb20uX3BmKSkgewogICAgICAgIHRvLl9wZiA9IGdldFBhcnNpbmdGbGFncyhmcm9tKTsKICAgIH0KICAgIGlmICghaXNVbmRlZmluZWQoZnJvbS5fbG9jYWxlKSkgewogICAgICAgIHRvLl9sb2NhbGUgPSBmcm9tLl9sb2NhbGU7CiAgICB9CgogICAgaWYgKG1vbWVudFByb3BlcnRpZXMubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoaSA9IDA7IGkgPCBtb21lbnRQcm9wZXJ0aWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHByb3AgPSBtb21lbnRQcm9wZXJ0aWVzW2ldOwogICAgICAgICAgICB2YWwgPSBmcm9tW3Byb3BdOwogICAgICAgICAgICBpZiAoIWlzVW5kZWZpbmVkKHZhbCkpIHsKICAgICAgICAgICAgICAgIHRvW3Byb3BdID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0bzsKfQoKdmFyIHVwZGF0ZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCi8vIE1vbWVudCBwcm90b3R5cGUgb2JqZWN0CmZ1bmN0aW9uIE1vbWVudChjb25maWcpIHsKICAgIGNvcHlDb25maWcodGhpcywgY29uZmlnKTsKICAgIHRoaXMuX2QgPSBuZXcgRGF0ZShjb25maWcuX2QgIT0gbnVsbCA/IGNvbmZpZy5fZC5nZXRUaW1lKCkgOiBOYU4pOwogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHRoaXMuX2QgPSBuZXcgRGF0ZShOYU4pOwogICAgfQogICAgLy8gUHJldmVudCBpbmZpbml0ZSBsb29wIGluIGNhc2UgdXBkYXRlT2Zmc2V0IGNyZWF0ZXMgbmV3IG1vbWVudAogICAgLy8gb2JqZWN0cy4KICAgIGlmICh1cGRhdGVJblByb2dyZXNzID09PSBmYWxzZSkgewogICAgICAgIHVwZGF0ZUluUHJvZ3Jlc3MgPSB0cnVlOwogICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldCh0aGlzKTsKICAgICAgICB1cGRhdGVJblByb2dyZXNzID0gZmFsc2U7CiAgICB9Cn0KCmZ1bmN0aW9uIGlzTW9tZW50IChvYmopIHsKICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBNb21lbnQgfHwgKG9iaiAhPSBudWxsICYmIG9iai5faXNBTW9tZW50T2JqZWN0ICE9IG51bGwpOwp9CgpmdW5jdGlvbiBhYnNGbG9vciAobnVtYmVyKSB7CiAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICAgIC8vIC0wIC0+IDAKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKG51bWJlcikgfHwgMDsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IobnVtYmVyKTsKICAgIH0KfQoKZnVuY3Rpb24gdG9JbnQoYXJndW1lbnRGb3JDb2VyY2lvbikgewogICAgdmFyIGNvZXJjZWROdW1iZXIgPSArYXJndW1lbnRGb3JDb2VyY2lvbiwKICAgICAgICB2YWx1ZSA9IDA7CgogICAgaWYgKGNvZXJjZWROdW1iZXIgIT09IDAgJiYgaXNGaW5pdGUoY29lcmNlZE51bWJlcikpIHsKICAgICAgICB2YWx1ZSA9IGFic0Zsb29yKGNvZXJjZWROdW1iZXIpOwogICAgfQoKICAgIHJldHVybiB2YWx1ZTsKfQoKLy8gY29tcGFyZSB0d28gYXJyYXlzLCByZXR1cm4gdGhlIG51bWJlciBvZiBkaWZmZXJlbmNlcwpmdW5jdGlvbiBjb21wYXJlQXJyYXlzKGFycmF5MSwgYXJyYXkyLCBkb250Q29udmVydCkgewogICAgdmFyIGxlbiA9IE1hdGgubWluKGFycmF5MS5sZW5ndGgsIGFycmF5Mi5sZW5ndGgpLAogICAgICAgIGxlbmd0aERpZmYgPSBNYXRoLmFicyhhcnJheTEubGVuZ3RoIC0gYXJyYXkyLmxlbmd0aCksCiAgICAgICAgZGlmZnMgPSAwLAogICAgICAgIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoKGRvbnRDb252ZXJ0ICYmIGFycmF5MVtpXSAhPT0gYXJyYXkyW2ldKSB8fAogICAgICAgICAgICAoIWRvbnRDb252ZXJ0ICYmIHRvSW50KGFycmF5MVtpXSkgIT09IHRvSW50KGFycmF5MltpXSkpKSB7CiAgICAgICAgICAgIGRpZmZzKys7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGRpZmZzICsgbGVuZ3RoRGlmZjsKfQoKZnVuY3Rpb24gd2Fybihtc2cpIHsKICAgIGlmIChob29rcy5zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZ3MgPT09IGZhbHNlICYmCiAgICAgICAgICAgICh0eXBlb2YgY29uc29sZSAhPT0gICd1bmRlZmluZWQnKSAmJiBjb25zb2xlLndhcm4pIHsKICAgICAgICBjb25zb2xlLndhcm4oJ0RlcHJlY2F0aW9uIHdhcm5pbmc6ICcgKyBtc2cpOwogICAgfQp9CgpmdW5jdGlvbiBkZXByZWNhdGUobXNnLCBmbikgewogICAgdmFyIGZpcnN0VGltZSA9IHRydWU7CgogICAgcmV0dXJuIGV4dGVuZChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKGhvb2tzLmRlcHJlY2F0aW9uSGFuZGxlciAhPSBudWxsKSB7CiAgICAgICAgICAgIGhvb2tzLmRlcHJlY2F0aW9uSGFuZGxlcihudWxsLCBtc2cpOwogICAgICAgIH0KICAgICAgICBpZiAoZmlyc3RUaW1lKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gW107CiAgICAgICAgICAgIHZhciBhcmc7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBhcmcgPSAnJzsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzW2ldID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgIGFyZyArPSAnXG5bJyArIGkgKyAnXSAnOwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBhcmd1bWVudHNbMF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXJnICs9IGtleSArICc6ICcgKyBhcmd1bWVudHNbMF1ba2V5XSArICcsICc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFyZyA9IGFyZy5zbGljZSgwLCAtMik7IC8vIFJlbW92ZSB0cmFpbGluZyBjb21tYSBhbmQgc3BhY2UKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXJncy5wdXNoKGFyZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybihtc2cgKyAnXG5Bcmd1bWVudHM6ICcgKyBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmdzKS5qb2luKCcnKSArICdcbicgKyAobmV3IEVycm9yKCkpLnN0YWNrKTsKICAgICAgICAgICAgZmlyc3RUaW1lID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwgZm4pOwp9Cgp2YXIgZGVwcmVjYXRpb25zID0ge307CgpmdW5jdGlvbiBkZXByZWNhdGVTaW1wbGUobmFtZSwgbXNnKSB7CiAgICBpZiAoaG9va3MuZGVwcmVjYXRpb25IYW5kbGVyICE9IG51bGwpIHsKICAgICAgICBob29rcy5kZXByZWNhdGlvbkhhbmRsZXIobmFtZSwgbXNnKTsKICAgIH0KICAgIGlmICghZGVwcmVjYXRpb25zW25hbWVdKSB7CiAgICAgICAgd2Fybihtc2cpOwogICAgICAgIGRlcHJlY2F0aW9uc1tuYW1lXSA9IHRydWU7CiAgICB9Cn0KCmhvb2tzLnN1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5ncyA9IGZhbHNlOwpob29rcy5kZXByZWNhdGlvbkhhbmRsZXIgPSBudWxsOwoKZnVuY3Rpb24gaXNGdW5jdGlvbihpbnB1dCkgewogICAgcmV0dXJuIGlucHV0IGluc3RhbmNlb2YgRnVuY3Rpb24gfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGlucHV0KSA9PT0gJ1tvYmplY3QgRnVuY3Rpb25dJzsKfQoKZnVuY3Rpb24gc2V0IChjb25maWcpIHsKICAgIHZhciBwcm9wLCBpOwogICAgZm9yIChpIGluIGNvbmZpZykgewogICAgICAgIHByb3AgPSBjb25maWdbaV07CiAgICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvcCkpIHsKICAgICAgICAgICAgdGhpc1tpXSA9IHByb3A7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc1snXycgKyBpXSA9IHByb3A7CiAgICAgICAgfQogICAgfQogICAgdGhpcy5fY29uZmlnID0gY29uZmlnOwogICAgLy8gTGVuaWVudCBvcmRpbmFsIHBhcnNpbmcgYWNjZXB0cyBqdXN0IGEgbnVtYmVyIGluIGFkZGl0aW9uIHRvCiAgICAvLyBudW1iZXIgKyAocG9zc2libHkpIHN0dWZmIGNvbWluZyBmcm9tIF9kYXlPZk1vbnRoT3JkaW5hbFBhcnNlLgogICAgLy8gVE9ETzogUmVtb3ZlICJvcmRpbmFsUGFyc2UiIGZhbGxiYWNrIGluIG5leHQgbWFqb3IgcmVsZWFzZS4KICAgIHRoaXMuX2RheU9mTW9udGhPcmRpbmFsUGFyc2VMZW5pZW50ID0gbmV3IFJlZ0V4cCgKICAgICAgICAodGhpcy5fZGF5T2ZNb250aE9yZGluYWxQYXJzZS5zb3VyY2UgfHwgdGhpcy5fb3JkaW5hbFBhcnNlLnNvdXJjZSkgKwogICAgICAgICAgICAnfCcgKyAoL1xkezEsMn0vKS5zb3VyY2UpOwp9CgpmdW5jdGlvbiBtZXJnZUNvbmZpZ3MocGFyZW50Q29uZmlnLCBjaGlsZENvbmZpZykgewogICAgdmFyIHJlcyA9IGV4dGVuZCh7fSwgcGFyZW50Q29uZmlnKSwgcHJvcDsKICAgIGZvciAocHJvcCBpbiBjaGlsZENvbmZpZykgewogICAgICAgIGlmIChoYXNPd25Qcm9wKGNoaWxkQ29uZmlnLCBwcm9wKSkgewogICAgICAgICAgICBpZiAoaXNPYmplY3QocGFyZW50Q29uZmlnW3Byb3BdKSAmJiBpc09iamVjdChjaGlsZENvbmZpZ1twcm9wXSkpIHsKICAgICAgICAgICAgICAgIHJlc1twcm9wXSA9IHt9OwogICAgICAgICAgICAgICAgZXh0ZW5kKHJlc1twcm9wXSwgcGFyZW50Q29uZmlnW3Byb3BdKTsKICAgICAgICAgICAgICAgIGV4dGVuZChyZXNbcHJvcF0sIGNoaWxkQ29uZmlnW3Byb3BdKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGlsZENvbmZpZ1twcm9wXSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXNbcHJvcF0gPSBjaGlsZENvbmZpZ1twcm9wXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSByZXNbcHJvcF07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBmb3IgKHByb3AgaW4gcGFyZW50Q29uZmlnKSB7CiAgICAgICAgaWYgKGhhc093blByb3AocGFyZW50Q29uZmlnLCBwcm9wKSAmJgogICAgICAgICAgICAgICAgIWhhc093blByb3AoY2hpbGRDb25maWcsIHByb3ApICYmCiAgICAgICAgICAgICAgICBpc09iamVjdChwYXJlbnRDb25maWdbcHJvcF0pKSB7CiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSBjaGFuZ2VzIHRvIHByb3BlcnRpZXMgZG9uJ3QgbW9kaWZ5IHBhcmVudCBjb25maWcKICAgICAgICAgICAgcmVzW3Byb3BdID0gZXh0ZW5kKHt9LCByZXNbcHJvcF0pOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIExvY2FsZShjb25maWcpIHsKICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgIHRoaXMuc2V0KGNvbmZpZyk7CiAgICB9Cn0KCnZhciBrZXlzOwoKaWYgKE9iamVjdC5rZXlzKSB7CiAgICBrZXlzID0gT2JqZWN0LmtleXM7Cn0gZWxzZSB7CiAgICBrZXlzID0gZnVuY3Rpb24gKG9iaikgewogICAgICAgIHZhciBpLCByZXMgPSBbXTsKICAgICAgICBmb3IgKGkgaW4gb2JqKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wKG9iaiwgaSkpIHsKICAgICAgICAgICAgICAgIHJlcy5wdXNoKGkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9Owp9Cgp2YXIgZGVmYXVsdENhbGVuZGFyID0gewogICAgc2FtZURheSA6ICdbVG9kYXkgYXRdIExUJywKICAgIG5leHREYXkgOiAnW1RvbW9ycm93IGF0XSBMVCcsCiAgICBuZXh0V2VlayA6ICdkZGRkIFthdF0gTFQnLAogICAgbGFzdERheSA6ICdbWWVzdGVyZGF5IGF0XSBMVCcsCiAgICBsYXN0V2VlayA6ICdbTGFzdF0gZGRkZCBbYXRdIExUJywKICAgIHNhbWVFbHNlIDogJ0wnCn07CgpmdW5jdGlvbiBjYWxlbmRhciAoa2V5LCBtb20sIG5vdykgewogICAgdmFyIG91dHB1dCA9IHRoaXMuX2NhbGVuZGFyW2tleV0gfHwgdGhpcy5fY2FsZW5kYXJbJ3NhbWVFbHNlJ107CiAgICByZXR1cm4gaXNGdW5jdGlvbihvdXRwdXQpID8gb3V0cHV0LmNhbGwobW9tLCBub3cpIDogb3V0cHV0Owp9Cgp2YXIgZGVmYXVsdExvbmdEYXRlRm9ybWF0ID0gewogICAgTFRTICA6ICdoOm1tOnNzIEEnLAogICAgTFQgICA6ICdoOm1tIEEnLAogICAgTCAgICA6ICdNTS9ERC9ZWVlZJywKICAgIExMICAgOiAnTU1NTSBELCBZWVlZJywKICAgIExMTCAgOiAnTU1NTSBELCBZWVlZIGg6bW0gQScsCiAgICBMTExMIDogJ2RkZGQsIE1NTU0gRCwgWVlZWSBoOm1tIEEnCn07CgpmdW5jdGlvbiBsb25nRGF0ZUZvcm1hdCAoa2V5KSB7CiAgICB2YXIgZm9ybWF0ID0gdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5XSwKICAgICAgICBmb3JtYXRVcHBlciA9IHRoaXMuX2xvbmdEYXRlRm9ybWF0W2tleS50b1VwcGVyQ2FzZSgpXTsKCiAgICBpZiAoZm9ybWF0IHx8ICFmb3JtYXRVcHBlcikgewogICAgICAgIHJldHVybiBmb3JtYXQ7CiAgICB9CgogICAgdGhpcy5fbG9uZ0RhdGVGb3JtYXRba2V5XSA9IGZvcm1hdFVwcGVyLnJlcGxhY2UoL01NTU18TU18RER8ZGRkZC9nLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgcmV0dXJuIHZhbC5zbGljZSgxKTsKICAgIH0pOwoKICAgIHJldHVybiB0aGlzLl9sb25nRGF0ZUZvcm1hdFtrZXldOwp9Cgp2YXIgZGVmYXVsdEludmFsaWREYXRlID0gJ0ludmFsaWQgZGF0ZSc7CgpmdW5jdGlvbiBpbnZhbGlkRGF0ZSAoKSB7CiAgICByZXR1cm4gdGhpcy5faW52YWxpZERhdGU7Cn0KCnZhciBkZWZhdWx0T3JkaW5hbCA9ICclZCc7CnZhciBkZWZhdWx0RGF5T2ZNb250aE9yZGluYWxQYXJzZSA9IC9cZHsxLDJ9LzsKCmZ1bmN0aW9uIG9yZGluYWwgKG51bWJlcikgewogICAgcmV0dXJuIHRoaXMuX29yZGluYWwucmVwbGFjZSgnJWQnLCBudW1iZXIpOwp9Cgp2YXIgZGVmYXVsdFJlbGF0aXZlVGltZSA9IHsKICAgIGZ1dHVyZSA6ICdpbiAlcycsCiAgICBwYXN0ICAgOiAnJXMgYWdvJywKICAgIHMgIDogJ2EgZmV3IHNlY29uZHMnLAogICAgc3MgOiAnJWQgc2Vjb25kcycsCiAgICBtICA6ICdhIG1pbnV0ZScsCiAgICBtbSA6ICclZCBtaW51dGVzJywKICAgIGggIDogJ2FuIGhvdXInLAogICAgaGggOiAnJWQgaG91cnMnLAogICAgZCAgOiAnYSBkYXknLAogICAgZGQgOiAnJWQgZGF5cycsCiAgICBNICA6ICdhIG1vbnRoJywKICAgIE1NIDogJyVkIG1vbnRocycsCiAgICB5ICA6ICdhIHllYXInLAogICAgeXkgOiAnJWQgeWVhcnMnCn07CgpmdW5jdGlvbiByZWxhdGl2ZVRpbWUgKG51bWJlciwgd2l0aG91dFN1ZmZpeCwgc3RyaW5nLCBpc0Z1dHVyZSkgewogICAgdmFyIG91dHB1dCA9IHRoaXMuX3JlbGF0aXZlVGltZVtzdHJpbmddOwogICAgcmV0dXJuIChpc0Z1bmN0aW9uKG91dHB1dCkpID8KICAgICAgICBvdXRwdXQobnVtYmVyLCB3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKSA6CiAgICAgICAgb3V0cHV0LnJlcGxhY2UoLyVkL2ksIG51bWJlcik7Cn0KCmZ1bmN0aW9uIHBhc3RGdXR1cmUgKGRpZmYsIG91dHB1dCkgewogICAgdmFyIGZvcm1hdCA9IHRoaXMuX3JlbGF0aXZlVGltZVtkaWZmID4gMCA/ICdmdXR1cmUnIDogJ3Bhc3QnXTsKICAgIHJldHVybiBpc0Z1bmN0aW9uKGZvcm1hdCkgPyBmb3JtYXQob3V0cHV0KSA6IGZvcm1hdC5yZXBsYWNlKC8lcy9pLCBvdXRwdXQpOwp9Cgp2YXIgYWxpYXNlcyA9IHt9OwoKZnVuY3Rpb24gYWRkVW5pdEFsaWFzICh1bml0LCBzaG9ydGhhbmQpIHsKICAgIHZhciBsb3dlckNhc2UgPSB1bml0LnRvTG93ZXJDYXNlKCk7CiAgICBhbGlhc2VzW2xvd2VyQ2FzZV0gPSBhbGlhc2VzW2xvd2VyQ2FzZSArICdzJ10gPSBhbGlhc2VzW3Nob3J0aGFuZF0gPSB1bml0Owp9CgpmdW5jdGlvbiBub3JtYWxpemVVbml0cyh1bml0cykgewogICAgcmV0dXJuIHR5cGVvZiB1bml0cyA9PT0gJ3N0cmluZycgPyBhbGlhc2VzW3VuaXRzXSB8fCBhbGlhc2VzW3VuaXRzLnRvTG93ZXJDYXNlKCldIDogdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBub3JtYWxpemVPYmplY3RVbml0cyhpbnB1dE9iamVjdCkgewogICAgdmFyIG5vcm1hbGl6ZWRJbnB1dCA9IHt9LAogICAgICAgIG5vcm1hbGl6ZWRQcm9wLAogICAgICAgIHByb3A7CgogICAgZm9yIChwcm9wIGluIGlucHV0T2JqZWN0KSB7CiAgICAgICAgaWYgKGhhc093blByb3AoaW5wdXRPYmplY3QsIHByb3ApKSB7CiAgICAgICAgICAgIG5vcm1hbGl6ZWRQcm9wID0gbm9ybWFsaXplVW5pdHMocHJvcCk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkUHJvcCkgewogICAgICAgICAgICAgICAgbm9ybWFsaXplZElucHV0W25vcm1hbGl6ZWRQcm9wXSA9IGlucHV0T2JqZWN0W3Byb3BdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBub3JtYWxpemVkSW5wdXQ7Cn0KCnZhciBwcmlvcml0aWVzID0ge307CgpmdW5jdGlvbiBhZGRVbml0UHJpb3JpdHkodW5pdCwgcHJpb3JpdHkpIHsKICAgIHByaW9yaXRpZXNbdW5pdF0gPSBwcmlvcml0eTsKfQoKZnVuY3Rpb24gZ2V0UHJpb3JpdGl6ZWRVbml0cyh1bml0c09iaikgewogICAgdmFyIHVuaXRzID0gW107CiAgICBmb3IgKHZhciB1IGluIHVuaXRzT2JqKSB7CiAgICAgICAgdW5pdHMucHVzaCh7dW5pdDogdSwgcHJpb3JpdHk6IHByaW9yaXRpZXNbdV19KTsKICAgIH0KICAgIHVuaXRzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYS5wcmlvcml0eSAtIGIucHJpb3JpdHk7CiAgICB9KTsKICAgIHJldHVybiB1bml0czsKfQoKZnVuY3Rpb24gemVyb0ZpbGwobnVtYmVyLCB0YXJnZXRMZW5ndGgsIGZvcmNlU2lnbikgewogICAgdmFyIGFic051bWJlciA9ICcnICsgTWF0aC5hYnMobnVtYmVyKSwKICAgICAgICB6ZXJvc1RvRmlsbCA9IHRhcmdldExlbmd0aCAtIGFic051bWJlci5sZW5ndGgsCiAgICAgICAgc2lnbiA9IG51bWJlciA+PSAwOwogICAgcmV0dXJuIChzaWduID8gKGZvcmNlU2lnbiA/ICcrJyA6ICcnKSA6ICctJykgKwogICAgICAgIE1hdGgucG93KDEwLCBNYXRoLm1heCgwLCB6ZXJvc1RvRmlsbCkpLnRvU3RyaW5nKCkuc3Vic3RyKDEpICsgYWJzTnVtYmVyOwp9Cgp2YXIgZm9ybWF0dGluZ1Rva2VucyA9IC8oXFtbXlxbXSpcXSl8KFxcKT8oW0hoXW1tKHNzKT98TW98TU0/TT9NP3xEb3xERERvfEREP0Q/RD98ZGRkP2Q/fGRvP3x3W298d10/fFdbb3xXXT98UW8/fFlZWVlZWXxZWVlZWXxZWVlZfFlZfGdnKGdnZz8pP3xHRyhHR0c/KT98ZXxFfGF8QXxoaD98SEg/fGtrP3xtbT98c3M/fFN7MSw5fXx4fFh8eno/fFpaP3wuKS9nOwoKdmFyIGxvY2FsRm9ybWF0dGluZ1Rva2VucyA9IC8oXFtbXlxbXSpcXSl8KFxcKT8oTFRTfExUfExMP0w/TD98bHsxLDR9KS9nOwoKdmFyIGZvcm1hdEZ1bmN0aW9ucyA9IHt9OwoKdmFyIGZvcm1hdFRva2VuRnVuY3Rpb25zID0ge307CgovLyB0b2tlbjogICAgJ00nCi8vIHBhZGRlZDogICBbJ01NJywgMl0KLy8gb3JkaW5hbDogICdNbycKLy8gY2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsgdGhpcy5tb250aCgpICsgMSB9CmZ1bmN0aW9uIGFkZEZvcm1hdFRva2VuICh0b2tlbiwgcGFkZGVkLCBvcmRpbmFsLCBjYWxsYmFjaykgewogICAgdmFyIGZ1bmMgPSBjYWxsYmFjazsKICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgZnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbY2FsbGJhY2tdKCk7CiAgICAgICAgfTsKICAgIH0KICAgIGlmICh0b2tlbikgewogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zW3Rva2VuXSA9IGZ1bmM7CiAgICB9CiAgICBpZiAocGFkZGVkKSB7CiAgICAgICAgZm9ybWF0VG9rZW5GdW5jdGlvbnNbcGFkZGVkWzBdXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHplcm9GaWxsKGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgcGFkZGVkWzFdLCBwYWRkZWRbMl0pOwogICAgICAgIH07CiAgICB9CiAgICBpZiAob3JkaW5hbCkgewogICAgICAgIGZvcm1hdFRva2VuRnVuY3Rpb25zW29yZGluYWxdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkub3JkaW5hbChmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIHRva2VuKTsKICAgICAgICB9OwogICAgfQp9CgpmdW5jdGlvbiByZW1vdmVGb3JtYXR0aW5nVG9rZW5zKGlucHV0KSB7CiAgICBpZiAoaW5wdXQubWF0Y2goL1xbW1xzXFNdLykpIHsKICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXlxbfFxdJC9nLCAnJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvXFwvZywgJycpOwp9CgpmdW5jdGlvbiBtYWtlRm9ybWF0RnVuY3Rpb24oZm9ybWF0KSB7CiAgICB2YXIgYXJyYXkgPSBmb3JtYXQubWF0Y2goZm9ybWF0dGluZ1Rva2VucyksIGksIGxlbmd0aDsKCiAgICBmb3IgKGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGlmIChmb3JtYXRUb2tlbkZ1bmN0aW9uc1thcnJheVtpXV0pIHsKICAgICAgICAgICAgYXJyYXlbaV0gPSBmb3JtYXRUb2tlbkZ1bmN0aW9uc1thcnJheVtpXV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXJyYXlbaV0gPSByZW1vdmVGb3JtYXR0aW5nVG9rZW5zKGFycmF5W2ldKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uIChtb20pIHsKICAgICAgICB2YXIgb3V0cHV0ID0gJycsIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dCArPSBpc0Z1bmN0aW9uKGFycmF5W2ldKSA/IGFycmF5W2ldLmNhbGwobW9tLCBmb3JtYXQpIDogYXJyYXlbaV07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9Owp9CgovLyBmb3JtYXQgZGF0ZSB1c2luZyBuYXRpdmUgZGF0ZSBvYmplY3QKZnVuY3Rpb24gZm9ybWF0TW9tZW50KG0sIGZvcm1hdCkgewogICAgaWYgKCFtLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiBtLmxvY2FsZURhdGEoKS5pbnZhbGlkRGF0ZSgpOwogICAgfQoKICAgIGZvcm1hdCA9IGV4cGFuZEZvcm1hdChmb3JtYXQsIG0ubG9jYWxlRGF0YSgpKTsKICAgIGZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdID0gZm9ybWF0RnVuY3Rpb25zW2Zvcm1hdF0gfHwgbWFrZUZvcm1hdEZ1bmN0aW9uKGZvcm1hdCk7CgogICAgcmV0dXJuIGZvcm1hdEZ1bmN0aW9uc1tmb3JtYXRdKG0pOwp9CgpmdW5jdGlvbiBleHBhbmRGb3JtYXQoZm9ybWF0LCBsb2NhbGUpIHsKICAgIHZhciBpID0gNTsKCiAgICBmdW5jdGlvbiByZXBsYWNlTG9uZ0RhdGVGb3JtYXRUb2tlbnMoaW5wdXQpIHsKICAgICAgICByZXR1cm4gbG9jYWxlLmxvbmdEYXRlRm9ybWF0KGlucHV0KSB8fCBpbnB1dDsKICAgIH0KCiAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgIHdoaWxlIChpID49IDAgJiYgbG9jYWxGb3JtYXR0aW5nVG9rZW5zLnRlc3QoZm9ybWF0KSkgewogICAgICAgIGZvcm1hdCA9IGZvcm1hdC5yZXBsYWNlKGxvY2FsRm9ybWF0dGluZ1Rva2VucywgcmVwbGFjZUxvbmdEYXRlRm9ybWF0VG9rZW5zKTsKICAgICAgICBsb2NhbEZvcm1hdHRpbmdUb2tlbnMubGFzdEluZGV4ID0gMDsKICAgICAgICBpIC09IDE7CiAgICB9CgogICAgcmV0dXJuIGZvcm1hdDsKfQoKdmFyIG1hdGNoMSAgICAgICAgID0gL1xkLzsgICAgICAgICAgICAvLyAgICAgICAwIC0gOQp2YXIgbWF0Y2gyICAgICAgICAgPSAvXGRcZC87ICAgICAgICAgIC8vICAgICAgMDAgLSA5OQp2YXIgbWF0Y2gzICAgICAgICAgPSAvXGR7M30vOyAgICAgICAgIC8vICAgICAwMDAgLSA5OTkKdmFyIG1hdGNoNCAgICAgICAgID0gL1xkezR9LzsgICAgICAgICAvLyAgICAwMDAwIC0gOTk5OQp2YXIgbWF0Y2g2ICAgICAgICAgPSAvWystXT9cZHs2fS87ICAgIC8vIC05OTk5OTkgLSA5OTk5OTkKdmFyIG1hdGNoMXRvMiAgICAgID0gL1xkXGQ/LzsgICAgICAgICAvLyAgICAgICAwIC0gOTkKdmFyIG1hdGNoM3RvNCAgICAgID0gL1xkXGRcZFxkPy87ICAgICAvLyAgICAgOTk5IC0gOTk5OQp2YXIgbWF0Y2g1dG82ICAgICAgPSAvXGRcZFxkXGRcZFxkPy87IC8vICAgOTk5OTkgLSA5OTk5OTkKdmFyIG1hdGNoMXRvMyAgICAgID0gL1xkezEsM30vOyAgICAgICAvLyAgICAgICAwIC0gOTk5CnZhciBtYXRjaDF0bzQgICAgICA9IC9cZHsxLDR9LzsgICAgICAgLy8gICAgICAgMCAtIDk5OTkKdmFyIG1hdGNoMXRvNiAgICAgID0gL1srLV0/XGR7MSw2fS87ICAvLyAtOTk5OTk5IC0gOTk5OTk5Cgp2YXIgbWF0Y2hVbnNpZ25lZCAgPSAvXGQrLzsgICAgICAgICAgIC8vICAgICAgIDAgLSBpbmYKdmFyIG1hdGNoU2lnbmVkICAgID0gL1srLV0/XGQrLzsgICAgICAvLyAgICAtaW5mIC0gaW5mCgp2YXIgbWF0Y2hPZmZzZXQgICAgPSAvWnxbKy1dXGRcZDo/XGRcZC9naTsgLy8gKzAwOjAwIC0wMDowMCArMDAwMCAtMDAwMCBvciBaCnZhciBtYXRjaFNob3J0T2Zmc2V0ID0gL1p8WystXVxkXGQoPzo6P1xkXGQpPy9naTsgLy8gKzAwIC0wMCArMDA6MDAgLTAwOjAwICswMDAwIC0wMDAwIG9yIFoKCnZhciBtYXRjaFRpbWVzdGFtcCA9IC9bKy1dP1xkKyhcLlxkezEsM30pPy87IC8vIDEyMzQ1Njc4OSAxMjM0NTY3ODkuMTIzCgovLyBhbnkgd29yZCAob3IgdHdvKSBjaGFyYWN0ZXJzIG9yIG51bWJlcnMgaW5jbHVkaW5nIHR3by90aHJlZSB3b3JkIG1vbnRoIGluIGFyYWJpYy4KLy8gaW5jbHVkZXMgc2NvdHRpc2ggZ2FlbGljIHR3byB3b3JkIGFuZCBoeXBoZW5hdGVkIG1vbnRocwp2YXIgbWF0Y2hXb3JkID0gL1swLTldezAsMjU2fVsnYS16XHUwMEEwLVx1MDVGRlx1MDcwMC1cdUQ3RkZcdUY5MDAtXHVGRENGXHVGREYwLVx1RkYwN1x1RkYxMC1cdUZGRUZdezEsMjU2fXxbXHUwNjAwLVx1MDZGRlwvXXsxLDI1Nn0oXHMqP1tcdTA2MDAtXHUwNkZGXXsxLDI1Nn0pezEsMn0vaTsKCgp2YXIgcmVnZXhlcyA9IHt9OwoKZnVuY3Rpb24gYWRkUmVnZXhUb2tlbiAodG9rZW4sIHJlZ2V4LCBzdHJpY3RSZWdleCkgewogICAgcmVnZXhlc1t0b2tlbl0gPSBpc0Z1bmN0aW9uKHJlZ2V4KSA/IHJlZ2V4IDogZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGVEYXRhKSB7CiAgICAgICAgcmV0dXJuIChpc1N0cmljdCAmJiBzdHJpY3RSZWdleCkgPyBzdHJpY3RSZWdleCA6IHJlZ2V4OwogICAgfTsKfQoKZnVuY3Rpb24gZ2V0UGFyc2VSZWdleEZvclRva2VuICh0b2tlbiwgY29uZmlnKSB7CiAgICBpZiAoIWhhc093blByb3AocmVnZXhlcywgdG9rZW4pKSB7CiAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAodW5lc2NhcGVGb3JtYXQodG9rZW4pKTsKICAgIH0KCiAgICByZXR1cm4gcmVnZXhlc1t0b2tlbl0oY29uZmlnLl9zdHJpY3QsIGNvbmZpZy5fbG9jYWxlKTsKfQoKLy8gQ29kZSBmcm9tIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMzU2MTQ5My9pcy10aGVyZS1hLXJlZ2V4cC1lc2NhcGUtZnVuY3Rpb24taW4tamF2YXNjcmlwdApmdW5jdGlvbiB1bmVzY2FwZUZvcm1hdChzKSB7CiAgICByZXR1cm4gcmVnZXhFc2NhcGUocy5yZXBsYWNlKCdcXCcsICcnKS5yZXBsYWNlKC9cXChcWyl8XFwoXF0pfFxbKFteXF1cW10qKVxdfFxcKC4pL2csIGZ1bmN0aW9uIChtYXRjaGVkLCBwMSwgcDIsIHAzLCBwNCkgewogICAgICAgIHJldHVybiBwMSB8fCBwMiB8fCBwMyB8fCBwNDsKICAgIH0pKTsKfQoKZnVuY3Rpb24gcmVnZXhFc2NhcGUocykgewogICAgcmV0dXJuIHMucmVwbGFjZSgvWy1cL1xcXiQqKz8uKCl8W1xde31dL2csICdcXCQmJyk7Cn0KCnZhciB0b2tlbnMgPSB7fTsKCmZ1bmN0aW9uIGFkZFBhcnNlVG9rZW4gKHRva2VuLCBjYWxsYmFjaykgewogICAgdmFyIGksIGZ1bmMgPSBjYWxsYmFjazsKICAgIGlmICh0eXBlb2YgdG9rZW4gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdG9rZW4gPSBbdG9rZW5dOwogICAgfQogICAgaWYgKGlzTnVtYmVyKGNhbGxiYWNrKSkgewogICAgICAgIGZ1bmMgPSBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICAgICAgICAgIGFycmF5W2NhbGxiYWNrXSA9IHRvSW50KGlucHV0KTsKICAgICAgICB9OwogICAgfQogICAgZm9yIChpID0gMDsgaSA8IHRva2VuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9rZW5zW3Rva2VuW2ldXSA9IGZ1bmM7CiAgICB9Cn0KCmZ1bmN0aW9uIGFkZFdlZWtQYXJzZVRva2VuICh0b2tlbiwgY2FsbGJhY2spIHsKICAgIGFkZFBhcnNlVG9rZW4odG9rZW4sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZywgdG9rZW4pIHsKICAgICAgICBjb25maWcuX3cgPSBjb25maWcuX3cgfHwge307CiAgICAgICAgY2FsbGJhY2soaW5wdXQsIGNvbmZpZy5fdywgY29uZmlnLCB0b2tlbik7CiAgICB9KTsKfQoKZnVuY3Rpb24gYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIGlucHV0LCBjb25maWcpIHsKICAgIGlmIChpbnB1dCAhPSBudWxsICYmIGhhc093blByb3AodG9rZW5zLCB0b2tlbikpIHsKICAgICAgICB0b2tlbnNbdG9rZW5dKGlucHV0LCBjb25maWcuX2EsIGNvbmZpZywgdG9rZW4pOwogICAgfQp9Cgp2YXIgWUVBUiA9IDA7CnZhciBNT05USCA9IDE7CnZhciBEQVRFID0gMjsKdmFyIEhPVVIgPSAzOwp2YXIgTUlOVVRFID0gNDsKdmFyIFNFQ09ORCA9IDU7CnZhciBNSUxMSVNFQ09ORCA9IDY7CnZhciBXRUVLID0gNzsKdmFyIFdFRUtEQVkgPSA4OwoKLy8gRk9STUFUVElORwoKYWRkRm9ybWF0VG9rZW4oJ1knLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICB2YXIgeSA9IHRoaXMueWVhcigpOwogICAgcmV0dXJuIHkgPD0gOTk5OSA/ICcnICsgeSA6ICcrJyArIHk7Cn0pOwoKYWRkRm9ybWF0VG9rZW4oMCwgWydZWScsIDJdLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy55ZWFyKCkgJSAxMDA7Cn0pOwoKYWRkRm9ybWF0VG9rZW4oMCwgWydZWVlZJywgICA0XSwgICAgICAgMCwgJ3llYXInKTsKYWRkRm9ybWF0VG9rZW4oMCwgWydZWVlZWScsICA1XSwgICAgICAgMCwgJ3llYXInKTsKYWRkRm9ybWF0VG9rZW4oMCwgWydZWVlZWVknLCA2LCB0cnVlXSwgMCwgJ3llYXInKTsKCi8vIEFMSUFTRVMKCmFkZFVuaXRBbGlhcygneWVhcicsICd5Jyk7CgovLyBQUklPUklUSUVTCgphZGRVbml0UHJpb3JpdHkoJ3llYXInLCAxKTsKCi8vIFBBUlNJTkcKCmFkZFJlZ2V4VG9rZW4oJ1knLCAgICAgIG1hdGNoU2lnbmVkKTsKYWRkUmVnZXhUb2tlbignWVknLCAgICAgbWF0Y2gxdG8yLCBtYXRjaDIpOwphZGRSZWdleFRva2VuKCdZWVlZJywgICBtYXRjaDF0bzQsIG1hdGNoNCk7CmFkZFJlZ2V4VG9rZW4oJ1lZWVlZJywgIG1hdGNoMXRvNiwgbWF0Y2g2KTsKYWRkUmVnZXhUb2tlbignWVlZWVlZJywgbWF0Y2gxdG82LCBtYXRjaDYpOwoKYWRkUGFyc2VUb2tlbihbJ1lZWVlZJywgJ1lZWVlZWSddLCBZRUFSKTsKYWRkUGFyc2VUb2tlbignWVlZWScsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXkpIHsKICAgIGFycmF5W1lFQVJdID0gaW5wdXQubGVuZ3RoID09PSAyID8gaG9va3MucGFyc2VUd29EaWdpdFllYXIoaW5wdXQpIDogdG9JbnQoaW5wdXQpOwp9KTsKYWRkUGFyc2VUb2tlbignWVknLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICBhcnJheVtZRUFSXSA9IGhvb2tzLnBhcnNlVHdvRGlnaXRZZWFyKGlucHV0KTsKfSk7CmFkZFBhcnNlVG9rZW4oJ1knLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICBhcnJheVtZRUFSXSA9IHBhcnNlSW50KGlucHV0LCAxMCk7Cn0pOwoKLy8gSEVMUEVSUwoKZnVuY3Rpb24gZGF5c0luWWVhcih5ZWFyKSB7CiAgICByZXR1cm4gaXNMZWFwWWVhcih5ZWFyKSA/IDM2NiA6IDM2NTsKfQoKZnVuY3Rpb24gaXNMZWFwWWVhcih5ZWFyKSB7CiAgICByZXR1cm4gKHllYXIgJSA0ID09PSAwICYmIHllYXIgJSAxMDAgIT09IDApIHx8IHllYXIgJSA0MDAgPT09IDA7Cn0KCi8vIEhPT0tTCgpob29rcy5wYXJzZVR3b0RpZ2l0WWVhciA9IGZ1bmN0aW9uIChpbnB1dCkgewogICAgcmV0dXJuIHRvSW50KGlucHV0KSArICh0b0ludChpbnB1dCkgPiA2OCA/IDE5MDAgOiAyMDAwKTsKfTsKCi8vIE1PTUVOVFMKCnZhciBnZXRTZXRZZWFyID0gbWFrZUdldFNldCgnRnVsbFllYXInLCB0cnVlKTsKCmZ1bmN0aW9uIGdldElzTGVhcFllYXIgKCkgewogICAgcmV0dXJuIGlzTGVhcFllYXIodGhpcy55ZWFyKCkpOwp9CgpmdW5jdGlvbiBtYWtlR2V0U2V0ICh1bml0LCBrZWVwVGltZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldCQxKHRoaXMsIHVuaXQsIHZhbHVlKTsKICAgICAgICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIGtlZXBUaW1lKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldCh0aGlzLCB1bml0KTsKICAgICAgICB9CiAgICB9Owp9CgpmdW5jdGlvbiBnZXQgKG1vbSwgdW5pdCkgewogICAgcmV0dXJuIG1vbS5pc1ZhbGlkKCkgPwogICAgICAgIG1vbS5fZFsnZ2V0JyArIChtb20uX2lzVVRDID8gJ1VUQycgOiAnJykgKyB1bml0XSgpIDogTmFOOwp9CgpmdW5jdGlvbiBzZXQkMSAobW9tLCB1bml0LCB2YWx1ZSkgewogICAgaWYgKG1vbS5pc1ZhbGlkKCkgJiYgIWlzTmFOKHZhbHVlKSkgewogICAgICAgIGlmICh1bml0ID09PSAnRnVsbFllYXInICYmIGlzTGVhcFllYXIobW9tLnllYXIoKSkgJiYgbW9tLm1vbnRoKCkgPT09IDEgJiYgbW9tLmRhdGUoKSA9PT0gMjkpIHsKICAgICAgICAgICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArIHVuaXRdKHZhbHVlLCBtb20ubW9udGgoKSwgZGF5c0luTW9udGgodmFsdWUsIG1vbS5tb250aCgpKSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBtb20uX2RbJ3NldCcgKyAobW9tLl9pc1VUQyA/ICdVVEMnIDogJycpICsgdW5pdF0odmFsdWUpOwogICAgICAgIH0KICAgIH0KfQoKLy8gTU9NRU5UUwoKZnVuY3Rpb24gc3RyaW5nR2V0ICh1bml0cykgewogICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICBpZiAoaXNGdW5jdGlvbih0aGlzW3VuaXRzXSkpIHsKICAgICAgICByZXR1cm4gdGhpc1t1bml0c10oKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9CgoKZnVuY3Rpb24gc3RyaW5nU2V0ICh1bml0cywgdmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdW5pdHMgPT09ICdvYmplY3QnKSB7CiAgICAgICAgdW5pdHMgPSBub3JtYWxpemVPYmplY3RVbml0cyh1bml0cyk7CiAgICAgICAgdmFyIHByaW9yaXRpemVkID0gZ2V0UHJpb3JpdGl6ZWRVbml0cyh1bml0cyk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcmlvcml0aXplZC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0aGlzW3ByaW9yaXRpemVkW2ldLnVuaXRdKHVuaXRzW3ByaW9yaXRpemVkW2ldLnVuaXRdKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwogICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoaXNbdW5pdHNdKSkgewogICAgICAgICAgICByZXR1cm4gdGhpc1t1bml0c10odmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwp9CgpmdW5jdGlvbiBtb2QobiwgeCkgewogICAgcmV0dXJuICgobiAlIHgpICsgeCkgJSB4Owp9Cgp2YXIgaW5kZXhPZjsKCmlmIChBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogICAgaW5kZXhPZiA9IEFycmF5LnByb3RvdHlwZS5pbmRleE9mOwp9IGVsc2UgewogICAgaW5kZXhPZiA9IGZ1bmN0aW9uIChvKSB7CiAgICAgICAgLy8gSSBrbm93CiAgICAgICAgdmFyIGk7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgaWYgKHRoaXNbaV0gPT09IG8pIHsKICAgICAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiAtMTsKICAgIH07Cn0KCmZ1bmN0aW9uIGRheXNJbk1vbnRoKHllYXIsIG1vbnRoKSB7CiAgICBpZiAoaXNOYU4oeWVhcikgfHwgaXNOYU4obW9udGgpKSB7CiAgICAgICAgcmV0dXJuIE5hTjsKICAgIH0KICAgIHZhciBtb2RNb250aCA9IG1vZChtb250aCwgMTIpOwogICAgeWVhciArPSAobW9udGggLSBtb2RNb250aCkgLyAxMjsKICAgIHJldHVybiBtb2RNb250aCA9PT0gMSA/IChpc0xlYXBZZWFyKHllYXIpID8gMjkgOiAyOCkgOiAoMzEgLSBtb2RNb250aCAlIDcgJSAyKTsKfQoKLy8gRk9STUFUVElORwoKYWRkRm9ybWF0VG9rZW4oJ00nLCBbJ01NJywgMl0sICdNbycsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLm1vbnRoKCkgKyAxOwp9KTsKCmFkZEZvcm1hdFRva2VuKCdNTU0nLCAwLCAwLCBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubW9udGhzU2hvcnQodGhpcywgZm9ybWF0KTsKfSk7CgphZGRGb3JtYXRUb2tlbignTU1NTScsIDAsIDAsIGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5tb250aHModGhpcywgZm9ybWF0KTsKfSk7CgovLyBBTElBU0VTCgphZGRVbml0QWxpYXMoJ21vbnRoJywgJ00nKTsKCi8vIFBSSU9SSVRZCgphZGRVbml0UHJpb3JpdHkoJ21vbnRoJywgOCk7CgovLyBQQVJTSU5HCgphZGRSZWdleFRva2VuKCdNJywgICAgbWF0Y2gxdG8yKTsKYWRkUmVnZXhUb2tlbignTU0nLCAgIG1hdGNoMXRvMiwgbWF0Y2gyKTsKYWRkUmVnZXhUb2tlbignTU1NJywgIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLm1vbnRoc1Nob3J0UmVnZXgoaXNTdHJpY3QpOwp9KTsKYWRkUmVnZXhUb2tlbignTU1NTScsIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLm1vbnRoc1JlZ2V4KGlzU3RyaWN0KTsKfSk7CgphZGRQYXJzZVRva2VuKFsnTScsICdNTSddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICBhcnJheVtNT05USF0gPSB0b0ludChpbnB1dCkgLSAxOwp9KTsKCmFkZFBhcnNlVG9rZW4oWydNTU0nLCAnTU1NTSddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcsIHRva2VuKSB7CiAgICB2YXIgbW9udGggPSBjb25maWcuX2xvY2FsZS5tb250aHNQYXJzZShpbnB1dCwgdG9rZW4sIGNvbmZpZy5fc3RyaWN0KTsKICAgIC8vIGlmIHdlIGRpZG4ndCBmaW5kIGEgbW9udGggbmFtZSwgbWFyayB0aGUgZGF0ZSBhcyBpbnZhbGlkLgogICAgaWYgKG1vbnRoICE9IG51bGwpIHsKICAgICAgICBhcnJheVtNT05USF0gPSBtb250aDsKICAgIH0gZWxzZSB7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaW52YWxpZE1vbnRoID0gaW5wdXQ7CiAgICB9Cn0pOwoKLy8gTE9DQUxFUwoKdmFyIE1PTlRIU19JTl9GT1JNQVQgPSAvRFtvRF0/KFxbW15cW1xdXSpcXXxccykrTU1NTT8vOwp2YXIgZGVmYXVsdExvY2FsZU1vbnRocyA9ICdKYW51YXJ5X0ZlYnJ1YXJ5X01hcmNoX0FwcmlsX01heV9KdW5lX0p1bHlfQXVndXN0X1NlcHRlbWJlcl9PY3RvYmVyX05vdmVtYmVyX0RlY2VtYmVyJy5zcGxpdCgnXycpOwpmdW5jdGlvbiBsb2NhbGVNb250aHMgKG0sIGZvcm1hdCkgewogICAgaWYgKCFtKSB7CiAgICAgICAgcmV0dXJuIGlzQXJyYXkodGhpcy5fbW9udGhzKSA/IHRoaXMuX21vbnRocyA6CiAgICAgICAgICAgIHRoaXMuX21vbnRoc1snc3RhbmRhbG9uZSddOwogICAgfQogICAgcmV0dXJuIGlzQXJyYXkodGhpcy5fbW9udGhzKSA/IHRoaXMuX21vbnRoc1ttLm1vbnRoKCldIDoKICAgICAgICB0aGlzLl9tb250aHNbKHRoaXMuX21vbnRocy5pc0Zvcm1hdCB8fCBNT05USFNfSU5fRk9STUFUKS50ZXN0KGZvcm1hdCkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ11bbS5tb250aCgpXTsKfQoKdmFyIGRlZmF1bHRMb2NhbGVNb250aHNTaG9ydCA9ICdKYW5fRmViX01hcl9BcHJfTWF5X0p1bl9KdWxfQXVnX1NlcF9PY3RfTm92X0RlYycuc3BsaXQoJ18nKTsKZnVuY3Rpb24gbG9jYWxlTW9udGhzU2hvcnQgKG0sIGZvcm1hdCkgewogICAgaWYgKCFtKSB7CiAgICAgICAgcmV0dXJuIGlzQXJyYXkodGhpcy5fbW9udGhzU2hvcnQpID8gdGhpcy5fbW9udGhzU2hvcnQgOgogICAgICAgICAgICB0aGlzLl9tb250aHNTaG9ydFsnc3RhbmRhbG9uZSddOwogICAgfQogICAgcmV0dXJuIGlzQXJyYXkodGhpcy5fbW9udGhzU2hvcnQpID8gdGhpcy5fbW9udGhzU2hvcnRbbS5tb250aCgpXSA6CiAgICAgICAgdGhpcy5fbW9udGhzU2hvcnRbTU9OVEhTX0lOX0ZPUk1BVC50ZXN0KGZvcm1hdCkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ11bbS5tb250aCgpXTsKfQoKZnVuY3Rpb24gaGFuZGxlU3RyaWN0UGFyc2UobW9udGhOYW1lLCBmb3JtYXQsIHN0cmljdCkgewogICAgdmFyIGksIGlpLCBtb20sIGxsYyA9IG1vbnRoTmFtZS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZSkgewogICAgICAgIC8vIHRoaXMgaXMgbm90IHVzZWQKICAgICAgICB0aGlzLl9tb250aHNQYXJzZSA9IFtdOwogICAgICAgIHRoaXMuX2xvbmdNb250aHNQYXJzZSA9IFtdOwogICAgICAgIHRoaXMuX3Nob3J0TW9udGhzUGFyc2UgPSBbXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgMTI7ICsraSkgewogICAgICAgICAgICBtb20gPSBjcmVhdGVVVEMoWzIwMDAsIGldKTsKICAgICAgICAgICAgdGhpcy5fc2hvcnRNb250aHNQYXJzZVtpXSA9IHRoaXMubW9udGhzU2hvcnQobW9tLCAnJykudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgICAgICAgICAgdGhpcy5fbG9uZ01vbnRoc1BhcnNlW2ldID0gdGhpcy5tb250aHMobW9tLCAnJykudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHN0cmljdCkgewogICAgICAgIGlmIChmb3JtYXQgPT09ICdNTU0nKSB7CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3Nob3J0TW9udGhzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fbG9uZ01vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGZvcm1hdCA9PT0gJ01NTScpIHsKICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRNb250aHNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX2xvbmdNb250aHNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9sb25nTW9udGhzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpaTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9zaG9ydE1vbnRoc1BhcnNlLCBsbGMpOwogICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gbG9jYWxlTW9udGhzUGFyc2UgKG1vbnRoTmFtZSwgZm9ybWF0LCBzdHJpY3QpIHsKICAgIHZhciBpLCBtb20sIHJlZ2V4OwoKICAgIGlmICh0aGlzLl9tb250aHNQYXJzZUV4YWN0KSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZVN0cmljdFBhcnNlLmNhbGwodGhpcywgbW9udGhOYW1lLCBmb3JtYXQsIHN0cmljdCk7CiAgICB9CgogICAgaWYgKCF0aGlzLl9tb250aHNQYXJzZSkgewogICAgICAgIHRoaXMuX21vbnRoc1BhcnNlID0gW107CiAgICAgICAgdGhpcy5fbG9uZ01vbnRoc1BhcnNlID0gW107CiAgICAgICAgdGhpcy5fc2hvcnRNb250aHNQYXJzZSA9IFtdOwogICAgfQoKICAgIC8vIFRPRE86IGFkZCBzb3J0aW5nCiAgICAvLyBTb3J0aW5nIG1ha2VzIHN1cmUgaWYgb25lIG1vbnRoIChvciBhYmJyKSBpcyBhIHByZWZpeCBvZiBhbm90aGVyCiAgICAvLyBzZWUgc29ydGluZyBpbiBjb21wdXRlTW9udGhzUGFyc2UKICAgIGZvciAoaSA9IDA7IGkgPCAxMjsgaSsrKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CiAgICAgICAgbW9tID0gY3JlYXRlVVRDKFsyMDAwLCBpXSk7CiAgICAgICAgaWYgKHN0cmljdCAmJiAhdGhpcy5fbG9uZ01vbnRoc1BhcnNlW2ldKSB7CiAgICAgICAgICAgIHRoaXMuX2xvbmdNb250aHNQYXJzZVtpXSA9IG5ldyBSZWdFeHAoJ14nICsgdGhpcy5tb250aHMobW9tLCAnJykucmVwbGFjZSgnLicsICcnKSArICckJywgJ2knKTsKICAgICAgICAgICAgdGhpcy5fc2hvcnRNb250aHNQYXJzZVtpXSA9IG5ldyBSZWdFeHAoJ14nICsgdGhpcy5tb250aHNTaG9ydChtb20sICcnKS5yZXBsYWNlKCcuJywgJycpICsgJyQnLCAnaScpOwogICAgICAgIH0KICAgICAgICBpZiAoIXN0cmljdCAmJiAhdGhpcy5fbW9udGhzUGFyc2VbaV0pIHsKICAgICAgICAgICAgcmVnZXggPSAnXicgKyB0aGlzLm1vbnRocyhtb20sICcnKSArICd8XicgKyB0aGlzLm1vbnRoc1Nob3J0KG1vbSwgJycpOwogICAgICAgICAgICB0aGlzLl9tb250aHNQYXJzZVtpXSA9IG5ldyBSZWdFeHAocmVnZXgucmVwbGFjZSgnLicsICcnKSwgJ2knKTsKICAgICAgICB9CiAgICAgICAgLy8gdGVzdCB0aGUgcmVnZXgKICAgICAgICBpZiAoc3RyaWN0ICYmIGZvcm1hdCA9PT0gJ01NTU0nICYmIHRoaXMuX2xvbmdNb250aHNQYXJzZVtpXS50ZXN0KG1vbnRoTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfSBlbHNlIGlmIChzdHJpY3QgJiYgZm9ybWF0ID09PSAnTU1NJyAmJiB0aGlzLl9zaG9ydE1vbnRoc1BhcnNlW2ldLnRlc3QobW9udGhOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9IGVsc2UgaWYgKCFzdHJpY3QgJiYgdGhpcy5fbW9udGhzUGFyc2VbaV0udGVzdChtb250aE5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgIH0KICAgIH0KfQoKLy8gTU9NRU5UUwoKZnVuY3Rpb24gc2V0TW9udGggKG1vbSwgdmFsdWUpIHsKICAgIHZhciBkYXlPZk1vbnRoOwoKICAgIGlmICghbW9tLmlzVmFsaWQoKSkgewogICAgICAgIC8vIE5vIG9wCiAgICAgICAgcmV0dXJuIG1vbTsKICAgIH0KCiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICAgIGlmICgvXlxkKyQvLnRlc3QodmFsdWUpKSB7CiAgICAgICAgICAgIHZhbHVlID0gdG9JbnQodmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gbW9tLmxvY2FsZURhdGEoKS5tb250aHNQYXJzZSh2YWx1ZSk7CiAgICAgICAgICAgIC8vIFRPRE86IEFub3RoZXIgc2lsZW50IGZhaWx1cmU/CiAgICAgICAgICAgIGlmICghaXNOdW1iZXIodmFsdWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW9tOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGRheU9mTW9udGggPSBNYXRoLm1pbihtb20uZGF0ZSgpLCBkYXlzSW5Nb250aChtb20ueWVhcigpLCB2YWx1ZSkpOwogICAgbW9tLl9kWydzZXQnICsgKG1vbS5faXNVVEMgPyAnVVRDJyA6ICcnKSArICdNb250aCddKHZhbHVlLCBkYXlPZk1vbnRoKTsKICAgIHJldHVybiBtb207Cn0KCmZ1bmN0aW9uIGdldFNldE1vbnRoICh2YWx1ZSkgewogICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICBzZXRNb250aCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgaG9va3MudXBkYXRlT2Zmc2V0KHRoaXMsIHRydWUpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZ2V0KHRoaXMsICdNb250aCcpOwogICAgfQp9CgpmdW5jdGlvbiBnZXREYXlzSW5Nb250aCAoKSB7CiAgICByZXR1cm4gZGF5c0luTW9udGgodGhpcy55ZWFyKCksIHRoaXMubW9udGgoKSk7Cn0KCnZhciBkZWZhdWx0TW9udGhzU2hvcnRSZWdleCA9IG1hdGNoV29yZDsKZnVuY3Rpb24gbW9udGhzU2hvcnRSZWdleCAoaXNTdHJpY3QpIHsKICAgIGlmICh0aGlzLl9tb250aHNQYXJzZUV4YWN0KSB7CiAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfbW9udGhzUmVnZXgnKSkgewogICAgICAgICAgICBjb21wdXRlTW9udGhzUGFyc2UuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb250aHNTaG9ydFN0cmljdFJlZ2V4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9tb250aHNTaG9ydFJlZ2V4OwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfbW9udGhzU2hvcnRSZWdleCcpKSB7CiAgICAgICAgICAgIHRoaXMuX21vbnRoc1Nob3J0UmVnZXggPSBkZWZhdWx0TW9udGhzU2hvcnRSZWdleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1Nob3J0U3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPwogICAgICAgICAgICB0aGlzLl9tb250aHNTaG9ydFN0cmljdFJlZ2V4IDogdGhpcy5fbW9udGhzU2hvcnRSZWdleDsKICAgIH0KfQoKdmFyIGRlZmF1bHRNb250aHNSZWdleCA9IG1hdGNoV29yZDsKZnVuY3Rpb24gbW9udGhzUmVnZXggKGlzU3RyaWN0KSB7CiAgICBpZiAodGhpcy5fbW9udGhzUGFyc2VFeGFjdCkgewogICAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX21vbnRoc1JlZ2V4JykpIHsKICAgICAgICAgICAgY29tcHV0ZU1vbnRoc1BhcnNlLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmIChpc1N0cmljdCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9udGhzU3RyaWN0UmVnZXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1JlZ2V4OwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfbW9udGhzUmVnZXgnKSkgewogICAgICAgICAgICB0aGlzLl9tb250aHNSZWdleCA9IGRlZmF1bHRNb250aHNSZWdleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX21vbnRoc1N0cmljdFJlZ2V4ICYmIGlzU3RyaWN0ID8KICAgICAgICAgICAgdGhpcy5fbW9udGhzU3RyaWN0UmVnZXggOiB0aGlzLl9tb250aHNSZWdleDsKICAgIH0KfQoKZnVuY3Rpb24gY29tcHV0ZU1vbnRoc1BhcnNlICgpIHsKICAgIGZ1bmN0aW9uIGNtcExlblJldihhLCBiKSB7CiAgICAgICAgcmV0dXJuIGIubGVuZ3RoIC0gYS5sZW5ndGg7CiAgICB9CgogICAgdmFyIHNob3J0UGllY2VzID0gW10sIGxvbmdQaWVjZXMgPSBbXSwgbWl4ZWRQaWVjZXMgPSBbXSwKICAgICAgICBpLCBtb207CiAgICBmb3IgKGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgaV0pOwogICAgICAgIHNob3J0UGllY2VzLnB1c2godGhpcy5tb250aHNTaG9ydChtb20sICcnKSk7CiAgICAgICAgbG9uZ1BpZWNlcy5wdXNoKHRoaXMubW9udGhzKG1vbSwgJycpKTsKICAgICAgICBtaXhlZFBpZWNlcy5wdXNoKHRoaXMubW9udGhzKG1vbSwgJycpKTsKICAgICAgICBtaXhlZFBpZWNlcy5wdXNoKHRoaXMubW9udGhzU2hvcnQobW9tLCAnJykpOwogICAgfQogICAgLy8gU29ydGluZyBtYWtlcyBzdXJlIGlmIG9uZSBtb250aCAob3IgYWJicikgaXMgYSBwcmVmaXggb2YgYW5vdGhlciBpdAogICAgLy8gd2lsbCBtYXRjaCB0aGUgbG9uZ2VyIHBpZWNlLgogICAgc2hvcnRQaWVjZXMuc29ydChjbXBMZW5SZXYpOwogICAgbG9uZ1BpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBtaXhlZFBpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBmb3IgKGkgPSAwOyBpIDwgMTI7IGkrKykgewogICAgICAgIHNob3J0UGllY2VzW2ldID0gcmVnZXhFc2NhcGUoc2hvcnRQaWVjZXNbaV0pOwogICAgICAgIGxvbmdQaWVjZXNbaV0gPSByZWdleEVzY2FwZShsb25nUGllY2VzW2ldKTsKICAgIH0KICAgIGZvciAoaSA9IDA7IGkgPCAyNDsgaSsrKSB7CiAgICAgICAgbWl4ZWRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShtaXhlZFBpZWNlc1tpXSk7CiAgICB9CgogICAgdGhpcy5fbW9udGhzUmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBtaXhlZFBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB0aGlzLl9tb250aHNTaG9ydFJlZ2V4ID0gdGhpcy5fbW9udGhzUmVnZXg7CiAgICB0aGlzLl9tb250aHNTdHJpY3RSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIGxvbmdQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgdGhpcy5fbW9udGhzU2hvcnRTdHJpY3RSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIHNob3J0UGllY2VzLmpvaW4oJ3wnKSArICcpJywgJ2knKTsKfQoKZnVuY3Rpb24gY3JlYXRlRGF0ZSAoeSwgbSwgZCwgaCwgTSwgcywgbXMpIHsKICAgIC8vIGNhbid0IGp1c3QgYXBwbHkoKSB0byBjcmVhdGUgYSBkYXRlOgogICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xLzE4MTM0OAogICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSh5LCBtLCBkLCBoLCBNLCBzLCBtcyk7CgogICAgLy8gdGhlIGRhdGUgY29uc3RydWN0b3IgcmVtYXBzIHllYXJzIDAtOTkgdG8gMTkwMC0xOTk5CiAgICBpZiAoeSA8IDEwMCAmJiB5ID49IDAgJiYgaXNGaW5pdGUoZGF0ZS5nZXRGdWxsWWVhcigpKSkgewogICAgICAgIGRhdGUuc2V0RnVsbFllYXIoeSk7CiAgICB9CiAgICByZXR1cm4gZGF0ZTsKfQoKZnVuY3Rpb24gY3JlYXRlVVRDRGF0ZSAoeSkgewogICAgdmFyIGRhdGUgPSBuZXcgRGF0ZShEYXRlLlVUQy5hcHBseShudWxsLCBhcmd1bWVudHMpKTsKCiAgICAvLyB0aGUgRGF0ZS5VVEMgZnVuY3Rpb24gcmVtYXBzIHllYXJzIDAtOTkgdG8gMTkwMC0xOTk5CiAgICBpZiAoeSA8IDEwMCAmJiB5ID49IDAgJiYgaXNGaW5pdGUoZGF0ZS5nZXRVVENGdWxsWWVhcigpKSkgewogICAgICAgIGRhdGUuc2V0VVRDRnVsbFllYXIoeSk7CiAgICB9CiAgICByZXR1cm4gZGF0ZTsKfQoKLy8gc3RhcnQtb2YtZmlyc3Qtd2VlayAtIHN0YXJ0LW9mLXllYXIKZnVuY3Rpb24gZmlyc3RXZWVrT2Zmc2V0KHllYXIsIGRvdywgZG95KSB7CiAgICB2YXIgLy8gZmlyc3Qtd2VlayBkYXkgLS0gd2hpY2ggamFudWFyeSBpcyBhbHdheXMgaW4gdGhlIGZpcnN0IHdlZWsgKDQgZm9yIGlzbywgMSBmb3Igb3RoZXIpCiAgICAgICAgZndkID0gNyArIGRvdyAtIGRveSwKICAgICAgICAvLyBmaXJzdC13ZWVrIGRheSBsb2NhbCB3ZWVrZGF5IC0tIHdoaWNoIGxvY2FsIHdlZWtkYXkgaXMgZndkCiAgICAgICAgZndkbHcgPSAoNyArIGNyZWF0ZVVUQ0RhdGUoeWVhciwgMCwgZndkKS5nZXRVVENEYXkoKSAtIGRvdykgJSA3OwoKICAgIHJldHVybiAtZndkbHcgKyBmd2QgLSAxOwp9CgovLyBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9JU09fd2Vla19kYXRlI0NhbGN1bGF0aW5nX2FfZGF0ZV9naXZlbl90aGVfeWVhci4yQ193ZWVrX251bWJlcl9hbmRfd2Vla2RheQpmdW5jdGlvbiBkYXlPZlllYXJGcm9tV2Vla3MoeWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3kpIHsKICAgIHZhciBsb2NhbFdlZWtkYXkgPSAoNyArIHdlZWtkYXkgLSBkb3cpICUgNywKICAgICAgICB3ZWVrT2Zmc2V0ID0gZmlyc3RXZWVrT2Zmc2V0KHllYXIsIGRvdywgZG95KSwKICAgICAgICBkYXlPZlllYXIgPSAxICsgNyAqICh3ZWVrIC0gMSkgKyBsb2NhbFdlZWtkYXkgKyB3ZWVrT2Zmc2V0LAogICAgICAgIHJlc1llYXIsIHJlc0RheU9mWWVhcjsKCiAgICBpZiAoZGF5T2ZZZWFyIDw9IDApIHsKICAgICAgICByZXNZZWFyID0geWVhciAtIDE7CiAgICAgICAgcmVzRGF5T2ZZZWFyID0gZGF5c0luWWVhcihyZXNZZWFyKSArIGRheU9mWWVhcjsKICAgIH0gZWxzZSBpZiAoZGF5T2ZZZWFyID4gZGF5c0luWWVhcih5ZWFyKSkgewogICAgICAgIHJlc1llYXIgPSB5ZWFyICsgMTsKICAgICAgICByZXNEYXlPZlllYXIgPSBkYXlPZlllYXIgLSBkYXlzSW5ZZWFyKHllYXIpOwogICAgfSBlbHNlIHsKICAgICAgICByZXNZZWFyID0geWVhcjsKICAgICAgICByZXNEYXlPZlllYXIgPSBkYXlPZlllYXI7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgICB5ZWFyOiByZXNZZWFyLAogICAgICAgIGRheU9mWWVhcjogcmVzRGF5T2ZZZWFyCiAgICB9Owp9CgpmdW5jdGlvbiB3ZWVrT2ZZZWFyKG1vbSwgZG93LCBkb3kpIHsKICAgIHZhciB3ZWVrT2Zmc2V0ID0gZmlyc3RXZWVrT2Zmc2V0KG1vbS55ZWFyKCksIGRvdywgZG95KSwKICAgICAgICB3ZWVrID0gTWF0aC5mbG9vcigobW9tLmRheU9mWWVhcigpIC0gd2Vla09mZnNldCAtIDEpIC8gNykgKyAxLAogICAgICAgIHJlc1dlZWssIHJlc1llYXI7CgogICAgaWYgKHdlZWsgPCAxKSB7CiAgICAgICAgcmVzWWVhciA9IG1vbS55ZWFyKCkgLSAxOwogICAgICAgIHJlc1dlZWsgPSB3ZWVrICsgd2Vla3NJblllYXIocmVzWWVhciwgZG93LCBkb3kpOwogICAgfSBlbHNlIGlmICh3ZWVrID4gd2Vla3NJblllYXIobW9tLnllYXIoKSwgZG93LCBkb3kpKSB7CiAgICAgICAgcmVzV2VlayA9IHdlZWsgLSB3ZWVrc0luWWVhcihtb20ueWVhcigpLCBkb3csIGRveSk7CiAgICAgICAgcmVzWWVhciA9IG1vbS55ZWFyKCkgKyAxOwogICAgfSBlbHNlIHsKICAgICAgICByZXNZZWFyID0gbW9tLnllYXIoKTsKICAgICAgICByZXNXZWVrID0gd2VlazsKICAgIH0KCiAgICByZXR1cm4gewogICAgICAgIHdlZWs6IHJlc1dlZWssCiAgICAgICAgeWVhcjogcmVzWWVhcgogICAgfTsKfQoKZnVuY3Rpb24gd2Vla3NJblllYXIoeWVhciwgZG93LCBkb3kpIHsKICAgIHZhciB3ZWVrT2Zmc2V0ID0gZmlyc3RXZWVrT2Zmc2V0KHllYXIsIGRvdywgZG95KSwKICAgICAgICB3ZWVrT2Zmc2V0TmV4dCA9IGZpcnN0V2Vla09mZnNldCh5ZWFyICsgMSwgZG93LCBkb3kpOwogICAgcmV0dXJuIChkYXlzSW5ZZWFyKHllYXIpIC0gd2Vla09mZnNldCArIHdlZWtPZmZzZXROZXh0KSAvIDc7Cn0KCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKCd3JywgWyd3dycsIDJdLCAnd28nLCAnd2VlaycpOwphZGRGb3JtYXRUb2tlbignVycsIFsnV1cnLCAyXSwgJ1dvJywgJ2lzb1dlZWsnKTsKCi8vIEFMSUFTRVMKCmFkZFVuaXRBbGlhcygnd2VlaycsICd3Jyk7CmFkZFVuaXRBbGlhcygnaXNvV2VlaycsICdXJyk7CgovLyBQUklPUklUSUVTCgphZGRVbml0UHJpb3JpdHkoJ3dlZWsnLCA1KTsKYWRkVW5pdFByaW9yaXR5KCdpc29XZWVrJywgNSk7CgovLyBQQVJTSU5HCgphZGRSZWdleFRva2VuKCd3JywgIG1hdGNoMXRvMik7CmFkZFJlZ2V4VG9rZW4oJ3d3JywgbWF0Y2gxdG8yLCBtYXRjaDIpOwphZGRSZWdleFRva2VuKCdXJywgIG1hdGNoMXRvMik7CmFkZFJlZ2V4VG9rZW4oJ1dXJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwoKYWRkV2Vla1BhcnNlVG9rZW4oWyd3JywgJ3d3JywgJ1cnLCAnV1cnXSwgZnVuY3Rpb24gKGlucHV0LCB3ZWVrLCBjb25maWcsIHRva2VuKSB7CiAgICB3ZWVrW3Rva2VuLnN1YnN0cigwLCAxKV0gPSB0b0ludChpbnB1dCk7Cn0pOwoKLy8gSEVMUEVSUwoKLy8gTE9DQUxFUwoKZnVuY3Rpb24gbG9jYWxlV2VlayAobW9tKSB7CiAgICByZXR1cm4gd2Vla09mWWVhcihtb20sIHRoaXMuX3dlZWsuZG93LCB0aGlzLl93ZWVrLmRveSkud2VlazsKfQoKdmFyIGRlZmF1bHRMb2NhbGVXZWVrID0gewogICAgZG93IDogMCwgLy8gU3VuZGF5IGlzIHRoZSBmaXJzdCBkYXkgb2YgdGhlIHdlZWsuCiAgICBkb3kgOiA2ICAvLyBUaGUgd2VlayB0aGF0IGNvbnRhaW5zIEphbiAxc3QgaXMgdGhlIGZpcnN0IHdlZWsgb2YgdGhlIHllYXIuCn07CgpmdW5jdGlvbiBsb2NhbGVGaXJzdERheU9mV2VlayAoKSB7CiAgICByZXR1cm4gdGhpcy5fd2Vlay5kb3c7Cn0KCmZ1bmN0aW9uIGxvY2FsZUZpcnN0RGF5T2ZZZWFyICgpIHsKICAgIHJldHVybiB0aGlzLl93ZWVrLmRveTsKfQoKLy8gTU9NRU5UUwoKZnVuY3Rpb24gZ2V0U2V0V2VlayAoaW5wdXQpIHsKICAgIHZhciB3ZWVrID0gdGhpcy5sb2NhbGVEYXRhKCkud2Vlayh0aGlzKTsKICAgIHJldHVybiBpbnB1dCA9PSBudWxsID8gd2VlayA6IHRoaXMuYWRkKChpbnB1dCAtIHdlZWspICogNywgJ2QnKTsKfQoKZnVuY3Rpb24gZ2V0U2V0SVNPV2VlayAoaW5wdXQpIHsKICAgIHZhciB3ZWVrID0gd2Vla09mWWVhcih0aGlzLCAxLCA0KS53ZWVrOwogICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrIDogdGhpcy5hZGQoKGlucHV0IC0gd2VlaykgKiA3LCAnZCcpOwp9CgovLyBGT1JNQVRUSU5HCgphZGRGb3JtYXRUb2tlbignZCcsIDAsICdkbycsICdkYXknKTsKCmFkZEZvcm1hdFRva2VuKCdkZCcsIDAsIDAsIGZ1bmN0aW9uIChmb3JtYXQpIHsKICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS53ZWVrZGF5c01pbih0aGlzLCBmb3JtYXQpOwp9KTsKCmFkZEZvcm1hdFRva2VuKCdkZGQnLCAwLCAwLCBmdW5jdGlvbiAoZm9ybWF0KSB7CiAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkud2Vla2RheXNTaG9ydCh0aGlzLCBmb3JtYXQpOwp9KTsKCmFkZEZvcm1hdFRva2VuKCdkZGRkJywgMCwgMCwgZnVuY3Rpb24gKGZvcm1hdCkgewogICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLndlZWtkYXlzKHRoaXMsIGZvcm1hdCk7Cn0pOwoKYWRkRm9ybWF0VG9rZW4oJ2UnLCAwLCAwLCAnd2Vla2RheScpOwphZGRGb3JtYXRUb2tlbignRScsIDAsIDAsICdpc29XZWVrZGF5Jyk7CgovLyBBTElBU0VTCgphZGRVbml0QWxpYXMoJ2RheScsICdkJyk7CmFkZFVuaXRBbGlhcygnd2Vla2RheScsICdlJyk7CmFkZFVuaXRBbGlhcygnaXNvV2Vla2RheScsICdFJyk7CgovLyBQUklPUklUWQphZGRVbml0UHJpb3JpdHkoJ2RheScsIDExKTsKYWRkVW5pdFByaW9yaXR5KCd3ZWVrZGF5JywgMTEpOwphZGRVbml0UHJpb3JpdHkoJ2lzb1dlZWtkYXknLCAxMSk7CgovLyBQQVJTSU5HCgphZGRSZWdleFRva2VuKCdkJywgICAgbWF0Y2gxdG8yKTsKYWRkUmVnZXhUb2tlbignZScsICAgIG1hdGNoMXRvMik7CmFkZFJlZ2V4VG9rZW4oJ0UnLCAgICBtYXRjaDF0bzIpOwphZGRSZWdleFRva2VuKCdkZCcsICAgZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgIHJldHVybiBsb2NhbGUud2Vla2RheXNNaW5SZWdleChpc1N0cmljdCk7Cn0pOwphZGRSZWdleFRva2VuKCdkZGQnLCAgIGZ1bmN0aW9uIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLndlZWtkYXlzU2hvcnRSZWdleChpc1N0cmljdCk7Cn0pOwphZGRSZWdleFRva2VuKCdkZGRkJywgICBmdW5jdGlvbiAoaXNTdHJpY3QsIGxvY2FsZSkgewogICAgcmV0dXJuIGxvY2FsZS53ZWVrZGF5c1JlZ2V4KGlzU3RyaWN0KTsKfSk7CgphZGRXZWVrUGFyc2VUb2tlbihbJ2RkJywgJ2RkZCcsICdkZGRkJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgdmFyIHdlZWtkYXkgPSBjb25maWcuX2xvY2FsZS53ZWVrZGF5c1BhcnNlKGlucHV0LCB0b2tlbiwgY29uZmlnLl9zdHJpY3QpOwogICAgLy8gaWYgd2UgZGlkbid0IGdldCBhIHdlZWtkYXkgbmFtZSwgbWFyayB0aGUgZGF0ZSBhcyBpbnZhbGlkCiAgICBpZiAod2Vla2RheSAhPSBudWxsKSB7CiAgICAgICAgd2Vlay5kID0gd2Vla2RheTsKICAgIH0gZWxzZSB7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaW52YWxpZFdlZWtkYXkgPSBpbnB1dDsKICAgIH0KfSk7CgphZGRXZWVrUGFyc2VUb2tlbihbJ2QnLCAnZScsICdFJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgd2Vla1t0b2tlbl0gPSB0b0ludChpbnB1dCk7Cn0pOwoKLy8gSEVMUEVSUwoKZnVuY3Rpb24gcGFyc2VXZWVrZGF5KGlucHV0LCBsb2NhbGUpIHsKICAgIGlmICh0eXBlb2YgaW5wdXQgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGlucHV0OwogICAgfQoKICAgIGlmICghaXNOYU4oaW5wdXQpKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlSW50KGlucHV0LCAxMCk7CiAgICB9CgogICAgaW5wdXQgPSBsb2NhbGUud2Vla2RheXNQYXJzZShpbnB1dCk7CiAgICBpZiAodHlwZW9mIGlucHV0ID09PSAnbnVtYmVyJykgewogICAgICAgIHJldHVybiBpbnB1dDsKICAgIH0KCiAgICByZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gcGFyc2VJc29XZWVrZGF5KGlucHV0LCBsb2NhbGUpIHsKICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZS53ZWVrZGF5c1BhcnNlKGlucHV0KSAlIDcgfHwgNzsKICAgIH0KICAgIHJldHVybiBpc05hTihpbnB1dCkgPyBudWxsIDogaW5wdXQ7Cn0KCi8vIExPQ0FMRVMKCnZhciBkZWZhdWx0TG9jYWxlV2Vla2RheXMgPSAnU3VuZGF5X01vbmRheV9UdWVzZGF5X1dlZG5lc2RheV9UaHVyc2RheV9GcmlkYXlfU2F0dXJkYXknLnNwbGl0KCdfJyk7CmZ1bmN0aW9uIGxvY2FsZVdlZWtkYXlzIChtLCBmb3JtYXQpIHsKICAgIGlmICghbSkgewogICAgICAgIHJldHVybiBpc0FycmF5KHRoaXMuX3dlZWtkYXlzKSA/IHRoaXMuX3dlZWtkYXlzIDoKICAgICAgICAgICAgdGhpcy5fd2Vla2RheXNbJ3N0YW5kYWxvbmUnXTsKICAgIH0KICAgIHJldHVybiBpc0FycmF5KHRoaXMuX3dlZWtkYXlzKSA/IHRoaXMuX3dlZWtkYXlzW20uZGF5KCldIDoKICAgICAgICB0aGlzLl93ZWVrZGF5c1t0aGlzLl93ZWVrZGF5cy5pc0Zvcm1hdC50ZXN0KGZvcm1hdCkgPyAnZm9ybWF0JyA6ICdzdGFuZGFsb25lJ11bbS5kYXkoKV07Cn0KCnZhciBkZWZhdWx0TG9jYWxlV2Vla2RheXNTaG9ydCA9ICdTdW5fTW9uX1R1ZV9XZWRfVGh1X0ZyaV9TYXQnLnNwbGl0KCdfJyk7CmZ1bmN0aW9uIGxvY2FsZVdlZWtkYXlzU2hvcnQgKG0pIHsKICAgIHJldHVybiAobSkgPyB0aGlzLl93ZWVrZGF5c1Nob3J0W20uZGF5KCldIDogdGhpcy5fd2Vla2RheXNTaG9ydDsKfQoKdmFyIGRlZmF1bHRMb2NhbGVXZWVrZGF5c01pbiA9ICdTdV9Nb19UdV9XZV9UaF9Gcl9TYScuc3BsaXQoJ18nKTsKZnVuY3Rpb24gbG9jYWxlV2Vla2RheXNNaW4gKG0pIHsKICAgIHJldHVybiAobSkgPyB0aGlzLl93ZWVrZGF5c01pblttLmRheSgpXSA6IHRoaXMuX3dlZWtkYXlzTWluOwp9CgpmdW5jdGlvbiBoYW5kbGVTdHJpY3RQYXJzZSQxKHdlZWtkYXlOYW1lLCBmb3JtYXQsIHN0cmljdCkgewogICAgdmFyIGksIGlpLCBtb20sIGxsYyA9IHdlZWtkYXlOYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICBpZiAoIXRoaXMuX3dlZWtkYXlzUGFyc2UpIHsKICAgICAgICB0aGlzLl93ZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgdGhpcy5fbWluV2Vla2RheXNQYXJzZSA9IFtdOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgNzsgKytpKSB7CiAgICAgICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgMV0pLmRheShpKTsKICAgICAgICAgICAgdGhpcy5fbWluV2Vla2RheXNQYXJzZVtpXSA9IHRoaXMud2Vla2RheXNNaW4obW9tLCAnJykudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgICAgICAgICAgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlW2ldID0gdGhpcy53ZWVrZGF5c1Nob3J0KG1vbSwgJycpLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0gPSB0aGlzLndlZWtkYXlzKG1vbSwgJycpLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChzdHJpY3QpIHsKICAgICAgICBpZiAoZm9ybWF0ID09PSAnZGRkZCcpIHsKICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fd2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgcmV0dXJuIGlpICE9PSAtMSA/IGlpIDogbnVsbDsKICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdCA9PT0gJ2RkZCcpIHsKICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX21pbldlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAoZm9ybWF0ID09PSAnZGRkZCcpIHsKICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fd2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX21pbldlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgIHJldHVybiBpaSAhPT0gLTEgPyBpaSA6IG51bGw7CiAgICAgICAgfSBlbHNlIGlmIChmb3JtYXQgPT09ICdkZGQnKSB7CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZSwgbGxjKTsKICAgICAgICAgICAgaWYgKGlpICE9PSAtMSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX3dlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpaTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl9taW5XZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlpID0gaW5kZXhPZi5jYWxsKHRoaXMuX21pbldlZWtkYXlzUGFyc2UsIGxsYyk7CiAgICAgICAgICAgIGlmIChpaSAhPT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpaTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpaSA9IGluZGV4T2YuY2FsbCh0aGlzLl93ZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICBpZiAoaWkgIT09IC0xKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaWk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWkgPSBpbmRleE9mLmNhbGwodGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlLCBsbGMpOwogICAgICAgICAgICByZXR1cm4gaWkgIT09IC0xID8gaWkgOiBudWxsOwogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gbG9jYWxlV2Vla2RheXNQYXJzZSAod2Vla2RheU5hbWUsIGZvcm1hdCwgc3RyaWN0KSB7CiAgICB2YXIgaSwgbW9tLCByZWdleDsKCiAgICBpZiAodGhpcy5fd2Vla2RheXNQYXJzZUV4YWN0KSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZVN0cmljdFBhcnNlJDEuY2FsbCh0aGlzLCB3ZWVrZGF5TmFtZSwgZm9ybWF0LCBzdHJpY3QpOwogICAgfQoKICAgIGlmICghdGhpcy5fd2Vla2RheXNQYXJzZSkgewogICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2UgPSBbXTsKICAgICAgICB0aGlzLl9taW5XZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgdGhpcy5fc2hvcnRXZWVrZGF5c1BhcnNlID0gW107CiAgICAgICAgdGhpcy5fZnVsbFdlZWtkYXlzUGFyc2UgPSBbXTsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CiAgICAgICAgLy8gbWFrZSB0aGUgcmVnZXggaWYgd2UgZG9uJ3QgaGF2ZSBpdCBhbHJlYWR5CgogICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgMV0pLmRheShpKTsKICAgICAgICBpZiAoc3RyaWN0ICYmICF0aGlzLl9mdWxsV2Vla2RheXNQYXJzZVtpXSkgewogICAgICAgICAgICB0aGlzLl9mdWxsV2Vla2RheXNQYXJzZVtpXSA9IG5ldyBSZWdFeHAoJ14nICsgdGhpcy53ZWVrZGF5cyhtb20sICcnKS5yZXBsYWNlKCcuJywgJ1wuPycpICsgJyQnLCAnaScpOwogICAgICAgICAgICB0aGlzLl9zaG9ydFdlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKCdeJyArIHRoaXMud2Vla2RheXNTaG9ydChtb20sICcnKS5yZXBsYWNlKCcuJywgJ1wuPycpICsgJyQnLCAnaScpOwogICAgICAgICAgICB0aGlzLl9taW5XZWVrZGF5c1BhcnNlW2ldID0gbmV3IFJlZ0V4cCgnXicgKyB0aGlzLndlZWtkYXlzTWluKG1vbSwgJycpLnJlcGxhY2UoJy4nLCAnXC4/JykgKyAnJCcsICdpJyk7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5fd2Vla2RheXNQYXJzZVtpXSkgewogICAgICAgICAgICByZWdleCA9ICdeJyArIHRoaXMud2Vla2RheXMobW9tLCAnJykgKyAnfF4nICsgdGhpcy53ZWVrZGF5c1Nob3J0KG1vbSwgJycpICsgJ3xeJyArIHRoaXMud2Vla2RheXNNaW4obW9tLCAnJyk7CiAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUGFyc2VbaV0gPSBuZXcgUmVnRXhwKHJlZ2V4LnJlcGxhY2UoJy4nLCAnJyksICdpJyk7CiAgICAgICAgfQogICAgICAgIC8vIHRlc3QgdGhlIHJlZ2V4CiAgICAgICAgaWYgKHN0cmljdCAmJiBmb3JtYXQgPT09ICdkZGRkJyAmJiB0aGlzLl9mdWxsV2Vla2RheXNQYXJzZVtpXS50ZXN0KHdlZWtkYXlOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9IGVsc2UgaWYgKHN0cmljdCAmJiBmb3JtYXQgPT09ICdkZGQnICYmIHRoaXMuX3Nob3J0V2Vla2RheXNQYXJzZVtpXS50ZXN0KHdlZWtkYXlOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9IGVsc2UgaWYgKHN0cmljdCAmJiBmb3JtYXQgPT09ICdkZCcgJiYgdGhpcy5fbWluV2Vla2RheXNQYXJzZVtpXS50ZXN0KHdlZWtkYXlOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9IGVsc2UgaWYgKCFzdHJpY3QgJiYgdGhpcy5fd2Vla2RheXNQYXJzZVtpXS50ZXN0KHdlZWtkYXlOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICB9CiAgICB9Cn0KCi8vIE1PTUVOVFMKCmZ1bmN0aW9uIGdldFNldERheU9mV2VlayAoaW5wdXQpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICB9CiAgICB2YXIgZGF5ID0gdGhpcy5faXNVVEMgPyB0aGlzLl9kLmdldFVUQ0RheSgpIDogdGhpcy5fZC5nZXREYXkoKTsKICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgaW5wdXQgPSBwYXJzZVdlZWtkYXkoaW5wdXQsIHRoaXMubG9jYWxlRGF0YSgpKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGQoaW5wdXQgLSBkYXksICdkJyk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkYXk7CiAgICB9Cn0KCmZ1bmN0aW9uIGdldFNldExvY2FsZURheU9mV2VlayAoaW5wdXQpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICByZXR1cm4gaW5wdXQgIT0gbnVsbCA/IHRoaXMgOiBOYU47CiAgICB9CiAgICB2YXIgd2Vla2RheSA9ICh0aGlzLmRheSgpICsgNyAtIHRoaXMubG9jYWxlRGF0YSgpLl93ZWVrLmRvdykgJSA3OwogICAgcmV0dXJuIGlucHV0ID09IG51bGwgPyB3ZWVrZGF5IDogdGhpcy5hZGQoaW5wdXQgLSB3ZWVrZGF5LCAnZCcpOwp9CgpmdW5jdGlvbiBnZXRTZXRJU09EYXlPZldlZWsgKGlucHV0KSB7CiAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgcmV0dXJuIGlucHV0ICE9IG51bGwgPyB0aGlzIDogTmFOOwogICAgfQoKICAgIC8vIGJlaGF2ZXMgdGhlIHNhbWUgYXMgbW9tZW50I2RheSBleGNlcHQKICAgIC8vIGFzIGEgZ2V0dGVyLCByZXR1cm5zIDcgaW5zdGVhZCBvZiAwICgxLTcgcmFuZ2UgaW5zdGVhZCBvZiAwLTYpCiAgICAvLyBhcyBhIHNldHRlciwgc3VuZGF5IHNob3VsZCBiZWxvbmcgdG8gdGhlIHByZXZpb3VzIHdlZWsuCgogICAgaWYgKGlucHV0ICE9IG51bGwpIHsKICAgICAgICB2YXIgd2Vla2RheSA9IHBhcnNlSXNvV2Vla2RheShpbnB1dCwgdGhpcy5sb2NhbGVEYXRhKCkpOwogICAgICAgIHJldHVybiB0aGlzLmRheSh0aGlzLmRheSgpICUgNyA/IHdlZWtkYXkgOiB3ZWVrZGF5IC0gNyk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmRheSgpIHx8IDc7CiAgICB9Cn0KCnZhciBkZWZhdWx0V2Vla2RheXNSZWdleCA9IG1hdGNoV29yZDsKZnVuY3Rpb24gd2Vla2RheXNSZWdleCAoaXNTdHJpY3QpIHsKICAgIGlmICh0aGlzLl93ZWVrZGF5c1BhcnNlRXhhY3QpIHsKICAgICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ193ZWVrZGF5c1JlZ2V4JykpIHsKICAgICAgICAgICAgY29tcHV0ZVdlZWtkYXlzUGFyc2UuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1N0cmljdFJlZ2V4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1JlZ2V4OwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNSZWdleCcpKSB7CiAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzUmVnZXggPSBkZWZhdWx0V2Vla2RheXNSZWdleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPwogICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1N0cmljdFJlZ2V4IDogdGhpcy5fd2Vla2RheXNSZWdleDsKICAgIH0KfQoKdmFyIGRlZmF1bHRXZWVrZGF5c1Nob3J0UmVnZXggPSBtYXRjaFdvcmQ7CmZ1bmN0aW9uIHdlZWtkYXlzU2hvcnRSZWdleCAoaXNTdHJpY3QpIHsKICAgIGlmICh0aGlzLl93ZWVrZGF5c1BhcnNlRXhhY3QpIHsKICAgICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ193ZWVrZGF5c1JlZ2V4JykpIHsKICAgICAgICAgICAgY29tcHV0ZVdlZWtkYXlzUGFyc2UuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzU2hvcnRSZWdleDsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICghaGFzT3duUHJvcCh0aGlzLCAnX3dlZWtkYXlzU2hvcnRSZWdleCcpKSB7CiAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzU2hvcnRSZWdleCA9IGRlZmF1bHRXZWVrZGF5c1Nob3J0UmVnZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPwogICAgICAgICAgICB0aGlzLl93ZWVrZGF5c1Nob3J0U3RyaWN0UmVnZXggOiB0aGlzLl93ZWVrZGF5c1Nob3J0UmVnZXg7CiAgICB9Cn0KCnZhciBkZWZhdWx0V2Vla2RheXNNaW5SZWdleCA9IG1hdGNoV29yZDsKZnVuY3Rpb24gd2Vla2RheXNNaW5SZWdleCAoaXNTdHJpY3QpIHsKICAgIGlmICh0aGlzLl93ZWVrZGF5c1BhcnNlRXhhY3QpIHsKICAgICAgICBpZiAoIWhhc093blByb3AodGhpcywgJ193ZWVrZGF5c1JlZ2V4JykpIHsKICAgICAgICAgICAgY29tcHV0ZVdlZWtkYXlzUGFyc2UuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzU3RyaWN0KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c01pblN0cmljdFJlZ2V4OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl93ZWVrZGF5c01pblJlZ2V4OwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFoYXNPd25Qcm9wKHRoaXMsICdfd2Vla2RheXNNaW5SZWdleCcpKSB7CiAgICAgICAgICAgIHRoaXMuX3dlZWtkYXlzTWluUmVnZXggPSBkZWZhdWx0V2Vla2RheXNNaW5SZWdleDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3dlZWtkYXlzTWluU3RyaWN0UmVnZXggJiYgaXNTdHJpY3QgPwogICAgICAgICAgICB0aGlzLl93ZWVrZGF5c01pblN0cmljdFJlZ2V4IDogdGhpcy5fd2Vla2RheXNNaW5SZWdleDsKICAgIH0KfQoKCmZ1bmN0aW9uIGNvbXB1dGVXZWVrZGF5c1BhcnNlICgpIHsKICAgIGZ1bmN0aW9uIGNtcExlblJldihhLCBiKSB7CiAgICAgICAgcmV0dXJuIGIubGVuZ3RoIC0gYS5sZW5ndGg7CiAgICB9CgogICAgdmFyIG1pblBpZWNlcyA9IFtdLCBzaG9ydFBpZWNlcyA9IFtdLCBsb25nUGllY2VzID0gW10sIG1peGVkUGllY2VzID0gW10sCiAgICAgICAgaSwgbW9tLCBtaW5wLCBzaG9ydHAsIGxvbmdwOwogICAgZm9yIChpID0gMDsgaSA8IDc7IGkrKykgewogICAgICAgIC8vIG1ha2UgdGhlIHJlZ2V4IGlmIHdlIGRvbid0IGhhdmUgaXQgYWxyZWFkeQogICAgICAgIG1vbSA9IGNyZWF0ZVVUQyhbMjAwMCwgMV0pLmRheShpKTsKICAgICAgICBtaW5wID0gdGhpcy53ZWVrZGF5c01pbihtb20sICcnKTsKICAgICAgICBzaG9ydHAgPSB0aGlzLndlZWtkYXlzU2hvcnQobW9tLCAnJyk7CiAgICAgICAgbG9uZ3AgPSB0aGlzLndlZWtkYXlzKG1vbSwgJycpOwogICAgICAgIG1pblBpZWNlcy5wdXNoKG1pbnApOwogICAgICAgIHNob3J0UGllY2VzLnB1c2goc2hvcnRwKTsKICAgICAgICBsb25nUGllY2VzLnB1c2gobG9uZ3ApOwogICAgICAgIG1peGVkUGllY2VzLnB1c2gobWlucCk7CiAgICAgICAgbWl4ZWRQaWVjZXMucHVzaChzaG9ydHApOwogICAgICAgIG1peGVkUGllY2VzLnB1c2gobG9uZ3ApOwogICAgfQogICAgLy8gU29ydGluZyBtYWtlcyBzdXJlIGlmIG9uZSB3ZWVrZGF5IChvciBhYmJyKSBpcyBhIHByZWZpeCBvZiBhbm90aGVyIGl0CiAgICAvLyB3aWxsIG1hdGNoIHRoZSBsb25nZXIgcGllY2UuCiAgICBtaW5QaWVjZXMuc29ydChjbXBMZW5SZXYpOwogICAgc2hvcnRQaWVjZXMuc29ydChjbXBMZW5SZXYpOwogICAgbG9uZ1BpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBtaXhlZFBpZWNlcy5zb3J0KGNtcExlblJldik7CiAgICBmb3IgKGkgPSAwOyBpIDwgNzsgaSsrKSB7CiAgICAgICAgc2hvcnRQaWVjZXNbaV0gPSByZWdleEVzY2FwZShzaG9ydFBpZWNlc1tpXSk7CiAgICAgICAgbG9uZ1BpZWNlc1tpXSA9IHJlZ2V4RXNjYXBlKGxvbmdQaWVjZXNbaV0pOwogICAgICAgIG1peGVkUGllY2VzW2ldID0gcmVnZXhFc2NhcGUobWl4ZWRQaWVjZXNbaV0pOwogICAgfQoKICAgIHRoaXMuX3dlZWtkYXlzUmVnZXggPSBuZXcgUmVnRXhwKCdeKCcgKyBtaXhlZFBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7CiAgICB0aGlzLl93ZWVrZGF5c1Nob3J0UmVnZXggPSB0aGlzLl93ZWVrZGF5c1JlZ2V4OwogICAgdGhpcy5fd2Vla2RheXNNaW5SZWdleCA9IHRoaXMuX3dlZWtkYXlzUmVnZXg7CgogICAgdGhpcy5fd2Vla2RheXNTdHJpY3RSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIGxvbmdQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgdGhpcy5fd2Vla2RheXNTaG9ydFN0cmljdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgc2hvcnRQaWVjZXMuam9pbignfCcpICsgJyknLCAnaScpOwogICAgdGhpcy5fd2Vla2RheXNNaW5TdHJpY3RSZWdleCA9IG5ldyBSZWdFeHAoJ14oJyArIG1pblBpZWNlcy5qb2luKCd8JykgKyAnKScsICdpJyk7Cn0KCi8vIEZPUk1BVFRJTkcKCmZ1bmN0aW9uIGhGb3JtYXQoKSB7CiAgICByZXR1cm4gdGhpcy5ob3VycygpICUgMTIgfHwgMTI7Cn0KCmZ1bmN0aW9uIGtGb3JtYXQoKSB7CiAgICByZXR1cm4gdGhpcy5ob3VycygpIHx8IDI0Owp9CgphZGRGb3JtYXRUb2tlbignSCcsIFsnSEgnLCAyXSwgMCwgJ2hvdXInKTsKYWRkRm9ybWF0VG9rZW4oJ2gnLCBbJ2hoJywgMl0sIDAsIGhGb3JtYXQpOwphZGRGb3JtYXRUb2tlbignaycsIFsna2snLCAyXSwgMCwga0Zvcm1hdCk7CgphZGRGb3JtYXRUb2tlbignaG1tJywgMCwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICcnICsgaEZvcm1hdC5hcHBseSh0aGlzKSArIHplcm9GaWxsKHRoaXMubWludXRlcygpLCAyKTsKfSk7CgphZGRGb3JtYXRUb2tlbignaG1tc3MnLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gJycgKyBoRm9ybWF0LmFwcGx5KHRoaXMpICsgemVyb0ZpbGwodGhpcy5taW51dGVzKCksIDIpICsKICAgICAgICB6ZXJvRmlsbCh0aGlzLnNlY29uZHMoKSwgMik7Cn0pOwoKYWRkRm9ybWF0VG9rZW4oJ0htbScsIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAnJyArIHRoaXMuaG91cnMoKSArIHplcm9GaWxsKHRoaXMubWludXRlcygpLCAyKTsKfSk7CgphZGRGb3JtYXRUb2tlbignSG1tc3MnLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gJycgKyB0aGlzLmhvdXJzKCkgKyB6ZXJvRmlsbCh0aGlzLm1pbnV0ZXMoKSwgMikgKwogICAgICAgIHplcm9GaWxsKHRoaXMuc2Vjb25kcygpLCAyKTsKfSk7CgpmdW5jdGlvbiBtZXJpZGllbSAodG9rZW4sIGxvd2VyY2FzZSkgewogICAgYWRkRm9ybWF0VG9rZW4odG9rZW4sIDAsIDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkubWVyaWRpZW0odGhpcy5ob3VycygpLCB0aGlzLm1pbnV0ZXMoKSwgbG93ZXJjYXNlKTsKICAgIH0pOwp9CgptZXJpZGllbSgnYScsIHRydWUpOwptZXJpZGllbSgnQScsIGZhbHNlKTsKCi8vIEFMSUFTRVMKCmFkZFVuaXRBbGlhcygnaG91cicsICdoJyk7CgovLyBQUklPUklUWQphZGRVbml0UHJpb3JpdHkoJ2hvdXInLCAxMyk7CgovLyBQQVJTSU5HCgpmdW5jdGlvbiBtYXRjaE1lcmlkaWVtIChpc1N0cmljdCwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLl9tZXJpZGllbVBhcnNlOwp9CgphZGRSZWdleFRva2VuKCdhJywgIG1hdGNoTWVyaWRpZW0pOwphZGRSZWdleFRva2VuKCdBJywgIG1hdGNoTWVyaWRpZW0pOwphZGRSZWdleFRva2VuKCdIJywgIG1hdGNoMXRvMik7CmFkZFJlZ2V4VG9rZW4oJ2gnLCAgbWF0Y2gxdG8yKTsKYWRkUmVnZXhUb2tlbignaycsICBtYXRjaDF0bzIpOwphZGRSZWdleFRva2VuKCdISCcsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKYWRkUmVnZXhUb2tlbignaGgnLCBtYXRjaDF0bzIsIG1hdGNoMik7CmFkZFJlZ2V4VG9rZW4oJ2trJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwoKYWRkUmVnZXhUb2tlbignaG1tJywgbWF0Y2gzdG80KTsKYWRkUmVnZXhUb2tlbignaG1tc3MnLCBtYXRjaDV0bzYpOwphZGRSZWdleFRva2VuKCdIbW0nLCBtYXRjaDN0bzQpOwphZGRSZWdleFRva2VuKCdIbW1zcycsIG1hdGNoNXRvNik7CgphZGRQYXJzZVRva2VuKFsnSCcsICdISCddLCBIT1VSKTsKYWRkUGFyc2VUb2tlbihbJ2snLCAna2snXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICB2YXIga0lucHV0ID0gdG9JbnQoaW5wdXQpOwogICAgYXJyYXlbSE9VUl0gPSBrSW5wdXQgPT09IDI0ID8gMCA6IGtJbnB1dDsKfSk7CmFkZFBhcnNlVG9rZW4oWydhJywgJ0EnXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICBjb25maWcuX2lzUG0gPSBjb25maWcuX2xvY2FsZS5pc1BNKGlucHV0KTsKICAgIGNvbmZpZy5fbWVyaWRpZW0gPSBpbnB1dDsKfSk7CmFkZFBhcnNlVG9rZW4oWydoJywgJ2hoJ10sIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgYXJyYXlbSE9VUl0gPSB0b0ludChpbnB1dCk7CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5iaWdIb3VyID0gdHJ1ZTsKfSk7CmFkZFBhcnNlVG9rZW4oJ2htbScsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgdmFyIHBvcyA9IGlucHV0Lmxlbmd0aCAtIDI7CiAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0LnN1YnN0cigwLCBwb3MpKTsKICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zKSk7CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5iaWdIb3VyID0gdHJ1ZTsKfSk7CmFkZFBhcnNlVG9rZW4oJ2htbXNzJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICB2YXIgcG9zMSA9IGlucHV0Lmxlbmd0aCAtIDQ7CiAgICB2YXIgcG9zMiA9IGlucHV0Lmxlbmd0aCAtIDI7CiAgICBhcnJheVtIT1VSXSA9IHRvSW50KGlucHV0LnN1YnN0cigwLCBwb3MxKSk7CiAgICBhcnJheVtNSU5VVEVdID0gdG9JbnQoaW5wdXQuc3Vic3RyKHBvczEsIDIpKTsKICAgIGFycmF5W1NFQ09ORF0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zMikpOwogICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHRydWU7Cn0pOwphZGRQYXJzZVRva2VuKCdIbW0nLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgIHZhciBwb3MgPSBpbnB1dC5sZW5ndGggLSAyOwogICAgYXJyYXlbSE9VUl0gPSB0b0ludChpbnB1dC5zdWJzdHIoMCwgcG9zKSk7CiAgICBhcnJheVtNSU5VVEVdID0gdG9JbnQoaW5wdXQuc3Vic3RyKHBvcykpOwp9KTsKYWRkUGFyc2VUb2tlbignSG1tc3MnLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgIHZhciBwb3MxID0gaW5wdXQubGVuZ3RoIC0gNDsKICAgIHZhciBwb3MyID0gaW5wdXQubGVuZ3RoIC0gMjsKICAgIGFycmF5W0hPVVJdID0gdG9JbnQoaW5wdXQuc3Vic3RyKDAsIHBvczEpKTsKICAgIGFycmF5W01JTlVURV0gPSB0b0ludChpbnB1dC5zdWJzdHIocG9zMSwgMikpOwogICAgYXJyYXlbU0VDT05EXSA9IHRvSW50KGlucHV0LnN1YnN0cihwb3MyKSk7Cn0pOwoKLy8gTE9DQUxFUwoKZnVuY3Rpb24gbG9jYWxlSXNQTSAoaW5wdXQpIHsKICAgIC8vIElFOCBRdWlya3MgTW9kZSAmIElFNyBTdGFuZGFyZHMgTW9kZSBkbyBub3QgYWxsb3cgYWNjZXNzaW5nIHN0cmluZ3MgbGlrZSBhcnJheXMKICAgIC8vIFVzaW5nIGNoYXJBdCBzaG91bGQgYmUgbW9yZSBjb21wYXRpYmxlLgogICAgcmV0dXJuICgoaW5wdXQgKyAnJykudG9Mb3dlckNhc2UoKS5jaGFyQXQoMCkgPT09ICdwJyk7Cn0KCnZhciBkZWZhdWx0TG9jYWxlTWVyaWRpZW1QYXJzZSA9IC9bYXBdXC4/bT9cLj8vaTsKZnVuY3Rpb24gbG9jYWxlTWVyaWRpZW0gKGhvdXJzLCBtaW51dGVzLCBpc0xvd2VyKSB7CiAgICBpZiAoaG91cnMgPiAxMSkgewogICAgICAgIHJldHVybiBpc0xvd2VyID8gJ3BtJyA6ICdQTSc7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBpc0xvd2VyID8gJ2FtJyA6ICdBTSc7CiAgICB9Cn0KCgovLyBNT01FTlRTCgovLyBTZXR0aW5nIHRoZSBob3VyIHNob3VsZCBrZWVwIHRoZSB0aW1lLCBiZWNhdXNlIHRoZSB1c2VyIGV4cGxpY2l0bHkKLy8gc3BlY2lmaWVkIHdoaWNoIGhvdXIgaGUgd2FudHMuIFNvIHRyeWluZyB0byBtYWludGFpbiB0aGUgc2FtZSBob3VyIChpbgovLyBhIG5ldyB0aW1lem9uZSkgbWFrZXMgc2Vuc2UuIEFkZGluZy9zdWJ0cmFjdGluZyBob3VycyBkb2VzIG5vdCBmb2xsb3cKLy8gdGhpcyBydWxlLgp2YXIgZ2V0U2V0SG91ciA9IG1ha2VHZXRTZXQoJ0hvdXJzJywgdHJ1ZSk7CgovLyBtb250aHMKLy8gd2VlawovLyB3ZWVrZGF5cwovLyBtZXJpZGllbQp2YXIgYmFzZUNvbmZpZyA9IHsKICAgIGNhbGVuZGFyOiBkZWZhdWx0Q2FsZW5kYXIsCiAgICBsb25nRGF0ZUZvcm1hdDogZGVmYXVsdExvbmdEYXRlRm9ybWF0LAogICAgaW52YWxpZERhdGU6IGRlZmF1bHRJbnZhbGlkRGF0ZSwKICAgIG9yZGluYWw6IGRlZmF1bHRPcmRpbmFsLAogICAgZGF5T2ZNb250aE9yZGluYWxQYXJzZTogZGVmYXVsdERheU9mTW9udGhPcmRpbmFsUGFyc2UsCiAgICByZWxhdGl2ZVRpbWU6IGRlZmF1bHRSZWxhdGl2ZVRpbWUsCgogICAgbW9udGhzOiBkZWZhdWx0TG9jYWxlTW9udGhzLAogICAgbW9udGhzU2hvcnQ6IGRlZmF1bHRMb2NhbGVNb250aHNTaG9ydCwKCiAgICB3ZWVrOiBkZWZhdWx0TG9jYWxlV2VlaywKCiAgICB3ZWVrZGF5czogZGVmYXVsdExvY2FsZVdlZWtkYXlzLAogICAgd2Vla2RheXNNaW46IGRlZmF1bHRMb2NhbGVXZWVrZGF5c01pbiwKICAgIHdlZWtkYXlzU2hvcnQ6IGRlZmF1bHRMb2NhbGVXZWVrZGF5c1Nob3J0LAoKICAgIG1lcmlkaWVtUGFyc2U6IGRlZmF1bHRMb2NhbGVNZXJpZGllbVBhcnNlCn07CgovLyBpbnRlcm5hbCBzdG9yYWdlIGZvciBsb2NhbGUgY29uZmlnIGZpbGVzCnZhciBsb2NhbGVzID0ge307CnZhciBsb2NhbGVGYW1pbGllcyA9IHt9Owp2YXIgZ2xvYmFsTG9jYWxlOwoKZnVuY3Rpb24gbm9ybWFsaXplTG9jYWxlKGtleSkgewogICAgcmV0dXJuIGtleSA/IGtleS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ18nLCAnLScpIDoga2V5Owp9CgovLyBwaWNrIHRoZSBsb2NhbGUgZnJvbSB0aGUgYXJyYXkKLy8gdHJ5IFsnZW4tYXUnLCAnZW4tZ2InXSBhcyAnZW4tYXUnLCAnZW4tZ2InLCAnZW4nLCBhcyBpbiBtb3ZlIHRocm91Z2ggdGhlIGxpc3QgdHJ5aW5nIGVhY2gKLy8gc3Vic3RyaW5nIGZyb20gbW9zdCBzcGVjaWZpYyB0byBsZWFzdCwgYnV0IG1vdmUgdG8gdGhlIG5leHQgYXJyYXkgaXRlbSBpZiBpdCdzIGEgbW9yZSBzcGVjaWZpYyB2YXJpYW50IHRoYW4gdGhlIGN1cnJlbnQgcm9vdApmdW5jdGlvbiBjaG9vc2VMb2NhbGUobmFtZXMpIHsKICAgIHZhciBpID0gMCwgaiwgbmV4dCwgbG9jYWxlLCBzcGxpdDsKCiAgICB3aGlsZSAoaSA8IG5hbWVzLmxlbmd0aCkgewogICAgICAgIHNwbGl0ID0gbm9ybWFsaXplTG9jYWxlKG5hbWVzW2ldKS5zcGxpdCgnLScpOwogICAgICAgIGogPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgbmV4dCA9IG5vcm1hbGl6ZUxvY2FsZShuYW1lc1tpICsgMV0pOwogICAgICAgIG5leHQgPSBuZXh0ID8gbmV4dC5zcGxpdCgnLScpIDogbnVsbDsKICAgICAgICB3aGlsZSAoaiA+IDApIHsKICAgICAgICAgICAgbG9jYWxlID0gbG9hZExvY2FsZShzcGxpdC5zbGljZSgwLCBqKS5qb2luKCctJykpOwogICAgICAgICAgICBpZiAobG9jYWxlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXh0ICYmIG5leHQubGVuZ3RoID49IGogJiYgY29tcGFyZUFycmF5cyhzcGxpdCwgbmV4dCwgdHJ1ZSkgPj0gaiAtIDEpIHsKICAgICAgICAgICAgICAgIC8vdGhlIG5leHQgYXJyYXkgaXRlbSBpcyBiZXR0ZXIgdGhhbiBhIHNoYWxsb3dlciBzdWJzdHJpbmcgb2YgdGhpcyBvbmUKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGotLTsKICAgICAgICB9CiAgICAgICAgaSsrOwogICAgfQogICAgcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGxvYWRMb2NhbGUobmFtZSkgewogICAgdmFyIG9sZExvY2FsZSA9IG51bGw7CiAgICAvLyBUT0RPOiBGaW5kIGEgYmV0dGVyIHdheSB0byByZWdpc3RlciBhbmQgbG9hZCBhbGwgdGhlIGxvY2FsZXMgaW4gTm9kZQogICAgaWYgKCFsb2NhbGVzW25hbWVdICYmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJykgJiYKICAgICAgICAgICAgbW9kdWxlICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgb2xkTG9jYWxlID0gZ2xvYmFsTG9jYWxlLl9hYmJyOwogICAgICAgICAgICB2YXIgYWxpYXNlZFJlcXVpcmUgPSByZXF1aXJlOwogICAgICAgICAgICBhbGlhc2VkUmVxdWlyZSgnLi9sb2NhbGUvJyArIG5hbWUpOwogICAgICAgICAgICBnZXRTZXRHbG9iYWxMb2NhbGUob2xkTG9jYWxlKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgfQogICAgcmV0dXJuIGxvY2FsZXNbbmFtZV07Cn0KCi8vIFRoaXMgZnVuY3Rpb24gd2lsbCBsb2FkIGxvY2FsZSBhbmQgdGhlbiBzZXQgdGhlIGdsb2JhbCBsb2NhbGUuICBJZgovLyBubyBhcmd1bWVudHMgYXJlIHBhc3NlZCBpbiwgaXQgd2lsbCBzaW1wbHkgcmV0dXJuIHRoZSBjdXJyZW50IGdsb2JhbAovLyBsb2NhbGUga2V5LgpmdW5jdGlvbiBnZXRTZXRHbG9iYWxMb2NhbGUgKGtleSwgdmFsdWVzKSB7CiAgICB2YXIgZGF0YTsKICAgIGlmIChrZXkpIHsKICAgICAgICBpZiAoaXNVbmRlZmluZWQodmFsdWVzKSkgewogICAgICAgICAgICBkYXRhID0gZ2V0TG9jYWxlKGtleSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBkYXRhID0gZGVmaW5lTG9jYWxlKGtleSwgdmFsdWVzKTsKICAgICAgICB9CgogICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgIC8vIG1vbWVudC5kdXJhdGlvbi5fbG9jYWxlID0gbW9tZW50Ll9sb2NhbGUgPSBkYXRhOwogICAgICAgICAgICBnbG9iYWxMb2NhbGUgPSBkYXRhOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ2xvYmFsTG9jYWxlLl9hYmJyOwp9CgpmdW5jdGlvbiBkZWZpbmVMb2NhbGUgKG5hbWUsIGNvbmZpZykgewogICAgaWYgKGNvbmZpZyAhPT0gbnVsbCkgewogICAgICAgIHZhciBwYXJlbnRDb25maWcgPSBiYXNlQ29uZmlnOwogICAgICAgIGNvbmZpZy5hYmJyID0gbmFtZTsKICAgICAgICBpZiAobG9jYWxlc1tuYW1lXSAhPSBudWxsKSB7CiAgICAgICAgICAgIGRlcHJlY2F0ZVNpbXBsZSgnZGVmaW5lTG9jYWxlT3ZlcnJpZGUnLAogICAgICAgICAgICAgICAgICAgICd1c2UgbW9tZW50LnVwZGF0ZUxvY2FsZShsb2NhbGVOYW1lLCBjb25maWcpIHRvIGNoYW5nZSAnICsKICAgICAgICAgICAgICAgICAgICAnYW4gZXhpc3RpbmcgbG9jYWxlLiBtb21lbnQuZGVmaW5lTG9jYWxlKGxvY2FsZU5hbWUsICcgKwogICAgICAgICAgICAgICAgICAgICdjb25maWcpIHNob3VsZCBvbmx5IGJlIHVzZWQgZm9yIGNyZWF0aW5nIGEgbmV3IGxvY2FsZSAnICsKICAgICAgICAgICAgICAgICAgICAnU2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvZGVmaW5lLWxvY2FsZS8gZm9yIG1vcmUgaW5mby4nKTsKICAgICAgICAgICAgcGFyZW50Q29uZmlnID0gbG9jYWxlc1tuYW1lXS5fY29uZmlnOwogICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnBhcmVudExvY2FsZSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChsb2NhbGVzW2NvbmZpZy5wYXJlbnRMb2NhbGVdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHBhcmVudENvbmZpZyA9IGxvY2FsZXNbY29uZmlnLnBhcmVudExvY2FsZV0uX2NvbmZpZzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghbG9jYWxlRmFtaWxpZXNbY29uZmlnLnBhcmVudExvY2FsZV0pIHsKICAgICAgICAgICAgICAgICAgICBsb2NhbGVGYW1pbGllc1tjb25maWcucGFyZW50TG9jYWxlXSA9IFtdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbG9jYWxlRmFtaWxpZXNbY29uZmlnLnBhcmVudExvY2FsZV0ucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICBjb25maWc6IGNvbmZpZwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsb2NhbGVzW25hbWVdID0gbmV3IExvY2FsZShtZXJnZUNvbmZpZ3MocGFyZW50Q29uZmlnLCBjb25maWcpKTsKCiAgICAgICAgaWYgKGxvY2FsZUZhbWlsaWVzW25hbWVdKSB7CiAgICAgICAgICAgIGxvY2FsZUZhbWlsaWVzW25hbWVdLmZvckVhY2goZnVuY3Rpb24gKHgpIHsKICAgICAgICAgICAgICAgIGRlZmluZUxvY2FsZSh4Lm5hbWUsIHguY29uZmlnKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGF0IGZvciBub3c6IGFsc28gc2V0IHRoZSBsb2NhbGUKICAgICAgICAvLyBtYWtlIHN1cmUgd2Ugc2V0IHRoZSBsb2NhbGUgQUZURVIgYWxsIGNoaWxkIGxvY2FsZXMgaGF2ZSBiZWVuCiAgICAgICAgLy8gY3JlYXRlZCwgc28gd2Ugd29uJ3QgZW5kIHVwIHdpdGggdGhlIGNoaWxkIGxvY2FsZSBzZXQuCiAgICAgICAgZ2V0U2V0R2xvYmFsTG9jYWxlKG5hbWUpOwoKCiAgICAgICAgcmV0dXJuIGxvY2FsZXNbbmFtZV07CiAgICB9IGVsc2UgewogICAgICAgIC8vIHVzZWZ1bCBmb3IgdGVzdGluZwogICAgICAgIGRlbGV0ZSBsb2NhbGVzW25hbWVdOwogICAgICAgIHJldHVybiBudWxsOwogICAgfQp9CgpmdW5jdGlvbiB1cGRhdGVMb2NhbGUobmFtZSwgY29uZmlnKSB7CiAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICB2YXIgbG9jYWxlLCB0bXBMb2NhbGUsIHBhcmVudENvbmZpZyA9IGJhc2VDb25maWc7CiAgICAgICAgLy8gTUVSR0UKICAgICAgICB0bXBMb2NhbGUgPSBsb2FkTG9jYWxlKG5hbWUpOwogICAgICAgIGlmICh0bXBMb2NhbGUgIT0gbnVsbCkgewogICAgICAgICAgICBwYXJlbnRDb25maWcgPSB0bXBMb2NhbGUuX2NvbmZpZzsKICAgICAgICB9CiAgICAgICAgY29uZmlnID0gbWVyZ2VDb25maWdzKHBhcmVudENvbmZpZywgY29uZmlnKTsKICAgICAgICBsb2NhbGUgPSBuZXcgTG9jYWxlKGNvbmZpZyk7CiAgICAgICAgbG9jYWxlLnBhcmVudExvY2FsZSA9IGxvY2FsZXNbbmFtZV07CiAgICAgICAgbG9jYWxlc1tuYW1lXSA9IGxvY2FsZTsKCiAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdCBmb3Igbm93OiBhbHNvIHNldCB0aGUgbG9jYWxlCiAgICAgICAgZ2V0U2V0R2xvYmFsTG9jYWxlKG5hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBwYXNzIG51bGwgZm9yIGNvbmZpZyB0byB1bnVwZGF0ZSwgdXNlZnVsIGZvciB0ZXN0cwogICAgICAgIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGxvY2FsZXNbbmFtZV0ucGFyZW50TG9jYWxlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxvY2FsZXNbbmFtZV0gPSBsb2NhbGVzW25hbWVdLnBhcmVudExvY2FsZTsKICAgICAgICAgICAgfSBlbHNlIGlmIChsb2NhbGVzW25hbWVdICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBsb2NhbGVzW25hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGxvY2FsZXNbbmFtZV07Cn0KCi8vIHJldHVybnMgbG9jYWxlIGRhdGEKZnVuY3Rpb24gZ2V0TG9jYWxlIChrZXkpIHsKICAgIHZhciBsb2NhbGU7CgogICAgaWYgKGtleSAmJiBrZXkuX2xvY2FsZSAmJiBrZXkuX2xvY2FsZS5fYWJicikgewogICAgICAgIGtleSA9IGtleS5fbG9jYWxlLl9hYmJyOwogICAgfQoKICAgIGlmICgha2V5KSB7CiAgICAgICAgcmV0dXJuIGdsb2JhbExvY2FsZTsKICAgIH0KCiAgICBpZiAoIWlzQXJyYXkoa2V5KSkgewogICAgICAgIC8vc2hvcnQtY2lyY3VpdCBldmVyeXRoaW5nIGVsc2UKICAgICAgICBsb2NhbGUgPSBsb2FkTG9jYWxlKGtleSk7CiAgICAgICAgaWYgKGxvY2FsZSkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxlOwogICAgICAgIH0KICAgICAgICBrZXkgPSBba2V5XTsKICAgIH0KCiAgICByZXR1cm4gY2hvb3NlTG9jYWxlKGtleSk7Cn0KCmZ1bmN0aW9uIGxpc3RMb2NhbGVzKCkgewogICAgcmV0dXJuIGtleXMobG9jYWxlcyk7Cn0KCmZ1bmN0aW9uIGNoZWNrT3ZlcmZsb3cgKG0pIHsKICAgIHZhciBvdmVyZmxvdzsKICAgIHZhciBhID0gbS5fYTsKCiAgICBpZiAoYSAmJiBnZXRQYXJzaW5nRmxhZ3MobSkub3ZlcmZsb3cgPT09IC0yKSB7CiAgICAgICAgb3ZlcmZsb3cgPQogICAgICAgICAgICBhW01PTlRIXSAgICAgICA8IDAgfHwgYVtNT05USF0gICAgICAgPiAxMSAgPyBNT05USCA6CiAgICAgICAgICAgIGFbREFURV0gICAgICAgIDwgMSB8fCBhW0RBVEVdICAgICAgICA+IGRheXNJbk1vbnRoKGFbWUVBUl0sIGFbTU9OVEhdKSA/IERBVEUgOgogICAgICAgICAgICBhW0hPVVJdICAgICAgICA8IDAgfHwgYVtIT1VSXSAgICAgICAgPiAyNCB8fCAoYVtIT1VSXSA9PT0gMjQgJiYgKGFbTUlOVVRFXSAhPT0gMCB8fCBhW1NFQ09ORF0gIT09IDAgfHwgYVtNSUxMSVNFQ09ORF0gIT09IDApKSA/IEhPVVIgOgogICAgICAgICAgICBhW01JTlVURV0gICAgICA8IDAgfHwgYVtNSU5VVEVdICAgICAgPiA1OSAgPyBNSU5VVEUgOgogICAgICAgICAgICBhW1NFQ09ORF0gICAgICA8IDAgfHwgYVtTRUNPTkRdICAgICAgPiA1OSAgPyBTRUNPTkQgOgogICAgICAgICAgICBhW01JTExJU0VDT05EXSA8IDAgfHwgYVtNSUxMSVNFQ09ORF0gPiA5OTkgPyBNSUxMSVNFQ09ORCA6CiAgICAgICAgICAgIC0xOwoKICAgICAgICBpZiAoZ2V0UGFyc2luZ0ZsYWdzKG0pLl9vdmVyZmxvd0RheU9mWWVhciAmJiAob3ZlcmZsb3cgPCBZRUFSIHx8IG92ZXJmbG93ID4gREFURSkpIHsKICAgICAgICAgICAgb3ZlcmZsb3cgPSBEQVRFOwogICAgICAgIH0KICAgICAgICBpZiAoZ2V0UGFyc2luZ0ZsYWdzKG0pLl9vdmVyZmxvd1dlZWtzICYmIG92ZXJmbG93ID09PSAtMSkgewogICAgICAgICAgICBvdmVyZmxvdyA9IFdFRUs7CiAgICAgICAgfQogICAgICAgIGlmIChnZXRQYXJzaW5nRmxhZ3MobSkuX292ZXJmbG93V2Vla2RheSAmJiBvdmVyZmxvdyA9PT0gLTEpIHsKICAgICAgICAgICAgb3ZlcmZsb3cgPSBXRUVLREFZOwogICAgICAgIH0KCiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKG0pLm92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICB9CgogICAgcmV0dXJuIG07Cn0KCi8vIFBpY2sgdGhlIGZpcnN0IGRlZmluZWQgb2YgdHdvIG9yIHRocmVlIGFyZ3VtZW50cy4KZnVuY3Rpb24gZGVmYXVsdHMoYSwgYiwgYykgewogICAgaWYgKGEgIT0gbnVsbCkgewogICAgICAgIHJldHVybiBhOwogICAgfQogICAgaWYgKGIgIT0gbnVsbCkgewogICAgICAgIHJldHVybiBiOwogICAgfQogICAgcmV0dXJuIGM7Cn0KCmZ1bmN0aW9uIGN1cnJlbnREYXRlQXJyYXkoY29uZmlnKSB7CiAgICAvLyBob29rcyBpcyBhY3R1YWxseSB0aGUgZXhwb3J0ZWQgbW9tZW50IG9iamVjdAogICAgdmFyIG5vd1ZhbHVlID0gbmV3IERhdGUoaG9va3Mubm93KCkpOwogICAgaWYgKGNvbmZpZy5fdXNlVVRDKSB7CiAgICAgICAgcmV0dXJuIFtub3dWYWx1ZS5nZXRVVENGdWxsWWVhcigpLCBub3dWYWx1ZS5nZXRVVENNb250aCgpLCBub3dWYWx1ZS5nZXRVVENEYXRlKCldOwogICAgfQogICAgcmV0dXJuIFtub3dWYWx1ZS5nZXRGdWxsWWVhcigpLCBub3dWYWx1ZS5nZXRNb250aCgpLCBub3dWYWx1ZS5nZXREYXRlKCldOwp9CgovLyBjb252ZXJ0IGFuIGFycmF5IHRvIGEgZGF0ZS4KLy8gdGhlIGFycmF5IHNob3VsZCBtaXJyb3IgdGhlIHBhcmFtZXRlcnMgYmVsb3cKLy8gbm90ZTogYWxsIHZhbHVlcyBwYXN0IHRoZSB5ZWFyIGFyZSBvcHRpb25hbCBhbmQgd2lsbCBkZWZhdWx0IHRvIHRoZSBsb3dlc3QgcG9zc2libGUgdmFsdWUuCi8vIFt5ZWFyLCBtb250aCwgZGF5ICwgaG91ciwgbWludXRlLCBzZWNvbmQsIG1pbGxpc2Vjb25kXQpmdW5jdGlvbiBjb25maWdGcm9tQXJyYXkgKGNvbmZpZykgewogICAgdmFyIGksIGRhdGUsIGlucHV0ID0gW10sIGN1cnJlbnREYXRlLCBleHBlY3RlZFdlZWtkYXksIHllYXJUb1VzZTsKCiAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGN1cnJlbnREYXRlID0gY3VycmVudERhdGVBcnJheShjb25maWcpOwoKICAgIC8vY29tcHV0ZSBkYXkgb2YgdGhlIHllYXIgZnJvbSB3ZWVrcyBhbmQgd2Vla2RheXMKICAgIGlmIChjb25maWcuX3cgJiYgY29uZmlnLl9hW0RBVEVdID09IG51bGwgJiYgY29uZmlnLl9hW01PTlRIXSA9PSBudWxsKSB7CiAgICAgICAgZGF5T2ZZZWFyRnJvbVdlZWtJbmZvKGNvbmZpZyk7CiAgICB9CgogICAgLy9pZiB0aGUgZGF5IG9mIHRoZSB5ZWFyIGlzIHNldCwgZmlndXJlIG91dCB3aGF0IGl0IGlzCiAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIgIT0gbnVsbCkgewogICAgICAgIHllYXJUb1VzZSA9IGRlZmF1bHRzKGNvbmZpZy5fYVtZRUFSXSwgY3VycmVudERhdGVbWUVBUl0pOwoKICAgICAgICBpZiAoY29uZmlnLl9kYXlPZlllYXIgPiBkYXlzSW5ZZWFyKHllYXJUb1VzZSkgfHwgY29uZmlnLl9kYXlPZlllYXIgPT09IDApIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuX292ZXJmbG93RGF5T2ZZZWFyID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGRhdGUgPSBjcmVhdGVVVENEYXRlKHllYXJUb1VzZSwgMCwgY29uZmlnLl9kYXlPZlllYXIpOwogICAgICAgIGNvbmZpZy5fYVtNT05USF0gPSBkYXRlLmdldFVUQ01vbnRoKCk7CiAgICAgICAgY29uZmlnLl9hW0RBVEVdID0gZGF0ZS5nZXRVVENEYXRlKCk7CiAgICB9CgogICAgLy8gRGVmYXVsdCB0byBjdXJyZW50IGRhdGUuCiAgICAvLyAqIGlmIG5vIHllYXIsIG1vbnRoLCBkYXkgb2YgbW9udGggYXJlIGdpdmVuLCBkZWZhdWx0IHRvIHRvZGF5CiAgICAvLyAqIGlmIGRheSBvZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBtb250aCBhbmQgeWVhcgogICAgLy8gKiBpZiBtb250aCBpcyBnaXZlbiwgZGVmYXVsdCBvbmx5IHllYXIKICAgIC8vICogaWYgeWVhciBpcyBnaXZlbiwgZG9uJ3QgZGVmYXVsdCBhbnl0aGluZwogICAgZm9yIChpID0gMDsgaSA8IDMgJiYgY29uZmlnLl9hW2ldID09IG51bGw7ICsraSkgewogICAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gY3VycmVudERhdGVbaV07CiAgICB9CgogICAgLy8gWmVybyBvdXQgd2hhdGV2ZXIgd2FzIG5vdCBkZWZhdWx0ZWQsIGluY2x1ZGluZyB0aW1lCiAgICBmb3IgKDsgaSA8IDc7IGkrKykgewogICAgICAgIGNvbmZpZy5fYVtpXSA9IGlucHV0W2ldID0gKGNvbmZpZy5fYVtpXSA9PSBudWxsKSA/IChpID09PSAyID8gMSA6IDApIDogY29uZmlnLl9hW2ldOwogICAgfQoKICAgIC8vIENoZWNrIGZvciAyNDowMDowMC4wMDAKICAgIGlmIChjb25maWcuX2FbSE9VUl0gPT09IDI0ICYmCiAgICAgICAgICAgIGNvbmZpZy5fYVtNSU5VVEVdID09PSAwICYmCiAgICAgICAgICAgIGNvbmZpZy5fYVtTRUNPTkRdID09PSAwICYmCiAgICAgICAgICAgIGNvbmZpZy5fYVtNSUxMSVNFQ09ORF0gPT09IDApIHsKICAgICAgICBjb25maWcuX25leHREYXkgPSB0cnVlOwogICAgICAgIGNvbmZpZy5fYVtIT1VSXSA9IDA7CiAgICB9CgogICAgY29uZmlnLl9kID0gKGNvbmZpZy5fdXNlVVRDID8gY3JlYXRlVVRDRGF0ZSA6IGNyZWF0ZURhdGUpLmFwcGx5KG51bGwsIGlucHV0KTsKICAgIGV4cGVjdGVkV2Vla2RheSA9IGNvbmZpZy5fdXNlVVRDID8gY29uZmlnLl9kLmdldFVUQ0RheSgpIDogY29uZmlnLl9kLmdldERheSgpOwoKICAgIC8vIEFwcGx5IHRpbWV6b25lIG9mZnNldCBmcm9tIGlucHV0LiBUaGUgYWN0dWFsIHV0Y09mZnNldCBjYW4gYmUgY2hhbmdlZAogICAgLy8gd2l0aCBwYXJzZVpvbmUuCiAgICBpZiAoY29uZmlnLl90em0gIT0gbnVsbCkgewogICAgICAgIGNvbmZpZy5fZC5zZXRVVENNaW51dGVzKGNvbmZpZy5fZC5nZXRVVENNaW51dGVzKCkgLSBjb25maWcuX3R6bSk7CiAgICB9CgogICAgaWYgKGNvbmZpZy5fbmV4dERheSkgewogICAgICAgIGNvbmZpZy5fYVtIT1VSXSA9IDI0OwogICAgfQoKICAgIC8vIGNoZWNrIGZvciBtaXNtYXRjaGluZyBkYXkgb2Ygd2VlawogICAgaWYgKGNvbmZpZy5fdyAmJiB0eXBlb2YgY29uZmlnLl93LmQgIT09ICd1bmRlZmluZWQnICYmIGNvbmZpZy5fdy5kICE9PSBleHBlY3RlZFdlZWtkYXkpIHsKICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS53ZWVrZGF5TWlzbWF0Y2ggPSB0cnVlOwogICAgfQp9CgpmdW5jdGlvbiBkYXlPZlllYXJGcm9tV2Vla0luZm8oY29uZmlnKSB7CiAgICB2YXIgdywgd2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95LCB0ZW1wLCB3ZWVrZGF5T3ZlcmZsb3c7CgogICAgdyA9IGNvbmZpZy5fdzsKICAgIGlmICh3LkdHICE9IG51bGwgfHwgdy5XICE9IG51bGwgfHwgdy5FICE9IG51bGwpIHsKICAgICAgICBkb3cgPSAxOwogICAgICAgIGRveSA9IDQ7CgogICAgICAgIC8vIFRPRE86IFdlIG5lZWQgdG8gdGFrZSB0aGUgY3VycmVudCBpc29XZWVrWWVhciwgYnV0IHRoYXQgZGVwZW5kcyBvbgogICAgICAgIC8vIGhvdyB3ZSBpbnRlcnByZXQgbm93IChsb2NhbCwgdXRjLCBmaXhlZCBvZmZzZXQpLiBTbyBjcmVhdGUKICAgICAgICAvLyBhIG5vdyB2ZXJzaW9uIG9mIGN1cnJlbnQgY29uZmlnICh0YWtlIGxvY2FsL3V0Yy9vZmZzZXQgZmxhZ3MsIGFuZAogICAgICAgIC8vIGNyZWF0ZSBub3cpLgogICAgICAgIHdlZWtZZWFyID0gZGVmYXVsdHMody5HRywgY29uZmlnLl9hW1lFQVJdLCB3ZWVrT2ZZZWFyKGNyZWF0ZUxvY2FsKCksIDEsIDQpLnllYXIpOwogICAgICAgIHdlZWsgPSBkZWZhdWx0cyh3LlcsIDEpOwogICAgICAgIHdlZWtkYXkgPSBkZWZhdWx0cyh3LkUsIDEpOwogICAgICAgIGlmICh3ZWVrZGF5IDwgMSB8fCB3ZWVrZGF5ID4gNykgewogICAgICAgICAgICB3ZWVrZGF5T3ZlcmZsb3cgPSB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgZG93ID0gY29uZmlnLl9sb2NhbGUuX3dlZWsuZG93OwogICAgICAgIGRveSA9IGNvbmZpZy5fbG9jYWxlLl93ZWVrLmRveTsKCiAgICAgICAgdmFyIGN1cldlZWsgPSB3ZWVrT2ZZZWFyKGNyZWF0ZUxvY2FsKCksIGRvdywgZG95KTsKCiAgICAgICAgd2Vla1llYXIgPSBkZWZhdWx0cyh3LmdnLCBjb25maWcuX2FbWUVBUl0sIGN1cldlZWsueWVhcik7CgogICAgICAgIC8vIERlZmF1bHQgdG8gY3VycmVudCB3ZWVrLgogICAgICAgIHdlZWsgPSBkZWZhdWx0cyh3LncsIGN1cldlZWsud2Vlayk7CgogICAgICAgIGlmICh3LmQgIT0gbnVsbCkgewogICAgICAgICAgICAvLyB3ZWVrZGF5IC0tIGxvdyBkYXkgbnVtYmVycyBhcmUgY29uc2lkZXJlZCBuZXh0IHdlZWsKICAgICAgICAgICAgd2Vla2RheSA9IHcuZDsKICAgICAgICAgICAgaWYgKHdlZWtkYXkgPCAwIHx8IHdlZWtkYXkgPiA2KSB7CiAgICAgICAgICAgICAgICB3ZWVrZGF5T3ZlcmZsb3cgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh3LmUgIT0gbnVsbCkgewogICAgICAgICAgICAvLyBsb2NhbCB3ZWVrZGF5IC0tIGNvdW50aW5nIHN0YXJ0cyBmcm9tIGJlZ2luaW5nIG9mIHdlZWsKICAgICAgICAgICAgd2Vla2RheSA9IHcuZSArIGRvdzsKICAgICAgICAgICAgaWYgKHcuZSA8IDAgfHwgdy5lID4gNikgewogICAgICAgICAgICAgICAgd2Vla2RheU92ZXJmbG93ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGRlZmF1bHQgdG8gYmVnaW5pbmcgb2Ygd2VlawogICAgICAgICAgICB3ZWVrZGF5ID0gZG93OwogICAgICAgIH0KICAgIH0KICAgIGlmICh3ZWVrIDwgMSB8fCB3ZWVrID4gd2Vla3NJblllYXIod2Vla1llYXIsIGRvdywgZG95KSkgewogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLl9vdmVyZmxvd1dlZWtzID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAod2Vla2RheU92ZXJmbG93ICE9IG51bGwpIHsKICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5fb3ZlcmZsb3dXZWVrZGF5ID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGVtcCA9IGRheU9mWWVhckZyb21XZWVrcyh3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3kpOwogICAgICAgIGNvbmZpZy5fYVtZRUFSXSA9IHRlbXAueWVhcjsKICAgICAgICBjb25maWcuX2RheU9mWWVhciA9IHRlbXAuZGF5T2ZZZWFyOwogICAgfQp9CgovLyBpc28gODYwMSByZWdleAovLyAwMDAwLTAwLTAwIDAwMDAtVzAwIG9yIDAwMDAtVzAwLTAgKyBUICsgMDAgb3IgMDA6MDAgb3IgMDA6MDA6MDAgb3IgMDA6MDA6MDAuMDAwICsgKzAwOjAwIG9yICswMDAwIG9yICswMCkKdmFyIGV4dGVuZGVkSXNvUmVnZXggPSAvXlxzKigoPzpbKy1dXGR7Nn18XGR7NH0pLSg/OlxkXGQtXGRcZHxXXGRcZC1cZHxXXGRcZHxcZFxkXGR8XGRcZCkpKD86KFR8ICkoXGRcZCg/OjpcZFxkKD86OlxkXGQoPzpbLixdXGQrKT8pPyk/KShbXCtcLV1cZFxkKD86Oj9cZFxkKT98XHMqWik/KT8kLzsKdmFyIGJhc2ljSXNvUmVnZXggPSAvXlxzKigoPzpbKy1dXGR7Nn18XGR7NH0pKD86XGRcZFxkXGR8V1xkXGRcZHxXXGRcZHxcZFxkXGR8XGRcZCkpKD86KFR8ICkoXGRcZCg/OlxkXGQoPzpcZFxkKD86Wy4sXVxkKyk/KT8pPykoW1wrXC1dXGRcZCg/Ojo/XGRcZCk/fFxzKlopPyk/JC87Cgp2YXIgdHpSZWdleCA9IC9afFsrLV1cZFxkKD86Oj9cZFxkKT8vOwoKdmFyIGlzb0RhdGVzID0gWwogICAgWydZWVlZWVktTU0tREQnLCAvWystXVxkezZ9LVxkXGQtXGRcZC9dLAogICAgWydZWVlZLU1NLUREJywgL1xkezR9LVxkXGQtXGRcZC9dLAogICAgWydHR0dHLVtXXVdXLUUnLCAvXGR7NH0tV1xkXGQtXGQvXSwKICAgIFsnR0dHRy1bV11XVycsIC9cZHs0fS1XXGRcZC8sIGZhbHNlXSwKICAgIFsnWVlZWS1EREQnLCAvXGR7NH0tXGR7M30vXSwKICAgIFsnWVlZWS1NTScsIC9cZHs0fS1cZFxkLywgZmFsc2VdLAogICAgWydZWVlZWVlNTUREJywgL1srLV1cZHsxMH0vXSwKICAgIFsnWVlZWU1NREQnLCAvXGR7OH0vXSwKICAgIC8vIFlZWVlNTSBpcyBOT1QgYWxsb3dlZCBieSB0aGUgc3RhbmRhcmQKICAgIFsnR0dHR1tXXVdXRScsIC9cZHs0fVdcZHszfS9dLAogICAgWydHR0dHW1ddV1cnLCAvXGR7NH1XXGR7Mn0vLCBmYWxzZV0sCiAgICBbJ1lZWVlEREQnLCAvXGR7N30vXQpdOwoKLy8gaXNvIHRpbWUgZm9ybWF0cyBhbmQgcmVnZXhlcwp2YXIgaXNvVGltZXMgPSBbCiAgICBbJ0hIOm1tOnNzLlNTU1MnLCAvXGRcZDpcZFxkOlxkXGRcLlxkKy9dLAogICAgWydISDptbTpzcyxTU1NTJywgL1xkXGQ6XGRcZDpcZFxkLFxkKy9dLAogICAgWydISDptbTpzcycsIC9cZFxkOlxkXGQ6XGRcZC9dLAogICAgWydISDptbScsIC9cZFxkOlxkXGQvXSwKICAgIFsnSEhtbXNzLlNTU1MnLCAvXGRcZFxkXGRcZFxkXC5cZCsvXSwKICAgIFsnSEhtbXNzLFNTU1MnLCAvXGRcZFxkXGRcZFxkLFxkKy9dLAogICAgWydISG1tc3MnLCAvXGRcZFxkXGRcZFxkL10sCiAgICBbJ0hIbW0nLCAvXGRcZFxkXGQvXSwKICAgIFsnSEgnLCAvXGRcZC9dCl07Cgp2YXIgYXNwTmV0SnNvblJlZ2V4ID0gL15cLz9EYXRlXCgoXC0/XGQrKS9pOwoKLy8gZGF0ZSBmcm9tIGlzbyBmb3JtYXQKZnVuY3Rpb24gY29uZmlnRnJvbUlTTyhjb25maWcpIHsKICAgIHZhciBpLCBsLAogICAgICAgIHN0cmluZyA9IGNvbmZpZy5faSwKICAgICAgICBtYXRjaCA9IGV4dGVuZGVkSXNvUmVnZXguZXhlYyhzdHJpbmcpIHx8IGJhc2ljSXNvUmVnZXguZXhlYyhzdHJpbmcpLAogICAgICAgIGFsbG93VGltZSwgZGF0ZUZvcm1hdCwgdGltZUZvcm1hdCwgdHpGb3JtYXQ7CgogICAgaWYgKG1hdGNoKSB7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuaXNvID0gdHJ1ZTsKCiAgICAgICAgZm9yIChpID0gMCwgbCA9IGlzb0RhdGVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBpZiAoaXNvRGF0ZXNbaV1bMV0uZXhlYyhtYXRjaFsxXSkpIHsKICAgICAgICAgICAgICAgIGRhdGVGb3JtYXQgPSBpc29EYXRlc1tpXVswXTsKICAgICAgICAgICAgICAgIGFsbG93VGltZSA9IGlzb0RhdGVzW2ldWzJdICE9PSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChkYXRlRm9ybWF0ID09IG51bGwpIHsKICAgICAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBpc29UaW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChpc29UaW1lc1tpXVsxXS5leGVjKG1hdGNoWzNdKSkgewogICAgICAgICAgICAgICAgICAgIC8vIG1hdGNoWzJdIHNob3VsZCBiZSAnVCcgb3Igc3BhY2UKICAgICAgICAgICAgICAgICAgICB0aW1lRm9ybWF0ID0gKG1hdGNoWzJdIHx8ICcgJykgKyBpc29UaW1lc1tpXVswXTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGltZUZvcm1hdCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWFsbG93VGltZSAmJiB0aW1lRm9ybWF0ICE9IG51bGwpIHsKICAgICAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG1hdGNoWzRdKSB7CiAgICAgICAgICAgIGlmICh0elJlZ2V4LmV4ZWMobWF0Y2hbNF0pKSB7CiAgICAgICAgICAgICAgICB0ekZvcm1hdCA9ICdaJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbmZpZy5fZiA9IGRhdGVGb3JtYXQgKyAodGltZUZvcm1hdCB8fCAnJykgKyAodHpGb3JtYXQgfHwgJycpOwogICAgICAgIGNvbmZpZ0Zyb21TdHJpbmdBbmRGb3JtYXQoY29uZmlnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uZmlnLl9pc1ZhbGlkID0gZmFsc2U7CiAgICB9Cn0KCi8vIFJGQyAyODIyIHJlZ2V4OiBGb3IgZGV0YWlscyBzZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzI4MjIjc2VjdGlvbi0zLjMKdmFyIHJmYzI4MjIgPSAvXig/OihNb258VHVlfFdlZHxUaHV8RnJpfFNhdHxTdW4pLD9ccyk/KFxkezEsMn0pXHMoSmFufEZlYnxNYXJ8QXByfE1heXxKdW58SnVsfEF1Z3xTZXB8T2N0fE5vdnxEZWMpXHMoXGR7Miw0fSlccyhcZFxkKTooXGRcZCkoPzo6KFxkXGQpKT9ccyg/OihVVHxHTVR8W0VDTVBdW1NEXVQpfChbWnpdKXwoWystXVxkezR9KSkkLzsKCmZ1bmN0aW9uIGV4dHJhY3RGcm9tUkZDMjgyMlN0cmluZ3MoeWVhclN0ciwgbW9udGhTdHIsIGRheVN0ciwgaG91clN0ciwgbWludXRlU3RyLCBzZWNvbmRTdHIpIHsKICAgIHZhciByZXN1bHQgPSBbCiAgICAgICAgdW50cnVuY2F0ZVllYXIoeWVhclN0ciksCiAgICAgICAgZGVmYXVsdExvY2FsZU1vbnRoc1Nob3J0LmluZGV4T2YobW9udGhTdHIpLAogICAgICAgIHBhcnNlSW50KGRheVN0ciwgMTApLAogICAgICAgIHBhcnNlSW50KGhvdXJTdHIsIDEwKSwKICAgICAgICBwYXJzZUludChtaW51dGVTdHIsIDEwKQogICAgXTsKCiAgICBpZiAoc2Vjb25kU3RyKSB7CiAgICAgICAgcmVzdWx0LnB1c2gocGFyc2VJbnQoc2Vjb25kU3RyLCAxMCkpOwogICAgfQoKICAgIHJldHVybiByZXN1bHQ7Cn0KCmZ1bmN0aW9uIHVudHJ1bmNhdGVZZWFyKHllYXJTdHIpIHsKICAgIHZhciB5ZWFyID0gcGFyc2VJbnQoeWVhclN0ciwgMTApOwogICAgaWYgKHllYXIgPD0gNDkpIHsKICAgICAgICByZXR1cm4gMjAwMCArIHllYXI7CiAgICB9IGVsc2UgaWYgKHllYXIgPD0gOTk5KSB7CiAgICAgICAgcmV0dXJuIDE5MDAgKyB5ZWFyOwogICAgfQogICAgcmV0dXJuIHllYXI7Cn0KCmZ1bmN0aW9uIHByZXByb2Nlc3NSRkMyODIyKHMpIHsKICAgIC8vIFJlbW92ZSBjb21tZW50cyBhbmQgZm9sZGluZyB3aGl0ZXNwYWNlIGFuZCByZXBsYWNlIG11bHRpcGxlLXNwYWNlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCiAgICByZXR1cm4gcy5yZXBsYWNlKC9cKFteKV0qXCl8W1xuXHRdL2csICcgJykucmVwbGFjZSgvKFxzXHMrKS9nLCAnICcpLnRyaW0oKTsKfQoKZnVuY3Rpb24gY2hlY2tXZWVrZGF5KHdlZWtkYXlTdHIsIHBhcnNlZElucHV0LCBjb25maWcpIHsKICAgIGlmICh3ZWVrZGF5U3RyKSB7CiAgICAgICAgLy8gVE9ETzogUmVwbGFjZSB0aGUgdmFuaWxsYSBKUyBEYXRlIG9iamVjdCB3aXRoIGFuIGluZGVwZW50ZW50IGRheS1vZi13ZWVrIGNoZWNrLgogICAgICAgIHZhciB3ZWVrZGF5UHJvdmlkZWQgPSBkZWZhdWx0TG9jYWxlV2Vla2RheXNTaG9ydC5pbmRleE9mKHdlZWtkYXlTdHIpLAogICAgICAgICAgICB3ZWVrZGF5QWN0dWFsID0gbmV3IERhdGUocGFyc2VkSW5wdXRbMF0sIHBhcnNlZElucHV0WzFdLCBwYXJzZWRJbnB1dFsyXSkuZ2V0RGF5KCk7CiAgICAgICAgaWYgKHdlZWtkYXlQcm92aWRlZCAhPT0gd2Vla2RheUFjdHVhbCkgewogICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS53ZWVrZGF5TWlzbWF0Y2ggPSB0cnVlOwogICAgICAgICAgICBjb25maWcuX2lzVmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwp9Cgp2YXIgb2JzT2Zmc2V0cyA9IHsKICAgIFVUOiAwLAogICAgR01UOiAwLAogICAgRURUOiAtNCAqIDYwLAogICAgRVNUOiAtNSAqIDYwLAogICAgQ0RUOiAtNSAqIDYwLAogICAgQ1NUOiAtNiAqIDYwLAogICAgTURUOiAtNiAqIDYwLAogICAgTVNUOiAtNyAqIDYwLAogICAgUERUOiAtNyAqIDYwLAogICAgUFNUOiAtOCAqIDYwCn07CgpmdW5jdGlvbiBjYWxjdWxhdGVPZmZzZXQob2JzT2Zmc2V0LCBtaWxpdGFyeU9mZnNldCwgbnVtT2Zmc2V0KSB7CiAgICBpZiAob2JzT2Zmc2V0KSB7CiAgICAgICAgcmV0dXJuIG9ic09mZnNldHNbb2JzT2Zmc2V0XTsKICAgIH0gZWxzZSBpZiAobWlsaXRhcnlPZmZzZXQpIHsKICAgICAgICAvLyB0aGUgb25seSBhbGxvd2VkIG1pbGl0YXJ5IHR6IGlzIFoKICAgICAgICByZXR1cm4gMDsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGhtID0gcGFyc2VJbnQobnVtT2Zmc2V0LCAxMCk7CiAgICAgICAgdmFyIG0gPSBobSAlIDEwMCwgaCA9IChobSAtIG0pIC8gMTAwOwogICAgICAgIHJldHVybiBoICogNjAgKyBtOwogICAgfQp9CgovLyBkYXRlIGFuZCB0aW1lIGZyb20gcmVmIDI4MjIgZm9ybWF0CmZ1bmN0aW9uIGNvbmZpZ0Zyb21SRkMyODIyKGNvbmZpZykgewogICAgdmFyIG1hdGNoID0gcmZjMjgyMi5leGVjKHByZXByb2Nlc3NSRkMyODIyKGNvbmZpZy5faSkpOwogICAgaWYgKG1hdGNoKSB7CiAgICAgICAgdmFyIHBhcnNlZEFycmF5ID0gZXh0cmFjdEZyb21SRkMyODIyU3RyaW5ncyhtYXRjaFs0XSwgbWF0Y2hbM10sIG1hdGNoWzJdLCBtYXRjaFs1XSwgbWF0Y2hbNl0sIG1hdGNoWzddKTsKICAgICAgICBpZiAoIWNoZWNrV2Vla2RheShtYXRjaFsxXSwgcGFyc2VkQXJyYXksIGNvbmZpZykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnLl9hID0gcGFyc2VkQXJyYXk7CiAgICAgICAgY29uZmlnLl90em0gPSBjYWxjdWxhdGVPZmZzZXQobWF0Y2hbOF0sIG1hdGNoWzldLCBtYXRjaFsxMF0pOwoKICAgICAgICBjb25maWcuX2QgPSBjcmVhdGVVVENEYXRlLmFwcGx5KG51bGwsIGNvbmZpZy5fYSk7CiAgICAgICAgY29uZmlnLl9kLnNldFVUQ01pbnV0ZXMoY29uZmlnLl9kLmdldFVUQ01pbnV0ZXMoKSAtIGNvbmZpZy5fdHptKTsKCiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykucmZjMjgyMiA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICAgIGNvbmZpZy5faXNWYWxpZCA9IGZhbHNlOwogICAgfQp9CgovLyBkYXRlIGZyb20gaXNvIGZvcm1hdCBvciBmYWxsYmFjawpmdW5jdGlvbiBjb25maWdGcm9tU3RyaW5nKGNvbmZpZykgewogICAgdmFyIG1hdGNoZWQgPSBhc3BOZXRKc29uUmVnZXguZXhlYyhjb25maWcuX2kpOwoKICAgIGlmIChtYXRjaGVkICE9PSBudWxsKSB7CiAgICAgICAgY29uZmlnLl9kID0gbmV3IERhdGUoK21hdGNoZWRbMV0pOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25maWdGcm9tSVNPKGNvbmZpZyk7CiAgICBpZiAoY29uZmlnLl9pc1ZhbGlkID09PSBmYWxzZSkgewogICAgICAgIGRlbGV0ZSBjb25maWcuX2lzVmFsaWQ7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBjb25maWdGcm9tUkZDMjgyMihjb25maWcpOwogICAgaWYgKGNvbmZpZy5faXNWYWxpZCA9PT0gZmFsc2UpIHsKICAgICAgICBkZWxldGUgY29uZmlnLl9pc1ZhbGlkOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gRmluYWwgYXR0ZW1wdCwgdXNlIElucHV0IEZhbGxiYWNrCiAgICBob29rcy5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayhjb25maWcpOwp9Cgpob29rcy5jcmVhdGVGcm9tSW5wdXRGYWxsYmFjayA9IGRlcHJlY2F0ZSgKICAgICd2YWx1ZSBwcm92aWRlZCBpcyBub3QgaW4gYSByZWNvZ25pemVkIFJGQzI4MjIgb3IgSVNPIGZvcm1hdC4gbW9tZW50IGNvbnN0cnVjdGlvbiBmYWxscyBiYWNrIHRvIGpzIERhdGUoKSwgJyArCiAgICAnd2hpY2ggaXMgbm90IHJlbGlhYmxlIGFjcm9zcyBhbGwgYnJvd3NlcnMgYW5kIHZlcnNpb25zLiBOb24gUkZDMjgyMi9JU08gZGF0ZSBmb3JtYXRzIGFyZSAnICsKICAgICdkaXNjb3VyYWdlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGFuIHVwY29taW5nIG1ham9yIHJlbGVhc2UuIFBsZWFzZSByZWZlciB0byAnICsKICAgICdodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL2pzLWRhdGUvIGZvciBtb3JlIGluZm8uJywKICAgIGZ1bmN0aW9uIChjb25maWcpIHsKICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShjb25maWcuX2kgKyAoY29uZmlnLl91c2VVVEMgPyAnIFVUQycgOiAnJykpOwogICAgfQopOwoKLy8gY29uc3RhbnQgdGhhdCByZWZlcnMgdG8gdGhlIElTTyBzdGFuZGFyZApob29rcy5JU09fODYwMSA9IGZ1bmN0aW9uICgpIHt9OwoKLy8gY29uc3RhbnQgdGhhdCByZWZlcnMgdG8gdGhlIFJGQyAyODIyIGZvcm0KaG9va3MuUkZDXzI4MjIgPSBmdW5jdGlvbiAoKSB7fTsKCi8vIGRhdGUgZnJvbSBzdHJpbmcgYW5kIGZvcm1hdCBzdHJpbmcKZnVuY3Rpb24gY29uZmlnRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpIHsKICAgIC8vIFRPRE86IE1vdmUgdGhpcyB0byBhbm90aGVyIHBhcnQgb2YgdGhlIGNyZWF0aW9uIGZsb3cgdG8gcHJldmVudCBjaXJjdWxhciBkZXBzCiAgICBpZiAoY29uZmlnLl9mID09PSBob29rcy5JU09fODYwMSkgewogICAgICAgIGNvbmZpZ0Zyb21JU08oY29uZmlnKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoY29uZmlnLl9mID09PSBob29rcy5SRkNfMjgyMikgewogICAgICAgIGNvbmZpZ0Zyb21SRkMyODIyKGNvbmZpZyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgY29uZmlnLl9hID0gW107CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5lbXB0eSA9IHRydWU7CgogICAgLy8gVGhpcyBhcnJheSBpcyB1c2VkIHRvIG1ha2UgYSBEYXRlLCBlaXRoZXIgd2l0aCBgbmV3IERhdGVgIG9yIGBEYXRlLlVUQ2AKICAgIHZhciBzdHJpbmcgPSAnJyArIGNvbmZpZy5faSwKICAgICAgICBpLCBwYXJzZWRJbnB1dCwgdG9rZW5zLCB0b2tlbiwgc2tpcHBlZCwKICAgICAgICBzdHJpbmdMZW5ndGggPSBzdHJpbmcubGVuZ3RoLAogICAgICAgIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGggPSAwOwoKICAgIHRva2VucyA9IGV4cGFuZEZvcm1hdChjb25maWcuX2YsIGNvbmZpZy5fbG9jYWxlKS5tYXRjaChmb3JtYXR0aW5nVG9rZW5zKSB8fCBbXTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdG9rZW4gPSB0b2tlbnNbaV07CiAgICAgICAgcGFyc2VkSW5wdXQgPSAoc3RyaW5nLm1hdGNoKGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSkgfHwgW10pWzBdOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCd0b2tlbicsIHRva2VuLCAncGFyc2VkSW5wdXQnLCBwYXJzZWRJbnB1dCwKICAgICAgICAvLyAgICAgICAgICdyZWdleCcsIGdldFBhcnNlUmVnZXhGb3JUb2tlbih0b2tlbiwgY29uZmlnKSk7CiAgICAgICAgaWYgKHBhcnNlZElucHV0KSB7CiAgICAgICAgICAgIHNraXBwZWQgPSBzdHJpbmcuc3Vic3RyKDAsIHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSk7CiAgICAgICAgICAgIGlmIChza2lwcGVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLnVudXNlZElucHV0LnB1c2goc2tpcHBlZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RyaW5nID0gc3RyaW5nLnNsaWNlKHN0cmluZy5pbmRleE9mKHBhcnNlZElucHV0KSArIHBhcnNlZElucHV0Lmxlbmd0aCk7CiAgICAgICAgICAgIHRvdGFsUGFyc2VkSW5wdXRMZW5ndGggKz0gcGFyc2VkSW5wdXQubGVuZ3RoOwogICAgICAgIH0KICAgICAgICAvLyBkb24ndCBwYXJzZSBpZiBpdCdzIG5vdCBhIGtub3duIHRva2VuCiAgICAgICAgaWYgKGZvcm1hdFRva2VuRnVuY3Rpb25zW3Rva2VuXSkgewogICAgICAgICAgICBpZiAocGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmVtcHR5ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS51bnVzZWRUb2tlbnMucHVzaCh0b2tlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWRkVGltZVRvQXJyYXlGcm9tVG9rZW4odG9rZW4sIHBhcnNlZElucHV0LCBjb25maWcpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChjb25maWcuX3N0cmljdCAmJiAhcGFyc2VkSW5wdXQpIHsKICAgICAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykudW51c2VkVG9rZW5zLnB1c2godG9rZW4pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBhZGQgcmVtYWluaW5nIHVucGFyc2VkIGlucHV0IGxlbmd0aCB0byB0aGUgc3RyaW5nCiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5jaGFyc0xlZnRPdmVyID0gc3RyaW5nTGVuZ3RoIC0gdG90YWxQYXJzZWRJbnB1dExlbmd0aDsKICAgIGlmIChzdHJpbmcubGVuZ3RoID4gMCkgewogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLnVudXNlZElucHV0LnB1c2goc3RyaW5nKTsKICAgIH0KCiAgICAvLyBjbGVhciBfMTJoIGZsYWcgaWYgaG91ciBpcyA8PSAxMgogICAgaWYgKGNvbmZpZy5fYVtIT1VSXSA8PSAxMiAmJgogICAgICAgIGdldFBhcnNpbmdGbGFncyhjb25maWcpLmJpZ0hvdXIgPT09IHRydWUgJiYKICAgICAgICBjb25maWcuX2FbSE9VUl0gPiAwKSB7CiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKGNvbmZpZykuYmlnSG91ciA9IHVuZGVmaW5lZDsKICAgIH0KCiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5wYXJzZWREYXRlUGFydHMgPSBjb25maWcuX2Euc2xpY2UoMCk7CiAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5tZXJpZGllbSA9IGNvbmZpZy5fbWVyaWRpZW07CiAgICAvLyBoYW5kbGUgbWVyaWRpZW0KICAgIGNvbmZpZy5fYVtIT1VSXSA9IG1lcmlkaWVtRml4V3JhcChjb25maWcuX2xvY2FsZSwgY29uZmlnLl9hW0hPVVJdLCBjb25maWcuX21lcmlkaWVtKTsKCiAgICBjb25maWdGcm9tQXJyYXkoY29uZmlnKTsKICAgIGNoZWNrT3ZlcmZsb3coY29uZmlnKTsKfQoKCmZ1bmN0aW9uIG1lcmlkaWVtRml4V3JhcCAobG9jYWxlLCBob3VyLCBtZXJpZGllbSkgewogICAgdmFyIGlzUG07CgogICAgaWYgKG1lcmlkaWVtID09IG51bGwpIHsKICAgICAgICAvLyBub3RoaW5nIHRvIGRvCiAgICAgICAgcmV0dXJuIGhvdXI7CiAgICB9CiAgICBpZiAobG9jYWxlLm1lcmlkaWVtSG91ciAhPSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGxvY2FsZS5tZXJpZGllbUhvdXIoaG91ciwgbWVyaWRpZW0pOwogICAgfSBlbHNlIGlmIChsb2NhbGUuaXNQTSAhPSBudWxsKSB7CiAgICAgICAgLy8gRmFsbGJhY2sKICAgICAgICBpc1BtID0gbG9jYWxlLmlzUE0obWVyaWRpZW0pOwogICAgICAgIGlmIChpc1BtICYmIGhvdXIgPCAxMikgewogICAgICAgICAgICBob3VyICs9IDEyOwogICAgICAgIH0KICAgICAgICBpZiAoIWlzUG0gJiYgaG91ciA9PT0gMTIpIHsKICAgICAgICAgICAgaG91ciA9IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBob3VyOwogICAgfSBlbHNlIHsKICAgICAgICAvLyB0aGlzIGlzIG5vdCBzdXBwb3NlZCB0byBoYXBwZW4KICAgICAgICByZXR1cm4gaG91cjsKICAgIH0KfQoKLy8gZGF0ZSBmcm9tIHN0cmluZyBhbmQgYXJyYXkgb2YgZm9ybWF0IHN0cmluZ3MKZnVuY3Rpb24gY29uZmlnRnJvbVN0cmluZ0FuZEFycmF5KGNvbmZpZykgewogICAgdmFyIHRlbXBDb25maWcsCiAgICAgICAgYmVzdE1vbWVudCwKCiAgICAgICAgc2NvcmVUb0JlYXQsCiAgICAgICAgaSwKICAgICAgICBjdXJyZW50U2NvcmU7CgogICAgaWYgKGNvbmZpZy5fZi5sZW5ndGggPT09IDApIHsKICAgICAgICBnZXRQYXJzaW5nRmxhZ3MoY29uZmlnKS5pbnZhbGlkRm9ybWF0ID0gdHJ1ZTsKICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShOYU4pOwogICAgICAgIHJldHVybjsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgY29uZmlnLl9mLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY3VycmVudFNjb3JlID0gMDsKICAgICAgICB0ZW1wQ29uZmlnID0gY29weUNvbmZpZyh7fSwgY29uZmlnKTsKICAgICAgICBpZiAoY29uZmlnLl91c2VVVEMgIT0gbnVsbCkgewogICAgICAgICAgICB0ZW1wQ29uZmlnLl91c2VVVEMgPSBjb25maWcuX3VzZVVUQzsKICAgICAgICB9CiAgICAgICAgdGVtcENvbmZpZy5fZiA9IGNvbmZpZy5fZltpXTsKICAgICAgICBjb25maWdGcm9tU3RyaW5nQW5kRm9ybWF0KHRlbXBDb25maWcpOwoKICAgICAgICBpZiAoIWlzVmFsaWQodGVtcENvbmZpZykpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICAvLyBpZiB0aGVyZSBpcyBhbnkgaW5wdXQgdGhhdCB3YXMgbm90IHBhcnNlZCBhZGQgYSBwZW5hbHR5IGZvciB0aGF0IGZvcm1hdAogICAgICAgIGN1cnJlbnRTY29yZSArPSBnZXRQYXJzaW5nRmxhZ3ModGVtcENvbmZpZykuY2hhcnNMZWZ0T3ZlcjsKCiAgICAgICAgLy9vciB0b2tlbnMKICAgICAgICBjdXJyZW50U2NvcmUgKz0gZ2V0UGFyc2luZ0ZsYWdzKHRlbXBDb25maWcpLnVudXNlZFRva2Vucy5sZW5ndGggKiAxMDsKCiAgICAgICAgZ2V0UGFyc2luZ0ZsYWdzKHRlbXBDb25maWcpLnNjb3JlID0gY3VycmVudFNjb3JlOwoKICAgICAgICBpZiAoc2NvcmVUb0JlYXQgPT0gbnVsbCB8fCBjdXJyZW50U2NvcmUgPCBzY29yZVRvQmVhdCkgewogICAgICAgICAgICBzY29yZVRvQmVhdCA9IGN1cnJlbnRTY29yZTsKICAgICAgICAgICAgYmVzdE1vbWVudCA9IHRlbXBDb25maWc7CiAgICAgICAgfQogICAgfQoKICAgIGV4dGVuZChjb25maWcsIGJlc3RNb21lbnQgfHwgdGVtcENvbmZpZyk7Cn0KCmZ1bmN0aW9uIGNvbmZpZ0Zyb21PYmplY3QoY29uZmlnKSB7CiAgICBpZiAoY29uZmlnLl9kKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBpID0gbm9ybWFsaXplT2JqZWN0VW5pdHMoY29uZmlnLl9pKTsKICAgIGNvbmZpZy5fYSA9IG1hcChbaS55ZWFyLCBpLm1vbnRoLCBpLmRheSB8fCBpLmRhdGUsIGkuaG91ciwgaS5taW51dGUsIGkuc2Vjb25kLCBpLm1pbGxpc2Vjb25kXSwgZnVuY3Rpb24gKG9iaikgewogICAgICAgIHJldHVybiBvYmogJiYgcGFyc2VJbnQob2JqLCAxMCk7CiAgICB9KTsKCiAgICBjb25maWdGcm9tQXJyYXkoY29uZmlnKTsKfQoKZnVuY3Rpb24gY3JlYXRlRnJvbUNvbmZpZyAoY29uZmlnKSB7CiAgICB2YXIgcmVzID0gbmV3IE1vbWVudChjaGVja092ZXJmbG93KHByZXBhcmVDb25maWcoY29uZmlnKSkpOwogICAgaWYgKHJlcy5fbmV4dERheSkgewogICAgICAgIC8vIEFkZGluZyBpcyBzbWFydCBlbm91Z2ggYXJvdW5kIERTVAogICAgICAgIHJlcy5hZGQoMSwgJ2QnKTsKICAgICAgICByZXMuX25leHREYXkgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gcHJlcGFyZUNvbmZpZyAoY29uZmlnKSB7CiAgICB2YXIgaW5wdXQgPSBjb25maWcuX2ksCiAgICAgICAgZm9ybWF0ID0gY29uZmlnLl9mOwoKICAgIGNvbmZpZy5fbG9jYWxlID0gY29uZmlnLl9sb2NhbGUgfHwgZ2V0TG9jYWxlKGNvbmZpZy5fbCk7CgogICAgaWYgKGlucHV0ID09PSBudWxsIHx8IChmb3JtYXQgPT09IHVuZGVmaW5lZCAmJiBpbnB1dCA9PT0gJycpKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUludmFsaWQoe251bGxJbnB1dDogdHJ1ZX0pOwogICAgfQoKICAgIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgY29uZmlnLl9pID0gaW5wdXQgPSBjb25maWcuX2xvY2FsZS5wcmVwYXJzZShpbnB1dCk7CiAgICB9CgogICAgaWYgKGlzTW9tZW50KGlucHV0KSkgewogICAgICAgIHJldHVybiBuZXcgTW9tZW50KGNoZWNrT3ZlcmZsb3coaW5wdXQpKTsKICAgIH0gZWxzZSBpZiAoaXNEYXRlKGlucHV0KSkgewogICAgICAgIGNvbmZpZy5fZCA9IGlucHV0OwogICAgfSBlbHNlIGlmIChpc0FycmF5KGZvcm1hdCkpIHsKICAgICAgICBjb25maWdGcm9tU3RyaW5nQW5kQXJyYXkoY29uZmlnKTsKICAgIH0gZWxzZSBpZiAoZm9ybWF0KSB7CiAgICAgICAgY29uZmlnRnJvbVN0cmluZ0FuZEZvcm1hdChjb25maWcpOwogICAgfSAgZWxzZSB7CiAgICAgICAgY29uZmlnRnJvbUlucHV0KGNvbmZpZyk7CiAgICB9CgogICAgaWYgKCFpc1ZhbGlkKGNvbmZpZykpIHsKICAgICAgICBjb25maWcuX2QgPSBudWxsOwogICAgfQoKICAgIHJldHVybiBjb25maWc7Cn0KCmZ1bmN0aW9uIGNvbmZpZ0Zyb21JbnB1dChjb25maWcpIHsKICAgIHZhciBpbnB1dCA9IGNvbmZpZy5faTsKICAgIGlmIChpc1VuZGVmaW5lZChpbnB1dCkpIHsKICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShob29rcy5ub3coKSk7CiAgICB9IGVsc2UgaWYgKGlzRGF0ZShpbnB1dCkpIHsKICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dC52YWx1ZU9mKCkpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgY29uZmlnRnJvbVN0cmluZyhjb25maWcpOwogICAgfSBlbHNlIGlmIChpc0FycmF5KGlucHV0KSkgewogICAgICAgIGNvbmZpZy5fYSA9IG1hcChpbnB1dC5zbGljZSgwKSwgZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICByZXR1cm4gcGFyc2VJbnQob2JqLCAxMCk7CiAgICAgICAgfSk7CiAgICAgICAgY29uZmlnRnJvbUFycmF5KGNvbmZpZyk7CiAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KGlucHV0KSkgewogICAgICAgIGNvbmZpZ0Zyb21PYmplY3QoY29uZmlnKTsKICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIoaW5wdXQpKSB7CiAgICAgICAgLy8gZnJvbSBtaWxsaXNlY29uZHMKICAgICAgICBjb25maWcuX2QgPSBuZXcgRGF0ZShpbnB1dCk7CiAgICB9IGVsc2UgewogICAgICAgIGhvb2tzLmNyZWF0ZUZyb21JbnB1dEZhbGxiYWNrKGNvbmZpZyk7CiAgICB9Cn0KCmZ1bmN0aW9uIGNyZWF0ZUxvY2FsT3JVVEMgKGlucHV0LCBmb3JtYXQsIGxvY2FsZSwgc3RyaWN0LCBpc1VUQykgewogICAgdmFyIGMgPSB7fTsKCiAgICBpZiAobG9jYWxlID09PSB0cnVlIHx8IGxvY2FsZSA9PT0gZmFsc2UpIHsKICAgICAgICBzdHJpY3QgPSBsb2NhbGU7CiAgICAgICAgbG9jYWxlID0gdW5kZWZpbmVkOwogICAgfQoKICAgIGlmICgoaXNPYmplY3QoaW5wdXQpICYmIGlzT2JqZWN0RW1wdHkoaW5wdXQpKSB8fAogICAgICAgICAgICAoaXNBcnJheShpbnB1dCkgJiYgaW5wdXQubGVuZ3RoID09PSAwKSkgewogICAgICAgIGlucHV0ID0gdW5kZWZpbmVkOwogICAgfQogICAgLy8gb2JqZWN0IGNvbnN0cnVjdGlvbiBtdXN0IGJlIGRvbmUgdGhpcyB3YXkuCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMTQyMwogICAgYy5faXNBTW9tZW50T2JqZWN0ID0gdHJ1ZTsKICAgIGMuX3VzZVVUQyA9IGMuX2lzVVRDID0gaXNVVEM7CiAgICBjLl9sID0gbG9jYWxlOwogICAgYy5faSA9IGlucHV0OwogICAgYy5fZiA9IGZvcm1hdDsKICAgIGMuX3N0cmljdCA9IHN0cmljdDsKCiAgICByZXR1cm4gY3JlYXRlRnJvbUNvbmZpZyhjKTsKfQoKZnVuY3Rpb24gY3JlYXRlTG9jYWwgKGlucHV0LCBmb3JtYXQsIGxvY2FsZSwgc3RyaWN0KSB7CiAgICByZXR1cm4gY3JlYXRlTG9jYWxPclVUQyhpbnB1dCwgZm9ybWF0LCBsb2NhbGUsIHN0cmljdCwgZmFsc2UpOwp9Cgp2YXIgcHJvdG90eXBlTWluID0gZGVwcmVjYXRlKAogICAgJ21vbWVudCgpLm1pbiBpcyBkZXByZWNhdGVkLCB1c2UgbW9tZW50Lm1heCBpbnN0ZWFkLiBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL21pbi1tYXgvJywKICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgb3RoZXIgPSBjcmVhdGVMb2NhbC5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICAgIGlmICh0aGlzLmlzVmFsaWQoKSAmJiBvdGhlci5pc1ZhbGlkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIG90aGVyIDwgdGhpcyA/IHRoaXMgOiBvdGhlcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY3JlYXRlSW52YWxpZCgpOwogICAgICAgIH0KICAgIH0KKTsKCnZhciBwcm90b3R5cGVNYXggPSBkZXByZWNhdGUoCiAgICAnbW9tZW50KCkubWF4IGlzIGRlcHJlY2F0ZWQsIHVzZSBtb21lbnQubWluIGluc3RlYWQuIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvbWluLW1heC8nLAogICAgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBvdGhlciA9IGNyZWF0ZUxvY2FsLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKHRoaXMuaXNWYWxpZCgpICYmIG90aGVyLmlzVmFsaWQoKSkgewogICAgICAgICAgICByZXR1cm4gb3RoZXIgPiB0aGlzID8gdGhpcyA6IG90aGVyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVJbnZhbGlkKCk7CiAgICAgICAgfQogICAgfQopOwoKLy8gUGljayBhIG1vbWVudCBtIGZyb20gbW9tZW50cyBzbyB0aGF0IG1bZm5dKG90aGVyKSBpcyB0cnVlIGZvciBhbGwKLy8gb3RoZXIuIFRoaXMgcmVsaWVzIG9uIHRoZSBmdW5jdGlvbiBmbiB0byBiZSB0cmFuc2l0aXZlLgovLwovLyBtb21lbnRzIHNob3VsZCBlaXRoZXIgYmUgYW4gYXJyYXkgb2YgbW9tZW50IG9iamVjdHMgb3IgYW4gYXJyYXksIHdob3NlCi8vIGZpcnN0IGVsZW1lbnQgaXMgYW4gYXJyYXkgb2YgbW9tZW50IG9iamVjdHMuCmZ1bmN0aW9uIHBpY2tCeShmbiwgbW9tZW50cykgewogICAgdmFyIHJlcywgaTsKICAgIGlmIChtb21lbnRzLmxlbmd0aCA9PT0gMSAmJiBpc0FycmF5KG1vbWVudHNbMF0pKSB7CiAgICAgICAgbW9tZW50cyA9IG1vbWVudHNbMF07CiAgICB9CiAgICBpZiAoIW1vbWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUxvY2FsKCk7CiAgICB9CiAgICByZXMgPSBtb21lbnRzWzBdOwogICAgZm9yIChpID0gMTsgaSA8IG1vbWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgICBpZiAoIW1vbWVudHNbaV0uaXNWYWxpZCgpIHx8IG1vbWVudHNbaV1bZm5dKHJlcykpIHsKICAgICAgICAgICAgcmVzID0gbW9tZW50c1tpXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzOwp9CgovLyBUT0RPOiBVc2UgW10uc29ydCBpbnN0ZWFkPwpmdW5jdGlvbiBtaW4gKCkgewogICAgdmFyIGFyZ3MgPSBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CgogICAgcmV0dXJuIHBpY2tCeSgnaXNCZWZvcmUnLCBhcmdzKTsKfQoKZnVuY3Rpb24gbWF4ICgpIHsKICAgIHZhciBhcmdzID0gW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDApOwoKICAgIHJldHVybiBwaWNrQnkoJ2lzQWZ0ZXInLCBhcmdzKTsKfQoKdmFyIG5vdyA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBEYXRlLm5vdyA/IERhdGUubm93KCkgOiArKG5ldyBEYXRlKCkpOwp9OwoKdmFyIG9yZGVyaW5nID0gWyd5ZWFyJywgJ3F1YXJ0ZXInLCAnbW9udGgnLCAnd2VlaycsICdkYXknLCAnaG91cicsICdtaW51dGUnLCAnc2Vjb25kJywgJ21pbGxpc2Vjb25kJ107CgpmdW5jdGlvbiBpc0R1cmF0aW9uVmFsaWQobSkgewogICAgZm9yICh2YXIga2V5IGluIG0pIHsKICAgICAgICBpZiAoIShpbmRleE9mLmNhbGwob3JkZXJpbmcsIGtleSkgIT09IC0xICYmIChtW2tleV0gPT0gbnVsbCB8fCAhaXNOYU4obVtrZXldKSkpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgdmFyIHVuaXRIYXNEZWNpbWFsID0gZmFsc2U7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9yZGVyaW5nLmxlbmd0aDsgKytpKSB7CiAgICAgICAgaWYgKG1bb3JkZXJpbmdbaV1dKSB7CiAgICAgICAgICAgIGlmICh1bml0SGFzRGVjaW1hbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBvbmx5IGFsbG93IG5vbi1pbnRlZ2VycyBmb3Igc21hbGxlc3QgdW5pdAogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJzZUZsb2F0KG1bb3JkZXJpbmdbaV1dKSAhPT0gdG9JbnQobVtvcmRlcmluZ1tpXV0pKSB7CiAgICAgICAgICAgICAgICB1bml0SGFzRGVjaW1hbCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGlzVmFsaWQkMSgpIHsKICAgIHJldHVybiB0aGlzLl9pc1ZhbGlkOwp9CgpmdW5jdGlvbiBjcmVhdGVJbnZhbGlkJDEoKSB7CiAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oTmFOKTsKfQoKZnVuY3Rpb24gRHVyYXRpb24gKGR1cmF0aW9uKSB7CiAgICB2YXIgbm9ybWFsaXplZElucHV0ID0gbm9ybWFsaXplT2JqZWN0VW5pdHMoZHVyYXRpb24pLAogICAgICAgIHllYXJzID0gbm9ybWFsaXplZElucHV0LnllYXIgfHwgMCwKICAgICAgICBxdWFydGVycyA9IG5vcm1hbGl6ZWRJbnB1dC5xdWFydGVyIHx8IDAsCiAgICAgICAgbW9udGhzID0gbm9ybWFsaXplZElucHV0Lm1vbnRoIHx8IDAsCiAgICAgICAgd2Vla3MgPSBub3JtYWxpemVkSW5wdXQud2VlayB8fCAwLAogICAgICAgIGRheXMgPSBub3JtYWxpemVkSW5wdXQuZGF5IHx8IDAsCiAgICAgICAgaG91cnMgPSBub3JtYWxpemVkSW5wdXQuaG91ciB8fCAwLAogICAgICAgIG1pbnV0ZXMgPSBub3JtYWxpemVkSW5wdXQubWludXRlIHx8IDAsCiAgICAgICAgc2Vjb25kcyA9IG5vcm1hbGl6ZWRJbnB1dC5zZWNvbmQgfHwgMCwKICAgICAgICBtaWxsaXNlY29uZHMgPSBub3JtYWxpemVkSW5wdXQubWlsbGlzZWNvbmQgfHwgMDsKCiAgICB0aGlzLl9pc1ZhbGlkID0gaXNEdXJhdGlvblZhbGlkKG5vcm1hbGl6ZWRJbnB1dCk7CgogICAgLy8gcmVwcmVzZW50YXRpb24gZm9yIGRhdGVBZGRSZW1vdmUKICAgIHRoaXMuX21pbGxpc2Vjb25kcyA9ICttaWxsaXNlY29uZHMgKwogICAgICAgIHNlY29uZHMgKiAxZTMgKyAvLyAxMDAwCiAgICAgICAgbWludXRlcyAqIDZlNCArIC8vIDEwMDAgKiA2MAogICAgICAgIGhvdXJzICogMTAwMCAqIDYwICogNjA7IC8vdXNpbmcgMTAwMCAqIDYwICogNjAgaW5zdGVhZCBvZiAzNmU1IHRvIGF2b2lkIGZsb2F0aW5nIHBvaW50IHJvdW5kaW5nIGVycm9ycyBodHRwczovL2dpdGh1Yi5jb20vbW9tZW50L21vbWVudC9pc3N1ZXMvMjk3OAogICAgLy8gQmVjYXVzZSBvZiBkYXRlQWRkUmVtb3ZlIHRyZWF0cyAyNCBob3VycyBhcyBkaWZmZXJlbnQgZnJvbSBhCiAgICAvLyBkYXkgd2hlbiB3b3JraW5nIGFyb3VuZCBEU1QsIHdlIG5lZWQgdG8gc3RvcmUgdGhlbSBzZXBhcmF0ZWx5CiAgICB0aGlzLl9kYXlzID0gK2RheXMgKwogICAgICAgIHdlZWtzICogNzsKICAgIC8vIEl0IGlzIGltcG9zc2libGUgdG8gdHJhbnNsYXRlIG1vbnRocyBpbnRvIGRheXMgd2l0aG91dCBrbm93aW5nCiAgICAvLyB3aGljaCBtb250aHMgeW91IGFyZSBhcmUgdGFsa2luZyBhYm91dCwgc28gd2UgaGF2ZSB0byBzdG9yZQogICAgLy8gaXQgc2VwYXJhdGVseS4KICAgIHRoaXMuX21vbnRocyA9ICttb250aHMgKwogICAgICAgIHF1YXJ0ZXJzICogMyArCiAgICAgICAgeWVhcnMgKiAxMjsKCiAgICB0aGlzLl9kYXRhID0ge307CgogICAgdGhpcy5fbG9jYWxlID0gZ2V0TG9jYWxlKCk7CgogICAgdGhpcy5fYnViYmxlKCk7Cn0KCmZ1bmN0aW9uIGlzRHVyYXRpb24gKG9iaikgewogICAgcmV0dXJuIG9iaiBpbnN0YW5jZW9mIER1cmF0aW9uOwp9CgpmdW5jdGlvbiBhYnNSb3VuZCAobnVtYmVyKSB7CiAgICBpZiAobnVtYmVyIDwgMCkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKC0xICogbnVtYmVyKSAqIC0xOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChudW1iZXIpOwogICAgfQp9CgovLyBGT1JNQVRUSU5HCgpmdW5jdGlvbiBvZmZzZXQgKHRva2VuLCBzZXBhcmF0b3IpIHsKICAgIGFkZEZvcm1hdFRva2VuKHRva2VuLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG9mZnNldCA9IHRoaXMudXRjT2Zmc2V0KCk7CiAgICAgICAgdmFyIHNpZ24gPSAnKyc7CiAgICAgICAgaWYgKG9mZnNldCA8IDApIHsKICAgICAgICAgICAgb2Zmc2V0ID0gLW9mZnNldDsKICAgICAgICAgICAgc2lnbiA9ICctJzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNpZ24gKyB6ZXJvRmlsbCh+fihvZmZzZXQgLyA2MCksIDIpICsgc2VwYXJhdG9yICsgemVyb0ZpbGwofn4ob2Zmc2V0KSAlIDYwLCAyKTsKICAgIH0pOwp9CgpvZmZzZXQoJ1onLCAnOicpOwpvZmZzZXQoJ1paJywgJycpOwoKLy8gUEFSU0lORwoKYWRkUmVnZXhUb2tlbignWicsICBtYXRjaFNob3J0T2Zmc2V0KTsKYWRkUmVnZXhUb2tlbignWlonLCBtYXRjaFNob3J0T2Zmc2V0KTsKYWRkUGFyc2VUb2tlbihbJ1onLCAnWlonXSwgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICBjb25maWcuX3VzZVVUQyA9IHRydWU7CiAgICBjb25maWcuX3R6bSA9IG9mZnNldEZyb21TdHJpbmcobWF0Y2hTaG9ydE9mZnNldCwgaW5wdXQpOwp9KTsKCi8vIEhFTFBFUlMKCi8vIHRpbWV6b25lIGNodW5rZXIKLy8gJysxMDowMCcgPiBbJzEwJywgICcwMCddCi8vICctMTUzMCcgID4gWyctMTUnLCAnMzAnXQp2YXIgY2h1bmtPZmZzZXQgPSAvKFtcK1wtXXxcZFxkKS9naTsKCmZ1bmN0aW9uIG9mZnNldEZyb21TdHJpbmcobWF0Y2hlciwgc3RyaW5nKSB7CiAgICB2YXIgbWF0Y2hlcyA9IChzdHJpbmcgfHwgJycpLm1hdGNoKG1hdGNoZXIpOwoKICAgIGlmIChtYXRjaGVzID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIGNodW5rICAgPSBtYXRjaGVzW21hdGNoZXMubGVuZ3RoIC0gMV0gfHwgW107CiAgICB2YXIgcGFydHMgICA9IChjaHVuayArICcnKS5tYXRjaChjaHVua09mZnNldCkgfHwgWyctJywgMCwgMF07CiAgICB2YXIgbWludXRlcyA9ICsocGFydHNbMV0gKiA2MCkgKyB0b0ludChwYXJ0c1syXSk7CgogICAgcmV0dXJuIG1pbnV0ZXMgPT09IDAgPwogICAgICAwIDoKICAgICAgcGFydHNbMF0gPT09ICcrJyA/IG1pbnV0ZXMgOiAtbWludXRlczsKfQoKLy8gUmV0dXJuIGEgbW9tZW50IGZyb20gaW5wdXQsIHRoYXQgaXMgbG9jYWwvdXRjL3pvbmUgZXF1aXZhbGVudCB0byBtb2RlbC4KZnVuY3Rpb24gY2xvbmVXaXRoT2Zmc2V0KGlucHV0LCBtb2RlbCkgewogICAgdmFyIHJlcywgZGlmZjsKICAgIGlmIChtb2RlbC5faXNVVEMpIHsKICAgICAgICByZXMgPSBtb2RlbC5jbG9uZSgpOwogICAgICAgIGRpZmYgPSAoaXNNb21lbnQoaW5wdXQpIHx8IGlzRGF0ZShpbnB1dCkgPyBpbnB1dC52YWx1ZU9mKCkgOiBjcmVhdGVMb2NhbChpbnB1dCkudmFsdWVPZigpKSAtIHJlcy52YWx1ZU9mKCk7CiAgICAgICAgLy8gVXNlIGxvdy1sZXZlbCBhcGksIGJlY2F1c2UgdGhpcyBmbiBpcyBsb3ctbGV2ZWwgYXBpLgogICAgICAgIHJlcy5fZC5zZXRUaW1lKHJlcy5fZC52YWx1ZU9mKCkgKyBkaWZmKTsKICAgICAgICBob29rcy51cGRhdGVPZmZzZXQocmVzLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUxvY2FsKGlucHV0KS5sb2NhbCgpOwogICAgfQp9CgpmdW5jdGlvbiBnZXREYXRlT2Zmc2V0IChtKSB7CiAgICAvLyBPbiBGaXJlZm94LjI0IERhdGUjZ2V0VGltZXpvbmVPZmZzZXQgcmV0dXJucyBhIGZsb2F0aW5nIHBvaW50LgogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvcHVsbC8xODcxCiAgICByZXR1cm4gLU1hdGgucm91bmQobS5fZC5nZXRUaW1lem9uZU9mZnNldCgpIC8gMTUpICogMTU7Cn0KCi8vIEhPT0tTCgovLyBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdoZW5ldmVyIGEgbW9tZW50IGlzIG11dGF0ZWQuCi8vIEl0IGlzIGludGVuZGVkIHRvIGtlZXAgdGhlIG9mZnNldCBpbiBzeW5jIHdpdGggdGhlIHRpbWV6b25lLgpob29rcy51cGRhdGVPZmZzZXQgPSBmdW5jdGlvbiAoKSB7fTsKCi8vIE1PTUVOVFMKCi8vIGtlZXBMb2NhbFRpbWUgPSB0cnVlIG1lYW5zIG9ubHkgY2hhbmdlIHRoZSB0aW1lem9uZSwgd2l0aG91dAovLyBhZmZlY3RpbmcgdGhlIGxvY2FsIGhvdXIuIFNvIDU6MzE6MjYgKzAzMDAgLS1bdXRjT2Zmc2V0KDIsIHRydWUpXS0tPgovLyA1OjMxOjI2ICswMjAwIEl0IGlzIHBvc3NpYmxlIHRoYXQgNTozMToyNiBkb2Vzbid0IGV4aXN0IHdpdGggb2Zmc2V0Ci8vICswMjAwLCBzbyB3ZSBhZGp1c3QgdGhlIHRpbWUgYXMgbmVlZGVkLCB0byBiZSB2YWxpZC4KLy8KLy8gS2VlcGluZyB0aGUgdGltZSBhY3R1YWxseSBhZGRzL3N1YnRyYWN0cyAob25lIGhvdXIpCi8vIGZyb20gdGhlIGFjdHVhbCByZXByZXNlbnRlZCB0aW1lLiBUaGF0IGlzIHdoeSB3ZSBjYWxsIHVwZGF0ZU9mZnNldAovLyBhIHNlY29uZCB0aW1lLiBJbiBjYXNlIGl0IHdhbnRzIHVzIHRvIGNoYW5nZSB0aGUgb2Zmc2V0IGFnYWluCi8vIF9jaGFuZ2VJblByb2dyZXNzID09IHRydWUgY2FzZSwgdGhlbiB3ZSBoYXZlIHRvIGFkanVzdCwgYmVjYXVzZQovLyB0aGVyZSBpcyBubyBzdWNoIHRpbWUgaW4gdGhlIGdpdmVuIHRpbWV6b25lLgpmdW5jdGlvbiBnZXRTZXRPZmZzZXQgKGlucHV0LCBrZWVwTG9jYWxUaW1lLCBrZWVwTWludXRlcykgewogICAgdmFyIG9mZnNldCA9IHRoaXMuX29mZnNldCB8fCAwLAogICAgICAgIGxvY2FsQWRqdXN0OwogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiBpbnB1dCAhPSBudWxsID8gdGhpcyA6IE5hTjsKICAgIH0KICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgaW5wdXQgPSBvZmZzZXRGcm9tU3RyaW5nKG1hdGNoU2hvcnRPZmZzZXQsIGlucHV0KTsKICAgICAgICAgICAgaWYgKGlucHV0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoTWF0aC5hYnMoaW5wdXQpIDwgMTYgJiYgIWtlZXBNaW51dGVzKSB7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQgKiA2MDsKICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9pc1VUQyAmJiBrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgIGxvY2FsQWRqdXN0ID0gZ2V0RGF0ZU9mZnNldCh0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fb2Zmc2V0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5faXNVVEMgPSB0cnVlOwogICAgICAgIGlmIChsb2NhbEFkanVzdCAhPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuYWRkKGxvY2FsQWRqdXN0LCAnbScpOwogICAgICAgIH0KICAgICAgICBpZiAob2Zmc2V0ICE9PSBpbnB1dCkgewogICAgICAgICAgICBpZiAoIWtlZXBMb2NhbFRpbWUgfHwgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgYWRkU3VidHJhY3QodGhpcywgY3JlYXRlRHVyYXRpb24oaW5wdXQgLSBvZmZzZXQsICdtJyksIDEsIGZhbHNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcykgewogICAgICAgICAgICAgICAgdGhpcy5fY2hhbmdlSW5Qcm9ncmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgICBob29rcy51cGRhdGVPZmZzZXQodGhpcywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2lzVVRDID8gb2Zmc2V0IDogZ2V0RGF0ZU9mZnNldCh0aGlzKTsKICAgIH0KfQoKZnVuY3Rpb24gZ2V0U2V0Wm9uZSAoaW5wdXQsIGtlZXBMb2NhbFRpbWUpIHsKICAgIGlmIChpbnB1dCAhPSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgaW5wdXQgPSAtaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnV0Y09mZnNldChpbnB1dCwga2VlcExvY2FsVGltZSk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gLXRoaXMudXRjT2Zmc2V0KCk7CiAgICB9Cn0KCmZ1bmN0aW9uIHNldE9mZnNldFRvVVRDIChrZWVwTG9jYWxUaW1lKSB7CiAgICByZXR1cm4gdGhpcy51dGNPZmZzZXQoMCwga2VlcExvY2FsVGltZSk7Cn0KCmZ1bmN0aW9uIHNldE9mZnNldFRvTG9jYWwgKGtlZXBMb2NhbFRpbWUpIHsKICAgIGlmICh0aGlzLl9pc1VUQykgewogICAgICAgIHRoaXMudXRjT2Zmc2V0KDAsIGtlZXBMb2NhbFRpbWUpOwogICAgICAgIHRoaXMuX2lzVVRDID0gZmFsc2U7CgogICAgICAgIGlmIChrZWVwTG9jYWxUaW1lKSB7CiAgICAgICAgICAgIHRoaXMuc3VidHJhY3QoZ2V0RGF0ZU9mZnNldCh0aGlzKSwgJ20nKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKfQoKZnVuY3Rpb24gc2V0T2Zmc2V0VG9QYXJzZWRPZmZzZXQgKCkgewogICAgaWYgKHRoaXMuX3R6bSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy51dGNPZmZzZXQodGhpcy5fdHptLCBmYWxzZSwgdHJ1ZSk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB0aGlzLl9pID09PSAnc3RyaW5nJykgewogICAgICAgIHZhciB0Wm9uZSA9IG9mZnNldEZyb21TdHJpbmcobWF0Y2hPZmZzZXQsIHRoaXMuX2kpOwogICAgICAgIGlmICh0Wm9uZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMudXRjT2Zmc2V0KHRab25lKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRoaXMudXRjT2Zmc2V0KDAsIHRydWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwp9CgpmdW5jdGlvbiBoYXNBbGlnbmVkSG91ck9mZnNldCAoaW5wdXQpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBpbnB1dCA9IGlucHV0ID8gY3JlYXRlTG9jYWwoaW5wdXQpLnV0Y09mZnNldCgpIDogMDsKCiAgICByZXR1cm4gKHRoaXMudXRjT2Zmc2V0KCkgLSBpbnB1dCkgJSA2MCA9PT0gMDsKfQoKZnVuY3Rpb24gaXNEYXlsaWdodFNhdmluZ1RpbWUgKCkgewogICAgcmV0dXJuICgKICAgICAgICB0aGlzLnV0Y09mZnNldCgpID4gdGhpcy5jbG9uZSgpLm1vbnRoKDApLnV0Y09mZnNldCgpIHx8CiAgICAgICAgdGhpcy51dGNPZmZzZXQoKSA+IHRoaXMuY2xvbmUoKS5tb250aCg1KS51dGNPZmZzZXQoKQogICAgKTsKfQoKZnVuY3Rpb24gaXNEYXlsaWdodFNhdmluZ1RpbWVTaGlmdGVkICgpIHsKICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5faXNEU1RTaGlmdGVkKSkgewogICAgICAgIHJldHVybiB0aGlzLl9pc0RTVFNoaWZ0ZWQ7CiAgICB9CgogICAgdmFyIGMgPSB7fTsKCiAgICBjb3B5Q29uZmlnKGMsIHRoaXMpOwogICAgYyA9IHByZXBhcmVDb25maWcoYyk7CgogICAgaWYgKGMuX2EpIHsKICAgICAgICB2YXIgb3RoZXIgPSBjLl9pc1VUQyA/IGNyZWF0ZVVUQyhjLl9hKSA6IGNyZWF0ZUxvY2FsKGMuX2EpOwogICAgICAgIHRoaXMuX2lzRFNUU2hpZnRlZCA9IHRoaXMuaXNWYWxpZCgpICYmCiAgICAgICAgICAgIGNvbXBhcmVBcnJheXMoYy5fYSwgb3RoZXIudG9BcnJheSgpKSA+IDA7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2lzRFNUU2hpZnRlZCA9IGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0aGlzLl9pc0RTVFNoaWZ0ZWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwgKCkgewogICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gIXRoaXMuX2lzVVRDIDogZmFsc2U7Cn0KCmZ1bmN0aW9uIGlzVXRjT2Zmc2V0ICgpIHsKICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMuX2lzVVRDIDogZmFsc2U7Cn0KCmZ1bmN0aW9uIGlzVXRjICgpIHsKICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMuX2lzVVRDICYmIHRoaXMuX29mZnNldCA9PT0gMCA6IGZhbHNlOwp9CgovLyBBU1AuTkVUIGpzb24gZGF0ZSBmb3JtYXQgcmVnZXgKdmFyIGFzcE5ldFJlZ2V4ID0gL14oXC18XCspPyg/OihcZCopWy4gXSk/KFxkKylcOihcZCspKD86XDooXGQrKShcLlxkKik/KT8kLzsKCi8vIGZyb20gaHR0cDovL2RvY3MuY2xvc3VyZS1saWJyYXJ5Lmdvb2dsZWNvZGUuY29tL2dpdC9jbG9zdXJlX2dvb2dfZGF0ZV9kYXRlLmpzLnNvdXJjZS5odG1sCi8vIHNvbWV3aGF0IG1vcmUgaW4gbGluZSB3aXRoIDQuNC4zLjIgMjAwNCBzcGVjLCBidXQgYWxsb3dzIGRlY2ltYWwgYW55d2hlcmUKLy8gYW5kIGZ1cnRoZXIgbW9kaWZpZWQgdG8gYWxsb3cgZm9yIHN0cmluZ3MgY29udGFpbmluZyBib3RoIHdlZWsgYW5kIGRheQp2YXIgaXNvUmVnZXggPSAvXigtfFwrKT9QKD86KFstK10/WzAtOSwuXSopWSk/KD86KFstK10/WzAtOSwuXSopTSk/KD86KFstK10/WzAtOSwuXSopVyk/KD86KFstK10/WzAtOSwuXSopRCk/KD86VCg/OihbLStdP1swLTksLl0qKUgpPyg/OihbLStdP1swLTksLl0qKU0pPyg/OihbLStdP1swLTksLl0qKVMpPyk/JC87CgpmdW5jdGlvbiBjcmVhdGVEdXJhdGlvbiAoaW5wdXQsIGtleSkgewogICAgdmFyIGR1cmF0aW9uID0gaW5wdXQsCiAgICAgICAgLy8gbWF0Y2hpbmcgYWdhaW5zdCByZWdleHAgaXMgZXhwZW5zaXZlLCBkbyBpdCBvbiBkZW1hbmQKICAgICAgICBtYXRjaCA9IG51bGwsCiAgICAgICAgc2lnbiwKICAgICAgICByZXQsCiAgICAgICAgZGlmZlJlczsKCiAgICBpZiAoaXNEdXJhdGlvbihpbnB1dCkpIHsKICAgICAgICBkdXJhdGlvbiA9IHsKICAgICAgICAgICAgbXMgOiBpbnB1dC5fbWlsbGlzZWNvbmRzLAogICAgICAgICAgICBkICA6IGlucHV0Ll9kYXlzLAogICAgICAgICAgICBNICA6IGlucHV0Ll9tb250aHMKICAgICAgICB9OwogICAgfSBlbHNlIGlmIChpc051bWJlcihpbnB1dCkpIHsKICAgICAgICBkdXJhdGlvbiA9IHt9OwogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgZHVyYXRpb25ba2V5XSA9IGlucHV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGR1cmF0aW9uLm1pbGxpc2Vjb25kcyA9IGlucHV0OwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoISEobWF0Y2ggPSBhc3BOZXRSZWdleC5leGVjKGlucHV0KSkpIHsKICAgICAgICBzaWduID0gKG1hdGNoWzFdID09PSAnLScpID8gLTEgOiAxOwogICAgICAgIGR1cmF0aW9uID0gewogICAgICAgICAgICB5ICA6IDAsCiAgICAgICAgICAgIGQgIDogdG9JbnQobWF0Y2hbREFURV0pICAgICAgICAgICAgICAgICAgICAgICAgICogc2lnbiwKICAgICAgICAgICAgaCAgOiB0b0ludChtYXRjaFtIT1VSXSkgICAgICAgICAgICAgICAgICAgICAgICAgKiBzaWduLAogICAgICAgICAgICBtICA6IHRvSW50KG1hdGNoW01JTlVURV0pICAgICAgICAgICAgICAgICAgICAgICAqIHNpZ24sCiAgICAgICAgICAgIHMgIDogdG9JbnQobWF0Y2hbU0VDT05EXSkgICAgICAgICAgICAgICAgICAgICAgICogc2lnbiwKICAgICAgICAgICAgbXMgOiB0b0ludChhYnNSb3VuZChtYXRjaFtNSUxMSVNFQ09ORF0gKiAxMDAwKSkgKiBzaWduIC8vIHRoZSBtaWxsaXNlY29uZCBkZWNpbWFsIHBvaW50IGlzIGluY2x1ZGVkIGluIHRoZSBtYXRjaAogICAgICAgIH07CiAgICB9IGVsc2UgaWYgKCEhKG1hdGNoID0gaXNvUmVnZXguZXhlYyhpbnB1dCkpKSB7CiAgICAgICAgc2lnbiA9IChtYXRjaFsxXSA9PT0gJy0nKSA/IC0xIDogKG1hdGNoWzFdID09PSAnKycpID8gMSA6IDE7CiAgICAgICAgZHVyYXRpb24gPSB7CiAgICAgICAgICAgIHkgOiBwYXJzZUlzbyhtYXRjaFsyXSwgc2lnbiksCiAgICAgICAgICAgIE0gOiBwYXJzZUlzbyhtYXRjaFszXSwgc2lnbiksCiAgICAgICAgICAgIHcgOiBwYXJzZUlzbyhtYXRjaFs0XSwgc2lnbiksCiAgICAgICAgICAgIGQgOiBwYXJzZUlzbyhtYXRjaFs1XSwgc2lnbiksCiAgICAgICAgICAgIGggOiBwYXJzZUlzbyhtYXRjaFs2XSwgc2lnbiksCiAgICAgICAgICAgIG0gOiBwYXJzZUlzbyhtYXRjaFs3XSwgc2lnbiksCiAgICAgICAgICAgIHMgOiBwYXJzZUlzbyhtYXRjaFs4XSwgc2lnbikKICAgICAgICB9OwogICAgfSBlbHNlIGlmIChkdXJhdGlvbiA9PSBudWxsKSB7Ly8gY2hlY2tzIGZvciBudWxsIG9yIHVuZGVmaW5lZAogICAgICAgIGR1cmF0aW9uID0ge307CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gJ29iamVjdCcgJiYgKCdmcm9tJyBpbiBkdXJhdGlvbiB8fCAndG8nIGluIGR1cmF0aW9uKSkgewogICAgICAgIGRpZmZSZXMgPSBtb21lbnRzRGlmZmVyZW5jZShjcmVhdGVMb2NhbChkdXJhdGlvbi5mcm9tKSwgY3JlYXRlTG9jYWwoZHVyYXRpb24udG8pKTsKCiAgICAgICAgZHVyYXRpb24gPSB7fTsKICAgICAgICBkdXJhdGlvbi5tcyA9IGRpZmZSZXMubWlsbGlzZWNvbmRzOwogICAgICAgIGR1cmF0aW9uLk0gPSBkaWZmUmVzLm1vbnRoczsKICAgIH0KCiAgICByZXQgPSBuZXcgRHVyYXRpb24oZHVyYXRpb24pOwoKICAgIGlmIChpc0R1cmF0aW9uKGlucHV0KSAmJiBoYXNPd25Qcm9wKGlucHV0LCAnX2xvY2FsZScpKSB7CiAgICAgICAgcmV0Ll9sb2NhbGUgPSBpbnB1dC5fbG9jYWxlOwogICAgfQoKICAgIHJldHVybiByZXQ7Cn0KCmNyZWF0ZUR1cmF0aW9uLmZuID0gRHVyYXRpb24ucHJvdG90eXBlOwpjcmVhdGVEdXJhdGlvbi5pbnZhbGlkID0gY3JlYXRlSW52YWxpZCQxOwoKZnVuY3Rpb24gcGFyc2VJc28gKGlucCwgc2lnbikgewogICAgLy8gV2UnZCBub3JtYWxseSB1c2Ugfn5pbnAgZm9yIHRoaXMsIGJ1dCB1bmZvcnR1bmF0ZWx5IGl0IGFsc28KICAgIC8vIGNvbnZlcnRzIGZsb2F0cyB0byBpbnRzLgogICAgLy8gaW5wIG1heSBiZSB1bmRlZmluZWQsIHNvIGNhcmVmdWwgY2FsbGluZyByZXBsYWNlIG9uIGl0LgogICAgdmFyIHJlcyA9IGlucCAmJiBwYXJzZUZsb2F0KGlucC5yZXBsYWNlKCcsJywgJy4nKSk7CiAgICAvLyBhcHBseSBzaWduIHdoaWxlIHdlJ3JlIGF0IGl0CiAgICByZXR1cm4gKGlzTmFOKHJlcykgPyAwIDogcmVzKSAqIHNpZ247Cn0KCmZ1bmN0aW9uIHBvc2l0aXZlTW9tZW50c0RpZmZlcmVuY2UoYmFzZSwgb3RoZXIpIHsKICAgIHZhciByZXMgPSB7bWlsbGlzZWNvbmRzOiAwLCBtb250aHM6IDB9OwoKICAgIHJlcy5tb250aHMgPSBvdGhlci5tb250aCgpIC0gYmFzZS5tb250aCgpICsKICAgICAgICAob3RoZXIueWVhcigpIC0gYmFzZS55ZWFyKCkpICogMTI7CiAgICBpZiAoYmFzZS5jbG9uZSgpLmFkZChyZXMubW9udGhzLCAnTScpLmlzQWZ0ZXIob3RoZXIpKSB7CiAgICAgICAgLS1yZXMubW9udGhzOwogICAgfQoKICAgIHJlcy5taWxsaXNlY29uZHMgPSArb3RoZXIgLSArKGJhc2UuY2xvbmUoKS5hZGQocmVzLm1vbnRocywgJ00nKSk7CgogICAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gbW9tZW50c0RpZmZlcmVuY2UoYmFzZSwgb3RoZXIpIHsKICAgIHZhciByZXM7CiAgICBpZiAoIShiYXNlLmlzVmFsaWQoKSAmJiBvdGhlci5pc1ZhbGlkKCkpKSB7CiAgICAgICAgcmV0dXJuIHttaWxsaXNlY29uZHM6IDAsIG1vbnRoczogMH07CiAgICB9CgogICAgb3RoZXIgPSBjbG9uZVdpdGhPZmZzZXQob3RoZXIsIGJhc2UpOwogICAgaWYgKGJhc2UuaXNCZWZvcmUob3RoZXIpKSB7CiAgICAgICAgcmVzID0gcG9zaXRpdmVNb21lbnRzRGlmZmVyZW5jZShiYXNlLCBvdGhlcik7CiAgICB9IGVsc2UgewogICAgICAgIHJlcyA9IHBvc2l0aXZlTW9tZW50c0RpZmZlcmVuY2Uob3RoZXIsIGJhc2UpOwogICAgICAgIHJlcy5taWxsaXNlY29uZHMgPSAtcmVzLm1pbGxpc2Vjb25kczsKICAgICAgICByZXMubW9udGhzID0gLXJlcy5tb250aHM7CiAgICB9CgogICAgcmV0dXJuIHJlczsKfQoKLy8gVE9ETzogcmVtb3ZlICduYW1lJyBhcmcgYWZ0ZXIgZGVwcmVjYXRpb24gaXMgcmVtb3ZlZApmdW5jdGlvbiBjcmVhdGVBZGRlcihkaXJlY3Rpb24sIG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAodmFsLCBwZXJpb2QpIHsKICAgICAgICB2YXIgZHVyLCB0bXA7CiAgICAgICAgLy9pbnZlcnQgdGhlIGFyZ3VtZW50cywgYnV0IGNvbXBsYWluIGFib3V0IGl0CiAgICAgICAgaWYgKHBlcmlvZCAhPT0gbnVsbCAmJiAhaXNOYU4oK3BlcmlvZCkpIHsKICAgICAgICAgICAgZGVwcmVjYXRlU2ltcGxlKG5hbWUsICdtb21lbnQoKS4nICsgbmFtZSAgKyAnKHBlcmlvZCwgbnVtYmVyKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIG1vbWVudCgpLicgKyBuYW1lICsgJyhudW1iZXIsIHBlcmlvZCkuICcgKwogICAgICAgICAgICAnU2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZ3VpZGVzLyMvd2FybmluZ3MvYWRkLWludmVydGVkLXBhcmFtLyBmb3IgbW9yZSBpbmZvLicpOwogICAgICAgICAgICB0bXAgPSB2YWw7IHZhbCA9IHBlcmlvZDsgcGVyaW9kID0gdG1wOwogICAgICAgIH0KCiAgICAgICAgdmFsID0gdHlwZW9mIHZhbCA9PT0gJ3N0cmluZycgPyArdmFsIDogdmFsOwogICAgICAgIGR1ciA9IGNyZWF0ZUR1cmF0aW9uKHZhbCwgcGVyaW9kKTsKICAgICAgICBhZGRTdWJ0cmFjdCh0aGlzLCBkdXIsIGRpcmVjdGlvbik7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Owp9CgpmdW5jdGlvbiBhZGRTdWJ0cmFjdCAobW9tLCBkdXJhdGlvbiwgaXNBZGRpbmcsIHVwZGF0ZU9mZnNldCkgewogICAgdmFyIG1pbGxpc2Vjb25kcyA9IGR1cmF0aW9uLl9taWxsaXNlY29uZHMsCiAgICAgICAgZGF5cyA9IGFic1JvdW5kKGR1cmF0aW9uLl9kYXlzKSwKICAgICAgICBtb250aHMgPSBhYnNSb3VuZChkdXJhdGlvbi5fbW9udGhzKTsKCiAgICBpZiAoIW1vbS5pc1ZhbGlkKCkpIHsKICAgICAgICAvLyBObyBvcAogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB1cGRhdGVPZmZzZXQgPSB1cGRhdGVPZmZzZXQgPT0gbnVsbCA/IHRydWUgOiB1cGRhdGVPZmZzZXQ7CgogICAgaWYgKG1vbnRocykgewogICAgICAgIHNldE1vbnRoKG1vbSwgZ2V0KG1vbSwgJ01vbnRoJykgKyBtb250aHMgKiBpc0FkZGluZyk7CiAgICB9CiAgICBpZiAoZGF5cykgewogICAgICAgIHNldCQxKG1vbSwgJ0RhdGUnLCBnZXQobW9tLCAnRGF0ZScpICsgZGF5cyAqIGlzQWRkaW5nKTsKICAgIH0KICAgIGlmIChtaWxsaXNlY29uZHMpIHsKICAgICAgICBtb20uX2Quc2V0VGltZShtb20uX2QudmFsdWVPZigpICsgbWlsbGlzZWNvbmRzICogaXNBZGRpbmcpOwogICAgfQogICAgaWYgKHVwZGF0ZU9mZnNldCkgewogICAgICAgIGhvb2tzLnVwZGF0ZU9mZnNldChtb20sIGRheXMgfHwgbW9udGhzKTsKICAgIH0KfQoKdmFyIGFkZCAgICAgID0gY3JlYXRlQWRkZXIoMSwgJ2FkZCcpOwp2YXIgc3VidHJhY3QgPSBjcmVhdGVBZGRlcigtMSwgJ3N1YnRyYWN0Jyk7CgpmdW5jdGlvbiBnZXRDYWxlbmRhckZvcm1hdChteU1vbWVudCwgbm93KSB7CiAgICB2YXIgZGlmZiA9IG15TW9tZW50LmRpZmYobm93LCAnZGF5cycsIHRydWUpOwogICAgcmV0dXJuIGRpZmYgPCAtNiA/ICdzYW1lRWxzZScgOgogICAgICAgICAgICBkaWZmIDwgLTEgPyAnbGFzdFdlZWsnIDoKICAgICAgICAgICAgZGlmZiA8IDAgPyAnbGFzdERheScgOgogICAgICAgICAgICBkaWZmIDwgMSA/ICdzYW1lRGF5JyA6CiAgICAgICAgICAgIGRpZmYgPCAyID8gJ25leHREYXknIDoKICAgICAgICAgICAgZGlmZiA8IDcgPyAnbmV4dFdlZWsnIDogJ3NhbWVFbHNlJzsKfQoKZnVuY3Rpb24gY2FsZW5kYXIkMSAodGltZSwgZm9ybWF0cykgewogICAgLy8gV2Ugd2FudCB0byBjb21wYXJlIHRoZSBzdGFydCBvZiB0b2RheSwgdnMgdGhpcy4KICAgIC8vIEdldHRpbmcgc3RhcnQtb2YtdG9kYXkgZGVwZW5kcyBvbiB3aGV0aGVyIHdlJ3JlIGxvY2FsL3V0Yy9vZmZzZXQgb3Igbm90LgogICAgdmFyIG5vdyA9IHRpbWUgfHwgY3JlYXRlTG9jYWwoKSwKICAgICAgICBzb2QgPSBjbG9uZVdpdGhPZmZzZXQobm93LCB0aGlzKS5zdGFydE9mKCdkYXknKSwKICAgICAgICBmb3JtYXQgPSBob29rcy5jYWxlbmRhckZvcm1hdCh0aGlzLCBzb2QpIHx8ICdzYW1lRWxzZSc7CgogICAgdmFyIG91dHB1dCA9IGZvcm1hdHMgJiYgKGlzRnVuY3Rpb24oZm9ybWF0c1tmb3JtYXRdKSA/IGZvcm1hdHNbZm9ybWF0XS5jYWxsKHRoaXMsIG5vdykgOiBmb3JtYXRzW2Zvcm1hdF0pOwoKICAgIHJldHVybiB0aGlzLmZvcm1hdChvdXRwdXQgfHwgdGhpcy5sb2NhbGVEYXRhKCkuY2FsZW5kYXIoZm9ybWF0LCB0aGlzLCBjcmVhdGVMb2NhbChub3cpKSk7Cn0KCmZ1bmN0aW9uIGNsb25lICgpIHsKICAgIHJldHVybiBuZXcgTW9tZW50KHRoaXMpOwp9CgpmdW5jdGlvbiBpc0FmdGVyIChpbnB1dCwgdW5pdHMpIHsKICAgIHZhciBsb2NhbElucHV0ID0gaXNNb21lbnQoaW5wdXQpID8gaW5wdXQgOiBjcmVhdGVMb2NhbChpbnB1dCk7CiAgICBpZiAoISh0aGlzLmlzVmFsaWQoKSAmJiBsb2NhbElucHV0LmlzVmFsaWQoKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKCFpc1VuZGVmaW5lZCh1bml0cykgPyB1bml0cyA6ICdtaWxsaXNlY29uZCcpOwogICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVPZigpID4gbG9jYWxJbnB1dC52YWx1ZU9mKCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBsb2NhbElucHV0LnZhbHVlT2YoKSA8IHRoaXMuY2xvbmUoKS5zdGFydE9mKHVuaXRzKS52YWx1ZU9mKCk7CiAgICB9Cn0KCmZ1bmN0aW9uIGlzQmVmb3JlIChpbnB1dCwgdW5pdHMpIHsKICAgIHZhciBsb2NhbElucHV0ID0gaXNNb21lbnQoaW5wdXQpID8gaW5wdXQgOiBjcmVhdGVMb2NhbChpbnB1dCk7CiAgICBpZiAoISh0aGlzLmlzVmFsaWQoKSAmJiBsb2NhbElucHV0LmlzVmFsaWQoKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKCFpc1VuZGVmaW5lZCh1bml0cykgPyB1bml0cyA6ICdtaWxsaXNlY29uZCcpOwogICAgaWYgKHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVPZigpIDwgbG9jYWxJbnB1dC52YWx1ZU9mKCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmNsb25lKCkuZW5kT2YodW5pdHMpLnZhbHVlT2YoKSA8IGxvY2FsSW5wdXQudmFsdWVPZigpOwogICAgfQp9CgpmdW5jdGlvbiBpc0JldHdlZW4gKGZyb20sIHRvLCB1bml0cywgaW5jbHVzaXZpdHkpIHsKICAgIGluY2x1c2l2aXR5ID0gaW5jbHVzaXZpdHkgfHwgJygpJzsKICAgIHJldHVybiAoaW5jbHVzaXZpdHlbMF0gPT09ICcoJyA/IHRoaXMuaXNBZnRlcihmcm9tLCB1bml0cykgOiAhdGhpcy5pc0JlZm9yZShmcm9tLCB1bml0cykpICYmCiAgICAgICAgKGluY2x1c2l2aXR5WzFdID09PSAnKScgPyB0aGlzLmlzQmVmb3JlKHRvLCB1bml0cykgOiAhdGhpcy5pc0FmdGVyKHRvLCB1bml0cykpOwp9CgpmdW5jdGlvbiBpc1NhbWUgKGlucHV0LCB1bml0cykgewogICAgdmFyIGxvY2FsSW5wdXQgPSBpc01vbWVudChpbnB1dCkgPyBpbnB1dCA6IGNyZWF0ZUxvY2FsKGlucHV0KSwKICAgICAgICBpbnB1dE1zOwogICAgaWYgKCEodGhpcy5pc1ZhbGlkKCkgJiYgbG9jYWxJbnB1dC5pc1ZhbGlkKCkpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyB8fCAnbWlsbGlzZWNvbmQnKTsKICAgIGlmICh1bml0cyA9PT0gJ21pbGxpc2Vjb25kJykgewogICAgICAgIHJldHVybiB0aGlzLnZhbHVlT2YoKSA9PT0gbG9jYWxJbnB1dC52YWx1ZU9mKCk7CiAgICB9IGVsc2UgewogICAgICAgIGlucHV0TXMgPSBsb2NhbElucHV0LnZhbHVlT2YoKTsKICAgICAgICByZXR1cm4gdGhpcy5jbG9uZSgpLnN0YXJ0T2YodW5pdHMpLnZhbHVlT2YoKSA8PSBpbnB1dE1zICYmIGlucHV0TXMgPD0gdGhpcy5jbG9uZSgpLmVuZE9mKHVuaXRzKS52YWx1ZU9mKCk7CiAgICB9Cn0KCmZ1bmN0aW9uIGlzU2FtZU9yQWZ0ZXIgKGlucHV0LCB1bml0cykgewogICAgcmV0dXJuIHRoaXMuaXNTYW1lKGlucHV0LCB1bml0cykgfHwgdGhpcy5pc0FmdGVyKGlucHV0LHVuaXRzKTsKfQoKZnVuY3Rpb24gaXNTYW1lT3JCZWZvcmUgKGlucHV0LCB1bml0cykgewogICAgcmV0dXJuIHRoaXMuaXNTYW1lKGlucHV0LCB1bml0cykgfHwgdGhpcy5pc0JlZm9yZShpbnB1dCx1bml0cyk7Cn0KCmZ1bmN0aW9uIGRpZmYgKGlucHV0LCB1bml0cywgYXNGbG9hdCkgewogICAgdmFyIHRoYXQsCiAgICAgICAgem9uZURlbHRhLAogICAgICAgIGRlbHRhLCBvdXRwdXQ7CgogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiBOYU47CiAgICB9CgogICAgdGhhdCA9IGNsb25lV2l0aE9mZnNldChpbnB1dCwgdGhpcyk7CgogICAgaWYgKCF0aGF0LmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiBOYU47CiAgICB9CgogICAgem9uZURlbHRhID0gKHRoYXQudXRjT2Zmc2V0KCkgLSB0aGlzLnV0Y09mZnNldCgpKSAqIDZlNDsKCiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKCiAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgY2FzZSAneWVhcic6IG91dHB1dCA9IG1vbnRoRGlmZih0aGlzLCB0aGF0KSAvIDEyOyBicmVhazsKICAgICAgICBjYXNlICdtb250aCc6IG91dHB1dCA9IG1vbnRoRGlmZih0aGlzLCB0aGF0KTsgYnJlYWs7CiAgICAgICAgY2FzZSAncXVhcnRlcic6IG91dHB1dCA9IG1vbnRoRGlmZih0aGlzLCB0aGF0KSAvIDM7IGJyZWFrOwogICAgICAgIGNhc2UgJ3NlY29uZCc6IG91dHB1dCA9ICh0aGlzIC0gdGhhdCkgLyAxZTM7IGJyZWFrOyAvLyAxMDAwCiAgICAgICAgY2FzZSAnbWludXRlJzogb3V0cHV0ID0gKHRoaXMgLSB0aGF0KSAvIDZlNDsgYnJlYWs7IC8vIDEwMDAgKiA2MAogICAgICAgIGNhc2UgJ2hvdXInOiBvdXRwdXQgPSAodGhpcyAtIHRoYXQpIC8gMzZlNTsgYnJlYWs7IC8vIDEwMDAgKiA2MCAqIDYwCiAgICAgICAgY2FzZSAnZGF5Jzogb3V0cHV0ID0gKHRoaXMgLSB0aGF0IC0gem9uZURlbHRhKSAvIDg2NGU1OyBicmVhazsgLy8gMTAwMCAqIDYwICogNjAgKiAyNCwgbmVnYXRlIGRzdAogICAgICAgIGNhc2UgJ3dlZWsnOiBvdXRwdXQgPSAodGhpcyAtIHRoYXQgLSB6b25lRGVsdGEpIC8gNjA0OGU1OyBicmVhazsgLy8gMTAwMCAqIDYwICogNjAgKiAyNCAqIDcsIG5lZ2F0ZSBkc3QKICAgICAgICBkZWZhdWx0OiBvdXRwdXQgPSB0aGlzIC0gdGhhdDsKICAgIH0KCiAgICByZXR1cm4gYXNGbG9hdCA/IG91dHB1dCA6IGFic0Zsb29yKG91dHB1dCk7Cn0KCmZ1bmN0aW9uIG1vbnRoRGlmZiAoYSwgYikgewogICAgLy8gZGlmZmVyZW5jZSBpbiBtb250aHMKICAgIHZhciB3aG9sZU1vbnRoRGlmZiA9ICgoYi55ZWFyKCkgLSBhLnllYXIoKSkgKiAxMikgKyAoYi5tb250aCgpIC0gYS5tb250aCgpKSwKICAgICAgICAvLyBiIGlzIGluIChhbmNob3IgLSAxIG1vbnRoLCBhbmNob3IgKyAxIG1vbnRoKQogICAgICAgIGFuY2hvciA9IGEuY2xvbmUoKS5hZGQod2hvbGVNb250aERpZmYsICdtb250aHMnKSwKICAgICAgICBhbmNob3IyLCBhZGp1c3Q7CgogICAgaWYgKGIgLSBhbmNob3IgPCAwKSB7CiAgICAgICAgYW5jaG9yMiA9IGEuY2xvbmUoKS5hZGQod2hvbGVNb250aERpZmYgLSAxLCAnbW9udGhzJyk7CiAgICAgICAgLy8gbGluZWFyIGFjcm9zcyB0aGUgbW9udGgKICAgICAgICBhZGp1c3QgPSAoYiAtIGFuY2hvcikgLyAoYW5jaG9yIC0gYW5jaG9yMik7CiAgICB9IGVsc2UgewogICAgICAgIGFuY2hvcjIgPSBhLmNsb25lKCkuYWRkKHdob2xlTW9udGhEaWZmICsgMSwgJ21vbnRocycpOwogICAgICAgIC8vIGxpbmVhciBhY3Jvc3MgdGhlIG1vbnRoCiAgICAgICAgYWRqdXN0ID0gKGIgLSBhbmNob3IpIC8gKGFuY2hvcjIgLSBhbmNob3IpOwogICAgfQoKICAgIC8vY2hlY2sgZm9yIG5lZ2F0aXZlIHplcm8sIHJldHVybiB6ZXJvIGlmIG5lZ2F0aXZlIHplcm8KICAgIHJldHVybiAtKHdob2xlTW9udGhEaWZmICsgYWRqdXN0KSB8fCAwOwp9Cgpob29rcy5kZWZhdWx0Rm9ybWF0ID0gJ1lZWVktTU0tRERUSEg6bW06c3NaJzsKaG9va3MuZGVmYXVsdEZvcm1hdFV0YyA9ICdZWVlZLU1NLUREVEhIOm1tOnNzW1pdJzsKCmZ1bmN0aW9uIHRvU3RyaW5nICgpIHsKICAgIHJldHVybiB0aGlzLmNsb25lKCkubG9jYWxlKCdlbicpLmZvcm1hdCgnZGRkIE1NTSBERCBZWVlZIEhIOm1tOnNzIFtHTVRdWlonKTsKfQoKZnVuY3Rpb24gdG9JU09TdHJpbmcoa2VlcE9mZnNldCkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIHV0YyA9IGtlZXBPZmZzZXQgIT09IHRydWU7CiAgICB2YXIgbSA9IHV0YyA/IHRoaXMuY2xvbmUoKS51dGMoKSA6IHRoaXM7CiAgICBpZiAobS55ZWFyKCkgPCAwIHx8IG0ueWVhcigpID4gOTk5OSkgewogICAgICAgIHJldHVybiBmb3JtYXRNb21lbnQobSwgdXRjID8gJ1lZWVlZWS1NTS1ERFtUXUhIOm1tOnNzLlNTU1taXScgOiAnWVlZWVlZLU1NLUREW1RdSEg6bW06c3MuU1NTWicpOwogICAgfQogICAgaWYgKGlzRnVuY3Rpb24oRGF0ZS5wcm90b3R5cGUudG9JU09TdHJpbmcpKSB7CiAgICAgICAgLy8gbmF0aXZlIGltcGxlbWVudGF0aW9uIGlzIH41MHggZmFzdGVyLCB1c2UgaXQgd2hlbiB3ZSBjYW4KICAgICAgICBpZiAodXRjKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvRGF0ZSgpLnRvSVNPU3RyaW5nKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRoaXMuX2QudmFsdWVPZigpKS50b0lTT1N0cmluZygpLnJlcGxhY2UoJ1onLCBmb3JtYXRNb21lbnQobSwgJ1onKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGZvcm1hdE1vbWVudChtLCB1dGMgPyAnWVlZWS1NTS1ERFtUXUhIOm1tOnNzLlNTU1taXScgOiAnWVlZWS1NTS1ERFtUXUhIOm1tOnNzLlNTU1onKTsKfQoKLyoqCiAqIFJldHVybiBhIGh1bWFuIHJlYWRhYmxlIHJlcHJlc2VudGF0aW9uIG9mIGEgbW9tZW50IHRoYXQgY2FuCiAqIGFsc28gYmUgZXZhbHVhdGVkIHRvIGdldCBhIG5ldyBtb21lbnQgd2hpY2ggaXMgdGhlIHNhbWUKICoKICogQGxpbmsgaHR0cHM6Ly9ub2RlanMub3JnL2Rpc3QvbGF0ZXN0L2RvY3MvYXBpL3V0aWwuaHRtbCN1dGlsX2N1c3RvbV9pbnNwZWN0X2Z1bmN0aW9uX29uX29iamVjdHMKICovCmZ1bmN0aW9uIGluc3BlY3QgKCkgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiAnbW9tZW50LmludmFsaWQoLyogJyArIHRoaXMuX2kgKyAnICovKSc7CiAgICB9CiAgICB2YXIgZnVuYyA9ICdtb21lbnQnOwogICAgdmFyIHpvbmUgPSAnJzsKICAgIGlmICghdGhpcy5pc0xvY2FsKCkpIHsKICAgICAgICBmdW5jID0gdGhpcy51dGNPZmZzZXQoKSA9PT0gMCA/ICdtb21lbnQudXRjJyA6ICdtb21lbnQucGFyc2Vab25lJzsKICAgICAgICB6b25lID0gJ1onOwogICAgfQogICAgdmFyIHByZWZpeCA9ICdbJyArIGZ1bmMgKyAnKCJdJzsKICAgIHZhciB5ZWFyID0gKDAgPD0gdGhpcy55ZWFyKCkgJiYgdGhpcy55ZWFyKCkgPD0gOTk5OSkgPyAnWVlZWScgOiAnWVlZWVlZJzsKICAgIHZhciBkYXRldGltZSA9ICctTU0tRERbVF1ISDptbTpzcy5TU1MnOwogICAgdmFyIHN1ZmZpeCA9IHpvbmUgKyAnWyIpXSc7CgogICAgcmV0dXJuIHRoaXMuZm9ybWF0KHByZWZpeCArIHllYXIgKyBkYXRldGltZSArIHN1ZmZpeCk7Cn0KCmZ1bmN0aW9uIGZvcm1hdCAoaW5wdXRTdHJpbmcpIHsKICAgIGlmICghaW5wdXRTdHJpbmcpIHsKICAgICAgICBpbnB1dFN0cmluZyA9IHRoaXMuaXNVdGMoKSA/IGhvb2tzLmRlZmF1bHRGb3JtYXRVdGMgOiBob29rcy5kZWZhdWx0Rm9ybWF0OwogICAgfQogICAgdmFyIG91dHB1dCA9IGZvcm1hdE1vbWVudCh0aGlzLCBpbnB1dFN0cmluZyk7CiAgICByZXR1cm4gdGhpcy5sb2NhbGVEYXRhKCkucG9zdGZvcm1hdChvdXRwdXQpOwp9CgpmdW5jdGlvbiBmcm9tICh0aW1lLCB3aXRob3V0U3VmZml4KSB7CiAgICBpZiAodGhpcy5pc1ZhbGlkKCkgJiYKICAgICAgICAgICAgKChpc01vbWVudCh0aW1lKSAmJiB0aW1lLmlzVmFsaWQoKSkgfHwKICAgICAgICAgICAgIGNyZWF0ZUxvY2FsKHRpbWUpLmlzVmFsaWQoKSkpIHsKICAgICAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oe3RvOiB0aGlzLCBmcm9tOiB0aW1lfSkubG9jYWxlKHRoaXMubG9jYWxlKCkpLmh1bWFuaXplKCF3aXRob3V0U3VmZml4KTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9Cn0KCmZ1bmN0aW9uIGZyb21Ob3cgKHdpdGhvdXRTdWZmaXgpIHsKICAgIHJldHVybiB0aGlzLmZyb20oY3JlYXRlTG9jYWwoKSwgd2l0aG91dFN1ZmZpeCk7Cn0KCmZ1bmN0aW9uIHRvICh0aW1lLCB3aXRob3V0U3VmZml4KSB7CiAgICBpZiAodGhpcy5pc1ZhbGlkKCkgJiYKICAgICAgICAgICAgKChpc01vbWVudCh0aW1lKSAmJiB0aW1lLmlzVmFsaWQoKSkgfHwKICAgICAgICAgICAgIGNyZWF0ZUxvY2FsKHRpbWUpLmlzVmFsaWQoKSkpIHsKICAgICAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24oe2Zyb206IHRoaXMsIHRvOiB0aW1lfSkubG9jYWxlKHRoaXMubG9jYWxlKCkpLmh1bWFuaXplKCF3aXRob3V0U3VmZml4KTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9Cn0KCmZ1bmN0aW9uIHRvTm93ICh3aXRob3V0U3VmZml4KSB7CiAgICByZXR1cm4gdGhpcy50byhjcmVhdGVMb2NhbCgpLCB3aXRob3V0U3VmZml4KTsKfQoKLy8gSWYgcGFzc2VkIGEgbG9jYWxlIGtleSwgaXQgd2lsbCBzZXQgdGhlIGxvY2FsZSBmb3IgdGhpcwovLyBpbnN0YW5jZS4gIE90aGVyd2lzZSwgaXQgd2lsbCByZXR1cm4gdGhlIGxvY2FsZSBjb25maWd1cmF0aW9uCi8vIHZhcmlhYmxlcyBmb3IgdGhpcyBpbnN0YW5jZS4KZnVuY3Rpb24gbG9jYWxlIChrZXkpIHsKICAgIHZhciBuZXdMb2NhbGVEYXRhOwoKICAgIGlmIChrZXkgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0aGlzLl9sb2NhbGUuX2FiYnI7CiAgICB9IGVsc2UgewogICAgICAgIG5ld0xvY2FsZURhdGEgPSBnZXRMb2NhbGUoa2V5KTsKICAgICAgICBpZiAobmV3TG9jYWxlRGF0YSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2xvY2FsZSA9IG5ld0xvY2FsZURhdGE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQp9Cgp2YXIgbGFuZyA9IGRlcHJlY2F0ZSgKICAgICdtb21lbnQoKS5sYW5nKCkgaXMgZGVwcmVjYXRlZC4gSW5zdGVhZCwgdXNlIG1vbWVudCgpLmxvY2FsZURhdGEoKSB0byBnZXQgdGhlIGxhbmd1YWdlIGNvbmZpZ3VyYXRpb24uIFVzZSBtb21lbnQoKS5sb2NhbGUoKSB0byBjaGFuZ2UgbGFuZ3VhZ2VzLicsCiAgICBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGUoa2V5KTsKICAgICAgICB9CiAgICB9Cik7CgpmdW5jdGlvbiBsb2NhbGVEYXRhICgpIHsKICAgIHJldHVybiB0aGlzLl9sb2NhbGU7Cn0KCmZ1bmN0aW9uIHN0YXJ0T2YgKHVuaXRzKSB7CiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgIC8vIHRoZSBmb2xsb3dpbmcgc3dpdGNoIGludGVudGlvbmFsbHkgb21pdHMgYnJlYWsga2V5d29yZHMKICAgIC8vIHRvIHV0aWxpemUgZmFsbGluZyB0aHJvdWdoIHRoZSBjYXNlcy4KICAgIHN3aXRjaCAodW5pdHMpIHsKICAgICAgICBjYXNlICd5ZWFyJzoKICAgICAgICAgICAgdGhpcy5tb250aCgwKTsKICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ3F1YXJ0ZXInOgogICAgICAgIGNhc2UgJ21vbnRoJzoKICAgICAgICAgICAgdGhpcy5kYXRlKDEpOwogICAgICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCiAgICAgICAgY2FzZSAnd2Vlayc6CiAgICAgICAgY2FzZSAnaXNvV2Vlayc6CiAgICAgICAgY2FzZSAnZGF5JzoKICAgICAgICBjYXNlICdkYXRlJzoKICAgICAgICAgICAgdGhpcy5ob3VycygwKTsKICAgICAgICAgICAgLyogZmFsbHMgdGhyb3VnaCAqLwogICAgICAgIGNhc2UgJ2hvdXInOgogICAgICAgICAgICB0aGlzLm1pbnV0ZXMoMCk7CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdtaW51dGUnOgogICAgICAgICAgICB0aGlzLnNlY29uZHMoMCk7CiAgICAgICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KICAgICAgICBjYXNlICdzZWNvbmQnOgogICAgICAgICAgICB0aGlzLm1pbGxpc2Vjb25kcygwKTsKICAgIH0KCiAgICAvLyB3ZWVrcyBhcmUgYSBzcGVjaWFsIGNhc2UKICAgIGlmICh1bml0cyA9PT0gJ3dlZWsnKSB7CiAgICAgICAgdGhpcy53ZWVrZGF5KDApOwogICAgfQogICAgaWYgKHVuaXRzID09PSAnaXNvV2VlaycpIHsKICAgICAgICB0aGlzLmlzb1dlZWtkYXkoMSk7CiAgICB9CgogICAgLy8gcXVhcnRlcnMgYXJlIGFsc28gc3BlY2lhbAogICAgaWYgKHVuaXRzID09PSAncXVhcnRlcicpIHsKICAgICAgICB0aGlzLm1vbnRoKE1hdGguZmxvb3IodGhpcy5tb250aCgpIC8gMykgKiAzKTsKICAgIH0KCiAgICByZXR1cm4gdGhpczsKfQoKZnVuY3Rpb24gZW5kT2YgKHVuaXRzKSB7CiAgICB1bml0cyA9IG5vcm1hbGl6ZVVuaXRzKHVuaXRzKTsKICAgIGlmICh1bml0cyA9PT0gdW5kZWZpbmVkIHx8IHVuaXRzID09PSAnbWlsbGlzZWNvbmQnKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLy8gJ2RhdGUnIGlzIGFuIGFsaWFzIGZvciAnZGF5Jywgc28gaXQgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYXMgc3VjaC4KICAgIGlmICh1bml0cyA9PT0gJ2RhdGUnKSB7CiAgICAgICAgdW5pdHMgPSAnZGF5JzsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5zdGFydE9mKHVuaXRzKS5hZGQoMSwgKHVuaXRzID09PSAnaXNvV2VlaycgPyAnd2VlaycgOiB1bml0cykpLnN1YnRyYWN0KDEsICdtcycpOwp9CgpmdW5jdGlvbiB2YWx1ZU9mICgpIHsKICAgIHJldHVybiB0aGlzLl9kLnZhbHVlT2YoKSAtICgodGhpcy5fb2Zmc2V0IHx8IDApICogNjAwMDApOwp9CgpmdW5jdGlvbiB1bml4ICgpIHsKICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMudmFsdWVPZigpIC8gMTAwMCk7Cn0KCmZ1bmN0aW9uIHRvRGF0ZSAoKSB7CiAgICByZXR1cm4gbmV3IERhdGUodGhpcy52YWx1ZU9mKCkpOwp9CgpmdW5jdGlvbiB0b0FycmF5ICgpIHsKICAgIHZhciBtID0gdGhpczsKICAgIHJldHVybiBbbS55ZWFyKCksIG0ubW9udGgoKSwgbS5kYXRlKCksIG0uaG91cigpLCBtLm1pbnV0ZSgpLCBtLnNlY29uZCgpLCBtLm1pbGxpc2Vjb25kKCldOwp9CgpmdW5jdGlvbiB0b09iamVjdCAoKSB7CiAgICB2YXIgbSA9IHRoaXM7CiAgICByZXR1cm4gewogICAgICAgIHllYXJzOiBtLnllYXIoKSwKICAgICAgICBtb250aHM6IG0ubW9udGgoKSwKICAgICAgICBkYXRlOiBtLmRhdGUoKSwKICAgICAgICBob3VyczogbS5ob3VycygpLAogICAgICAgIG1pbnV0ZXM6IG0ubWludXRlcygpLAogICAgICAgIHNlY29uZHM6IG0uc2Vjb25kcygpLAogICAgICAgIG1pbGxpc2Vjb25kczogbS5taWxsaXNlY29uZHMoKQogICAgfTsKfQoKZnVuY3Rpb24gdG9KU09OICgpIHsKICAgIC8vIG5ldyBEYXRlKE5hTikudG9KU09OKCkgPT09IG51bGwKICAgIHJldHVybiB0aGlzLmlzVmFsaWQoKSA/IHRoaXMudG9JU09TdHJpbmcoKSA6IG51bGw7Cn0KCmZ1bmN0aW9uIGlzVmFsaWQkMiAoKSB7CiAgICByZXR1cm4gaXNWYWxpZCh0aGlzKTsKfQoKZnVuY3Rpb24gcGFyc2luZ0ZsYWdzICgpIHsKICAgIHJldHVybiBleHRlbmQoe30sIGdldFBhcnNpbmdGbGFncyh0aGlzKSk7Cn0KCmZ1bmN0aW9uIGludmFsaWRBdCAoKSB7CiAgICByZXR1cm4gZ2V0UGFyc2luZ0ZsYWdzKHRoaXMpLm92ZXJmbG93Owp9CgpmdW5jdGlvbiBjcmVhdGlvbkRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICAgIGlucHV0OiB0aGlzLl9pLAogICAgICAgIGZvcm1hdDogdGhpcy5fZiwKICAgICAgICBsb2NhbGU6IHRoaXMuX2xvY2FsZSwKICAgICAgICBpc1VUQzogdGhpcy5faXNVVEMsCiAgICAgICAgc3RyaWN0OiB0aGlzLl9zdHJpY3QKICAgIH07Cn0KCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKDAsIFsnZ2cnLCAyXSwgMCwgZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMud2Vla1llYXIoKSAlIDEwMDsKfSk7CgphZGRGb3JtYXRUb2tlbigwLCBbJ0dHJywgMl0sIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLmlzb1dlZWtZZWFyKCkgJSAxMDA7Cn0pOwoKZnVuY3Rpb24gYWRkV2Vla1llYXJGb3JtYXRUb2tlbiAodG9rZW4sIGdldHRlcikgewogICAgYWRkRm9ybWF0VG9rZW4oMCwgW3Rva2VuLCB0b2tlbi5sZW5ndGhdLCAwLCBnZXR0ZXIpOwp9CgphZGRXZWVrWWVhckZvcm1hdFRva2VuKCdnZ2dnJywgICAgICd3ZWVrWWVhcicpOwphZGRXZWVrWWVhckZvcm1hdFRva2VuKCdnZ2dnZycsICAgICd3ZWVrWWVhcicpOwphZGRXZWVrWWVhckZvcm1hdFRva2VuKCdHR0dHJywgICdpc29XZWVrWWVhcicpOwphZGRXZWVrWWVhckZvcm1hdFRva2VuKCdHR0dHRycsICdpc29XZWVrWWVhcicpOwoKLy8gQUxJQVNFUwoKYWRkVW5pdEFsaWFzKCd3ZWVrWWVhcicsICdnZycpOwphZGRVbml0QWxpYXMoJ2lzb1dlZWtZZWFyJywgJ0dHJyk7CgovLyBQUklPUklUWQoKYWRkVW5pdFByaW9yaXR5KCd3ZWVrWWVhcicsIDEpOwphZGRVbml0UHJpb3JpdHkoJ2lzb1dlZWtZZWFyJywgMSk7CgoKLy8gUEFSU0lORwoKYWRkUmVnZXhUb2tlbignRycsICAgICAgbWF0Y2hTaWduZWQpOwphZGRSZWdleFRva2VuKCdnJywgICAgICBtYXRjaFNpZ25lZCk7CmFkZFJlZ2V4VG9rZW4oJ0dHJywgICAgIG1hdGNoMXRvMiwgbWF0Y2gyKTsKYWRkUmVnZXhUb2tlbignZ2cnLCAgICAgbWF0Y2gxdG8yLCBtYXRjaDIpOwphZGRSZWdleFRva2VuKCdHR0dHJywgICBtYXRjaDF0bzQsIG1hdGNoNCk7CmFkZFJlZ2V4VG9rZW4oJ2dnZ2cnLCAgIG1hdGNoMXRvNCwgbWF0Y2g0KTsKYWRkUmVnZXhUb2tlbignR0dHR0cnLCAgbWF0Y2gxdG82LCBtYXRjaDYpOwphZGRSZWdleFRva2VuKCdnZ2dnZycsICBtYXRjaDF0bzYsIG1hdGNoNik7CgphZGRXZWVrUGFyc2VUb2tlbihbJ2dnZ2cnLCAnZ2dnZ2cnLCAnR0dHRycsICdHR0dHRyddLCBmdW5jdGlvbiAoaW5wdXQsIHdlZWssIGNvbmZpZywgdG9rZW4pIHsKICAgIHdlZWtbdG9rZW4uc3Vic3RyKDAsIDIpXSA9IHRvSW50KGlucHV0KTsKfSk7CgphZGRXZWVrUGFyc2VUb2tlbihbJ2dnJywgJ0dHJ10sIGZ1bmN0aW9uIChpbnB1dCwgd2VlaywgY29uZmlnLCB0b2tlbikgewogICAgd2Vla1t0b2tlbl0gPSBob29rcy5wYXJzZVR3b0RpZ2l0WWVhcihpbnB1dCk7Cn0pOwoKLy8gTU9NRU5UUwoKZnVuY3Rpb24gZ2V0U2V0V2Vla1llYXIgKGlucHV0KSB7CiAgICByZXR1cm4gZ2V0U2V0V2Vla1llYXJIZWxwZXIuY2FsbCh0aGlzLAogICAgICAgICAgICBpbnB1dCwKICAgICAgICAgICAgdGhpcy53ZWVrKCksCiAgICAgICAgICAgIHRoaXMud2Vla2RheSgpLAogICAgICAgICAgICB0aGlzLmxvY2FsZURhdGEoKS5fd2Vlay5kb3csCiAgICAgICAgICAgIHRoaXMubG9jYWxlRGF0YSgpLl93ZWVrLmRveSk7Cn0KCmZ1bmN0aW9uIGdldFNldElTT1dlZWtZZWFyIChpbnB1dCkgewogICAgcmV0dXJuIGdldFNldFdlZWtZZWFySGVscGVyLmNhbGwodGhpcywKICAgICAgICAgICAgaW5wdXQsIHRoaXMuaXNvV2VlaygpLCB0aGlzLmlzb1dlZWtkYXkoKSwgMSwgNCk7Cn0KCmZ1bmN0aW9uIGdldElTT1dlZWtzSW5ZZWFyICgpIHsKICAgIHJldHVybiB3ZWVrc0luWWVhcih0aGlzLnllYXIoKSwgMSwgNCk7Cn0KCmZ1bmN0aW9uIGdldFdlZWtzSW5ZZWFyICgpIHsKICAgIHZhciB3ZWVrSW5mbyA9IHRoaXMubG9jYWxlRGF0YSgpLl93ZWVrOwogICAgcmV0dXJuIHdlZWtzSW5ZZWFyKHRoaXMueWVhcigpLCB3ZWVrSW5mby5kb3csIHdlZWtJbmZvLmRveSk7Cn0KCmZ1bmN0aW9uIGdldFNldFdlZWtZZWFySGVscGVyKGlucHV0LCB3ZWVrLCB3ZWVrZGF5LCBkb3csIGRveSkgewogICAgdmFyIHdlZWtzVGFyZ2V0OwogICAgaWYgKGlucHV0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4gd2Vla09mWWVhcih0aGlzLCBkb3csIGRveSkueWVhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgd2Vla3NUYXJnZXQgPSB3ZWVrc0luWWVhcihpbnB1dCwgZG93LCBkb3kpOwogICAgICAgIGlmICh3ZWVrID4gd2Vla3NUYXJnZXQpIHsKICAgICAgICAgICAgd2VlayA9IHdlZWtzVGFyZ2V0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0V2Vla0FsbC5jYWxsKHRoaXMsIGlucHV0LCB3ZWVrLCB3ZWVrZGF5LCBkb3csIGRveSk7CiAgICB9Cn0KCmZ1bmN0aW9uIHNldFdlZWtBbGwod2Vla1llYXIsIHdlZWssIHdlZWtkYXksIGRvdywgZG95KSB7CiAgICB2YXIgZGF5T2ZZZWFyRGF0YSA9IGRheU9mWWVhckZyb21XZWVrcyh3ZWVrWWVhciwgd2Vlaywgd2Vla2RheSwgZG93LCBkb3kpLAogICAgICAgIGRhdGUgPSBjcmVhdGVVVENEYXRlKGRheU9mWWVhckRhdGEueWVhciwgMCwgZGF5T2ZZZWFyRGF0YS5kYXlPZlllYXIpOwoKICAgIHRoaXMueWVhcihkYXRlLmdldFVUQ0Z1bGxZZWFyKCkpOwogICAgdGhpcy5tb250aChkYXRlLmdldFVUQ01vbnRoKCkpOwogICAgdGhpcy5kYXRlKGRhdGUuZ2V0VVRDRGF0ZSgpKTsKICAgIHJldHVybiB0aGlzOwp9CgovLyBGT1JNQVRUSU5HCgphZGRGb3JtYXRUb2tlbignUScsIDAsICdRbycsICdxdWFydGVyJyk7CgovLyBBTElBU0VTCgphZGRVbml0QWxpYXMoJ3F1YXJ0ZXInLCAnUScpOwoKLy8gUFJJT1JJVFkKCmFkZFVuaXRQcmlvcml0eSgncXVhcnRlcicsIDcpOwoKLy8gUEFSU0lORwoKYWRkUmVnZXhUb2tlbignUScsIG1hdGNoMSk7CmFkZFBhcnNlVG9rZW4oJ1EnLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5KSB7CiAgICBhcnJheVtNT05USF0gPSAodG9JbnQoaW5wdXQpIC0gMSkgKiAzOwp9KTsKCi8vIE1PTUVOVFMKCmZ1bmN0aW9uIGdldFNldFF1YXJ0ZXIgKGlucHV0KSB7CiAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IE1hdGguY2VpbCgodGhpcy5tb250aCgpICsgMSkgLyAzKSA6IHRoaXMubW9udGgoKGlucHV0IC0gMSkgKiAzICsgdGhpcy5tb250aCgpICUgMyk7Cn0KCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKCdEJywgWydERCcsIDJdLCAnRG8nLCAnZGF0ZScpOwoKLy8gQUxJQVNFUwoKYWRkVW5pdEFsaWFzKCdkYXRlJywgJ0QnKTsKCi8vIFBSSU9ST0lUWQphZGRVbml0UHJpb3JpdHkoJ2RhdGUnLCA5KTsKCi8vIFBBUlNJTkcKCmFkZFJlZ2V4VG9rZW4oJ0QnLCAgbWF0Y2gxdG8yKTsKYWRkUmVnZXhUb2tlbignREQnLCBtYXRjaDF0bzIsIG1hdGNoMik7CmFkZFJlZ2V4VG9rZW4oJ0RvJywgZnVuY3Rpb24gKGlzU3RyaWN0LCBsb2NhbGUpIHsKICAgIC8vIFRPRE86IFJlbW92ZSAib3JkaW5hbFBhcnNlIiBmYWxsYmFjayBpbiBuZXh0IG1ham9yIHJlbGVhc2UuCiAgICByZXR1cm4gaXNTdHJpY3QgPwogICAgICAobG9jYWxlLl9kYXlPZk1vbnRoT3JkaW5hbFBhcnNlIHx8IGxvY2FsZS5fb3JkaW5hbFBhcnNlKSA6CiAgICAgIGxvY2FsZS5fZGF5T2ZNb250aE9yZGluYWxQYXJzZUxlbmllbnQ7Cn0pOwoKYWRkUGFyc2VUb2tlbihbJ0QnLCAnREQnXSwgREFURSk7CmFkZFBhcnNlVG9rZW4oJ0RvJywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSkgewogICAgYXJyYXlbREFURV0gPSB0b0ludChpbnB1dC5tYXRjaChtYXRjaDF0bzIpWzBdKTsKfSk7CgovLyBNT01FTlRTCgp2YXIgZ2V0U2V0RGF5T2ZNb250aCA9IG1ha2VHZXRTZXQoJ0RhdGUnLCB0cnVlKTsKCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKCdEREQnLCBbJ0REREQnLCAzXSwgJ0RERG8nLCAnZGF5T2ZZZWFyJyk7CgovLyBBTElBU0VTCgphZGRVbml0QWxpYXMoJ2RheU9mWWVhcicsICdEREQnKTsKCi8vIFBSSU9SSVRZCmFkZFVuaXRQcmlvcml0eSgnZGF5T2ZZZWFyJywgNCk7CgovLyBQQVJTSU5HCgphZGRSZWdleFRva2VuKCdEREQnLCAgbWF0Y2gxdG8zKTsKYWRkUmVnZXhUb2tlbignRERERCcsIG1hdGNoMyk7CmFkZFBhcnNlVG9rZW4oWydEREQnLCAnRERERCddLCBmdW5jdGlvbiAoaW5wdXQsIGFycmF5LCBjb25maWcpIHsKICAgIGNvbmZpZy5fZGF5T2ZZZWFyID0gdG9JbnQoaW5wdXQpOwp9KTsKCi8vIEhFTFBFUlMKCi8vIE1PTUVOVFMKCmZ1bmN0aW9uIGdldFNldERheU9mWWVhciAoaW5wdXQpIHsKICAgIHZhciBkYXlPZlllYXIgPSBNYXRoLnJvdW5kKCh0aGlzLmNsb25lKCkuc3RhcnRPZignZGF5JykgLSB0aGlzLmNsb25lKCkuc3RhcnRPZigneWVhcicpKSAvIDg2NGU1KSArIDE7CiAgICByZXR1cm4gaW5wdXQgPT0gbnVsbCA/IGRheU9mWWVhciA6IHRoaXMuYWRkKChpbnB1dCAtIGRheU9mWWVhciksICdkJyk7Cn0KCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKCdtJywgWydtbScsIDJdLCAwLCAnbWludXRlJyk7CgovLyBBTElBU0VTCgphZGRVbml0QWxpYXMoJ21pbnV0ZScsICdtJyk7CgovLyBQUklPUklUWQoKYWRkVW5pdFByaW9yaXR5KCdtaW51dGUnLCAxNCk7CgovLyBQQVJTSU5HCgphZGRSZWdleFRva2VuKCdtJywgIG1hdGNoMXRvMik7CmFkZFJlZ2V4VG9rZW4oJ21tJywgbWF0Y2gxdG8yLCBtYXRjaDIpOwphZGRQYXJzZVRva2VuKFsnbScsICdtbSddLCBNSU5VVEUpOwoKLy8gTU9NRU5UUwoKdmFyIGdldFNldE1pbnV0ZSA9IG1ha2VHZXRTZXQoJ01pbnV0ZXMnLCBmYWxzZSk7CgovLyBGT1JNQVRUSU5HCgphZGRGb3JtYXRUb2tlbigncycsIFsnc3MnLCAyXSwgMCwgJ3NlY29uZCcpOwoKLy8gQUxJQVNFUwoKYWRkVW5pdEFsaWFzKCdzZWNvbmQnLCAncycpOwoKLy8gUFJJT1JJVFkKCmFkZFVuaXRQcmlvcml0eSgnc2Vjb25kJywgMTUpOwoKLy8gUEFSU0lORwoKYWRkUmVnZXhUb2tlbigncycsICBtYXRjaDF0bzIpOwphZGRSZWdleFRva2VuKCdzcycsIG1hdGNoMXRvMiwgbWF0Y2gyKTsKYWRkUGFyc2VUb2tlbihbJ3MnLCAnc3MnXSwgU0VDT05EKTsKCi8vIE1PTUVOVFMKCnZhciBnZXRTZXRTZWNvbmQgPSBtYWtlR2V0U2V0KCdTZWNvbmRzJywgZmFsc2UpOwoKLy8gRk9STUFUVElORwoKYWRkRm9ybWF0VG9rZW4oJ1MnLCAwLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gfn4odGhpcy5taWxsaXNlY29uZCgpIC8gMTAwKTsKfSk7CgphZGRGb3JtYXRUb2tlbigwLCBbJ1NTJywgMl0sIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB+fih0aGlzLm1pbGxpc2Vjb25kKCkgLyAxMCk7Cn0pOwoKYWRkRm9ybWF0VG9rZW4oMCwgWydTU1MnLCAzXSwgMCwgJ21pbGxpc2Vjb25kJyk7CmFkZEZvcm1hdFRva2VuKDAsIFsnU1NTUycsIDRdLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTA7Cn0pOwphZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTJywgNV0sIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLm1pbGxpc2Vjb25kKCkgKiAxMDA7Cn0pOwphZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTUycsIDZdLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDsKfSk7CmFkZEZvcm1hdFRva2VuKDAsIFsnU1NTU1NTUycsIDddLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDA7Cn0pOwphZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTU1NTJywgOF0sIDAsIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLm1pbGxpc2Vjb25kKCkgKiAxMDAwMDA7Cn0pOwphZGRGb3JtYXRUb2tlbigwLCBbJ1NTU1NTU1NTUycsIDldLCAwLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5taWxsaXNlY29uZCgpICogMTAwMDAwMDsKfSk7CgoKLy8gQUxJQVNFUwoKYWRkVW5pdEFsaWFzKCdtaWxsaXNlY29uZCcsICdtcycpOwoKLy8gUFJJT1JJVFkKCmFkZFVuaXRQcmlvcml0eSgnbWlsbGlzZWNvbmQnLCAxNik7CgovLyBQQVJTSU5HCgphZGRSZWdleFRva2VuKCdTJywgICAgbWF0Y2gxdG8zLCBtYXRjaDEpOwphZGRSZWdleFRva2VuKCdTUycsICAgbWF0Y2gxdG8zLCBtYXRjaDIpOwphZGRSZWdleFRva2VuKCdTU1MnLCAgbWF0Y2gxdG8zLCBtYXRjaDMpOwoKdmFyIHRva2VuOwpmb3IgKHRva2VuID0gJ1NTU1MnOyB0b2tlbi5sZW5ndGggPD0gOTsgdG9rZW4gKz0gJ1MnKSB7CiAgICBhZGRSZWdleFRva2VuKHRva2VuLCBtYXRjaFVuc2lnbmVkKTsKfQoKZnVuY3Rpb24gcGFyc2VNcyhpbnB1dCwgYXJyYXkpIHsKICAgIGFycmF5W01JTExJU0VDT05EXSA9IHRvSW50KCgnMC4nICsgaW5wdXQpICogMTAwMCk7Cn0KCmZvciAodG9rZW4gPSAnUyc7IHRva2VuLmxlbmd0aCA8PSA5OyB0b2tlbiArPSAnUycpIHsKICAgIGFkZFBhcnNlVG9rZW4odG9rZW4sIHBhcnNlTXMpOwp9Ci8vIE1PTUVOVFMKCnZhciBnZXRTZXRNaWxsaXNlY29uZCA9IG1ha2VHZXRTZXQoJ01pbGxpc2Vjb25kcycsIGZhbHNlKTsKCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKCd6JywgIDAsIDAsICd6b25lQWJicicpOwphZGRGb3JtYXRUb2tlbignenonLCAwLCAwLCAnem9uZU5hbWUnKTsKCi8vIE1PTUVOVFMKCmZ1bmN0aW9uIGdldFpvbmVBYmJyICgpIHsKICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdVVEMnIDogJyc7Cn0KCmZ1bmN0aW9uIGdldFpvbmVOYW1lICgpIHsKICAgIHJldHVybiB0aGlzLl9pc1VUQyA/ICdDb29yZGluYXRlZCBVbml2ZXJzYWwgVGltZScgOiAnJzsKfQoKdmFyIHByb3RvID0gTW9tZW50LnByb3RvdHlwZTsKCnByb3RvLmFkZCAgICAgICAgICAgICAgID0gYWRkOwpwcm90by5jYWxlbmRhciAgICAgICAgICA9IGNhbGVuZGFyJDE7CnByb3RvLmNsb25lICAgICAgICAgICAgID0gY2xvbmU7CnByb3RvLmRpZmYgICAgICAgICAgICAgID0gZGlmZjsKcHJvdG8uZW5kT2YgICAgICAgICAgICAgPSBlbmRPZjsKcHJvdG8uZm9ybWF0ICAgICAgICAgICAgPSBmb3JtYXQ7CnByb3RvLmZyb20gICAgICAgICAgICAgID0gZnJvbTsKcHJvdG8uZnJvbU5vdyAgICAgICAgICAgPSBmcm9tTm93Owpwcm90by50byAgICAgICAgICAgICAgICA9IHRvOwpwcm90by50b05vdyAgICAgICAgICAgICA9IHRvTm93Owpwcm90by5nZXQgICAgICAgICAgICAgICA9IHN0cmluZ0dldDsKcHJvdG8uaW52YWxpZEF0ICAgICAgICAgPSBpbnZhbGlkQXQ7CnByb3RvLmlzQWZ0ZXIgICAgICAgICAgID0gaXNBZnRlcjsKcHJvdG8uaXNCZWZvcmUgICAgICAgICAgPSBpc0JlZm9yZTsKcHJvdG8uaXNCZXR3ZWVuICAgICAgICAgPSBpc0JldHdlZW47CnByb3RvLmlzU2FtZSAgICAgICAgICAgID0gaXNTYW1lOwpwcm90by5pc1NhbWVPckFmdGVyICAgICA9IGlzU2FtZU9yQWZ0ZXI7CnByb3RvLmlzU2FtZU9yQmVmb3JlICAgID0gaXNTYW1lT3JCZWZvcmU7CnByb3RvLmlzVmFsaWQgICAgICAgICAgID0gaXNWYWxpZCQyOwpwcm90by5sYW5nICAgICAgICAgICAgICA9IGxhbmc7CnByb3RvLmxvY2FsZSAgICAgICAgICAgID0gbG9jYWxlOwpwcm90by5sb2NhbGVEYXRhICAgICAgICA9IGxvY2FsZURhdGE7CnByb3RvLm1heCAgICAgICAgICAgICAgID0gcHJvdG90eXBlTWF4Owpwcm90by5taW4gICAgICAgICAgICAgICA9IHByb3RvdHlwZU1pbjsKcHJvdG8ucGFyc2luZ0ZsYWdzICAgICAgPSBwYXJzaW5nRmxhZ3M7CnByb3RvLnNldCAgICAgICAgICAgICAgID0gc3RyaW5nU2V0Owpwcm90by5zdGFydE9mICAgICAgICAgICA9IHN0YXJ0T2Y7CnByb3RvLnN1YnRyYWN0ICAgICAgICAgID0gc3VidHJhY3Q7CnByb3RvLnRvQXJyYXkgICAgICAgICAgID0gdG9BcnJheTsKcHJvdG8udG9PYmplY3QgICAgICAgICAgPSB0b09iamVjdDsKcHJvdG8udG9EYXRlICAgICAgICAgICAgPSB0b0RhdGU7CnByb3RvLnRvSVNPU3RyaW5nICAgICAgID0gdG9JU09TdHJpbmc7CnByb3RvLmluc3BlY3QgICAgICAgICAgID0gaW5zcGVjdDsKcHJvdG8udG9KU09OICAgICAgICAgICAgPSB0b0pTT047CnByb3RvLnRvU3RyaW5nICAgICAgICAgID0gdG9TdHJpbmc7CnByb3RvLnVuaXggICAgICAgICAgICAgID0gdW5peDsKcHJvdG8udmFsdWVPZiAgICAgICAgICAgPSB2YWx1ZU9mOwpwcm90by5jcmVhdGlvbkRhdGEgICAgICA9IGNyZWF0aW9uRGF0YTsKCi8vIFllYXIKcHJvdG8ueWVhciAgICAgICA9IGdldFNldFllYXI7CnByb3RvLmlzTGVhcFllYXIgPSBnZXRJc0xlYXBZZWFyOwoKLy8gV2VlayBZZWFyCnByb3RvLndlZWtZZWFyICAgID0gZ2V0U2V0V2Vla1llYXI7CnByb3RvLmlzb1dlZWtZZWFyID0gZ2V0U2V0SVNPV2Vla1llYXI7CgovLyBRdWFydGVyCnByb3RvLnF1YXJ0ZXIgPSBwcm90by5xdWFydGVycyA9IGdldFNldFF1YXJ0ZXI7CgovLyBNb250aApwcm90by5tb250aCAgICAgICA9IGdldFNldE1vbnRoOwpwcm90by5kYXlzSW5Nb250aCA9IGdldERheXNJbk1vbnRoOwoKLy8gV2Vlawpwcm90by53ZWVrICAgICAgICAgICA9IHByb3RvLndlZWtzICAgICAgICA9IGdldFNldFdlZWs7CnByb3RvLmlzb1dlZWsgICAgICAgID0gcHJvdG8uaXNvV2Vla3MgICAgID0gZ2V0U2V0SVNPV2VlazsKcHJvdG8ud2Vla3NJblllYXIgICAgPSBnZXRXZWVrc0luWWVhcjsKcHJvdG8uaXNvV2Vla3NJblllYXIgPSBnZXRJU09XZWVrc0luWWVhcjsKCi8vIERheQpwcm90by5kYXRlICAgICAgID0gZ2V0U2V0RGF5T2ZNb250aDsKcHJvdG8uZGF5ICAgICAgICA9IHByb3RvLmRheXMgICAgICAgICAgICAgPSBnZXRTZXREYXlPZldlZWs7CnByb3RvLndlZWtkYXkgICAgPSBnZXRTZXRMb2NhbGVEYXlPZldlZWs7CnByb3RvLmlzb1dlZWtkYXkgPSBnZXRTZXRJU09EYXlPZldlZWs7CnByb3RvLmRheU9mWWVhciAgPSBnZXRTZXREYXlPZlllYXI7CgovLyBIb3VyCnByb3RvLmhvdXIgPSBwcm90by5ob3VycyA9IGdldFNldEhvdXI7CgovLyBNaW51dGUKcHJvdG8ubWludXRlID0gcHJvdG8ubWludXRlcyA9IGdldFNldE1pbnV0ZTsKCi8vIFNlY29uZApwcm90by5zZWNvbmQgPSBwcm90by5zZWNvbmRzID0gZ2V0U2V0U2Vjb25kOwoKLy8gTWlsbGlzZWNvbmQKcHJvdG8ubWlsbGlzZWNvbmQgPSBwcm90by5taWxsaXNlY29uZHMgPSBnZXRTZXRNaWxsaXNlY29uZDsKCi8vIE9mZnNldApwcm90by51dGNPZmZzZXQgICAgICAgICAgICA9IGdldFNldE9mZnNldDsKcHJvdG8udXRjICAgICAgICAgICAgICAgICAgPSBzZXRPZmZzZXRUb1VUQzsKcHJvdG8ubG9jYWwgICAgICAgICAgICAgICAgPSBzZXRPZmZzZXRUb0xvY2FsOwpwcm90by5wYXJzZVpvbmUgICAgICAgICAgICA9IHNldE9mZnNldFRvUGFyc2VkT2Zmc2V0Owpwcm90by5oYXNBbGlnbmVkSG91ck9mZnNldCA9IGhhc0FsaWduZWRIb3VyT2Zmc2V0Owpwcm90by5pc0RTVCAgICAgICAgICAgICAgICA9IGlzRGF5bGlnaHRTYXZpbmdUaW1lOwpwcm90by5pc0xvY2FsICAgICAgICAgICAgICA9IGlzTG9jYWw7CnByb3RvLmlzVXRjT2Zmc2V0ICAgICAgICAgID0gaXNVdGNPZmZzZXQ7CnByb3RvLmlzVXRjICAgICAgICAgICAgICAgID0gaXNVdGM7CnByb3RvLmlzVVRDICAgICAgICAgICAgICAgID0gaXNVdGM7CgovLyBUaW1lem9uZQpwcm90by56b25lQWJiciA9IGdldFpvbmVBYmJyOwpwcm90by56b25lTmFtZSA9IGdldFpvbmVOYW1lOwoKLy8gRGVwcmVjYXRpb25zCnByb3RvLmRhdGVzICA9IGRlcHJlY2F0ZSgnZGF0ZXMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIGRhdGUgaW5zdGVhZC4nLCBnZXRTZXREYXlPZk1vbnRoKTsKcHJvdG8ubW9udGhzID0gZGVwcmVjYXRlKCdtb250aHMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIG1vbnRoIGluc3RlYWQnLCBnZXRTZXRNb250aCk7CnByb3RvLnllYXJzICA9IGRlcHJlY2F0ZSgneWVhcnMgYWNjZXNzb3IgaXMgZGVwcmVjYXRlZC4gVXNlIHllYXIgaW5zdGVhZCcsIGdldFNldFllYXIpOwpwcm90by56b25lICAgPSBkZXByZWNhdGUoJ21vbWVudCgpLnpvbmUgaXMgZGVwcmVjYXRlZCwgdXNlIG1vbWVudCgpLnV0Y09mZnNldCBpbnN0ZWFkLiBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL3pvbmUvJywgZ2V0U2V0Wm9uZSk7CnByb3RvLmlzRFNUU2hpZnRlZCA9IGRlcHJlY2F0ZSgnaXNEU1RTaGlmdGVkIGlzIGRlcHJlY2F0ZWQuIFNlZSBodHRwOi8vbW9tZW50anMuY29tL2d1aWRlcy8jL3dhcm5pbmdzL2RzdC1zaGlmdGVkLyBmb3IgbW9yZSBpbmZvcm1hdGlvbicsIGlzRGF5bGlnaHRTYXZpbmdUaW1lU2hpZnRlZCk7CgpmdW5jdGlvbiBjcmVhdGVVbml4IChpbnB1dCkgewogICAgcmV0dXJuIGNyZWF0ZUxvY2FsKGlucHV0ICogMTAwMCk7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUluWm9uZSAoKSB7CiAgICByZXR1cm4gY3JlYXRlTG9jYWwuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5wYXJzZVpvbmUoKTsKfQoKZnVuY3Rpb24gcHJlUGFyc2VQb3N0Rm9ybWF0IChzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmc7Cn0KCnZhciBwcm90byQxID0gTG9jYWxlLnByb3RvdHlwZTsKCnByb3RvJDEuY2FsZW5kYXIgICAgICAgID0gY2FsZW5kYXI7CnByb3RvJDEubG9uZ0RhdGVGb3JtYXQgID0gbG9uZ0RhdGVGb3JtYXQ7CnByb3RvJDEuaW52YWxpZERhdGUgICAgID0gaW52YWxpZERhdGU7CnByb3RvJDEub3JkaW5hbCAgICAgICAgID0gb3JkaW5hbDsKcHJvdG8kMS5wcmVwYXJzZSAgICAgICAgPSBwcmVQYXJzZVBvc3RGb3JtYXQ7CnByb3RvJDEucG9zdGZvcm1hdCAgICAgID0gcHJlUGFyc2VQb3N0Rm9ybWF0Owpwcm90byQxLnJlbGF0aXZlVGltZSAgICA9IHJlbGF0aXZlVGltZTsKcHJvdG8kMS5wYXN0RnV0dXJlICAgICAgPSBwYXN0RnV0dXJlOwpwcm90byQxLnNldCAgICAgICAgICAgICA9IHNldDsKCi8vIE1vbnRoCnByb3RvJDEubW9udGhzICAgICAgICAgICAgPSAgICAgICAgbG9jYWxlTW9udGhzOwpwcm90byQxLm1vbnRoc1Nob3J0ICAgICAgID0gICAgICAgIGxvY2FsZU1vbnRoc1Nob3J0Owpwcm90byQxLm1vbnRoc1BhcnNlICAgICAgID0gICAgICAgIGxvY2FsZU1vbnRoc1BhcnNlOwpwcm90byQxLm1vbnRoc1JlZ2V4ICAgICAgID0gbW9udGhzUmVnZXg7CnByb3RvJDEubW9udGhzU2hvcnRSZWdleCAgPSBtb250aHNTaG9ydFJlZ2V4OwoKLy8gV2Vlawpwcm90byQxLndlZWsgPSBsb2NhbGVXZWVrOwpwcm90byQxLmZpcnN0RGF5T2ZZZWFyID0gbG9jYWxlRmlyc3REYXlPZlllYXI7CnByb3RvJDEuZmlyc3REYXlPZldlZWsgPSBsb2NhbGVGaXJzdERheU9mV2VlazsKCi8vIERheSBvZiBXZWVrCnByb3RvJDEud2Vla2RheXMgICAgICAgPSAgICAgICAgbG9jYWxlV2Vla2RheXM7CnByb3RvJDEud2Vla2RheXNNaW4gICAgPSAgICAgICAgbG9jYWxlV2Vla2RheXNNaW47CnByb3RvJDEud2Vla2RheXNTaG9ydCAgPSAgICAgICAgbG9jYWxlV2Vla2RheXNTaG9ydDsKcHJvdG8kMS53ZWVrZGF5c1BhcnNlICA9ICAgICAgICBsb2NhbGVXZWVrZGF5c1BhcnNlOwoKcHJvdG8kMS53ZWVrZGF5c1JlZ2V4ICAgICAgID0gICAgICAgIHdlZWtkYXlzUmVnZXg7CnByb3RvJDEud2Vla2RheXNTaG9ydFJlZ2V4ICA9ICAgICAgICB3ZWVrZGF5c1Nob3J0UmVnZXg7CnByb3RvJDEud2Vla2RheXNNaW5SZWdleCAgICA9ICAgICAgICB3ZWVrZGF5c01pblJlZ2V4OwoKLy8gSG91cnMKcHJvdG8kMS5pc1BNID0gbG9jYWxlSXNQTTsKcHJvdG8kMS5tZXJpZGllbSA9IGxvY2FsZU1lcmlkaWVtOwoKZnVuY3Rpb24gZ2V0JDEgKGZvcm1hdCwgaW5kZXgsIGZpZWxkLCBzZXR0ZXIpIHsKICAgIHZhciBsb2NhbGUgPSBnZXRMb2NhbGUoKTsKICAgIHZhciB1dGMgPSBjcmVhdGVVVEMoKS5zZXQoc2V0dGVyLCBpbmRleCk7CiAgICByZXR1cm4gbG9jYWxlW2ZpZWxkXSh1dGMsIGZvcm1hdCk7Cn0KCmZ1bmN0aW9uIGxpc3RNb250aHNJbXBsIChmb3JtYXQsIGluZGV4LCBmaWVsZCkgewogICAgaWYgKGlzTnVtYmVyKGZvcm1hdCkpIHsKICAgICAgICBpbmRleCA9IGZvcm1hdDsKICAgICAgICBmb3JtYXQgPSB1bmRlZmluZWQ7CiAgICB9CgogICAgZm9ybWF0ID0gZm9ybWF0IHx8ICcnOwoKICAgIGlmIChpbmRleCAhPSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGdldCQxKGZvcm1hdCwgaW5kZXgsIGZpZWxkLCAnbW9udGgnKTsKICAgIH0KCiAgICB2YXIgaTsKICAgIHZhciBvdXQgPSBbXTsKICAgIGZvciAoaSA9IDA7IGkgPCAxMjsgaSsrKSB7CiAgICAgICAgb3V0W2ldID0gZ2V0JDEoZm9ybWF0LCBpLCBmaWVsZCwgJ21vbnRoJyk7CiAgICB9CiAgICByZXR1cm4gb3V0Owp9CgovLyAoKQovLyAoNSkKLy8gKGZtdCwgNSkKLy8gKGZtdCkKLy8gKHRydWUpCi8vICh0cnVlLCA1KQovLyAodHJ1ZSwgZm10LCA1KQovLyAodHJ1ZSwgZm10KQpmdW5jdGlvbiBsaXN0V2Vla2RheXNJbXBsIChsb2NhbGVTb3J0ZWQsIGZvcm1hdCwgaW5kZXgsIGZpZWxkKSB7CiAgICBpZiAodHlwZW9mIGxvY2FsZVNvcnRlZCA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgaWYgKGlzTnVtYmVyKGZvcm1hdCkpIHsKICAgICAgICAgICAgaW5kZXggPSBmb3JtYXQ7CiAgICAgICAgICAgIGZvcm1hdCA9IHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGZvcm1hdCA9IGZvcm1hdCB8fCAnJzsKICAgIH0gZWxzZSB7CiAgICAgICAgZm9ybWF0ID0gbG9jYWxlU29ydGVkOwogICAgICAgIGluZGV4ID0gZm9ybWF0OwogICAgICAgIGxvY2FsZVNvcnRlZCA9IGZhbHNlOwoKICAgICAgICBpZiAoaXNOdW1iZXIoZm9ybWF0KSkgewogICAgICAgICAgICBpbmRleCA9IGZvcm1hdDsKICAgICAgICAgICAgZm9ybWF0ID0gdW5kZWZpbmVkOwogICAgICAgIH0KCiAgICAgICAgZm9ybWF0ID0gZm9ybWF0IHx8ICcnOwogICAgfQoKICAgIHZhciBsb2NhbGUgPSBnZXRMb2NhbGUoKSwKICAgICAgICBzaGlmdCA9IGxvY2FsZVNvcnRlZCA/IGxvY2FsZS5fd2Vlay5kb3cgOiAwOwoKICAgIGlmIChpbmRleCAhPSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGdldCQxKGZvcm1hdCwgKGluZGV4ICsgc2hpZnQpICUgNywgZmllbGQsICdkYXknKTsKICAgIH0KCiAgICB2YXIgaTsKICAgIHZhciBvdXQgPSBbXTsKICAgIGZvciAoaSA9IDA7IGkgPCA3OyBpKyspIHsKICAgICAgICBvdXRbaV0gPSBnZXQkMShmb3JtYXQsIChpICsgc2hpZnQpICUgNywgZmllbGQsICdkYXknKTsKICAgIH0KICAgIHJldHVybiBvdXQ7Cn0KCmZ1bmN0aW9uIGxpc3RNb250aHMgKGZvcm1hdCwgaW5kZXgpIHsKICAgIHJldHVybiBsaXN0TW9udGhzSW1wbChmb3JtYXQsIGluZGV4LCAnbW9udGhzJyk7Cn0KCmZ1bmN0aW9uIGxpc3RNb250aHNTaG9ydCAoZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RNb250aHNJbXBsKGZvcm1hdCwgaW5kZXgsICdtb250aHNTaG9ydCcpOwp9CgpmdW5jdGlvbiBsaXN0V2Vla2RheXMgKGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCAnd2Vla2RheXMnKTsKfQoKZnVuY3Rpb24gbGlzdFdlZWtkYXlzU2hvcnQgKGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCAnd2Vla2RheXNTaG9ydCcpOwp9CgpmdW5jdGlvbiBsaXN0V2Vla2RheXNNaW4gKGxvY2FsZVNvcnRlZCwgZm9ybWF0LCBpbmRleCkgewogICAgcmV0dXJuIGxpc3RXZWVrZGF5c0ltcGwobG9jYWxlU29ydGVkLCBmb3JtYXQsIGluZGV4LCAnd2Vla2RheXNNaW4nKTsKfQoKZ2V0U2V0R2xvYmFsTG9jYWxlKCdlbicsIHsKICAgIGRheU9mTW9udGhPcmRpbmFsUGFyc2U6IC9cZHsxLDJ9KHRofHN0fG5kfHJkKS8sCiAgICBvcmRpbmFsIDogZnVuY3Rpb24gKG51bWJlcikgewogICAgICAgIHZhciBiID0gbnVtYmVyICUgMTAsCiAgICAgICAgICAgIG91dHB1dCA9ICh0b0ludChudW1iZXIgJSAxMDAgLyAxMCkgPT09IDEpID8gJ3RoJyA6CiAgICAgICAgICAgIChiID09PSAxKSA/ICdzdCcgOgogICAgICAgICAgICAoYiA9PT0gMikgPyAnbmQnIDoKICAgICAgICAgICAgKGIgPT09IDMpID8gJ3JkJyA6ICd0aCc7CiAgICAgICAgcmV0dXJuIG51bWJlciArIG91dHB1dDsKICAgIH0KfSk7CgovLyBTaWRlIGVmZmVjdCBpbXBvcnRzCmhvb2tzLmxhbmcgPSBkZXByZWNhdGUoJ21vbWVudC5sYW5nIGlzIGRlcHJlY2F0ZWQuIFVzZSBtb21lbnQubG9jYWxlIGluc3RlYWQuJywgZ2V0U2V0R2xvYmFsTG9jYWxlKTsKaG9va3MubGFuZ0RhdGEgPSBkZXByZWNhdGUoJ21vbWVudC5sYW5nRGF0YSBpcyBkZXByZWNhdGVkLiBVc2UgbW9tZW50LmxvY2FsZURhdGEgaW5zdGVhZC4nLCBnZXRMb2NhbGUpOwoKdmFyIG1hdGhBYnMgPSBNYXRoLmFiczsKCmZ1bmN0aW9uIGFicyAoKSB7CiAgICB2YXIgZGF0YSAgICAgICAgICAgPSB0aGlzLl9kYXRhOwoKICAgIHRoaXMuX21pbGxpc2Vjb25kcyA9IG1hdGhBYnModGhpcy5fbWlsbGlzZWNvbmRzKTsKICAgIHRoaXMuX2RheXMgICAgICAgICA9IG1hdGhBYnModGhpcy5fZGF5cyk7CiAgICB0aGlzLl9tb250aHMgICAgICAgPSBtYXRoQWJzKHRoaXMuX21vbnRocyk7CgogICAgZGF0YS5taWxsaXNlY29uZHMgID0gbWF0aEFicyhkYXRhLm1pbGxpc2Vjb25kcyk7CiAgICBkYXRhLnNlY29uZHMgICAgICAgPSBtYXRoQWJzKGRhdGEuc2Vjb25kcyk7CiAgICBkYXRhLm1pbnV0ZXMgICAgICAgPSBtYXRoQWJzKGRhdGEubWludXRlcyk7CiAgICBkYXRhLmhvdXJzICAgICAgICAgPSBtYXRoQWJzKGRhdGEuaG91cnMpOwogICAgZGF0YS5tb250aHMgICAgICAgID0gbWF0aEFicyhkYXRhLm1vbnRocyk7CiAgICBkYXRhLnllYXJzICAgICAgICAgPSBtYXRoQWJzKGRhdGEueWVhcnMpOwoKICAgIHJldHVybiB0aGlzOwp9CgpmdW5jdGlvbiBhZGRTdWJ0cmFjdCQxIChkdXJhdGlvbiwgaW5wdXQsIHZhbHVlLCBkaXJlY3Rpb24pIHsKICAgIHZhciBvdGhlciA9IGNyZWF0ZUR1cmF0aW9uKGlucHV0LCB2YWx1ZSk7CgogICAgZHVyYXRpb24uX21pbGxpc2Vjb25kcyArPSBkaXJlY3Rpb24gKiBvdGhlci5fbWlsbGlzZWNvbmRzOwogICAgZHVyYXRpb24uX2RheXMgICAgICAgICArPSBkaXJlY3Rpb24gKiBvdGhlci5fZGF5czsKICAgIGR1cmF0aW9uLl9tb250aHMgICAgICAgKz0gZGlyZWN0aW9uICogb3RoZXIuX21vbnRoczsKCiAgICByZXR1cm4gZHVyYXRpb24uX2J1YmJsZSgpOwp9CgovLyBzdXBwb3J0cyBvbmx5IDIuMC1zdHlsZSBhZGQoMSwgJ3MnKSBvciBhZGQoZHVyYXRpb24pCmZ1bmN0aW9uIGFkZCQxIChpbnB1dCwgdmFsdWUpIHsKICAgIHJldHVybiBhZGRTdWJ0cmFjdCQxKHRoaXMsIGlucHV0LCB2YWx1ZSwgMSk7Cn0KCi8vIHN1cHBvcnRzIG9ubHkgMi4wLXN0eWxlIHN1YnRyYWN0KDEsICdzJykgb3Igc3VidHJhY3QoZHVyYXRpb24pCmZ1bmN0aW9uIHN1YnRyYWN0JDEgKGlucHV0LCB2YWx1ZSkgewogICAgcmV0dXJuIGFkZFN1YnRyYWN0JDEodGhpcywgaW5wdXQsIHZhbHVlLCAtMSk7Cn0KCmZ1bmN0aW9uIGFic0NlaWwgKG51bWJlcikgewogICAgaWYgKG51bWJlciA8IDApIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihudW1iZXIpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKG51bWJlcik7CiAgICB9Cn0KCmZ1bmN0aW9uIGJ1YmJsZSAoKSB7CiAgICB2YXIgbWlsbGlzZWNvbmRzID0gdGhpcy5fbWlsbGlzZWNvbmRzOwogICAgdmFyIGRheXMgICAgICAgICA9IHRoaXMuX2RheXM7CiAgICB2YXIgbW9udGhzICAgICAgID0gdGhpcy5fbW9udGhzOwogICAgdmFyIGRhdGEgICAgICAgICA9IHRoaXMuX2RhdGE7CiAgICB2YXIgc2Vjb25kcywgbWludXRlcywgaG91cnMsIHllYXJzLCBtb250aHNGcm9tRGF5czsKCiAgICAvLyBpZiB3ZSBoYXZlIGEgbWl4IG9mIHBvc2l0aXZlIGFuZCBuZWdhdGl2ZSB2YWx1ZXMsIGJ1YmJsZSBkb3duIGZpcnN0CiAgICAvLyBjaGVjazogaHR0cHM6Ly9naXRodWIuY29tL21vbWVudC9tb21lbnQvaXNzdWVzLzIxNjYKICAgIGlmICghKChtaWxsaXNlY29uZHMgPj0gMCAmJiBkYXlzID49IDAgJiYgbW9udGhzID49IDApIHx8CiAgICAgICAgICAgIChtaWxsaXNlY29uZHMgPD0gMCAmJiBkYXlzIDw9IDAgJiYgbW9udGhzIDw9IDApKSkgewogICAgICAgIG1pbGxpc2Vjb25kcyArPSBhYnNDZWlsKG1vbnRoc1RvRGF5cyhtb250aHMpICsgZGF5cykgKiA4NjRlNTsKICAgICAgICBkYXlzID0gMDsKICAgICAgICBtb250aHMgPSAwOwogICAgfQoKICAgIC8vIFRoZSBmb2xsb3dpbmcgY29kZSBidWJibGVzIHVwIHZhbHVlcywgc2VlIHRoZSB0ZXN0cyBmb3IKICAgIC8vIGV4YW1wbGVzIG9mIHdoYXQgdGhhdCBtZWFucy4KICAgIGRhdGEubWlsbGlzZWNvbmRzID0gbWlsbGlzZWNvbmRzICUgMTAwMDsKCiAgICBzZWNvbmRzICAgICAgICAgICA9IGFic0Zsb29yKG1pbGxpc2Vjb25kcyAvIDEwMDApOwogICAgZGF0YS5zZWNvbmRzICAgICAgPSBzZWNvbmRzICUgNjA7CgogICAgbWludXRlcyAgICAgICAgICAgPSBhYnNGbG9vcihzZWNvbmRzIC8gNjApOwogICAgZGF0YS5taW51dGVzICAgICAgPSBtaW51dGVzICUgNjA7CgogICAgaG91cnMgICAgICAgICAgICAgPSBhYnNGbG9vcihtaW51dGVzIC8gNjApOwogICAgZGF0YS5ob3VycyAgICAgICAgPSBob3VycyAlIDI0OwoKICAgIGRheXMgKz0gYWJzRmxvb3IoaG91cnMgLyAyNCk7CgogICAgLy8gY29udmVydCBkYXlzIHRvIG1vbnRocwogICAgbW9udGhzRnJvbURheXMgPSBhYnNGbG9vcihkYXlzVG9Nb250aHMoZGF5cykpOwogICAgbW9udGhzICs9IG1vbnRoc0Zyb21EYXlzOwogICAgZGF5cyAtPSBhYnNDZWlsKG1vbnRoc1RvRGF5cyhtb250aHNGcm9tRGF5cykpOwoKICAgIC8vIDEyIG1vbnRocyAtPiAxIHllYXIKICAgIHllYXJzID0gYWJzRmxvb3IobW9udGhzIC8gMTIpOwogICAgbW9udGhzICU9IDEyOwoKICAgIGRhdGEuZGF5cyAgID0gZGF5czsKICAgIGRhdGEubW9udGhzID0gbW9udGhzOwogICAgZGF0YS55ZWFycyAgPSB5ZWFyczsKCiAgICByZXR1cm4gdGhpczsKfQoKZnVuY3Rpb24gZGF5c1RvTW9udGhzIChkYXlzKSB7CiAgICAvLyA0MDAgeWVhcnMgaGF2ZSAxNDYwOTcgZGF5cyAodGFraW5nIGludG8gYWNjb3VudCBsZWFwIHllYXIgcnVsZXMpCiAgICAvLyA0MDAgeWVhcnMgaGF2ZSAxMiBtb250aHMgPT09IDQ4MDAKICAgIHJldHVybiBkYXlzICogNDgwMCAvIDE0NjA5NzsKfQoKZnVuY3Rpb24gbW9udGhzVG9EYXlzIChtb250aHMpIHsKICAgIC8vIHRoZSByZXZlcnNlIG9mIGRheXNUb01vbnRocwogICAgcmV0dXJuIG1vbnRocyAqIDE0NjA5NyAvIDQ4MDA7Cn0KCmZ1bmN0aW9uIGFzICh1bml0cykgewogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiBOYU47CiAgICB9CiAgICB2YXIgZGF5czsKICAgIHZhciBtb250aHM7CiAgICB2YXIgbWlsbGlzZWNvbmRzID0gdGhpcy5fbWlsbGlzZWNvbmRzOwoKICAgIHVuaXRzID0gbm9ybWFsaXplVW5pdHModW5pdHMpOwoKICAgIGlmICh1bml0cyA9PT0gJ21vbnRoJyB8fCB1bml0cyA9PT0gJ3llYXInKSB7CiAgICAgICAgZGF5cyAgID0gdGhpcy5fZGF5cyAgICsgbWlsbGlzZWNvbmRzIC8gODY0ZTU7CiAgICAgICAgbW9udGhzID0gdGhpcy5fbW9udGhzICsgZGF5c1RvTW9udGhzKGRheXMpOwogICAgICAgIHJldHVybiB1bml0cyA9PT0gJ21vbnRoJyA/IG1vbnRocyA6IG1vbnRocyAvIDEyOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBoYW5kbGUgbWlsbGlzZWNvbmRzIHNlcGFyYXRlbHkgYmVjYXVzZSBvZiBmbG9hdGluZyBwb2ludCBtYXRoIGVycm9ycyAoaXNzdWUgIzE4NjcpCiAgICAgICAgZGF5cyA9IHRoaXMuX2RheXMgKyBNYXRoLnJvdW5kKG1vbnRoc1RvRGF5cyh0aGlzLl9tb250aHMpKTsKICAgICAgICBzd2l0Y2ggKHVuaXRzKSB7CiAgICAgICAgICAgIGNhc2UgJ3dlZWsnICAgOiByZXR1cm4gZGF5cyAvIDcgICAgICsgbWlsbGlzZWNvbmRzIC8gNjA0OGU1OwogICAgICAgICAgICBjYXNlICdkYXknICAgIDogcmV0dXJuIGRheXMgICAgICAgICArIG1pbGxpc2Vjb25kcyAvIDg2NGU1OwogICAgICAgICAgICBjYXNlICdob3VyJyAgIDogcmV0dXJuIGRheXMgKiAyNCAgICArIG1pbGxpc2Vjb25kcyAvIDM2ZTU7CiAgICAgICAgICAgIGNhc2UgJ21pbnV0ZScgOiByZXR1cm4gZGF5cyAqIDE0NDAgICsgbWlsbGlzZWNvbmRzIC8gNmU0OwogICAgICAgICAgICBjYXNlICdzZWNvbmQnIDogcmV0dXJuIGRheXMgKiA4NjQwMCArIG1pbGxpc2Vjb25kcyAvIDEwMDA7CiAgICAgICAgICAgIC8vIE1hdGguZmxvb3IgcHJldmVudHMgZmxvYXRpbmcgcG9pbnQgbWF0aCBlcnJvcnMgaGVyZQogICAgICAgICAgICBjYXNlICdtaWxsaXNlY29uZCc6IHJldHVybiBNYXRoLmZsb29yKGRheXMgKiA4NjRlNSkgKyBtaWxsaXNlY29uZHM7CiAgICAgICAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcignVW5rbm93biB1bml0ICcgKyB1bml0cyk7CiAgICAgICAgfQogICAgfQp9CgovLyBUT0RPOiBVc2UgdGhpcy5hcygnbXMnKT8KZnVuY3Rpb24gdmFsdWVPZiQxICgpIHsKICAgIGlmICghdGhpcy5pc1ZhbGlkKCkpIHsKICAgICAgICByZXR1cm4gTmFOOwogICAgfQogICAgcmV0dXJuICgKICAgICAgICB0aGlzLl9taWxsaXNlY29uZHMgKwogICAgICAgIHRoaXMuX2RheXMgKiA4NjRlNSArCiAgICAgICAgKHRoaXMuX21vbnRocyAlIDEyKSAqIDI1OTJlNiArCiAgICAgICAgdG9JbnQodGhpcy5fbW9udGhzIC8gMTIpICogMzE1MzZlNgogICAgKTsKfQoKZnVuY3Rpb24gbWFrZUFzIChhbGlhcykgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hcyhhbGlhcyk7CiAgICB9Owp9Cgp2YXIgYXNNaWxsaXNlY29uZHMgPSBtYWtlQXMoJ21zJyk7CnZhciBhc1NlY29uZHMgICAgICA9IG1ha2VBcygncycpOwp2YXIgYXNNaW51dGVzICAgICAgPSBtYWtlQXMoJ20nKTsKdmFyIGFzSG91cnMgICAgICAgID0gbWFrZUFzKCdoJyk7CnZhciBhc0RheXMgICAgICAgICA9IG1ha2VBcygnZCcpOwp2YXIgYXNXZWVrcyAgICAgICAgPSBtYWtlQXMoJ3cnKTsKdmFyIGFzTW9udGhzICAgICAgID0gbWFrZUFzKCdNJyk7CnZhciBhc1llYXJzICAgICAgICA9IG1ha2VBcygneScpOwoKZnVuY3Rpb24gY2xvbmUkMSAoKSB7CiAgICByZXR1cm4gY3JlYXRlRHVyYXRpb24odGhpcyk7Cn0KCmZ1bmN0aW9uIGdldCQyICh1bml0cykgewogICAgdW5pdHMgPSBub3JtYWxpemVVbml0cyh1bml0cyk7CiAgICByZXR1cm4gdGhpcy5pc1ZhbGlkKCkgPyB0aGlzW3VuaXRzICsgJ3MnXSgpIDogTmFOOwp9CgpmdW5jdGlvbiBtYWtlR2V0dGVyKG5hbWUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNWYWxpZCgpID8gdGhpcy5fZGF0YVtuYW1lXSA6IE5hTjsKICAgIH07Cn0KCnZhciBtaWxsaXNlY29uZHMgPSBtYWtlR2V0dGVyKCdtaWxsaXNlY29uZHMnKTsKdmFyIHNlY29uZHMgICAgICA9IG1ha2VHZXR0ZXIoJ3NlY29uZHMnKTsKdmFyIG1pbnV0ZXMgICAgICA9IG1ha2VHZXR0ZXIoJ21pbnV0ZXMnKTsKdmFyIGhvdXJzICAgICAgICA9IG1ha2VHZXR0ZXIoJ2hvdXJzJyk7CnZhciBkYXlzICAgICAgICAgPSBtYWtlR2V0dGVyKCdkYXlzJyk7CnZhciBtb250aHMgICAgICAgPSBtYWtlR2V0dGVyKCdtb250aHMnKTsKdmFyIHllYXJzICAgICAgICA9IG1ha2VHZXR0ZXIoJ3llYXJzJyk7CgpmdW5jdGlvbiB3ZWVrcyAoKSB7CiAgICByZXR1cm4gYWJzRmxvb3IodGhpcy5kYXlzKCkgLyA3KTsKfQoKdmFyIHJvdW5kID0gTWF0aC5yb3VuZDsKdmFyIHRocmVzaG9sZHMgPSB7CiAgICBzczogNDQsICAgICAgICAgLy8gYSBmZXcgc2Vjb25kcyB0byBzZWNvbmRzCiAgICBzIDogNDUsICAgICAgICAgLy8gc2Vjb25kcyB0byBtaW51dGUKICAgIG0gOiA0NSwgICAgICAgICAvLyBtaW51dGVzIHRvIGhvdXIKICAgIGggOiAyMiwgICAgICAgICAvLyBob3VycyB0byBkYXkKICAgIGQgOiAyNiwgICAgICAgICAvLyBkYXlzIHRvIG1vbnRoCiAgICBNIDogMTEgICAgICAgICAgLy8gbW9udGhzIHRvIHllYXIKfTsKCi8vIGhlbHBlciBmdW5jdGlvbiBmb3IgbW9tZW50LmZuLmZyb20sIG1vbWVudC5mbi5mcm9tTm93LCBhbmQgbW9tZW50LmR1cmF0aW9uLmZuLmh1bWFuaXplCmZ1bmN0aW9uIHN1YnN0aXR1dGVUaW1lQWdvKHN0cmluZywgbnVtYmVyLCB3aXRob3V0U3VmZml4LCBpc0Z1dHVyZSwgbG9jYWxlKSB7CiAgICByZXR1cm4gbG9jYWxlLnJlbGF0aXZlVGltZShudW1iZXIgfHwgMSwgISF3aXRob3V0U3VmZml4LCBzdHJpbmcsIGlzRnV0dXJlKTsKfQoKZnVuY3Rpb24gcmVsYXRpdmVUaW1lJDEgKHBvc05lZ0R1cmF0aW9uLCB3aXRob3V0U3VmZml4LCBsb2NhbGUpIHsKICAgIHZhciBkdXJhdGlvbiA9IGNyZWF0ZUR1cmF0aW9uKHBvc05lZ0R1cmF0aW9uKS5hYnMoKTsKICAgIHZhciBzZWNvbmRzICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdzJykpOwogICAgdmFyIG1pbnV0ZXMgID0gcm91bmQoZHVyYXRpb24uYXMoJ20nKSk7CiAgICB2YXIgaG91cnMgICAgPSByb3VuZChkdXJhdGlvbi5hcygnaCcpKTsKICAgIHZhciBkYXlzICAgICA9IHJvdW5kKGR1cmF0aW9uLmFzKCdkJykpOwogICAgdmFyIG1vbnRocyAgID0gcm91bmQoZHVyYXRpb24uYXMoJ00nKSk7CiAgICB2YXIgeWVhcnMgICAgPSByb3VuZChkdXJhdGlvbi5hcygneScpKTsKCiAgICB2YXIgYSA9IHNlY29uZHMgPD0gdGhyZXNob2xkcy5zcyAmJiBbJ3MnLCBzZWNvbmRzXSAgfHwKICAgICAgICAgICAgc2Vjb25kcyA8IHRocmVzaG9sZHMucyAgICYmIFsnc3MnLCBzZWNvbmRzXSB8fAogICAgICAgICAgICBtaW51dGVzIDw9IDEgICAgICAgICAgICAgJiYgWydtJ10gICAgICAgICAgIHx8CiAgICAgICAgICAgIG1pbnV0ZXMgPCB0aHJlc2hvbGRzLm0gICAmJiBbJ21tJywgbWludXRlc10gfHwKICAgICAgICAgICAgaG91cnMgICA8PSAxICAgICAgICAgICAgICYmIFsnaCddICAgICAgICAgICB8fAogICAgICAgICAgICBob3VycyAgIDwgdGhyZXNob2xkcy5oICAgJiYgWydoaCcsIGhvdXJzXSAgIHx8CiAgICAgICAgICAgIGRheXMgICAgPD0gMSAgICAgICAgICAgICAmJiBbJ2QnXSAgICAgICAgICAgfHwKICAgICAgICAgICAgZGF5cyAgICA8IHRocmVzaG9sZHMuZCAgICYmIFsnZGQnLCBkYXlzXSAgICB8fAogICAgICAgICAgICBtb250aHMgIDw9IDEgICAgICAgICAgICAgJiYgWydNJ10gICAgICAgICAgIHx8CiAgICAgICAgICAgIG1vbnRocyAgPCB0aHJlc2hvbGRzLk0gICAmJiBbJ01NJywgbW9udGhzXSAgfHwKICAgICAgICAgICAgeWVhcnMgICA8PSAxICAgICAgICAgICAgICYmIFsneSddICAgICAgICAgICB8fCBbJ3l5JywgeWVhcnNdOwoKICAgIGFbMl0gPSB3aXRob3V0U3VmZml4OwogICAgYVszXSA9ICtwb3NOZWdEdXJhdGlvbiA+IDA7CiAgICBhWzRdID0gbG9jYWxlOwogICAgcmV0dXJuIHN1YnN0aXR1dGVUaW1lQWdvLmFwcGx5KG51bGwsIGEpOwp9CgovLyBUaGlzIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gc2V0IHRoZSByb3VuZGluZyBmdW5jdGlvbiBmb3IgcmVsYXRpdmUgdGltZSBzdHJpbmdzCmZ1bmN0aW9uIGdldFNldFJlbGF0aXZlVGltZVJvdW5kaW5nIChyb3VuZGluZ0Z1bmN0aW9uKSB7CiAgICBpZiAocm91bmRpbmdGdW5jdGlvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHJvdW5kOwogICAgfQogICAgaWYgKHR5cGVvZihyb3VuZGluZ0Z1bmN0aW9uKSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJvdW5kID0gcm91bmRpbmdGdW5jdGlvbjsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfQoKLy8gVGhpcyBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIHNldCBhIHRocmVzaG9sZCBmb3IgcmVsYXRpdmUgdGltZSBzdHJpbmdzCmZ1bmN0aW9uIGdldFNldFJlbGF0aXZlVGltZVRocmVzaG9sZCAodGhyZXNob2xkLCBsaW1pdCkgewogICAgaWYgKHRocmVzaG9sZHNbdGhyZXNob2xkXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKGxpbWl0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhyZXNob2xkc1t0aHJlc2hvbGRdOwogICAgfQogICAgdGhyZXNob2xkc1t0aHJlc2hvbGRdID0gbGltaXQ7CiAgICBpZiAodGhyZXNob2xkID09PSAncycpIHsKICAgICAgICB0aHJlc2hvbGRzLnNzID0gbGltaXQgLSAxOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIGh1bWFuaXplICh3aXRoU3VmZml4KSB7CiAgICBpZiAoIXRoaXMuaXNWYWxpZCgpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYWxlRGF0YSgpLmludmFsaWREYXRlKCk7CiAgICB9CgogICAgdmFyIGxvY2FsZSA9IHRoaXMubG9jYWxlRGF0YSgpOwogICAgdmFyIG91dHB1dCA9IHJlbGF0aXZlVGltZSQxKHRoaXMsICF3aXRoU3VmZml4LCBsb2NhbGUpOwoKICAgIGlmICh3aXRoU3VmZml4KSB7CiAgICAgICAgb3V0cHV0ID0gbG9jYWxlLnBhc3RGdXR1cmUoK3RoaXMsIG91dHB1dCk7CiAgICB9CgogICAgcmV0dXJuIGxvY2FsZS5wb3N0Zm9ybWF0KG91dHB1dCk7Cn0KCnZhciBhYnMkMSA9IE1hdGguYWJzOwoKZnVuY3Rpb24gc2lnbih4KSB7CiAgICByZXR1cm4gKCh4ID4gMCkgLSAoeCA8IDApKSB8fCAreDsKfQoKZnVuY3Rpb24gdG9JU09TdHJpbmckMSgpIHsKICAgIC8vIGZvciBJU08gc3RyaW5ncyB3ZSBkbyBub3QgdXNlIHRoZSBub3JtYWwgYnViYmxpbmcgcnVsZXM6CiAgICAvLyAgKiBtaWxsaXNlY29uZHMgYnViYmxlIHVwIHVudGlsIHRoZXkgYmVjb21lIGhvdXJzCiAgICAvLyAgKiBkYXlzIGRvIG5vdCBidWJibGUgYXQgYWxsCiAgICAvLyAgKiBtb250aHMgYnViYmxlIHVwIHVudGlsIHRoZXkgYmVjb21lIHllYXJzCiAgICAvLyBUaGlzIGlzIGJlY2F1c2UgdGhlcmUgaXMgbm8gY29udGV4dC1mcmVlIGNvbnZlcnNpb24gYmV0d2VlbiBob3VycyBhbmQgZGF5cwogICAgLy8gKHRoaW5rIG9mIGNsb2NrIGNoYW5nZXMpCiAgICAvLyBhbmQgYWxzbyBub3QgYmV0d2VlbiBkYXlzIGFuZCBtb250aHMgKDI4LTMxIGRheXMgcGVyIG1vbnRoKQogICAgaWYgKCF0aGlzLmlzVmFsaWQoKSkgewogICAgICAgIHJldHVybiB0aGlzLmxvY2FsZURhdGEoKS5pbnZhbGlkRGF0ZSgpOwogICAgfQoKICAgIHZhciBzZWNvbmRzID0gYWJzJDEodGhpcy5fbWlsbGlzZWNvbmRzKSAvIDEwMDA7CiAgICB2YXIgZGF5cyAgICAgICAgID0gYWJzJDEodGhpcy5fZGF5cyk7CiAgICB2YXIgbW9udGhzICAgICAgID0gYWJzJDEodGhpcy5fbW9udGhzKTsKICAgIHZhciBtaW51dGVzLCBob3VycywgeWVhcnM7CgogICAgLy8gMzYwMCBzZWNvbmRzIC0+IDYwIG1pbnV0ZXMgLT4gMSBob3VyCiAgICBtaW51dGVzICAgICAgICAgICA9IGFic0Zsb29yKHNlY29uZHMgLyA2MCk7CiAgICBob3VycyAgICAgICAgICAgICA9IGFic0Zsb29yKG1pbnV0ZXMgLyA2MCk7CiAgICBzZWNvbmRzICU9IDYwOwogICAgbWludXRlcyAlPSA2MDsKCiAgICAvLyAxMiBtb250aHMgLT4gMSB5ZWFyCiAgICB5ZWFycyAgPSBhYnNGbG9vcihtb250aHMgLyAxMik7CiAgICBtb250aHMgJT0gMTI7CgoKICAgIC8vIGluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9kb3JkaWxsZS9tb21lbnQtaXNvZHVyYXRpb24vYmxvYi9tYXN0ZXIvbW9tZW50Lmlzb2R1cmF0aW9uLmpzCiAgICB2YXIgWSA9IHllYXJzOwogICAgdmFyIE0gPSBtb250aHM7CiAgICB2YXIgRCA9IGRheXM7CiAgICB2YXIgaCA9IGhvdXJzOwogICAgdmFyIG0gPSBtaW51dGVzOwogICAgdmFyIHMgPSBzZWNvbmRzID8gc2Vjb25kcy50b0ZpeGVkKDMpLnJlcGxhY2UoL1wuPzArJC8sICcnKSA6ICcnOwogICAgdmFyIHRvdGFsID0gdGhpcy5hc1NlY29uZHMoKTsKCiAgICBpZiAoIXRvdGFsKSB7CiAgICAgICAgLy8gdGhpcyBpcyB0aGUgc2FtZSBhcyBDIydzIChOb2RhKSBhbmQgcHl0aG9uIChpc29kYXRlKS4uLgogICAgICAgIC8vIGJ1dCBub3Qgb3RoZXIgSlMgKGdvb2cuZGF0ZSkKICAgICAgICByZXR1cm4gJ1AwRCc7CiAgICB9CgogICAgdmFyIHRvdGFsU2lnbiA9IHRvdGFsIDwgMCA/ICctJyA6ICcnOwogICAgdmFyIHltU2lnbiA9IHNpZ24odGhpcy5fbW9udGhzKSAhPT0gc2lnbih0b3RhbCkgPyAnLScgOiAnJzsKICAgIHZhciBkYXlzU2lnbiA9IHNpZ24odGhpcy5fZGF5cykgIT09IHNpZ24odG90YWwpID8gJy0nIDogJyc7CiAgICB2YXIgaG1zU2lnbiA9IHNpZ24odGhpcy5fbWlsbGlzZWNvbmRzKSAhPT0gc2lnbih0b3RhbCkgPyAnLScgOiAnJzsKCiAgICByZXR1cm4gdG90YWxTaWduICsgJ1AnICsKICAgICAgICAoWSA/IHltU2lnbiArIFkgKyAnWScgOiAnJykgKwogICAgICAgIChNID8geW1TaWduICsgTSArICdNJyA6ICcnKSArCiAgICAgICAgKEQgPyBkYXlzU2lnbiArIEQgKyAnRCcgOiAnJykgKwogICAgICAgICgoaCB8fCBtIHx8IHMpID8gJ1QnIDogJycpICsKICAgICAgICAoaCA/IGhtc1NpZ24gKyBoICsgJ0gnIDogJycpICsKICAgICAgICAobSA/IGhtc1NpZ24gKyBtICsgJ00nIDogJycpICsKICAgICAgICAocyA/IGhtc1NpZ24gKyBzICsgJ1MnIDogJycpOwp9Cgp2YXIgcHJvdG8kMiA9IER1cmF0aW9uLnByb3RvdHlwZTsKCnByb3RvJDIuaXNWYWxpZCAgICAgICAgPSBpc1ZhbGlkJDE7CnByb3RvJDIuYWJzICAgICAgICAgICAgPSBhYnM7CnByb3RvJDIuYWRkICAgICAgICAgICAgPSBhZGQkMTsKcHJvdG8kMi5zdWJ0cmFjdCAgICAgICA9IHN1YnRyYWN0JDE7CnByb3RvJDIuYXMgICAgICAgICAgICAgPSBhczsKcHJvdG8kMi5hc01pbGxpc2Vjb25kcyA9IGFzTWlsbGlzZWNvbmRzOwpwcm90byQyLmFzU2Vjb25kcyAgICAgID0gYXNTZWNvbmRzOwpwcm90byQyLmFzTWludXRlcyAgICAgID0gYXNNaW51dGVzOwpwcm90byQyLmFzSG91cnMgICAgICAgID0gYXNIb3VyczsKcHJvdG8kMi5hc0RheXMgICAgICAgICA9IGFzRGF5czsKcHJvdG8kMi5hc1dlZWtzICAgICAgICA9IGFzV2Vla3M7CnByb3RvJDIuYXNNb250aHMgICAgICAgPSBhc01vbnRoczsKcHJvdG8kMi5hc1llYXJzICAgICAgICA9IGFzWWVhcnM7CnByb3RvJDIudmFsdWVPZiAgICAgICAgPSB2YWx1ZU9mJDE7CnByb3RvJDIuX2J1YmJsZSAgICAgICAgPSBidWJibGU7CnByb3RvJDIuY2xvbmUgICAgICAgICAgPSBjbG9uZSQxOwpwcm90byQyLmdldCAgICAgICAgICAgID0gZ2V0JDI7CnByb3RvJDIubWlsbGlzZWNvbmRzICAgPSBtaWxsaXNlY29uZHM7CnByb3RvJDIuc2Vjb25kcyAgICAgICAgPSBzZWNvbmRzOwpwcm90byQyLm1pbnV0ZXMgICAgICAgID0gbWludXRlczsKcHJvdG8kMi5ob3VycyAgICAgICAgICA9IGhvdXJzOwpwcm90byQyLmRheXMgICAgICAgICAgID0gZGF5czsKcHJvdG8kMi53ZWVrcyAgICAgICAgICA9IHdlZWtzOwpwcm90byQyLm1vbnRocyAgICAgICAgID0gbW9udGhzOwpwcm90byQyLnllYXJzICAgICAgICAgID0geWVhcnM7CnByb3RvJDIuaHVtYW5pemUgICAgICAgPSBodW1hbml6ZTsKcHJvdG8kMi50b0lTT1N0cmluZyAgICA9IHRvSVNPU3RyaW5nJDE7CnByb3RvJDIudG9TdHJpbmcgICAgICAgPSB0b0lTT1N0cmluZyQxOwpwcm90byQyLnRvSlNPTiAgICAgICAgID0gdG9JU09TdHJpbmckMTsKcHJvdG8kMi5sb2NhbGUgICAgICAgICA9IGxvY2FsZTsKcHJvdG8kMi5sb2NhbGVEYXRhICAgICA9IGxvY2FsZURhdGE7CgovLyBEZXByZWNhdGlvbnMKcHJvdG8kMi50b0lzb1N0cmluZyA9IGRlcHJlY2F0ZSgndG9Jc29TdHJpbmcoKSBpcyBkZXByZWNhdGVkLiBQbGVhc2UgdXNlIHRvSVNPU3RyaW5nKCkgaW5zdGVhZCAobm90aWNlIHRoZSBjYXBpdGFscyknLCB0b0lTT1N0cmluZyQxKTsKcHJvdG8kMi5sYW5nID0gbGFuZzsKCi8vIFNpZGUgZWZmZWN0IGltcG9ydHMKCi8vIEZPUk1BVFRJTkcKCmFkZEZvcm1hdFRva2VuKCdYJywgMCwgMCwgJ3VuaXgnKTsKYWRkRm9ybWF0VG9rZW4oJ3gnLCAwLCAwLCAndmFsdWVPZicpOwoKLy8gUEFSU0lORwoKYWRkUmVnZXhUb2tlbigneCcsIG1hdGNoU2lnbmVkKTsKYWRkUmVnZXhUb2tlbignWCcsIG1hdGNoVGltZXN0YW1wKTsKYWRkUGFyc2VUb2tlbignWCcsIGZ1bmN0aW9uIChpbnB1dCwgYXJyYXksIGNvbmZpZykgewogICAgY29uZmlnLl9kID0gbmV3IERhdGUocGFyc2VGbG9hdChpbnB1dCwgMTApICogMTAwMCk7Cn0pOwphZGRQYXJzZVRva2VuKCd4JywgZnVuY3Rpb24gKGlucHV0LCBhcnJheSwgY29uZmlnKSB7CiAgICBjb25maWcuX2QgPSBuZXcgRGF0ZSh0b0ludChpbnB1dCkpOwp9KTsKCi8vIFNpZGUgZWZmZWN0IGltcG9ydHMKCgpob29rcy52ZXJzaW9uID0gJzIuMjAuMSc7CgpzZXRIb29rQ2FsbGJhY2soY3JlYXRlTG9jYWwpOwoKaG9va3MuZm4gICAgICAgICAgICAgICAgICAgID0gcHJvdG87Cmhvb2tzLm1pbiAgICAgICAgICAgICAgICAgICA9IG1pbjsKaG9va3MubWF4ICAgICAgICAgICAgICAgICAgID0gbWF4Owpob29rcy5ub3cgICAgICAgICAgICAgICAgICAgPSBub3c7Cmhvb2tzLnV0YyAgICAgICAgICAgICAgICAgICA9IGNyZWF0ZVVUQzsKaG9va3MudW5peCAgICAgICAgICAgICAgICAgID0gY3JlYXRlVW5peDsKaG9va3MubW9udGhzICAgICAgICAgICAgICAgID0gbGlzdE1vbnRoczsKaG9va3MuaXNEYXRlICAgICAgICAgICAgICAgID0gaXNEYXRlOwpob29rcy5sb2NhbGUgICAgICAgICAgICAgICAgPSBnZXRTZXRHbG9iYWxMb2NhbGU7Cmhvb2tzLmludmFsaWQgICAgICAgICAgICAgICA9IGNyZWF0ZUludmFsaWQ7Cmhvb2tzLmR1cmF0aW9uICAgICAgICAgICAgICA9IGNyZWF0ZUR1cmF0aW9uOwpob29rcy5pc01vbWVudCAgICAgICAgICAgICAgPSBpc01vbWVudDsKaG9va3Mud2Vla2RheXMgICAgICAgICAgICAgID0gbGlzdFdlZWtkYXlzOwpob29rcy5wYXJzZVpvbmUgICAgICAgICAgICAgPSBjcmVhdGVJblpvbmU7Cmhvb2tzLmxvY2FsZURhdGEgICAgICAgICAgICA9IGdldExvY2FsZTsKaG9va3MuaXNEdXJhdGlvbiAgICAgICAgICAgID0gaXNEdXJhdGlvbjsKaG9va3MubW9udGhzU2hvcnQgICAgICAgICAgID0gbGlzdE1vbnRoc1Nob3J0Owpob29rcy53ZWVrZGF5c01pbiAgICAgICAgICAgPSBsaXN0V2Vla2RheXNNaW47Cmhvb2tzLmRlZmluZUxvY2FsZSAgICAgICAgICA9IGRlZmluZUxvY2FsZTsKaG9va3MudXBkYXRlTG9jYWxlICAgICAgICAgID0gdXBkYXRlTG9jYWxlOwpob29rcy5sb2NhbGVzICAgICAgICAgICAgICAgPSBsaXN0TG9jYWxlczsKaG9va3Mud2Vla2RheXNTaG9ydCAgICAgICAgID0gbGlzdFdlZWtkYXlzU2hvcnQ7Cmhvb2tzLm5vcm1hbGl6ZVVuaXRzICAgICAgICA9IG5vcm1hbGl6ZVVuaXRzOwpob29rcy5yZWxhdGl2ZVRpbWVSb3VuZGluZyAgPSBnZXRTZXRSZWxhdGl2ZVRpbWVSb3VuZGluZzsKaG9va3MucmVsYXRpdmVUaW1lVGhyZXNob2xkID0gZ2V0U2V0UmVsYXRpdmVUaW1lVGhyZXNob2xkOwpob29rcy5jYWxlbmRhckZvcm1hdCAgICAgICAgPSBnZXRDYWxlbmRhckZvcm1hdDsKaG9va3MucHJvdG90eXBlICAgICAgICAgICAgID0gcHJvdG87CgovLyBjdXJyZW50bHkgSFRNTDUgaW5wdXQgdHlwZSBvbmx5IHN1cHBvcnRzIDI0LWhvdXIgZm9ybWF0cwpob29rcy5IVE1MNV9GTVQgPSB7CiAgICBEQVRFVElNRV9MT0NBTDogJ1lZWVktTU0tRERUSEg6bW0nLCAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIC8+CiAgICBEQVRFVElNRV9MT0NBTF9TRUNPTkRTOiAnWVlZWS1NTS1ERFRISDptbTpzcycsICAvLyA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIHN0ZXA9IjEiIC8+CiAgICBEQVRFVElNRV9MT0NBTF9NUzogJ1lZWVktTU0tRERUSEg6bW06c3MuU1NTJywgICAvLyA8aW5wdXQgdHlwZT0iZGF0ZXRpbWUtbG9jYWwiIHN0ZXA9IjAuMDAxIiAvPgogICAgREFURTogJ1lZWVktTU0tREQnLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPGlucHV0IHR5cGU9ImRhdGUiIC8+CiAgICBUSU1FOiAnSEg6bW0nLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0idGltZSIgLz4KICAgIFRJTUVfU0VDT05EUzogJ0hIOm1tOnNzJywgICAgICAgICAgICAgICAgICAgICAgIC8vIDxpbnB1dCB0eXBlPSJ0aW1lIiBzdGVwPSIxIiAvPgogICAgVElNRV9NUzogJ0hIOm1tOnNzLlNTUycsICAgICAgICAgICAgICAgICAgICAgICAgLy8gPGlucHV0IHR5cGU9InRpbWUiIHN0ZXA9IjAuMDAxIiAvPgogICAgV0VFSzogJ1lZWVktW1ddV1cnLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gPGlucHV0IHR5cGU9IndlZWsiIC8+CiAgICBNT05USDogJ1lZWVktTU0nICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA8aW5wdXQgdHlwZT0ibW9udGgiIC8+Cn07CgpyZXR1cm4gaG9va3M7Cgp9KSkpOwoKfSx7fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBAbmFtZXNwYWNlIENoYXJ0CiAqLwp2YXIgQ2hhcnQgPSByZXF1aXJlKDI5KSgpOwoKQ2hhcnQuaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKLy8gQHRvZG8gZGlzcGF0Y2ggdGhlc2UgaGVscGVycyBpbnRvIGFwcHJvcHJpYXRlZCBoZWxwZXJzL2hlbHBlcnMuKiBmaWxlIGFuZCB3cml0ZSB1bml0IHRlc3RzIQpyZXF1aXJlKDI3KShDaGFydCk7CgpDaGFydC5kZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwpDaGFydC5FbGVtZW50ID0gcmVxdWlyZSgyNik7CkNoYXJ0LmVsZW1lbnRzID0gcmVxdWlyZSg0MCk7CkNoYXJ0LkludGVyYWN0aW9uID0gcmVxdWlyZSgyOCk7CkNoYXJ0LmxheW91dHMgPSByZXF1aXJlKDMwKTsKQ2hhcnQucGxhdGZvcm0gPSByZXF1aXJlKDQ4KTsKQ2hhcnQucGx1Z2lucyA9IHJlcXVpcmUoMzEpOwpDaGFydC5UaWNrcyA9IHJlcXVpcmUoMzQpOwoKcmVxdWlyZSgyMikoQ2hhcnQpOwpyZXF1aXJlKDIzKShDaGFydCk7CnJlcXVpcmUoMjQpKENoYXJ0KTsKcmVxdWlyZSgzMykoQ2hhcnQpOwpyZXF1aXJlKDMyKShDaGFydCk7CnJlcXVpcmUoMzUpKENoYXJ0KTsKCnJlcXVpcmUoNTUpKENoYXJ0KTsKcmVxdWlyZSg1MykoQ2hhcnQpOwpyZXF1aXJlKDU0KShDaGFydCk7CnJlcXVpcmUoNTYpKENoYXJ0KTsKcmVxdWlyZSg1NykoQ2hhcnQpOwpyZXF1aXJlKDU4KShDaGFydCk7CgovLyBDb250cm9sbGVycyBtdXN0IGJlIGxvYWRlZCBhZnRlciBlbGVtZW50cwovLyBTZWUgQ2hhcnQuY29yZS5kYXRhc2V0Q29udHJvbGxlci5kYXRhRWxlbWVudFR5cGUKcmVxdWlyZSgxNSkoQ2hhcnQpOwpyZXF1aXJlKDE2KShDaGFydCk7CnJlcXVpcmUoMTcpKENoYXJ0KTsKcmVxdWlyZSgxOCkoQ2hhcnQpOwpyZXF1aXJlKDE5KShDaGFydCk7CnJlcXVpcmUoMjApKENoYXJ0KTsKcmVxdWlyZSgyMSkoQ2hhcnQpOwoKcmVxdWlyZSg4KShDaGFydCk7CnJlcXVpcmUoOSkoQ2hhcnQpOwpyZXF1aXJlKDEwKShDaGFydCk7CnJlcXVpcmUoMTEpKENoYXJ0KTsKcmVxdWlyZSgxMikoQ2hhcnQpOwpyZXF1aXJlKDEzKShDaGFydCk7CnJlcXVpcmUoMTQpKENoYXJ0KTsKCi8vIExvYWRpbmcgYnVpbHQtaXQgcGx1Z2lucwp2YXIgcGx1Z2lucyA9IHJlcXVpcmUoNDkpOwpmb3IgKHZhciBrIGluIHBsdWdpbnMpIHsKCWlmIChwbHVnaW5zLmhhc093blByb3BlcnR5KGspKSB7CgkJQ2hhcnQucGx1Z2lucy5yZWdpc3RlcihwbHVnaW5zW2tdKTsKCX0KfQoKQ2hhcnQucGxhdGZvcm0uaW5pdGlhbGl6ZSgpOwoKbW9kdWxlLmV4cG9ydHMgPSBDaGFydDsKaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7Cgl3aW5kb3cuQ2hhcnQgPSBDaGFydDsKfQoKLy8gREVQUkVDQVRJT05TCgovKioKICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIG5vdCBhdmFpbGFibGUgYW55bW9yZQogKiBAbmFtZXNwYWNlIENoYXJ0LkxlZ2VuZAogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuMS41CiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCkNoYXJ0LkxlZ2VuZCA9IHBsdWdpbnMubGVnZW5kLl9lbGVtZW50OwoKLyoqCiAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBub3QgYXZhaWxhYmxlIGFueW1vcmUKICogQG5hbWVzcGFjZSBDaGFydC5UaXRsZQogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuMS41CiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCkNoYXJ0LlRpdGxlID0gcGx1Z2lucy50aXRsZS5fZWxlbWVudDsKCi8qKgogKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LnBsdWdpbnMgaW5zdGVhZAogKiBAbmFtZXNwYWNlIENoYXJ0LnBsdWdpblNlcnZpY2UKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjEuNQogKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCiAqIEBwcml2YXRlCiAqLwpDaGFydC5wbHVnaW5TZXJ2aWNlID0gQ2hhcnQucGx1Z2luczsKCi8qKgogKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgaW5oZXJpdGluZyBmcm9tIENoYXJ0LlBsdWdpbmdCYXNlIGhhcyBubwogKiBlZmZlY3QsIGluc3RlYWQgc2ltcGx5IGNyZWF0ZS9yZWdpc3RlciBwbHVnaW5zIHZpYSBwbGFpbiBKYXZhU2NyaXB0IG9iamVjdHMuCiAqIEBpbnRlcmZhY2UgQ2hhcnQuUGx1Z2luQmFzZQogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNS4wCiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCkNoYXJ0LlBsdWdpbkJhc2UgPSBDaGFydC5FbGVtZW50LmV4dGVuZCh7fSk7CgovKioKICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydC5oZWxwZXJzLmNhbnZhcyBpbnN0ZWFkLgogKiBAbmFtZXNwYWNlIENoYXJ0LmNhbnZhc0hlbHBlcnMKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjYuMAogKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCiAqIEBwcml2YXRlCiAqLwpDaGFydC5jYW52YXNIZWxwZXJzID0gQ2hhcnQuaGVscGVycy5jYW52YXM7CgovKioKICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydC5sYXlvdXRzIGluc3RlYWQuCiAqIEBuYW1lc3BhY2UgQ2hhcnQubGF5b3V0U2VydmljZQogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuOC4wCiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCkNoYXJ0LmxheW91dFNlcnZpY2UgPSBDaGFydC5sYXlvdXRzOwoKfSx7IjEwIjoxMCwiMTEiOjExLCIxMiI6MTIsIjEzIjoxMywiMTQiOjE0LCIxNSI6MTUsIjE2IjoxNiwiMTciOjE3LCIxOCI6MTgsIjE5IjoxOSwiMjAiOjIwLCIyMSI6MjEsIjIyIjoyMiwiMjMiOjIzLCIyNCI6MjQsIjI1IjoyNSwiMjYiOjI2LCIyNyI6MjcsIjI4IjoyOCwiMjkiOjI5LCIzMCI6MzAsIjMxIjozMSwiMzIiOjMyLCIzMyI6MzMsIjM0IjozNCwiMzUiOjM1LCI0MCI6NDAsIjQ1Ijo0NSwiNDgiOjQ4LCI0OSI6NDksIjUzIjo1MywiNTQiOjU0LCI1NSI6NTUsIjU2Ijo1NiwiNTciOjU3LCI1OCI6NTgsIjgiOjgsIjkiOjl9XSw4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCUNoYXJ0LkJhciA9IGZ1bmN0aW9uKGNvbnRleHQsIGNvbmZpZykgewoJCWNvbmZpZy50eXBlID0gJ2Jhcic7CgoJCXJldHVybiBuZXcgQ2hhcnQoY29udGV4dCwgY29uZmlnKTsKCX07Cgp9OwoKfSx7fV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCglDaGFydC5CdWJibGUgPSBmdW5jdGlvbihjb250ZXh0LCBjb25maWcpIHsKCQljb25maWcudHlwZSA9ICdidWJibGUnOwoJCXJldHVybiBuZXcgQ2hhcnQoY29udGV4dCwgY29uZmlnKTsKCX07Cgp9OwoKfSx7fV0sMTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJQ2hhcnQuRG91Z2hudXQgPSBmdW5jdGlvbihjb250ZXh0LCBjb25maWcpIHsKCQljb25maWcudHlwZSA9ICdkb3VnaG51dCc7CgoJCXJldHVybiBuZXcgQ2hhcnQoY29udGV4dCwgY29uZmlnKTsKCX07Cgp9OwoKfSx7fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJQ2hhcnQuTGluZSA9IGZ1bmN0aW9uKGNvbnRleHQsIGNvbmZpZykgewoJCWNvbmZpZy50eXBlID0gJ2xpbmUnOwoKCQlyZXR1cm4gbmV3IENoYXJ0KGNvbnRleHQsIGNvbmZpZyk7Cgl9OwoKfTsKCn0se31dLDEyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCUNoYXJ0LlBvbGFyQXJlYSA9IGZ1bmN0aW9uKGNvbnRleHQsIGNvbmZpZykgewoJCWNvbmZpZy50eXBlID0gJ3BvbGFyQXJlYSc7CgoJCXJldHVybiBuZXcgQ2hhcnQoY29udGV4dCwgY29uZmlnKTsKCX07Cgp9OwoKfSx7fV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJQ2hhcnQuUmFkYXIgPSBmdW5jdGlvbihjb250ZXh0LCBjb25maWcpIHsKCQljb25maWcudHlwZSA9ICdyYWRhcic7CgoJCXJldHVybiBuZXcgQ2hhcnQoY29udGV4dCwgY29uZmlnKTsKCX07Cgp9OwoKfSx7fV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CglDaGFydC5TY2F0dGVyID0gZnVuY3Rpb24oY29udGV4dCwgY29uZmlnKSB7CgkJY29uZmlnLnR5cGUgPSAnc2NhdHRlcic7CgkJcmV0dXJuIG5ldyBDaGFydChjb250ZXh0LCBjb25maWcpOwoJfTsKfTsKCn0se31dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGRlZmF1bHRzID0gcmVxdWlyZSgyNSk7CnZhciBlbGVtZW50cyA9IHJlcXVpcmUoNDApOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKZGVmYXVsdHMuX3NldCgnYmFyJywgewoJaG92ZXI6IHsKCQltb2RlOiAnbGFiZWwnCgl9LAoKCXNjYWxlczogewoJCXhBeGVzOiBbewoJCQl0eXBlOiAnY2F0ZWdvcnknLAoKCQkJLy8gU3BlY2lmaWMgdG8gQmFyIENvbnRyb2xsZXIKCQkJY2F0ZWdvcnlQZXJjZW50YWdlOiAwLjgsCgkJCWJhclBlcmNlbnRhZ2U6IDAuOSwKCgkJCS8vIG9mZnNldCBzZXR0aW5ncwoJCQlvZmZzZXQ6IHRydWUsCgoJCQkvLyBncmlkIGxpbmUgc2V0dGluZ3MKCQkJZ3JpZExpbmVzOiB7CgkJCQlvZmZzZXRHcmlkTGluZXM6IHRydWUKCQkJfQoJCX1dLAoKCQl5QXhlczogW3sKCQkJdHlwZTogJ2xpbmVhcicKCQl9XQoJfQp9KTsKCmRlZmF1bHRzLl9zZXQoJ2hvcml6b250YWxCYXInLCB7Cglob3ZlcjogewoJCW1vZGU6ICdpbmRleCcsCgkJYXhpczogJ3knCgl9LAoKCXNjYWxlczogewoJCXhBeGVzOiBbewoJCQl0eXBlOiAnbGluZWFyJywKCQkJcG9zaXRpb246ICdib3R0b20nCgkJfV0sCgoJCXlBeGVzOiBbewoJCQlwb3NpdGlvbjogJ2xlZnQnLAoJCQl0eXBlOiAnY2F0ZWdvcnknLAoKCQkJLy8gU3BlY2lmaWMgdG8gSG9yaXpvbnRhbCBCYXIgQ29udHJvbGxlcgoJCQljYXRlZ29yeVBlcmNlbnRhZ2U6IDAuOCwKCQkJYmFyUGVyY2VudGFnZTogMC45LAoKCQkJLy8gb2Zmc2V0IHNldHRpbmdzCgkJCW9mZnNldDogdHJ1ZSwKCgkJCS8vIGdyaWQgbGluZSBzZXR0aW5ncwoJCQlncmlkTGluZXM6IHsKCQkJCW9mZnNldEdyaWRMaW5lczogdHJ1ZQoJCQl9CgkJfV0KCX0sCgoJZWxlbWVudHM6IHsKCQlyZWN0YW5nbGU6IHsKCQkJYm9yZGVyU2tpcHBlZDogJ2xlZnQnCgkJfQoJfSwKCgl0b29sdGlwczogewoJCWNhbGxiYWNrczogewoJCQl0aXRsZTogZnVuY3Rpb24oaXRlbSwgZGF0YSkgewoJCQkJLy8gUGljayBmaXJzdCB4TGFiZWwgZm9yIG5vdwoJCQkJdmFyIHRpdGxlID0gJyc7CgoJCQkJaWYgKGl0ZW0ubGVuZ3RoID4gMCkgewoJCQkJCWlmIChpdGVtWzBdLnlMYWJlbCkgewoJCQkJCQl0aXRsZSA9IGl0ZW1bMF0ueUxhYmVsOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5sYWJlbHMubGVuZ3RoID4gMCAmJiBpdGVtWzBdLmluZGV4IDwgZGF0YS5sYWJlbHMubGVuZ3RoKSB7CgkJCQkJCXRpdGxlID0gZGF0YS5sYWJlbHNbaXRlbVswXS5pbmRleF07CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiB0aXRsZTsKCQkJfSwKCgkJCWxhYmVsOiBmdW5jdGlvbihpdGVtLCBkYXRhKSB7CgkJCQl2YXIgZGF0YXNldExhYmVsID0gZGF0YS5kYXRhc2V0c1tpdGVtLmRhdGFzZXRJbmRleF0ubGFiZWwgfHwgJyc7CgkJCQlyZXR1cm4gZGF0YXNldExhYmVsICsgJzogJyArIGl0ZW0ueExhYmVsOwoJCQl9CgkJfSwKCQltb2RlOiAnaW5kZXgnLAoJCWF4aXM6ICd5JwoJfQp9KTsKCi8qKgogKiBDb21wdXRlcyB0aGUgIm9wdGltYWwiIHNhbXBsZSBzaXplIHRvIG1haW50YWluIGJhcnMgZXF1YWxseSBzaXplZCB3aGlsZSBwcmV2ZW50aW5nIG92ZXJsYXAuCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBjb21wdXRlTWluU2FtcGxlU2l6ZShzY2FsZSwgcGl4ZWxzKSB7Cgl2YXIgbWluID0gc2NhbGUuaXNIb3Jpem9udGFsKCkgPyBzY2FsZS53aWR0aCA6IHNjYWxlLmhlaWdodDsKCXZhciB0aWNrcyA9IHNjYWxlLmdldFRpY2tzKCk7Cgl2YXIgcHJldiwgY3VyciwgaSwgaWxlbjsKCglmb3IgKGkgPSAxLCBpbGVuID0gcGl4ZWxzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCW1pbiA9IE1hdGgubWluKG1pbiwgcGl4ZWxzW2ldIC0gcGl4ZWxzW2kgLSAxXSk7Cgl9CgoJZm9yIChpID0gMCwgaWxlbiA9IHRpY2tzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCWN1cnIgPSBzY2FsZS5nZXRQaXhlbEZvclRpY2soaSk7CgkJbWluID0gaSA+IDAgPyBNYXRoLm1pbihtaW4sIGN1cnIgLSBwcmV2KSA6IG1pbjsKCQlwcmV2ID0gY3VycjsKCX0KCglyZXR1cm4gbWluOwp9CgovKioKICogQ29tcHV0ZXMgYW4gImlkZWFsIiBjYXRlZ29yeSBiYXNlZCBvbiB0aGUgYWJzb2x1dGUgYmFyIHRoaWNrbmVzcyBvciwgaWYgdW5kZWZpbmVkIG9yIG51bGwsCiAqIHVzZXMgdGhlIHNtYWxsZXN0IGludGVydmFsIChzZWUgY29tcHV0ZU1pblNhbXBsZVNpemUpIHRoYXQgcHJldmVudHMgYmFyIG92ZXJsYXBwaW5nLiBUaGlzCiAqIG1vZGUgY3VycmVudGx5IGFsd2F5cyBnZW5lcmF0ZXMgYmFycyBlcXVhbGx5IHNpemVkICh1bnRpbCB3ZSBpbnRyb2R1Y2Ugc2NyaXB0YWJsZSBvcHRpb25zPykuCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBjb21wdXRlRml0Q2F0ZWdvcnlUcmFpdHMoaW5kZXgsIHJ1bGVyLCBvcHRpb25zKSB7Cgl2YXIgdGhpY2tuZXNzID0gb3B0aW9ucy5iYXJUaGlja25lc3M7Cgl2YXIgY291bnQgPSBydWxlci5zdGFja0NvdW50OwoJdmFyIGN1cnIgPSBydWxlci5waXhlbHNbaW5kZXhdOwoJdmFyIHNpemUsIHJhdGlvOwoKCWlmIChoZWxwZXJzLmlzTnVsbE9yVW5kZWYodGhpY2tuZXNzKSkgewoJCXNpemUgPSBydWxlci5taW4gKiBvcHRpb25zLmNhdGVnb3J5UGVyY2VudGFnZTsKCQlyYXRpbyA9IG9wdGlvbnMuYmFyUGVyY2VudGFnZTsKCX0gZWxzZSB7CgkJLy8gV2hlbiBiYXIgdGhpY2tuZXNzIGlzIGVuZm9yY2VkLCBjYXRlZ29yeSBhbmQgYmFyIHBlcmNlbnRhZ2VzIGFyZSBpZ25vcmVkLgoJCS8vIE5vdGUoU0IpOiB3ZSBjb3VsZCBhZGQgc3VwcG9ydCBmb3IgcmVsYXRpdmUgYmFyIHRoaWNrbmVzcyAoZS5nLiBiYXJUaGlja25lc3M6ICc1MCUnKQoJCS8vIGFuZCBkZXByZWNhdGUgYmFyUGVyY2VudGFnZSBzaW5jZSB0aGlzIHZhbHVlIGlzIGlnbm9yZWQgd2hlbiB0aGlja25lc3MgaXMgYWJzb2x1dGUuCgkJc2l6ZSA9IHRoaWNrbmVzcyAqIGNvdW50OwoJCXJhdGlvID0gMTsKCX0KCglyZXR1cm4gewoJCWNodW5rOiBzaXplIC8gY291bnQsCgkJcmF0aW86IHJhdGlvLAoJCXN0YXJ0OiBjdXJyIC0gKHNpemUgLyAyKQoJfTsKfQoKLyoqCiAqIENvbXB1dGVzIGFuICJvcHRpbWFsIiBjYXRlZ29yeSB0aGF0IGdsb2JhbGx5IGFycmFuZ2VzIGJhcnMgc2lkZSBieSBzaWRlIChubyBnYXAgd2hlbgogKiBwZXJjZW50YWdlIG9wdGlvbnMgYXJlIDEpLCBiYXNlZCBvbiB0aGUgcHJldmlvdXMgYW5kIGZvbGxvd2luZyBjYXRlZ29yaWVzLiBUaGlzIG1vZGUKICogZ2VuZXJhdGVzIGJhcnMgd2l0aCBkaWZmZXJlbnQgd2lkdGhzIHdoZW4gZGF0YSBhcmUgbm90IGV2ZW5seSBzcGFjZWQuCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBjb21wdXRlRmxleENhdGVnb3J5VHJhaXRzKGluZGV4LCBydWxlciwgb3B0aW9ucykgewoJdmFyIHBpeGVscyA9IHJ1bGVyLnBpeGVsczsKCXZhciBjdXJyID0gcGl4ZWxzW2luZGV4XTsKCXZhciBwcmV2ID0gaW5kZXggPiAwID8gcGl4ZWxzW2luZGV4IC0gMV0gOiBudWxsOwoJdmFyIG5leHQgPSBpbmRleCA8IHBpeGVscy5sZW5ndGggLSAxID8gcGl4ZWxzW2luZGV4ICsgMV0gOiBudWxsOwoJdmFyIHBlcmNlbnQgPSBvcHRpb25zLmNhdGVnb3J5UGVyY2VudGFnZTsKCXZhciBzdGFydCwgc2l6ZTsKCglpZiAocHJldiA9PT0gbnVsbCkgewoJCS8vIGZpcnN0IGRhdGE6IGl0cyBzaXplIGlzIGRvdWJsZSBiYXNlZCBvbiB0aGUgbmV4dCBwb2ludCBvciwKCQkvLyBpZiBpdCdzIGFsc28gdGhlIGxhc3QgZGF0YSwgd2UgdXNlIHRoZSBzY2FsZSBlbmQgZXh0cmVtaXR5LgoJCXByZXYgPSBjdXJyIC0gKG5leHQgPT09IG51bGwgPyBydWxlci5lbmQgLSBjdXJyIDogbmV4dCAtIGN1cnIpOwoJfQoKCWlmIChuZXh0ID09PSBudWxsKSB7CgkJLy8gbGFzdCBkYXRhOiBpdHMgc2l6ZSBpcyBhbHNvIGRvdWJsZSBiYXNlZCBvbiB0aGUgcHJldmlvdXMgcG9pbnQuCgkJbmV4dCA9IGN1cnIgKyBjdXJyIC0gcHJldjsKCX0KCglzdGFydCA9IGN1cnIgLSAoKGN1cnIgLSBwcmV2KSAvIDIpICogcGVyY2VudDsKCXNpemUgPSAoKG5leHQgLSBwcmV2KSAvIDIpICogcGVyY2VudDsKCglyZXR1cm4gewoJCWNodW5rOiBzaXplIC8gcnVsZXIuc3RhY2tDb3VudCwKCQlyYXRpbzogb3B0aW9ucy5iYXJQZXJjZW50YWdlLAoJCXN0YXJ0OiBzdGFydAoJfTsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCUNoYXJ0LmNvbnRyb2xsZXJzLmJhciA9IENoYXJ0LkRhdGFzZXRDb250cm9sbGVyLmV4dGVuZCh7CgoJCWRhdGFFbGVtZW50VHlwZTogZWxlbWVudHMuUmVjdGFuZ2xlLAoKCQlpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG1ldGE7CgoJCQlDaGFydC5EYXRhc2V0Q29udHJvbGxlci5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseShtZSwgYXJndW1lbnRzKTsKCgkJCW1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCW1ldGEuc3RhY2sgPSBtZS5nZXREYXRhc2V0KCkuc3RhY2s7CgkJCW1ldGEuYmFyID0gdHJ1ZTsKCQl9LAoKCQl1cGRhdGU6IGZ1bmN0aW9uKHJlc2V0KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciByZWN0cyA9IG1lLmdldE1ldGEoKS5kYXRhOwoJCQl2YXIgaSwgaWxlbjsKCgkJCW1lLl9ydWxlciA9IG1lLmdldFJ1bGVyKCk7CgoJCQlmb3IgKGkgPSAwLCBpbGVuID0gcmVjdHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQltZS51cGRhdGVFbGVtZW50KHJlY3RzW2ldLCBpLCByZXNldCk7CgkJCX0KCQl9LAoKCQl1cGRhdGVFbGVtZW50OiBmdW5jdGlvbihyZWN0YW5nbGUsIGluZGV4LCByZXNldCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgY2hhcnQgPSBtZS5jaGFydDsKCQkJdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCXZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpOwoJCQl2YXIgY3VzdG9tID0gcmVjdGFuZ2xlLmN1c3RvbSB8fCB7fTsKCQkJdmFyIHJlY3RhbmdsZU9wdGlvbnMgPSBjaGFydC5vcHRpb25zLmVsZW1lbnRzLnJlY3RhbmdsZTsKCgkJCXJlY3RhbmdsZS5feFNjYWxlID0gbWUuZ2V0U2NhbGVGb3JJZChtZXRhLnhBeGlzSUQpOwoJCQlyZWN0YW5nbGUuX3lTY2FsZSA9IG1lLmdldFNjYWxlRm9ySWQobWV0YS55QXhpc0lEKTsKCQkJcmVjdGFuZ2xlLl9kYXRhc2V0SW5kZXggPSBtZS5pbmRleDsKCQkJcmVjdGFuZ2xlLl9pbmRleCA9IGluZGV4OwoKCQkJcmVjdGFuZ2xlLl9tb2RlbCA9IHsKCQkJCWRhdGFzZXRMYWJlbDogZGF0YXNldC5sYWJlbCwKCQkJCWxhYmVsOiBjaGFydC5kYXRhLmxhYmVsc1tpbmRleF0sCgkJCQlib3JkZXJTa2lwcGVkOiBjdXN0b20uYm9yZGVyU2tpcHBlZCA/IGN1c3RvbS5ib3JkZXJTa2lwcGVkIDogcmVjdGFuZ2xlT3B0aW9ucy5ib3JkZXJTa2lwcGVkLAoJCQkJYmFja2dyb3VuZENvbG9yOiBjdXN0b20uYmFja2dyb3VuZENvbG9yID8gY3VzdG9tLmJhY2tncm91bmRDb2xvciA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQuYmFja2dyb3VuZENvbG9yLCBpbmRleCwgcmVjdGFuZ2xlT3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IpLAoJCQkJYm9yZGVyQ29sb3I6IGN1c3RvbS5ib3JkZXJDb2xvciA/IGN1c3RvbS5ib3JkZXJDb2xvciA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQuYm9yZGVyQ29sb3IsIGluZGV4LCByZWN0YW5nbGVPcHRpb25zLmJvcmRlckNvbG9yKSwKCQkJCWJvcmRlcldpZHRoOiBjdXN0b20uYm9yZGVyV2lkdGggPyBjdXN0b20uYm9yZGVyV2lkdGggOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LmJvcmRlcldpZHRoLCBpbmRleCwgcmVjdGFuZ2xlT3B0aW9ucy5ib3JkZXJXaWR0aCkKCQkJfTsKCgkJCW1lLnVwZGF0ZUVsZW1lbnRHZW9tZXRyeShyZWN0YW5nbGUsIGluZGV4LCByZXNldCk7CgoJCQlyZWN0YW5nbGUucGl2b3QoKTsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCXVwZGF0ZUVsZW1lbnRHZW9tZXRyeTogZnVuY3Rpb24ocmVjdGFuZ2xlLCBpbmRleCwgcmVzZXQpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG1vZGVsID0gcmVjdGFuZ2xlLl9tb2RlbDsKCQkJdmFyIHZzY2FsZSA9IG1lLmdldFZhbHVlU2NhbGUoKTsKCQkJdmFyIGJhc2UgPSB2c2NhbGUuZ2V0QmFzZVBpeGVsKCk7CgkJCXZhciBob3Jpem9udGFsID0gdnNjYWxlLmlzSG9yaXpvbnRhbCgpOwoJCQl2YXIgcnVsZXIgPSBtZS5fcnVsZXIgfHwgbWUuZ2V0UnVsZXIoKTsKCQkJdmFyIHZwaXhlbHMgPSBtZS5jYWxjdWxhdGVCYXJWYWx1ZVBpeGVscyhtZS5pbmRleCwgaW5kZXgpOwoJCQl2YXIgaXBpeGVscyA9IG1lLmNhbGN1bGF0ZUJhckluZGV4UGl4ZWxzKG1lLmluZGV4LCBpbmRleCwgcnVsZXIpOwoKCQkJbW9kZWwuaG9yaXpvbnRhbCA9IGhvcml6b250YWw7CgkJCW1vZGVsLmJhc2UgPSByZXNldCA/IGJhc2UgOiB2cGl4ZWxzLmJhc2U7CgkJCW1vZGVsLnggPSBob3Jpem9udGFsID8gcmVzZXQgPyBiYXNlIDogdnBpeGVscy5oZWFkIDogaXBpeGVscy5jZW50ZXI7CgkJCW1vZGVsLnkgPSBob3Jpem9udGFsID8gaXBpeGVscy5jZW50ZXIgOiByZXNldCA/IGJhc2UgOiB2cGl4ZWxzLmhlYWQ7CgkJCW1vZGVsLmhlaWdodCA9IGhvcml6b250YWwgPyBpcGl4ZWxzLnNpemUgOiB1bmRlZmluZWQ7CgkJCW1vZGVsLndpZHRoID0gaG9yaXpvbnRhbCA/IHVuZGVmaW5lZCA6IGlwaXhlbHMuc2l6ZTsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWdldFZhbHVlU2NhbGVJZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmdldE1ldGEoKS55QXhpc0lEOwoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJZ2V0SW5kZXhTY2FsZUlkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0TWV0YSgpLnhBeGlzSUQ7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlnZXRWYWx1ZVNjYWxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuZ2V0U2NhbGVGb3JJZCh0aGlzLmdldFZhbHVlU2NhbGVJZCgpKTsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWdldEluZGV4U2NhbGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5nZXRTY2FsZUZvcklkKHRoaXMuZ2V0SW5kZXhTY2FsZUlkKCkpOwoJCX0sCgoJCS8qKgoJCSAqIFJldHVybnMgdGhlIHN0YWNrcyBiYXNlZCBvbiBncm91cHMgYW5kIGJhciB2aXNpYmlsaXR5LgoJCSAqIEBwYXJhbSB7TnVtYmVyfSBbbGFzdF0gLSBUaGUgZGF0YXNldCBpbmRleAoJCSAqIEByZXR1cm5zIHtBcnJheX0gVGhlIHN0YWNrIGxpc3QKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCV9nZXRTdGFja3M6IGZ1bmN0aW9uKGxhc3QpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciBzY2FsZSA9IG1lLmdldEluZGV4U2NhbGUoKTsKCQkJdmFyIHN0YWNrZWQgPSBzY2FsZS5vcHRpb25zLnN0YWNrZWQ7CgkJCXZhciBpbGVuID0gbGFzdCA9PT0gdW5kZWZpbmVkID8gY2hhcnQuZGF0YS5kYXRhc2V0cy5sZW5ndGggOiBsYXN0ICsgMTsKCQkJdmFyIHN0YWNrcyA9IFtdOwoJCQl2YXIgaSwgbWV0YTsKCgkJCWZvciAoaSA9IDA7IGkgPCBpbGVuOyArK2kpIHsKCQkJCW1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShpKTsKCQkJCWlmIChtZXRhLmJhciAmJiBjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGkpICYmCgkJCQkJKHN0YWNrZWQgPT09IGZhbHNlIHx8CgkJCQkJKHN0YWNrZWQgPT09IHRydWUgJiYgc3RhY2tzLmluZGV4T2YobWV0YS5zdGFjaykgPT09IC0xKSB8fAoJCQkJCShzdGFja2VkID09PSB1bmRlZmluZWQgJiYgKG1ldGEuc3RhY2sgPT09IHVuZGVmaW5lZCB8fCBzdGFja3MuaW5kZXhPZihtZXRhLnN0YWNrKSA9PT0gLTEpKSkpIHsKCQkJCQlzdGFja3MucHVzaChtZXRhLnN0YWNrKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHN0YWNrczsKCQl9LAoKCQkvKioKCQkgKiBSZXR1cm5zIHRoZSBlZmZlY3RpdmUgbnVtYmVyIG9mIHN0YWNrcyBiYXNlZCBvbiBncm91cHMgYW5kIGJhciB2aXNpYmlsaXR5LgoJCSAqIEBwcml2YXRlCgkJICovCgkJZ2V0U3RhY2tDb3VudDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLl9nZXRTdGFja3MoKS5sZW5ndGg7CgkJfSwKCgkJLyoqCgkJICogUmV0dXJucyB0aGUgc3RhY2sgaW5kZXggZm9yIHRoZSBnaXZlbiBkYXRhc2V0IGJhc2VkIG9uIGdyb3VwcyBhbmQgYmFyIHZpc2liaWxpdHkuCgkJICogQHBhcmFtIHtOdW1iZXJ9IFtkYXRhc2V0SW5kZXhdIC0gVGhlIGRhdGFzZXQgaW5kZXgKCQkgKiBAcGFyYW0ge1N0cmluZ30gW25hbWVdIC0gVGhlIHN0YWNrIG5hbWUgdG8gZmluZAoJCSAqIEByZXR1cm5zIHtOdW1iZXJ9IFRoZSBzdGFjayBpbmRleAoJCSAqIEBwcml2YXRlCgkJICovCgkJZ2V0U3RhY2tJbmRleDogZnVuY3Rpb24oZGF0YXNldEluZGV4LCBuYW1lKSB7CgkJCXZhciBzdGFja3MgPSB0aGlzLl9nZXRTdGFja3MoZGF0YXNldEluZGV4KTsKCQkJdmFyIGluZGV4ID0gKG5hbWUgIT09IHVuZGVmaW5lZCkKCQkJCT8gc3RhY2tzLmluZGV4T2YobmFtZSkKCQkJCTogLTE7IC8vIGluZGV4T2YgcmV0dXJucyAtMSBpZiBlbGVtZW50IGlzIG5vdCBwcmVzZW50CgoJCQlyZXR1cm4gKGluZGV4ID09PSAtMSkKCQkJCT8gc3RhY2tzLmxlbmd0aCAtIDEKCQkJCTogaW5kZXg7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlnZXRSdWxlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBzY2FsZSA9IG1lLmdldEluZGV4U2NhbGUoKTsKCQkJdmFyIHN0YWNrQ291bnQgPSBtZS5nZXRTdGFja0NvdW50KCk7CgkJCXZhciBkYXRhc2V0SW5kZXggPSBtZS5pbmRleDsKCQkJdmFyIGlzSG9yaXpvbnRhbCA9IHNjYWxlLmlzSG9yaXpvbnRhbCgpOwoJCQl2YXIgc3RhcnQgPSBpc0hvcml6b250YWwgPyBzY2FsZS5sZWZ0IDogc2NhbGUudG9wOwoJCQl2YXIgZW5kID0gc3RhcnQgKyAoaXNIb3Jpem9udGFsID8gc2NhbGUud2lkdGggOiBzY2FsZS5oZWlnaHQpOwoJCQl2YXIgcGl4ZWxzID0gW107CgkJCXZhciBpLCBpbGVuLCBtaW47CgoJCQlmb3IgKGkgPSAwLCBpbGVuID0gbWUuZ2V0TWV0YSgpLmRhdGEubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQlwaXhlbHMucHVzaChzY2FsZS5nZXRQaXhlbEZvclZhbHVlKG51bGwsIGksIGRhdGFzZXRJbmRleCkpOwoJCQl9CgoJCQltaW4gPSBoZWxwZXJzLmlzTnVsbE9yVW5kZWYoc2NhbGUub3B0aW9ucy5iYXJUaGlja25lc3MpCgkJCQk/IGNvbXB1dGVNaW5TYW1wbGVTaXplKHNjYWxlLCBwaXhlbHMpCgkJCQk6IC0xOwoKCQkJcmV0dXJuIHsKCQkJCW1pbjogbWluLAoJCQkJcGl4ZWxzOiBwaXhlbHMsCgkJCQlzdGFydDogc3RhcnQsCgkJCQllbmQ6IGVuZCwKCQkJCXN0YWNrQ291bnQ6IHN0YWNrQ291bnQsCgkJCQlzY2FsZTogc2NhbGUKCQkJfTsKCQl9LAoKCQkvKioKCQkgKiBOb3RlOiBwaXhlbCB2YWx1ZXMgYXJlIG5vdCBjbGFtcGVkIHRvIHRoZSBzY2FsZSBhcmVhLgoJCSAqIEBwcml2YXRlCgkJICovCgkJY2FsY3VsYXRlQmFyVmFsdWVQaXhlbHM6IGZ1bmN0aW9uKGRhdGFzZXRJbmRleCwgaW5kZXgpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwoJCQl2YXIgc2NhbGUgPSBtZS5nZXRWYWx1ZVNjYWxlKCk7CgkJCXZhciBkYXRhc2V0cyA9IGNoYXJ0LmRhdGEuZGF0YXNldHM7CgkJCXZhciB2YWx1ZSA9IHNjYWxlLmdldFJpZ2h0VmFsdWUoZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhW2luZGV4XSk7CgkJCXZhciBzdGFja2VkID0gc2NhbGUub3B0aW9ucy5zdGFja2VkOwoJCQl2YXIgc3RhY2sgPSBtZXRhLnN0YWNrOwoJCQl2YXIgc3RhcnQgPSAwOwoJCQl2YXIgaSwgaW1ldGEsIGl2YWx1ZSwgYmFzZSwgaGVhZCwgc2l6ZTsKCgkJCWlmIChzdGFja2VkIHx8IChzdGFja2VkID09PSB1bmRlZmluZWQgJiYgc3RhY2sgIT09IHVuZGVmaW5lZCkpIHsKCQkJCWZvciAoaSA9IDA7IGkgPCBkYXRhc2V0SW5kZXg7ICsraSkgewoJCQkJCWltZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaSk7CgoJCQkJCWlmIChpbWV0YS5iYXIgJiYKCQkJCQkJaW1ldGEuc3RhY2sgPT09IHN0YWNrICYmCgkJCQkJCWltZXRhLmNvbnRyb2xsZXIuZ2V0VmFsdWVTY2FsZUlkKCkgPT09IHNjYWxlLmlkICYmCgkJCQkJCWNoYXJ0LmlzRGF0YXNldFZpc2libGUoaSkpIHsKCgkJCQkJCWl2YWx1ZSA9IHNjYWxlLmdldFJpZ2h0VmFsdWUoZGF0YXNldHNbaV0uZGF0YVtpbmRleF0pOwoJCQkJCQlpZiAoKHZhbHVlIDwgMCAmJiBpdmFsdWUgPCAwKSB8fCAodmFsdWUgPj0gMCAmJiBpdmFsdWUgPiAwKSkgewoJCQkJCQkJc3RhcnQgKz0gaXZhbHVlOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQliYXNlID0gc2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZShzdGFydCk7CgkJCWhlYWQgPSBzY2FsZS5nZXRQaXhlbEZvclZhbHVlKHN0YXJ0ICsgdmFsdWUpOwoJCQlzaXplID0gKGhlYWQgLSBiYXNlKSAvIDI7CgoJCQlyZXR1cm4gewoJCQkJc2l6ZTogc2l6ZSwKCQkJCWJhc2U6IGJhc2UsCgkJCQloZWFkOiBoZWFkLAoJCQkJY2VudGVyOiBoZWFkICsgc2l6ZSAvIDIKCQkJfTsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWNhbGN1bGF0ZUJhckluZGV4UGl4ZWxzOiBmdW5jdGlvbihkYXRhc2V0SW5kZXgsIGluZGV4LCBydWxlcikgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0aW9ucyA9IHJ1bGVyLnNjYWxlLm9wdGlvbnM7CgkJCXZhciByYW5nZSA9IG9wdGlvbnMuYmFyVGhpY2tuZXNzID09PSAnZmxleCcKCQkJCT8gY29tcHV0ZUZsZXhDYXRlZ29yeVRyYWl0cyhpbmRleCwgcnVsZXIsIG9wdGlvbnMpCgkJCQk6IGNvbXB1dGVGaXRDYXRlZ29yeVRyYWl0cyhpbmRleCwgcnVsZXIsIG9wdGlvbnMpOwoKCQkJdmFyIHN0YWNrSW5kZXggPSBtZS5nZXRTdGFja0luZGV4KGRhdGFzZXRJbmRleCwgbWUuZ2V0TWV0YSgpLnN0YWNrKTsKCQkJdmFyIGNlbnRlciA9IHJhbmdlLnN0YXJ0ICsgKHJhbmdlLmNodW5rICogc3RhY2tJbmRleCkgKyAocmFuZ2UuY2h1bmsgLyAyKTsKCQkJdmFyIHNpemUgPSBNYXRoLm1pbigKCQkJCWhlbHBlcnMudmFsdWVPckRlZmF1bHQob3B0aW9ucy5tYXhCYXJUaGlja25lc3MsIEluZmluaXR5KSwKCQkJCXJhbmdlLmNodW5rICogcmFuZ2UucmF0aW8pOwoKCQkJcmV0dXJuIHsKCQkJCWJhc2U6IGNlbnRlciAtIHNpemUgLyAyLAoJCQkJaGVhZDogY2VudGVyICsgc2l6ZSAvIDIsCgkJCQljZW50ZXI6IGNlbnRlciwKCQkJCXNpemU6IHNpemUKCQkJfTsKCQl9LAoKCQlkcmF3OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciBzY2FsZSA9IG1lLmdldFZhbHVlU2NhbGUoKTsKCQkJdmFyIHJlY3RzID0gbWUuZ2V0TWV0YSgpLmRhdGE7CgkJCXZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpOwoJCQl2YXIgaWxlbiA9IHJlY3RzLmxlbmd0aDsKCQkJdmFyIGkgPSAwOwoKCQkJaGVscGVycy5jYW52YXMuY2xpcEFyZWEoY2hhcnQuY3R4LCBjaGFydC5jaGFydEFyZWEpOwoKCQkJZm9yICg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCWlmICghaXNOYU4oc2NhbGUuZ2V0UmlnaHRWYWx1ZShkYXRhc2V0LmRhdGFbaV0pKSkgewoJCQkJCXJlY3RzW2ldLmRyYXcoKTsKCQkJCX0KCQkJfQoKCQkJaGVscGVycy5jYW52YXMudW5jbGlwQXJlYShjaGFydC5jdHgpOwoJCX0sCgoJCXNldEhvdmVyU3R5bGU6IGZ1bmN0aW9uKHJlY3RhbmdsZSkgewoJCQl2YXIgZGF0YXNldCA9IHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1tyZWN0YW5nbGUuX2RhdGFzZXRJbmRleF07CgkJCXZhciBpbmRleCA9IHJlY3RhbmdsZS5faW5kZXg7CgkJCXZhciBjdXN0b20gPSByZWN0YW5nbGUuY3VzdG9tIHx8IHt9OwoJCQl2YXIgbW9kZWwgPSByZWN0YW5nbGUuX21vZGVsOwoKCQkJbW9kZWwuYmFja2dyb3VuZENvbG9yID0gY3VzdG9tLmhvdmVyQmFja2dyb3VuZENvbG9yID8gY3VzdG9tLmhvdmVyQmFja2dyb3VuZENvbG9yIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5ob3ZlckJhY2tncm91bmRDb2xvciwgaW5kZXgsIGhlbHBlcnMuZ2V0SG92ZXJDb2xvcihtb2RlbC5iYWNrZ3JvdW5kQ29sb3IpKTsKCQkJbW9kZWwuYm9yZGVyQ29sb3IgPSBjdXN0b20uaG92ZXJCb3JkZXJDb2xvciA/IGN1c3RvbS5ob3ZlckJvcmRlckNvbG9yIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5ob3ZlckJvcmRlckNvbG9yLCBpbmRleCwgaGVscGVycy5nZXRIb3ZlckNvbG9yKG1vZGVsLmJvcmRlckNvbG9yKSk7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gY3VzdG9tLmhvdmVyQm9yZGVyV2lkdGggPyBjdXN0b20uaG92ZXJCb3JkZXJXaWR0aCA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQuaG92ZXJCb3JkZXJXaWR0aCwgaW5kZXgsIG1vZGVsLmJvcmRlcldpZHRoKTsKCQl9LAoKCQlyZW1vdmVIb3ZlclN0eWxlOiBmdW5jdGlvbihyZWN0YW5nbGUpIHsKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbcmVjdGFuZ2xlLl9kYXRhc2V0SW5kZXhdOwoJCQl2YXIgaW5kZXggPSByZWN0YW5nbGUuX2luZGV4OwoJCQl2YXIgY3VzdG9tID0gcmVjdGFuZ2xlLmN1c3RvbSB8fCB7fTsKCQkJdmFyIG1vZGVsID0gcmVjdGFuZ2xlLl9tb2RlbDsKCQkJdmFyIHJlY3RhbmdsZUVsZW1lbnRPcHRpb25zID0gdGhpcy5jaGFydC5vcHRpb25zLmVsZW1lbnRzLnJlY3RhbmdsZTsKCgkJCW1vZGVsLmJhY2tncm91bmRDb2xvciA9IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgPyBjdXN0b20uYmFja2dyb3VuZENvbG9yIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5iYWNrZ3JvdW5kQ29sb3IsIGluZGV4LCByZWN0YW5nbGVFbGVtZW50T3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IpOwoJCQltb2RlbC5ib3JkZXJDb2xvciA9IGN1c3RvbS5ib3JkZXJDb2xvciA/IGN1c3RvbS5ib3JkZXJDb2xvciA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQuYm9yZGVyQ29sb3IsIGluZGV4LCByZWN0YW5nbGVFbGVtZW50T3B0aW9ucy5ib3JkZXJDb2xvcik7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gY3VzdG9tLmJvcmRlcldpZHRoID8gY3VzdG9tLmJvcmRlcldpZHRoIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5ib3JkZXJXaWR0aCwgaW5kZXgsIHJlY3RhbmdsZUVsZW1lbnRPcHRpb25zLmJvcmRlcldpZHRoKTsKCQl9Cgl9KTsKCglDaGFydC5jb250cm9sbGVycy5ob3Jpem9udGFsQmFyID0gQ2hhcnQuY29udHJvbGxlcnMuYmFyLmV4dGVuZCh7CgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlnZXRWYWx1ZVNjYWxlSWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5nZXRNZXRhKCkueEF4aXNJRDsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWdldEluZGV4U2NhbGVJZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmdldE1ldGEoKS55QXhpc0lEOwoJCX0KCX0pOwp9OwoKfSx7IjI1IjoyNSwiNDAiOjQwLCI0NSI6NDV9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgZWxlbWVudHMgPSByZXF1aXJlKDQwKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ2J1YmJsZScsIHsKCWhvdmVyOiB7CgkJbW9kZTogJ3NpbmdsZScKCX0sCgoJc2NhbGVzOiB7CgkJeEF4ZXM6IFt7CgkJCXR5cGU6ICdsaW5lYXInLCAvLyBidWJibGUgc2hvdWxkIHByb2JhYmx5IHVzZSBhIGxpbmVhciBzY2FsZSBieSBkZWZhdWx0CgkJCXBvc2l0aW9uOiAnYm90dG9tJywKCQkJaWQ6ICd4LWF4aXMtMCcgLy8gbmVlZCBhbiBJRCBzbyBkYXRhc2V0cyBjYW4gcmVmZXJlbmNlIHRoZSBzY2FsZQoJCX1dLAoJCXlBeGVzOiBbewoJCQl0eXBlOiAnbGluZWFyJywKCQkJcG9zaXRpb246ICdsZWZ0JywKCQkJaWQ6ICd5LWF4aXMtMCcKCQl9XQoJfSwKCgl0b29sdGlwczogewoJCWNhbGxiYWNrczogewoJCQl0aXRsZTogZnVuY3Rpb24oKSB7CgkJCQkvLyBUaXRsZSBkb2Vzbid0IG1ha2Ugc2Vuc2UgZm9yIHNjYXR0ZXIgc2luY2Ugd2UgZm9ybWF0IHRoZSBkYXRhIGFzIGEgcG9pbnQKCQkJCXJldHVybiAnJzsKCQkJfSwKCQkJbGFiZWw6IGZ1bmN0aW9uKGl0ZW0sIGRhdGEpIHsKCQkJCXZhciBkYXRhc2V0TGFiZWwgPSBkYXRhLmRhdGFzZXRzW2l0ZW0uZGF0YXNldEluZGV4XS5sYWJlbCB8fCAnJzsKCQkJCXZhciBkYXRhUG9pbnQgPSBkYXRhLmRhdGFzZXRzW2l0ZW0uZGF0YXNldEluZGV4XS5kYXRhW2l0ZW0uaW5kZXhdOwoJCQkJcmV0dXJuIGRhdGFzZXRMYWJlbCArICc6ICgnICsgaXRlbS54TGFiZWwgKyAnLCAnICsgaXRlbS55TGFiZWwgKyAnLCAnICsgZGF0YVBvaW50LnIgKyAnKSc7CgkJCX0KCQl9Cgl9Cn0pOwoKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCglDaGFydC5jb250cm9sbGVycy5idWJibGUgPSBDaGFydC5EYXRhc2V0Q29udHJvbGxlci5leHRlbmQoewoJCS8qKgoJCSAqIEBwcm90ZWN0ZWQKCQkgKi8KCQlkYXRhRWxlbWVudFR5cGU6IGVsZW1lbnRzLlBvaW50LAoKCQkvKioKCQkgKiBAcHJvdGVjdGVkCgkJICovCgkJdXBkYXRlOiBmdW5jdGlvbihyZXNldCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKCQkJdmFyIHBvaW50cyA9IG1ldGEuZGF0YTsKCgkJCS8vIFVwZGF0ZSBQb2ludHMKCQkJaGVscGVycy5lYWNoKHBvaW50cywgZnVuY3Rpb24ocG9pbnQsIGluZGV4KSB7CgkJCQltZS51cGRhdGVFbGVtZW50KHBvaW50LCBpbmRleCwgcmVzZXQpOwoJCQl9KTsKCQl9LAoKCQkvKioKCQkgKiBAcHJvdGVjdGVkCgkJICovCgkJdXBkYXRlRWxlbWVudDogZnVuY3Rpb24ocG9pbnQsIGluZGV4LCByZXNldCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKCQkJdmFyIGN1c3RvbSA9IHBvaW50LmN1c3RvbSB8fCB7fTsKCQkJdmFyIHhTY2FsZSA9IG1lLmdldFNjYWxlRm9ySWQobWV0YS54QXhpc0lEKTsKCQkJdmFyIHlTY2FsZSA9IG1lLmdldFNjYWxlRm9ySWQobWV0YS55QXhpc0lEKTsKCQkJdmFyIG9wdGlvbnMgPSBtZS5fcmVzb2x2ZUVsZW1lbnRPcHRpb25zKHBvaW50LCBpbmRleCk7CgkJCXZhciBkYXRhID0gbWUuZ2V0RGF0YXNldCgpLmRhdGFbaW5kZXhdOwoJCQl2YXIgZHNJbmRleCA9IG1lLmluZGV4OwoKCQkJdmFyIHggPSByZXNldCA/IHhTY2FsZS5nZXRQaXhlbEZvckRlY2ltYWwoMC41KSA6IHhTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyA/IGRhdGEgOiBOYU4sIGluZGV4LCBkc0luZGV4KTsKCQkJdmFyIHkgPSByZXNldCA/IHlTY2FsZS5nZXRCYXNlUGl4ZWwoKSA6IHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKGRhdGEsIGluZGV4LCBkc0luZGV4KTsKCgkJCXBvaW50Ll94U2NhbGUgPSB4U2NhbGU7CgkJCXBvaW50Ll95U2NhbGUgPSB5U2NhbGU7CgkJCXBvaW50Ll9vcHRpb25zID0gb3B0aW9uczsKCQkJcG9pbnQuX2RhdGFzZXRJbmRleCA9IGRzSW5kZXg7CgkJCXBvaW50Ll9pbmRleCA9IGluZGV4OwoJCQlwb2ludC5fbW9kZWwgPSB7CgkJCQliYWNrZ3JvdW5kQ29sb3I6IG9wdGlvbnMuYmFja2dyb3VuZENvbG9yLAoJCQkJYm9yZGVyQ29sb3I6IG9wdGlvbnMuYm9yZGVyQ29sb3IsCgkJCQlib3JkZXJXaWR0aDogb3B0aW9ucy5ib3JkZXJXaWR0aCwKCQkJCWhpdFJhZGl1czogb3B0aW9ucy5oaXRSYWRpdXMsCgkJCQlwb2ludFN0eWxlOiBvcHRpb25zLnBvaW50U3R5bGUsCgkJCQlyYWRpdXM6IHJlc2V0ID8gMCA6IG9wdGlvbnMucmFkaXVzLAoJCQkJc2tpcDogY3VzdG9tLnNraXAgfHwgaXNOYU4oeCkgfHwgaXNOYU4oeSksCgkJCQl4OiB4LAoJCQkJeTogeSwKCQkJfTsKCgkJCXBvaW50LnBpdm90KCk7CgkJfSwKCgkJLyoqCgkJICogQHByb3RlY3RlZAoJCSAqLwoJCXNldEhvdmVyU3R5bGU6IGZ1bmN0aW9uKHBvaW50KSB7CgkJCXZhciBtb2RlbCA9IHBvaW50Ll9tb2RlbDsKCQkJdmFyIG9wdGlvbnMgPSBwb2ludC5fb3B0aW9uczsKCgkJCW1vZGVsLmJhY2tncm91bmRDb2xvciA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQob3B0aW9ucy5ob3ZlckJhY2tncm91bmRDb2xvciwgaGVscGVycy5nZXRIb3ZlckNvbG9yKG9wdGlvbnMuYmFja2dyb3VuZENvbG9yKSk7CgkJCW1vZGVsLmJvcmRlckNvbG9yID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdChvcHRpb25zLmhvdmVyQm9yZGVyQ29sb3IsIGhlbHBlcnMuZ2V0SG92ZXJDb2xvcihvcHRpb25zLmJvcmRlckNvbG9yKSk7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdChvcHRpb25zLmhvdmVyQm9yZGVyV2lkdGgsIG9wdGlvbnMuYm9yZGVyV2lkdGgpOwoJCQltb2RlbC5yYWRpdXMgPSBvcHRpb25zLnJhZGl1cyArIG9wdGlvbnMuaG92ZXJSYWRpdXM7CgkJfSwKCgkJLyoqCgkJICogQHByb3RlY3RlZAoJCSAqLwoJCXJlbW92ZUhvdmVyU3R5bGU6IGZ1bmN0aW9uKHBvaW50KSB7CgkJCXZhciBtb2RlbCA9IHBvaW50Ll9tb2RlbDsKCQkJdmFyIG9wdGlvbnMgPSBwb2ludC5fb3B0aW9uczsKCgkJCW1vZGVsLmJhY2tncm91bmRDb2xvciA9IG9wdGlvbnMuYmFja2dyb3VuZENvbG9yOwoJCQltb2RlbC5ib3JkZXJDb2xvciA9IG9wdGlvbnMuYm9yZGVyQ29sb3I7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gb3B0aW9ucy5ib3JkZXJXaWR0aDsKCQkJbW9kZWwucmFkaXVzID0gb3B0aW9ucy5yYWRpdXM7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlfcmVzb2x2ZUVsZW1lbnRPcHRpb25zOiBmdW5jdGlvbihwb2ludCwgaW5kZXgpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciBkYXRhc2V0cyA9IGNoYXJ0LmRhdGEuZGF0YXNldHM7CgkJCXZhciBkYXRhc2V0ID0gZGF0YXNldHNbbWUuaW5kZXhdOwoJCQl2YXIgY3VzdG9tID0gcG9pbnQuY3VzdG9tIHx8IHt9OwoJCQl2YXIgb3B0aW9ucyA9IGNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQ7CgkJCXZhciByZXNvbHZlID0gaGVscGVycy5vcHRpb25zLnJlc29sdmU7CgkJCXZhciBkYXRhID0gZGF0YXNldC5kYXRhW2luZGV4XTsKCQkJdmFyIHZhbHVlcyA9IHt9OwoJCQl2YXIgaSwgaWxlbiwga2V5OwoKCQkJLy8gU2NyaXB0YWJsZSBvcHRpb25zCgkJCXZhciBjb250ZXh0ID0gewoJCQkJY2hhcnQ6IGNoYXJ0LAoJCQkJZGF0YUluZGV4OiBpbmRleCwKCQkJCWRhdGFzZXQ6IGRhdGFzZXQsCgkJCQlkYXRhc2V0SW5kZXg6IG1lLmluZGV4CgkJCX07CgoJCQl2YXIga2V5cyA9IFsKCQkJCSdiYWNrZ3JvdW5kQ29sb3InLAoJCQkJJ2JvcmRlckNvbG9yJywKCQkJCSdib3JkZXJXaWR0aCcsCgkJCQknaG92ZXJCYWNrZ3JvdW5kQ29sb3InLAoJCQkJJ2hvdmVyQm9yZGVyQ29sb3InLAoJCQkJJ2hvdmVyQm9yZGVyV2lkdGgnLAoJCQkJJ2hvdmVyUmFkaXVzJywKCQkJCSdoaXRSYWRpdXMnLAoJCQkJJ3BvaW50U3R5bGUnCgkJCV07CgoJCQlmb3IgKGkgPSAwLCBpbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCWtleSA9IGtleXNbaV07CgkJCQl2YWx1ZXNba2V5XSA9IHJlc29sdmUoWwoJCQkJCWN1c3RvbVtrZXldLAoJCQkJCWRhdGFzZXRba2V5XSwKCQkJCQlvcHRpb25zW2tleV0KCQkJCV0sIGNvbnRleHQsIGluZGV4KTsKCQkJfQoKCQkJLy8gQ3VzdG9tIHJhZGl1cyByZXNvbHV0aW9uCgkJCXZhbHVlcy5yYWRpdXMgPSByZXNvbHZlKFsKCQkJCWN1c3RvbS5yYWRpdXMsCgkJCQlkYXRhID8gZGF0YS5yIDogdW5kZWZpbmVkLAoJCQkJZGF0YXNldC5yYWRpdXMsCgkJCQlvcHRpb25zLnJhZGl1cwoJCQldLCBjb250ZXh0LCBpbmRleCk7CgoJCQlyZXR1cm4gdmFsdWVzOwoJCX0KCX0pOwp9OwoKfSx7IjI1IjoyNSwiNDAiOjQwLCI0NSI6NDV9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgZWxlbWVudHMgPSByZXF1aXJlKDQwKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ2RvdWdobnV0JywgewoJYW5pbWF0aW9uOiB7CgkJLy8gQm9vbGVhbiAtIFdoZXRoZXIgd2UgYW5pbWF0ZSB0aGUgcm90YXRpb24gb2YgdGhlIERvdWdobnV0CgkJYW5pbWF0ZVJvdGF0ZTogdHJ1ZSwKCQkvLyBCb29sZWFuIC0gV2hldGhlciB3ZSBhbmltYXRlIHNjYWxpbmcgdGhlIERvdWdobnV0IGZyb20gdGhlIGNlbnRyZQoJCWFuaW1hdGVTY2FsZTogZmFsc2UKCX0sCglob3ZlcjogewoJCW1vZGU6ICdzaW5nbGUnCgl9LAoJbGVnZW5kQ2FsbGJhY2s6IGZ1bmN0aW9uKGNoYXJ0KSB7CgkJdmFyIHRleHQgPSBbXTsKCQl0ZXh0LnB1c2goJzx1bCBjbGFzcz0iJyArIGNoYXJ0LmlkICsgJy1sZWdlbmQiPicpOwoKCQl2YXIgZGF0YSA9IGNoYXJ0LmRhdGE7CgkJdmFyIGRhdGFzZXRzID0gZGF0YS5kYXRhc2V0czsKCQl2YXIgbGFiZWxzID0gZGF0YS5sYWJlbHM7CgoJCWlmIChkYXRhc2V0cy5sZW5ndGgpIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhc2V0c1swXS5kYXRhLmxlbmd0aDsgKytpKSB7CgkJCQl0ZXh0LnB1c2goJzxsaT48c3BhbiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjonICsgZGF0YXNldHNbMF0uYmFja2dyb3VuZENvbG9yW2ldICsgJyI+PC9zcGFuPicpOwoJCQkJaWYgKGxhYmVsc1tpXSkgewoJCQkJCXRleHQucHVzaChsYWJlbHNbaV0pOwoJCQkJfQoJCQkJdGV4dC5wdXNoKCc8L2xpPicpOwoJCQl9CgkJfQoKCQl0ZXh0LnB1c2goJzwvdWw+Jyk7CgkJcmV0dXJuIHRleHQuam9pbignJyk7Cgl9LAoJbGVnZW5kOiB7CgkJbGFiZWxzOiB7CgkJCWdlbmVyYXRlTGFiZWxzOiBmdW5jdGlvbihjaGFydCkgewoJCQkJdmFyIGRhdGEgPSBjaGFydC5kYXRhOwoJCQkJaWYgKGRhdGEubGFiZWxzLmxlbmd0aCAmJiBkYXRhLmRhdGFzZXRzLmxlbmd0aCkgewoJCQkJCXJldHVybiBkYXRhLmxhYmVscy5tYXAoZnVuY3Rpb24obGFiZWwsIGkpIHsKCQkJCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YSgwKTsKCQkJCQkJdmFyIGRzID0gZGF0YS5kYXRhc2V0c1swXTsKCQkJCQkJdmFyIGFyYyA9IG1ldGEuZGF0YVtpXTsKCQkJCQkJdmFyIGN1c3RvbSA9IGFyYyAmJiBhcmMuY3VzdG9tIHx8IHt9OwoJCQkJCQl2YXIgdmFsdWVBdEluZGV4T3JEZWZhdWx0ID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQ7CgkJCQkJCXZhciBhcmNPcHRzID0gY2hhcnQub3B0aW9ucy5lbGVtZW50cy5hcmM7CgkJCQkJCXZhciBmaWxsID0gY3VzdG9tLmJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgOiB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZHMuYmFja2dyb3VuZENvbG9yLCBpLCBhcmNPcHRzLmJhY2tncm91bmRDb2xvcik7CgkJCQkJCXZhciBzdHJva2UgPSBjdXN0b20uYm9yZGVyQ29sb3IgPyBjdXN0b20uYm9yZGVyQ29sb3IgOiB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZHMuYm9yZGVyQ29sb3IsIGksIGFyY09wdHMuYm9yZGVyQ29sb3IpOwoJCQkJCQl2YXIgYncgPSBjdXN0b20uYm9yZGVyV2lkdGggPyBjdXN0b20uYm9yZGVyV2lkdGggOiB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZHMuYm9yZGVyV2lkdGgsIGksIGFyY09wdHMuYm9yZGVyV2lkdGgpOwoKCQkJCQkJcmV0dXJuIHsKCQkJCQkJCXRleHQ6IGxhYmVsLAoJCQkJCQkJZmlsbFN0eWxlOiBmaWxsLAoJCQkJCQkJc3Ryb2tlU3R5bGU6IHN0cm9rZSwKCQkJCQkJCWxpbmVXaWR0aDogYncsCgkJCQkJCQloaWRkZW46IGlzTmFOKGRzLmRhdGFbaV0pIHx8IG1ldGEuZGF0YVtpXS5oaWRkZW4sCgoJCQkJCQkJLy8gRXh0cmEgZGF0YSB1c2VkIGZvciB0b2dnbGluZyB0aGUgY29ycmVjdCBpdGVtCgkJCQkJCQlpbmRleDogaQoJCQkJCQl9OwoJCQkJCX0pOwoJCQkJfQoJCQkJcmV0dXJuIFtdOwoJCQl9CgkJfSwKCgkJb25DbGljazogZnVuY3Rpb24oZSwgbGVnZW5kSXRlbSkgewoJCQl2YXIgaW5kZXggPSBsZWdlbmRJdGVtLmluZGV4OwoJCQl2YXIgY2hhcnQgPSB0aGlzLmNoYXJ0OwoJCQl2YXIgaSwgaWxlbiwgbWV0YTsKCgkJCWZvciAoaSA9IDAsIGlsZW4gPSAoY2hhcnQuZGF0YS5kYXRhc2V0cyB8fCBbXSkubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQltZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaSk7CgkJCQkvLyB0b2dnbGUgdmlzaWJpbGl0eSBvZiBpbmRleCBpZiBleGlzdHMKCQkJCWlmIChtZXRhLmRhdGFbaW5kZXhdKSB7CgkJCQkJbWV0YS5kYXRhW2luZGV4XS5oaWRkZW4gPSAhbWV0YS5kYXRhW2luZGV4XS5oaWRkZW47CgkJCQl9CgkJCX0KCgkJCWNoYXJ0LnVwZGF0ZSgpOwoJCX0KCX0sCgoJLy8gVGhlIHBlcmNlbnRhZ2Ugb2YgdGhlIGNoYXJ0IHRoYXQgd2UgY3V0IG91dCBvZiB0aGUgbWlkZGxlLgoJY3V0b3V0UGVyY2VudGFnZTogNTAsCgoJLy8gVGhlIHJvdGF0aW9uIG9mIHRoZSBjaGFydCwgd2hlcmUgdGhlIGZpcnN0IGRhdGEgYXJjIGJlZ2lucy4KCXJvdGF0aW9uOiBNYXRoLlBJICogLTAuNSwKCgkvLyBUaGUgdG90YWwgY2lyY3VtZmVyZW5jZSBvZiB0aGUgY2hhcnQuCgljaXJjdW1mZXJlbmNlOiBNYXRoLlBJICogMi4wLAoKCS8vIE5lZWQgdG8gb3ZlcnJpZGUgdGhlc2UgdG8gZ2l2ZSBhIG5pY2UgZGVmYXVsdAoJdG9vbHRpcHM6IHsKCQljYWxsYmFja3M6IHsKCQkJdGl0bGU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICcnOwoJCQl9LAoJCQlsYWJlbDogZnVuY3Rpb24odG9vbHRpcEl0ZW0sIGRhdGEpIHsKCQkJCXZhciBkYXRhTGFiZWwgPSBkYXRhLmxhYmVsc1t0b29sdGlwSXRlbS5pbmRleF07CgkJCQl2YXIgdmFsdWUgPSAnOiAnICsgZGF0YS5kYXRhc2V0c1t0b29sdGlwSXRlbS5kYXRhc2V0SW5kZXhdLmRhdGFbdG9vbHRpcEl0ZW0uaW5kZXhdOwoKCQkJCWlmIChoZWxwZXJzLmlzQXJyYXkoZGF0YUxhYmVsKSkgewoJCQkJCS8vIHNob3cgdmFsdWUgb24gZmlyc3QgbGluZSBvZiBtdWx0aWxpbmUgbGFiZWwKCQkJCQkvLyBuZWVkIHRvIGNsb25lIGJlY2F1c2Ugd2UgYXJlIGNoYW5naW5nIHRoZSB2YWx1ZQoJCQkJCWRhdGFMYWJlbCA9IGRhdGFMYWJlbC5zbGljZSgpOwoJCQkJCWRhdGFMYWJlbFswXSArPSB2YWx1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJZGF0YUxhYmVsICs9IHZhbHVlOwoJCQkJfQoKCQkJCXJldHVybiBkYXRhTGFiZWw7CgkJCX0KCQl9Cgl9Cn0pOwoKZGVmYXVsdHMuX3NldCgncGllJywgaGVscGVycy5jbG9uZShkZWZhdWx0cy5kb3VnaG51dCkpOwpkZWZhdWx0cy5fc2V0KCdwaWUnLCB7CgljdXRvdXRQZXJjZW50YWdlOiAwCn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCUNoYXJ0LmNvbnRyb2xsZXJzLmRvdWdobnV0ID0gQ2hhcnQuY29udHJvbGxlcnMucGllID0gQ2hhcnQuRGF0YXNldENvbnRyb2xsZXIuZXh0ZW5kKHsKCgkJZGF0YUVsZW1lbnRUeXBlOiBlbGVtZW50cy5BcmMsCgoJCWxpbmtTY2FsZXM6IGhlbHBlcnMubm9vcCwKCgkJLy8gR2V0IGluZGV4IG9mIHRoZSBkYXRhc2V0IGluIHJlbGF0aW9uIHRvIHRoZSB2aXNpYmxlIGRhdGFzZXRzLiBUaGlzIGFsbG93cyBkZXRlcm1pbmluZyB0aGUgaW5uZXIgYW5kIG91dGVyIHJhZGl1cyBjb3JyZWN0bHkKCQlnZXRSaW5nSW5kZXg6IGZ1bmN0aW9uKGRhdGFzZXRJbmRleCkgewoJCQl2YXIgcmluZ0luZGV4ID0gMDsKCgkJCWZvciAodmFyIGogPSAwOyBqIDwgZGF0YXNldEluZGV4OyArK2opIHsKCQkJCWlmICh0aGlzLmNoYXJ0LmlzRGF0YXNldFZpc2libGUoaikpIHsKCQkJCQkrK3JpbmdJbmRleDsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuIHJpbmdJbmRleDsKCQl9LAoKCQl1cGRhdGU6IGZ1bmN0aW9uKHJlc2V0KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBjaGFydCA9IG1lLmNoYXJ0OwoJCQl2YXIgY2hhcnRBcmVhID0gY2hhcnQuY2hhcnRBcmVhOwoJCQl2YXIgb3B0cyA9IGNoYXJ0Lm9wdGlvbnM7CgkJCXZhciBhcmNPcHRzID0gb3B0cy5lbGVtZW50cy5hcmM7CgkJCXZhciBhdmFpbGFibGVXaWR0aCA9IGNoYXJ0QXJlYS5yaWdodCAtIGNoYXJ0QXJlYS5sZWZ0IC0gYXJjT3B0cy5ib3JkZXJXaWR0aDsKCQkJdmFyIGF2YWlsYWJsZUhlaWdodCA9IGNoYXJ0QXJlYS5ib3R0b20gLSBjaGFydEFyZWEudG9wIC0gYXJjT3B0cy5ib3JkZXJXaWR0aDsKCQkJdmFyIG1pblNpemUgPSBNYXRoLm1pbihhdmFpbGFibGVXaWR0aCwgYXZhaWxhYmxlSGVpZ2h0KTsKCQkJdmFyIG9mZnNldCA9IHt4OiAwLCB5OiAwfTsKCQkJdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCXZhciBjdXRvdXRQZXJjZW50YWdlID0gb3B0cy5jdXRvdXRQZXJjZW50YWdlOwoJCQl2YXIgY2lyY3VtZmVyZW5jZSA9IG9wdHMuY2lyY3VtZmVyZW5jZTsKCgkJCS8vIElmIHRoZSBjaGFydCdzIGNpcmN1bWZlcmVuY2UgaXNuJ3QgYSBmdWxsIGNpcmNsZSwgY2FsY3VsYXRlIG1pblNpemUgYXMgYSByYXRpbyBvZiB0aGUgd2lkdGgvaGVpZ2h0IG9mIHRoZSBhcmMKCQkJaWYgKGNpcmN1bWZlcmVuY2UgPCBNYXRoLlBJICogMi4wKSB7CgkJCQl2YXIgc3RhcnRBbmdsZSA9IG9wdHMucm90YXRpb24gJSAoTWF0aC5QSSAqIDIuMCk7CgkJCQlzdGFydEFuZ2xlICs9IE1hdGguUEkgKiAyLjAgKiAoc3RhcnRBbmdsZSA+PSBNYXRoLlBJID8gLTEgOiBzdGFydEFuZ2xlIDwgLU1hdGguUEkgPyAxIDogMCk7CgkJCQl2YXIgZW5kQW5nbGUgPSBzdGFydEFuZ2xlICsgY2lyY3VtZmVyZW5jZTsKCQkJCXZhciBzdGFydCA9IHt4OiBNYXRoLmNvcyhzdGFydEFuZ2xlKSwgeTogTWF0aC5zaW4oc3RhcnRBbmdsZSl9OwoJCQkJdmFyIGVuZCA9IHt4OiBNYXRoLmNvcyhlbmRBbmdsZSksIHk6IE1hdGguc2luKGVuZEFuZ2xlKX07CgkJCQl2YXIgY29udGFpbnMwID0gKHN0YXJ0QW5nbGUgPD0gMCAmJiBlbmRBbmdsZSA+PSAwKSB8fCAoc3RhcnRBbmdsZSA8PSBNYXRoLlBJICogMi4wICYmIE1hdGguUEkgKiAyLjAgPD0gZW5kQW5nbGUpOwoJCQkJdmFyIGNvbnRhaW5zOTAgPSAoc3RhcnRBbmdsZSA8PSBNYXRoLlBJICogMC41ICYmIE1hdGguUEkgKiAwLjUgPD0gZW5kQW5nbGUpIHx8IChzdGFydEFuZ2xlIDw9IE1hdGguUEkgKiAyLjUgJiYgTWF0aC5QSSAqIDIuNSA8PSBlbmRBbmdsZSk7CgkJCQl2YXIgY29udGFpbnMxODAgPSAoc3RhcnRBbmdsZSA8PSAtTWF0aC5QSSAmJiAtTWF0aC5QSSA8PSBlbmRBbmdsZSkgfHwgKHN0YXJ0QW5nbGUgPD0gTWF0aC5QSSAmJiBNYXRoLlBJIDw9IGVuZEFuZ2xlKTsKCQkJCXZhciBjb250YWluczI3MCA9IChzdGFydEFuZ2xlIDw9IC1NYXRoLlBJICogMC41ICYmIC1NYXRoLlBJICogMC41IDw9IGVuZEFuZ2xlKSB8fCAoc3RhcnRBbmdsZSA8PSBNYXRoLlBJICogMS41ICYmIE1hdGguUEkgKiAxLjUgPD0gZW5kQW5nbGUpOwoJCQkJdmFyIGN1dG91dCA9IGN1dG91dFBlcmNlbnRhZ2UgLyAxMDAuMDsKCQkJCXZhciBtaW4gPSB7eDogY29udGFpbnMxODAgPyAtMSA6IE1hdGgubWluKHN0YXJ0LnggKiAoc3RhcnQueCA8IDAgPyAxIDogY3V0b3V0KSwgZW5kLnggKiAoZW5kLnggPCAwID8gMSA6IGN1dG91dCkpLCB5OiBjb250YWluczI3MCA/IC0xIDogTWF0aC5taW4oc3RhcnQueSAqIChzdGFydC55IDwgMCA/IDEgOiBjdXRvdXQpLCBlbmQueSAqIChlbmQueSA8IDAgPyAxIDogY3V0b3V0KSl9OwoJCQkJdmFyIG1heCA9IHt4OiBjb250YWluczAgPyAxIDogTWF0aC5tYXgoc3RhcnQueCAqIChzdGFydC54ID4gMCA/IDEgOiBjdXRvdXQpLCBlbmQueCAqIChlbmQueCA+IDAgPyAxIDogY3V0b3V0KSksIHk6IGNvbnRhaW5zOTAgPyAxIDogTWF0aC5tYXgoc3RhcnQueSAqIChzdGFydC55ID4gMCA/IDEgOiBjdXRvdXQpLCBlbmQueSAqIChlbmQueSA+IDAgPyAxIDogY3V0b3V0KSl9OwoJCQkJdmFyIHNpemUgPSB7d2lkdGg6IChtYXgueCAtIG1pbi54KSAqIDAuNSwgaGVpZ2h0OiAobWF4LnkgLSBtaW4ueSkgKiAwLjV9OwoJCQkJbWluU2l6ZSA9IE1hdGgubWluKGF2YWlsYWJsZVdpZHRoIC8gc2l6ZS53aWR0aCwgYXZhaWxhYmxlSGVpZ2h0IC8gc2l6ZS5oZWlnaHQpOwoJCQkJb2Zmc2V0ID0ge3g6IChtYXgueCArIG1pbi54KSAqIC0wLjUsIHk6IChtYXgueSArIG1pbi55KSAqIC0wLjV9OwoJCQl9CgoJCQljaGFydC5ib3JkZXJXaWR0aCA9IG1lLmdldE1heEJvcmRlcldpZHRoKG1ldGEuZGF0YSk7CgkJCWNoYXJ0Lm91dGVyUmFkaXVzID0gTWF0aC5tYXgoKG1pblNpemUgLSBjaGFydC5ib3JkZXJXaWR0aCkgLyAyLCAwKTsKCQkJY2hhcnQuaW5uZXJSYWRpdXMgPSBNYXRoLm1heChjdXRvdXRQZXJjZW50YWdlID8gKGNoYXJ0Lm91dGVyUmFkaXVzIC8gMTAwKSAqIChjdXRvdXRQZXJjZW50YWdlKSA6IDAsIDApOwoJCQljaGFydC5yYWRpdXNMZW5ndGggPSAoY2hhcnQub3V0ZXJSYWRpdXMgLSBjaGFydC5pbm5lclJhZGl1cykgLyBjaGFydC5nZXRWaXNpYmxlRGF0YXNldENvdW50KCk7CgkJCWNoYXJ0Lm9mZnNldFggPSBvZmZzZXQueCAqIGNoYXJ0Lm91dGVyUmFkaXVzOwoJCQljaGFydC5vZmZzZXRZID0gb2Zmc2V0LnkgKiBjaGFydC5vdXRlclJhZGl1czsKCgkJCW1ldGEudG90YWwgPSBtZS5jYWxjdWxhdGVUb3RhbCgpOwoKCQkJbWUub3V0ZXJSYWRpdXMgPSBjaGFydC5vdXRlclJhZGl1cyAtIChjaGFydC5yYWRpdXNMZW5ndGggKiBtZS5nZXRSaW5nSW5kZXgobWUuaW5kZXgpKTsKCQkJbWUuaW5uZXJSYWRpdXMgPSBNYXRoLm1heChtZS5vdXRlclJhZGl1cyAtIGNoYXJ0LnJhZGl1c0xlbmd0aCwgMCk7CgoJCQloZWxwZXJzLmVhY2gobWV0YS5kYXRhLCBmdW5jdGlvbihhcmMsIGluZGV4KSB7CgkJCQltZS51cGRhdGVFbGVtZW50KGFyYywgaW5kZXgsIHJlc2V0KTsKCQkJfSk7CgkJfSwKCgkJdXBkYXRlRWxlbWVudDogZnVuY3Rpb24oYXJjLCBpbmRleCwgcmVzZXQpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciBjaGFydEFyZWEgPSBjaGFydC5jaGFydEFyZWE7CgkJCXZhciBvcHRzID0gY2hhcnQub3B0aW9uczsKCQkJdmFyIGFuaW1hdGlvbk9wdHMgPSBvcHRzLmFuaW1hdGlvbjsKCQkJdmFyIGNlbnRlclggPSAoY2hhcnRBcmVhLmxlZnQgKyBjaGFydEFyZWEucmlnaHQpIC8gMjsKCQkJdmFyIGNlbnRlclkgPSAoY2hhcnRBcmVhLnRvcCArIGNoYXJ0QXJlYS5ib3R0b20pIC8gMjsKCQkJdmFyIHN0YXJ0QW5nbGUgPSBvcHRzLnJvdGF0aW9uOyAvLyBub24gcmVzZXQgY2FzZSBoYW5kbGVkIGxhdGVyCgkJCXZhciBlbmRBbmdsZSA9IG9wdHMucm90YXRpb247IC8vIG5vbiByZXNldCBjYXNlIGhhbmRsZWQgbGF0ZXIKCQkJdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CgkJCXZhciBjaXJjdW1mZXJlbmNlID0gcmVzZXQgJiYgYW5pbWF0aW9uT3B0cy5hbmltYXRlUm90YXRlID8gMCA6IGFyYy5oaWRkZW4gPyAwIDogbWUuY2FsY3VsYXRlQ2lyY3VtZmVyZW5jZShkYXRhc2V0LmRhdGFbaW5kZXhdKSAqIChvcHRzLmNpcmN1bWZlcmVuY2UgLyAoMi4wICogTWF0aC5QSSkpOwoJCQl2YXIgaW5uZXJSYWRpdXMgPSByZXNldCAmJiBhbmltYXRpb25PcHRzLmFuaW1hdGVTY2FsZSA/IDAgOiBtZS5pbm5lclJhZGl1czsKCQkJdmFyIG91dGVyUmFkaXVzID0gcmVzZXQgJiYgYW5pbWF0aW9uT3B0cy5hbmltYXRlU2NhbGUgPyAwIDogbWUub3V0ZXJSYWRpdXM7CgkJCXZhciB2YWx1ZUF0SW5kZXhPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdDsKCgkJCWhlbHBlcnMuZXh0ZW5kKGFyYywgewoJCQkJLy8gVXRpbGl0eQoJCQkJX2RhdGFzZXRJbmRleDogbWUuaW5kZXgsCgkJCQlfaW5kZXg6IGluZGV4LAoKCQkJCS8vIERlc2lyZWQgdmlldyBwcm9wZXJ0aWVzCgkJCQlfbW9kZWw6IHsKCQkJCQl4OiBjZW50ZXJYICsgY2hhcnQub2Zmc2V0WCwKCQkJCQl5OiBjZW50ZXJZICsgY2hhcnQub2Zmc2V0WSwKCQkJCQlzdGFydEFuZ2xlOiBzdGFydEFuZ2xlLAoJCQkJCWVuZEFuZ2xlOiBlbmRBbmdsZSwKCQkJCQljaXJjdW1mZXJlbmNlOiBjaXJjdW1mZXJlbmNlLAoJCQkJCW91dGVyUmFkaXVzOiBvdXRlclJhZGl1cywKCQkJCQlpbm5lclJhZGl1czogaW5uZXJSYWRpdXMsCgkJCQkJbGFiZWw6IHZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LmxhYmVsLCBpbmRleCwgY2hhcnQuZGF0YS5sYWJlbHNbaW5kZXhdKQoJCQkJfQoJCQl9KTsKCgkJCXZhciBtb2RlbCA9IGFyYy5fbW9kZWw7CgkJCS8vIFJlc2V0cyB0aGUgdmlzdWFsIHN0eWxlcwoJCQl0aGlzLnJlbW92ZUhvdmVyU3R5bGUoYXJjKTsKCgkJCS8vIFNldCBjb3JyZWN0IGFuZ2xlcyBpZiBub3QgcmVzZXR0aW5nCgkJCWlmICghcmVzZXQgfHwgIWFuaW1hdGlvbk9wdHMuYW5pbWF0ZVJvdGF0ZSkgewoJCQkJaWYgKGluZGV4ID09PSAwKSB7CgkJCQkJbW9kZWwuc3RhcnRBbmdsZSA9IG9wdHMucm90YXRpb247CgkJCQl9IGVsc2UgewoJCQkJCW1vZGVsLnN0YXJ0QW5nbGUgPSBtZS5nZXRNZXRhKCkuZGF0YVtpbmRleCAtIDFdLl9tb2RlbC5lbmRBbmdsZTsKCQkJCX0KCgkJCQltb2RlbC5lbmRBbmdsZSA9IG1vZGVsLnN0YXJ0QW5nbGUgKyBtb2RlbC5jaXJjdW1mZXJlbmNlOwoJCQl9CgoJCQlhcmMucGl2b3QoKTsKCQl9LAoKCQlyZW1vdmVIb3ZlclN0eWxlOiBmdW5jdGlvbihhcmMpIHsKCQkJQ2hhcnQuRGF0YXNldENvbnRyb2xsZXIucHJvdG90eXBlLnJlbW92ZUhvdmVyU3R5bGUuY2FsbCh0aGlzLCBhcmMsIHRoaXMuY2hhcnQub3B0aW9ucy5lbGVtZW50cy5hcmMpOwoJCX0sCgoJCWNhbGN1bGF0ZVRvdGFsOiBmdW5jdGlvbigpIHsKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmdldERhdGFzZXQoKTsKCQkJdmFyIG1ldGEgPSB0aGlzLmdldE1ldGEoKTsKCQkJdmFyIHRvdGFsID0gMDsKCQkJdmFyIHZhbHVlOwoKCQkJaGVscGVycy5lYWNoKG1ldGEuZGF0YSwgZnVuY3Rpb24oZWxlbWVudCwgaW5kZXgpIHsKCQkJCXZhbHVlID0gZGF0YXNldC5kYXRhW2luZGV4XTsKCQkJCWlmICghaXNOYU4odmFsdWUpICYmICFlbGVtZW50LmhpZGRlbikgewoJCQkJCXRvdGFsICs9IE1hdGguYWJzKHZhbHVlKTsKCQkJCX0KCQkJfSk7CgoJCQkvKiBpZiAodG90YWwgPT09IDApIHsKCQkJCXRvdGFsID0gTmFOOwoJCQl9Ki8KCgkJCXJldHVybiB0b3RhbDsKCQl9LAoKCQljYWxjdWxhdGVDaXJjdW1mZXJlbmNlOiBmdW5jdGlvbih2YWx1ZSkgewoJCQl2YXIgdG90YWwgPSB0aGlzLmdldE1ldGEoKS50b3RhbDsKCQkJaWYgKHRvdGFsID4gMCAmJiAhaXNOYU4odmFsdWUpKSB7CgkJCQlyZXR1cm4gKE1hdGguUEkgKiAyLjApICogKE1hdGguYWJzKHZhbHVlKSAvIHRvdGFsKTsKCQkJfQoJCQlyZXR1cm4gMDsKCQl9LAoKCQkvLyBnZXRzIHRoZSBtYXggYm9yZGVyIG9yIGhvdmVyIHdpZHRoIHRvIHByb3Blcmx5IHNjYWxlIHBpZSBjaGFydHMKCQlnZXRNYXhCb3JkZXJXaWR0aDogZnVuY3Rpb24oYXJjcykgewoJCQl2YXIgbWF4ID0gMDsKCQkJdmFyIGluZGV4ID0gdGhpcy5pbmRleDsKCQkJdmFyIGxlbmd0aCA9IGFyY3MubGVuZ3RoOwoJCQl2YXIgYm9yZGVyV2lkdGg7CgkJCXZhciBob3ZlcldpZHRoOwoKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewoJCQkJYm9yZGVyV2lkdGggPSBhcmNzW2ldLl9tb2RlbCA/IGFyY3NbaV0uX21vZGVsLmJvcmRlcldpZHRoIDogMDsKCQkJCWhvdmVyV2lkdGggPSBhcmNzW2ldLl9jaGFydCA/IGFyY3NbaV0uX2NoYXJ0LmNvbmZpZy5kYXRhLmRhdGFzZXRzW2luZGV4XS5ob3ZlckJvcmRlcldpZHRoIDogMDsKCgkJCQltYXggPSBib3JkZXJXaWR0aCA+IG1heCA/IGJvcmRlcldpZHRoIDogbWF4OwoJCQkJbWF4ID0gaG92ZXJXaWR0aCA+IG1heCA/IGhvdmVyV2lkdGggOiBtYXg7CgkJCX0KCQkJcmV0dXJuIG1heDsKCQl9Cgl9KTsKfTsKCn0seyIyNSI6MjUsIjQwIjo0MCwiNDUiOjQ1fV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgZGVmYXVsdHMgPSByZXF1aXJlKDI1KTsKdmFyIGVsZW1lbnRzID0gcmVxdWlyZSg0MCk7CnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7CgpkZWZhdWx0cy5fc2V0KCdsaW5lJywgewoJc2hvd0xpbmVzOiB0cnVlLAoJc3BhbkdhcHM6IGZhbHNlLAoKCWhvdmVyOiB7CgkJbW9kZTogJ2xhYmVsJwoJfSwKCglzY2FsZXM6IHsKCQl4QXhlczogW3sKCQkJdHlwZTogJ2NhdGVnb3J5JywKCQkJaWQ6ICd4LWF4aXMtMCcKCQl9XSwKCQl5QXhlczogW3sKCQkJdHlwZTogJ2xpbmVhcicsCgkJCWlkOiAneS1heGlzLTAnCgkJfV0KCX0KfSk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJZnVuY3Rpb24gbGluZUVuYWJsZWQoZGF0YXNldCwgb3B0aW9ucykgewoJCXJldHVybiBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KGRhdGFzZXQuc2hvd0xpbmUsIG9wdGlvbnMuc2hvd0xpbmVzKTsKCX0KCglDaGFydC5jb250cm9sbGVycy5saW5lID0gQ2hhcnQuRGF0YXNldENvbnRyb2xsZXIuZXh0ZW5kKHsKCgkJZGF0YXNldEVsZW1lbnRUeXBlOiBlbGVtZW50cy5MaW5lLAoKCQlkYXRhRWxlbWVudFR5cGU6IGVsZW1lbnRzLlBvaW50LAoKCQl1cGRhdGU6IGZ1bmN0aW9uKHJlc2V0KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwoJCQl2YXIgbGluZSA9IG1ldGEuZGF0YXNldDsKCQkJdmFyIHBvaW50cyA9IG1ldGEuZGF0YSB8fCBbXTsKCQkJdmFyIG9wdGlvbnMgPSBtZS5jaGFydC5vcHRpb25zOwoJCQl2YXIgbGluZUVsZW1lbnRPcHRpb25zID0gb3B0aW9ucy5lbGVtZW50cy5saW5lOwoJCQl2YXIgc2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueUF4aXNJRCk7CgkJCXZhciBpLCBpbGVuLCBjdXN0b207CgkJCXZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpOwoJCQl2YXIgc2hvd0xpbmUgPSBsaW5lRW5hYmxlZChkYXRhc2V0LCBvcHRpb25zKTsKCgkJCS8vIFVwZGF0ZSBMaW5lCgkJCWlmIChzaG93TGluZSkgewoJCQkJY3VzdG9tID0gbGluZS5jdXN0b20gfHwge307CgoJCQkJLy8gQ29tcGF0aWJpbGl0eTogSWYgdGhlIHByb3BlcnRpZXMgYXJlIGRlZmluZWQgd2l0aCBvbmx5IHRoZSBvbGQgbmFtZSwgdXNlIHRob3NlIHZhbHVlcwoJCQkJaWYgKChkYXRhc2V0LnRlbnNpb24gIT09IHVuZGVmaW5lZCkgJiYgKGRhdGFzZXQubGluZVRlbnNpb24gPT09IHVuZGVmaW5lZCkpIHsKCQkJCQlkYXRhc2V0LmxpbmVUZW5zaW9uID0gZGF0YXNldC50ZW5zaW9uOwoJCQkJfQoKCQkJCS8vIFV0aWxpdHkKCQkJCWxpbmUuX3NjYWxlID0gc2NhbGU7CgkJCQlsaW5lLl9kYXRhc2V0SW5kZXggPSBtZS5pbmRleDsKCQkJCS8vIERhdGEKCQkJCWxpbmUuX2NoaWxkcmVuID0gcG9pbnRzOwoJCQkJLy8gTW9kZWwKCQkJCWxpbmUuX21vZGVsID0gewoJCQkJCS8vIEFwcGVhcmFuY2UKCQkJCQkvLyBUaGUgZGVmYXVsdCBiZWhhdmlvciBvZiBsaW5lcyBpcyB0byBicmVhayBhdCBudWxsIHZhbHVlcywgYWNjb3JkaW5nCgkJCQkJLy8gdG8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzI0MzUjaXNzdWVjb21tZW50LTIxNjcxODE1OAoJCQkJCS8vIFRoaXMgb3B0aW9uIGdpdmVzIGxpbmVzIHRoZSBhYmlsaXR5IHRvIHNwYW4gZ2FwcwoJCQkJCXNwYW5HYXBzOiBkYXRhc2V0LnNwYW5HYXBzID8gZGF0YXNldC5zcGFuR2FwcyA6IG9wdGlvbnMuc3BhbkdhcHMsCgkJCQkJdGVuc2lvbjogY3VzdG9tLnRlbnNpb24gPyBjdXN0b20udGVuc2lvbiA6IGhlbHBlcnMudmFsdWVPckRlZmF1bHQoZGF0YXNldC5saW5lVGVuc2lvbiwgbGluZUVsZW1lbnRPcHRpb25zLnRlbnNpb24pLAoJCQkJCWJhY2tncm91bmRDb2xvcjogY3VzdG9tLmJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgOiAoZGF0YXNldC5iYWNrZ3JvdW5kQ29sb3IgfHwgbGluZUVsZW1lbnRPcHRpb25zLmJhY2tncm91bmRDb2xvciksCgkJCQkJYm9yZGVyV2lkdGg6IGN1c3RvbS5ib3JkZXJXaWR0aCA/IGN1c3RvbS5ib3JkZXJXaWR0aCA6IChkYXRhc2V0LmJvcmRlcldpZHRoIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJXaWR0aCksCgkJCQkJYm9yZGVyQ29sb3I6IGN1c3RvbS5ib3JkZXJDb2xvciA/IGN1c3RvbS5ib3JkZXJDb2xvciA6IChkYXRhc2V0LmJvcmRlckNvbG9yIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJDb2xvciksCgkJCQkJYm9yZGVyQ2FwU3R5bGU6IGN1c3RvbS5ib3JkZXJDYXBTdHlsZSA/IGN1c3RvbS5ib3JkZXJDYXBTdHlsZSA6IChkYXRhc2V0LmJvcmRlckNhcFN0eWxlIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJDYXBTdHlsZSksCgkJCQkJYm9yZGVyRGFzaDogY3VzdG9tLmJvcmRlckRhc2ggPyBjdXN0b20uYm9yZGVyRGFzaCA6IChkYXRhc2V0LmJvcmRlckRhc2ggfHwgbGluZUVsZW1lbnRPcHRpb25zLmJvcmRlckRhc2gpLAoJCQkJCWJvcmRlckRhc2hPZmZzZXQ6IGN1c3RvbS5ib3JkZXJEYXNoT2Zmc2V0ID8gY3VzdG9tLmJvcmRlckRhc2hPZmZzZXQgOiAoZGF0YXNldC5ib3JkZXJEYXNoT2Zmc2V0IHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJEYXNoT2Zmc2V0KSwKCQkJCQlib3JkZXJKb2luU3R5bGU6IGN1c3RvbS5ib3JkZXJKb2luU3R5bGUgPyBjdXN0b20uYm9yZGVySm9pblN0eWxlIDogKGRhdGFzZXQuYm9yZGVySm9pblN0eWxlIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJKb2luU3R5bGUpLAoJCQkJCWZpbGw6IGN1c3RvbS5maWxsID8gY3VzdG9tLmZpbGwgOiAoZGF0YXNldC5maWxsICE9PSB1bmRlZmluZWQgPyBkYXRhc2V0LmZpbGwgOiBsaW5lRWxlbWVudE9wdGlvbnMuZmlsbCksCgkJCQkJc3RlcHBlZExpbmU6IGN1c3RvbS5zdGVwcGVkTGluZSA/IGN1c3RvbS5zdGVwcGVkTGluZSA6IGhlbHBlcnMudmFsdWVPckRlZmF1bHQoZGF0YXNldC5zdGVwcGVkTGluZSwgbGluZUVsZW1lbnRPcHRpb25zLnN0ZXBwZWQpLAoJCQkJCWN1YmljSW50ZXJwb2xhdGlvbk1vZGU6IGN1c3RvbS5jdWJpY0ludGVycG9sYXRpb25Nb2RlID8gY3VzdG9tLmN1YmljSW50ZXJwb2xhdGlvbk1vZGUgOiBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KGRhdGFzZXQuY3ViaWNJbnRlcnBvbGF0aW9uTW9kZSwgbGluZUVsZW1lbnRPcHRpb25zLmN1YmljSW50ZXJwb2xhdGlvbk1vZGUpLAoJCQkJfTsKCgkJCQlsaW5lLnBpdm90KCk7CgkJCX0KCgkJCS8vIFVwZGF0ZSBQb2ludHMKCQkJZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCW1lLnVwZGF0ZUVsZW1lbnQocG9pbnRzW2ldLCBpLCByZXNldCk7CgkJCX0KCgkJCWlmIChzaG93TGluZSAmJiBsaW5lLl9tb2RlbC50ZW5zaW9uICE9PSAwKSB7CgkJCQltZS51cGRhdGVCZXppZXJDb250cm9sUG9pbnRzKCk7CgkJCX0KCgkJCS8vIE5vdyBwaXZvdCB0aGUgcG9pbnQgZm9yIGFuaW1hdGlvbgoJCQlmb3IgKGkgPSAwLCBpbGVuID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCQkJcG9pbnRzW2ldLnBpdm90KCk7CgkJCX0KCQl9LAoKCQlnZXRQb2ludEJhY2tncm91bmRDb2xvcjogZnVuY3Rpb24ocG9pbnQsIGluZGV4KSB7CgkJCXZhciBiYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQuYmFja2dyb3VuZENvbG9yOwoJCQl2YXIgZGF0YXNldCA9IHRoaXMuZ2V0RGF0YXNldCgpOwoJCQl2YXIgY3VzdG9tID0gcG9pbnQuY3VzdG9tIHx8IHt9OwoKCQkJaWYgKGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IpIHsKCQkJCWJhY2tncm91bmRDb2xvciA9IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3I7CgkJCX0gZWxzZSBpZiAoZGF0YXNldC5wb2ludEJhY2tncm91bmRDb2xvcikgewoJCQkJYmFja2dyb3VuZENvbG9yID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEJhY2tncm91bmRDb2xvciwgaW5kZXgsIGJhY2tncm91bmRDb2xvcik7CgkJCX0gZWxzZSBpZiAoZGF0YXNldC5iYWNrZ3JvdW5kQ29sb3IpIHsKCQkJCWJhY2tncm91bmRDb2xvciA9IGRhdGFzZXQuYmFja2dyb3VuZENvbG9yOwoJCQl9CgoJCQlyZXR1cm4gYmFja2dyb3VuZENvbG9yOwoJCX0sCgoJCWdldFBvaW50Qm9yZGVyQ29sb3I6IGZ1bmN0aW9uKHBvaW50LCBpbmRleCkgewoJCQl2YXIgYm9yZGVyQ29sb3IgPSB0aGlzLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQuYm9yZGVyQ29sb3I7CgkJCXZhciBkYXRhc2V0ID0gdGhpcy5nZXREYXRhc2V0KCk7CgkJCXZhciBjdXN0b20gPSBwb2ludC5jdXN0b20gfHwge307CgoJCQlpZiAoY3VzdG9tLmJvcmRlckNvbG9yKSB7CgkJCQlib3JkZXJDb2xvciA9IGN1c3RvbS5ib3JkZXJDb2xvcjsKCQkJfSBlbHNlIGlmIChkYXRhc2V0LnBvaW50Qm9yZGVyQ29sb3IpIHsKCQkJCWJvcmRlckNvbG9yID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEJvcmRlckNvbG9yLCBpbmRleCwgYm9yZGVyQ29sb3IpOwoJCQl9IGVsc2UgaWYgKGRhdGFzZXQuYm9yZGVyQ29sb3IpIHsKCQkJCWJvcmRlckNvbG9yID0gZGF0YXNldC5ib3JkZXJDb2xvcjsKCQkJfQoKCQkJcmV0dXJuIGJvcmRlckNvbG9yOwoJCX0sCgoJCWdldFBvaW50Qm9yZGVyV2lkdGg6IGZ1bmN0aW9uKHBvaW50LCBpbmRleCkgewoJCQl2YXIgYm9yZGVyV2lkdGggPSB0aGlzLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQuYm9yZGVyV2lkdGg7CgkJCXZhciBkYXRhc2V0ID0gdGhpcy5nZXREYXRhc2V0KCk7CgkJCXZhciBjdXN0b20gPSBwb2ludC5jdXN0b20gfHwge307CgoJCQlpZiAoIWlzTmFOKGN1c3RvbS5ib3JkZXJXaWR0aCkpIHsKCQkJCWJvcmRlcldpZHRoID0gY3VzdG9tLmJvcmRlcldpZHRoOwoJCQl9IGVsc2UgaWYgKCFpc05hTihkYXRhc2V0LnBvaW50Qm9yZGVyV2lkdGgpIHx8IGhlbHBlcnMuaXNBcnJheShkYXRhc2V0LnBvaW50Qm9yZGVyV2lkdGgpKSB7CgkJCQlib3JkZXJXaWR0aCA9IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQucG9pbnRCb3JkZXJXaWR0aCwgaW5kZXgsIGJvcmRlcldpZHRoKTsKCQkJfSBlbHNlIGlmICghaXNOYU4oZGF0YXNldC5ib3JkZXJXaWR0aCkpIHsKCQkJCWJvcmRlcldpZHRoID0gZGF0YXNldC5ib3JkZXJXaWR0aDsKCQkJfQoKCQkJcmV0dXJuIGJvcmRlcldpZHRoOwoJCX0sCgoJCXVwZGF0ZUVsZW1lbnQ6IGZ1bmN0aW9uKHBvaW50LCBpbmRleCwgcmVzZXQpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCXZhciBjdXN0b20gPSBwb2ludC5jdXN0b20gfHwge307CgkJCXZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpOwoJCQl2YXIgZGF0YXNldEluZGV4ID0gbWUuaW5kZXg7CgkJCXZhciB2YWx1ZSA9IGRhdGFzZXQuZGF0YVtpbmRleF07CgkJCXZhciB5U2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueUF4aXNJRCk7CgkJCXZhciB4U2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueEF4aXNJRCk7CgkJCXZhciBwb2ludE9wdGlvbnMgPSBtZS5jaGFydC5vcHRpb25zLmVsZW1lbnRzLnBvaW50OwoJCQl2YXIgeCwgeTsKCgkJCS8vIENvbXBhdGliaWxpdHk6IElmIHRoZSBwcm9wZXJ0aWVzIGFyZSBkZWZpbmVkIHdpdGggb25seSB0aGUgb2xkIG5hbWUsIHVzZSB0aG9zZSB2YWx1ZXMKCQkJaWYgKChkYXRhc2V0LnJhZGl1cyAhPT0gdW5kZWZpbmVkKSAmJiAoZGF0YXNldC5wb2ludFJhZGl1cyA9PT0gdW5kZWZpbmVkKSkgewoJCQkJZGF0YXNldC5wb2ludFJhZGl1cyA9IGRhdGFzZXQucmFkaXVzOwoJCQl9CgkJCWlmICgoZGF0YXNldC5oaXRSYWRpdXMgIT09IHVuZGVmaW5lZCkgJiYgKGRhdGFzZXQucG9pbnRIaXRSYWRpdXMgPT09IHVuZGVmaW5lZCkpIHsKCQkJCWRhdGFzZXQucG9pbnRIaXRSYWRpdXMgPSBkYXRhc2V0LmhpdFJhZGl1czsKCQkJfQoKCQkJeCA9IHhTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgPyB2YWx1ZSA6IE5hTiwgaW5kZXgsIGRhdGFzZXRJbmRleCk7CgkJCXkgPSByZXNldCA/IHlTY2FsZS5nZXRCYXNlUGl4ZWwoKSA6IG1lLmNhbGN1bGF0ZVBvaW50WSh2YWx1ZSwgaW5kZXgsIGRhdGFzZXRJbmRleCk7CgoJCQkvLyBVdGlsaXR5CgkJCXBvaW50Ll94U2NhbGUgPSB4U2NhbGU7CgkJCXBvaW50Ll95U2NhbGUgPSB5U2NhbGU7CgkJCXBvaW50Ll9kYXRhc2V0SW5kZXggPSBkYXRhc2V0SW5kZXg7CgkJCXBvaW50Ll9pbmRleCA9IGluZGV4OwoKCQkJLy8gRGVzaXJlZCB2aWV3IHByb3BlcnRpZXMKCQkJcG9pbnQuX21vZGVsID0gewoJCQkJeDogeCwKCQkJCXk6IHksCgkJCQlza2lwOiBjdXN0b20uc2tpcCB8fCBpc05hTih4KSB8fCBpc05hTih5KSwKCQkJCS8vIEFwcGVhcmFuY2UKCQkJCXJhZGl1czogY3VzdG9tLnJhZGl1cyB8fCBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50UmFkaXVzLCBpbmRleCwgcG9pbnRPcHRpb25zLnJhZGl1cyksCgkJCQlwb2ludFN0eWxlOiBjdXN0b20ucG9pbnRTdHlsZSB8fCBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50U3R5bGUsIGluZGV4LCBwb2ludE9wdGlvbnMucG9pbnRTdHlsZSksCgkJCQliYWNrZ3JvdW5kQ29sb3I6IG1lLmdldFBvaW50QmFja2dyb3VuZENvbG9yKHBvaW50LCBpbmRleCksCgkJCQlib3JkZXJDb2xvcjogbWUuZ2V0UG9pbnRCb3JkZXJDb2xvcihwb2ludCwgaW5kZXgpLAoJCQkJYm9yZGVyV2lkdGg6IG1lLmdldFBvaW50Qm9yZGVyV2lkdGgocG9pbnQsIGluZGV4KSwKCQkJCXRlbnNpb246IG1ldGEuZGF0YXNldC5fbW9kZWwgPyBtZXRhLmRhdGFzZXQuX21vZGVsLnRlbnNpb24gOiAwLAoJCQkJc3RlcHBlZExpbmU6IG1ldGEuZGF0YXNldC5fbW9kZWwgPyBtZXRhLmRhdGFzZXQuX21vZGVsLnN0ZXBwZWRMaW5lIDogZmFsc2UsCgkJCQkvLyBUb29sdGlwCgkJCQloaXRSYWRpdXM6IGN1c3RvbS5oaXRSYWRpdXMgfHwgaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEhpdFJhZGl1cywgaW5kZXgsIHBvaW50T3B0aW9ucy5oaXRSYWRpdXMpCgkJCX07CgkJfSwKCgkJY2FsY3VsYXRlUG9pbnRZOiBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGRhdGFzZXRJbmRleCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgY2hhcnQgPSBtZS5jaGFydDsKCQkJdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCXZhciB5U2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueUF4aXNJRCk7CgkJCXZhciBzdW1Qb3MgPSAwOwoJCQl2YXIgc3VtTmVnID0gMDsKCQkJdmFyIGksIGRzLCBkc01ldGE7CgoJCQlpZiAoeVNjYWxlLm9wdGlvbnMuc3RhY2tlZCkgewoJCQkJZm9yIChpID0gMDsgaSA8IGRhdGFzZXRJbmRleDsgaSsrKSB7CgkJCQkJZHMgPSBjaGFydC5kYXRhLmRhdGFzZXRzW2ldOwoJCQkJCWRzTWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGkpOwoJCQkJCWlmIChkc01ldGEudHlwZSA9PT0gJ2xpbmUnICYmIGRzTWV0YS55QXhpc0lEID09PSB5U2NhbGUuaWQgJiYgY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShpKSkgewoJCQkJCQl2YXIgc3RhY2tlZFJpZ2h0VmFsdWUgPSBOdW1iZXIoeVNjYWxlLmdldFJpZ2h0VmFsdWUoZHMuZGF0YVtpbmRleF0pKTsKCQkJCQkJaWYgKHN0YWNrZWRSaWdodFZhbHVlIDwgMCkgewoJCQkJCQkJc3VtTmVnICs9IHN0YWNrZWRSaWdodFZhbHVlIHx8IDA7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlzdW1Qb3MgKz0gc3RhY2tlZFJpZ2h0VmFsdWUgfHwgMDsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQl2YXIgcmlnaHRWYWx1ZSA9IE51bWJlcih5U2NhbGUuZ2V0UmlnaHRWYWx1ZSh2YWx1ZSkpOwoJCQkJaWYgKHJpZ2h0VmFsdWUgPCAwKSB7CgkJCQkJcmV0dXJuIHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHN1bU5lZyArIHJpZ2h0VmFsdWUpOwoJCQkJfQoJCQkJcmV0dXJuIHlTY2FsZS5nZXRQaXhlbEZvclZhbHVlKHN1bVBvcyArIHJpZ2h0VmFsdWUpOwoJCQl9CgoJCQlyZXR1cm4geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUodmFsdWUpOwoJCX0sCgoJCXVwZGF0ZUJlemllckNvbnRyb2xQb2ludHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKCQkJdmFyIGFyZWEgPSBtZS5jaGFydC5jaGFydEFyZWE7CgkJCXZhciBwb2ludHMgPSAobWV0YS5kYXRhIHx8IFtdKTsKCQkJdmFyIGksIGlsZW4sIHBvaW50LCBtb2RlbCwgY29udHJvbFBvaW50czsKCgkJCS8vIE9ubHkgY29uc2lkZXIgcG9pbnRzIHRoYXQgYXJlIGRyYXduIGluIGNhc2UgdGhlIHNwYW5HYXBzIG9wdGlvbiBpcyB1c2VkCgkJCWlmIChtZXRhLmRhdGFzZXQuX21vZGVsLnNwYW5HYXBzKSB7CgkJCQlwb2ludHMgPSBwb2ludHMuZmlsdGVyKGZ1bmN0aW9uKHB0KSB7CgkJCQkJcmV0dXJuICFwdC5fbW9kZWwuc2tpcDsKCQkJCX0pOwoJCQl9CgoJCQlmdW5jdGlvbiBjYXBDb250cm9sUG9pbnQocHQsIG1pbiwgbWF4KSB7CgkJCQlyZXR1cm4gTWF0aC5tYXgoTWF0aC5taW4ocHQsIG1heCksIG1pbik7CgkJCX0KCgkJCWlmIChtZXRhLmRhdGFzZXQuX21vZGVsLmN1YmljSW50ZXJwb2xhdGlvbk1vZGUgPT09ICdtb25vdG9uZScpIHsKCQkJCWhlbHBlcnMuc3BsaW5lQ3VydmVNb25vdG9uZShwb2ludHMpOwoJCQl9IGVsc2UgewoJCQkJZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCQlwb2ludCA9IHBvaW50c1tpXTsKCQkJCQltb2RlbCA9IHBvaW50Ll9tb2RlbDsKCQkJCQljb250cm9sUG9pbnRzID0gaGVscGVycy5zcGxpbmVDdXJ2ZSgKCQkJCQkJaGVscGVycy5wcmV2aW91c0l0ZW0ocG9pbnRzLCBpKS5fbW9kZWwsCgkJCQkJCW1vZGVsLAoJCQkJCQloZWxwZXJzLm5leHRJdGVtKHBvaW50cywgaSkuX21vZGVsLAoJCQkJCQltZXRhLmRhdGFzZXQuX21vZGVsLnRlbnNpb24KCQkJCQkpOwoJCQkJCW1vZGVsLmNvbnRyb2xQb2ludFByZXZpb3VzWCA9IGNvbnRyb2xQb2ludHMucHJldmlvdXMueDsKCQkJCQltb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1kgPSBjb250cm9sUG9pbnRzLnByZXZpb3VzLnk7CgkJCQkJbW9kZWwuY29udHJvbFBvaW50TmV4dFggPSBjb250cm9sUG9pbnRzLm5leHQueDsKCQkJCQltb2RlbC5jb250cm9sUG9pbnROZXh0WSA9IGNvbnRyb2xQb2ludHMubmV4dC55OwoJCQkJfQoJCQl9CgoJCQlpZiAobWUuY2hhcnQub3B0aW9ucy5lbGVtZW50cy5saW5lLmNhcEJlemllclBvaW50cykgewoJCQkJZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCQltb2RlbCA9IHBvaW50c1tpXS5fbW9kZWw7CgkJCQkJbW9kZWwuY29udHJvbFBvaW50UHJldmlvdXNYID0gY2FwQ29udHJvbFBvaW50KG1vZGVsLmNvbnRyb2xQb2ludFByZXZpb3VzWCwgYXJlYS5sZWZ0LCBhcmVhLnJpZ2h0KTsKCQkJCQltb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1kgPSBjYXBDb250cm9sUG9pbnQobW9kZWwuY29udHJvbFBvaW50UHJldmlvdXNZLCBhcmVhLnRvcCwgYXJlYS5ib3R0b20pOwoJCQkJCW1vZGVsLmNvbnRyb2xQb2ludE5leHRYID0gY2FwQ29udHJvbFBvaW50KG1vZGVsLmNvbnRyb2xQb2ludE5leHRYLCBhcmVhLmxlZnQsIGFyZWEucmlnaHQpOwoJCQkJCW1vZGVsLmNvbnRyb2xQb2ludE5leHRZID0gY2FwQ29udHJvbFBvaW50KG1vZGVsLmNvbnRyb2xQb2ludE5leHRZLCBhcmVhLnRvcCwgYXJlYS5ib3R0b20pOwoJCQkJfQoJCQl9CgkJfSwKCgkJZHJhdzogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBjaGFydCA9IG1lLmNoYXJ0OwoJCQl2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKCQkJdmFyIHBvaW50cyA9IG1ldGEuZGF0YSB8fCBbXTsKCQkJdmFyIGFyZWEgPSBjaGFydC5jaGFydEFyZWE7CgkJCXZhciBpbGVuID0gcG9pbnRzLmxlbmd0aDsKCQkJdmFyIGkgPSAwOwoKCQkJaGVscGVycy5jYW52YXMuY2xpcEFyZWEoY2hhcnQuY3R4LCBhcmVhKTsKCgkJCWlmIChsaW5lRW5hYmxlZChtZS5nZXREYXRhc2V0KCksIGNoYXJ0Lm9wdGlvbnMpKSB7CgkJCQltZXRhLmRhdGFzZXQuZHJhdygpOwoJCQl9CgoJCQloZWxwZXJzLmNhbnZhcy51bmNsaXBBcmVhKGNoYXJ0LmN0eCk7CgoJCQkvLyBEcmF3IHRoZSBwb2ludHMKCQkJZm9yICg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCXBvaW50c1tpXS5kcmF3KGFyZWEpOwoJCQl9CgkJfSwKCgkJc2V0SG92ZXJTdHlsZTogZnVuY3Rpb24ocG9pbnQpIHsKCQkJLy8gUG9pbnQKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbcG9pbnQuX2RhdGFzZXRJbmRleF07CgkJCXZhciBpbmRleCA9IHBvaW50Ll9pbmRleDsKCQkJdmFyIGN1c3RvbSA9IHBvaW50LmN1c3RvbSB8fCB7fTsKCQkJdmFyIG1vZGVsID0gcG9pbnQuX21vZGVsOwoKCQkJbW9kZWwucmFkaXVzID0gY3VzdG9tLmhvdmVyUmFkaXVzIHx8IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQucG9pbnRIb3ZlclJhZGl1cywgaW5kZXgsIHRoaXMuY2hhcnQub3B0aW9ucy5lbGVtZW50cy5wb2ludC5ob3ZlclJhZGl1cyk7CgkJCW1vZGVsLmJhY2tncm91bmRDb2xvciA9IGN1c3RvbS5ob3ZlckJhY2tncm91bmRDb2xvciB8fCBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50SG92ZXJCYWNrZ3JvdW5kQ29sb3IsIGluZGV4LCBoZWxwZXJzLmdldEhvdmVyQ29sb3IobW9kZWwuYmFja2dyb3VuZENvbG9yKSk7CgkJCW1vZGVsLmJvcmRlckNvbG9yID0gY3VzdG9tLmhvdmVyQm9yZGVyQ29sb3IgfHwgaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEhvdmVyQm9yZGVyQ29sb3IsIGluZGV4LCBoZWxwZXJzLmdldEhvdmVyQ29sb3IobW9kZWwuYm9yZGVyQ29sb3IpKTsKCQkJbW9kZWwuYm9yZGVyV2lkdGggPSBjdXN0b20uaG92ZXJCb3JkZXJXaWR0aCB8fCBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50SG92ZXJCb3JkZXJXaWR0aCwgaW5kZXgsIG1vZGVsLmJvcmRlcldpZHRoKTsKCQl9LAoKCQlyZW1vdmVIb3ZlclN0eWxlOiBmdW5jdGlvbihwb2ludCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgZGF0YXNldCA9IG1lLmNoYXJ0LmRhdGEuZGF0YXNldHNbcG9pbnQuX2RhdGFzZXRJbmRleF07CgkJCXZhciBpbmRleCA9IHBvaW50Ll9pbmRleDsKCQkJdmFyIGN1c3RvbSA9IHBvaW50LmN1c3RvbSB8fCB7fTsKCQkJdmFyIG1vZGVsID0gcG9pbnQuX21vZGVsOwoKCQkJLy8gQ29tcGF0aWJpbGl0eTogSWYgdGhlIHByb3BlcnRpZXMgYXJlIGRlZmluZWQgd2l0aCBvbmx5IHRoZSBvbGQgbmFtZSwgdXNlIHRob3NlIHZhbHVlcwoJCQlpZiAoKGRhdGFzZXQucmFkaXVzICE9PSB1bmRlZmluZWQpICYmIChkYXRhc2V0LnBvaW50UmFkaXVzID09PSB1bmRlZmluZWQpKSB7CgkJCQlkYXRhc2V0LnBvaW50UmFkaXVzID0gZGF0YXNldC5yYWRpdXM7CgkJCX0KCgkJCW1vZGVsLnJhZGl1cyA9IGN1c3RvbS5yYWRpdXMgfHwgaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludFJhZGl1cywgaW5kZXgsIG1lLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQucmFkaXVzKTsKCQkJbW9kZWwuYmFja2dyb3VuZENvbG9yID0gbWUuZ2V0UG9pbnRCYWNrZ3JvdW5kQ29sb3IocG9pbnQsIGluZGV4KTsKCQkJbW9kZWwuYm9yZGVyQ29sb3IgPSBtZS5nZXRQb2ludEJvcmRlckNvbG9yKHBvaW50LCBpbmRleCk7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gbWUuZ2V0UG9pbnRCb3JkZXJXaWR0aChwb2ludCwgaW5kZXgpOwoJCX0KCX0pOwp9OwoKfSx7IjI1IjoyNSwiNDAiOjQwLCI0NSI6NDV9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgZWxlbWVudHMgPSByZXF1aXJlKDQwKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ3BvbGFyQXJlYScsIHsKCXNjYWxlOiB7CgkJdHlwZTogJ3JhZGlhbExpbmVhcicsCgkJYW5nbGVMaW5lczogewoJCQlkaXNwbGF5OiBmYWxzZQoJCX0sCgkJZ3JpZExpbmVzOiB7CgkJCWNpcmN1bGFyOiB0cnVlCgkJfSwKCQlwb2ludExhYmVsczogewoJCQlkaXNwbGF5OiBmYWxzZQoJCX0sCgkJdGlja3M6IHsKCQkJYmVnaW5BdFplcm86IHRydWUKCQl9Cgl9LAoKCS8vIEJvb2xlYW4gLSBXaGV0aGVyIHRvIGFuaW1hdGUgdGhlIHJvdGF0aW9uIG9mIHRoZSBjaGFydAoJYW5pbWF0aW9uOiB7CgkJYW5pbWF0ZVJvdGF0ZTogdHJ1ZSwKCQlhbmltYXRlU2NhbGU6IHRydWUKCX0sCgoJc3RhcnRBbmdsZTogLTAuNSAqIE1hdGguUEksCglsZWdlbmRDYWxsYmFjazogZnVuY3Rpb24oY2hhcnQpIHsKCQl2YXIgdGV4dCA9IFtdOwoJCXRleHQucHVzaCgnPHVsIGNsYXNzPSInICsgY2hhcnQuaWQgKyAnLWxlZ2VuZCI+Jyk7CgoJCXZhciBkYXRhID0gY2hhcnQuZGF0YTsKCQl2YXIgZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzOwoJCXZhciBsYWJlbHMgPSBkYXRhLmxhYmVsczsKCgkJaWYgKGRhdGFzZXRzLmxlbmd0aCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGRhdGFzZXRzWzBdLmRhdGEubGVuZ3RoOyArK2kpIHsKCQkJCXRleHQucHVzaCgnPGxpPjxzcGFuIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOicgKyBkYXRhc2V0c1swXS5iYWNrZ3JvdW5kQ29sb3JbaV0gKyAnIj48L3NwYW4+Jyk7CgkJCQlpZiAobGFiZWxzW2ldKSB7CgkJCQkJdGV4dC5wdXNoKGxhYmVsc1tpXSk7CgkJCQl9CgkJCQl0ZXh0LnB1c2goJzwvbGk+Jyk7CgkJCX0KCQl9CgoJCXRleHQucHVzaCgnPC91bD4nKTsKCQlyZXR1cm4gdGV4dC5qb2luKCcnKTsKCX0sCglsZWdlbmQ6IHsKCQlsYWJlbHM6IHsKCQkJZ2VuZXJhdGVMYWJlbHM6IGZ1bmN0aW9uKGNoYXJ0KSB7CgkJCQl2YXIgZGF0YSA9IGNoYXJ0LmRhdGE7CgkJCQlpZiAoZGF0YS5sYWJlbHMubGVuZ3RoICYmIGRhdGEuZGF0YXNldHMubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIGRhdGEubGFiZWxzLm1hcChmdW5jdGlvbihsYWJlbCwgaSkgewoJCQkJCQl2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKDApOwoJCQkJCQl2YXIgZHMgPSBkYXRhLmRhdGFzZXRzWzBdOwoJCQkJCQl2YXIgYXJjID0gbWV0YS5kYXRhW2ldOwoJCQkJCQl2YXIgY3VzdG9tID0gYXJjLmN1c3RvbSB8fCB7fTsKCQkJCQkJdmFyIHZhbHVlQXRJbmRleE9yRGVmYXVsdCA9IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0OwoJCQkJCQl2YXIgYXJjT3B0cyA9IGNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMuYXJjOwoJCQkJCQl2YXIgZmlsbCA9IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgPyBjdXN0b20uYmFja2dyb3VuZENvbG9yIDogdmFsdWVBdEluZGV4T3JEZWZhdWx0KGRzLmJhY2tncm91bmRDb2xvciwgaSwgYXJjT3B0cy5iYWNrZ3JvdW5kQ29sb3IpOwoJCQkJCQl2YXIgc3Ryb2tlID0gY3VzdG9tLmJvcmRlckNvbG9yID8gY3VzdG9tLmJvcmRlckNvbG9yIDogdmFsdWVBdEluZGV4T3JEZWZhdWx0KGRzLmJvcmRlckNvbG9yLCBpLCBhcmNPcHRzLmJvcmRlckNvbG9yKTsKCQkJCQkJdmFyIGJ3ID0gY3VzdG9tLmJvcmRlcldpZHRoID8gY3VzdG9tLmJvcmRlcldpZHRoIDogdmFsdWVBdEluZGV4T3JEZWZhdWx0KGRzLmJvcmRlcldpZHRoLCBpLCBhcmNPcHRzLmJvcmRlcldpZHRoKTsKCgkJCQkJCXJldHVybiB7CgkJCQkJCQl0ZXh0OiBsYWJlbCwKCQkJCQkJCWZpbGxTdHlsZTogZmlsbCwKCQkJCQkJCXN0cm9rZVN0eWxlOiBzdHJva2UsCgkJCQkJCQlsaW5lV2lkdGg6IGJ3LAoJCQkJCQkJaGlkZGVuOiBpc05hTihkcy5kYXRhW2ldKSB8fCBtZXRhLmRhdGFbaV0uaGlkZGVuLAoKCQkJCQkJCS8vIEV4dHJhIGRhdGEgdXNlZCBmb3IgdG9nZ2xpbmcgdGhlIGNvcnJlY3QgaXRlbQoJCQkJCQkJaW5kZXg6IGkKCQkJCQkJfTsKCQkJCQl9KTsKCQkJCX0KCQkJCXJldHVybiBbXTsKCQkJfQoJCX0sCgoJCW9uQ2xpY2s6IGZ1bmN0aW9uKGUsIGxlZ2VuZEl0ZW0pIHsKCQkJdmFyIGluZGV4ID0gbGVnZW5kSXRlbS5pbmRleDsKCQkJdmFyIGNoYXJ0ID0gdGhpcy5jaGFydDsKCQkJdmFyIGksIGlsZW4sIG1ldGE7CgoJCQlmb3IgKGkgPSAwLCBpbGVuID0gKGNoYXJ0LmRhdGEuZGF0YXNldHMgfHwgW10pLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCQkJbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGkpOwoJCQkJbWV0YS5kYXRhW2luZGV4XS5oaWRkZW4gPSAhbWV0YS5kYXRhW2luZGV4XS5oaWRkZW47CgkJCX0KCgkJCWNoYXJ0LnVwZGF0ZSgpOwoJCX0KCX0sCgoJLy8gTmVlZCB0byBvdmVycmlkZSB0aGVzZSB0byBnaXZlIGEgbmljZSBkZWZhdWx0Cgl0b29sdGlwczogewoJCWNhbGxiYWNrczogewoJCQl0aXRsZTogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJyc7CgkJCX0sCgkJCWxhYmVsOiBmdW5jdGlvbihpdGVtLCBkYXRhKSB7CgkJCQlyZXR1cm4gZGF0YS5sYWJlbHNbaXRlbS5pbmRleF0gKyAnOiAnICsgaXRlbS55TGFiZWw7CgkJCX0KCQl9Cgl9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCUNoYXJ0LmNvbnRyb2xsZXJzLnBvbGFyQXJlYSA9IENoYXJ0LkRhdGFzZXRDb250cm9sbGVyLmV4dGVuZCh7CgoJCWRhdGFFbGVtZW50VHlwZTogZWxlbWVudHMuQXJjLAoKCQlsaW5rU2NhbGVzOiBoZWxwZXJzLm5vb3AsCgoJCXVwZGF0ZTogZnVuY3Rpb24ocmVzZXQpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciBjaGFydEFyZWEgPSBjaGFydC5jaGFydEFyZWE7CgkJCXZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwoJCQl2YXIgb3B0cyA9IGNoYXJ0Lm9wdGlvbnM7CgkJCXZhciBhcmNPcHRzID0gb3B0cy5lbGVtZW50cy5hcmM7CgkJCXZhciBtaW5TaXplID0gTWF0aC5taW4oY2hhcnRBcmVhLnJpZ2h0IC0gY2hhcnRBcmVhLmxlZnQsIGNoYXJ0QXJlYS5ib3R0b20gLSBjaGFydEFyZWEudG9wKTsKCQkJY2hhcnQub3V0ZXJSYWRpdXMgPSBNYXRoLm1heCgobWluU2l6ZSAtIGFyY09wdHMuYm9yZGVyV2lkdGggLyAyKSAvIDIsIDApOwoJCQljaGFydC5pbm5lclJhZGl1cyA9IE1hdGgubWF4KG9wdHMuY3V0b3V0UGVyY2VudGFnZSA/IChjaGFydC5vdXRlclJhZGl1cyAvIDEwMCkgKiAob3B0cy5jdXRvdXRQZXJjZW50YWdlKSA6IDEsIDApOwoJCQljaGFydC5yYWRpdXNMZW5ndGggPSAoY2hhcnQub3V0ZXJSYWRpdXMgLSBjaGFydC5pbm5lclJhZGl1cykgLyBjaGFydC5nZXRWaXNpYmxlRGF0YXNldENvdW50KCk7CgoJCQltZS5vdXRlclJhZGl1cyA9IGNoYXJ0Lm91dGVyUmFkaXVzIC0gKGNoYXJ0LnJhZGl1c0xlbmd0aCAqIG1lLmluZGV4KTsKCQkJbWUuaW5uZXJSYWRpdXMgPSBtZS5vdXRlclJhZGl1cyAtIGNoYXJ0LnJhZGl1c0xlbmd0aDsKCgkJCW1ldGEuY291bnQgPSBtZS5jb3VudFZpc2libGVFbGVtZW50cygpOwoKCQkJaGVscGVycy5lYWNoKG1ldGEuZGF0YSwgZnVuY3Rpb24oYXJjLCBpbmRleCkgewoJCQkJbWUudXBkYXRlRWxlbWVudChhcmMsIGluZGV4LCByZXNldCk7CgkJCX0pOwoJCX0sCgoJCXVwZGF0ZUVsZW1lbnQ6IGZ1bmN0aW9uKGFyYywgaW5kZXgsIHJlc2V0KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBjaGFydCA9IG1lLmNoYXJ0OwoJCQl2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTsKCQkJdmFyIG9wdHMgPSBjaGFydC5vcHRpb25zOwoJCQl2YXIgYW5pbWF0aW9uT3B0cyA9IG9wdHMuYW5pbWF0aW9uOwoJCQl2YXIgc2NhbGUgPSBjaGFydC5zY2FsZTsKCQkJdmFyIGxhYmVscyA9IGNoYXJ0LmRhdGEubGFiZWxzOwoKCQkJdmFyIGNpcmN1bWZlcmVuY2UgPSBtZS5jYWxjdWxhdGVDaXJjdW1mZXJlbmNlKGRhdGFzZXQuZGF0YVtpbmRleF0pOwoJCQl2YXIgY2VudGVyWCA9IHNjYWxlLnhDZW50ZXI7CgkJCXZhciBjZW50ZXJZID0gc2NhbGUueUNlbnRlcjsKCgkJCS8vIElmIHRoZXJlIGlzIE5hTiBkYXRhIGJlZm9yZSB1cywgd2UgbmVlZCB0byBjYWxjdWxhdGUgdGhlIHN0YXJ0aW5nIGFuZ2xlIGNvcnJlY3RseS4KCQkJLy8gV2UgY291bGQgYmUgd2F5IG1vcmUgZWZmaWNpZW50IGhlcmUsIGJ1dCBpdHMgdW5saWtlbHkgdGhhdCB0aGUgcG9sYXIgYXJlYSBjaGFydCB3aWxsIGhhdmUgYSBsb3Qgb2YgZGF0YQoJCQl2YXIgdmlzaWJsZUNvdW50ID0gMDsKCQkJdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgaW5kZXg7ICsraSkgewoJCQkJaWYgKCFpc05hTihkYXRhc2V0LmRhdGFbaV0pICYmICFtZXRhLmRhdGFbaV0uaGlkZGVuKSB7CgkJCQkJKyt2aXNpYmxlQ291bnQ7CgkJCQl9CgkJCX0KCgkJCS8vIHZhciBuZWdIYWxmUEkgPSAtMC41ICogTWF0aC5QSTsKCQkJdmFyIGRhdGFzZXRTdGFydEFuZ2xlID0gb3B0cy5zdGFydEFuZ2xlOwoJCQl2YXIgZGlzdGFuY2UgPSBhcmMuaGlkZGVuID8gMCA6IHNjYWxlLmdldERpc3RhbmNlRnJvbUNlbnRlckZvclZhbHVlKGRhdGFzZXQuZGF0YVtpbmRleF0pOwoJCQl2YXIgc3RhcnRBbmdsZSA9IGRhdGFzZXRTdGFydEFuZ2xlICsgKGNpcmN1bWZlcmVuY2UgKiB2aXNpYmxlQ291bnQpOwoJCQl2YXIgZW5kQW5nbGUgPSBzdGFydEFuZ2xlICsgKGFyYy5oaWRkZW4gPyAwIDogY2lyY3VtZmVyZW5jZSk7CgoJCQl2YXIgcmVzZXRSYWRpdXMgPSBhbmltYXRpb25PcHRzLmFuaW1hdGVTY2FsZSA/IDAgOiBzY2FsZS5nZXREaXN0YW5jZUZyb21DZW50ZXJGb3JWYWx1ZShkYXRhc2V0LmRhdGFbaW5kZXhdKTsKCgkJCWhlbHBlcnMuZXh0ZW5kKGFyYywgewoJCQkJLy8gVXRpbGl0eQoJCQkJX2RhdGFzZXRJbmRleDogbWUuaW5kZXgsCgkJCQlfaW5kZXg6IGluZGV4LAoJCQkJX3NjYWxlOiBzY2FsZSwKCgkJCQkvLyBEZXNpcmVkIHZpZXcgcHJvcGVydGllcwoJCQkJX21vZGVsOiB7CgkJCQkJeDogY2VudGVyWCwKCQkJCQl5OiBjZW50ZXJZLAoJCQkJCWlubmVyUmFkaXVzOiAwLAoJCQkJCW91dGVyUmFkaXVzOiByZXNldCA/IHJlc2V0UmFkaXVzIDogZGlzdGFuY2UsCgkJCQkJc3RhcnRBbmdsZTogcmVzZXQgJiYgYW5pbWF0aW9uT3B0cy5hbmltYXRlUm90YXRlID8gZGF0YXNldFN0YXJ0QW5nbGUgOiBzdGFydEFuZ2xlLAoJCQkJCWVuZEFuZ2xlOiByZXNldCAmJiBhbmltYXRpb25PcHRzLmFuaW1hdGVSb3RhdGUgPyBkYXRhc2V0U3RhcnRBbmdsZSA6IGVuZEFuZ2xlLAoJCQkJCWxhYmVsOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChsYWJlbHMsIGluZGV4LCBsYWJlbHNbaW5kZXhdKQoJCQkJfQoJCQl9KTsKCgkJCS8vIEFwcGx5IGJvcmRlciBhbmQgZmlsbCBzdHlsZQoJCQltZS5yZW1vdmVIb3ZlclN0eWxlKGFyYyk7CgoJCQlhcmMucGl2b3QoKTsKCQl9LAoKCQlyZW1vdmVIb3ZlclN0eWxlOiBmdW5jdGlvbihhcmMpIHsKCQkJQ2hhcnQuRGF0YXNldENvbnRyb2xsZXIucHJvdG90eXBlLnJlbW92ZUhvdmVyU3R5bGUuY2FsbCh0aGlzLCBhcmMsIHRoaXMuY2hhcnQub3B0aW9ucy5lbGVtZW50cy5hcmMpOwoJCX0sCgoJCWNvdW50VmlzaWJsZUVsZW1lbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmdldERhdGFzZXQoKTsKCQkJdmFyIG1ldGEgPSB0aGlzLmdldE1ldGEoKTsKCQkJdmFyIGNvdW50ID0gMDsKCgkJCWhlbHBlcnMuZWFjaChtZXRhLmRhdGEsIGZ1bmN0aW9uKGVsZW1lbnQsIGluZGV4KSB7CgkJCQlpZiAoIWlzTmFOKGRhdGFzZXQuZGF0YVtpbmRleF0pICYmICFlbGVtZW50LmhpZGRlbikgewoJCQkJCWNvdW50Kys7CgkJCQl9CgkJCX0pOwoKCQkJcmV0dXJuIGNvdW50OwoJCX0sCgoJCWNhbGN1bGF0ZUNpcmN1bWZlcmVuY2U6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCXZhciBjb3VudCA9IHRoaXMuZ2V0TWV0YSgpLmNvdW50OwoJCQlpZiAoY291bnQgPiAwICYmICFpc05hTih2YWx1ZSkpIHsKCQkJCXJldHVybiAoMiAqIE1hdGguUEkpIC8gY291bnQ7CgkJCX0KCQkJcmV0dXJuIDA7CgkJfQoJfSk7Cn07Cgp9LHsiMjUiOjI1LCI0MCI6NDAsIjQ1Ijo0NX1dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGRlZmF1bHRzID0gcmVxdWlyZSgyNSk7CnZhciBlbGVtZW50cyA9IHJlcXVpcmUoNDApOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKZGVmYXVsdHMuX3NldCgncmFkYXInLCB7CglzY2FsZTogewoJCXR5cGU6ICdyYWRpYWxMaW5lYXInCgl9LAoJZWxlbWVudHM6IHsKCQlsaW5lOiB7CgkJCXRlbnNpb246IDAgLy8gbm8gYmV6aWVyIGluIHJhZGFyCgkJfQoJfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCglDaGFydC5jb250cm9sbGVycy5yYWRhciA9IENoYXJ0LkRhdGFzZXRDb250cm9sbGVyLmV4dGVuZCh7CgoJCWRhdGFzZXRFbGVtZW50VHlwZTogZWxlbWVudHMuTGluZSwKCgkJZGF0YUVsZW1lbnRUeXBlOiBlbGVtZW50cy5Qb2ludCwKCgkJbGlua1NjYWxlczogaGVscGVycy5ub29wLAoKCQl1cGRhdGU6IGZ1bmN0aW9uKHJlc2V0KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwoJCQl2YXIgbGluZSA9IG1ldGEuZGF0YXNldDsKCQkJdmFyIHBvaW50cyA9IG1ldGEuZGF0YTsKCQkJdmFyIGN1c3RvbSA9IGxpbmUuY3VzdG9tIHx8IHt9OwoJCQl2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTsKCQkJdmFyIGxpbmVFbGVtZW50T3B0aW9ucyA9IG1lLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMubGluZTsKCQkJdmFyIHNjYWxlID0gbWUuY2hhcnQuc2NhbGU7CgoJCQkvLyBDb21wYXRpYmlsaXR5OiBJZiB0aGUgcHJvcGVydGllcyBhcmUgZGVmaW5lZCB3aXRoIG9ubHkgdGhlIG9sZCBuYW1lLCB1c2UgdGhvc2UgdmFsdWVzCgkJCWlmICgoZGF0YXNldC50ZW5zaW9uICE9PSB1bmRlZmluZWQpICYmIChkYXRhc2V0LmxpbmVUZW5zaW9uID09PSB1bmRlZmluZWQpKSB7CgkJCQlkYXRhc2V0LmxpbmVUZW5zaW9uID0gZGF0YXNldC50ZW5zaW9uOwoJCQl9CgoJCQloZWxwZXJzLmV4dGVuZChtZXRhLmRhdGFzZXQsIHsKCQkJCS8vIFV0aWxpdHkKCQkJCV9kYXRhc2V0SW5kZXg6IG1lLmluZGV4LAoJCQkJX3NjYWxlOiBzY2FsZSwKCQkJCS8vIERhdGEKCQkJCV9jaGlsZHJlbjogcG9pbnRzLAoJCQkJX2xvb3A6IHRydWUsCgkJCQkvLyBNb2RlbAoJCQkJX21vZGVsOiB7CgkJCQkJLy8gQXBwZWFyYW5jZQoJCQkJCXRlbnNpb246IGN1c3RvbS50ZW5zaW9uID8gY3VzdG9tLnRlbnNpb24gOiBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KGRhdGFzZXQubGluZVRlbnNpb24sIGxpbmVFbGVtZW50T3B0aW9ucy50ZW5zaW9uKSwKCQkJCQliYWNrZ3JvdW5kQ29sb3I6IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgPyBjdXN0b20uYmFja2dyb3VuZENvbG9yIDogKGRhdGFzZXQuYmFja2dyb3VuZENvbG9yIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IpLAoJCQkJCWJvcmRlcldpZHRoOiBjdXN0b20uYm9yZGVyV2lkdGggPyBjdXN0b20uYm9yZGVyV2lkdGggOiAoZGF0YXNldC5ib3JkZXJXaWR0aCB8fCBsaW5lRWxlbWVudE9wdGlvbnMuYm9yZGVyV2lkdGgpLAoJCQkJCWJvcmRlckNvbG9yOiBjdXN0b20uYm9yZGVyQ29sb3IgPyBjdXN0b20uYm9yZGVyQ29sb3IgOiAoZGF0YXNldC5ib3JkZXJDb2xvciB8fCBsaW5lRWxlbWVudE9wdGlvbnMuYm9yZGVyQ29sb3IpLAoJCQkJCWZpbGw6IGN1c3RvbS5maWxsID8gY3VzdG9tLmZpbGwgOiAoZGF0YXNldC5maWxsICE9PSB1bmRlZmluZWQgPyBkYXRhc2V0LmZpbGwgOiBsaW5lRWxlbWVudE9wdGlvbnMuZmlsbCksCgkJCQkJYm9yZGVyQ2FwU3R5bGU6IGN1c3RvbS5ib3JkZXJDYXBTdHlsZSA/IGN1c3RvbS5ib3JkZXJDYXBTdHlsZSA6IChkYXRhc2V0LmJvcmRlckNhcFN0eWxlIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJDYXBTdHlsZSksCgkJCQkJYm9yZGVyRGFzaDogY3VzdG9tLmJvcmRlckRhc2ggPyBjdXN0b20uYm9yZGVyRGFzaCA6IChkYXRhc2V0LmJvcmRlckRhc2ggfHwgbGluZUVsZW1lbnRPcHRpb25zLmJvcmRlckRhc2gpLAoJCQkJCWJvcmRlckRhc2hPZmZzZXQ6IGN1c3RvbS5ib3JkZXJEYXNoT2Zmc2V0ID8gY3VzdG9tLmJvcmRlckRhc2hPZmZzZXQgOiAoZGF0YXNldC5ib3JkZXJEYXNoT2Zmc2V0IHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJEYXNoT2Zmc2V0KSwKCQkJCQlib3JkZXJKb2luU3R5bGU6IGN1c3RvbS5ib3JkZXJKb2luU3R5bGUgPyBjdXN0b20uYm9yZGVySm9pblN0eWxlIDogKGRhdGFzZXQuYm9yZGVySm9pblN0eWxlIHx8IGxpbmVFbGVtZW50T3B0aW9ucy5ib3JkZXJKb2luU3R5bGUpLAoJCQkJfQoJCQl9KTsKCgkJCW1ldGEuZGF0YXNldC5waXZvdCgpOwoKCQkJLy8gVXBkYXRlIFBvaW50cwoJCQloZWxwZXJzLmVhY2gocG9pbnRzLCBmdW5jdGlvbihwb2ludCwgaW5kZXgpIHsKCQkJCW1lLnVwZGF0ZUVsZW1lbnQocG9pbnQsIGluZGV4LCByZXNldCk7CgkJCX0sIG1lKTsKCgkJCS8vIFVwZGF0ZSBiZXppZXIgY29udHJvbCBwb2ludHMKCQkJbWUudXBkYXRlQmV6aWVyQ29udHJvbFBvaW50cygpOwoJCX0sCgkJdXBkYXRlRWxlbWVudDogZnVuY3Rpb24ocG9pbnQsIGluZGV4LCByZXNldCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgY3VzdG9tID0gcG9pbnQuY3VzdG9tIHx8IHt9OwoJCQl2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTsKCQkJdmFyIHNjYWxlID0gbWUuY2hhcnQuc2NhbGU7CgkJCXZhciBwb2ludEVsZW1lbnRPcHRpb25zID0gbWUuY2hhcnQub3B0aW9ucy5lbGVtZW50cy5wb2ludDsKCQkJdmFyIHBvaW50UG9zaXRpb24gPSBzY2FsZS5nZXRQb2ludFBvc2l0aW9uRm9yVmFsdWUoaW5kZXgsIGRhdGFzZXQuZGF0YVtpbmRleF0pOwoKCQkJLy8gQ29tcGF0aWJpbGl0eTogSWYgdGhlIHByb3BlcnRpZXMgYXJlIGRlZmluZWQgd2l0aCBvbmx5IHRoZSBvbGQgbmFtZSwgdXNlIHRob3NlIHZhbHVlcwoJCQlpZiAoKGRhdGFzZXQucmFkaXVzICE9PSB1bmRlZmluZWQpICYmIChkYXRhc2V0LnBvaW50UmFkaXVzID09PSB1bmRlZmluZWQpKSB7CgkJCQlkYXRhc2V0LnBvaW50UmFkaXVzID0gZGF0YXNldC5yYWRpdXM7CgkJCX0KCQkJaWYgKChkYXRhc2V0LmhpdFJhZGl1cyAhPT0gdW5kZWZpbmVkKSAmJiAoZGF0YXNldC5wb2ludEhpdFJhZGl1cyA9PT0gdW5kZWZpbmVkKSkgewoJCQkJZGF0YXNldC5wb2ludEhpdFJhZGl1cyA9IGRhdGFzZXQuaGl0UmFkaXVzOwoJCQl9CgoJCQloZWxwZXJzLmV4dGVuZChwb2ludCwgewoJCQkJLy8gVXRpbGl0eQoJCQkJX2RhdGFzZXRJbmRleDogbWUuaW5kZXgsCgkJCQlfaW5kZXg6IGluZGV4LAoJCQkJX3NjYWxlOiBzY2FsZSwKCgkJCQkvLyBEZXNpcmVkIHZpZXcgcHJvcGVydGllcwoJCQkJX21vZGVsOiB7CgkJCQkJeDogcmVzZXQgPyBzY2FsZS54Q2VudGVyIDogcG9pbnRQb3NpdGlvbi54LCAvLyB2YWx1ZSBub3QgdXNlZCBpbiBkYXRhc2V0IHNjYWxlLCBidXQgd2Ugd2FudCBhIGNvbnNpc3RlbnQgQVBJIGJldHdlZW4gc2NhbGVzCgkJCQkJeTogcmVzZXQgPyBzY2FsZS55Q2VudGVyIDogcG9pbnRQb3NpdGlvbi55LAoKCQkJCQkvLyBBcHBlYXJhbmNlCgkJCQkJdGVuc2lvbjogY3VzdG9tLnRlbnNpb24gPyBjdXN0b20udGVuc2lvbiA6IGhlbHBlcnMudmFsdWVPckRlZmF1bHQoZGF0YXNldC5saW5lVGVuc2lvbiwgbWUuY2hhcnQub3B0aW9ucy5lbGVtZW50cy5saW5lLnRlbnNpb24pLAoJCQkJCXJhZGl1czogY3VzdG9tLnJhZGl1cyA/IGN1c3RvbS5yYWRpdXMgOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50UmFkaXVzLCBpbmRleCwgcG9pbnRFbGVtZW50T3B0aW9ucy5yYWRpdXMpLAoJCQkJCWJhY2tncm91bmRDb2xvcjogY3VzdG9tLmJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50QmFja2dyb3VuZENvbG9yLCBpbmRleCwgcG9pbnRFbGVtZW50T3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IpLAoJCQkJCWJvcmRlckNvbG9yOiBjdXN0b20uYm9yZGVyQ29sb3IgPyBjdXN0b20uYm9yZGVyQ29sb3IgOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50Qm9yZGVyQ29sb3IsIGluZGV4LCBwb2ludEVsZW1lbnRPcHRpb25zLmJvcmRlckNvbG9yKSwKCQkJCQlib3JkZXJXaWR0aDogY3VzdG9tLmJvcmRlcldpZHRoID8gY3VzdG9tLmJvcmRlcldpZHRoIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEJvcmRlcldpZHRoLCBpbmRleCwgcG9pbnRFbGVtZW50T3B0aW9ucy5ib3JkZXJXaWR0aCksCgkJCQkJcG9pbnRTdHlsZTogY3VzdG9tLnBvaW50U3R5bGUgPyBjdXN0b20ucG9pbnRTdHlsZSA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQucG9pbnRTdHlsZSwgaW5kZXgsIHBvaW50RWxlbWVudE9wdGlvbnMucG9pbnRTdHlsZSksCgoJCQkJCS8vIFRvb2x0aXAKCQkJCQloaXRSYWRpdXM6IGN1c3RvbS5oaXRSYWRpdXMgPyBjdXN0b20uaGl0UmFkaXVzIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEhpdFJhZGl1cywgaW5kZXgsIHBvaW50RWxlbWVudE9wdGlvbnMuaGl0UmFkaXVzKQoJCQkJfQoJCQl9KTsKCgkJCXBvaW50Ll9tb2RlbC5za2lwID0gY3VzdG9tLnNraXAgPyBjdXN0b20uc2tpcCA6IChpc05hTihwb2ludC5fbW9kZWwueCkgfHwgaXNOYU4ocG9pbnQuX21vZGVsLnkpKTsKCQl9LAoJCXVwZGF0ZUJlemllckNvbnRyb2xQb2ludHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY2hhcnRBcmVhID0gdGhpcy5jaGFydC5jaGFydEFyZWE7CgkJCXZhciBtZXRhID0gdGhpcy5nZXRNZXRhKCk7CgoJCQloZWxwZXJzLmVhY2gobWV0YS5kYXRhLCBmdW5jdGlvbihwb2ludCwgaW5kZXgpIHsKCQkJCXZhciBtb2RlbCA9IHBvaW50Ll9tb2RlbDsKCQkJCXZhciBjb250cm9sUG9pbnRzID0gaGVscGVycy5zcGxpbmVDdXJ2ZSgKCQkJCQloZWxwZXJzLnByZXZpb3VzSXRlbShtZXRhLmRhdGEsIGluZGV4LCB0cnVlKS5fbW9kZWwsCgkJCQkJbW9kZWwsCgkJCQkJaGVscGVycy5uZXh0SXRlbShtZXRhLmRhdGEsIGluZGV4LCB0cnVlKS5fbW9kZWwsCgkJCQkJbW9kZWwudGVuc2lvbgoJCQkJKTsKCgkJCQkvLyBQcmV2ZW50IHRoZSBiZXppZXIgZ29pbmcgb3V0c2lkZSBvZiB0aGUgYm91bmRzIG9mIHRoZSBncmFwaAoJCQkJbW9kZWwuY29udHJvbFBvaW50UHJldmlvdXNYID0gTWF0aC5tYXgoTWF0aC5taW4oY29udHJvbFBvaW50cy5wcmV2aW91cy54LCBjaGFydEFyZWEucmlnaHQpLCBjaGFydEFyZWEubGVmdCk7CgkJCQltb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1kgPSBNYXRoLm1heChNYXRoLm1pbihjb250cm9sUG9pbnRzLnByZXZpb3VzLnksIGNoYXJ0QXJlYS5ib3R0b20pLCBjaGFydEFyZWEudG9wKTsKCgkJCQltb2RlbC5jb250cm9sUG9pbnROZXh0WCA9IE1hdGgubWF4KE1hdGgubWluKGNvbnRyb2xQb2ludHMubmV4dC54LCBjaGFydEFyZWEucmlnaHQpLCBjaGFydEFyZWEubGVmdCk7CgkJCQltb2RlbC5jb250cm9sUG9pbnROZXh0WSA9IE1hdGgubWF4KE1hdGgubWluKGNvbnRyb2xQb2ludHMubmV4dC55LCBjaGFydEFyZWEuYm90dG9tKSwgY2hhcnRBcmVhLnRvcCk7CgoJCQkJLy8gTm93IHBpdm90IHRoZSBwb2ludCBmb3IgYW5pbWF0aW9uCgkJCQlwb2ludC5waXZvdCgpOwoJCQl9KTsKCQl9LAoKCQlzZXRIb3ZlclN0eWxlOiBmdW5jdGlvbihwb2ludCkgewoJCQkvLyBQb2ludAoJCQl2YXIgZGF0YXNldCA9IHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1twb2ludC5fZGF0YXNldEluZGV4XTsKCQkJdmFyIGN1c3RvbSA9IHBvaW50LmN1c3RvbSB8fCB7fTsKCQkJdmFyIGluZGV4ID0gcG9pbnQuX2luZGV4OwoJCQl2YXIgbW9kZWwgPSBwb2ludC5fbW9kZWw7CgoJCQltb2RlbC5yYWRpdXMgPSBjdXN0b20uaG92ZXJSYWRpdXMgPyBjdXN0b20uaG92ZXJSYWRpdXMgOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50SG92ZXJSYWRpdXMsIGluZGV4LCB0aGlzLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQuaG92ZXJSYWRpdXMpOwoJCQltb2RlbC5iYWNrZ3JvdW5kQ29sb3IgPSBjdXN0b20uaG92ZXJCYWNrZ3JvdW5kQ29sb3IgPyBjdXN0b20uaG92ZXJCYWNrZ3JvdW5kQ29sb3IgOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50SG92ZXJCYWNrZ3JvdW5kQ29sb3IsIGluZGV4LCBoZWxwZXJzLmdldEhvdmVyQ29sb3IobW9kZWwuYmFja2dyb3VuZENvbG9yKSk7CgkJCW1vZGVsLmJvcmRlckNvbG9yID0gY3VzdG9tLmhvdmVyQm9yZGVyQ29sb3IgPyBjdXN0b20uaG92ZXJCb3JkZXJDb2xvciA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQucG9pbnRIb3ZlckJvcmRlckNvbG9yLCBpbmRleCwgaGVscGVycy5nZXRIb3ZlckNvbG9yKG1vZGVsLmJvcmRlckNvbG9yKSk7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gY3VzdG9tLmhvdmVyQm9yZGVyV2lkdGggPyBjdXN0b20uaG92ZXJCb3JkZXJXaWR0aCA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQucG9pbnRIb3ZlckJvcmRlcldpZHRoLCBpbmRleCwgbW9kZWwuYm9yZGVyV2lkdGgpOwoJCX0sCgoJCXJlbW92ZUhvdmVyU3R5bGU6IGZ1bmN0aW9uKHBvaW50KSB7CgkJCXZhciBkYXRhc2V0ID0gdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzW3BvaW50Ll9kYXRhc2V0SW5kZXhdOwoJCQl2YXIgY3VzdG9tID0gcG9pbnQuY3VzdG9tIHx8IHt9OwoJCQl2YXIgaW5kZXggPSBwb2ludC5faW5kZXg7CgkJCXZhciBtb2RlbCA9IHBvaW50Ll9tb2RlbDsKCQkJdmFyIHBvaW50RWxlbWVudE9wdGlvbnMgPSB0aGlzLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMucG9pbnQ7CgoJCQltb2RlbC5yYWRpdXMgPSBjdXN0b20ucmFkaXVzID8gY3VzdG9tLnJhZGl1cyA6IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGRhdGFzZXQucG9pbnRSYWRpdXMsIGluZGV4LCBwb2ludEVsZW1lbnRPcHRpb25zLnJhZGl1cyk7CgkJCW1vZGVsLmJhY2tncm91bmRDb2xvciA9IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgPyBjdXN0b20uYmFja2dyb3VuZENvbG9yIDogaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZGF0YXNldC5wb2ludEJhY2tncm91bmRDb2xvciwgaW5kZXgsIHBvaW50RWxlbWVudE9wdGlvbnMuYmFja2dyb3VuZENvbG9yKTsKCQkJbW9kZWwuYm9yZGVyQ29sb3IgPSBjdXN0b20uYm9yZGVyQ29sb3IgPyBjdXN0b20uYm9yZGVyQ29sb3IgOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50Qm9yZGVyQ29sb3IsIGluZGV4LCBwb2ludEVsZW1lbnRPcHRpb25zLmJvcmRlckNvbG9yKTsKCQkJbW9kZWwuYm9yZGVyV2lkdGggPSBjdXN0b20uYm9yZGVyV2lkdGggPyBjdXN0b20uYm9yZGVyV2lkdGggOiBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LnBvaW50Qm9yZGVyV2lkdGgsIGluZGV4LCBwb2ludEVsZW1lbnRPcHRpb25zLmJvcmRlcldpZHRoKTsKCQl9Cgl9KTsKfTsKCn0seyIyNSI6MjUsIjQwIjo0MCwiNDUiOjQ1fV0sMjE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgZGVmYXVsdHMgPSByZXF1aXJlKDI1KTsKCmRlZmF1bHRzLl9zZXQoJ3NjYXR0ZXInLCB7Cglob3ZlcjogewoJCW1vZGU6ICdzaW5nbGUnCgl9LAoKCXNjYWxlczogewoJCXhBeGVzOiBbewoJCQlpZDogJ3gtYXhpcy0xJywgICAgLy8gbmVlZCBhbiBJRCBzbyBkYXRhc2V0cyBjYW4gcmVmZXJlbmNlIHRoZSBzY2FsZQoJCQl0eXBlOiAnbGluZWFyJywgICAgLy8gc2NhdHRlciBzaG91bGQgbm90IHVzZSBhIGNhdGVnb3J5IGF4aXMKCQkJcG9zaXRpb246ICdib3R0b20nCgkJfV0sCgkJeUF4ZXM6IFt7CgkJCWlkOiAneS1heGlzLTEnLAoJCQl0eXBlOiAnbGluZWFyJywKCQkJcG9zaXRpb246ICdsZWZ0JwoJCX1dCgl9LAoKCXNob3dMaW5lczogZmFsc2UsCgoJdG9vbHRpcHM6IHsKCQljYWxsYmFja3M6IHsKCQkJdGl0bGU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICcnOyAgICAgLy8gZG9lc24ndCBtYWtlIHNlbnNlIGZvciBzY2F0dGVyIHNpbmNlIGRhdGEgYXJlIGZvcm1hdHRlZCBhcyBhIHBvaW50CgkJCX0sCgkJCWxhYmVsOiBmdW5jdGlvbihpdGVtKSB7CgkJCQlyZXR1cm4gJygnICsgaXRlbS54TGFiZWwgKyAnLCAnICsgaXRlbS55TGFiZWwgKyAnKSc7CgkJCX0KCQl9Cgl9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCS8vIFNjYXR0ZXIgY2hhcnRzIHVzZSBsaW5lIGNvbnRyb2xsZXJzCglDaGFydC5jb250cm9sbGVycy5zY2F0dGVyID0gQ2hhcnQuY29udHJvbGxlcnMubGluZTsKCn07Cgp9LHsiMjUiOjI1fV0sMjI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiBnbG9iYWwgd2luZG93OiBmYWxzZSAqLwondXNlIHN0cmljdCc7Cgp2YXIgZGVmYXVsdHMgPSByZXF1aXJlKDI1KTsKdmFyIEVsZW1lbnQgPSByZXF1aXJlKDI2KTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKCWFuaW1hdGlvbjogewoJCWR1cmF0aW9uOiAxMDAwLAoJCWVhc2luZzogJ2Vhc2VPdXRRdWFydCcsCgkJb25Qcm9ncmVzczogaGVscGVycy5ub29wLAoJCW9uQ29tcGxldGU6IGhlbHBlcnMubm9vcAoJfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCglDaGFydC5BbmltYXRpb24gPSBFbGVtZW50LmV4dGVuZCh7CgkJY2hhcnQ6IG51bGwsIC8vIHRoZSBhbmltYXRpb24gYXNzb2NpYXRlZCBjaGFydCBpbnN0YW5jZQoJCWN1cnJlbnRTdGVwOiAwLCAvLyB0aGUgY3VycmVudCBhbmltYXRpb24gc3RlcAoJCW51bVN0ZXBzOiA2MCwgLy8gZGVmYXVsdCBudW1iZXIgb2Ygc3RlcHMKCQllYXNpbmc6ICcnLCAvLyB0aGUgZWFzaW5nIHRvIHVzZSBmb3IgdGhpcyBhbmltYXRpb24KCQlyZW5kZXI6IG51bGwsIC8vIHJlbmRlciBmdW5jdGlvbiB1c2VkIGJ5IHRoZSBhbmltYXRpb24gc2VydmljZQoKCQlvbkFuaW1hdGlvblByb2dyZXNzOiBudWxsLCAvLyB1c2VyIHNwZWNpZmllZCBjYWxsYmFjayB0byBmaXJlIG9uIGVhY2ggc3RlcCBvZiB0aGUgYW5pbWF0aW9uCgkJb25BbmltYXRpb25Db21wbGV0ZTogbnVsbCwgLy8gdXNlciBzcGVjaWZpZWQgY2FsbGJhY2sgdG8gZmlyZSB3aGVuIHRoZSBhbmltYXRpb24gZmluaXNoZXMKCX0pOwoKCUNoYXJ0LmFuaW1hdGlvblNlcnZpY2UgPSB7CgkJZnJhbWVEdXJhdGlvbjogMTcsCgkJYW5pbWF0aW9uczogW10sCgkJZHJvcEZyYW1lczogMCwKCQlyZXF1ZXN0OiBudWxsLAoKCQkvKioKCQkgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIFRoZSBjaGFydCB0byBhbmltYXRlLgoJCSAqIEBwYXJhbSB7Q2hhcnQuQW5pbWF0aW9ufSBhbmltYXRpb24gLSBUaGUgYW5pbWF0aW9uIHRoYXQgd2Ugd2lsbCBhbmltYXRlLgoJCSAqIEBwYXJhbSB7TnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBhbmltYXRpb24gZHVyYXRpb24gaW4gbXMuCgkJICogQHBhcmFtIHtCb29sZWFufSBsYXp5IC0gaWYgdHJ1ZSwgdGhlIGNoYXJ0IGlzIG5vdCBtYXJrZWQgYXMgYW5pbWF0aW5nIHRvIGVuYWJsZSBtb3JlIHJlc3BvbnNpdmUgaW50ZXJhY3Rpb25zCgkJICovCgkJYWRkQW5pbWF0aW9uOiBmdW5jdGlvbihjaGFydCwgYW5pbWF0aW9uLCBkdXJhdGlvbiwgbGF6eSkgewoJCQl2YXIgYW5pbWF0aW9ucyA9IHRoaXMuYW5pbWF0aW9uczsKCQkJdmFyIGksIGlsZW47CgoJCQlhbmltYXRpb24uY2hhcnQgPSBjaGFydDsKCgkJCWlmICghbGF6eSkgewoJCQkJY2hhcnQuYW5pbWF0aW5nID0gdHJ1ZTsKCQkJfQoKCQkJZm9yIChpID0gMCwgaWxlbiA9IGFuaW1hdGlvbnMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQlpZiAoYW5pbWF0aW9uc1tpXS5jaGFydCA9PT0gY2hhcnQpIHsKCQkJCQlhbmltYXRpb25zW2ldID0gYW5pbWF0aW9uOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJYW5pbWF0aW9ucy5wdXNoKGFuaW1hdGlvbik7CgoJCQkvLyBJZiB0aGVyZSBhcmUgbm8gYW5pbWF0aW9ucyBxdWV1ZWQsIG1hbnVhbGx5IGtpY2tzdGFydCBhIGRpZ2VzdCwgZm9yIGxhY2sgb2YgYSBiZXR0ZXIgd29yZAoJCQlpZiAoYW5pbWF0aW9ucy5sZW5ndGggPT09IDEpIHsKCQkJCXRoaXMucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk7CgkJCX0KCQl9LAoKCQljYW5jZWxBbmltYXRpb246IGZ1bmN0aW9uKGNoYXJ0KSB7CgkJCXZhciBpbmRleCA9IGhlbHBlcnMuZmluZEluZGV4KHRoaXMuYW5pbWF0aW9ucywgZnVuY3Rpb24oYW5pbWF0aW9uKSB7CgkJCQlyZXR1cm4gYW5pbWF0aW9uLmNoYXJ0ID09PSBjaGFydDsKCQkJfSk7CgoJCQlpZiAoaW5kZXggIT09IC0xKSB7CgkJCQl0aGlzLmFuaW1hdGlvbnMuc3BsaWNlKGluZGV4LCAxKTsKCQkJCWNoYXJ0LmFuaW1hdGluZyA9IGZhbHNlOwoJCQl9CgkJfSwKCgkJcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJaWYgKG1lLnJlcXVlc3QgPT09IG51bGwpIHsKCQkJCS8vIFNraXAgYW5pbWF0aW9uIGZyYW1lIHJlcXVlc3RzIHVudGlsIHRoZSBhY3RpdmUgb25lIGlzIGV4ZWN1dGVkLgoJCQkJLy8gVGhpcyBjYW4gaGFwcGVuIHdoZW4gcHJvY2Vzc2luZyBtb3VzZSBldmVudHMsIGUuZy4gJ21vdXNlbW92ZScKCQkJCS8vIGFuZCAnbW91c2VvdXQnIGV2ZW50cyB3aWxsIHRyaWdnZXIgbXVsdGlwbGUgcmVuZGVycy4KCQkJCW1lLnJlcXVlc3QgPSBoZWxwZXJzLnJlcXVlc3RBbmltRnJhbWUuY2FsbCh3aW5kb3csIGZ1bmN0aW9uKCkgewoJCQkJCW1lLnJlcXVlc3QgPSBudWxsOwoJCQkJCW1lLnN0YXJ0RGlnZXN0KCk7CgkJCQl9KTsKCQkJfQoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJc3RhcnREaWdlc3Q6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTsKCQkJdmFyIGZyYW1lc1RvRHJvcCA9IDA7CgoJCQlpZiAobWUuZHJvcEZyYW1lcyA+IDEpIHsKCQkJCWZyYW1lc1RvRHJvcCA9IE1hdGguZmxvb3IobWUuZHJvcEZyYW1lcyk7CgkJCQltZS5kcm9wRnJhbWVzID0gbWUuZHJvcEZyYW1lcyAlIDE7CgkJCX0KCgkJCW1lLmFkdmFuY2UoMSArIGZyYW1lc1RvRHJvcCk7CgoJCQl2YXIgZW5kVGltZSA9IERhdGUubm93KCk7CgoJCQltZS5kcm9wRnJhbWVzICs9IChlbmRUaW1lIC0gc3RhcnRUaW1lKSAvIG1lLmZyYW1lRHVyYXRpb247CgoJCQkvLyBEbyB3ZSBoYXZlIG1vcmUgc3R1ZmYgdG8gYW5pbWF0ZT8KCQkJaWYgKG1lLmFuaW1hdGlvbnMubGVuZ3RoID4gMCkgewoJCQkJbWUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk7CgkJCX0KCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWFkdmFuY2U6IGZ1bmN0aW9uKGNvdW50KSB7CgkJCXZhciBhbmltYXRpb25zID0gdGhpcy5hbmltYXRpb25zOwoJCQl2YXIgYW5pbWF0aW9uLCBjaGFydDsKCQkJdmFyIGkgPSAwOwoKCQkJd2hpbGUgKGkgPCBhbmltYXRpb25zLmxlbmd0aCkgewoJCQkJYW5pbWF0aW9uID0gYW5pbWF0aW9uc1tpXTsKCQkJCWNoYXJ0ID0gYW5pbWF0aW9uLmNoYXJ0OwoKCQkJCWFuaW1hdGlvbi5jdXJyZW50U3RlcCA9IChhbmltYXRpb24uY3VycmVudFN0ZXAgfHwgMCkgKyBjb3VudDsKCQkJCWFuaW1hdGlvbi5jdXJyZW50U3RlcCA9IE1hdGgubWluKGFuaW1hdGlvbi5jdXJyZW50U3RlcCwgYW5pbWF0aW9uLm51bVN0ZXBzKTsKCgkJCQloZWxwZXJzLmNhbGxiYWNrKGFuaW1hdGlvbi5yZW5kZXIsIFtjaGFydCwgYW5pbWF0aW9uXSwgY2hhcnQpOwoJCQkJaGVscGVycy5jYWxsYmFjayhhbmltYXRpb24ub25BbmltYXRpb25Qcm9ncmVzcywgW2FuaW1hdGlvbl0sIGNoYXJ0KTsKCgkJCQlpZiAoYW5pbWF0aW9uLmN1cnJlbnRTdGVwID49IGFuaW1hdGlvbi5udW1TdGVwcykgewoJCQkJCWhlbHBlcnMuY2FsbGJhY2soYW5pbWF0aW9uLm9uQW5pbWF0aW9uQ29tcGxldGUsIFthbmltYXRpb25dLCBjaGFydCk7CgkJCQkJY2hhcnQuYW5pbWF0aW5nID0gZmFsc2U7CgkJCQkJYW5pbWF0aW9ucy5zcGxpY2UoaSwgMSk7CgkJCQl9IGVsc2UgewoJCQkJCSsraTsKCQkJCX0KCQkJfQoJCX0KCX07CgoJLyoqCgkgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LkFuaW1hdGlvbiBpbnN0ZWFkCgkgKiBAcHJvcCBDaGFydC5BbmltYXRpb24jYW5pbWF0aW9uT2JqZWN0CgkgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNi4wCgkgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCgkgKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShDaGFydC5BbmltYXRpb24ucHJvdG90eXBlLCAnYW5pbWF0aW9uT2JqZWN0JywgewoJCWdldDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCX0pOwoKCS8qKgoJICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydC5BbmltYXRpb24jY2hhcnQgaW5zdGVhZAoJICogQHByb3AgQ2hhcnQuQW5pbWF0aW9uI2NoYXJ0SW5zdGFuY2UKCSAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi42LjAKCSAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKCSAqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KENoYXJ0LkFuaW1hdGlvbi5wcm90b3R5cGUsICdjaGFydEluc3RhbmNlJywgewoJCWdldDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmNoYXJ0OwoJCX0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoJCQl0aGlzLmNoYXJ0ID0gdmFsdWU7CgkJfQoJfSk7Cgp9OwoKfSx7IjI1IjoyNSwiMjYiOjI2LCI0NSI6NDV9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgSW50ZXJhY3Rpb24gPSByZXF1aXJlKDI4KTsKdmFyIGxheW91dHMgPSByZXF1aXJlKDMwKTsKdmFyIHBsYXRmb3JtID0gcmVxdWlyZSg0OCk7CnZhciBwbHVnaW5zID0gcmVxdWlyZSgzMSk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJLy8gQ3JlYXRlIGEgZGljdGlvbmFyeSBvZiBjaGFydCB0eXBlcywgdG8gYWxsb3cgZm9yIGV4dGVuc2lvbiBvZiBleGlzdGluZyB0eXBlcwoJQ2hhcnQudHlwZXMgPSB7fTsKCgkvLyBTdG9yZSBhIHJlZmVyZW5jZSB0byBlYWNoIGluc3RhbmNlIC0gYWxsb3dpbmcgdXMgdG8gZ2xvYmFsbHkgcmVzaXplIGNoYXJ0IGluc3RhbmNlcyBvbiB3aW5kb3cgcmVzaXplLgoJLy8gRGVzdHJveSBtZXRob2Qgb24gdGhlIGNoYXJ0IHdpbGwgcmVtb3ZlIHRoZSBpbnN0YW5jZSBvZiB0aGUgY2hhcnQgZnJvbSB0aGlzIHJlZmVyZW5jZS4KCUNoYXJ0Lmluc3RhbmNlcyA9IHt9OwoKCS8vIENvbnRyb2xsZXJzIGF2YWlsYWJsZSBmb3IgZGF0YXNldCB2aXN1YWxpemF0aW9uIGVnLiBiYXIsIGxpbmUsIHNsaWNlLCBldGMuCglDaGFydC5jb250cm9sbGVycyA9IHt9OwoKCS8qKgoJICogSW5pdGlhbGl6ZXMgdGhlIGdpdmVuIGNvbmZpZyB3aXRoIGdsb2JhbCBhbmQgY2hhcnQgZGVmYXVsdCB2YWx1ZXMuCgkgKi8KCWZ1bmN0aW9uIGluaXRDb25maWcoY29uZmlnKSB7CgkJY29uZmlnID0gY29uZmlnIHx8IHt9OwoKCQkvLyBEbyBOT1QgdXNlIGNvbmZpZ01lcmdlKCkgZm9yIHRoZSBkYXRhIG9iamVjdCBiZWNhdXNlIHRoaXMgbWV0aG9kIG1lcmdlcyBhcnJheXMKCQkvLyBhbmQgc28gd291bGQgY2hhbmdlIHJlZmVyZW5jZXMgdG8gbGFiZWxzIGFuZCBkYXRhc2V0cywgcHJldmVudGluZyBkYXRhIHVwZGF0ZXMuCgkJdmFyIGRhdGEgPSBjb25maWcuZGF0YSA9IGNvbmZpZy5kYXRhIHx8IHt9OwoJCWRhdGEuZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzIHx8IFtdOwoJCWRhdGEubGFiZWxzID0gZGF0YS5sYWJlbHMgfHwgW107CgoJCWNvbmZpZy5vcHRpb25zID0gaGVscGVycy5jb25maWdNZXJnZSgKCQkJZGVmYXVsdHMuZ2xvYmFsLAoJCQlkZWZhdWx0c1tjb25maWcudHlwZV0sCgkJCWNvbmZpZy5vcHRpb25zIHx8IHt9KTsKCgkJcmV0dXJuIGNvbmZpZzsKCX0KCgkvKioKCSAqIFVwZGF0ZXMgdGhlIGNvbmZpZyBvZiB0aGUgY2hhcnQKCSAqIEBwYXJhbSBjaGFydCB7Q2hhcnR9IGNoYXJ0IHRvIHVwZGF0ZSB0aGUgb3B0aW9ucyBmb3IKCSAqLwoJZnVuY3Rpb24gdXBkYXRlQ29uZmlnKGNoYXJ0KSB7CgkJdmFyIG5ld09wdGlvbnMgPSBjaGFydC5vcHRpb25zOwoKCQloZWxwZXJzLmVhY2goY2hhcnQuc2NhbGVzLCBmdW5jdGlvbihzY2FsZSkgewoJCQlsYXlvdXRzLnJlbW92ZUJveChjaGFydCwgc2NhbGUpOwoJCX0pOwoKCQluZXdPcHRpb25zID0gaGVscGVycy5jb25maWdNZXJnZSgKCQkJQ2hhcnQuZGVmYXVsdHMuZ2xvYmFsLAoJCQlDaGFydC5kZWZhdWx0c1tjaGFydC5jb25maWcudHlwZV0sCgkJCW5ld09wdGlvbnMpOwoKCQljaGFydC5vcHRpb25zID0gY2hhcnQuY29uZmlnLm9wdGlvbnMgPSBuZXdPcHRpb25zOwoJCWNoYXJ0LmVuc3VyZVNjYWxlc0hhdmVJRHMoKTsKCQljaGFydC5idWlsZE9yVXBkYXRlU2NhbGVzKCk7CgkJLy8gVG9vbHRpcAoJCWNoYXJ0LnRvb2x0aXAuX29wdGlvbnMgPSBuZXdPcHRpb25zLnRvb2x0aXBzOwoJCWNoYXJ0LnRvb2x0aXAuaW5pdGlhbGl6ZSgpOwoJfQoKCWZ1bmN0aW9uIHBvc2l0aW9uSXNIb3Jpem9udGFsKHBvc2l0aW9uKSB7CgkJcmV0dXJuIHBvc2l0aW9uID09PSAndG9wJyB8fCBwb3NpdGlvbiA9PT0gJ2JvdHRvbSc7Cgl9CgoJaGVscGVycy5leHRlbmQoQ2hhcnQucHJvdG90eXBlLCAvKiogQGxlbmRzIENoYXJ0ICovIHsKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWNvbnN0cnVjdDogZnVuY3Rpb24oaXRlbSwgY29uZmlnKSB7CgkJCXZhciBtZSA9IHRoaXM7CgoJCQljb25maWcgPSBpbml0Q29uZmlnKGNvbmZpZyk7CgoJCQl2YXIgY29udGV4dCA9IHBsYXRmb3JtLmFjcXVpcmVDb250ZXh0KGl0ZW0sIGNvbmZpZyk7CgkJCXZhciBjYW52YXMgPSBjb250ZXh0ICYmIGNvbnRleHQuY2FudmFzOwoJCQl2YXIgaGVpZ2h0ID0gY2FudmFzICYmIGNhbnZhcy5oZWlnaHQ7CgkJCXZhciB3aWR0aCA9IGNhbnZhcyAmJiBjYW52YXMud2lkdGg7CgoJCQltZS5pZCA9IGhlbHBlcnMudWlkKCk7CgkJCW1lLmN0eCA9IGNvbnRleHQ7CgkJCW1lLmNhbnZhcyA9IGNhbnZhczsKCQkJbWUuY29uZmlnID0gY29uZmlnOwoJCQltZS53aWR0aCA9IHdpZHRoOwoJCQltZS5oZWlnaHQgPSBoZWlnaHQ7CgkJCW1lLmFzcGVjdFJhdGlvID0gaGVpZ2h0ID8gd2lkdGggLyBoZWlnaHQgOiBudWxsOwoJCQltZS5vcHRpb25zID0gY29uZmlnLm9wdGlvbnM7CgkJCW1lLl9idWZmZXJlZFJlbmRlciA9IGZhbHNlOwoKCQkJLyoqCgkJCSAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBDaGFydCBhbmQgQ2hhcnQuQ29udHJvbGxlciBoYXZlIGJlZW4gbWVyZ2VkLAoJCQkgKiB0aGUgImluc3RhbmNlIiBzdGlsbCBuZWVkIHRvIGJlIGRlZmluZWQgc2luY2UgaXQgbWlnaHQgYmUgY2FsbGVkIGZyb20gcGx1Z2lucy4KCQkJICogQHByb3AgQ2hhcnQjY2hhcnQKCQkJICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjYuMAoJCQkgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCgkJCSAqIEBwcml2YXRlCgkJCSAqLwoJCQltZS5jaGFydCA9IG1lOwoJCQltZS5jb250cm9sbGVyID0gbWU7IC8vIGNoYXJ0LmNoYXJ0LmNvbnRyb2xsZXIgI2luY2VwdGlvbgoKCQkJLy8gQWRkIHRoZSBjaGFydCBpbnN0YW5jZSB0byB0aGUgZ2xvYmFsIG5hbWVzcGFjZQoJCQlDaGFydC5pbnN0YW5jZXNbbWUuaWRdID0gbWU7CgoJCQkvLyBEZWZpbmUgYWxpYXMgdG8gdGhlIGNvbmZpZyBkYXRhOiBgY2hhcnQuZGF0YSA9PT0gY2hhcnQuY29uZmlnLmRhdGFgCgkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShtZSwgJ2RhdGEnLCB7CgkJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBtZS5jb25maWcuZGF0YTsKCQkJCX0sCgkJCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCQkJbWUuY29uZmlnLmRhdGEgPSB2YWx1ZTsKCQkJCX0KCQkJfSk7CgoJCQlpZiAoIWNvbnRleHQgfHwgIWNhbnZhcykgewoJCQkJLy8gVGhlIGdpdmVuIGl0ZW0gaXMgbm90IGEgY29tcGF0aWJsZSBjb250ZXh0MmQgZWxlbWVudCwgbGV0J3MgcmV0dXJuIGJlZm9yZSBmaW5hbGl6aW5nCgkJCQkvLyB0aGUgY2hhcnQgaW5pdGlhbGl6YXRpb24gYnV0IGFmdGVyIHNldHRpbmcgYmFzaWMgY2hhcnQgLyBjb250cm9sbGVyIHByb3BlcnRpZXMgdGhhdAoJCQkJLy8gY2FuIGhlbHAgdG8gZmlndXJlIG91dCB0aGF0IHRoZSBjaGFydCBpcyBub3QgdmFsaWQgKGUuZyBjaGFydC5jYW52YXMgIT09IG51bGwpOwoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzI4MDcKCQkJCWNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBjcmVhdGUgY2hhcnQ6IGNhbid0IGFjcXVpcmUgY29udGV4dCBmcm9tIHRoZSBnaXZlbiBpdGVtIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCW1lLmluaXRpYWxpemUoKTsKCQkJbWUudXBkYXRlKCk7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCgkJCS8vIEJlZm9yZSBpbml0IHBsdWdpbiBub3RpZmljYXRpb24KCQkJcGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVJbml0Jyk7CgoJCQloZWxwZXJzLnJldGluYVNjYWxlKG1lLCBtZS5vcHRpb25zLmRldmljZVBpeGVsUmF0aW8pOwoKCQkJbWUuYmluZEV2ZW50cygpOwoKCQkJaWYgKG1lLm9wdGlvbnMucmVzcG9uc2l2ZSkgewoJCQkJLy8gSW5pdGlhbCByZXNpemUgYmVmb3JlIGNoYXJ0IGRyYXdzIChtdXN0IGJlIHNpbGVudCB0byBwcmVzZXJ2ZSBpbml0aWFsIGFuaW1hdGlvbnMpLgoJCQkJbWUucmVzaXplKHRydWUpOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgc2NhbGVzIGhhdmUgSURzIGFuZCBhcmUgYnVpbHQgYmVmb3JlIHdlIGJ1aWxkIGFueSBjb250cm9sbGVycy4KCQkJbWUuZW5zdXJlU2NhbGVzSGF2ZUlEcygpOwoJCQltZS5idWlsZE9yVXBkYXRlU2NhbGVzKCk7CgkJCW1lLmluaXRUb29sVGlwKCk7CgoJCQkvLyBBZnRlciBpbml0IHBsdWdpbiBub3RpZmljYXRpb24KCQkJcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlckluaXQnKTsKCgkJCXJldHVybiBtZTsKCQl9LAoKCQljbGVhcjogZnVuY3Rpb24oKSB7CgkJCWhlbHBlcnMuY2FudmFzLmNsZWFyKHRoaXMpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlzdG9wOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcHMgYW55IGN1cnJlbnQgYW5pbWF0aW9uIGxvb3Agb2NjdXJyaW5nCgkJCUNoYXJ0LmFuaW1hdGlvblNlcnZpY2UuY2FuY2VsQW5pbWF0aW9uKHRoaXMpOwoJCQlyZXR1cm4gdGhpczsKCQl9LAoKCQlyZXNpemU6IGZ1bmN0aW9uKHNpbGVudCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0aW9ucyA9IG1lLm9wdGlvbnM7CgkJCXZhciBjYW52YXMgPSBtZS5jYW52YXM7CgkJCXZhciBhc3BlY3RSYXRpbyA9IChvcHRpb25zLm1haW50YWluQXNwZWN0UmF0aW8gJiYgbWUuYXNwZWN0UmF0aW8pIHx8IG51bGw7CgoJCQkvLyB0aGUgY2FudmFzIHJlbmRlciB3aWR0aCBhbmQgaGVpZ2h0IHdpbGwgYmUgY2FzdGVkIHRvIGludGVnZXJzIHNvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIHRoZSBjYW52YXMgZGlzcGxheSBzdHlsZSB1c2VzIHRoZSBzYW1lIGludGVnZXIgdmFsdWVzIHRvIGF2b2lkIGJsdXJyaW5nIGVmZmVjdC4KCgkJCS8vIFNldCB0byAwIGluc3RlYWQgb2YgY2FudmFzLnNpemUgYmVjYXVzZSB0aGUgc2l6ZSBkZWZhdWx0cyB0byAzMDB4MTUwIGlmIHRoZSBlbGVtZW50IGlzIGNvbGxhc2VkCgkJCXZhciBuZXdXaWR0aCA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3IoaGVscGVycy5nZXRNYXhpbXVtV2lkdGgoY2FudmFzKSkpOwoJCQl2YXIgbmV3SGVpZ2h0ID0gTWF0aC5tYXgoMCwgTWF0aC5mbG9vcihhc3BlY3RSYXRpbyA/IG5ld1dpZHRoIC8gYXNwZWN0UmF0aW8gOiBoZWxwZXJzLmdldE1heGltdW1IZWlnaHQoY2FudmFzKSkpOwoKCQkJaWYgKG1lLndpZHRoID09PSBuZXdXaWR0aCAmJiBtZS5oZWlnaHQgPT09IG5ld0hlaWdodCkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQljYW52YXMud2lkdGggPSBtZS53aWR0aCA9IG5ld1dpZHRoOwoJCQljYW52YXMuaGVpZ2h0ID0gbWUuaGVpZ2h0ID0gbmV3SGVpZ2h0OwoJCQljYW52YXMuc3R5bGUud2lkdGggPSBuZXdXaWR0aCArICdweCc7CgkJCWNhbnZhcy5zdHlsZS5oZWlnaHQgPSBuZXdIZWlnaHQgKyAncHgnOwoKCQkJaGVscGVycy5yZXRpbmFTY2FsZShtZSwgb3B0aW9ucy5kZXZpY2VQaXhlbFJhdGlvKTsKCgkJCWlmICghc2lsZW50KSB7CgkJCQkvLyBOb3RpZnkgYW55IHBsdWdpbnMgYWJvdXQgdGhlIHJlc2l6ZQoJCQkJdmFyIG5ld1NpemUgPSB7d2lkdGg6IG5ld1dpZHRoLCBoZWlnaHQ6IG5ld0hlaWdodH07CgkJCQlwbHVnaW5zLm5vdGlmeShtZSwgJ3Jlc2l6ZScsIFtuZXdTaXplXSk7CgoJCQkJLy8gTm90aWZ5IG9mIHJlc2l6ZQoJCQkJaWYgKG1lLm9wdGlvbnMub25SZXNpemUpIHsKCQkJCQltZS5vcHRpb25zLm9uUmVzaXplKG1lLCBuZXdTaXplKTsKCQkJCX0KCgkJCQltZS5zdG9wKCk7CgkJCQltZS51cGRhdGUobWUub3B0aW9ucy5yZXNwb25zaXZlQW5pbWF0aW9uRHVyYXRpb24pOwoJCQl9CgkJfSwKCgkJZW5zdXJlU2NhbGVzSGF2ZUlEczogZnVuY3Rpb24oKSB7CgkJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCQl2YXIgc2NhbGVzT3B0aW9ucyA9IG9wdGlvbnMuc2NhbGVzIHx8IHt9OwoJCQl2YXIgc2NhbGVPcHRpb25zID0gb3B0aW9ucy5zY2FsZTsKCgkJCWhlbHBlcnMuZWFjaChzY2FsZXNPcHRpb25zLnhBeGVzLCBmdW5jdGlvbih4QXhpc09wdGlvbnMsIGluZGV4KSB7CgkJCQl4QXhpc09wdGlvbnMuaWQgPSB4QXhpc09wdGlvbnMuaWQgfHwgKCd4LWF4aXMtJyArIGluZGV4KTsKCQkJfSk7CgoJCQloZWxwZXJzLmVhY2goc2NhbGVzT3B0aW9ucy55QXhlcywgZnVuY3Rpb24oeUF4aXNPcHRpb25zLCBpbmRleCkgewoJCQkJeUF4aXNPcHRpb25zLmlkID0geUF4aXNPcHRpb25zLmlkIHx8ICgneS1heGlzLScgKyBpbmRleCk7CgkJCX0pOwoKCQkJaWYgKHNjYWxlT3B0aW9ucykgewoJCQkJc2NhbGVPcHRpb25zLmlkID0gc2NhbGVPcHRpb25zLmlkIHx8ICdzY2FsZSc7CgkJCX0KCQl9LAoKCQkvKioKCQkgKiBCdWlsZHMgYSBtYXAgb2Ygc2NhbGUgSUQgdG8gc2NhbGUgb2JqZWN0IGZvciBmdXR1cmUgbG9va3VwLgoJCSAqLwoJCWJ1aWxkT3JVcGRhdGVTY2FsZXM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0aW9ucyA9IG1lLm9wdGlvbnM7CgkJCXZhciBzY2FsZXMgPSBtZS5zY2FsZXMgfHwge307CgkJCXZhciBpdGVtcyA9IFtdOwoJCQl2YXIgdXBkYXRlZCA9IE9iamVjdC5rZXlzKHNjYWxlcykucmVkdWNlKGZ1bmN0aW9uKG9iaiwgaWQpIHsKCQkJCW9ialtpZF0gPSBmYWxzZTsKCQkJCXJldHVybiBvYmo7CgkJCX0sIHt9KTsKCgkJCWlmIChvcHRpb25zLnNjYWxlcykgewoJCQkJaXRlbXMgPSBpdGVtcy5jb25jYXQoCgkJCQkJKG9wdGlvbnMuc2NhbGVzLnhBeGVzIHx8IFtdKS5tYXAoZnVuY3Rpb24oeEF4aXNPcHRpb25zKSB7CgkJCQkJCXJldHVybiB7b3B0aW9uczogeEF4aXNPcHRpb25zLCBkdHlwZTogJ2NhdGVnb3J5JywgZHBvc2l0aW9uOiAnYm90dG9tJ307CgkJCQkJfSksCgkJCQkJKG9wdGlvbnMuc2NhbGVzLnlBeGVzIHx8IFtdKS5tYXAoZnVuY3Rpb24oeUF4aXNPcHRpb25zKSB7CgkJCQkJCXJldHVybiB7b3B0aW9uczogeUF4aXNPcHRpb25zLCBkdHlwZTogJ2xpbmVhcicsIGRwb3NpdGlvbjogJ2xlZnQnfTsKCQkJCQl9KQoJCQkJKTsKCQkJfQoKCQkJaWYgKG9wdGlvbnMuc2NhbGUpIHsKCQkJCWl0ZW1zLnB1c2goewoJCQkJCW9wdGlvbnM6IG9wdGlvbnMuc2NhbGUsCgkJCQkJZHR5cGU6ICdyYWRpYWxMaW5lYXInLAoJCQkJCWlzRGVmYXVsdDogdHJ1ZSwKCQkJCQlkcG9zaXRpb246ICdjaGFydEFyZWEnCgkJCQl9KTsKCQkJfQoKCQkJaGVscGVycy5lYWNoKGl0ZW1zLCBmdW5jdGlvbihpdGVtKSB7CgkJCQl2YXIgc2NhbGVPcHRpb25zID0gaXRlbS5vcHRpb25zOwoJCQkJdmFyIGlkID0gc2NhbGVPcHRpb25zLmlkOwoJCQkJdmFyIHNjYWxlVHlwZSA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQoc2NhbGVPcHRpb25zLnR5cGUsIGl0ZW0uZHR5cGUpOwoKCQkJCWlmIChwb3NpdGlvbklzSG9yaXpvbnRhbChzY2FsZU9wdGlvbnMucG9zaXRpb24pICE9PSBwb3NpdGlvbklzSG9yaXpvbnRhbChpdGVtLmRwb3NpdGlvbikpIHsKCQkJCQlzY2FsZU9wdGlvbnMucG9zaXRpb24gPSBpdGVtLmRwb3NpdGlvbjsKCQkJCX0KCgkJCQl1cGRhdGVkW2lkXSA9IHRydWU7CgkJCQl2YXIgc2NhbGUgPSBudWxsOwoJCQkJaWYgKGlkIGluIHNjYWxlcyAmJiBzY2FsZXNbaWRdLnR5cGUgPT09IHNjYWxlVHlwZSkgewoJCQkJCXNjYWxlID0gc2NhbGVzW2lkXTsKCQkJCQlzY2FsZS5vcHRpb25zID0gc2NhbGVPcHRpb25zOwoJCQkJCXNjYWxlLmN0eCA9IG1lLmN0eDsKCQkJCQlzY2FsZS5jaGFydCA9IG1lOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgc2NhbGVDbGFzcyA9IENoYXJ0LnNjYWxlU2VydmljZS5nZXRTY2FsZUNvbnN0cnVjdG9yKHNjYWxlVHlwZSk7CgkJCQkJaWYgKCFzY2FsZUNsYXNzKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJc2NhbGUgPSBuZXcgc2NhbGVDbGFzcyh7CgkJCQkJCWlkOiBpZCwKCQkJCQkJdHlwZTogc2NhbGVUeXBlLAoJCQkJCQlvcHRpb25zOiBzY2FsZU9wdGlvbnMsCgkJCQkJCWN0eDogbWUuY3R4LAoJCQkJCQljaGFydDogbWUKCQkJCQl9KTsKCQkJCQlzY2FsZXNbc2NhbGUuaWRdID0gc2NhbGU7CgkJCQl9CgoJCQkJc2NhbGUubWVyZ2VUaWNrc09wdGlvbnMoKTsKCgkJCQkvLyBUT0RPKFNCKTogSSB0aGluayB3ZSBzaG91bGQgYmUgYWJsZSB0byByZW1vdmUgdGhpcyBjdXN0b20gY2FzZSAob3B0aW9ucy5zY2FsZSkKCQkJCS8vIGFuZCBjb25zaWRlciBpdCBhcyBhIHJlZ3VsYXIgc2NhbGUgcGFydCBvZiB0aGUgInNjYWxlcyIiIG1hcCBvbmx5ISBUaGlzIHdvdWxkCgkJCQkvLyBtYWtlIHRoZSBsb2dpYyBlYXNpZXIgYW5kIHJlbW92ZSBzb21lIHVzZWxlc3M/IGN1c3RvbSBjb2RlLgoJCQkJaWYgKGl0ZW0uaXNEZWZhdWx0KSB7CgkJCQkJbWUuc2NhbGUgPSBzY2FsZTsKCQkJCX0KCQkJfSk7CgkJCS8vIGNsZWFyIHVwIGRpc2NhcmRlZCBzY2FsZXMKCQkJaGVscGVycy5lYWNoKHVwZGF0ZWQsIGZ1bmN0aW9uKGhhc1VwZGF0ZWQsIGlkKSB7CgkJCQlpZiAoIWhhc1VwZGF0ZWQpIHsKCQkJCQlkZWxldGUgc2NhbGVzW2lkXTsKCQkJCX0KCQkJfSk7CgoJCQltZS5zY2FsZXMgPSBzY2FsZXM7CgoJCQlDaGFydC5zY2FsZVNlcnZpY2UuYWRkU2NhbGVzVG9MYXlvdXQodGhpcyk7CgkJfSwKCgkJYnVpbGRPclVwZGF0ZUNvbnRyb2xsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIHR5cGVzID0gW107CgkJCXZhciBuZXdDb250cm9sbGVycyA9IFtdOwoKCQkJaGVscGVycy5lYWNoKG1lLmRhdGEuZGF0YXNldHMsIGZ1bmN0aW9uKGRhdGFzZXQsIGRhdGFzZXRJbmRleCkgewoJCQkJdmFyIG1ldGEgPSBtZS5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoJCQkJdmFyIHR5cGUgPSBkYXRhc2V0LnR5cGUgfHwgbWUuY29uZmlnLnR5cGU7CgoJCQkJaWYgKG1ldGEudHlwZSAmJiBtZXRhLnR5cGUgIT09IHR5cGUpIHsKCQkJCQltZS5kZXN0cm95RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsKCQkJCQltZXRhID0gbWUuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsKCQkJCX0KCQkJCW1ldGEudHlwZSA9IHR5cGU7CgoJCQkJdHlwZXMucHVzaChtZXRhLnR5cGUpOwoKCQkJCWlmIChtZXRhLmNvbnRyb2xsZXIpIHsKCQkJCQltZXRhLmNvbnRyb2xsZXIudXBkYXRlSW5kZXgoZGF0YXNldEluZGV4KTsKCQkJCQltZXRhLmNvbnRyb2xsZXIubGlua1NjYWxlcygpOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgQ29udHJvbGxlckNsYXNzID0gQ2hhcnQuY29udHJvbGxlcnNbbWV0YS50eXBlXTsKCQkJCQlpZiAoQ29udHJvbGxlckNsYXNzID09PSB1bmRlZmluZWQpIHsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCciJyArIG1ldGEudHlwZSArICciIGlzIG5vdCBhIGNoYXJ0IHR5cGUuJyk7CgkJCQkJfQoKCQkJCQltZXRhLmNvbnRyb2xsZXIgPSBuZXcgQ29udHJvbGxlckNsYXNzKG1lLCBkYXRhc2V0SW5kZXgpOwoJCQkJCW5ld0NvbnRyb2xsZXJzLnB1c2gobWV0YS5jb250cm9sbGVyKTsKCQkJCX0KCQkJfSwgbWUpOwoKCQkJcmV0dXJuIG5ld0NvbnRyb2xsZXJzOwoJCX0sCgoJCS8qKgoJCSAqIFJlc2V0IHRoZSBlbGVtZW50cyBvZiBhbGwgZGF0YXNldHMKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCXJlc2V0RWxlbWVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQloZWxwZXJzLmVhY2gobWUuZGF0YS5kYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7CgkJCQltZS5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpLmNvbnRyb2xsZXIucmVzZXQoKTsKCQkJfSwgbWUpOwoJCX0sCgoJCS8qKgoJCSogUmVzZXRzIHRoZSBjaGFydCBiYWNrIHRvIGl0J3Mgc3RhdGUgYmVmb3JlIHRoZSBpbml0aWFsIGFuaW1hdGlvbgoJCSovCgkJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnJlc2V0RWxlbWVudHMoKTsKCQkJdGhpcy50b29sdGlwLmluaXRpYWxpemUoKTsKCQl9LAoKCQl1cGRhdGU6IGZ1bmN0aW9uKGNvbmZpZykgewoJCQl2YXIgbWUgPSB0aGlzOwoKCQkJaWYgKCFjb25maWcgfHwgdHlwZW9mIGNvbmZpZyAhPT0gJ29iamVjdCcpIHsKCQkJCS8vIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CgkJCQljb25maWcgPSB7CgkJCQkJZHVyYXRpb246IGNvbmZpZywKCQkJCQlsYXp5OiBhcmd1bWVudHNbMV0KCQkJCX07CgkJCX0KCgkJCXVwZGF0ZUNvbmZpZyhtZSk7CgoJCQkvLyBwbHVnaW5zIG9wdGlvbnMgcmVmZXJlbmNlcyBtaWdodCBoYXZlIGNoYW5nZSwgbGV0J3MgaW52YWxpZGF0ZSB0aGUgY2FjaGUKCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzUxMTEjaXNzdWVjb21tZW50LTM1NTkzNDE2NwoJCQlwbHVnaW5zLl9pbnZhbGlkYXRlKG1lKTsKCgkJCWlmIChwbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZVVwZGF0ZScpID09PSBmYWxzZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJbiBjYXNlIHRoZSBlbnRpcmUgZGF0YSBvYmplY3QgY2hhbmdlZAoJCQltZS50b29sdGlwLl9kYXRhID0gbWUuZGF0YTsKCgkJCS8vIE1ha2Ugc3VyZSBkYXRhc2V0IGNvbnRyb2xsZXJzIGFyZSB1cGRhdGVkIGFuZCBuZXcgY29udHJvbGxlcnMgYXJlIHJlc2V0CgkJCXZhciBuZXdDb250cm9sbGVycyA9IG1lLmJ1aWxkT3JVcGRhdGVDb250cm9sbGVycygpOwoKCQkJLy8gTWFrZSBzdXJlIGFsbCBkYXRhc2V0IGNvbnRyb2xsZXJzIGhhdmUgY29ycmVjdCBtZXRhIGRhdGEgY291bnRzCgkJCWhlbHBlcnMuZWFjaChtZS5kYXRhLmRhdGFzZXRzLCBmdW5jdGlvbihkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHsKCQkJCW1lLmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCkuY29udHJvbGxlci5idWlsZE9yVXBkYXRlRWxlbWVudHMoKTsKCQkJfSwgbWUpOwoKCQkJbWUudXBkYXRlTGF5b3V0KCk7CgoJCQkvLyBDYW4gb25seSByZXNldCB0aGUgbmV3IGNvbnRyb2xsZXJzIGFmdGVyIHRoZSBzY2FsZXMgaGF2ZSBiZWVuIHVwZGF0ZWQKCQkJaWYgKG1lLm9wdGlvbnMuYW5pbWF0aW9uICYmIG1lLm9wdGlvbnMuYW5pbWF0aW9uLmR1cmF0aW9uKSB7CgkJCQloZWxwZXJzLmVhY2gobmV3Q29udHJvbGxlcnMsIGZ1bmN0aW9uKGNvbnRyb2xsZXIpIHsKCQkJCQljb250cm9sbGVyLnJlc2V0KCk7CgkJCQl9KTsKCQkJfQoKCQkJbWUudXBkYXRlRGF0YXNldHMoKTsKCgkJCS8vIE5lZWQgdG8gcmVzZXQgdG9vbHRpcCBpbiBjYXNlIGl0IGlzIGRpc3BsYXllZCB3aXRoIGVsZW1lbnRzIHRoYXQgYXJlIHJlbW92ZWQKCQkJLy8gYWZ0ZXIgdXBkYXRlLgoJCQltZS50b29sdGlwLmluaXRpYWxpemUoKTsKCgkJCS8vIExhc3QgYWN0aXZlIGNvbnRhaW5zIGl0ZW1zIHRoYXQgd2VyZSBwcmV2aW91c2x5IGluIHRoZSB0b29sdGlwLgoJCQkvLyBXaGVuIHdlIHJlc2V0IHRoZSB0b29sdGlwLCB3ZSBuZWVkIHRvIGNsZWFyIGl0CgkJCW1lLmxhc3RBY3RpdmUgPSBbXTsKCgkJCS8vIERvIHRoaXMgYmVmb3JlIHJlbmRlciBzbyB0aGF0IGFueSBwbHVnaW5zIHRoYXQgbmVlZCBmaW5hbCBzY2FsZSB1cGRhdGVzIGNhbiB1c2UgaXQKCQkJcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlclVwZGF0ZScpOwoKCQkJaWYgKG1lLl9idWZmZXJlZFJlbmRlcikgewoJCQkJbWUuX2J1ZmZlcmVkUmVxdWVzdCA9IHsKCQkJCQlkdXJhdGlvbjogY29uZmlnLmR1cmF0aW9uLAoJCQkJCWVhc2luZzogY29uZmlnLmVhc2luZywKCQkJCQlsYXp5OiBjb25maWcubGF6eQoJCQkJfTsKCQkJfSBlbHNlIHsKCQkJCW1lLnJlbmRlcihjb25maWcpOwoJCQl9CgkJfSwKCgkJLyoqCgkJICogVXBkYXRlcyB0aGUgY2hhcnQgbGF5b3V0IHVubGVzcyBhIHBsdWdpbiByZXR1cm5zIGBmYWxzZWAgdG8gdGhlIGBiZWZvcmVMYXlvdXRgCgkJICogaG9vaywgaW4gd2hpY2ggY2FzZSwgcGx1Z2lucyB3aWxsIG5vdCBiZSBjYWxsZWQgb24gYGFmdGVyTGF5b3V0YC4KCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCXVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgoJCQlpZiAocGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVMYXlvdXQnKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJbGF5b3V0cy51cGRhdGUodGhpcywgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKCQkJLyoqCgkJCSAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgYGFmdGVyTGF5b3V0YCBpbnN0ZWFkLgoJCQkgKiBAbWV0aG9kIElQbHVnaW4jYWZ0ZXJTY2FsZVVwZGF0ZQoJCQkgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNS4wCgkJCSAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKCQkJICogQHByaXZhdGUKCQkJICovCgkJCXBsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJTY2FsZVVwZGF0ZScpOwoJCQlwbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyTGF5b3V0Jyk7CgkJfSwKCgkJLyoqCgkJICogVXBkYXRlcyBhbGwgZGF0YXNldHMgdW5sZXNzIGEgcGx1Z2luIHJldHVybnMgYGZhbHNlYCB0byB0aGUgYGJlZm9yZURhdGFzZXRzVXBkYXRlYAoJCSAqIGhvb2ssIGluIHdoaWNoIGNhc2UsIHBsdWdpbnMgd2lsbCBub3QgYmUgY2FsbGVkIG9uIGBhZnRlckRhdGFzZXRzVXBkYXRlYC4KCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCXVwZGF0ZURhdGFzZXRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCgkJCWlmIChwbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZURhdGFzZXRzVXBkYXRlJykgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWZvciAodmFyIGkgPSAwLCBpbGVuID0gbWUuZGF0YS5kYXRhc2V0cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCW1lLnVwZGF0ZURhdGFzZXQoaSk7CgkJCX0KCgkJCXBsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJEYXRhc2V0c1VwZGF0ZScpOwoJCX0sCgoJCS8qKgoJCSAqIFVwZGF0ZXMgZGF0YXNldCBhdCBpbmRleCB1bmxlc3MgYSBwbHVnaW4gcmV0dXJucyBgZmFsc2VgIHRvIHRoZSBgYmVmb3JlRGF0YXNldFVwZGF0ZWAKCQkgKiBob29rLCBpbiB3aGljaCBjYXNlLCBwbHVnaW5zIHdpbGwgbm90IGJlIGNhbGxlZCBvbiBgYWZ0ZXJEYXRhc2V0VXBkYXRlYC4KCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCXVwZGF0ZURhdGFzZXQ6IGZ1bmN0aW9uKGluZGV4KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtZXRhID0gbWUuZ2V0RGF0YXNldE1ldGEoaW5kZXgpOwoJCQl2YXIgYXJncyA9IHsKCQkJCW1ldGE6IG1ldGEsCgkJCQlpbmRleDogaW5kZXgKCQkJfTsKCgkJCWlmIChwbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZURhdGFzZXRVcGRhdGUnLCBbYXJnc10pID09PSBmYWxzZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQltZXRhLmNvbnRyb2xsZXIudXBkYXRlKCk7CgoJCQlwbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyRGF0YXNldFVwZGF0ZScsIFthcmdzXSk7CgkJfSwKCgkJcmVuZGVyOiBmdW5jdGlvbihjb25maWcpIHsKCQkJdmFyIG1lID0gdGhpczsKCgkJCWlmICghY29uZmlnIHx8IHR5cGVvZiBjb25maWcgIT09ICdvYmplY3QnKSB7CgkJCQkvLyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJCQkJY29uZmlnID0gewoJCQkJCWR1cmF0aW9uOiBjb25maWcsCgkJCQkJbGF6eTogYXJndW1lbnRzWzFdCgkJCQl9OwoJCQl9CgoJCQl2YXIgZHVyYXRpb24gPSBjb25maWcuZHVyYXRpb247CgkJCXZhciBsYXp5ID0gY29uZmlnLmxhenk7CgoJCQlpZiAocGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVSZW5kZXInKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFuaW1hdGlvbk9wdGlvbnMgPSBtZS5vcHRpb25zLmFuaW1hdGlvbjsKCQkJdmFyIG9uQ29tcGxldGUgPSBmdW5jdGlvbihhbmltYXRpb24pIHsKCQkJCXBsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJSZW5kZXInKTsKCQkJCWhlbHBlcnMuY2FsbGJhY2soYW5pbWF0aW9uT3B0aW9ucyAmJiBhbmltYXRpb25PcHRpb25zLm9uQ29tcGxldGUsIFthbmltYXRpb25dLCBtZSk7CgkJCX07CgoJCQlpZiAoYW5pbWF0aW9uT3B0aW9ucyAmJiAoKHR5cGVvZiBkdXJhdGlvbiAhPT0gJ3VuZGVmaW5lZCcgJiYgZHVyYXRpb24gIT09IDApIHx8ICh0eXBlb2YgZHVyYXRpb24gPT09ICd1bmRlZmluZWQnICYmIGFuaW1hdGlvbk9wdGlvbnMuZHVyYXRpb24gIT09IDApKSkgewoJCQkJdmFyIGFuaW1hdGlvbiA9IG5ldyBDaGFydC5BbmltYXRpb24oewoJCQkJCW51bVN0ZXBzOiAoZHVyYXRpb24gfHwgYW5pbWF0aW9uT3B0aW9ucy5kdXJhdGlvbikgLyAxNi42NiwgLy8gNjAgZnBzCgkJCQkJZWFzaW5nOiBjb25maWcuZWFzaW5nIHx8IGFuaW1hdGlvbk9wdGlvbnMuZWFzaW5nLAoKCQkJCQlyZW5kZXI6IGZ1bmN0aW9uKGNoYXJ0LCBhbmltYXRpb25PYmplY3QpIHsKCQkJCQkJdmFyIGVhc2luZ0Z1bmN0aW9uID0gaGVscGVycy5lYXNpbmcuZWZmZWN0c1thbmltYXRpb25PYmplY3QuZWFzaW5nXTsKCQkJCQkJdmFyIGN1cnJlbnRTdGVwID0gYW5pbWF0aW9uT2JqZWN0LmN1cnJlbnRTdGVwOwoJCQkJCQl2YXIgc3RlcERlY2ltYWwgPSBjdXJyZW50U3RlcCAvIGFuaW1hdGlvbk9iamVjdC5udW1TdGVwczsKCgkJCQkJCWNoYXJ0LmRyYXcoZWFzaW5nRnVuY3Rpb24oc3RlcERlY2ltYWwpLCBzdGVwRGVjaW1hbCwgY3VycmVudFN0ZXApOwoJCQkJCX0sCgoJCQkJCW9uQW5pbWF0aW9uUHJvZ3Jlc3M6IGFuaW1hdGlvbk9wdGlvbnMub25Qcm9ncmVzcywKCQkJCQlvbkFuaW1hdGlvbkNvbXBsZXRlOiBvbkNvbXBsZXRlCgkJCQl9KTsKCgkJCQlDaGFydC5hbmltYXRpb25TZXJ2aWNlLmFkZEFuaW1hdGlvbihtZSwgYW5pbWF0aW9uLCBkdXJhdGlvbiwgbGF6eSk7CgkJCX0gZWxzZSB7CgkJCQltZS5kcmF3KCk7CgoJCQkJLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy8zNzgxCgkJCQlvbkNvbXBsZXRlKG5ldyBDaGFydC5BbmltYXRpb24oe251bVN0ZXBzOiAwLCBjaGFydDogbWV9KSk7CgkJCX0KCgkJCXJldHVybiBtZTsKCQl9LAoKCQlkcmF3OiBmdW5jdGlvbihlYXNpbmdWYWx1ZSkgewoJCQl2YXIgbWUgPSB0aGlzOwoKCQkJbWUuY2xlYXIoKTsKCgkJCWlmIChoZWxwZXJzLmlzTnVsbE9yVW5kZWYoZWFzaW5nVmFsdWUpKSB7CgkJCQllYXNpbmdWYWx1ZSA9IDE7CgkJCX0KCgkJCW1lLnRyYW5zaXRpb24oZWFzaW5nVmFsdWUpOwoKCQkJaWYgKHBsdWdpbnMubm90aWZ5KG1lLCAnYmVmb3JlRHJhdycsIFtlYXNpbmdWYWx1ZV0pID09PSBmYWxzZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBEcmF3IGFsbCB0aGUgc2NhbGVzCgkJCWhlbHBlcnMuZWFjaChtZS5ib3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCQlib3guZHJhdyhtZS5jaGFydEFyZWEpOwoJCQl9LCBtZSk7CgoJCQlpZiAobWUuc2NhbGUpIHsKCQkJCW1lLnNjYWxlLmRyYXcoKTsKCQkJfQoKCQkJbWUuZHJhd0RhdGFzZXRzKGVhc2luZ1ZhbHVlKTsKCQkJbWUuX2RyYXdUb29sdGlwKGVhc2luZ1ZhbHVlKTsKCgkJCXBsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJEcmF3JywgW2Vhc2luZ1ZhbHVlXSk7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQl0cmFuc2l0aW9uOiBmdW5jdGlvbihlYXNpbmdWYWx1ZSkgewoJCQl2YXIgbWUgPSB0aGlzOwoKCQkJZm9yICh2YXIgaSA9IDAsIGlsZW4gPSAobWUuZGF0YS5kYXRhc2V0cyB8fCBbXSkubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQlpZiAobWUuaXNEYXRhc2V0VmlzaWJsZShpKSkgewoJCQkJCW1lLmdldERhdGFzZXRNZXRhKGkpLmNvbnRyb2xsZXIudHJhbnNpdGlvbihlYXNpbmdWYWx1ZSk7CgkJCQl9CgkJCX0KCgkJCW1lLnRvb2x0aXAudHJhbnNpdGlvbihlYXNpbmdWYWx1ZSk7CgkJfSwKCgkJLyoqCgkJICogRHJhd3MgYWxsIGRhdGFzZXRzIHVubGVzcyBhIHBsdWdpbiByZXR1cm5zIGBmYWxzZWAgdG8gdGhlIGBiZWZvcmVEYXRhc2V0c0RyYXdgCgkJICogaG9vaywgaW4gd2hpY2ggY2FzZSwgcGx1Z2lucyB3aWxsIG5vdCBiZSBjYWxsZWQgb24gYGFmdGVyRGF0YXNldHNEcmF3YC4KCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWRyYXdEYXRhc2V0czogZnVuY3Rpb24oZWFzaW5nVmFsdWUpIHsKCQkJdmFyIG1lID0gdGhpczsKCgkJCWlmIChwbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZURhdGFzZXRzRHJhdycsIFtlYXNpbmdWYWx1ZV0pID09PSBmYWxzZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBEcmF3IGRhdGFzZXRzIHJldmVyc2VkIHRvIHN1cHBvcnQgcHJvcGVyIGxpbmUgc3RhY2tpbmcKCQkJZm9yICh2YXIgaSA9IChtZS5kYXRhLmRhdGFzZXRzIHx8IFtdKS5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgewoJCQkJaWYgKG1lLmlzRGF0YXNldFZpc2libGUoaSkpIHsKCQkJCQltZS5kcmF3RGF0YXNldChpLCBlYXNpbmdWYWx1ZSk7CgkJCQl9CgkJCX0KCgkJCXBsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJEYXRhc2V0c0RyYXcnLCBbZWFzaW5nVmFsdWVdKTsKCQl9LAoKCQkvKioKCQkgKiBEcmF3cyBkYXRhc2V0IGF0IGluZGV4IHVubGVzcyBhIHBsdWdpbiByZXR1cm5zIGBmYWxzZWAgdG8gdGhlIGBiZWZvcmVEYXRhc2V0RHJhd2AKCQkgKiBob29rLCBpbiB3aGljaCBjYXNlLCBwbHVnaW5zIHdpbGwgbm90IGJlIGNhbGxlZCBvbiBgYWZ0ZXJEYXRhc2V0RHJhd2AuCgkJICogQHByaXZhdGUKCQkgKi8KCQlkcmF3RGF0YXNldDogZnVuY3Rpb24oaW5kZXgsIGVhc2luZ1ZhbHVlKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtZXRhID0gbWUuZ2V0RGF0YXNldE1ldGEoaW5kZXgpOwoJCQl2YXIgYXJncyA9IHsKCQkJCW1ldGE6IG1ldGEsCgkJCQlpbmRleDogaW5kZXgsCgkJCQllYXNpbmdWYWx1ZTogZWFzaW5nVmFsdWUKCQkJfTsKCgkJCWlmIChwbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZURhdGFzZXREcmF3JywgW2FyZ3NdKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJbWV0YS5jb250cm9sbGVyLmRyYXcoZWFzaW5nVmFsdWUpOwoKCQkJcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlckRhdGFzZXREcmF3JywgW2FyZ3NdKTsKCQl9LAoKCQkvKioKCQkgKiBEcmF3cyB0b29sdGlwIHVubGVzcyBhIHBsdWdpbiByZXR1cm5zIGBmYWxzZWAgdG8gdGhlIGBiZWZvcmVUb29sdGlwRHJhd2AKCQkgKiBob29rLCBpbiB3aGljaCBjYXNlLCBwbHVnaW5zIHdpbGwgbm90IGJlIGNhbGxlZCBvbiBgYWZ0ZXJUb29sdGlwRHJhd2AuCgkJICogQHByaXZhdGUKCQkgKi8KCQlfZHJhd1Rvb2x0aXA6IGZ1bmN0aW9uKGVhc2luZ1ZhbHVlKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciB0b29sdGlwID0gbWUudG9vbHRpcDsKCQkJdmFyIGFyZ3MgPSB7CgkJCQl0b29sdGlwOiB0b29sdGlwLAoJCQkJZWFzaW5nVmFsdWU6IGVhc2luZ1ZhbHVlCgkJCX07CgoJCQlpZiAocGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVUb29sdGlwRHJhdycsIFthcmdzXSkgPT09IGZhbHNlKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRvb2x0aXAuZHJhdygpOwoKCQkJcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlclRvb2x0aXBEcmF3JywgW2FyZ3NdKTsKCQl9LAoKCQkvLyBHZXQgdGhlIHNpbmdsZSBlbGVtZW50IHRoYXQgd2FzIGNsaWNrZWQgb24KCQkvLyBAcmV0dXJuIDogQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGRhdGFzZXQgaW5kZXggYW5kIGVsZW1lbnQgaW5kZXggb2YgdGhlIG1hdGNoaW5nIGVsZW1lbnQuIEFsc28gY29udGFpbnMgdGhlIHJlY3RhbmdsZSB0aGF0IHdhcyBkcmF3CgkJZ2V0RWxlbWVudEF0RXZlbnQ6IGZ1bmN0aW9uKGUpIHsKCQkJcmV0dXJuIEludGVyYWN0aW9uLm1vZGVzLnNpbmdsZSh0aGlzLCBlKTsKCQl9LAoKCQlnZXRFbGVtZW50c0F0RXZlbnQ6IGZ1bmN0aW9uKGUpIHsKCQkJcmV0dXJuIEludGVyYWN0aW9uLm1vZGVzLmxhYmVsKHRoaXMsIGUsIHtpbnRlcnNlY3Q6IHRydWV9KTsKCQl9LAoKCQlnZXRFbGVtZW50c0F0WEF4aXM6IGZ1bmN0aW9uKGUpIHsKCQkJcmV0dXJuIEludGVyYWN0aW9uLm1vZGVzWyd4LWF4aXMnXSh0aGlzLCBlLCB7aW50ZXJzZWN0OiB0cnVlfSk7CgkJfSwKCgkJZ2V0RWxlbWVudHNBdEV2ZW50Rm9yTW9kZTogZnVuY3Rpb24oZSwgbW9kZSwgb3B0aW9ucykgewoJCQl2YXIgbWV0aG9kID0gSW50ZXJhY3Rpb24ubW9kZXNbbW9kZV07CgkJCWlmICh0eXBlb2YgbWV0aG9kID09PSAnZnVuY3Rpb24nKSB7CgkJCQlyZXR1cm4gbWV0aG9kKHRoaXMsIGUsIG9wdGlvbnMpOwoJCQl9CgoJCQlyZXR1cm4gW107CgkJfSwKCgkJZ2V0RGF0YXNldEF0RXZlbnQ6IGZ1bmN0aW9uKGUpIHsKCQkJcmV0dXJuIEludGVyYWN0aW9uLm1vZGVzLmRhdGFzZXQodGhpcywgZSwge2ludGVyc2VjdDogdHJ1ZX0pOwoJCX0sCgoJCWdldERhdGFzZXRNZXRhOiBmdW5jdGlvbihkYXRhc2V0SW5kZXgpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGRhdGFzZXQgPSBtZS5kYXRhLmRhdGFzZXRzW2RhdGFzZXRJbmRleF07CgkJCWlmICghZGF0YXNldC5fbWV0YSkgewoJCQkJZGF0YXNldC5fbWV0YSA9IHt9OwoJCQl9CgoJCQl2YXIgbWV0YSA9IGRhdGFzZXQuX21ldGFbbWUuaWRdOwoJCQlpZiAoIW1ldGEpIHsKCQkJCW1ldGEgPSBkYXRhc2V0Ll9tZXRhW21lLmlkXSA9IHsKCQkJCQl0eXBlOiBudWxsLAoJCQkJCWRhdGE6IFtdLAoJCQkJCWRhdGFzZXQ6IG51bGwsCgkJCQkJY29udHJvbGxlcjogbnVsbCwKCQkJCQloaWRkZW46IG51bGwsCQkJLy8gU2VlIGlzRGF0YXNldFZpc2libGUoKSBjb21tZW50CgkJCQkJeEF4aXNJRDogbnVsbCwKCQkJCQl5QXhpc0lEOiBudWxsCgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gbWV0YTsKCQl9LAoKCQlnZXRWaXNpYmxlRGF0YXNldENvdW50OiBmdW5jdGlvbigpIHsKCQkJdmFyIGNvdW50ID0gMDsKCQkJZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLmRhdGEuZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQlpZiAodGhpcy5pc0RhdGFzZXRWaXNpYmxlKGkpKSB7CgkJCQkJY291bnQrKzsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gY291bnQ7CgkJfSwKCgkJaXNEYXRhc2V0VmlzaWJsZTogZnVuY3Rpb24oZGF0YXNldEluZGV4KSB7CgkJCXZhciBtZXRhID0gdGhpcy5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoKCQkJLy8gbWV0YS5oaWRkZW4gaXMgYSBwZXIgY2hhcnQgZGF0YXNldCBoaWRkZW4gZmxhZyBvdmVycmlkZSB3aXRoIDMgc3RhdGVzOiBpZiB0cnVlIG9yIGZhbHNlLAoJCQkvLyB0aGUgZGF0YXNldC5oaWRkZW4gdmFsdWUgaXMgaWdub3JlZCwgZWxzZSBpZiBudWxsLCB0aGUgZGF0YXNldCBoaWRkZW4gc3RhdGUgaXMgcmV0dXJuZWQuCgkJCXJldHVybiB0eXBlb2YgbWV0YS5oaWRkZW4gPT09ICdib29sZWFuJyA/ICFtZXRhLmhpZGRlbiA6ICF0aGlzLmRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XS5oaWRkZW47CgkJfSwKCgkJZ2VuZXJhdGVMZWdlbmQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5vcHRpb25zLmxlZ2VuZENhbGxiYWNrKHRoaXMpOwoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJZGVzdHJveURhdGFzZXRNZXRhOiBmdW5jdGlvbihkYXRhc2V0SW5kZXgpIHsKCQkJdmFyIGlkID0gdGhpcy5pZDsKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XTsKCQkJdmFyIG1ldGEgPSBkYXRhc2V0Ll9tZXRhICYmIGRhdGFzZXQuX21ldGFbaWRdOwoKCQkJaWYgKG1ldGEpIHsKCQkJCW1ldGEuY29udHJvbGxlci5kZXN0cm95KCk7CgkJCQlkZWxldGUgZGF0YXNldC5fbWV0YVtpZF07CgkJCX0KCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNhbnZhcyA9IG1lLmNhbnZhczsKCQkJdmFyIGksIGlsZW47CgoJCQltZS5zdG9wKCk7CgoJCQkvLyBkYXRhc2V0IGNvbnRyb2xsZXJzIG5lZWQgdG8gY2xlYW51cCBhc3NvY2lhdGVkIGRhdGEKCQkJZm9yIChpID0gMCwgaWxlbiA9IG1lLmRhdGEuZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQltZS5kZXN0cm95RGF0YXNldE1ldGEoaSk7CgkJCX0KCgkJCWlmIChjYW52YXMpIHsKCQkJCW1lLnVuYmluZEV2ZW50cygpOwoJCQkJaGVscGVycy5jYW52YXMuY2xlYXIobWUpOwoJCQkJcGxhdGZvcm0ucmVsZWFzZUNvbnRleHQobWUuY3R4KTsKCQkJCW1lLmNhbnZhcyA9IG51bGw7CgkJCQltZS5jdHggPSBudWxsOwoJCQl9CgoJCQlwbHVnaW5zLm5vdGlmeShtZSwgJ2Rlc3Ryb3knKTsKCgkJCWRlbGV0ZSBDaGFydC5pbnN0YW5jZXNbbWUuaWRdOwoJCX0sCgoJCXRvQmFzZTY0SW1hZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5jYW52YXMudG9EYXRhVVJMLmFwcGx5KHRoaXMuY2FudmFzLCBhcmd1bWVudHMpOwoJCX0sCgoJCWluaXRUb29sVGlwOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJbWUudG9vbHRpcCA9IG5ldyBDaGFydC5Ub29sdGlwKHsKCQkJCV9jaGFydDogbWUsCgkJCQlfY2hhcnRJbnN0YW5jZTogbWUsIC8vIGRlcHJlY2F0ZWQsIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKCQkJCV9kYXRhOiBtZS5kYXRhLAoJCQkJX29wdGlvbnM6IG1lLm9wdGlvbnMudG9vbHRpcHMKCQkJfSwgbWUpOwoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJYmluZEV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBsaXN0ZW5lcnMgPSBtZS5fbGlzdGVuZXJzID0ge307CgkJCXZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewoJCQkJbWUuZXZlbnRIYW5kbGVyLmFwcGx5KG1lLCBhcmd1bWVudHMpOwoJCQl9OwoKCQkJaGVscGVycy5lYWNoKG1lLm9wdGlvbnMuZXZlbnRzLCBmdW5jdGlvbih0eXBlKSB7CgkJCQlwbGF0Zm9ybS5hZGRFdmVudExpc3RlbmVyKG1lLCB0eXBlLCBsaXN0ZW5lcik7CgkJCQlsaXN0ZW5lcnNbdHlwZV0gPSBsaXN0ZW5lcjsKCQkJfSk7CgoJCQkvLyBFbGVtZW50cyB1c2VkIHRvIGRldGVjdCBzaXplIGNoYW5nZSBzaG91bGQgbm90IGJlIGluamVjdGVkIGZvciBub24gcmVzcG9uc2l2ZSBjaGFydHMuCgkJCS8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvMjIxMAoJCQlpZiAobWUub3B0aW9ucy5yZXNwb25zaXZlKSB7CgkJCQlsaXN0ZW5lciA9IGZ1bmN0aW9uKCkgewoJCQkJCW1lLnJlc2l6ZSgpOwoJCQkJfTsKCgkJCQlwbGF0Zm9ybS5hZGRFdmVudExpc3RlbmVyKG1lLCAncmVzaXplJywgbGlzdGVuZXIpOwoJCQkJbGlzdGVuZXJzLnJlc2l6ZSA9IGxpc3RlbmVyOwoJCQl9CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQl1bmJpbmRFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbGlzdGVuZXJzID0gbWUuX2xpc3RlbmVyczsKCQkJaWYgKCFsaXN0ZW5lcnMpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJZGVsZXRlIG1lLl9saXN0ZW5lcnM7CgkJCWhlbHBlcnMuZWFjaChsaXN0ZW5lcnMsIGZ1bmN0aW9uKGxpc3RlbmVyLCB0eXBlKSB7CgkJCQlwbGF0Zm9ybS5yZW1vdmVFdmVudExpc3RlbmVyKG1lLCB0eXBlLCBsaXN0ZW5lcik7CgkJCX0pOwoJCX0sCgoJCXVwZGF0ZUhvdmVyU3R5bGU6IGZ1bmN0aW9uKGVsZW1lbnRzLCBtb2RlLCBlbmFibGVkKSB7CgkJCXZhciBtZXRob2QgPSBlbmFibGVkID8gJ3NldEhvdmVyU3R5bGUnIDogJ3JlbW92ZUhvdmVyU3R5bGUnOwoJCQl2YXIgZWxlbWVudCwgaSwgaWxlbjsKCgkJCWZvciAoaSA9IDAsIGlsZW4gPSBlbGVtZW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCWVsZW1lbnQgPSBlbGVtZW50c1tpXTsKCQkJCWlmIChlbGVtZW50KSB7CgkJCQkJdGhpcy5nZXREYXRhc2V0TWV0YShlbGVtZW50Ll9kYXRhc2V0SW5kZXgpLmNvbnRyb2xsZXJbbWV0aG9kXShlbGVtZW50KTsKCQkJCX0KCQkJfQoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJZXZlbnRIYW5kbGVyOiBmdW5jdGlvbihlKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciB0b29sdGlwID0gbWUudG9vbHRpcDsKCgkJCWlmIChwbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZUV2ZW50JywgW2VdKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gQnVmZmVyIGFueSB1cGRhdGUgY2FsbHMgc28gdGhhdCByZW5kZXJzIGRvIG5vdCBvY2N1cgoJCQltZS5fYnVmZmVyZWRSZW5kZXIgPSB0cnVlOwoJCQltZS5fYnVmZmVyZWRSZXF1ZXN0ID0gbnVsbDsKCgkJCXZhciBjaGFuZ2VkID0gbWUuaGFuZGxlRXZlbnQoZSk7CgkJCS8vIGZvciBzbW9vdGggdG9vbHRpcCBhbmltYXRpb25zIGlzc3VlICM0OTg5CgkJCS8vIHRoZSB0b29sdGlwIHNob3VsZCBiZSB0aGUgc291cmNlIG9mIGNoYW5nZQoJCQkvLyBBbmltYXRpb24gY2hlY2sgd29ya2Fyb3VuZDoKCQkJLy8gdG9vbHRpcC5fc3RhcnQgd2lsbCBiZSBudWxsIHdoZW4gdG9vbHRpcCBpc24ndCBhbmltYXRpbmcKCQkJaWYgKHRvb2x0aXApIHsKCQkJCWNoYW5nZWQgPSB0b29sdGlwLl9zdGFydAoJCQkJCT8gdG9vbHRpcC5oYW5kbGVFdmVudChlKQoJCQkJCTogY2hhbmdlZCB8IHRvb2x0aXAuaGFuZGxlRXZlbnQoZSk7CgkJCX0KCgkJCXBsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJFdmVudCcsIFtlXSk7CgoJCQl2YXIgYnVmZmVyZWRSZXF1ZXN0ID0gbWUuX2J1ZmZlcmVkUmVxdWVzdDsKCQkJaWYgKGJ1ZmZlcmVkUmVxdWVzdCkgewoJCQkJLy8gSWYgd2UgaGF2ZSBhbiB1cGRhdGUgdGhhdCB3YXMgdHJpZ2dlcmVkLCB3ZSBuZWVkIHRvIGRvIGEgbm9ybWFsIHJlbmRlcgoJCQkJbWUucmVuZGVyKGJ1ZmZlcmVkUmVxdWVzdCk7CgkJCX0gZWxzZSBpZiAoY2hhbmdlZCAmJiAhbWUuYW5pbWF0aW5nKSB7CgkJCQkvLyBJZiBlbnRlcmluZywgbGVhdmluZywgb3IgY2hhbmdpbmcgZWxlbWVudHMsIGFuaW1hdGUgdGhlIGNoYW5nZSB2aWEgcGl2b3QKCQkJCW1lLnN0b3AoKTsKCgkJCQkvLyBXZSBvbmx5IG5lZWQgdG8gcmVuZGVyIGF0IHRoaXMgcG9pbnQuIFVwZGF0aW5nIHdpbGwgY2F1c2Ugc2NhbGVzIHRvIGJlCgkJCQkvLyByZWNvbXB1dGVkIGdlbmVyYXRpbmcgZmxpY2tlciAmIHVzaW5nIG1vcmUgbWVtb3J5IHRoYW4gbmVjZXNzYXJ5LgoJCQkJbWUucmVuZGVyKG1lLm9wdGlvbnMuaG92ZXIuYW5pbWF0aW9uRHVyYXRpb24sIHRydWUpOwoJCQl9CgoJCQltZS5fYnVmZmVyZWRSZW5kZXIgPSBmYWxzZTsKCQkJbWUuX2J1ZmZlcmVkUmVxdWVzdCA9IG51bGw7CgoJCQlyZXR1cm4gbWU7CgkJfSwKCgkJLyoqCgkJICogSGFuZGxlIGFuIGV2ZW50CgkJICogQHByaXZhdGUKCQkgKiBAcGFyYW0ge0lFdmVudH0gZXZlbnQgdGhlIGV2ZW50IHRvIGhhbmRsZQoJCSAqIEByZXR1cm4ge0Jvb2xlYW59IHRydWUgaWYgdGhlIGNoYXJ0IG5lZWRzIHRvIHJlLXJlbmRlcgoJCSAqLwoJCWhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBvcHRpb25zID0gbWUub3B0aW9ucyB8fCB7fTsKCQkJdmFyIGhvdmVyT3B0aW9ucyA9IG9wdGlvbnMuaG92ZXI7CgkJCXZhciBjaGFuZ2VkID0gZmFsc2U7CgoJCQltZS5sYXN0QWN0aXZlID0gbWUubGFzdEFjdGl2ZSB8fCBbXTsKCgkJCS8vIEZpbmQgQWN0aXZlIEVsZW1lbnRzIGZvciBob3ZlciBhbmQgdG9vbHRpcHMKCQkJaWYgKGUudHlwZSA9PT0gJ21vdXNlb3V0JykgewoJCQkJbWUuYWN0aXZlID0gW107CgkJCX0gZWxzZSB7CgkJCQltZS5hY3RpdmUgPSBtZS5nZXRFbGVtZW50c0F0RXZlbnRGb3JNb2RlKGUsIGhvdmVyT3B0aW9ucy5tb2RlLCBob3Zlck9wdGlvbnMpOwoJCQl9CgoJCQkvLyBJbnZva2Ugb25Ib3ZlciBob29rCgkJCS8vIE5lZWQgdG8gY2FsbCB3aXRoIG5hdGl2ZSBldmVudCBoZXJlIHRvIG5vdCBicmVhayBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJCQloZWxwZXJzLmNhbGxiYWNrKG9wdGlvbnMub25Ib3ZlciB8fCBvcHRpb25zLmhvdmVyLm9uSG92ZXIsIFtlLm5hdGl2ZSwgbWUuYWN0aXZlXSwgbWUpOwoKCQkJaWYgKGUudHlwZSA9PT0gJ21vdXNldXAnIHx8IGUudHlwZSA9PT0gJ2NsaWNrJykgewoJCQkJaWYgKG9wdGlvbnMub25DbGljaykgewoJCQkJCS8vIFVzZSBlLm5hdGl2ZSBoZXJlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJCQkJCW9wdGlvbnMub25DbGljay5jYWxsKG1lLCBlLm5hdGl2ZSwgbWUuYWN0aXZlKTsKCQkJCX0KCQkJfQoKCQkJLy8gUmVtb3ZlIHN0eWxpbmcgZm9yIGxhc3QgYWN0aXZlIChldmVuIGlmIGl0IG1heSBzdGlsbCBiZSBhY3RpdmUpCgkJCWlmIChtZS5sYXN0QWN0aXZlLmxlbmd0aCkgewoJCQkJbWUudXBkYXRlSG92ZXJTdHlsZShtZS5sYXN0QWN0aXZlLCBob3Zlck9wdGlvbnMubW9kZSwgZmFsc2UpOwoJCQl9CgoJCQkvLyBCdWlsdCBpbiBob3ZlciBzdHlsaW5nCgkJCWlmIChtZS5hY3RpdmUubGVuZ3RoICYmIGhvdmVyT3B0aW9ucy5tb2RlKSB7CgkJCQltZS51cGRhdGVIb3ZlclN0eWxlKG1lLmFjdGl2ZSwgaG92ZXJPcHRpb25zLm1vZGUsIHRydWUpOwoJCQl9CgoJCQljaGFuZ2VkID0gIWhlbHBlcnMuYXJyYXlFcXVhbHMobWUuYWN0aXZlLCBtZS5sYXN0QWN0aXZlKTsKCgkJCS8vIFJlbWVtYmVyIExhc3QgQWN0aXZlcwoJCQltZS5sYXN0QWN0aXZlID0gbWUuYWN0aXZlOwoKCQkJcmV0dXJuIGNoYW5nZWQ7CgkJfQoJfSk7CgoJLyoqCgkgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0IGluc3RlYWQuCgkgKiBAY2xhc3MgQ2hhcnQuQ29udHJvbGxlcgoJICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjYuMAoJICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMwoJICogQHByaXZhdGUKCSAqLwoJQ2hhcnQuQ29udHJvbGxlciA9IENoYXJ0Owp9OwoKfSx7IjI1IjoyNSwiMjgiOjI4LCIzMCI6MzAsIjMxIjozMSwiNDUiOjQ1LCI0OCI6NDh9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJdmFyIGFycmF5RXZlbnRzID0gWydwdXNoJywgJ3BvcCcsICdzaGlmdCcsICdzcGxpY2UnLCAndW5zaGlmdCddOwoKCS8qKgoJICogSG9va3MgdGhlIGFycmF5IG1ldGhvZHMgdGhhdCBhZGQgb3IgcmVtb3ZlIHZhbHVlcyAoJ3B1c2gnLCBwb3AnLCAnc2hpZnQnLCAnc3BsaWNlJywKCSAqICd1bnNoaWZ0JykgYW5kIG5vdGlmeSB0aGUgbGlzdGVuZXIgQUZURVIgdGhlIGFycmF5IGhhcyBiZWVuIGFsdGVyZWQuIExpc3RlbmVycyBhcmUKCSAqIGNhbGxlZCBvbiB0aGUgJ29uRGF0YSonIGNhbGxiYWNrcyAoZS5nLiBvbkRhdGFQdXNoLCBldGMuKSB3aXRoIHNhbWUgYXJndW1lbnRzLgoJICovCglmdW5jdGlvbiBsaXN0ZW5BcnJheUV2ZW50cyhhcnJheSwgbGlzdGVuZXIpIHsKCQlpZiAoYXJyYXkuX2NoYXJ0anMpIHsKCQkJYXJyYXkuX2NoYXJ0anMubGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpOwoJCQlyZXR1cm47CgkJfQoKCQlPYmplY3QuZGVmaW5lUHJvcGVydHkoYXJyYXksICdfY2hhcnRqcycsIHsKCQkJY29uZmlndXJhYmxlOiB0cnVlLAoJCQllbnVtZXJhYmxlOiBmYWxzZSwKCQkJdmFsdWU6IHsKCQkJCWxpc3RlbmVyczogW2xpc3RlbmVyXQoJCQl9CgkJfSk7CgoJCWFycmF5RXZlbnRzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7CgkJCXZhciBtZXRob2QgPSAnb25EYXRhJyArIGtleS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSgxKTsKCQkJdmFyIGJhc2UgPSBhcnJheVtrZXldOwoKCQkJT2JqZWN0LmRlZmluZVByb3BlcnR5KGFycmF5LCBrZXksIHsKCQkJCWNvbmZpZ3VyYWJsZTogdHJ1ZSwKCQkJCWVudW1lcmFibGU6IGZhbHNlLAoJCQkJdmFsdWU6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCQkJCQl2YXIgcmVzID0gYmFzZS5hcHBseSh0aGlzLCBhcmdzKTsKCgkJCQkJaGVscGVycy5lYWNoKGFycmF5Ll9jaGFydGpzLmxpc3RlbmVycywgZnVuY3Rpb24ob2JqZWN0KSB7CgkJCQkJCWlmICh0eXBlb2Ygb2JqZWN0W21ldGhvZF0gPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCW9iamVjdFttZXRob2RdLmFwcGx5KG9iamVjdCwgYXJncyk7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkJcmV0dXJuIHJlczsKCQkJCX0KCQkJfSk7CgkJfSk7Cgl9CgoJLyoqCgkgKiBSZW1vdmVzIHRoZSBnaXZlbiBhcnJheSBldmVudCBsaXN0ZW5lciBhbmQgY2xlYW51cCBleHRyYSBhdHRhY2hlZCBwcm9wZXJ0aWVzIChzdWNoIGFzCgkgKiB0aGUgX2NoYXJ0anMgc3R1YiBhbmQgb3ZlcnJpZGRlbiBtZXRob2RzKSBpZiBhcnJheSBkb2Vzbid0IGhhdmUgYW55IG1vcmUgbGlzdGVuZXJzLgoJICovCglmdW5jdGlvbiB1bmxpc3RlbkFycmF5RXZlbnRzKGFycmF5LCBsaXN0ZW5lcikgewoJCXZhciBzdHViID0gYXJyYXkuX2NoYXJ0anM7CgkJaWYgKCFzdHViKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBsaXN0ZW5lcnMgPSBzdHViLmxpc3RlbmVyczsKCQl2YXIgaW5kZXggPSBsaXN0ZW5lcnMuaW5kZXhPZihsaXN0ZW5lcik7CgkJaWYgKGluZGV4ICE9PSAtMSkgewoJCQlsaXN0ZW5lcnMuc3BsaWNlKGluZGV4LCAxKTsKCQl9CgoJCWlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewoJCQlyZXR1cm47CgkJfQoKCQlhcnJheUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkgewoJCQlkZWxldGUgYXJyYXlba2V5XTsKCQl9KTsKCgkJZGVsZXRlIGFycmF5Ll9jaGFydGpzOwoJfQoKCS8vIEJhc2UgY2xhc3MgZm9yIGFsbCBkYXRhc2V0IGNvbnRyb2xsZXJzIChsaW5lLCBiYXIsIGV0YykKCUNoYXJ0LkRhdGFzZXRDb250cm9sbGVyID0gZnVuY3Rpb24oY2hhcnQsIGRhdGFzZXRJbmRleCkgewoJCXRoaXMuaW5pdGlhbGl6ZShjaGFydCwgZGF0YXNldEluZGV4KTsKCX07CgoJaGVscGVycy5leHRlbmQoQ2hhcnQuRGF0YXNldENvbnRyb2xsZXIucHJvdG90eXBlLCB7CgoJCS8qKgoJCSAqIEVsZW1lbnQgdHlwZSB1c2VkIHRvIGdlbmVyYXRlIGEgbWV0YSBkYXRhc2V0IChlLmcuIENoYXJ0LmVsZW1lbnQuTGluZSkuCgkJICogQHR5cGUge0NoYXJ0LmNvcmUuZWxlbWVudH0KCQkgKi8KCQlkYXRhc2V0RWxlbWVudFR5cGU6IG51bGwsCgoJCS8qKgoJCSAqIEVsZW1lbnQgdHlwZSB1c2VkIHRvIGdlbmVyYXRlIGEgbWV0YSBkYXRhIChlLmcuIENoYXJ0LmVsZW1lbnQuUG9pbnQpLgoJCSAqIEB0eXBlIHtDaGFydC5jb3JlLmVsZW1lbnR9CgkJICovCgkJZGF0YUVsZW1lbnRUeXBlOiBudWxsLAoKCQlpbml0aWFsaXplOiBmdW5jdGlvbihjaGFydCwgZGF0YXNldEluZGV4KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCW1lLmNoYXJ0ID0gY2hhcnQ7CgkJCW1lLmluZGV4ID0gZGF0YXNldEluZGV4OwoJCQltZS5saW5rU2NhbGVzKCk7CgkJCW1lLmFkZEVsZW1lbnRzKCk7CgkJfSwKCgkJdXBkYXRlSW5kZXg6IGZ1bmN0aW9uKGRhdGFzZXRJbmRleCkgewoJCQl0aGlzLmluZGV4ID0gZGF0YXNldEluZGV4OwoJCX0sCgoJCWxpbmtTY2FsZXM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKCQkJdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CgoJCQlpZiAobWV0YS54QXhpc0lEID09PSBudWxsIHx8ICEobWV0YS54QXhpc0lEIGluIG1lLmNoYXJ0LnNjYWxlcykpIHsKCQkJCW1ldGEueEF4aXNJRCA9IGRhdGFzZXQueEF4aXNJRCB8fCBtZS5jaGFydC5vcHRpb25zLnNjYWxlcy54QXhlc1swXS5pZDsKCQkJfQoJCQlpZiAobWV0YS55QXhpc0lEID09PSBudWxsIHx8ICEobWV0YS55QXhpc0lEIGluIG1lLmNoYXJ0LnNjYWxlcykpIHsKCQkJCW1ldGEueUF4aXNJRCA9IGRhdGFzZXQueUF4aXNJRCB8fCBtZS5jaGFydC5vcHRpb25zLnNjYWxlcy55QXhlc1swXS5pZDsKCQkJfQoJCX0sCgoJCWdldERhdGFzZXQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzW3RoaXMuaW5kZXhdOwoJCX0sCgoJCWdldE1ldGE6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5jaGFydC5nZXREYXRhc2V0TWV0YSh0aGlzLmluZGV4KTsKCQl9LAoKCQlnZXRTY2FsZUZvcklkOiBmdW5jdGlvbihzY2FsZUlEKSB7CgkJCXJldHVybiB0aGlzLmNoYXJ0LnNjYWxlc1tzY2FsZUlEXTsKCQl9LAoKCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlKHRydWUpOwoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCWlmICh0aGlzLl9kYXRhKSB7CgkJCQl1bmxpc3RlbkFycmF5RXZlbnRzKHRoaXMuX2RhdGEsIHRoaXMpOwoJCQl9CgkJfSwKCgkJY3JlYXRlTWV0YURhdGFzZXQ6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgdHlwZSA9IG1lLmRhdGFzZXRFbGVtZW50VHlwZTsKCQkJcmV0dXJuIHR5cGUgJiYgbmV3IHR5cGUoewoJCQkJX2NoYXJ0OiBtZS5jaGFydCwKCQkJCV9kYXRhc2V0SW5kZXg6IG1lLmluZGV4CgkJCX0pOwoJCX0sCgoJCWNyZWF0ZU1ldGFEYXRhOiBmdW5jdGlvbihpbmRleCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgdHlwZSA9IG1lLmRhdGFFbGVtZW50VHlwZTsKCQkJcmV0dXJuIHR5cGUgJiYgbmV3IHR5cGUoewoJCQkJX2NoYXJ0OiBtZS5jaGFydCwKCQkJCV9kYXRhc2V0SW5kZXg6IG1lLmluZGV4LAoJCQkJX2luZGV4OiBpbmRleAoJCQl9KTsKCQl9LAoKCQlhZGRFbGVtZW50czogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwoJCQl2YXIgZGF0YSA9IG1lLmdldERhdGFzZXQoKS5kYXRhIHx8IFtdOwoJCQl2YXIgbWV0YURhdGEgPSBtZXRhLmRhdGE7CgkJCXZhciBpLCBpbGVuOwoKCQkJZm9yIChpID0gMCwgaWxlbiA9IGRhdGEubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQltZXRhRGF0YVtpXSA9IG1ldGFEYXRhW2ldIHx8IG1lLmNyZWF0ZU1ldGFEYXRhKGkpOwoJCQl9CgoJCQltZXRhLmRhdGFzZXQgPSBtZXRhLmRhdGFzZXQgfHwgbWUuY3JlYXRlTWV0YURhdGFzZXQoKTsKCQl9LAoKCQlhZGRFbGVtZW50QW5kUmVzZXQ6IGZ1bmN0aW9uKGluZGV4KSB7CgkJCXZhciBlbGVtZW50ID0gdGhpcy5jcmVhdGVNZXRhRGF0YShpbmRleCk7CgkJCXRoaXMuZ2V0TWV0YSgpLmRhdGEuc3BsaWNlKGluZGV4LCAwLCBlbGVtZW50KTsKCQkJdGhpcy51cGRhdGVFbGVtZW50KGVsZW1lbnQsIGluZGV4LCB0cnVlKTsKCQl9LAoKCQlidWlsZE9yVXBkYXRlRWxlbWVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTsKCQkJdmFyIGRhdGEgPSBkYXRhc2V0LmRhdGEgfHwgKGRhdGFzZXQuZGF0YSA9IFtdKTsKCgkJCS8vIEluIG9yZGVyIHRvIGNvcnJlY3RseSBoYW5kbGUgZGF0YSBhZGRpdGlvbi9kZWxldGlvbiBhbmltYXRpb24gKGFuIHRodXMgc2ltdWxhdGUKCQkJLy8gcmVhbC10aW1lIGNoYXJ0cyksIHdlIG5lZWQgdG8gbW9uaXRvciB0aGVzZSBkYXRhIG1vZGlmaWNhdGlvbnMgYW5kIHN5bmNocm9uaXplCgkJCS8vIHRoZSBpbnRlcm5hbCBtZXRhIGRhdGEgYWNjb3JkaW5nbHkuCgkJCWlmIChtZS5fZGF0YSAhPT0gZGF0YSkgewoJCQkJaWYgKG1lLl9kYXRhKSB7CgkJCQkJLy8gVGhpcyBjYXNlIGhhcHBlbnMgd2hlbiB0aGUgdXNlciByZXBsYWNlZCB0aGUgZGF0YSBhcnJheSBpbnN0YW5jZS4KCQkJCQl1bmxpc3RlbkFycmF5RXZlbnRzKG1lLl9kYXRhLCBtZSk7CgkJCQl9CgoJCQkJbGlzdGVuQXJyYXlFdmVudHMoZGF0YSwgbWUpOwoJCQkJbWUuX2RhdGEgPSBkYXRhOwoJCQl9CgoJCQkvLyBSZS1zeW5jIG1ldGEgZGF0YSBpbiBjYXNlIHRoZSB1c2VyIHJlcGxhY2VkIHRoZSBkYXRhIGFycmF5IG9yIGlmIHdlIG1pc3NlZAoJCQkvLyBhbnkgdXBkYXRlcyBhbmQgc28gbWFrZSBzdXJlIHRoYXQgd2UgaGFuZGxlIG51bWJlciBvZiBkYXRhcG9pbnRzIGNoYW5naW5nLgoJCQltZS5yZXN5bmNFbGVtZW50cygpOwoJCX0sCgoJCXVwZGF0ZTogaGVscGVycy5ub29wLAoKCQl0cmFuc2l0aW9uOiBmdW5jdGlvbihlYXNpbmdWYWx1ZSkgewoJCQl2YXIgbWV0YSA9IHRoaXMuZ2V0TWV0YSgpOwoJCQl2YXIgZWxlbWVudHMgPSBtZXRhLmRhdGEgfHwgW107CgkJCXZhciBpbGVuID0gZWxlbWVudHMubGVuZ3RoOwoJCQl2YXIgaSA9IDA7CgoJCQlmb3IgKDsgaSA8IGlsZW47ICsraSkgewoJCQkJZWxlbWVudHNbaV0udHJhbnNpdGlvbihlYXNpbmdWYWx1ZSk7CgkJCX0KCgkJCWlmIChtZXRhLmRhdGFzZXQpIHsKCQkJCW1ldGEuZGF0YXNldC50cmFuc2l0aW9uKGVhc2luZ1ZhbHVlKTsKCQkJfQoJCX0sCgoJCWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWV0YSA9IHRoaXMuZ2V0TWV0YSgpOwoJCQl2YXIgZWxlbWVudHMgPSBtZXRhLmRhdGEgfHwgW107CgkJCXZhciBpbGVuID0gZWxlbWVudHMubGVuZ3RoOwoJCQl2YXIgaSA9IDA7CgoJCQlpZiAobWV0YS5kYXRhc2V0KSB7CgkJCQltZXRhLmRhdGFzZXQuZHJhdygpOwoJCQl9CgoJCQlmb3IgKDsgaSA8IGlsZW47ICsraSkgewoJCQkJZWxlbWVudHNbaV0uZHJhdygpOwoJCQl9CgkJfSwKCgkJcmVtb3ZlSG92ZXJTdHlsZTogZnVuY3Rpb24oZWxlbWVudCwgZWxlbWVudE9wdHMpIHsKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZWxlbWVudC5fZGF0YXNldEluZGV4XTsKCQkJdmFyIGluZGV4ID0gZWxlbWVudC5faW5kZXg7CgkJCXZhciBjdXN0b20gPSBlbGVtZW50LmN1c3RvbSB8fCB7fTsKCQkJdmFyIHZhbHVlT3JEZWZhdWx0ID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQ7CgkJCXZhciBtb2RlbCA9IGVsZW1lbnQuX21vZGVsOwoKCQkJbW9kZWwuYmFja2dyb3VuZENvbG9yID0gY3VzdG9tLmJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgOiB2YWx1ZU9yRGVmYXVsdChkYXRhc2V0LmJhY2tncm91bmRDb2xvciwgaW5kZXgsIGVsZW1lbnRPcHRzLmJhY2tncm91bmRDb2xvcik7CgkJCW1vZGVsLmJvcmRlckNvbG9yID0gY3VzdG9tLmJvcmRlckNvbG9yID8gY3VzdG9tLmJvcmRlckNvbG9yIDogdmFsdWVPckRlZmF1bHQoZGF0YXNldC5ib3JkZXJDb2xvciwgaW5kZXgsIGVsZW1lbnRPcHRzLmJvcmRlckNvbG9yKTsKCQkJbW9kZWwuYm9yZGVyV2lkdGggPSBjdXN0b20uYm9yZGVyV2lkdGggPyBjdXN0b20uYm9yZGVyV2lkdGggOiB2YWx1ZU9yRGVmYXVsdChkYXRhc2V0LmJvcmRlcldpZHRoLCBpbmRleCwgZWxlbWVudE9wdHMuYm9yZGVyV2lkdGgpOwoJCX0sCgoJCXNldEhvdmVyU3R5bGU6IGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQkJdmFyIGRhdGFzZXQgPSB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZWxlbWVudC5fZGF0YXNldEluZGV4XTsKCQkJdmFyIGluZGV4ID0gZWxlbWVudC5faW5kZXg7CgkJCXZhciBjdXN0b20gPSBlbGVtZW50LmN1c3RvbSB8fCB7fTsKCQkJdmFyIHZhbHVlT3JEZWZhdWx0ID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQ7CgkJCXZhciBnZXRIb3ZlckNvbG9yID0gaGVscGVycy5nZXRIb3ZlckNvbG9yOwoJCQl2YXIgbW9kZWwgPSBlbGVtZW50Ll9tb2RlbDsKCgkJCW1vZGVsLmJhY2tncm91bmRDb2xvciA9IGN1c3RvbS5ob3ZlckJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5ob3ZlckJhY2tncm91bmRDb2xvciA6IHZhbHVlT3JEZWZhdWx0KGRhdGFzZXQuaG92ZXJCYWNrZ3JvdW5kQ29sb3IsIGluZGV4LCBnZXRIb3ZlckNvbG9yKG1vZGVsLmJhY2tncm91bmRDb2xvcikpOwoJCQltb2RlbC5ib3JkZXJDb2xvciA9IGN1c3RvbS5ob3ZlckJvcmRlckNvbG9yID8gY3VzdG9tLmhvdmVyQm9yZGVyQ29sb3IgOiB2YWx1ZU9yRGVmYXVsdChkYXRhc2V0LmhvdmVyQm9yZGVyQ29sb3IsIGluZGV4LCBnZXRIb3ZlckNvbG9yKG1vZGVsLmJvcmRlckNvbG9yKSk7CgkJCW1vZGVsLmJvcmRlcldpZHRoID0gY3VzdG9tLmhvdmVyQm9yZGVyV2lkdGggPyBjdXN0b20uaG92ZXJCb3JkZXJXaWR0aCA6IHZhbHVlT3JEZWZhdWx0KGRhdGFzZXQuaG92ZXJCb3JkZXJXaWR0aCwgaW5kZXgsIG1vZGVsLmJvcmRlcldpZHRoKTsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCXJlc3luY0VsZW1lbnRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CgkJCXZhciBkYXRhID0gbWUuZ2V0RGF0YXNldCgpLmRhdGE7CgkJCXZhciBudW1NZXRhID0gbWV0YS5kYXRhLmxlbmd0aDsKCQkJdmFyIG51bURhdGEgPSBkYXRhLmxlbmd0aDsKCgkJCWlmIChudW1EYXRhIDwgbnVtTWV0YSkgewoJCQkJbWV0YS5kYXRhLnNwbGljZShudW1EYXRhLCBudW1NZXRhIC0gbnVtRGF0YSk7CgkJCX0gZWxzZSBpZiAobnVtRGF0YSA+IG51bU1ldGEpIHsKCQkJCW1lLmluc2VydEVsZW1lbnRzKG51bU1ldGEsIG51bURhdGEgLSBudW1NZXRhKTsKCQkJfQoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJaW5zZXJ0RWxlbWVudHM6IGZ1bmN0aW9uKHN0YXJ0LCBjb3VudCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKCQkJCXRoaXMuYWRkRWxlbWVudEFuZFJlc2V0KHN0YXJ0ICsgaSk7CgkJCX0KCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCW9uRGF0YVB1c2g6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmluc2VydEVsZW1lbnRzKHRoaXMuZ2V0RGF0YXNldCgpLmRhdGEubGVuZ3RoIC0gMSwgYXJndW1lbnRzLmxlbmd0aCk7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlvbkRhdGFQb3A6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdldE1ldGEoKS5kYXRhLnBvcCgpOwoJCX0sCgoJCS8qKgoJCSAqIEBwcml2YXRlCgkJICovCgkJb25EYXRhU2hpZnQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdldE1ldGEoKS5kYXRhLnNoaWZ0KCk7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlvbkRhdGFTcGxpY2U6IGZ1bmN0aW9uKHN0YXJ0LCBjb3VudCkgewoJCQl0aGlzLmdldE1ldGEoKS5kYXRhLnNwbGljZShzdGFydCwgY291bnQpOwoJCQl0aGlzLmluc2VydEVsZW1lbnRzKHN0YXJ0LCBhcmd1bWVudHMubGVuZ3RoIC0gMik7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlvbkRhdGFVbnNoaWZ0OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5pbnNlcnRFbGVtZW50cygwLCBhcmd1bWVudHMubGVuZ3RoKTsKCQl9Cgl9KTsKCglDaGFydC5EYXRhc2V0Q29udHJvbGxlci5leHRlbmQgPSBoZWxwZXJzLmluaGVyaXRzOwp9OwoKfSx7IjQ1Ijo0NX1dLDI1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCm1vZHVsZS5leHBvcnRzID0gewoJLyoqCgkgKiBAcHJpdmF0ZQoJICovCglfc2V0OiBmdW5jdGlvbihzY29wZSwgdmFsdWVzKSB7CgkJcmV0dXJuIGhlbHBlcnMubWVyZ2UodGhpc1tzY29wZV0gfHwgKHRoaXNbc2NvcGVdID0ge30pLCB2YWx1ZXMpOwoJfQp9OwoKfSx7IjQ1Ijo0NX1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGNvbG9yID0gcmVxdWlyZSgyKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmZ1bmN0aW9uIGludGVycG9sYXRlKHN0YXJ0LCB2aWV3LCBtb2RlbCwgZWFzZSkgewoJdmFyIGtleXMgPSBPYmplY3Qua2V5cyhtb2RlbCk7Cgl2YXIgaSwgaWxlbiwga2V5LCBhY3R1YWwsIG9yaWdpbiwgdGFyZ2V0LCB0eXBlLCBjMCwgYzE7CgoJZm9yIChpID0gMCwgaWxlbiA9IGtleXMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJa2V5ID0ga2V5c1tpXTsKCgkJdGFyZ2V0ID0gbW9kZWxba2V5XTsKCgkJLy8gaWYgYSB2YWx1ZSBpcyBhZGRlZCB0byB0aGUgbW9kZWwgYWZ0ZXIgcGl2b3QoKSBoYXMgYmVlbiBjYWxsZWQsIHRoZSB2aWV3CgkJLy8gZG9lc24ndCBjb250YWluIGl0LCBzbyBsZXQncyBpbml0aWFsaXplIHRoZSB2aWV3IHRvIHRoZSB0YXJnZXQgdmFsdWUuCgkJaWYgKCF2aWV3Lmhhc093blByb3BlcnR5KGtleSkpIHsKCQkJdmlld1trZXldID0gdGFyZ2V0OwoJCX0KCgkJYWN0dWFsID0gdmlld1trZXldOwoKCQlpZiAoYWN0dWFsID09PSB0YXJnZXQgfHwga2V5WzBdID09PSAnXycpIHsKCQkJY29udGludWU7CgkJfQoKCQlpZiAoIXN0YXJ0Lmhhc093blByb3BlcnR5KGtleSkpIHsKCQkJc3RhcnRba2V5XSA9IGFjdHVhbDsKCQl9CgoJCW9yaWdpbiA9IHN0YXJ0W2tleV07CgoJCXR5cGUgPSB0eXBlb2YgdGFyZ2V0OwoKCQlpZiAodHlwZSA9PT0gdHlwZW9mIG9yaWdpbikgewoJCQlpZiAodHlwZSA9PT0gJ3N0cmluZycpIHsKCQkJCWMwID0gY29sb3Iob3JpZ2luKTsKCQkJCWlmIChjMC52YWxpZCkgewoJCQkJCWMxID0gY29sb3IodGFyZ2V0KTsKCQkJCQlpZiAoYzEudmFsaWQpIHsKCQkJCQkJdmlld1trZXldID0gYzEubWl4KGMwLCBlYXNlKS5yZ2JTdHJpbmcoKTsKCQkJCQkJY29udGludWU7CgkJCQkJfQoJCQkJfQoJCQl9IGVsc2UgaWYgKHR5cGUgPT09ICdudW1iZXInICYmIGlzRmluaXRlKG9yaWdpbikgJiYgaXNGaW5pdGUodGFyZ2V0KSkgewoJCQkJdmlld1trZXldID0gb3JpZ2luICsgKHRhcmdldCAtIG9yaWdpbikgKiBlYXNlOwoJCQkJY29udGludWU7CgkJCX0KCQl9CgoJCXZpZXdba2V5XSA9IHRhcmdldDsKCX0KfQoKdmFyIEVsZW1lbnQgPSBmdW5jdGlvbihjb25maWd1cmF0aW9uKSB7CgloZWxwZXJzLmV4dGVuZCh0aGlzLCBjb25maWd1cmF0aW9uKTsKCXRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKaGVscGVycy5leHRlbmQoRWxlbWVudC5wcm90b3R5cGUsIHsKCglpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQl0aGlzLmhpZGRlbiA9IGZhbHNlOwoJfSwKCglwaXZvdDogZnVuY3Rpb24oKSB7CgkJdmFyIG1lID0gdGhpczsKCQlpZiAoIW1lLl92aWV3KSB7CgkJCW1lLl92aWV3ID0gaGVscGVycy5jbG9uZShtZS5fbW9kZWwpOwoJCX0KCQltZS5fc3RhcnQgPSB7fTsKCQlyZXR1cm4gbWU7Cgl9LAoKCXRyYW5zaXRpb246IGZ1bmN0aW9uKGVhc2UpIHsKCQl2YXIgbWUgPSB0aGlzOwoJCXZhciBtb2RlbCA9IG1lLl9tb2RlbDsKCQl2YXIgc3RhcnQgPSBtZS5fc3RhcnQ7CgkJdmFyIHZpZXcgPSBtZS5fdmlldzsKCgkJLy8gTm8gYW5pbWF0aW9uIC0+IE5vIFRyYW5zaXRpb24KCQlpZiAoIW1vZGVsIHx8IGVhc2UgPT09IDEpIHsKCQkJbWUuX3ZpZXcgPSBtb2RlbDsKCQkJbWUuX3N0YXJ0ID0gbnVsbDsKCQkJcmV0dXJuIG1lOwoJCX0KCgkJaWYgKCF2aWV3KSB7CgkJCXZpZXcgPSBtZS5fdmlldyA9IHt9OwoJCX0KCgkJaWYgKCFzdGFydCkgewoJCQlzdGFydCA9IG1lLl9zdGFydCA9IHt9OwoJCX0KCgkJaW50ZXJwb2xhdGUoc3RhcnQsIHZpZXcsIG1vZGVsLCBlYXNlKTsKCgkJcmV0dXJuIG1lOwoJfSwKCgl0b29sdGlwUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB7CgkJCXg6IHRoaXMuX21vZGVsLngsCgkJCXk6IHRoaXMuX21vZGVsLnkKCQl9OwoJfSwKCgloYXNWYWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGhlbHBlcnMuaXNOdW1iZXIodGhpcy5fbW9kZWwueCkgJiYgaGVscGVycy5pc051bWJlcih0aGlzLl9tb2RlbC55KTsKCX0KfSk7CgpFbGVtZW50LmV4dGVuZCA9IGhlbHBlcnMuaW5oZXJpdHM7Cgptb2R1bGUuZXhwb3J0cyA9IEVsZW1lbnQ7Cgp9LHsiMiI6MiwiNDUiOjQ1fV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiBnbG9iYWwgd2luZG93OiBmYWxzZSAqLwovKiBnbG9iYWwgZG9jdW1lbnQ6IGZhbHNlICovCid1c2Ugc3RyaWN0JzsKCnZhciBjb2xvciA9IHJlcXVpcmUoMik7CnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCS8vIC0tIEJhc2ljIGpzIHV0aWxpdHkgbWV0aG9kcwoKCWhlbHBlcnMuY29uZmlnTWVyZ2UgPSBmdW5jdGlvbigvKiBvYmplY3RzIC4uLiAqLykgewoJCXJldHVybiBoZWxwZXJzLm1lcmdlKGhlbHBlcnMuY2xvbmUoYXJndW1lbnRzWzBdKSwgW10uc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCB7CgkJCW1lcmdlcjogZnVuY3Rpb24oa2V5LCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucykgewoJCQkJdmFyIHR2YWwgPSB0YXJnZXRba2V5XSB8fCB7fTsKCQkJCXZhciBzdmFsID0gc291cmNlW2tleV07CgoJCQkJaWYgKGtleSA9PT0gJ3NjYWxlcycpIHsKCQkJCQkvLyBzY2FsZSBjb25maWcgbWVyZ2luZyBpcyBjb21wbGV4LiBBZGQgb3VyIG93biBmdW5jdGlvbiBoZXJlIGZvciB0aGF0CgkJCQkJdGFyZ2V0W2tleV0gPSBoZWxwZXJzLnNjYWxlTWVyZ2UodHZhbCwgc3ZhbCk7CgkJCQl9IGVsc2UgaWYgKGtleSA9PT0gJ3NjYWxlJykgewoJCQkJCS8vIHVzZWQgaW4gcG9sYXIgYXJlYSAmIHJhZGFyIGNoYXJ0cyBzaW5jZSB0aGVyZSBpcyBvbmx5IG9uZSBzY2FsZQoJCQkJCXRhcmdldFtrZXldID0gaGVscGVycy5tZXJnZSh0dmFsLCBbQ2hhcnQuc2NhbGVTZXJ2aWNlLmdldFNjYWxlRGVmYXVsdHMoc3ZhbC50eXBlKSwgc3ZhbF0pOwoJCQkJfSBlbHNlIHsKCQkJCQloZWxwZXJzLl9tZXJnZXIoa2V5LCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucyk7CgkJCQl9CgkJCX0KCQl9KTsKCX07CgoJaGVscGVycy5zY2FsZU1lcmdlID0gZnVuY3Rpb24oLyogb2JqZWN0cyAuLi4gKi8pIHsKCQlyZXR1cm4gaGVscGVycy5tZXJnZShoZWxwZXJzLmNsb25lKGFyZ3VtZW50c1swXSksIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgewoJCQltZXJnZXI6IGZ1bmN0aW9uKGtleSwgdGFyZ2V0LCBzb3VyY2UsIG9wdGlvbnMpIHsKCQkJCWlmIChrZXkgPT09ICd4QXhlcycgfHwga2V5ID09PSAneUF4ZXMnKSB7CgkJCQkJdmFyIHNsZW4gPSBzb3VyY2Vba2V5XS5sZW5ndGg7CgkJCQkJdmFyIGksIHR5cGUsIHNjYWxlOwoKCQkJCQlpZiAoIXRhcmdldFtrZXldKSB7CgkJCQkJCXRhcmdldFtrZXldID0gW107CgkJCQkJfQoKCQkJCQlmb3IgKGkgPSAwOyBpIDwgc2xlbjsgKytpKSB7CgkJCQkJCXNjYWxlID0gc291cmNlW2tleV1baV07CgkJCQkJCXR5cGUgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHNjYWxlLnR5cGUsIGtleSA9PT0gJ3hBeGVzJyA/ICdjYXRlZ29yeScgOiAnbGluZWFyJyk7CgoJCQkJCQlpZiAoaSA+PSB0YXJnZXRba2V5XS5sZW5ndGgpIHsKCQkJCQkJCXRhcmdldFtrZXldLnB1c2goe30pOwoJCQkJCQl9CgoJCQkJCQlpZiAoIXRhcmdldFtrZXldW2ldLnR5cGUgfHwgKHNjYWxlLnR5cGUgJiYgc2NhbGUudHlwZSAhPT0gdGFyZ2V0W2tleV1baV0udHlwZSkpIHsKCQkJCQkJCS8vIG5ldy91bnR5cGVkIHNjYWxlIG9yIHR5cGUgY2hhbmdlZDogbGV0J3MgYXBwbHkgdGhlIG5ldyBkZWZhdWx0cwoJCQkJCQkJLy8gdGhlbiBtZXJnZSBzb3VyY2Ugc2NhbGUgdG8gY29ycmVjdGx5IG92ZXJ3cml0ZSB0aGUgZGVmYXVsdHMuCgkJCQkJCQloZWxwZXJzLm1lcmdlKHRhcmdldFtrZXldW2ldLCBbQ2hhcnQuc2NhbGVTZXJ2aWNlLmdldFNjYWxlRGVmYXVsdHModHlwZSksIHNjYWxlXSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBzY2FsZXMgdHlwZSBhcmUgdGhlIHNhbWUKCQkJCQkJCWhlbHBlcnMubWVyZ2UodGFyZ2V0W2tleV1baV0sIHNjYWxlKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJaGVscGVycy5fbWVyZ2VyKGtleSwgdGFyZ2V0LCBzb3VyY2UsIG9wdGlvbnMpOwoJCQkJfQoJCQl9CgkJfSk7Cgl9OwoKCWhlbHBlcnMud2hlcmUgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCBmaWx0ZXJDYWxsYmFjaykgewoJCWlmIChoZWxwZXJzLmlzQXJyYXkoY29sbGVjdGlvbikgJiYgQXJyYXkucHJvdG90eXBlLmZpbHRlcikgewoJCQlyZXR1cm4gY29sbGVjdGlvbi5maWx0ZXIoZmlsdGVyQ2FsbGJhY2spOwoJCX0KCQl2YXIgZmlsdGVyZWQgPSBbXTsKCgkJaGVscGVycy5lYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKGl0ZW0pIHsKCQkJaWYgKGZpbHRlckNhbGxiYWNrKGl0ZW0pKSB7CgkJCQlmaWx0ZXJlZC5wdXNoKGl0ZW0pOwoJCQl9CgkJfSk7CgoJCXJldHVybiBmaWx0ZXJlZDsKCX07CgloZWxwZXJzLmZpbmRJbmRleCA9IEFycmF5LnByb3RvdHlwZS5maW5kSW5kZXggPwoJCWZ1bmN0aW9uKGFycmF5LCBjYWxsYmFjaywgc2NvcGUpIHsKCQkJcmV0dXJuIGFycmF5LmZpbmRJbmRleChjYWxsYmFjaywgc2NvcGUpOwoJCX0gOgoJCWZ1bmN0aW9uKGFycmF5LCBjYWxsYmFjaywgc2NvcGUpIHsKCQkJc2NvcGUgPSBzY29wZSA9PT0gdW5kZWZpbmVkID8gYXJyYXkgOiBzY29wZTsKCQkJZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBhcnJheS5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJCWlmIChjYWxsYmFjay5jYWxsKHNjb3BlLCBhcnJheVtpXSwgaSwgYXJyYXkpKSB7CgkJCQkJcmV0dXJuIGk7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIC0xOwoJCX07CgloZWxwZXJzLmZpbmROZXh0V2hlcmUgPSBmdW5jdGlvbihhcnJheVRvU2VhcmNoLCBmaWx0ZXJDYWxsYmFjaywgc3RhcnRJbmRleCkgewoJCS8vIERlZmF1bHQgdG8gc3RhcnQgb2YgdGhlIGFycmF5CgkJaWYgKGhlbHBlcnMuaXNOdWxsT3JVbmRlZihzdGFydEluZGV4KSkgewoJCQlzdGFydEluZGV4ID0gLTE7CgkJfQoJCWZvciAodmFyIGkgPSBzdGFydEluZGV4ICsgMTsgaSA8IGFycmF5VG9TZWFyY2gubGVuZ3RoOyBpKyspIHsKCQkJdmFyIGN1cnJlbnRJdGVtID0gYXJyYXlUb1NlYXJjaFtpXTsKCQkJaWYgKGZpbHRlckNhbGxiYWNrKGN1cnJlbnRJdGVtKSkgewoJCQkJcmV0dXJuIGN1cnJlbnRJdGVtOwoJCQl9CgkJfQoJfTsKCWhlbHBlcnMuZmluZFByZXZpb3VzV2hlcmUgPSBmdW5jdGlvbihhcnJheVRvU2VhcmNoLCBmaWx0ZXJDYWxsYmFjaywgc3RhcnRJbmRleCkgewoJCS8vIERlZmF1bHQgdG8gZW5kIG9mIHRoZSBhcnJheQoJCWlmIChoZWxwZXJzLmlzTnVsbE9yVW5kZWYoc3RhcnRJbmRleCkpIHsKCQkJc3RhcnRJbmRleCA9IGFycmF5VG9TZWFyY2gubGVuZ3RoOwoJCX0KCQlmb3IgKHZhciBpID0gc3RhcnRJbmRleCAtIDE7IGkgPj0gMDsgaS0tKSB7CgkJCXZhciBjdXJyZW50SXRlbSA9IGFycmF5VG9TZWFyY2hbaV07CgkJCWlmIChmaWx0ZXJDYWxsYmFjayhjdXJyZW50SXRlbSkpIHsKCQkJCXJldHVybiBjdXJyZW50SXRlbTsKCQkJfQoJCX0KCX07CgoJLy8gLS0gTWF0aCBtZXRob2RzCgloZWxwZXJzLmlzTnVtYmVyID0gZnVuY3Rpb24obikgewoJCXJldHVybiAhaXNOYU4ocGFyc2VGbG9hdChuKSkgJiYgaXNGaW5pdGUobik7Cgl9OwoJaGVscGVycy5hbG1vc3RFcXVhbHMgPSBmdW5jdGlvbih4LCB5LCBlcHNpbG9uKSB7CgkJcmV0dXJuIE1hdGguYWJzKHggLSB5KSA8IGVwc2lsb247Cgl9OwoJaGVscGVycy5hbG1vc3RXaG9sZSA9IGZ1bmN0aW9uKHgsIGVwc2lsb24pIHsKCQl2YXIgcm91bmRlZCA9IE1hdGgucm91bmQoeCk7CgkJcmV0dXJuICgoKHJvdW5kZWQgLSBlcHNpbG9uKSA8IHgpICYmICgocm91bmRlZCArIGVwc2lsb24pID4geCkpOwoJfTsKCWhlbHBlcnMubWF4ID0gZnVuY3Rpb24oYXJyYXkpIHsKCQlyZXR1cm4gYXJyYXkucmVkdWNlKGZ1bmN0aW9uKG1heCwgdmFsdWUpIHsKCQkJaWYgKCFpc05hTih2YWx1ZSkpIHsKCQkJCXJldHVybiBNYXRoLm1heChtYXgsIHZhbHVlKTsKCQkJfQoJCQlyZXR1cm4gbWF4OwoJCX0sIE51bWJlci5ORUdBVElWRV9JTkZJTklUWSk7Cgl9OwoJaGVscGVycy5taW4gPSBmdW5jdGlvbihhcnJheSkgewoJCXJldHVybiBhcnJheS5yZWR1Y2UoZnVuY3Rpb24obWluLCB2YWx1ZSkgewoJCQlpZiAoIWlzTmFOKHZhbHVlKSkgewoJCQkJcmV0dXJuIE1hdGgubWluKG1pbiwgdmFsdWUpOwoJCQl9CgkJCXJldHVybiBtaW47CgkJfSwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKTsKCX07CgloZWxwZXJzLnNpZ24gPSBNYXRoLnNpZ24gPwoJCWZ1bmN0aW9uKHgpIHsKCQkJcmV0dXJuIE1hdGguc2lnbih4KTsKCQl9IDoKCQlmdW5jdGlvbih4KSB7CgkJCXggPSAreDsgLy8gY29udmVydCB0byBhIG51bWJlcgoJCQlpZiAoeCA9PT0gMCB8fCBpc05hTih4KSkgewoJCQkJcmV0dXJuIHg7CgkJCX0KCQkJcmV0dXJuIHggPiAwID8gMSA6IC0xOwoJCX07CgloZWxwZXJzLmxvZzEwID0gTWF0aC5sb2cxMCA/CgkJZnVuY3Rpb24oeCkgewoJCQlyZXR1cm4gTWF0aC5sb2cxMCh4KTsKCQl9IDoKCQlmdW5jdGlvbih4KSB7CgkJCXZhciBleHBvbmVudCA9IE1hdGgubG9nKHgpICogTWF0aC5MT0cxMEU7IC8vIE1hdGguTE9HMTBFID0gMSAvIE1hdGguTE4xMC4KCQkJLy8gQ2hlY2sgZm9yIHdob2xlIHBvd2VycyBvZiAxMCwKCQkJLy8gd2hpY2ggZHVlIHRvIGZsb2F0aW5nIHBvaW50IHJvdW5kaW5nIGVycm9yIHNob3VsZCBiZSBjb3JyZWN0ZWQuCgkJCXZhciBwb3dlck9mMTAgPSBNYXRoLnJvdW5kKGV4cG9uZW50KTsKCQkJdmFyIGlzUG93ZXJPZjEwID0geCA9PT0gTWF0aC5wb3coMTAsIHBvd2VyT2YxMCk7CgoJCQlyZXR1cm4gaXNQb3dlck9mMTAgPyBwb3dlck9mMTAgOiBleHBvbmVudDsKCQl9OwoJaGVscGVycy50b1JhZGlhbnMgPSBmdW5jdGlvbihkZWdyZWVzKSB7CgkJcmV0dXJuIGRlZ3JlZXMgKiAoTWF0aC5QSSAvIDE4MCk7Cgl9OwoJaGVscGVycy50b0RlZ3JlZXMgPSBmdW5jdGlvbihyYWRpYW5zKSB7CgkJcmV0dXJuIHJhZGlhbnMgKiAoMTgwIC8gTWF0aC5QSSk7Cgl9OwoJLy8gR2V0cyB0aGUgYW5nbGUgZnJvbSB2ZXJ0aWNhbCB1cHJpZ2h0IHRvIHRoZSBwb2ludCBhYm91dCBhIGNlbnRyZS4KCWhlbHBlcnMuZ2V0QW5nbGVGcm9tUG9pbnQgPSBmdW5jdGlvbihjZW50cmVQb2ludCwgYW5nbGVQb2ludCkgewoJCXZhciBkaXN0YW5jZUZyb21YQ2VudGVyID0gYW5nbGVQb2ludC54IC0gY2VudHJlUG9pbnQueDsKCQl2YXIgZGlzdGFuY2VGcm9tWUNlbnRlciA9IGFuZ2xlUG9pbnQueSAtIGNlbnRyZVBvaW50Lnk7CgkJdmFyIHJhZGlhbERpc3RhbmNlRnJvbUNlbnRlciA9IE1hdGguc3FydChkaXN0YW5jZUZyb21YQ2VudGVyICogZGlzdGFuY2VGcm9tWENlbnRlciArIGRpc3RhbmNlRnJvbVlDZW50ZXIgKiBkaXN0YW5jZUZyb21ZQ2VudGVyKTsKCgkJdmFyIGFuZ2xlID0gTWF0aC5hdGFuMihkaXN0YW5jZUZyb21ZQ2VudGVyLCBkaXN0YW5jZUZyb21YQ2VudGVyKTsKCgkJaWYgKGFuZ2xlIDwgKC0wLjUgKiBNYXRoLlBJKSkgewoJCQlhbmdsZSArPSAyLjAgKiBNYXRoLlBJOyAvLyBtYWtlIHN1cmUgdGhlIHJldHVybmVkIGFuZ2xlIGlzIGluIHRoZSByYW5nZSBvZiAoLVBJLzIsIDNQSS8yXQoJCX0KCgkJcmV0dXJuIHsKCQkJYW5nbGU6IGFuZ2xlLAoJCQlkaXN0YW5jZTogcmFkaWFsRGlzdGFuY2VGcm9tQ2VudGVyCgkJfTsKCX07CgloZWxwZXJzLmRpc3RhbmNlQmV0d2VlblBvaW50cyA9IGZ1bmN0aW9uKHB0MSwgcHQyKSB7CgkJcmV0dXJuIE1hdGguc3FydChNYXRoLnBvdyhwdDIueCAtIHB0MS54LCAyKSArIE1hdGgucG93KHB0Mi55IC0gcHQxLnksIDIpKTsKCX07CgloZWxwZXJzLmFsaWFzUGl4ZWwgPSBmdW5jdGlvbihwaXhlbFdpZHRoKSB7CgkJcmV0dXJuIChwaXhlbFdpZHRoICUgMiA9PT0gMCkgPyAwIDogMC41OwoJfTsKCWhlbHBlcnMuc3BsaW5lQ3VydmUgPSBmdW5jdGlvbihmaXJzdFBvaW50LCBtaWRkbGVQb2ludCwgYWZ0ZXJQb2ludCwgdCkgewoJCS8vIFByb3BzIHRvIFJvYiBTcGVuY2VyIGF0IHNjYWxlZCBpbm5vdmF0aW9uIGZvciBoaXMgcG9zdCBvbiBzcGxpbmluZyBiZXR3ZWVuIHBvaW50cwoJCS8vIGh0dHA6Ly9zY2FsZWRpbm5vdmF0aW9uLmNvbS9hbmFseXRpY3Mvc3BsaW5lcy9hYm91dFNwbGluZXMuaHRtbAoKCQkvLyBUaGlzIGZ1bmN0aW9uIG11c3QgYWxzbyByZXNwZWN0ICJza2lwcGVkIiBwb2ludHMKCgkJdmFyIHByZXZpb3VzID0gZmlyc3RQb2ludC5za2lwID8gbWlkZGxlUG9pbnQgOiBmaXJzdFBvaW50OwoJCXZhciBjdXJyZW50ID0gbWlkZGxlUG9pbnQ7CgkJdmFyIG5leHQgPSBhZnRlclBvaW50LnNraXAgPyBtaWRkbGVQb2ludCA6IGFmdGVyUG9pbnQ7CgoJCXZhciBkMDEgPSBNYXRoLnNxcnQoTWF0aC5wb3coY3VycmVudC54IC0gcHJldmlvdXMueCwgMikgKyBNYXRoLnBvdyhjdXJyZW50LnkgLSBwcmV2aW91cy55LCAyKSk7CgkJdmFyIGQxMiA9IE1hdGguc3FydChNYXRoLnBvdyhuZXh0LnggLSBjdXJyZW50LngsIDIpICsgTWF0aC5wb3cobmV4dC55IC0gY3VycmVudC55LCAyKSk7CgoJCXZhciBzMDEgPSBkMDEgLyAoZDAxICsgZDEyKTsKCQl2YXIgczEyID0gZDEyIC8gKGQwMSArIGQxMik7CgoJCS8vIElmIGFsbCBwb2ludHMgYXJlIHRoZSBzYW1lLCBzMDEgJiBzMDIgd2lsbCBiZSBpbmYKCQlzMDEgPSBpc05hTihzMDEpID8gMCA6IHMwMTsKCQlzMTIgPSBpc05hTihzMTIpID8gMCA6IHMxMjsKCgkJdmFyIGZhID0gdCAqIHMwMTsgLy8gc2NhbGluZyBmYWN0b3IgZm9yIHRyaWFuZ2xlIFRhCgkJdmFyIGZiID0gdCAqIHMxMjsKCgkJcmV0dXJuIHsKCQkJcHJldmlvdXM6IHsKCQkJCXg6IGN1cnJlbnQueCAtIGZhICogKG5leHQueCAtIHByZXZpb3VzLngpLAoJCQkJeTogY3VycmVudC55IC0gZmEgKiAobmV4dC55IC0gcHJldmlvdXMueSkKCQkJfSwKCQkJbmV4dDogewoJCQkJeDogY3VycmVudC54ICsgZmIgKiAobmV4dC54IC0gcHJldmlvdXMueCksCgkJCQl5OiBjdXJyZW50LnkgKyBmYiAqIChuZXh0LnkgLSBwcmV2aW91cy55KQoJCQl9CgkJfTsKCX07CgloZWxwZXJzLkVQU0lMT04gPSBOdW1iZXIuRVBTSUxPTiB8fCAxZS0xNDsKCWhlbHBlcnMuc3BsaW5lQ3VydmVNb25vdG9uZSA9IGZ1bmN0aW9uKHBvaW50cykgewoJCS8vIFRoaXMgZnVuY3Rpb24gY2FsY3VsYXRlcyBCw6l6aWVyIGNvbnRyb2wgcG9pbnRzIGluIGEgc2ltaWxhciB3YXkgdGhhbiB8c3BsaW5lQ3VydmV8LAoJCS8vIGJ1dCBwcmVzZXJ2ZXMgbW9ub3RvbmljaXR5IG9mIHRoZSBwcm92aWRlZCBkYXRhIGFuZCBlbnN1cmVzIG5vIGxvY2FsIGV4dHJlbXVtcyBhcmUgYWRkZWQKCQkvLyBiZXR3ZWVuIHRoZSBkYXRhc2V0IGRpc2NyZXRlIHBvaW50cyBkdWUgdG8gdGhlIGludGVycG9sYXRpb24uCgkJLy8gU2VlIDogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTW9ub3RvbmVfY3ViaWNfaW50ZXJwb2xhdGlvbgoKCQl2YXIgcG9pbnRzV2l0aFRhbmdlbnRzID0gKHBvaW50cyB8fCBbXSkubWFwKGZ1bmN0aW9uKHBvaW50KSB7CgkJCXJldHVybiB7CgkJCQltb2RlbDogcG9pbnQuX21vZGVsLAoJCQkJZGVsdGFLOiAwLAoJCQkJbUs6IDAKCQkJfTsKCQl9KTsKCgkJLy8gQ2FsY3VsYXRlIHNsb3BlcyAoZGVsdGFLKSBhbmQgaW5pdGlhbGl6ZSB0YW5nZW50cyAobUspCgkJdmFyIHBvaW50c0xlbiA9IHBvaW50c1dpdGhUYW5nZW50cy5sZW5ndGg7CgkJdmFyIGksIHBvaW50QmVmb3JlLCBwb2ludEN1cnJlbnQsIHBvaW50QWZ0ZXI7CgkJZm9yIChpID0gMDsgaSA8IHBvaW50c0xlbjsgKytpKSB7CgkJCXBvaW50Q3VycmVudCA9IHBvaW50c1dpdGhUYW5nZW50c1tpXTsKCQkJaWYgKHBvaW50Q3VycmVudC5tb2RlbC5za2lwKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJcG9pbnRCZWZvcmUgPSBpID4gMCA/IHBvaW50c1dpdGhUYW5nZW50c1tpIC0gMV0gOiBudWxsOwoJCQlwb2ludEFmdGVyID0gaSA8IHBvaW50c0xlbiAtIDEgPyBwb2ludHNXaXRoVGFuZ2VudHNbaSArIDFdIDogbnVsbDsKCQkJaWYgKHBvaW50QWZ0ZXIgJiYgIXBvaW50QWZ0ZXIubW9kZWwuc2tpcCkgewoJCQkJdmFyIHNsb3BlRGVsdGFYID0gKHBvaW50QWZ0ZXIubW9kZWwueCAtIHBvaW50Q3VycmVudC5tb2RlbC54KTsKCgkJCQkvLyBJbiB0aGUgY2FzZSBvZiB0d28gcG9pbnRzIHRoYXQgYXBwZWFyIGF0IHRoZSBzYW1lIHggcGl4ZWwsIHNsb3BlRGVsdGFYIGlzIDAKCQkJCXBvaW50Q3VycmVudC5kZWx0YUsgPSBzbG9wZURlbHRhWCAhPT0gMCA/IChwb2ludEFmdGVyLm1vZGVsLnkgLSBwb2ludEN1cnJlbnQubW9kZWwueSkgLyBzbG9wZURlbHRhWCA6IDA7CgkJCX0KCgkJCWlmICghcG9pbnRCZWZvcmUgfHwgcG9pbnRCZWZvcmUubW9kZWwuc2tpcCkgewoJCQkJcG9pbnRDdXJyZW50Lm1LID0gcG9pbnRDdXJyZW50LmRlbHRhSzsKCQkJfSBlbHNlIGlmICghcG9pbnRBZnRlciB8fCBwb2ludEFmdGVyLm1vZGVsLnNraXApIHsKCQkJCXBvaW50Q3VycmVudC5tSyA9IHBvaW50QmVmb3JlLmRlbHRhSzsKCQkJfSBlbHNlIGlmICh0aGlzLnNpZ24ocG9pbnRCZWZvcmUuZGVsdGFLKSAhPT0gdGhpcy5zaWduKHBvaW50Q3VycmVudC5kZWx0YUspKSB7CgkJCQlwb2ludEN1cnJlbnQubUsgPSAwOwoJCQl9IGVsc2UgewoJCQkJcG9pbnRDdXJyZW50Lm1LID0gKHBvaW50QmVmb3JlLmRlbHRhSyArIHBvaW50Q3VycmVudC5kZWx0YUspIC8gMjsKCQkJfQoJCX0KCgkJLy8gQWRqdXN0IHRhbmdlbnRzIHRvIGVuc3VyZSBtb25vdG9uaWMgcHJvcGVydGllcwoJCXZhciBhbHBoYUssIGJldGFLLCB0YXVLLCBzcXVhcmVkTWFnbml0dWRlOwoJCWZvciAoaSA9IDA7IGkgPCBwb2ludHNMZW4gLSAxOyArK2kpIHsKCQkJcG9pbnRDdXJyZW50ID0gcG9pbnRzV2l0aFRhbmdlbnRzW2ldOwoJCQlwb2ludEFmdGVyID0gcG9pbnRzV2l0aFRhbmdlbnRzW2kgKyAxXTsKCQkJaWYgKHBvaW50Q3VycmVudC5tb2RlbC5za2lwIHx8IHBvaW50QWZ0ZXIubW9kZWwuc2tpcCkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCWlmIChoZWxwZXJzLmFsbW9zdEVxdWFscyhwb2ludEN1cnJlbnQuZGVsdGFLLCAwLCB0aGlzLkVQU0lMT04pKSB7CgkJCQlwb2ludEN1cnJlbnQubUsgPSBwb2ludEFmdGVyLm1LID0gMDsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlhbHBoYUsgPSBwb2ludEN1cnJlbnQubUsgLyBwb2ludEN1cnJlbnQuZGVsdGFLOwoJCQliZXRhSyA9IHBvaW50QWZ0ZXIubUsgLyBwb2ludEN1cnJlbnQuZGVsdGFLOwoJCQlzcXVhcmVkTWFnbml0dWRlID0gTWF0aC5wb3coYWxwaGFLLCAyKSArIE1hdGgucG93KGJldGFLLCAyKTsKCQkJaWYgKHNxdWFyZWRNYWduaXR1ZGUgPD0gOSkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCXRhdUsgPSAzIC8gTWF0aC5zcXJ0KHNxdWFyZWRNYWduaXR1ZGUpOwoJCQlwb2ludEN1cnJlbnQubUsgPSBhbHBoYUsgKiB0YXVLICogcG9pbnRDdXJyZW50LmRlbHRhSzsKCQkJcG9pbnRBZnRlci5tSyA9IGJldGFLICogdGF1SyAqIHBvaW50Q3VycmVudC5kZWx0YUs7CgkJfQoKCQkvLyBDb21wdXRlIGNvbnRyb2wgcG9pbnRzCgkJdmFyIGRlbHRhWDsKCQlmb3IgKGkgPSAwOyBpIDwgcG9pbnRzTGVuOyArK2kpIHsKCQkJcG9pbnRDdXJyZW50ID0gcG9pbnRzV2l0aFRhbmdlbnRzW2ldOwoJCQlpZiAocG9pbnRDdXJyZW50Lm1vZGVsLnNraXApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwb2ludEJlZm9yZSA9IGkgPiAwID8gcG9pbnRzV2l0aFRhbmdlbnRzW2kgLSAxXSA6IG51bGw7CgkJCXBvaW50QWZ0ZXIgPSBpIDwgcG9pbnRzTGVuIC0gMSA/IHBvaW50c1dpdGhUYW5nZW50c1tpICsgMV0gOiBudWxsOwoJCQlpZiAocG9pbnRCZWZvcmUgJiYgIXBvaW50QmVmb3JlLm1vZGVsLnNraXApIHsKCQkJCWRlbHRhWCA9IChwb2ludEN1cnJlbnQubW9kZWwueCAtIHBvaW50QmVmb3JlLm1vZGVsLngpIC8gMzsKCQkJCXBvaW50Q3VycmVudC5tb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1ggPSBwb2ludEN1cnJlbnQubW9kZWwueCAtIGRlbHRhWDsKCQkJCXBvaW50Q3VycmVudC5tb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1kgPSBwb2ludEN1cnJlbnQubW9kZWwueSAtIGRlbHRhWCAqIHBvaW50Q3VycmVudC5tSzsKCQkJfQoJCQlpZiAocG9pbnRBZnRlciAmJiAhcG9pbnRBZnRlci5tb2RlbC5za2lwKSB7CgkJCQlkZWx0YVggPSAocG9pbnRBZnRlci5tb2RlbC54IC0gcG9pbnRDdXJyZW50Lm1vZGVsLngpIC8gMzsKCQkJCXBvaW50Q3VycmVudC5tb2RlbC5jb250cm9sUG9pbnROZXh0WCA9IHBvaW50Q3VycmVudC5tb2RlbC54ICsgZGVsdGFYOwoJCQkJcG9pbnRDdXJyZW50Lm1vZGVsLmNvbnRyb2xQb2ludE5leHRZID0gcG9pbnRDdXJyZW50Lm1vZGVsLnkgKyBkZWx0YVggKiBwb2ludEN1cnJlbnQubUs7CgkJCX0KCQl9Cgl9OwoJaGVscGVycy5uZXh0SXRlbSA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGluZGV4LCBsb29wKSB7CgkJaWYgKGxvb3ApIHsKCQkJcmV0dXJuIGluZGV4ID49IGNvbGxlY3Rpb24ubGVuZ3RoIC0gMSA/IGNvbGxlY3Rpb25bMF0gOiBjb2xsZWN0aW9uW2luZGV4ICsgMV07CgkJfQoJCXJldHVybiBpbmRleCA+PSBjb2xsZWN0aW9uLmxlbmd0aCAtIDEgPyBjb2xsZWN0aW9uW2NvbGxlY3Rpb24ubGVuZ3RoIC0gMV0gOiBjb2xsZWN0aW9uW2luZGV4ICsgMV07Cgl9OwoJaGVscGVycy5wcmV2aW91c0l0ZW0gPSBmdW5jdGlvbihjb2xsZWN0aW9uLCBpbmRleCwgbG9vcCkgewoJCWlmIChsb29wKSB7CgkJCXJldHVybiBpbmRleCA8PSAwID8gY29sbGVjdGlvbltjb2xsZWN0aW9uLmxlbmd0aCAtIDFdIDogY29sbGVjdGlvbltpbmRleCAtIDFdOwoJCX0KCQlyZXR1cm4gaW5kZXggPD0gMCA/IGNvbGxlY3Rpb25bMF0gOiBjb2xsZWN0aW9uW2luZGV4IC0gMV07Cgl9OwoJLy8gSW1wbGVtZW50YXRpb24gb2YgdGhlIG5pY2UgbnVtYmVyIGFsZ29yaXRobSB1c2VkIGluIGRldGVybWluaW5nIHdoZXJlIGF4aXMgbGFiZWxzIHdpbGwgZ28KCWhlbHBlcnMubmljZU51bSA9IGZ1bmN0aW9uKHJhbmdlLCByb3VuZCkgewoJCXZhciBleHBvbmVudCA9IE1hdGguZmxvb3IoaGVscGVycy5sb2cxMChyYW5nZSkpOwoJCXZhciBmcmFjdGlvbiA9IHJhbmdlIC8gTWF0aC5wb3coMTAsIGV4cG9uZW50KTsKCQl2YXIgbmljZUZyYWN0aW9uOwoKCQlpZiAocm91bmQpIHsKCQkJaWYgKGZyYWN0aW9uIDwgMS41KSB7CgkJCQluaWNlRnJhY3Rpb24gPSAxOwoJCQl9IGVsc2UgaWYgKGZyYWN0aW9uIDwgMykgewoJCQkJbmljZUZyYWN0aW9uID0gMjsKCQkJfSBlbHNlIGlmIChmcmFjdGlvbiA8IDcpIHsKCQkJCW5pY2VGcmFjdGlvbiA9IDU7CgkJCX0gZWxzZSB7CgkJCQluaWNlRnJhY3Rpb24gPSAxMDsKCQkJfQoJCX0gZWxzZSBpZiAoZnJhY3Rpb24gPD0gMS4wKSB7CgkJCW5pY2VGcmFjdGlvbiA9IDE7CgkJfSBlbHNlIGlmIChmcmFjdGlvbiA8PSAyKSB7CgkJCW5pY2VGcmFjdGlvbiA9IDI7CgkJfSBlbHNlIGlmIChmcmFjdGlvbiA8PSA1KSB7CgkJCW5pY2VGcmFjdGlvbiA9IDU7CgkJfSBlbHNlIHsKCQkJbmljZUZyYWN0aW9uID0gMTA7CgkJfQoKCQlyZXR1cm4gbmljZUZyYWN0aW9uICogTWF0aC5wb3coMTAsIGV4cG9uZW50KTsKCX07CgkvLyBSZXF1ZXN0IGFuaW1hdGlvbiBwb2x5ZmlsbCAtIGh0dHA6Ly93d3cucGF1bGlyaXNoLmNvbS8yMDExL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtYW5pbWF0aW5nLwoJaGVscGVycy5yZXF1ZXN0QW5pbUZyYW1lID0gKGZ1bmN0aW9uKCkgewoJCWlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykgewoJCQlyZXR1cm4gZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCWNhbGxiYWNrKCk7CgkJCX07CgkJfQoJCXJldHVybiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CgkJCXdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKCQkJd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAoJCQl3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fAoJCQl3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwKCQkJZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCXJldHVybiB3aW5kb3cuc2V0VGltZW91dChjYWxsYmFjaywgMTAwMCAvIDYwKTsKCQkJfTsKCX0oKSk7CgkvLyAtLSBET00gbWV0aG9kcwoJaGVscGVycy5nZXRSZWxhdGl2ZVBvc2l0aW9uID0gZnVuY3Rpb24oZXZ0LCBjaGFydCkgewoJCXZhciBtb3VzZVgsIG1vdXNlWTsKCQl2YXIgZSA9IGV2dC5vcmlnaW5hbEV2ZW50IHx8IGV2dDsKCQl2YXIgY2FudmFzID0gZXZ0LmN1cnJlbnRUYXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQ7CgkJdmFyIGJvdW5kaW5nUmVjdCA9IGNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCgkJdmFyIHRvdWNoZXMgPSBlLnRvdWNoZXM7CgkJaWYgKHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPiAwKSB7CgkJCW1vdXNlWCA9IHRvdWNoZXNbMF0uY2xpZW50WDsKCQkJbW91c2VZID0gdG91Y2hlc1swXS5jbGllbnRZOwoKCQl9IGVsc2UgewoJCQltb3VzZVggPSBlLmNsaWVudFg7CgkJCW1vdXNlWSA9IGUuY2xpZW50WTsKCQl9CgoJCS8vIFNjYWxlIG1vdXNlIGNvb3JkaW5hdGVzIGludG8gY2FudmFzIGNvb3JkaW5hdGVzCgkJLy8gYnkgZm9sbG93aW5nIHRoZSBwYXR0ZXJuIGxhaWQgb3V0IGJ5ICdqZXJyeWonIGluIHRoZSBjb21tZW50cyBvZgoJCS8vIGh0dHA6Ly93d3cuaHRtbDVjYW52YXN0dXRvcmlhbHMuY29tL2FkdmFuY2VkL2h0bWw1LWNhbnZhcy1tb3VzZS1jb29yZGluYXRlcy8KCQl2YXIgcGFkZGluZ0xlZnQgPSBwYXJzZUZsb2F0KGhlbHBlcnMuZ2V0U3R5bGUoY2FudmFzLCAncGFkZGluZy1sZWZ0JykpOwoJCXZhciBwYWRkaW5nVG9wID0gcGFyc2VGbG9hdChoZWxwZXJzLmdldFN0eWxlKGNhbnZhcywgJ3BhZGRpbmctdG9wJykpOwoJCXZhciBwYWRkaW5nUmlnaHQgPSBwYXJzZUZsb2F0KGhlbHBlcnMuZ2V0U3R5bGUoY2FudmFzLCAncGFkZGluZy1yaWdodCcpKTsKCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoaGVscGVycy5nZXRTdHlsZShjYW52YXMsICdwYWRkaW5nLWJvdHRvbScpKTsKCQl2YXIgd2lkdGggPSBib3VuZGluZ1JlY3QucmlnaHQgLSBib3VuZGluZ1JlY3QubGVmdCAtIHBhZGRpbmdMZWZ0IC0gcGFkZGluZ1JpZ2h0OwoJCXZhciBoZWlnaHQgPSBib3VuZGluZ1JlY3QuYm90dG9tIC0gYm91bmRpbmdSZWN0LnRvcCAtIHBhZGRpbmdUb3AgLSBwYWRkaW5nQm90dG9tOwoKCQkvLyBXZSBkaXZpZGUgYnkgdGhlIGN1cnJlbnQgZGV2aWNlIHBpeGVsIHJhdGlvLCBiZWNhdXNlIHRoZSBjYW52YXMgaXMgc2NhbGVkIHVwIGJ5IHRoYXQgYW1vdW50IGluIGVhY2ggZGlyZWN0aW9uLiBIb3dldmVyCgkJLy8gdGhlIGJhY2tlbmQgbW9kZWwgaXMgaW4gdW5zY2FsZWQgY29vcmRpbmF0ZXMuIFNpbmNlIHdlIGFyZSBnb2luZyB0byBkZWFsIHdpdGggb3VyIG1vZGVsIGNvb3JkaW5hdGVzLCB3ZSBnbyBiYWNrIGhlcmUKCQltb3VzZVggPSBNYXRoLnJvdW5kKChtb3VzZVggLSBib3VuZGluZ1JlY3QubGVmdCAtIHBhZGRpbmdMZWZ0KSAvICh3aWR0aCkgKiBjYW52YXMud2lkdGggLyBjaGFydC5jdXJyZW50RGV2aWNlUGl4ZWxSYXRpbyk7CgkJbW91c2VZID0gTWF0aC5yb3VuZCgobW91c2VZIC0gYm91bmRpbmdSZWN0LnRvcCAtIHBhZGRpbmdUb3ApIC8gKGhlaWdodCkgKiBjYW52YXMuaGVpZ2h0IC8gY2hhcnQuY3VycmVudERldmljZVBpeGVsUmF0aW8pOwoKCQlyZXR1cm4gewoJCQl4OiBtb3VzZVgsCgkJCXk6IG1vdXNlWQoJCX07CgoJfTsKCgkvLyBQcml2YXRlIGhlbHBlciBmdW5jdGlvbiB0byBjb252ZXJ0IG1heC13aWR0aC9tYXgtaGVpZ2h0IHZhbHVlcyB0aGF0IG1heSBiZSBwZXJjZW50YWdlcyBpbnRvIGEgbnVtYmVyCglmdW5jdGlvbiBwYXJzZU1heFN0eWxlKHN0eWxlVmFsdWUsIG5vZGUsIHBhcmVudFByb3BlcnR5KSB7CgkJdmFyIHZhbHVlSW5QaXhlbHM7CgkJaWYgKHR5cGVvZiBzdHlsZVZhbHVlID09PSAnc3RyaW5nJykgewoJCQl2YWx1ZUluUGl4ZWxzID0gcGFyc2VJbnQoc3R5bGVWYWx1ZSwgMTApOwoKCQkJaWYgKHN0eWxlVmFsdWUuaW5kZXhPZignJScpICE9PSAtMSkgewoJCQkJLy8gcGVyY2VudGFnZSAqIHNpemUgaW4gZGltZW5zaW9uCgkJCQl2YWx1ZUluUGl4ZWxzID0gdmFsdWVJblBpeGVscyAvIDEwMCAqIG5vZGUucGFyZW50Tm9kZVtwYXJlbnRQcm9wZXJ0eV07CgkJCX0KCQl9IGVsc2UgewoJCQl2YWx1ZUluUGl4ZWxzID0gc3R5bGVWYWx1ZTsKCQl9CgoJCXJldHVybiB2YWx1ZUluUGl4ZWxzOwoJfQoKCS8qKgoJICogUmV0dXJucyBpZiB0aGUgZ2l2ZW4gdmFsdWUgY29udGFpbnMgYW4gZWZmZWN0aXZlIGNvbnN0cmFpbnQuCgkgKiBAcHJpdmF0ZQoJICovCglmdW5jdGlvbiBpc0NvbnN0cmFpbmVkVmFsdWUodmFsdWUpIHsKCQlyZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gJ25vbmUnOwoJfQoKCS8vIFByaXZhdGUgaGVscGVyIHRvIGdldCBhIGNvbnN0cmFpbnQgZGltZW5zaW9uCgkvLyBAcGFyYW0gZG9tTm9kZSA6IHRoZSBub2RlIHRvIGNoZWNrIHRoZSBjb25zdHJhaW50IG9uCgkvLyBAcGFyYW0gbWF4U3R5bGUgOiB0aGUgc3R5bGUgdGhhdCBkZWZpbmVzIHRoZSBtYXhpbXVtIGZvciB0aGUgZGlyZWN0aW9uIHdlIGFyZSB1c2luZyAobWF4V2lkdGggLyBtYXhIZWlnaHQpCgkvLyBAcGFyYW0gcGVyY2VudGFnZVByb3BlcnR5IDogcHJvcGVydHkgb2YgcGFyZW50IHRvIHVzZSB3aGVuIGNhbGN1bGF0aW5nIHdpZHRoIGFzIGEgcGVyY2VudGFnZQoJLy8gQHNlZSBodHRwOi8vd3d3Lm5hdGhhbmFlbGpvbmVzLmNvbS9ibG9nLzIwMTMvcmVhZGluZy1tYXgtd2lkdGgtY3Jvc3MtYnJvd3NlcgoJZnVuY3Rpb24gZ2V0Q29uc3RyYWludERpbWVuc2lvbihkb21Ob2RlLCBtYXhTdHlsZSwgcGVyY2VudGFnZVByb3BlcnR5KSB7CgkJdmFyIHZpZXcgPSBkb2N1bWVudC5kZWZhdWx0VmlldzsKCQl2YXIgcGFyZW50Tm9kZSA9IGRvbU5vZGUucGFyZW50Tm9kZTsKCQl2YXIgY29uc3RyYWluZWROb2RlID0gdmlldy5nZXRDb21wdXRlZFN0eWxlKGRvbU5vZGUpW21heFN0eWxlXTsKCQl2YXIgY29uc3RyYWluZWRDb250YWluZXIgPSB2aWV3LmdldENvbXB1dGVkU3R5bGUocGFyZW50Tm9kZSlbbWF4U3R5bGVdOwoJCXZhciBoYXNDTm9kZSA9IGlzQ29uc3RyYWluZWRWYWx1ZShjb25zdHJhaW5lZE5vZGUpOwoJCXZhciBoYXNDQ29udGFpbmVyID0gaXNDb25zdHJhaW5lZFZhbHVlKGNvbnN0cmFpbmVkQ29udGFpbmVyKTsKCQl2YXIgaW5maW5pdHkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CgoJCWlmIChoYXNDTm9kZSB8fCBoYXNDQ29udGFpbmVyKSB7CgkJCXJldHVybiBNYXRoLm1pbigKCQkJCWhhc0NOb2RlID8gcGFyc2VNYXhTdHlsZShjb25zdHJhaW5lZE5vZGUsIGRvbU5vZGUsIHBlcmNlbnRhZ2VQcm9wZXJ0eSkgOiBpbmZpbml0eSwKCQkJCWhhc0NDb250YWluZXIgPyBwYXJzZU1heFN0eWxlKGNvbnN0cmFpbmVkQ29udGFpbmVyLCBwYXJlbnROb2RlLCBwZXJjZW50YWdlUHJvcGVydHkpIDogaW5maW5pdHkpOwoJCX0KCgkJcmV0dXJuICdub25lJzsKCX0KCS8vIHJldHVybnMgTnVtYmVyIG9yIHVuZGVmaW5lZCBpZiBubyBjb25zdHJhaW50CgloZWxwZXJzLmdldENvbnN0cmFpbnRXaWR0aCA9IGZ1bmN0aW9uKGRvbU5vZGUpIHsKCQlyZXR1cm4gZ2V0Q29uc3RyYWludERpbWVuc2lvbihkb21Ob2RlLCAnbWF4LXdpZHRoJywgJ2NsaWVudFdpZHRoJyk7Cgl9OwoJLy8gcmV0dXJucyBOdW1iZXIgb3IgdW5kZWZpbmVkIGlmIG5vIGNvbnN0cmFpbnQKCWhlbHBlcnMuZ2V0Q29uc3RyYWludEhlaWdodCA9IGZ1bmN0aW9uKGRvbU5vZGUpIHsKCQlyZXR1cm4gZ2V0Q29uc3RyYWludERpbWVuc2lvbihkb21Ob2RlLCAnbWF4LWhlaWdodCcsICdjbGllbnRIZWlnaHQnKTsKCX07CgloZWxwZXJzLmdldE1heGltdW1XaWR0aCA9IGZ1bmN0aW9uKGRvbU5vZGUpIHsKCQl2YXIgY29udGFpbmVyID0gZG9tTm9kZS5wYXJlbnROb2RlOwoJCWlmICghY29udGFpbmVyKSB7CgkJCXJldHVybiBkb21Ob2RlLmNsaWVudFdpZHRoOwoJCX0KCgkJdmFyIHBhZGRpbmdMZWZ0ID0gcGFyc2VJbnQoaGVscGVycy5nZXRTdHlsZShjb250YWluZXIsICdwYWRkaW5nLWxlZnQnKSwgMTApOwoJCXZhciBwYWRkaW5nUmlnaHQgPSBwYXJzZUludChoZWxwZXJzLmdldFN0eWxlKGNvbnRhaW5lciwgJ3BhZGRpbmctcmlnaHQnKSwgMTApOwoJCXZhciB3ID0gY29udGFpbmVyLmNsaWVudFdpZHRoIC0gcGFkZGluZ0xlZnQgLSBwYWRkaW5nUmlnaHQ7CgkJdmFyIGN3ID0gaGVscGVycy5nZXRDb25zdHJhaW50V2lkdGgoZG9tTm9kZSk7CgkJcmV0dXJuIGlzTmFOKGN3KSA/IHcgOiBNYXRoLm1pbih3LCBjdyk7Cgl9OwoJaGVscGVycy5nZXRNYXhpbXVtSGVpZ2h0ID0gZnVuY3Rpb24oZG9tTm9kZSkgewoJCXZhciBjb250YWluZXIgPSBkb21Ob2RlLnBhcmVudE5vZGU7CgkJaWYgKCFjb250YWluZXIpIHsKCQkJcmV0dXJuIGRvbU5vZGUuY2xpZW50SGVpZ2h0OwoJCX0KCgkJdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUludChoZWxwZXJzLmdldFN0eWxlKGNvbnRhaW5lciwgJ3BhZGRpbmctdG9wJyksIDEwKTsKCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlSW50KGhlbHBlcnMuZ2V0U3R5bGUoY29udGFpbmVyLCAncGFkZGluZy1ib3R0b20nKSwgMTApOwoJCXZhciBoID0gY29udGFpbmVyLmNsaWVudEhlaWdodCAtIHBhZGRpbmdUb3AgLSBwYWRkaW5nQm90dG9tOwoJCXZhciBjaCA9IGhlbHBlcnMuZ2V0Q29uc3RyYWludEhlaWdodChkb21Ob2RlKTsKCQlyZXR1cm4gaXNOYU4oY2gpID8gaCA6IE1hdGgubWluKGgsIGNoKTsKCX07CgloZWxwZXJzLmdldFN0eWxlID0gZnVuY3Rpb24oZWwsIHByb3BlcnR5KSB7CgkJcmV0dXJuIGVsLmN1cnJlbnRTdHlsZSA/CgkJCWVsLmN1cnJlbnRTdHlsZVtwcm9wZXJ0eV0gOgoJCQlkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsLCBudWxsKS5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5KTsKCX07CgloZWxwZXJzLnJldGluYVNjYWxlID0gZnVuY3Rpb24oY2hhcnQsIGZvcmNlUmF0aW8pIHsKCQl2YXIgcGl4ZWxSYXRpbyA9IGNoYXJ0LmN1cnJlbnREZXZpY2VQaXhlbFJhdGlvID0gZm9yY2VSYXRpbyB8fCB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxOwoJCWlmIChwaXhlbFJhdGlvID09PSAxKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBjYW52YXMgPSBjaGFydC5jYW52YXM7CgkJdmFyIGhlaWdodCA9IGNoYXJ0LmhlaWdodDsKCQl2YXIgd2lkdGggPSBjaGFydC53aWR0aDsKCgkJY2FudmFzLmhlaWdodCA9IGhlaWdodCAqIHBpeGVsUmF0aW87CgkJY2FudmFzLndpZHRoID0gd2lkdGggKiBwaXhlbFJhdGlvOwoJCWNoYXJ0LmN0eC5zY2FsZShwaXhlbFJhdGlvLCBwaXhlbFJhdGlvKTsKCgkJLy8gSWYgbm8gc3R5bGUgaGFzIGJlZW4gc2V0IG9uIHRoZSBjYW52YXMsIHRoZSByZW5kZXIgc2l6ZSBpcyB1c2VkIGFzIGRpc3BsYXkgc2l6ZSwKCQkvLyBtYWtpbmcgdGhlIGNoYXJ0IHZpc3VhbGx5IGJpZ2dlciwgc28gbGV0J3MgZW5mb3JjZSBpdCB0byB0aGUgImNvcnJlY3QiIHZhbHVlcy4KCQkvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzM1NzUKCQlpZiAoIWNhbnZhcy5zdHlsZS5oZWlnaHQgJiYgIWNhbnZhcy5zdHlsZS53aWR0aCkgewoJCQljYW52YXMuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKCQkJY2FudmFzLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwoJCX0KCX07CgkvLyAtLSBDYW52YXMgbWV0aG9kcwoJaGVscGVycy5mb250U3RyaW5nID0gZnVuY3Rpb24ocGl4ZWxTaXplLCBmb250U3R5bGUsIGZvbnRGYW1pbHkpIHsKCQlyZXR1cm4gZm9udFN0eWxlICsgJyAnICsgcGl4ZWxTaXplICsgJ3B4ICcgKyBmb250RmFtaWx5OwoJfTsKCWhlbHBlcnMubG9uZ2VzdFRleHQgPSBmdW5jdGlvbihjdHgsIGZvbnQsIGFycmF5T2ZUaGluZ3MsIGNhY2hlKSB7CgkJY2FjaGUgPSBjYWNoZSB8fCB7fTsKCQl2YXIgZGF0YSA9IGNhY2hlLmRhdGEgPSBjYWNoZS5kYXRhIHx8IHt9OwoJCXZhciBnYyA9IGNhY2hlLmdhcmJhZ2VDb2xsZWN0ID0gY2FjaGUuZ2FyYmFnZUNvbGxlY3QgfHwgW107CgoJCWlmIChjYWNoZS5mb250ICE9PSBmb250KSB7CgkJCWRhdGEgPSBjYWNoZS5kYXRhID0ge307CgkJCWdjID0gY2FjaGUuZ2FyYmFnZUNvbGxlY3QgPSBbXTsKCQkJY2FjaGUuZm9udCA9IGZvbnQ7CgkJfQoKCQljdHguZm9udCA9IGZvbnQ7CgkJdmFyIGxvbmdlc3QgPSAwOwoJCWhlbHBlcnMuZWFjaChhcnJheU9mVGhpbmdzLCBmdW5jdGlvbih0aGluZykgewoJCQkvLyBVbmRlZmluZWQgc3RyaW5ncyBhbmQgYXJyYXlzIHNob3VsZCBub3QgYmUgbWVhc3VyZWQKCQkJaWYgKHRoaW5nICE9PSB1bmRlZmluZWQgJiYgdGhpbmcgIT09IG51bGwgJiYgaGVscGVycy5pc0FycmF5KHRoaW5nKSAhPT0gdHJ1ZSkgewoJCQkJbG9uZ2VzdCA9IGhlbHBlcnMubWVhc3VyZVRleHQoY3R4LCBkYXRhLCBnYywgbG9uZ2VzdCwgdGhpbmcpOwoJCQl9IGVsc2UgaWYgKGhlbHBlcnMuaXNBcnJheSh0aGluZykpIHsKCQkJCS8vIGlmIGl0IGlzIGFuIGFycmF5IGxldHMgbWVhc3VyZSBlYWNoIGVsZW1lbnQKCQkJCS8vIHRvIGRvIG1heWJlIHNpbXBsaWZ5IHRoaXMgZnVuY3Rpb24gYSBiaXQgc28gd2UgY2FuIGRvIHRoaXMgbW9yZSByZWN1cnNpdmVseT8KCQkJCWhlbHBlcnMuZWFjaCh0aGluZywgZnVuY3Rpb24obmVzdGVkVGhpbmcpIHsKCQkJCQkvLyBVbmRlZmluZWQgc3RyaW5ncyBhbmQgYXJyYXlzIHNob3VsZCBub3QgYmUgbWVhc3VyZWQKCQkJCQlpZiAobmVzdGVkVGhpbmcgIT09IHVuZGVmaW5lZCAmJiBuZXN0ZWRUaGluZyAhPT0gbnVsbCAmJiAhaGVscGVycy5pc0FycmF5KG5lc3RlZFRoaW5nKSkgewoJCQkJCQlsb25nZXN0ID0gaGVscGVycy5tZWFzdXJlVGV4dChjdHgsIGRhdGEsIGdjLCBsb25nZXN0LCBuZXN0ZWRUaGluZyk7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCQl9KTsKCgkJdmFyIGdjTGVuID0gZ2MubGVuZ3RoIC8gMjsKCQlpZiAoZ2NMZW4gPiBhcnJheU9mVGhpbmdzLmxlbmd0aCkgewoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGdjTGVuOyBpKyspIHsKCQkJCWRlbGV0ZSBkYXRhW2djW2ldXTsKCQkJfQoJCQlnYy5zcGxpY2UoMCwgZ2NMZW4pOwoJCX0KCQlyZXR1cm4gbG9uZ2VzdDsKCX07CgloZWxwZXJzLm1lYXN1cmVUZXh0ID0gZnVuY3Rpb24oY3R4LCBkYXRhLCBnYywgbG9uZ2VzdCwgc3RyaW5nKSB7CgkJdmFyIHRleHRXaWR0aCA9IGRhdGFbc3RyaW5nXTsKCQlpZiAoIXRleHRXaWR0aCkgewoJCQl0ZXh0V2lkdGggPSBkYXRhW3N0cmluZ10gPSBjdHgubWVhc3VyZVRleHQoc3RyaW5nKS53aWR0aDsKCQkJZ2MucHVzaChzdHJpbmcpOwoJCX0KCQlpZiAodGV4dFdpZHRoID4gbG9uZ2VzdCkgewoJCQlsb25nZXN0ID0gdGV4dFdpZHRoOwoJCX0KCQlyZXR1cm4gbG9uZ2VzdDsKCX07CgloZWxwZXJzLm51bWJlck9mTGFiZWxMaW5lcyA9IGZ1bmN0aW9uKGFycmF5T2ZUaGluZ3MpIHsKCQl2YXIgbnVtYmVyT2ZMaW5lcyA9IDE7CgkJaGVscGVycy5lYWNoKGFycmF5T2ZUaGluZ3MsIGZ1bmN0aW9uKHRoaW5nKSB7CgkJCWlmIChoZWxwZXJzLmlzQXJyYXkodGhpbmcpKSB7CgkJCQlpZiAodGhpbmcubGVuZ3RoID4gbnVtYmVyT2ZMaW5lcykgewoJCQkJCW51bWJlck9mTGluZXMgPSB0aGluZy5sZW5ndGg7CgkJCQl9CgkJCX0KCQl9KTsKCQlyZXR1cm4gbnVtYmVyT2ZMaW5lczsKCX07CgoJaGVscGVycy5jb2xvciA9ICFjb2xvciA/CgkJZnVuY3Rpb24odmFsdWUpIHsKCQkJY29uc29sZS5lcnJvcignQ29sb3IuanMgbm90IGZvdW5kIScpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSA6CgkJZnVuY3Rpb24odmFsdWUpIHsKCQkJLyogZ2xvYmFsIENhbnZhc0dyYWRpZW50ICovCgkJCWlmICh2YWx1ZSBpbnN0YW5jZW9mIENhbnZhc0dyYWRpZW50KSB7CgkJCQl2YWx1ZSA9IGRlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Q29sb3I7CgkJCX0KCgkJCXJldHVybiBjb2xvcih2YWx1ZSk7CgkJfTsKCgloZWxwZXJzLmdldEhvdmVyQ29sb3IgPSBmdW5jdGlvbihjb2xvclZhbHVlKSB7CgkJLyogZ2xvYmFsIENhbnZhc1BhdHRlcm4gKi8KCQlyZXR1cm4gKGNvbG9yVmFsdWUgaW5zdGFuY2VvZiBDYW52YXNQYXR0ZXJuKSA/CgkJCWNvbG9yVmFsdWUgOgoJCQloZWxwZXJzLmNvbG9yKGNvbG9yVmFsdWUpLnNhdHVyYXRlKDAuNSkuZGFya2VuKDAuMSkucmdiU3RyaW5nKCk7Cgl9Owp9OwoKfSx7IjIiOjIsIjI1IjoyNSwiNDUiOjQ1fV0sMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKLyoqCiAqIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgcmVsYXRpdmUgcG9zaXRpb24gZm9yIGFuIGV2ZW50CiAqIEBwYXJhbSB7RXZlbnR8SUV2ZW50fSBldmVudCAtIFRoZSBldmVudCB0byBnZXQgdGhlIHBvc2l0aW9uIGZvcgogKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIFRoZSBjaGFydAogKiBAcmV0dXJucyB7UG9pbnR9IHRoZSBldmVudCBwb3NpdGlvbgogKi8KZnVuY3Rpb24gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCkgewoJaWYgKGUubmF0aXZlKSB7CgkJcmV0dXJuIHsKCQkJeDogZS54LAoJCQl5OiBlLnkKCQl9OwoJfQoKCXJldHVybiBoZWxwZXJzLmdldFJlbGF0aXZlUG9zaXRpb24oZSwgY2hhcnQpOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRvIHRyYXZlcnNlIGFsbCBvZiB0aGUgdmlzaWJsZSBlbGVtZW50cyBpbiB0aGUgY2hhcnQKICogQHBhcmFtIGNoYXJ0IHtjaGFydH0gdGhlIGNoYXJ0CiAqIEBwYXJhbSBoYW5kbGVyIHtGdW5jdGlvbn0gdGhlIGNhbGxiYWNrIHRvIGV4ZWN1dGUgZm9yIGVhY2ggdmlzaWJsZSBpdGVtCiAqLwpmdW5jdGlvbiBwYXJzZVZpc2libGVJdGVtcyhjaGFydCwgaGFuZGxlcikgewoJdmFyIGRhdGFzZXRzID0gY2hhcnQuZGF0YS5kYXRhc2V0czsKCXZhciBtZXRhLCBpLCBqLCBpbGVuLCBqbGVuOwoKCWZvciAoaSA9IDAsIGlsZW4gPSBkYXRhc2V0cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQlpZiAoIWNoYXJ0LmlzRGF0YXNldFZpc2libGUoaSkpIHsKCQkJY29udGludWU7CgkJfQoKCQltZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaSk7CgkJZm9yIChqID0gMCwgamxlbiA9IG1ldGEuZGF0YS5sZW5ndGg7IGogPCBqbGVuOyArK2opIHsKCQkJdmFyIGVsZW1lbnQgPSBtZXRhLmRhdGFbal07CgkJCWlmICghZWxlbWVudC5fdmlldy5za2lwKSB7CgkJCQloYW5kbGVyKGVsZW1lbnQpOwoJCQl9CgkJfQoJfQp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRvIGdldCB0aGUgaXRlbXMgdGhhdCBpbnRlcnNlY3QgdGhlIGV2ZW50IHBvc2l0aW9uCiAqIEBwYXJhbSBpdGVtcyB7Q2hhcnRFbGVtZW50W119IGVsZW1lbnRzIHRvIGZpbHRlcgogKiBAcGFyYW0gcG9zaXRpb24ge1BvaW50fSB0aGUgcG9pbnQgdG8gYmUgbmVhcmVzdCB0bwogKiBAcmV0dXJuIHtDaGFydEVsZW1lbnRbXX0gdGhlIG5lYXJlc3QgaXRlbXMKICovCmZ1bmN0aW9uIGdldEludGVyc2VjdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbikgewoJdmFyIGVsZW1lbnRzID0gW107CgoJcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQlpZiAoZWxlbWVudC5pblJhbmdlKHBvc2l0aW9uLngsIHBvc2l0aW9uLnkpKSB7CgkJCWVsZW1lbnRzLnB1c2goZWxlbWVudCk7CgkJfQoJfSk7CgoJcmV0dXJuIGVsZW1lbnRzOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRvIGdldCB0aGUgaXRlbXMgbmVhcmVzdCB0byB0aGUgZXZlbnQgcG9zaXRpb24gY29uc2lkZXJpbmcgYWxsIHZpc2libGUgaXRlbXMgaW4gdGVoIGNoYXJ0CiAqIEBwYXJhbSBjaGFydCB7Q2hhcnR9IHRoZSBjaGFydCB0byBsb29rIGF0IGVsZW1lbnRzIGZyb20KICogQHBhcmFtIHBvc2l0aW9uIHtQb2ludH0gdGhlIHBvaW50IHRvIGJlIG5lYXJlc3QgdG8KICogQHBhcmFtIGludGVyc2VjdCB7Qm9vbGVhbn0gaWYgdHJ1ZSwgb25seSBjb25zaWRlciBpdGVtcyB0aGF0IGludGVyc2VjdCB0aGUgcG9zaXRpb24KICogQHBhcmFtIGRpc3RhbmNlTWV0cmljIHtGdW5jdGlvbn0gZnVuY3Rpb24gdG8gcHJvdmlkZSB0aGUgZGlzdGFuY2UgYmV0d2VlbiBwb2ludHMKICogQHJldHVybiB7Q2hhcnRFbGVtZW50W119IHRoZSBuZWFyZXN0IGl0ZW1zCiAqLwpmdW5jdGlvbiBnZXROZWFyZXN0SXRlbXMoY2hhcnQsIHBvc2l0aW9uLCBpbnRlcnNlY3QsIGRpc3RhbmNlTWV0cmljKSB7Cgl2YXIgbWluRGlzdGFuY2UgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7Cgl2YXIgbmVhcmVzdEl0ZW1zID0gW107CgoJcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQlpZiAoaW50ZXJzZWN0ICYmICFlbGVtZW50LmluUmFuZ2UocG9zaXRpb24ueCwgcG9zaXRpb24ueSkpIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGNlbnRlciA9IGVsZW1lbnQuZ2V0Q2VudGVyUG9pbnQoKTsKCQl2YXIgZGlzdGFuY2UgPSBkaXN0YW5jZU1ldHJpYyhwb3NpdGlvbiwgY2VudGVyKTsKCgkJaWYgKGRpc3RhbmNlIDwgbWluRGlzdGFuY2UpIHsKCQkJbmVhcmVzdEl0ZW1zID0gW2VsZW1lbnRdOwoJCQltaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwoJCX0gZWxzZSBpZiAoZGlzdGFuY2UgPT09IG1pbkRpc3RhbmNlKSB7CgkJCS8vIENhbiBoYXZlIG11bHRpcGxlIGl0ZW1zIGF0IHRoZSBzYW1lIGRpc3RhbmNlIGluIHdoaWNoIGNhc2Ugd2Ugc29ydCBieSBzaXplCgkJCW5lYXJlc3RJdGVtcy5wdXNoKGVsZW1lbnQpOwoJCX0KCX0pOwoKCXJldHVybiBuZWFyZXN0SXRlbXM7Cn0KCi8qKgogKiBHZXQgYSBkaXN0YW5jZSBtZXRyaWMgZnVuY3Rpb24gZm9yIHR3byBwb2ludHMgYmFzZWQgb24gdGhlCiAqIGF4aXMgbW9kZSBzZXR0aW5nCiAqIEBwYXJhbSB7U3RyaW5nfSBheGlzIHRoZSBheGlzIG1vZGUuIHh8eXx4eQogKi8KZnVuY3Rpb24gZ2V0RGlzdGFuY2VNZXRyaWNGb3JBeGlzKGF4aXMpIHsKCXZhciB1c2VYID0gYXhpcy5pbmRleE9mKCd4JykgIT09IC0xOwoJdmFyIHVzZVkgPSBheGlzLmluZGV4T2YoJ3knKSAhPT0gLTE7CgoJcmV0dXJuIGZ1bmN0aW9uKHB0MSwgcHQyKSB7CgkJdmFyIGRlbHRhWCA9IHVzZVggPyBNYXRoLmFicyhwdDEueCAtIHB0Mi54KSA6IDA7CgkJdmFyIGRlbHRhWSA9IHVzZVkgPyBNYXRoLmFicyhwdDEueSAtIHB0Mi55KSA6IDA7CgkJcmV0dXJuIE1hdGguc3FydChNYXRoLnBvdyhkZWx0YVgsIDIpICsgTWF0aC5wb3coZGVsdGFZLCAyKSk7Cgl9Owp9CgpmdW5jdGlvbiBpbmRleE1vZGUoY2hhcnQsIGUsIG9wdGlvbnMpIHsKCXZhciBwb3NpdGlvbiA9IGdldFJlbGF0aXZlUG9zaXRpb24oZSwgY2hhcnQpOwoJLy8gRGVmYXVsdCBheGlzIGZvciBpbmRleCBtb2RlIGlzICd4JyB0byBtYXRjaCBvbGQgYmVoYXZpb3VyCglvcHRpb25zLmF4aXMgPSBvcHRpb25zLmF4aXMgfHwgJ3gnOwoJdmFyIGRpc3RhbmNlTWV0cmljID0gZ2V0RGlzdGFuY2VNZXRyaWNGb3JBeGlzKG9wdGlvbnMuYXhpcyk7Cgl2YXIgaXRlbXMgPSBvcHRpb25zLmludGVyc2VjdCA/IGdldEludGVyc2VjdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbikgOiBnZXROZWFyZXN0SXRlbXMoY2hhcnQsIHBvc2l0aW9uLCBmYWxzZSwgZGlzdGFuY2VNZXRyaWMpOwoJdmFyIGVsZW1lbnRzID0gW107CgoJaWYgKCFpdGVtcy5sZW5ndGgpIHsKCQlyZXR1cm4gW107Cgl9CgoJY2hhcnQuZGF0YS5kYXRhc2V0cy5mb3JFYWNoKGZ1bmN0aW9uKGRhdGFzZXQsIGRhdGFzZXRJbmRleCkgewoJCWlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkpIHsKCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoJCQl2YXIgZWxlbWVudCA9IG1ldGEuZGF0YVtpdGVtc1swXS5faW5kZXhdOwoKCQkJLy8gZG9uJ3QgY291bnQgaXRlbXMgdGhhdCBhcmUgc2tpcHBlZCAobnVsbCBkYXRhKQoJCQlpZiAoZWxlbWVudCAmJiAhZWxlbWVudC5fdmlldy5za2lwKSB7CgkJCQllbGVtZW50cy5wdXNoKGVsZW1lbnQpOwoJCQl9CgkJfQoJfSk7CgoJcmV0dXJuIGVsZW1lbnRzOwp9CgovKioKICogQGludGVyZmFjZSBJSW50ZXJhY3Rpb25PcHRpb25zCiAqLwovKioKICogSWYgdHJ1ZSwgb25seSBjb25zaWRlciBpdGVtcyB0aGF0IGludGVyc2VjdCB0aGUgcG9pbnQKICogQG5hbWUgSUludGVyZmFjZU9wdGlvbnMjYm9vbGVhbgogKiBAdHlwZSBCb29sZWFuCiAqLwoKLyoqCiAqIENvbnRhaW5zIGludGVyYWN0aW9uIHJlbGF0ZWQgZnVuY3Rpb25zCiAqIEBuYW1lc3BhY2UgQ2hhcnQuSW50ZXJhY3Rpb24KICovCm1vZHVsZS5leHBvcnRzID0gewoJLy8gSGVscGVyIGZ1bmN0aW9uIGZvciBkaWZmZXJlbnQgbW9kZXMKCW1vZGVzOiB7CgkJc2luZ2xlOiBmdW5jdGlvbihjaGFydCwgZSkgewoJCQl2YXIgcG9zaXRpb24gPSBnZXRSZWxhdGl2ZVBvc2l0aW9uKGUsIGNoYXJ0KTsKCQkJdmFyIGVsZW1lbnRzID0gW107CgoJCQlwYXJzZVZpc2libGVJdGVtcyhjaGFydCwgZnVuY3Rpb24oZWxlbWVudCkgewoJCQkJaWYgKGVsZW1lbnQuaW5SYW5nZShwb3NpdGlvbi54LCBwb3NpdGlvbi55KSkgewoJCQkJCWVsZW1lbnRzLnB1c2goZWxlbWVudCk7CgkJCQkJcmV0dXJuIGVsZW1lbnRzOwoJCQkJfQoJCQl9KTsKCgkJCXJldHVybiBlbGVtZW50cy5zbGljZSgwLCAxKTsKCQl9LAoKCQkvKioKCQkgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMubGFiZWwKCQkgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNC4wCgkJICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMwoJCSAqIEBwcml2YXRlCgkJICovCgkJbGFiZWw6IGluZGV4TW9kZSwKCgkJLyoqCgkJICogUmV0dXJucyBpdGVtcyBhdCB0aGUgc2FtZSBpbmRleC4gSWYgdGhlIG9wdGlvbnMuaW50ZXJzZWN0IHBhcmFtZXRlciBpcyB0cnVlLCB3ZSBvbmx5IHJldHVybiBpdGVtcyBpZiB3ZSBpbnRlcnNlY3Qgc29tZXRoaW5nCgkJICogSWYgdGhlIG9wdGlvbnMuaW50ZXJzZWN0IG1vZGUgaXMgZmFsc2UsIHdlIGZpbmQgdGhlIG5lYXJlc3QgaXRlbSBhbmQgcmV0dXJuIHRoZSBpdGVtcyBhdCB0aGUgc2FtZSBpbmRleCBhcyB0aGF0IGl0ZW0KCQkgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMuaW5kZXgKCQkgKiBAc2luY2UgdjIuNC4wCgkJICogQHBhcmFtIGNoYXJ0IHtjaGFydH0gdGhlIGNoYXJ0IHdlIGFyZSByZXR1cm5pbmcgaXRlbXMgZnJvbQoJCSAqIEBwYXJhbSBlIHtFdmVudH0gdGhlIGV2ZW50IHdlIGFyZSBmaW5kIHRoaW5ncyBhdAoJCSAqIEBwYXJhbSBvcHRpb25zIHtJSW50ZXJhY3Rpb25PcHRpb25zfSBvcHRpb25zIHRvIHVzZSBkdXJpbmcgaW50ZXJhY3Rpb24KCQkgKiBAcmV0dXJuIHtDaGFydC5FbGVtZW50W119IEFycmF5IG9mIGVsZW1lbnRzIHRoYXQgYXJlIHVuZGVyIHRoZSBwb2ludC4gSWYgbm9uZSBhcmUgZm91bmQsIGFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkCgkJICovCgkJaW5kZXg6IGluZGV4TW9kZSwKCgkJLyoqCgkJICogUmV0dXJucyBpdGVtcyBpbiB0aGUgc2FtZSBkYXRhc2V0LiBJZiB0aGUgb3B0aW9ucy5pbnRlcnNlY3QgcGFyYW1ldGVyIGlzIHRydWUsIHdlIG9ubHkgcmV0dXJuIGl0ZW1zIGlmIHdlIGludGVyc2VjdCBzb21ldGhpbmcKCQkgKiBJZiB0aGUgb3B0aW9ucy5pbnRlcnNlY3QgaXMgZmFsc2UsIHdlIGZpbmQgdGhlIG5lYXJlc3QgaXRlbSBhbmQgcmV0dXJuIHRoZSBpdGVtcyBpbiB0aGF0IGRhdGFzZXQKCQkgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMuZGF0YXNldAoJCSAqIEBwYXJhbSBjaGFydCB7Y2hhcnR9IHRoZSBjaGFydCB3ZSBhcmUgcmV0dXJuaW5nIGl0ZW1zIGZyb20KCQkgKiBAcGFyYW0gZSB7RXZlbnR9IHRoZSBldmVudCB3ZSBhcmUgZmluZCB0aGluZ3MgYXQKCQkgKiBAcGFyYW0gb3B0aW9ucyB7SUludGVyYWN0aW9uT3B0aW9uc30gb3B0aW9ucyB0byB1c2UgZHVyaW5nIGludGVyYWN0aW9uCgkJICogQHJldHVybiB7Q2hhcnQuRWxlbWVudFtdfSBBcnJheSBvZiBlbGVtZW50cyB0aGF0IGFyZSB1bmRlciB0aGUgcG9pbnQuIElmIG5vbmUgYXJlIGZvdW5kLCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZAoJCSAqLwoJCWRhdGFzZXQ6IGZ1bmN0aW9uKGNoYXJ0LCBlLCBvcHRpb25zKSB7CgkJCXZhciBwb3NpdGlvbiA9IGdldFJlbGF0aXZlUG9zaXRpb24oZSwgY2hhcnQpOwoJCQlvcHRpb25zLmF4aXMgPSBvcHRpb25zLmF4aXMgfHwgJ3h5JzsKCQkJdmFyIGRpc3RhbmNlTWV0cmljID0gZ2V0RGlzdGFuY2VNZXRyaWNGb3JBeGlzKG9wdGlvbnMuYXhpcyk7CgkJCXZhciBpdGVtcyA9IG9wdGlvbnMuaW50ZXJzZWN0ID8gZ2V0SW50ZXJzZWN0SXRlbXMoY2hhcnQsIHBvc2l0aW9uKSA6IGdldE5lYXJlc3RJdGVtcyhjaGFydCwgcG9zaXRpb24sIGZhbHNlLCBkaXN0YW5jZU1ldHJpYyk7CgoJCQlpZiAoaXRlbXMubGVuZ3RoID4gMCkgewoJCQkJaXRlbXMgPSBjaGFydC5nZXREYXRhc2V0TWV0YShpdGVtc1swXS5fZGF0YXNldEluZGV4KS5kYXRhOwoJCQl9CgoJCQlyZXR1cm4gaXRlbXM7CgkJfSwKCgkJLyoqCgkJICogQGZ1bmN0aW9uIENoYXJ0LkludGVyYWN0aW9uLm1vZGVzLngtYXhpcwoJCSAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi40LjAuIFVzZSBpbmRleCBtb2RlIGFuZCBpbnRlcnNlY3QgPT0gdHJ1ZQoJCSAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCSd4LWF4aXMnOiBmdW5jdGlvbihjaGFydCwgZSkgewoJCQlyZXR1cm4gaW5kZXhNb2RlKGNoYXJ0LCBlLCB7aW50ZXJzZWN0OiBmYWxzZX0pOwoJCX0sCgoJCS8qKgoJCSAqIFBvaW50IG1vZGUgcmV0dXJucyBhbGwgZWxlbWVudHMgdGhhdCBoaXQgdGVzdCBiYXNlZCBvbiB0aGUgZXZlbnQgcG9zaXRpb24KCQkgKiBvZiB0aGUgZXZlbnQKCQkgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMuaW50ZXJzZWN0CgkJICogQHBhcmFtIGNoYXJ0IHtjaGFydH0gdGhlIGNoYXJ0IHdlIGFyZSByZXR1cm5pbmcgaXRlbXMgZnJvbQoJCSAqIEBwYXJhbSBlIHtFdmVudH0gdGhlIGV2ZW50IHdlIGFyZSBmaW5kIHRoaW5ncyBhdAoJCSAqIEByZXR1cm4ge0NoYXJ0LkVsZW1lbnRbXX0gQXJyYXkgb2YgZWxlbWVudHMgdGhhdCBhcmUgdW5kZXIgdGhlIHBvaW50LiBJZiBub25lIGFyZSBmb3VuZCwgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQKCQkgKi8KCQlwb2ludDogZnVuY3Rpb24oY2hhcnQsIGUpIHsKCQkJdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CgkJCXJldHVybiBnZXRJbnRlcnNlY3RJdGVtcyhjaGFydCwgcG9zaXRpb24pOwoJCX0sCgoJCS8qKgoJCSAqIG5lYXJlc3QgbW9kZSByZXR1cm5zIHRoZSBlbGVtZW50IGNsb3Nlc3QgdG8gdGhlIHBvaW50CgkJICogQGZ1bmN0aW9uIENoYXJ0LkludGVyYWN0aW9uLm1vZGVzLmludGVyc2VjdAoJCSAqIEBwYXJhbSBjaGFydCB7Y2hhcnR9IHRoZSBjaGFydCB3ZSBhcmUgcmV0dXJuaW5nIGl0ZW1zIGZyb20KCQkgKiBAcGFyYW0gZSB7RXZlbnR9IHRoZSBldmVudCB3ZSBhcmUgZmluZCB0aGluZ3MgYXQKCQkgKiBAcGFyYW0gb3B0aW9ucyB7SUludGVyYWN0aW9uT3B0aW9uc30gb3B0aW9ucyB0byB1c2UKCQkgKiBAcmV0dXJuIHtDaGFydC5FbGVtZW50W119IEFycmF5IG9mIGVsZW1lbnRzIHRoYXQgYXJlIHVuZGVyIHRoZSBwb2ludC4gSWYgbm9uZSBhcmUgZm91bmQsIGFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkCgkJICovCgkJbmVhcmVzdDogZnVuY3Rpb24oY2hhcnQsIGUsIG9wdGlvbnMpIHsKCQkJdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CgkJCW9wdGlvbnMuYXhpcyA9IG9wdGlvbnMuYXhpcyB8fCAneHknOwoJCQl2YXIgZGlzdGFuY2VNZXRyaWMgPSBnZXREaXN0YW5jZU1ldHJpY0ZvckF4aXMob3B0aW9ucy5heGlzKTsKCQkJdmFyIG5lYXJlc3RJdGVtcyA9IGdldE5lYXJlc3RJdGVtcyhjaGFydCwgcG9zaXRpb24sIG9wdGlvbnMuaW50ZXJzZWN0LCBkaXN0YW5jZU1ldHJpYyk7CgoJCQkvLyBXZSBoYXZlIG11bHRpcGxlIGl0ZW1zIGF0IHRoZSBzYW1lIGRpc3RhbmNlIGZyb20gdGhlIGV2ZW50LiBOb3cgc29ydCBieSBzbWFsbGVzdAoJCQlpZiAobmVhcmVzdEl0ZW1zLmxlbmd0aCA+IDEpIHsKCQkJCW5lYXJlc3RJdGVtcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKCQkJCQl2YXIgc2l6ZUEgPSBhLmdldEFyZWEoKTsKCQkJCQl2YXIgc2l6ZUIgPSBiLmdldEFyZWEoKTsKCQkJCQl2YXIgcmV0ID0gc2l6ZUEgLSBzaXplQjsKCgkJCQkJaWYgKHJldCA9PT0gMCkgewoJCQkJCQkvLyBpZiBlcXVhbCBzb3J0IGJ5IGRhdGFzZXQgaW5kZXgKCQkJCQkJcmV0ID0gYS5fZGF0YXNldEluZGV4IC0gYi5fZGF0YXNldEluZGV4OwoJCQkJCX0KCgkJCQkJcmV0dXJuIHJldDsKCQkJCX0pOwoJCQl9CgoJCQkvLyBSZXR1cm4gb25seSAxIGl0ZW0KCQkJcmV0dXJuIG5lYXJlc3RJdGVtcy5zbGljZSgwLCAxKTsKCQl9LAoKCQkvKioKCQkgKiB4IG1vZGUgcmV0dXJucyB0aGUgZWxlbWVudHMgdGhhdCBoaXQtdGVzdCBhdCB0aGUgY3VycmVudCB4IGNvb3JkaW5hdGUKCQkgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMueAoJCSAqIEBwYXJhbSBjaGFydCB7Y2hhcnR9IHRoZSBjaGFydCB3ZSBhcmUgcmV0dXJuaW5nIGl0ZW1zIGZyb20KCQkgKiBAcGFyYW0gZSB7RXZlbnR9IHRoZSBldmVudCB3ZSBhcmUgZmluZCB0aGluZ3MgYXQKCQkgKiBAcGFyYW0gb3B0aW9ucyB7SUludGVyYWN0aW9uT3B0aW9uc30gb3B0aW9ucyB0byB1c2UKCQkgKiBAcmV0dXJuIHtDaGFydC5FbGVtZW50W119IEFycmF5IG9mIGVsZW1lbnRzIHRoYXQgYXJlIHVuZGVyIHRoZSBwb2ludC4gSWYgbm9uZSBhcmUgZm91bmQsIGFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkCgkJICovCgkJeDogZnVuY3Rpb24oY2hhcnQsIGUsIG9wdGlvbnMpIHsKCQkJdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CgkJCXZhciBpdGVtcyA9IFtdOwoJCQl2YXIgaW50ZXJzZWN0c0l0ZW0gPSBmYWxzZTsKCgkJCXBhcnNlVmlzaWJsZUl0ZW1zKGNoYXJ0LCBmdW5jdGlvbihlbGVtZW50KSB7CgkJCQlpZiAoZWxlbWVudC5pblhSYW5nZShwb3NpdGlvbi54KSkgewoJCQkJCWl0ZW1zLnB1c2goZWxlbWVudCk7CgkJCQl9CgoJCQkJaWYgKGVsZW1lbnQuaW5SYW5nZShwb3NpdGlvbi54LCBwb3NpdGlvbi55KSkgewoJCQkJCWludGVyc2VjdHNJdGVtID0gdHJ1ZTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBJZiB3ZSB3YW50IHRvIHRyaWdnZXIgb24gYW4gaW50ZXJzZWN0IGFuZCB3ZSBkb24ndCBoYXZlIGFueSBpdGVtcwoJCQkvLyB0aGF0IGludGVyc2VjdCB0aGUgcG9zaXRpb24sIHJldHVybiBub3RoaW5nCgkJCWlmIChvcHRpb25zLmludGVyc2VjdCAmJiAhaW50ZXJzZWN0c0l0ZW0pIHsKCQkJCWl0ZW1zID0gW107CgkJCX0KCQkJcmV0dXJuIGl0ZW1zOwoJCX0sCgoJCS8qKgoJCSAqIHkgbW9kZSByZXR1cm5zIHRoZSBlbGVtZW50cyB0aGF0IGhpdC10ZXN0IGF0IHRoZSBjdXJyZW50IHkgY29vcmRpbmF0ZQoJCSAqIEBmdW5jdGlvbiBDaGFydC5JbnRlcmFjdGlvbi5tb2Rlcy55CgkJICogQHBhcmFtIGNoYXJ0IHtjaGFydH0gdGhlIGNoYXJ0IHdlIGFyZSByZXR1cm5pbmcgaXRlbXMgZnJvbQoJCSAqIEBwYXJhbSBlIHtFdmVudH0gdGhlIGV2ZW50IHdlIGFyZSBmaW5kIHRoaW5ncyBhdAoJCSAqIEBwYXJhbSBvcHRpb25zIHtJSW50ZXJhY3Rpb25PcHRpb25zfSBvcHRpb25zIHRvIHVzZQoJCSAqIEByZXR1cm4ge0NoYXJ0LkVsZW1lbnRbXX0gQXJyYXkgb2YgZWxlbWVudHMgdGhhdCBhcmUgdW5kZXIgdGhlIHBvaW50LiBJZiBub25lIGFyZSBmb3VuZCwgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQKCQkgKi8KCQl5OiBmdW5jdGlvbihjaGFydCwgZSwgb3B0aW9ucykgewoJCQl2YXIgcG9zaXRpb24gPSBnZXRSZWxhdGl2ZVBvc2l0aW9uKGUsIGNoYXJ0KTsKCQkJdmFyIGl0ZW1zID0gW107CgkJCXZhciBpbnRlcnNlY3RzSXRlbSA9IGZhbHNlOwoKCQkJcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uKGVsZW1lbnQpIHsKCQkJCWlmIChlbGVtZW50LmluWVJhbmdlKHBvc2l0aW9uLnkpKSB7CgkJCQkJaXRlbXMucHVzaChlbGVtZW50KTsKCQkJCX0KCgkJCQlpZiAoZWxlbWVudC5pblJhbmdlKHBvc2l0aW9uLngsIHBvc2l0aW9uLnkpKSB7CgkJCQkJaW50ZXJzZWN0c0l0ZW0gPSB0cnVlOwoJCQkJfQoJCQl9KTsKCgkJCS8vIElmIHdlIHdhbnQgdG8gdHJpZ2dlciBvbiBhbiBpbnRlcnNlY3QgYW5kIHdlIGRvbid0IGhhdmUgYW55IGl0ZW1zCgkJCS8vIHRoYXQgaW50ZXJzZWN0IHRoZSBwb3NpdGlvbiwgcmV0dXJuIG5vdGhpbmcKCQkJaWYgKG9wdGlvbnMuaW50ZXJzZWN0ICYmICFpbnRlcnNlY3RzSXRlbSkgewoJCQkJaXRlbXMgPSBbXTsKCQkJfQoJCQlyZXR1cm4gaXRlbXM7CgkJfQoJfQp9OwoKfSx7IjQ1Ijo0NX1dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGRlZmF1bHRzID0gcmVxdWlyZSgyNSk7CgpkZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CglyZXNwb25zaXZlOiB0cnVlLAoJcmVzcG9uc2l2ZUFuaW1hdGlvbkR1cmF0aW9uOiAwLAoJbWFpbnRhaW5Bc3BlY3RSYXRpbzogdHJ1ZSwKCWV2ZW50czogWydtb3VzZW1vdmUnLCAnbW91c2VvdXQnLCAnY2xpY2snLCAndG91Y2hzdGFydCcsICd0b3VjaG1vdmUnXSwKCWhvdmVyOiB7CgkJb25Ib3ZlcjogbnVsbCwKCQltb2RlOiAnbmVhcmVzdCcsCgkJaW50ZXJzZWN0OiB0cnVlLAoJCWFuaW1hdGlvbkR1cmF0aW9uOiA0MDAKCX0sCglvbkNsaWNrOiBudWxsLAoJZGVmYXVsdENvbG9yOiAncmdiYSgwLDAsMCwwLjEpJywKCWRlZmF1bHRGb250Q29sb3I6ICcjNjY2JywKCWRlZmF1bHRGb250RmFtaWx5OiAiJ0hlbHZldGljYSBOZXVlJywgJ0hlbHZldGljYScsICdBcmlhbCcsIHNhbnMtc2VyaWYiLAoJZGVmYXVsdEZvbnRTaXplOiAxMiwKCWRlZmF1bHRGb250U3R5bGU6ICdub3JtYWwnLAoJc2hvd0xpbmVzOiB0cnVlLAoKCS8vIEVsZW1lbnQgZGVmYXVsdHMgZGVmaW5lZCBpbiBlbGVtZW50IGV4dGVuc2lvbnMKCWVsZW1lbnRzOiB7fSwKCgkvLyBMYXlvdXQgb3B0aW9ucyBzdWNoIGFzIHBhZGRpbmcKCWxheW91dDogewoJCXBhZGRpbmc6IHsKCQkJdG9wOiAwLAoJCQlyaWdodDogMCwKCQkJYm90dG9tOiAwLAoJCQlsZWZ0OiAwCgkJfQoJfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CgoJLy8gT2NjdXB5IHRoZSBnbG9iYWwgdmFyaWFibGUgb2YgQ2hhcnQsIGFuZCBjcmVhdGUgYSBzaW1wbGUgYmFzZSBjbGFzcwoJdmFyIENoYXJ0ID0gZnVuY3Rpb24oaXRlbSwgY29uZmlnKSB7CgkJdGhpcy5jb25zdHJ1Y3QoaXRlbSwgY29uZmlnKTsKCQlyZXR1cm4gdGhpczsKCX07CgoJQ2hhcnQuQ2hhcnQgPSBDaGFydDsKCglyZXR1cm4gQ2hhcnQ7Cn07Cgp9LHsiMjUiOjI1fV0sMzA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKZnVuY3Rpb24gZmlsdGVyQnlQb3NpdGlvbihhcnJheSwgcG9zaXRpb24pIHsKCXJldHVybiBoZWxwZXJzLndoZXJlKGFycmF5LCBmdW5jdGlvbih2KSB7CgkJcmV0dXJuIHYucG9zaXRpb24gPT09IHBvc2l0aW9uOwoJfSk7Cn0KCmZ1bmN0aW9uIHNvcnRCeVdlaWdodChhcnJheSwgcmV2ZXJzZSkgewoJYXJyYXkuZm9yRWFjaChmdW5jdGlvbih2LCBpKSB7CgkJdi5fdG1wSW5kZXhfID0gaTsKCQlyZXR1cm4gdjsKCX0pOwoJYXJyYXkuc29ydChmdW5jdGlvbihhLCBiKSB7CgkJdmFyIHYwID0gcmV2ZXJzZSA/IGIgOiBhOwoJCXZhciB2MSA9IHJldmVyc2UgPyBhIDogYjsKCQlyZXR1cm4gdjAud2VpZ2h0ID09PSB2MS53ZWlnaHQgPwoJCQl2MC5fdG1wSW5kZXhfIC0gdjEuX3RtcEluZGV4XyA6CgkJCXYwLndlaWdodCAtIHYxLndlaWdodDsKCX0pOwoJYXJyYXkuZm9yRWFjaChmdW5jdGlvbih2KSB7CgkJZGVsZXRlIHYuX3RtcEluZGV4XzsKCX0pOwp9CgovKioKICogQGludGVyZmFjZSBJTGF5b3V0SXRlbQogKiBAcHJvcCB7U3RyaW5nfSBwb3NpdGlvbiAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgaXRlbSBpbiB0aGUgY2hhcnQgbGF5b3V0LiBQb3NzaWJsZSB2YWx1ZXMgYXJlCiAqICdsZWZ0JywgJ3RvcCcsICdyaWdodCcsICdib3R0b20nLCBhbmQgJ2NoYXJ0QXJlYScKICogQHByb3Age051bWJlcn0gd2VpZ2h0IC0gVGhlIHdlaWdodCB1c2VkIHRvIHNvcnQgdGhlIGl0ZW0uIEhpZ2hlciB3ZWlnaHRzIGFyZSBmdXJ0aGVyIGF3YXkgZnJvbSB0aGUgY2hhcnQgYXJlYQogKiBAcHJvcCB7Qm9vbGVhbn0gZnVsbFdpZHRoIC0gaWYgdHJ1ZSwgYW5kIHRoZSBpdGVtIGlzIGhvcml6b250YWwsIHRoZW4gcHVzaCB2ZXJ0aWNhbCBib3hlcyBkb3duCiAqIEBwcm9wIHtGdW5jdGlvbn0gaXNIb3Jpem9udGFsIC0gcmV0dXJucyB0cnVlIGlmIHRoZSBsYXlvdXQgaXRlbSBpcyBob3Jpem9udGFsIChpZS4gdG9wIG9yIGJvdHRvbSkKICogQHByb3Age0Z1bmN0aW9ufSB1cGRhdGUgLSBUYWtlcyB0d28gcGFyYW1ldGVyczogd2lkdGggYW5kIGhlaWdodC4gUmV0dXJucyBzaXplIG9mIGl0ZW0KICogQHByb3Age0Z1bmN0aW9ufSBnZXRQYWRkaW5nIC0gIFJldHVybnMgYW4gb2JqZWN0IHdpdGggcGFkZGluZyBvbiB0aGUgZWRnZXMKICogQHByb3Age051bWJlcn0gd2lkdGggLSBXaWR0aCBvZiBpdGVtLiBNdXN0IGJlIHZhbGlkIGFmdGVyIHVwZGF0ZSgpCiAqIEBwcm9wIHtOdW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiBpdGVtLiBNdXN0IGJlIHZhbGlkIGFmdGVyIHVwZGF0ZSgpCiAqIEBwcm9wIHtOdW1iZXJ9IGxlZnQgLSBMZWZ0IGVkZ2Ugb2YgdGhlIGl0ZW0uIFNldCBieSBsYXlvdXQgc3lzdGVtIGFuZCBjYW5ub3QgYmUgdXNlZCBpbiB1cGRhdGUKICogQHByb3Age051bWJlcn0gdG9wIC0gVG9wIGVkZ2Ugb2YgdGhlIGl0ZW0uIFNldCBieSBsYXlvdXQgc3lzdGVtIGFuZCBjYW5ub3QgYmUgdXNlZCBpbiB1cGRhdGUKICogQHByb3Age051bWJlcn0gcmlnaHQgLSBSaWdodCBlZGdlIG9mIHRoZSBpdGVtLiBTZXQgYnkgbGF5b3V0IHN5c3RlbSBhbmQgY2Fubm90IGJlIHVzZWQgaW4gdXBkYXRlCiAqIEBwcm9wIHtOdW1iZXJ9IGJvdHRvbSAtIEJvdHRvbSBlZGdlIG9mIHRoZSBpdGVtLiBTZXQgYnkgbGF5b3V0IHN5c3RlbSBhbmQgY2Fubm90IGJlIHVzZWQgaW4gdXBkYXRlCiAqLwoKLy8gVGhlIGxheW91dCBzZXJ2aWNlIGlzIHZlcnkgc2VsZiBleHBsYW5hdG9yeS4gIEl0J3MgcmVzcG9uc2libGUgZm9yIHRoZSBsYXlvdXQgd2l0aGluIGEgY2hhcnQuCi8vIFNjYWxlcywgTGVnZW5kcyBhbmQgUGx1Z2lucyBhbGwgcmVseSBvbiB0aGUgbGF5b3V0IHNlcnZpY2UgYW5kIGNhbiBlYXNpbHkgcmVnaXN0ZXIgdG8gYmUgcGxhY2VkIGFueXdoZXJlIHRoZXkgbmVlZAovLyBJdCBpcyB0aGlzIHNlcnZpY2UncyByZXNwb25zaWJpbGl0eSBvZiBjYXJyeWluZyBvdXQgdGhhdCBsYXlvdXQuCm1vZHVsZS5leHBvcnRzID0gewoJZGVmYXVsdHM6IHt9LAoKCS8qKgoJICogUmVnaXN0ZXIgYSBib3ggdG8gYSBjaGFydC4KCSAqIEEgYm94IGlzIHNpbXBseSBhIHJlZmVyZW5jZSB0byBhbiBvYmplY3QgdGhhdCByZXF1aXJlcyBsYXlvdXQuIGVnLiBTY2FsZXMsIExlZ2VuZCwgVGl0bGUuCgkgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIHRoZSBjaGFydCB0byB1c2UKCSAqIEBwYXJhbSB7SUxheW91dEl0ZW19IGl0ZW0gLSB0aGUgaXRlbSB0byBhZGQgdG8gYmUgbGF5ZWQgb3V0CgkgKi8KCWFkZEJveDogZnVuY3Rpb24oY2hhcnQsIGl0ZW0pIHsKCQlpZiAoIWNoYXJ0LmJveGVzKSB7CgkJCWNoYXJ0LmJveGVzID0gW107CgkJfQoKCQkvLyBpbml0aWFsaXplIGl0ZW0gd2l0aCBkZWZhdWx0IHZhbHVlcwoJCWl0ZW0uZnVsbFdpZHRoID0gaXRlbS5mdWxsV2lkdGggfHwgZmFsc2U7CgkJaXRlbS5wb3NpdGlvbiA9IGl0ZW0ucG9zaXRpb24gfHwgJ3RvcCc7CgkJaXRlbS53ZWlnaHQgPSBpdGVtLndlaWdodCB8fCAwOwoKCQljaGFydC5ib3hlcy5wdXNoKGl0ZW0pOwoJfSwKCgkvKioKCSAqIFJlbW92ZSBhIGxheW91dEl0ZW0gZnJvbSBhIGNoYXJ0CgkgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIHRoZSBjaGFydCB0byByZW1vdmUgdGhlIGJveCBmcm9tCgkgKiBAcGFyYW0ge09iamVjdH0gbGF5b3V0SXRlbSAtIHRoZSBpdGVtIHRvIHJlbW92ZSBmcm9tIHRoZSBsYXlvdXQKCSAqLwoJcmVtb3ZlQm94OiBmdW5jdGlvbihjaGFydCwgbGF5b3V0SXRlbSkgewoJCXZhciBpbmRleCA9IGNoYXJ0LmJveGVzID8gY2hhcnQuYm94ZXMuaW5kZXhPZihsYXlvdXRJdGVtKSA6IC0xOwoJCWlmIChpbmRleCAhPT0gLTEpIHsKCQkJY2hhcnQuYm94ZXMuc3BsaWNlKGluZGV4LCAxKTsKCQl9Cgl9LAoKCS8qKgoJICogU2V0cyAob3IgdXBkYXRlcykgb3B0aW9ucyBvbiB0aGUgZ2l2ZW4gYGl0ZW1gLgoJICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSB0aGUgY2hhcnQgaW4gd2hpY2ggdGhlIGl0ZW0gbGl2ZXMgKG9yIHdpbGwgYmUgYWRkZWQgdG8pCgkgKiBAcGFyYW0ge09iamVjdH0gaXRlbSAtIHRoZSBpdGVtIHRvIGNvbmZpZ3VyZSB3aXRoIHRoZSBnaXZlbiBvcHRpb25zCgkgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIHRoZSBuZXcgaXRlbSBvcHRpb25zLgoJICovCgljb25maWd1cmU6IGZ1bmN0aW9uKGNoYXJ0LCBpdGVtLCBvcHRpb25zKSB7CgkJdmFyIHByb3BzID0gWydmdWxsV2lkdGgnLCAncG9zaXRpb24nLCAnd2VpZ2h0J107CgkJdmFyIGlsZW4gPSBwcm9wcy5sZW5ndGg7CgkJdmFyIGkgPSAwOwoJCXZhciBwcm9wOwoKCQlmb3IgKDsgaSA8IGlsZW47ICsraSkgewoJCQlwcm9wID0gcHJvcHNbaV07CgkJCWlmIChvcHRpb25zLmhhc093blByb3BlcnR5KHByb3ApKSB7CgkJCQlpdGVtW3Byb3BdID0gb3B0aW9uc1twcm9wXTsKCQkJfQoJCX0KCX0sCgoJLyoqCgkgKiBGaXRzIGJveGVzIG9mIHRoZSBnaXZlbiBjaGFydCBpbnRvIHRoZSBnaXZlbiBzaXplIGJ5IGhhdmluZyBlYWNoIGJveCBtZWFzdXJlIGl0c2VsZgoJICogdGhlbiBydW5uaW5nIGEgZml0dGluZyBhbGdvcml0aG0KCSAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gdGhlIGNoYXJ0CgkgKiBAcGFyYW0ge051bWJlcn0gd2lkdGggLSB0aGUgd2lkdGggdG8gZml0IGludG8KCSAqIEBwYXJhbSB7TnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IHRvIGZpdCBpbnRvCgkgKi8KCXVwZGF0ZTogZnVuY3Rpb24oY2hhcnQsIHdpZHRoLCBoZWlnaHQpIHsKCQlpZiAoIWNoYXJ0KSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBsYXlvdXRPcHRpb25zID0gY2hhcnQub3B0aW9ucy5sYXlvdXQgfHwge307CgkJdmFyIHBhZGRpbmcgPSBoZWxwZXJzLm9wdGlvbnMudG9QYWRkaW5nKGxheW91dE9wdGlvbnMucGFkZGluZyk7CgkJdmFyIGxlZnRQYWRkaW5nID0gcGFkZGluZy5sZWZ0OwoJCXZhciByaWdodFBhZGRpbmcgPSBwYWRkaW5nLnJpZ2h0OwoJCXZhciB0b3BQYWRkaW5nID0gcGFkZGluZy50b3A7CgkJdmFyIGJvdHRvbVBhZGRpbmcgPSBwYWRkaW5nLmJvdHRvbTsKCgkJdmFyIGxlZnRCb3hlcyA9IGZpbHRlckJ5UG9zaXRpb24oY2hhcnQuYm94ZXMsICdsZWZ0Jyk7CgkJdmFyIHJpZ2h0Qm94ZXMgPSBmaWx0ZXJCeVBvc2l0aW9uKGNoYXJ0LmJveGVzLCAncmlnaHQnKTsKCQl2YXIgdG9wQm94ZXMgPSBmaWx0ZXJCeVBvc2l0aW9uKGNoYXJ0LmJveGVzLCAndG9wJyk7CgkJdmFyIGJvdHRvbUJveGVzID0gZmlsdGVyQnlQb3NpdGlvbihjaGFydC5ib3hlcywgJ2JvdHRvbScpOwoJCXZhciBjaGFydEFyZWFCb3hlcyA9IGZpbHRlckJ5UG9zaXRpb24oY2hhcnQuYm94ZXMsICdjaGFydEFyZWEnKTsKCgkJLy8gU29ydCBib3hlcyBieSB3ZWlnaHQuIEEgaGlnaGVyIHdlaWdodCBpcyBmdXJ0aGVyIGF3YXkgZnJvbSB0aGUgY2hhcnQgYXJlYQoJCXNvcnRCeVdlaWdodChsZWZ0Qm94ZXMsIHRydWUpOwoJCXNvcnRCeVdlaWdodChyaWdodEJveGVzLCBmYWxzZSk7CgkJc29ydEJ5V2VpZ2h0KHRvcEJveGVzLCB0cnVlKTsKCQlzb3J0QnlXZWlnaHQoYm90dG9tQm94ZXMsIGZhbHNlKTsKCgkJLy8gRXNzZW50aWFsbHkgd2Ugbm93IGhhdmUgYW55IG51bWJlciBvZiBib3hlcyBvbiBlYWNoIG9mIHRoZSA0IHNpZGVzLgoJCS8vIE91ciBjYW52YXMgbG9va3MgbGlrZSB0aGUgZm9sbG93aW5nLgoJCS8vIFRoZSBhcmVhcyBMMSBhbmQgTDIgYXJlIHRoZSBsZWZ0IGF4ZXMuIFIxIGlzIHRoZSByaWdodCBheGlzLCBUMSBpcyB0aGUgdG9wIGF4aXMgYW5kCgkJLy8gQjEgaXMgdGhlIGJvdHRvbSBheGlzCgkJLy8gVGhlcmUgYXJlIGFsc28gNCBxdWFkcmFudC1saWtlIGxvY2F0aW9ucyAobGVmdCB0byByaWdodCBpbnN0ZWFkIG9mIGNsb2Nrd2lzZSkgcmVzZXJ2ZWQgZm9yIGNoYXJ0IG92ZXJsYXlzCgkJLy8gVGhlc2UgbG9jYXRpb25zIGFyZSBzaW5nbGUtYm94IGxvY2F0aW9ucyBvbmx5LCB3aGVuIHRyeWluZyB0byByZWdpc3RlciBhIGNoYXJ0QXJlYSBsb2NhdGlvbiB0aGF0IGlzIGFscmVhZHkgdGFrZW4sCgkJLy8gYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24uCgkJLy8KCQkvLyB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKCQkvLyB8ICAgICAgICAgICAgICAgICAgVDEgKEZ1bGwgV2lkdGgpICAgICAgICAgICAgICAgICAgIHwKCQkvLyB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKCQkvLyB8ICAgIHwgICAgfCAgICAgICAgICAgICAgICAgVDIgICAgICAgICAgICAgICAgICB8ICAgIHwKCQkvLyB8ICAgIHwtLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLXwKCQkvLyB8ICAgIHwgICAgfCBDMSB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBDMiB8ICAgIHwKCQkvLyB8ICAgIHwgICAgfC0tLS18ICAgICAgICAgICAgICAgICAgICAgICAgICAgfC0tLS18ICAgIHwKCQkvLyB8ICAgIHwgICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8ICAgIHwKCQkvLyB8IEwxIHwgTDIgfCAgICAgICAgICAgQ2hhcnRBcmVhIChDMCkgICAgICAgICAgICB8IFIxIHwKCQkvLyB8ICAgIHwgICAgfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB8ICAgIHwKCQkvLyB8ICAgIHwgICAgfC0tLS18ICAgICAgICAgICAgICAgICAgICAgICAgICAgfC0tLS18ICAgIHwKCQkvLyB8ICAgIHwgICAgfCBDMyB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBDNCB8ICAgIHwKCQkvLyB8ICAgIHwtLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLXwKCQkvLyB8ICAgIHwgICAgfCAgICAgICAgICAgICAgICAgQjEgICAgICAgICAgICAgICAgICB8ICAgIHwKCQkvLyB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKCQkvLyB8ICAgICAgICAgICAgICAgICAgQjIgKEZ1bGwgV2lkdGgpICAgICAgICAgICAgICAgICAgIHwKCQkvLyB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKCQkvLwoJCS8vIFdoYXQgd2UgZG8gdG8gZmluZCB0aGUgYmVzdCBzaXppbmcsIHdlIGRvIHRoZSBmb2xsb3dpbmcKCQkvLyAxLiBEZXRlcm1pbmUgdGhlIG1pbmltdW0gc2l6ZSBvZiB0aGUgY2hhcnQgYXJlYS4KCQkvLyAyLiBTcGxpdCB0aGUgcmVtYWluaW5nIHdpZHRoIGVxdWFsbHkgYmV0d2VlbiBlYWNoIHZlcnRpY2FsIGF4aXMKCQkvLyAzLiBTcGxpdCB0aGUgcmVtYWluaW5nIGhlaWdodCBlcXVhbGx5IGJldHdlZW4gZWFjaCBob3Jpem9udGFsIGF4aXMKCQkvLyA0LiBHaXZlIGVhY2ggbGF5b3V0IHRoZSBtYXhpbXVtIHNpemUgaXQgY2FuIGJlLiBUaGUgbGF5b3V0IHdpbGwgcmV0dXJuIGl0J3MgbWluaW11bSBzaXplCgkJLy8gNS4gQWRqdXN0IHRoZSBzaXplcyBvZiBlYWNoIGF4aXMgYmFzZWQgb24gaXQncyBtaW5pbXVtIHJlcG9ydGVkIHNpemUuCgkJLy8gNi4gUmVmaXQgZWFjaCBheGlzCgkJLy8gNy4gUG9zaXRpb24gZWFjaCBheGlzIGluIHRoZSBmaW5hbCBsb2NhdGlvbgoJCS8vIDguIFRlbGwgdGhlIGNoYXJ0IHRoZSBmaW5hbCBsb2NhdGlvbiBvZiB0aGUgY2hhcnQgYXJlYQoJCS8vIDkuIFRlbGwgYW55IGF4ZXMgdGhhdCBvdmVybGF5IHRoZSBjaGFydCBhcmVhIHRoZSBwb3NpdGlvbnMgb2YgdGhlIGNoYXJ0IGFyZWEKCgkJLy8gU3RlcCAxCgkJdmFyIGNoYXJ0V2lkdGggPSB3aWR0aCAtIGxlZnRQYWRkaW5nIC0gcmlnaHRQYWRkaW5nOwoJCXZhciBjaGFydEhlaWdodCA9IGhlaWdodCAtIHRvcFBhZGRpbmcgLSBib3R0b21QYWRkaW5nOwoJCXZhciBjaGFydEFyZWFXaWR0aCA9IGNoYXJ0V2lkdGggLyAyOyAvLyBtaW4gNTAlCgkJdmFyIGNoYXJ0QXJlYUhlaWdodCA9IGNoYXJ0SGVpZ2h0IC8gMjsgLy8gbWluIDUwJQoKCQkvLyBTdGVwIDIKCQl2YXIgdmVydGljYWxCb3hXaWR0aCA9ICh3aWR0aCAtIGNoYXJ0QXJlYVdpZHRoKSAvIChsZWZ0Qm94ZXMubGVuZ3RoICsgcmlnaHRCb3hlcy5sZW5ndGgpOwoKCQkvLyBTdGVwIDMKCQl2YXIgaG9yaXpvbnRhbEJveEhlaWdodCA9IChoZWlnaHQgLSBjaGFydEFyZWFIZWlnaHQpIC8gKHRvcEJveGVzLmxlbmd0aCArIGJvdHRvbUJveGVzLmxlbmd0aCk7CgoJCS8vIFN0ZXAgNAoJCXZhciBtYXhDaGFydEFyZWFXaWR0aCA9IGNoYXJ0V2lkdGg7CgkJdmFyIG1heENoYXJ0QXJlYUhlaWdodCA9IGNoYXJ0SGVpZ2h0OwoJCXZhciBtaW5Cb3hTaXplcyA9IFtdOwoKCQlmdW5jdGlvbiBnZXRNaW5pbXVtQm94U2l6ZShib3gpIHsKCQkJdmFyIG1pblNpemU7CgkJCXZhciBpc0hvcml6b250YWwgPSBib3guaXNIb3Jpem9udGFsKCk7CgoJCQlpZiAoaXNIb3Jpem9udGFsKSB7CgkJCQltaW5TaXplID0gYm94LnVwZGF0ZShib3guZnVsbFdpZHRoID8gY2hhcnRXaWR0aCA6IG1heENoYXJ0QXJlYVdpZHRoLCBob3Jpem9udGFsQm94SGVpZ2h0KTsKCQkJCW1heENoYXJ0QXJlYUhlaWdodCAtPSBtaW5TaXplLmhlaWdodDsKCQkJfSBlbHNlIHsKCQkJCW1pblNpemUgPSBib3gudXBkYXRlKHZlcnRpY2FsQm94V2lkdGgsIG1heENoYXJ0QXJlYUhlaWdodCk7CgkJCQltYXhDaGFydEFyZWFXaWR0aCAtPSBtaW5TaXplLndpZHRoOwoJCQl9CgoJCQltaW5Cb3hTaXplcy5wdXNoKHsKCQkJCWhvcml6b250YWw6IGlzSG9yaXpvbnRhbCwKCQkJCW1pblNpemU6IG1pblNpemUsCgkJCQlib3g6IGJveCwKCQkJfSk7CgkJfQoKCQloZWxwZXJzLmVhY2gobGVmdEJveGVzLmNvbmNhdChyaWdodEJveGVzLCB0b3BCb3hlcywgYm90dG9tQm94ZXMpLCBnZXRNaW5pbXVtQm94U2l6ZSk7CgoJCS8vIElmIGEgaG9yaXpvbnRhbCBib3ggaGFzIHBhZGRpbmcsIHdlIG1vdmUgdGhlIGxlZnQgYm94ZXMgb3ZlciB0byBhdm9pZCB1Z2x5IGNoYXJ0cyAoc2VlIGlzc3VlICMyNDc4KQoJCXZhciBtYXhIb3Jpem9udGFsTGVmdFBhZGRpbmcgPSAwOwoJCXZhciBtYXhIb3Jpem9udGFsUmlnaHRQYWRkaW5nID0gMDsKCQl2YXIgbWF4VmVydGljYWxUb3BQYWRkaW5nID0gMDsKCQl2YXIgbWF4VmVydGljYWxCb3R0b21QYWRkaW5nID0gMDsKCgkJaGVscGVycy5lYWNoKHRvcEJveGVzLmNvbmNhdChib3R0b21Cb3hlcyksIGZ1bmN0aW9uKGhvcml6b250YWxCb3gpIHsKCQkJaWYgKGhvcml6b250YWxCb3guZ2V0UGFkZGluZykgewoJCQkJdmFyIGJveFBhZGRpbmcgPSBob3Jpem9udGFsQm94LmdldFBhZGRpbmcoKTsKCQkJCW1heEhvcml6b250YWxMZWZ0UGFkZGluZyA9IE1hdGgubWF4KG1heEhvcml6b250YWxMZWZ0UGFkZGluZywgYm94UGFkZGluZy5sZWZ0KTsKCQkJCW1heEhvcml6b250YWxSaWdodFBhZGRpbmcgPSBNYXRoLm1heChtYXhIb3Jpem9udGFsUmlnaHRQYWRkaW5nLCBib3hQYWRkaW5nLnJpZ2h0KTsKCQkJfQoJCX0pOwoKCQloZWxwZXJzLmVhY2gobGVmdEJveGVzLmNvbmNhdChyaWdodEJveGVzKSwgZnVuY3Rpb24odmVydGljYWxCb3gpIHsKCQkJaWYgKHZlcnRpY2FsQm94LmdldFBhZGRpbmcpIHsKCQkJCXZhciBib3hQYWRkaW5nID0gdmVydGljYWxCb3guZ2V0UGFkZGluZygpOwoJCQkJbWF4VmVydGljYWxUb3BQYWRkaW5nID0gTWF0aC5tYXgobWF4VmVydGljYWxUb3BQYWRkaW5nLCBib3hQYWRkaW5nLnRvcCk7CgkJCQltYXhWZXJ0aWNhbEJvdHRvbVBhZGRpbmcgPSBNYXRoLm1heChtYXhWZXJ0aWNhbEJvdHRvbVBhZGRpbmcsIGJveFBhZGRpbmcuYm90dG9tKTsKCQkJfQoJCX0pOwoKCQkvLyBBdCB0aGlzIHBvaW50LCBtYXhDaGFydEFyZWFIZWlnaHQgYW5kIG1heENoYXJ0QXJlYVdpZHRoIGFyZSB0aGUgc2l6ZSB0aGUgY2hhcnQgYXJlYSBjb3VsZAoJCS8vIGJlIGlmIHRoZSBheGVzIGFyZSBkcmF3biBhdCB0aGVpciBtaW5pbXVtIHNpemVzLgoJCS8vIFN0ZXBzIDUgJiA2CgkJdmFyIHRvdGFsTGVmdEJveGVzV2lkdGggPSBsZWZ0UGFkZGluZzsKCQl2YXIgdG90YWxSaWdodEJveGVzV2lkdGggPSByaWdodFBhZGRpbmc7CgkJdmFyIHRvdGFsVG9wQm94ZXNIZWlnaHQgPSB0b3BQYWRkaW5nOwoJCXZhciB0b3RhbEJvdHRvbUJveGVzSGVpZ2h0ID0gYm90dG9tUGFkZGluZzsKCgkJLy8gRnVuY3Rpb24gdG8gZml0IGEgYm94CgkJZnVuY3Rpb24gZml0Qm94KGJveCkgewoJCQl2YXIgbWluQm94U2l6ZSA9IGhlbHBlcnMuZmluZE5leHRXaGVyZShtaW5Cb3hTaXplcywgZnVuY3Rpb24obWluQm94KSB7CgkJCQlyZXR1cm4gbWluQm94LmJveCA9PT0gYm94OwoJCQl9KTsKCgkJCWlmIChtaW5Cb3hTaXplKSB7CgkJCQlpZiAoYm94LmlzSG9yaXpvbnRhbCgpKSB7CgkJCQkJdmFyIHNjYWxlTWFyZ2luID0gewoJCQkJCQlsZWZ0OiBNYXRoLm1heCh0b3RhbExlZnRCb3hlc1dpZHRoLCBtYXhIb3Jpem9udGFsTGVmdFBhZGRpbmcpLAoJCQkJCQlyaWdodDogTWF0aC5tYXgodG90YWxSaWdodEJveGVzV2lkdGgsIG1heEhvcml6b250YWxSaWdodFBhZGRpbmcpLAoJCQkJCQl0b3A6IDAsCgkJCQkJCWJvdHRvbTogMAoJCQkJCX07CgoJCQkJCS8vIERvbid0IHVzZSBtaW4gc2l6ZSBoZXJlIGJlY2F1c2Ugb2YgbGFiZWwgcm90YXRpb24uIFdoZW4gdGhlIGxhYmVscyBhcmUgcm90YXRlZCwgdGhlaXIgcm90YXRpb24gaGlnaGx5IGRlcGVuZHMKCQkJCQkvLyBvbiB0aGUgbWFyZ2luLiBTb21ldGltZXMgdGhleSBuZWVkIHRvIGluY3JlYXNlIGluIHNpemUgc2xpZ2h0bHkKCQkJCQlib3gudXBkYXRlKGJveC5mdWxsV2lkdGggPyBjaGFydFdpZHRoIDogbWF4Q2hhcnRBcmVhV2lkdGgsIGNoYXJ0SGVpZ2h0IC8gMiwgc2NhbGVNYXJnaW4pOwoJCQkJfSBlbHNlIHsKCQkJCQlib3gudXBkYXRlKG1pbkJveFNpemUubWluU2l6ZS53aWR0aCwgbWF4Q2hhcnRBcmVhSGVpZ2h0KTsKCQkJCX0KCQkJfQoJCX0KCgkJLy8gVXBkYXRlLCBhbmQgY2FsY3VsYXRlIHRoZSBsZWZ0IGFuZCByaWdodCBtYXJnaW5zIGZvciB0aGUgaG9yaXpvbnRhbCBib3hlcwoJCWhlbHBlcnMuZWFjaChsZWZ0Qm94ZXMuY29uY2F0KHJpZ2h0Qm94ZXMpLCBmaXRCb3gpOwoKCQloZWxwZXJzLmVhY2gobGVmdEJveGVzLCBmdW5jdGlvbihib3gpIHsKCQkJdG90YWxMZWZ0Qm94ZXNXaWR0aCArPSBib3gud2lkdGg7CgkJfSk7CgoJCWhlbHBlcnMuZWFjaChyaWdodEJveGVzLCBmdW5jdGlvbihib3gpIHsKCQkJdG90YWxSaWdodEJveGVzV2lkdGggKz0gYm94LndpZHRoOwoJCX0pOwoKCQkvLyBTZXQgdGhlIExlZnQgYW5kIFJpZ2h0IG1hcmdpbnMgZm9yIHRoZSBob3Jpem9udGFsIGJveGVzCgkJaGVscGVycy5lYWNoKHRvcEJveGVzLmNvbmNhdChib3R0b21Cb3hlcyksIGZpdEJveCk7CgoJCS8vIEZpZ3VyZSBvdXQgaG93IG11Y2ggbWFyZ2luIGlzIG9uIHRoZSB0b3AgYW5kIGJvdHRvbSBvZiB0aGUgdmVydGljYWwgYm94ZXMKCQloZWxwZXJzLmVhY2godG9wQm94ZXMsIGZ1bmN0aW9uKGJveCkgewoJCQl0b3RhbFRvcEJveGVzSGVpZ2h0ICs9IGJveC5oZWlnaHQ7CgkJfSk7CgoJCWhlbHBlcnMuZWFjaChib3R0b21Cb3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCXRvdGFsQm90dG9tQm94ZXNIZWlnaHQgKz0gYm94LmhlaWdodDsKCQl9KTsKCgkJZnVuY3Rpb24gZmluYWxGaXRWZXJ0aWNhbEJveChib3gpIHsKCQkJdmFyIG1pbkJveFNpemUgPSBoZWxwZXJzLmZpbmROZXh0V2hlcmUobWluQm94U2l6ZXMsIGZ1bmN0aW9uKG1pblNpemUpIHsKCQkJCXJldHVybiBtaW5TaXplLmJveCA9PT0gYm94OwoJCQl9KTsKCgkJCXZhciBzY2FsZU1hcmdpbiA9IHsKCQkJCWxlZnQ6IDAsCgkJCQlyaWdodDogMCwKCQkJCXRvcDogdG90YWxUb3BCb3hlc0hlaWdodCwKCQkJCWJvdHRvbTogdG90YWxCb3R0b21Cb3hlc0hlaWdodAoJCQl9OwoKCQkJaWYgKG1pbkJveFNpemUpIHsKCQkJCWJveC51cGRhdGUobWluQm94U2l6ZS5taW5TaXplLndpZHRoLCBtYXhDaGFydEFyZWFIZWlnaHQsIHNjYWxlTWFyZ2luKTsKCQkJfQoJCX0KCgkJLy8gTGV0IHRoZSBsZWZ0IGxheW91dCBrbm93IHRoZSBmaW5hbCBtYXJnaW4KCQloZWxwZXJzLmVhY2gobGVmdEJveGVzLmNvbmNhdChyaWdodEJveGVzKSwgZmluYWxGaXRWZXJ0aWNhbEJveCk7CgoJCS8vIFJlY2FsY3VsYXRlIGJlY2F1c2UgdGhlIHNpemUgb2YgZWFjaCBsYXlvdXQgbWlnaHQgaGF2ZSBjaGFuZ2VkIHNsaWdodGx5IGR1ZSB0byB0aGUgbWFyZ2lucyAobGFiZWwgcm90YXRpb24gZm9yIGluc3RhbmNlKQoJCXRvdGFsTGVmdEJveGVzV2lkdGggPSBsZWZ0UGFkZGluZzsKCQl0b3RhbFJpZ2h0Qm94ZXNXaWR0aCA9IHJpZ2h0UGFkZGluZzsKCQl0b3RhbFRvcEJveGVzSGVpZ2h0ID0gdG9wUGFkZGluZzsKCQl0b3RhbEJvdHRvbUJveGVzSGVpZ2h0ID0gYm90dG9tUGFkZGluZzsKCgkJaGVscGVycy5lYWNoKGxlZnRCb3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCXRvdGFsTGVmdEJveGVzV2lkdGggKz0gYm94LndpZHRoOwoJCX0pOwoKCQloZWxwZXJzLmVhY2gocmlnaHRCb3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCXRvdGFsUmlnaHRCb3hlc1dpZHRoICs9IGJveC53aWR0aDsKCQl9KTsKCgkJaGVscGVycy5lYWNoKHRvcEJveGVzLCBmdW5jdGlvbihib3gpIHsKCQkJdG90YWxUb3BCb3hlc0hlaWdodCArPSBib3guaGVpZ2h0OwoJCX0pOwoJCWhlbHBlcnMuZWFjaChib3R0b21Cb3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCXRvdGFsQm90dG9tQm94ZXNIZWlnaHQgKz0gYm94LmhlaWdodDsKCQl9KTsKCgkJLy8gV2UgbWF5IGJlIGFkZGluZyBzb21lIHBhZGRpbmcgdG8gYWNjb3VudCBmb3Igcm90YXRlZCB4IGF4aXMgbGFiZWxzCgkJdmFyIGxlZnRQYWRkaW5nQWRkaXRpb24gPSBNYXRoLm1heChtYXhIb3Jpem9udGFsTGVmdFBhZGRpbmcgLSB0b3RhbExlZnRCb3hlc1dpZHRoLCAwKTsKCQl0b3RhbExlZnRCb3hlc1dpZHRoICs9IGxlZnRQYWRkaW5nQWRkaXRpb247CgkJdG90YWxSaWdodEJveGVzV2lkdGggKz0gTWF0aC5tYXgobWF4SG9yaXpvbnRhbFJpZ2h0UGFkZGluZyAtIHRvdGFsUmlnaHRCb3hlc1dpZHRoLCAwKTsKCgkJdmFyIHRvcFBhZGRpbmdBZGRpdGlvbiA9IE1hdGgubWF4KG1heFZlcnRpY2FsVG9wUGFkZGluZyAtIHRvdGFsVG9wQm94ZXNIZWlnaHQsIDApOwoJCXRvdGFsVG9wQm94ZXNIZWlnaHQgKz0gdG9wUGFkZGluZ0FkZGl0aW9uOwoJCXRvdGFsQm90dG9tQm94ZXNIZWlnaHQgKz0gTWF0aC5tYXgobWF4VmVydGljYWxCb3R0b21QYWRkaW5nIC0gdG90YWxCb3R0b21Cb3hlc0hlaWdodCwgMCk7CgoJCS8vIEZpZ3VyZSBvdXQgaWYgb3VyIGNoYXJ0IGFyZWEgY2hhbmdlZC4gVGhpcyB3b3VsZCBvY2N1ciBpZiB0aGUgZGF0YXNldCBsYXlvdXQgbGFiZWwgcm90YXRpb24KCQkvLyBjaGFuZ2VkIGR1ZSB0byB0aGUgYXBwbGljYXRpb24gb2YgdGhlIG1hcmdpbnMgaW4gc3RlcCA2LiBTaW5jZSB3ZSBjYW4gb25seSBnZXQgYmlnZ2VyLCB0aGlzIGlzIHNhZmUgdG8gZG8KCQkvLyB3aXRob3V0IGNhbGxpbmcgYGZpdGAgYWdhaW4KCQl2YXIgbmV3TWF4Q2hhcnRBcmVhSGVpZ2h0ID0gaGVpZ2h0IC0gdG90YWxUb3BCb3hlc0hlaWdodCAtIHRvdGFsQm90dG9tQm94ZXNIZWlnaHQ7CgkJdmFyIG5ld01heENoYXJ0QXJlYVdpZHRoID0gd2lkdGggLSB0b3RhbExlZnRCb3hlc1dpZHRoIC0gdG90YWxSaWdodEJveGVzV2lkdGg7CgoJCWlmIChuZXdNYXhDaGFydEFyZWFXaWR0aCAhPT0gbWF4Q2hhcnRBcmVhV2lkdGggfHwgbmV3TWF4Q2hhcnRBcmVhSGVpZ2h0ICE9PSBtYXhDaGFydEFyZWFIZWlnaHQpIHsKCQkJaGVscGVycy5lYWNoKGxlZnRCb3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCQlib3guaGVpZ2h0ID0gbmV3TWF4Q2hhcnRBcmVhSGVpZ2h0OwoJCQl9KTsKCgkJCWhlbHBlcnMuZWFjaChyaWdodEJveGVzLCBmdW5jdGlvbihib3gpIHsKCQkJCWJveC5oZWlnaHQgPSBuZXdNYXhDaGFydEFyZWFIZWlnaHQ7CgkJCX0pOwoKCQkJaGVscGVycy5lYWNoKHRvcEJveGVzLCBmdW5jdGlvbihib3gpIHsKCQkJCWlmICghYm94LmZ1bGxXaWR0aCkgewoJCQkJCWJveC53aWR0aCA9IG5ld01heENoYXJ0QXJlYVdpZHRoOwoJCQkJfQoJCQl9KTsKCgkJCWhlbHBlcnMuZWFjaChib3R0b21Cb3hlcywgZnVuY3Rpb24oYm94KSB7CgkJCQlpZiAoIWJveC5mdWxsV2lkdGgpIHsKCQkJCQlib3gud2lkdGggPSBuZXdNYXhDaGFydEFyZWFXaWR0aDsKCQkJCX0KCQkJfSk7CgoJCQltYXhDaGFydEFyZWFIZWlnaHQgPSBuZXdNYXhDaGFydEFyZWFIZWlnaHQ7CgkJCW1heENoYXJ0QXJlYVdpZHRoID0gbmV3TWF4Q2hhcnRBcmVhV2lkdGg7CgkJfQoKCQkvLyBTdGVwIDcgLSBQb3NpdGlvbiB0aGUgYm94ZXMKCQl2YXIgbGVmdCA9IGxlZnRQYWRkaW5nICsgbGVmdFBhZGRpbmdBZGRpdGlvbjsKCQl2YXIgdG9wID0gdG9wUGFkZGluZyArIHRvcFBhZGRpbmdBZGRpdGlvbjsKCgkJZnVuY3Rpb24gcGxhY2VCb3goYm94KSB7CgkJCWlmIChib3guaXNIb3Jpem9udGFsKCkpIHsKCQkJCWJveC5sZWZ0ID0gYm94LmZ1bGxXaWR0aCA/IGxlZnRQYWRkaW5nIDogdG90YWxMZWZ0Qm94ZXNXaWR0aDsKCQkJCWJveC5yaWdodCA9IGJveC5mdWxsV2lkdGggPyB3aWR0aCAtIHJpZ2h0UGFkZGluZyA6IHRvdGFsTGVmdEJveGVzV2lkdGggKyBtYXhDaGFydEFyZWFXaWR0aDsKCQkJCWJveC50b3AgPSB0b3A7CgkJCQlib3guYm90dG9tID0gdG9wICsgYm94LmhlaWdodDsKCgkJCQkvLyBNb3ZlIHRvIG5leHQgcG9pbnQKCQkJCXRvcCA9IGJveC5ib3R0b207CgoJCQl9IGVsc2UgewoKCQkJCWJveC5sZWZ0ID0gbGVmdDsKCQkJCWJveC5yaWdodCA9IGxlZnQgKyBib3gud2lkdGg7CgkJCQlib3gudG9wID0gdG90YWxUb3BCb3hlc0hlaWdodDsKCQkJCWJveC5ib3R0b20gPSB0b3RhbFRvcEJveGVzSGVpZ2h0ICsgbWF4Q2hhcnRBcmVhSGVpZ2h0OwoKCQkJCS8vIE1vdmUgdG8gbmV4dCBwb2ludAoJCQkJbGVmdCA9IGJveC5yaWdodDsKCQkJfQoJCX0KCgkJaGVscGVycy5lYWNoKGxlZnRCb3hlcy5jb25jYXQodG9wQm94ZXMpLCBwbGFjZUJveCk7CgoJCS8vIEFjY291bnQgZm9yIGNoYXJ0IHdpZHRoIGFuZCBoZWlnaHQKCQlsZWZ0ICs9IG1heENoYXJ0QXJlYVdpZHRoOwoJCXRvcCArPSBtYXhDaGFydEFyZWFIZWlnaHQ7CgoJCWhlbHBlcnMuZWFjaChyaWdodEJveGVzLCBwbGFjZUJveCk7CgkJaGVscGVycy5lYWNoKGJvdHRvbUJveGVzLCBwbGFjZUJveCk7CgoJCS8vIFN0ZXAgOAoJCWNoYXJ0LmNoYXJ0QXJlYSA9IHsKCQkJbGVmdDogdG90YWxMZWZ0Qm94ZXNXaWR0aCwKCQkJdG9wOiB0b3RhbFRvcEJveGVzSGVpZ2h0LAoJCQlyaWdodDogdG90YWxMZWZ0Qm94ZXNXaWR0aCArIG1heENoYXJ0QXJlYVdpZHRoLAoJCQlib3R0b206IHRvdGFsVG9wQm94ZXNIZWlnaHQgKyBtYXhDaGFydEFyZWFIZWlnaHQKCQl9OwoKCQkvLyBTdGVwIDkKCQloZWxwZXJzLmVhY2goY2hhcnRBcmVhQm94ZXMsIGZ1bmN0aW9uKGJveCkgewoJCQlib3gubGVmdCA9IGNoYXJ0LmNoYXJ0QXJlYS5sZWZ0OwoJCQlib3gudG9wID0gY2hhcnQuY2hhcnRBcmVhLnRvcDsKCQkJYm94LnJpZ2h0ID0gY2hhcnQuY2hhcnRBcmVhLnJpZ2h0OwoJCQlib3guYm90dG9tID0gY2hhcnQuY2hhcnRBcmVhLmJvdHRvbTsKCgkJCWJveC51cGRhdGUobWF4Q2hhcnRBcmVhV2lkdGgsIG1heENoYXJ0QXJlYUhlaWdodCk7CgkJfSk7Cgl9Cn07Cgp9LHsiNDUiOjQ1fV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgZGVmYXVsdHMgPSByZXF1aXJlKDI1KTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKCXBsdWdpbnM6IHt9Cn0pOwoKLyoqCiAqIFRoZSBwbHVnaW4gc2VydmljZSBzaW5nbGV0b24KICogQG5hbWVzcGFjZSBDaGFydC5wbHVnaW5zCiAqIEBzaW5jZSAyLjEuMAogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CgkvKioKCSAqIEdsb2JhbGx5IHJlZ2lzdGVyZWQgcGx1Z2lucy4KCSAqIEBwcml2YXRlCgkgKi8KCV9wbHVnaW5zOiBbXSwKCgkvKioKCSAqIFRoaXMgaWRlbnRpZmllciBpcyB1c2VkIHRvIGludmFsaWRhdGUgdGhlIGRlc2NyaXB0b3JzIGNhY2hlIGF0dGFjaGVkIHRvIGVhY2ggY2hhcnQKCSAqIHdoZW4gYSBnbG9iYWwgcGx1Z2luIGlzIHJlZ2lzdGVyZWQgb3IgdW5yZWdpc3RlcmVkLiBJbiB0aGlzIGNhc2UsIHRoZSBjYWNoZSBJRCBpcwoJICogaW5jcmVtZW50ZWQgYW5kIGRlc2NyaXB0b3JzIGFyZSByZWdlbmVyYXRlZCBkdXJpbmcgZm9sbG93aW5nIEFQSSBjYWxscy4KCSAqIEBwcml2YXRlCgkgKi8KCV9jYWNoZUlkOiAwLAoKCS8qKgoJICogUmVnaXN0ZXJzIHRoZSBnaXZlbiBwbHVnaW4ocykgaWYgbm90IGFscmVhZHkgcmVnaXN0ZXJlZC4KCSAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBwbHVnaW5zIHBsdWdpbiBpbnN0YW5jZShzKS4KCSAqLwoJcmVnaXN0ZXI6IGZ1bmN0aW9uKHBsdWdpbnMpIHsKCQl2YXIgcCA9IHRoaXMuX3BsdWdpbnM7CgkJKFtdKS5jb25jYXQocGx1Z2lucykuZm9yRWFjaChmdW5jdGlvbihwbHVnaW4pIHsKCQkJaWYgKHAuaW5kZXhPZihwbHVnaW4pID09PSAtMSkgewoJCQkJcC5wdXNoKHBsdWdpbik7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY2FjaGVJZCsrOwoJfSwKCgkvKioKCSAqIFVucmVnaXN0ZXJzIHRoZSBnaXZlbiBwbHVnaW4ocykgb25seSBpZiByZWdpc3RlcmVkLgoJICogQHBhcmFtIHtBcnJheXxPYmplY3R9IHBsdWdpbnMgcGx1Z2luIGluc3RhbmNlKHMpLgoJICovCgl1bnJlZ2lzdGVyOiBmdW5jdGlvbihwbHVnaW5zKSB7CgkJdmFyIHAgPSB0aGlzLl9wbHVnaW5zOwoJCShbXSkuY29uY2F0KHBsdWdpbnMpLmZvckVhY2goZnVuY3Rpb24ocGx1Z2luKSB7CgkJCXZhciBpZHggPSBwLmluZGV4T2YocGx1Z2luKTsKCQkJaWYgKGlkeCAhPT0gLTEpIHsKCQkJCXAuc3BsaWNlKGlkeCwgMSk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY2FjaGVJZCsrOwoJfSwKCgkvKioKCSAqIFJlbW92ZSBhbGwgcmVnaXN0ZXJlZCBwbHVnaW5zLgoJICogQHNpbmNlIDIuMS41CgkgKi8KCWNsZWFyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9wbHVnaW5zID0gW107CgkJdGhpcy5fY2FjaGVJZCsrOwoJfSwKCgkvKioKCSAqIFJldHVybnMgdGhlIG51bWJlciBvZiByZWdpc3RlcmVkIHBsdWdpbnM/CgkgKiBAcmV0dXJucyB7TnVtYmVyfQoJICogQHNpbmNlIDIuMS41CgkgKi8KCWNvdW50OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fcGx1Z2lucy5sZW5ndGg7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBhbGwgcmVnaXN0ZXJlZCBwbHVnaW4gaW5zdGFuY2VzLgoJICogQHJldHVybnMge0FycmF5fSBhcnJheSBvZiBwbHVnaW4gb2JqZWN0cy4KCSAqIEBzaW5jZSAyLjEuNQoJICovCglnZXRBbGw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9wbHVnaW5zOwoJfSwKCgkvKioKCSAqIENhbGxzIGVuYWJsZWQgcGx1Z2lucyBmb3IgYGNoYXJ0YCBvbiB0aGUgc3BlY2lmaWVkIGhvb2sgYW5kIHdpdGggdGhlIGdpdmVuIGFyZ3MuCgkgKiBUaGlzIG1ldGhvZCBpbW1lZGlhdGVseSByZXR1cm5zIGFzIHNvb24gYXMgYSBwbHVnaW4gZXhwbGljaXRseSByZXR1cm5zIGZhbHNlLiBUaGUKCSAqIHJldHVybmVkIHZhbHVlIGNhbiBiZSB1c2VkLCBmb3IgaW5zdGFuY2UsIHRvIGludGVycnVwdCB0aGUgY3VycmVudCBhY3Rpb24uCgkgKiBAcGFyYW0ge09iamVjdH0gY2hhcnQgLSBUaGUgY2hhcnQgaW5zdGFuY2UgZm9yIHdoaWNoIHBsdWdpbnMgc2hvdWxkIGJlIGNhbGxlZC4KCSAqIEBwYXJhbSB7U3RyaW5nfSBob29rIC0gVGhlIG5hbWUgb2YgdGhlIHBsdWdpbiBtZXRob2QgdG8gY2FsbCAoZS5nLiAnYmVmb3JlVXBkYXRlJykuCgkgKiBAcGFyYW0ge0FycmF5fSBbYXJnc10gLSBFeHRyYSBhcmd1bWVudHMgdG8gYXBwbHkgdG8gdGhlIGhvb2sgY2FsbC4KCSAqIEByZXR1cm5zIHtCb29sZWFufSBmYWxzZSBpZiBhbnkgb2YgdGhlIHBsdWdpbnMgcmV0dXJuIGZhbHNlLCBlbHNlIHJldHVybnMgdHJ1ZS4KCSAqLwoJbm90aWZ5OiBmdW5jdGlvbihjaGFydCwgaG9vaywgYXJncykgewoJCXZhciBkZXNjcmlwdG9ycyA9IHRoaXMuZGVzY3JpcHRvcnMoY2hhcnQpOwoJCXZhciBpbGVuID0gZGVzY3JpcHRvcnMubGVuZ3RoOwoJCXZhciBpLCBkZXNjcmlwdG9yLCBwbHVnaW4sIHBhcmFtcywgbWV0aG9kOwoKCQlmb3IgKGkgPSAwOyBpIDwgaWxlbjsgKytpKSB7CgkJCWRlc2NyaXB0b3IgPSBkZXNjcmlwdG9yc1tpXTsKCQkJcGx1Z2luID0gZGVzY3JpcHRvci5wbHVnaW47CgkJCW1ldGhvZCA9IHBsdWdpbltob29rXTsKCQkJaWYgKHR5cGVvZiBtZXRob2QgPT09ICdmdW5jdGlvbicpIHsKCQkJCXBhcmFtcyA9IFtjaGFydF0uY29uY2F0KGFyZ3MgfHwgW10pOwoJCQkJcGFyYW1zLnB1c2goZGVzY3JpcHRvci5vcHRpb25zKTsKCQkJCWlmIChtZXRob2QuYXBwbHkocGx1Z2luLCBwYXJhbXMpID09PSBmYWxzZSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qKgoJICogUmV0dXJucyBkZXNjcmlwdG9ycyBvZiBlbmFibGVkIHBsdWdpbnMgZm9yIHRoZSBnaXZlbiBjaGFydC4KCSAqIEByZXR1cm5zIHtBcnJheX0gW3sgcGx1Z2luLCBvcHRpb25zIH1dCgkgKiBAcHJpdmF0ZQoJICovCglkZXNjcmlwdG9yczogZnVuY3Rpb24oY2hhcnQpIHsKCQl2YXIgY2FjaGUgPSBjaGFydC4kcGx1Z2lucyB8fCAoY2hhcnQuJHBsdWdpbnMgPSB7fSk7CgkJaWYgKGNhY2hlLmlkID09PSB0aGlzLl9jYWNoZUlkKSB7CgkJCXJldHVybiBjYWNoZS5kZXNjcmlwdG9yczsKCQl9CgoJCXZhciBwbHVnaW5zID0gW107CgkJdmFyIGRlc2NyaXB0b3JzID0gW107CgkJdmFyIGNvbmZpZyA9IChjaGFydCAmJiBjaGFydC5jb25maWcpIHx8IHt9OwoJCXZhciBvcHRpb25zID0gKGNvbmZpZy5vcHRpb25zICYmIGNvbmZpZy5vcHRpb25zLnBsdWdpbnMpIHx8IHt9OwoKCQl0aGlzLl9wbHVnaW5zLmNvbmNhdChjb25maWcucGx1Z2lucyB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbihwbHVnaW4pIHsKCQkJdmFyIGlkeCA9IHBsdWdpbnMuaW5kZXhPZihwbHVnaW4pOwoJCQlpZiAoaWR4ICE9PSAtMSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgaWQgPSBwbHVnaW4uaWQ7CgkJCXZhciBvcHRzID0gb3B0aW9uc1tpZF07CgkJCWlmIChvcHRzID09PSBmYWxzZSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAob3B0cyA9PT0gdHJ1ZSkgewoJCQkJb3B0cyA9IGhlbHBlcnMuY2xvbmUoZGVmYXVsdHMuZ2xvYmFsLnBsdWdpbnNbaWRdKTsKCQkJfQoKCQkJcGx1Z2lucy5wdXNoKHBsdWdpbik7CgkJCWRlc2NyaXB0b3JzLnB1c2goewoJCQkJcGx1Z2luOiBwbHVnaW4sCgkJCQlvcHRpb25zOiBvcHRzIHx8IHt9CgkJCX0pOwoJCX0pOwoKCQljYWNoZS5kZXNjcmlwdG9ycyA9IGRlc2NyaXB0b3JzOwoJCWNhY2hlLmlkID0gdGhpcy5fY2FjaGVJZDsKCQlyZXR1cm4gZGVzY3JpcHRvcnM7Cgl9LAoKCS8qKgoJICogSW52YWxpZGF0ZXMgY2FjaGUgZm9yIHRoZSBnaXZlbiBjaGFydDogZGVzY3JpcHRvcnMgaG9sZCBhIHJlZmVyZW5jZSBvbiBwbHVnaW4gb3B0aW9uLAoJICogYnV0IGluIHNvbWUgY2FzZXMsIHRoaXMgcmVmZXJlbmNlIGNhbiBiZSBjaGFuZ2VkIGJ5IHRoZSB1c2VyIHdoZW4gdXBkYXRpbmcgb3B0aW9ucy4KCSAqIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy81MTExI2lzc3VlY29tbWVudC0zNTU5MzQxNjcKCSAqIEBwcml2YXRlCgkgKi8KCV9pbnZhbGlkYXRlOiBmdW5jdGlvbihjaGFydCkgewoJCWRlbGV0ZSBjaGFydC4kcGx1Z2luczsKCX0KfTsKCi8qKgogKiBQbHVnaW4gZXh0ZW5zaW9uIGhvb2tzLgogKiBAaW50ZXJmYWNlIElQbHVnaW4KICogQHNpbmNlIDIuMS4wCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2JlZm9yZUluaXQKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSBpbml0aWFsaXppbmcgYGNoYXJ0YC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVySW5pdAogKiBAZGVzYyBDYWxsZWQgYWZ0ZXIgYGNoYXJ0YCBoYXMgYmVlbiBpbml0aWFsaXplZCBhbmQgYmVmb3JlIHRoZSBmaXJzdCB1cGRhdGUuCiAqIEBwYXJhbSB7Q2hhcnQuQ29udHJvbGxlcn0gY2hhcnQgLSBUaGUgY2hhcnQgaW5zdGFuY2UuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHBsdWdpbiBvcHRpb25zLgogKi8KLyoqCiAqIEBtZXRob2QgSVBsdWdpbiNiZWZvcmVVcGRhdGUKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSB1cGRhdGluZyBgY2hhcnRgLiBJZiBhbnkgcGx1Z2luIHJldHVybnMgYGZhbHNlYCwgdGhlIHVwZGF0ZQogKiBpcyBjYW5jZWxsZWQgKGFuZCB0aHVzIHN1YnNlcXVlbnQgcmVuZGVyKHMpKSB1bnRpbCBhbm90aGVyIGB1cGRhdGVgIGlzIHRyaWdnZXJlZC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqIEByZXR1cm5zIHtCb29sZWFufSBgZmFsc2VgIHRvIGNhbmNlbCB0aGUgY2hhcnQgdXBkYXRlLgogKi8KLyoqCiAqIEBtZXRob2QgSVBsdWdpbiNhZnRlclVwZGF0ZQogKiBAZGVzYyBDYWxsZWQgYWZ0ZXIgYGNoYXJ0YCBoYXMgYmVlbiB1cGRhdGVkIGFuZCBiZWZvcmUgcmVuZGVyaW5nLiBOb3RlIHRoYXQgdGhpcwogKiBob29rIHdpbGwgbm90IGJlIGNhbGxlZCBpZiB0aGUgY2hhcnQgdXBkYXRlIGhhcyBiZWVuIHByZXZpb3VzbHkgY2FuY2VsbGVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYmVmb3JlRGF0YXNldHNVcGRhdGUKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSB1cGRhdGluZyB0aGUgYGNoYXJ0YCBkYXRhc2V0cy4gSWYgYW55IHBsdWdpbiByZXR1cm5zIGBmYWxzZWAsCiAqIHRoZSBkYXRhc2V0cyB1cGRhdGUgaXMgY2FuY2VsbGVkIHVudGlsIGFub3RoZXIgYHVwZGF0ZWAgaXMgdHJpZ2dlcmVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICogQHJldHVybnMge0Jvb2xlYW59IGZhbHNlIHRvIGNhbmNlbCB0aGUgZGF0YXNldHMgdXBkYXRlLgogKiBAc2luY2UgdmVyc2lvbiAyLjEuNQoqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyRGF0YXNldHNVcGRhdGUKICogQGRlc2MgQ2FsbGVkIGFmdGVyIHRoZSBgY2hhcnRgIGRhdGFzZXRzIGhhdmUgYmVlbiB1cGRhdGVkLiBOb3RlIHRoYXQgdGhpcyBob29rCiAqIHdpbGwgbm90IGJlIGNhbGxlZCBpZiB0aGUgZGF0YXNldHMgdXBkYXRlIGhhcyBiZWVuIHByZXZpb3VzbHkgY2FuY2VsbGVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICogQHNpbmNlIHZlcnNpb24gMi4xLjUKICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYmVmb3JlRGF0YXNldFVwZGF0ZQogKiBAZGVzYyBDYWxsZWQgYmVmb3JlIHVwZGF0aW5nIHRoZSBgY2hhcnRgIGRhdGFzZXQgYXQgdGhlIGdpdmVuIGBhcmdzLmluZGV4YC4gSWYgYW55IHBsdWdpbgogKiByZXR1cm5zIGBmYWxzZWAsIHRoZSBkYXRhc2V0cyB1cGRhdGUgaXMgY2FuY2VsbGVkIHVudGlsIGFub3RoZXIgYHVwZGF0ZWAgaXMgdHJpZ2dlcmVkLgogKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtPYmplY3R9IGFyZ3MgLSBUaGUgY2FsbCBhcmd1bWVudHMuCiAqIEBwYXJhbSB7TnVtYmVyfSBhcmdzLmluZGV4IC0gVGhlIGRhdGFzZXQgaW5kZXguCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzLm1ldGEgLSBUaGUgZGF0YXNldCBtZXRhZGF0YS4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqIEByZXR1cm5zIHtCb29sZWFufSBgZmFsc2VgIHRvIGNhbmNlbCB0aGUgY2hhcnQgZGF0YXNldHMgZHJhd2luZy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYWZ0ZXJEYXRhc2V0VXBkYXRlCiAqIEBkZXNjIENhbGxlZCBhZnRlciB0aGUgYGNoYXJ0YCBkYXRhc2V0cyBhdCB0aGUgZ2l2ZW4gYGFyZ3MuaW5kZXhgIGhhcyBiZWVuIHVwZGF0ZWQuIE5vdGUKICogdGhhdCB0aGlzIGhvb2sgd2lsbCBub3QgYmUgY2FsbGVkIGlmIHRoZSBkYXRhc2V0cyB1cGRhdGUgaGFzIGJlZW4gcHJldmlvdXNseSBjYW5jZWxsZWQuCiAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gYXJncyAtIFRoZSBjYWxsIGFyZ3VtZW50cy4KICogQHBhcmFtIHtOdW1iZXJ9IGFyZ3MuaW5kZXggLSBUaGUgZGF0YXNldCBpbmRleC4KICogQHBhcmFtIHtPYmplY3R9IGFyZ3MubWV0YSAtIFRoZSBkYXRhc2V0IG1ldGFkYXRhLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYmVmb3JlTGF5b3V0CiAqIEBkZXNjIENhbGxlZCBiZWZvcmUgbGF5aW5nIG91dCBgY2hhcnRgLiBJZiBhbnkgcGx1Z2luIHJldHVybnMgYGZhbHNlYCwKICogdGhlIGxheW91dCB1cGRhdGUgaXMgY2FuY2VsbGVkIHVudGlsIGFub3RoZXIgYHVwZGF0ZWAgaXMgdHJpZ2dlcmVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICogQHJldHVybnMge0Jvb2xlYW59IGBmYWxzZWAgdG8gY2FuY2VsIHRoZSBjaGFydCBsYXlvdXQuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyTGF5b3V0CiAqIEBkZXNjIENhbGxlZCBhZnRlciB0aGUgYGNoYXJ0YCBoYXMgYmVlbiBsYXllZCBvdXQuIE5vdGUgdGhhdCB0aGlzIGhvb2sgd2lsbCBub3QKICogYmUgY2FsbGVkIGlmIHRoZSBsYXlvdXQgdXBkYXRlIGhhcyBiZWVuIHByZXZpb3VzbHkgY2FuY2VsbGVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYmVmb3JlUmVuZGVyCiAqIEBkZXNjIENhbGxlZCBiZWZvcmUgcmVuZGVyaW5nIGBjaGFydGAuIElmIGFueSBwbHVnaW4gcmV0dXJucyBgZmFsc2VgLAogKiB0aGUgcmVuZGVyaW5nIGlzIGNhbmNlbGxlZCB1bnRpbCBhbm90aGVyIGByZW5kZXJgIGlzIHRyaWdnZXJlZC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqIEByZXR1cm5zIHtCb29sZWFufSBgZmFsc2VgIHRvIGNhbmNlbCB0aGUgY2hhcnQgcmVuZGVyaW5nLgogKi8KLyoqCiAqIEBtZXRob2QgSVBsdWdpbiNhZnRlclJlbmRlcgogKiBAZGVzYyBDYWxsZWQgYWZ0ZXIgdGhlIGBjaGFydGAgaGFzIGJlZW4gZnVsbHkgcmVuZGVyZWQgKGFuZCBhbmltYXRpb24gY29tcGxldGVkKS4gTm90ZQogKiB0aGF0IHRoaXMgaG9vayB3aWxsIG5vdCBiZSBjYWxsZWQgaWYgdGhlIHJlbmRlcmluZyBoYXMgYmVlbiBwcmV2aW91c2x5IGNhbmNlbGxlZC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2JlZm9yZURyYXcKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSBkcmF3aW5nIGBjaGFydGAgYXQgZXZlcnkgYW5pbWF0aW9uIGZyYW1lIHNwZWNpZmllZCBieSB0aGUgZ2l2ZW4KICogZWFzaW5nIHZhbHVlLiBJZiBhbnkgcGx1Z2luIHJldHVybnMgYGZhbHNlYCwgdGhlIGZyYW1lIGRyYXdpbmcgaXMgY2FuY2VsbGVkIHVudGlsCiAqIGFub3RoZXIgYHJlbmRlcmAgaXMgdHJpZ2dlcmVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge051bWJlcn0gZWFzaW5nVmFsdWUgLSBUaGUgY3VycmVudCBhbmltYXRpb24gdmFsdWUsIGJldHdlZW4gMC4wIGFuZCAxLjAuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHBsdWdpbiBvcHRpb25zLgogKiBAcmV0dXJucyB7Qm9vbGVhbn0gYGZhbHNlYCB0byBjYW5jZWwgdGhlIGNoYXJ0IGRyYXdpbmcuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyRHJhdwogKiBAZGVzYyBDYWxsZWQgYWZ0ZXIgdGhlIGBjaGFydGAgaGFzIGJlZW4gZHJhd24gZm9yIHRoZSBzcGVjaWZpYyBlYXNpbmcgdmFsdWUuIE5vdGUKICogdGhhdCB0aGlzIGhvb2sgd2lsbCBub3QgYmUgY2FsbGVkIGlmIHRoZSBkcmF3aW5nIGhhcyBiZWVuIHByZXZpb3VzbHkgY2FuY2VsbGVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge051bWJlcn0gZWFzaW5nVmFsdWUgLSBUaGUgY3VycmVudCBhbmltYXRpb24gdmFsdWUsIGJldHdlZW4gMC4wIGFuZCAxLjAuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHBsdWdpbiBvcHRpb25zLgogKi8KLyoqCiAqIEBtZXRob2QgSVBsdWdpbiNiZWZvcmVEYXRhc2V0c0RyYXcKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSBkcmF3aW5nIHRoZSBgY2hhcnRgIGRhdGFzZXRzLiBJZiBhbnkgcGx1Z2luIHJldHVybnMgYGZhbHNlYCwKICogdGhlIGRhdGFzZXRzIGRyYXdpbmcgaXMgY2FuY2VsbGVkIHVudGlsIGFub3RoZXIgYHJlbmRlcmAgaXMgdHJpZ2dlcmVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge051bWJlcn0gZWFzaW5nVmFsdWUgLSBUaGUgY3VycmVudCBhbmltYXRpb24gdmFsdWUsIGJldHdlZW4gMC4wIGFuZCAxLjAuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHBsdWdpbiBvcHRpb25zLgogKiBAcmV0dXJucyB7Qm9vbGVhbn0gYGZhbHNlYCB0byBjYW5jZWwgdGhlIGNoYXJ0IGRhdGFzZXRzIGRyYXdpbmcuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyRGF0YXNldHNEcmF3CiAqIEBkZXNjIENhbGxlZCBhZnRlciB0aGUgYGNoYXJ0YCBkYXRhc2V0cyBoYXZlIGJlZW4gZHJhd24uIE5vdGUgdGhhdCB0aGlzIGhvb2sKICogd2lsbCBub3QgYmUgY2FsbGVkIGlmIHRoZSBkYXRhc2V0cyBkcmF3aW5nIGhhcyBiZWVuIHByZXZpb3VzbHkgY2FuY2VsbGVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge051bWJlcn0gZWFzaW5nVmFsdWUgLSBUaGUgY3VycmVudCBhbmltYXRpb24gdmFsdWUsIGJldHdlZW4gMC4wIGFuZCAxLjAuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHBsdWdpbiBvcHRpb25zLgogKi8KLyoqCiAqIEBtZXRob2QgSVBsdWdpbiNiZWZvcmVEYXRhc2V0RHJhdwogKiBAZGVzYyBDYWxsZWQgYmVmb3JlIGRyYXdpbmcgdGhlIGBjaGFydGAgZGF0YXNldCBhdCB0aGUgZ2l2ZW4gYGFyZ3MuaW5kZXhgIChkYXRhc2V0cwogKiBhcmUgZHJhd24gaW4gdGhlIHJldmVyc2Ugb3JkZXIpLiBJZiBhbnkgcGx1Z2luIHJldHVybnMgYGZhbHNlYCwgdGhlIGRhdGFzZXRzIGRyYXdpbmcKICogaXMgY2FuY2VsbGVkIHVudGlsIGFub3RoZXIgYHJlbmRlcmAgaXMgdHJpZ2dlcmVkLgogKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtPYmplY3R9IGFyZ3MgLSBUaGUgY2FsbCBhcmd1bWVudHMuCiAqIEBwYXJhbSB7TnVtYmVyfSBhcmdzLmluZGV4IC0gVGhlIGRhdGFzZXQgaW5kZXguCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzLm1ldGEgLSBUaGUgZGF0YXNldCBtZXRhZGF0YS4KICogQHBhcmFtIHtOdW1iZXJ9IGFyZ3MuZWFzaW5nVmFsdWUgLSBUaGUgY3VycmVudCBhbmltYXRpb24gdmFsdWUsIGJldHdlZW4gMC4wIGFuZCAxLjAuCiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHBsdWdpbiBvcHRpb25zLgogKiBAcmV0dXJucyB7Qm9vbGVhbn0gYGZhbHNlYCB0byBjYW5jZWwgdGhlIGNoYXJ0IGRhdGFzZXRzIGRyYXdpbmcuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyRGF0YXNldERyYXcKICogQGRlc2MgQ2FsbGVkIGFmdGVyIHRoZSBgY2hhcnRgIGRhdGFzZXRzIGF0IHRoZSBnaXZlbiBgYXJncy5pbmRleGAgaGF2ZSBiZWVuIGRyYXduCiAqIChkYXRhc2V0cyBhcmUgZHJhd24gaW4gdGhlIHJldmVyc2Ugb3JkZXIpLiBOb3RlIHRoYXQgdGhpcyBob29rIHdpbGwgbm90IGJlIGNhbGxlZAogKiBpZiB0aGUgZGF0YXNldHMgZHJhd2luZyBoYXMgYmVlbiBwcmV2aW91c2x5IGNhbmNlbGxlZC4KICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSBUaGUgY2hhcnQgaW5zdGFuY2UuCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzIC0gVGhlIGNhbGwgYXJndW1lbnRzLgogKiBAcGFyYW0ge051bWJlcn0gYXJncy5pbmRleCAtIFRoZSBkYXRhc2V0IGluZGV4LgogKiBAcGFyYW0ge09iamVjdH0gYXJncy5tZXRhIC0gVGhlIGRhdGFzZXQgbWV0YWRhdGEuCiAqIEBwYXJhbSB7TnVtYmVyfSBhcmdzLmVhc2luZ1ZhbHVlIC0gVGhlIGN1cnJlbnQgYW5pbWF0aW9uIHZhbHVlLCBiZXR3ZWVuIDAuMCBhbmQgMS4wLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYmVmb3JlVG9vbHRpcERyYXcKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSBkcmF3aW5nIHRoZSBgdG9vbHRpcGAuIElmIGFueSBwbHVnaW4gcmV0dXJucyBgZmFsc2VgLAogKiB0aGUgdG9vbHRpcCBkcmF3aW5nIGlzIGNhbmNlbGxlZCB1bnRpbCBhbm90aGVyIGByZW5kZXJgIGlzIHRyaWdnZXJlZC4KICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSBUaGUgY2hhcnQgaW5zdGFuY2UuCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzIC0gVGhlIGNhbGwgYXJndW1lbnRzLgogKiBAcGFyYW0ge09iamVjdH0gYXJncy50b29sdGlwIC0gVGhlIHRvb2x0aXAuCiAqIEBwYXJhbSB7TnVtYmVyfSBhcmdzLmVhc2luZ1ZhbHVlIC0gVGhlIGN1cnJlbnQgYW5pbWF0aW9uIHZhbHVlLCBiZXR3ZWVuIDAuMCBhbmQgMS4wLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICogQHJldHVybnMge0Jvb2xlYW59IGBmYWxzZWAgdG8gY2FuY2VsIHRoZSBjaGFydCB0b29sdGlwIGRyYXdpbmcuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyVG9vbHRpcERyYXcKICogQGRlc2MgQ2FsbGVkIGFmdGVyIGRyYXdpbmcgdGhlIGB0b29sdGlwYC4gTm90ZSB0aGF0IHRoaXMgaG9vayB3aWxsIG5vdAogKiBiZSBjYWxsZWQgaWYgdGhlIHRvb2x0aXAgZHJhd2luZyBoYXMgYmVlbiBwcmV2aW91c2x5IGNhbmNlbGxlZC4KICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSBUaGUgY2hhcnQgaW5zdGFuY2UuCiAqIEBwYXJhbSB7T2JqZWN0fSBhcmdzIC0gVGhlIGNhbGwgYXJndW1lbnRzLgogKiBAcGFyYW0ge09iamVjdH0gYXJncy50b29sdGlwIC0gVGhlIHRvb2x0aXAuCiAqIEBwYXJhbSB7TnVtYmVyfSBhcmdzLmVhc2luZ1ZhbHVlIC0gVGhlIGN1cnJlbnQgYW5pbWF0aW9uIHZhbHVlLCBiZXR3ZWVuIDAuMCBhbmQgMS4wLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jYmVmb3JlRXZlbnQKICogQGRlc2MgQ2FsbGVkIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSBzcGVjaWZpZWQgYGV2ZW50YC4gSWYgYW55IHBsdWdpbiByZXR1cm5zIGBmYWxzZWAsCiAqIHRoZSBldmVudCB3aWxsIGJlIGRpc2NhcmRlZC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtJRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IG9iamVjdC4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI2FmdGVyRXZlbnQKICogQGRlc2MgQ2FsbGVkIGFmdGVyIHRoZSBgZXZlbnRgIGhhcyBiZWVuIGNvbnN1bWVkLiBOb3RlIHRoYXQgdGhpcyBob29rCiAqIHdpbGwgbm90IGJlIGNhbGxlZCBpZiB0aGUgYGV2ZW50YCBoYXMgYmVlbiBwcmV2aW91c2x5IGRpc2NhcmRlZC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtJRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IG9iamVjdC4KICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgcGx1Z2luIG9wdGlvbnMuCiAqLwovKioKICogQG1ldGhvZCBJUGx1Z2luI3Jlc2l6ZQogKiBAZGVzYyBDYWxsZWQgYWZ0ZXIgdGhlIGNoYXJ0IGFzIGJlZW4gcmVzaXplZC4KICogQHBhcmFtIHtDaGFydC5Db250cm9sbGVyfSBjaGFydCAtIFRoZSBjaGFydCBpbnN0YW5jZS4KICogQHBhcmFtIHtOdW1iZXJ9IHNpemUgLSBUaGUgbmV3IGNhbnZhcyBkaXNwbGF5IHNpemUgKGVxLiBjYW52YXMuc3R5bGUgd2lkdGggJiBoZWlnaHQpLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCi8qKgogKiBAbWV0aG9kIElQbHVnaW4jZGVzdHJveQogKiBAZGVzYyBDYWxsZWQgYWZ0ZXIgdGhlIGNoYXJ0IGFzIGJlZW4gZGVzdHJveWVkLgogKiBAcGFyYW0ge0NoYXJ0LkNvbnRyb2xsZXJ9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlLgogKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIFRoZSBwbHVnaW4gb3B0aW9ucy4KICovCgp9LHsiMjUiOjI1LCI0NSI6NDV9XSwzMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgRWxlbWVudCA9IHJlcXVpcmUoMjYpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgVGlja3MgPSByZXF1aXJlKDM0KTsKCmRlZmF1bHRzLl9zZXQoJ3NjYWxlJywgewoJZGlzcGxheTogdHJ1ZSwKCXBvc2l0aW9uOiAnbGVmdCcsCglvZmZzZXQ6IGZhbHNlLAoKCS8vIGdyaWQgbGluZSBzZXR0aW5ncwoJZ3JpZExpbmVzOiB7CgkJZGlzcGxheTogdHJ1ZSwKCQljb2xvcjogJ3JnYmEoMCwgMCwgMCwgMC4xKScsCgkJbGluZVdpZHRoOiAxLAoJCWRyYXdCb3JkZXI6IHRydWUsCgkJZHJhd09uQ2hhcnRBcmVhOiB0cnVlLAoJCWRyYXdUaWNrczogdHJ1ZSwKCQl0aWNrTWFya0xlbmd0aDogMTAsCgkJemVyb0xpbmVXaWR0aDogMSwKCQl6ZXJvTGluZUNvbG9yOiAncmdiYSgwLDAsMCwwLjI1KScsCgkJemVyb0xpbmVCb3JkZXJEYXNoOiBbXSwKCQl6ZXJvTGluZUJvcmRlckRhc2hPZmZzZXQ6IDAuMCwKCQlvZmZzZXRHcmlkTGluZXM6IGZhbHNlLAoJCWJvcmRlckRhc2g6IFtdLAoJCWJvcmRlckRhc2hPZmZzZXQ6IDAuMAoJfSwKCgkvLyBzY2FsZSBsYWJlbAoJc2NhbGVMYWJlbDogewoJCS8vIGRpc3BsYXkgcHJvcGVydHkKCQlkaXNwbGF5OiBmYWxzZSwKCgkJLy8gYWN0dWFsIGxhYmVsCgkJbGFiZWxTdHJpbmc6ICcnLAoKCQkvLyBsaW5lIGhlaWdodAoJCWxpbmVIZWlnaHQ6IDEuMiwKCgkJLy8gdG9wL2JvdHRvbSBwYWRkaW5nCgkJcGFkZGluZzogewoJCQl0b3A6IDQsCgkJCWJvdHRvbTogNAoJCX0KCX0sCgoJLy8gbGFiZWwgc2V0dGluZ3MKCXRpY2tzOiB7CgkJYmVnaW5BdFplcm86IGZhbHNlLAoJCW1pblJvdGF0aW9uOiAwLAoJCW1heFJvdGF0aW9uOiA1MCwKCQltaXJyb3I6IGZhbHNlLAoJCXBhZGRpbmc6IDAsCgkJcmV2ZXJzZTogZmFsc2UsCgkJZGlzcGxheTogdHJ1ZSwKCQlhdXRvU2tpcDogdHJ1ZSwKCQlhdXRvU2tpcFBhZGRpbmc6IDAsCgkJbGFiZWxPZmZzZXQ6IDAsCgkJLy8gV2UgcGFzcyB0aHJvdWdoIGFycmF5cyB0byBiZSByZW5kZXJlZCBhcyBtdWx0aWxpbmUgbGFiZWxzLCB3ZSBjb252ZXJ0IE90aGVycyB0byBzdHJpbmdzIGhlcmUuCgkJY2FsbGJhY2s6IFRpY2tzLmZvcm1hdHRlcnMudmFsdWVzLAoJCW1pbm9yOiB7fSwKCQltYWpvcjoge30KCX0KfSk7CgpmdW5jdGlvbiBsYWJlbHNGcm9tVGlja3ModGlja3MpIHsKCXZhciBsYWJlbHMgPSBbXTsKCXZhciBpLCBpbGVuOwoKCWZvciAoaSA9IDAsIGlsZW4gPSB0aWNrcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQlsYWJlbHMucHVzaCh0aWNrc1tpXS5sYWJlbCk7Cgl9CgoJcmV0dXJuIGxhYmVsczsKfQoKZnVuY3Rpb24gZ2V0TGluZVZhbHVlKHNjYWxlLCBpbmRleCwgb2Zmc2V0R3JpZExpbmVzKSB7Cgl2YXIgbGluZVZhbHVlID0gc2NhbGUuZ2V0UGl4ZWxGb3JUaWNrKGluZGV4KTsKCglpZiAob2Zmc2V0R3JpZExpbmVzKSB7CgkJaWYgKGluZGV4ID09PSAwKSB7CgkJCWxpbmVWYWx1ZSAtPSAoc2NhbGUuZ2V0UGl4ZWxGb3JUaWNrKDEpIC0gbGluZVZhbHVlKSAvIDI7CgkJfSBlbHNlIHsKCQkJbGluZVZhbHVlIC09IChsaW5lVmFsdWUgLSBzY2FsZS5nZXRQaXhlbEZvclRpY2soaW5kZXggLSAxKSkgLyAyOwoJCX0KCX0KCXJldHVybiBsaW5lVmFsdWU7Cn0KCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCglmdW5jdGlvbiBjb21wdXRlVGV4dFNpemUoY29udGV4dCwgdGljaywgZm9udCkgewoJCXJldHVybiBoZWxwZXJzLmlzQXJyYXkodGljaykgPwoJCQloZWxwZXJzLmxvbmdlc3RUZXh0KGNvbnRleHQsIGZvbnQsIHRpY2spIDoKCQkJY29udGV4dC5tZWFzdXJlVGV4dCh0aWNrKS53aWR0aDsKCX0KCglmdW5jdGlvbiBwYXJzZUZvbnRPcHRpb25zKG9wdGlvbnMpIHsKCQl2YXIgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoJCXZhciBnbG9iYWxEZWZhdWx0cyA9IGRlZmF1bHRzLmdsb2JhbDsKCQl2YXIgc2l6ZSA9IHZhbHVlT3JEZWZhdWx0KG9wdGlvbnMuZm9udFNpemUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U2l6ZSk7CgkJdmFyIHN0eWxlID0gdmFsdWVPckRlZmF1bHQob3B0aW9ucy5mb250U3R5bGUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U3R5bGUpOwoJCXZhciBmYW1pbHkgPSB2YWx1ZU9yRGVmYXVsdChvcHRpb25zLmZvbnRGYW1pbHksIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250RmFtaWx5KTsKCgkJcmV0dXJuIHsKCQkJc2l6ZTogc2l6ZSwKCQkJc3R5bGU6IHN0eWxlLAoJCQlmYW1pbHk6IGZhbWlseSwKCQkJZm9udDogaGVscGVycy5mb250U3RyaW5nKHNpemUsIHN0eWxlLCBmYW1pbHkpCgkJfTsKCX0KCglmdW5jdGlvbiBwYXJzZUxpbmVIZWlnaHQob3B0aW9ucykgewoJCXJldHVybiBoZWxwZXJzLm9wdGlvbnMudG9MaW5lSGVpZ2h0KAoJCQloZWxwZXJzLnZhbHVlT3JEZWZhdWx0KG9wdGlvbnMubGluZUhlaWdodCwgMS4yKSwKCQkJaGVscGVycy52YWx1ZU9yRGVmYXVsdChvcHRpb25zLmZvbnRTaXplLCBkZWZhdWx0cy5nbG9iYWwuZGVmYXVsdEZvbnRTaXplKSk7Cgl9CgoJQ2hhcnQuU2NhbGUgPSBFbGVtZW50LmV4dGVuZCh7CgkJLyoqCgkJICogR2V0IHRoZSBwYWRkaW5nIG5lZWRlZCBmb3IgdGhlIHNjYWxlCgkJICogQG1ldGhvZCBnZXRQYWRkaW5nCgkJICogQHByaXZhdGUKCQkgKiBAcmV0dXJucyB7UGFkZGluZ30gdGhlIG5lY2Vzc2FyeSBwYWRkaW5nCgkJICovCgkJZ2V0UGFkZGluZzogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXJldHVybiB7CgkJCQlsZWZ0OiBtZS5wYWRkaW5nTGVmdCB8fCAwLAoJCQkJdG9wOiBtZS5wYWRkaW5nVG9wIHx8IDAsCgkJCQlyaWdodDogbWUucGFkZGluZ1JpZ2h0IHx8IDAsCgkJCQlib3R0b206IG1lLnBhZGRpbmdCb3R0b20gfHwgMAoJCQl9OwoJCX0sCgoJCS8qKgoJCSAqIFJldHVybnMgdGhlIHNjYWxlIHRpY2sgb2JqZWN0cyAoe2xhYmVsLCBtYWpvcn0pCgkJICogQHNpbmNlIDIuNwoJCSAqLwoJCWdldFRpY2tzOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuX3RpY2tzOwoJCX0sCgoJCS8vIFRoZXNlIG1ldGhvZHMgYXJlIG9yZGVyZWQgYnkgbGlmZWN5bGUuIFV0aWxpdGllcyB0aGVuIGZvbGxvdy4KCQkvLyBBbnkgZnVuY3Rpb24gZGVmaW5lZCBoZXJlIGlzIGluaGVyaXRlZCBieSBhbGwgc2NhbGUgdHlwZXMuCgkJLy8gQW55IGZ1bmN0aW9uIGNhbiBiZSBleHRlbmRlZCBieSB0aGUgc2NhbGUgdHlwZQoKCQltZXJnZVRpY2tzT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJCXZhciB0aWNrcyA9IHRoaXMub3B0aW9ucy50aWNrczsKCQkJaWYgKHRpY2tzLm1pbm9yID09PSBmYWxzZSkgewoJCQkJdGlja3MubWlub3IgPSB7CgkJCQkJZGlzcGxheTogZmFsc2UKCQkJCX07CgkJCX0KCQkJaWYgKHRpY2tzLm1ham9yID09PSBmYWxzZSkgewoJCQkJdGlja3MubWFqb3IgPSB7CgkJCQkJZGlzcGxheTogZmFsc2UKCQkJCX07CgkJCX0KCQkJZm9yICh2YXIga2V5IGluIHRpY2tzKSB7CgkJCQlpZiAoa2V5ICE9PSAnbWFqb3InICYmIGtleSAhPT0gJ21pbm9yJykgewoJCQkJCWlmICh0eXBlb2YgdGlja3MubWlub3Jba2V5XSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJdGlja3MubWlub3Jba2V5XSA9IHRpY2tzW2tleV07CgkJCQkJfQoJCQkJCWlmICh0eXBlb2YgdGlja3MubWFqb3Jba2V5XSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJdGlja3MubWFqb3Jba2V5XSA9IHRpY2tzW2tleV07CgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQliZWZvcmVVcGRhdGU6IGZ1bmN0aW9uKCkgewoJCQloZWxwZXJzLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5iZWZvcmVVcGRhdGUsIFt0aGlzXSk7CgkJfSwKCQl1cGRhdGU6IGZ1bmN0aW9uKG1heFdpZHRoLCBtYXhIZWlnaHQsIG1hcmdpbnMpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGksIGlsZW4sIGxhYmVscywgbGFiZWwsIHRpY2tzLCB0aWNrOwoKCQkJLy8gVXBkYXRlIExpZmVjeWNsZSAtIFByb2JhYmx5IGRvbid0IHdhbnQgdG8gZXZlciBleHRlbmQgb3Igb3ZlcndyaXRlIHRoaXMgZnVuY3Rpb24gOykKCQkJbWUuYmVmb3JlVXBkYXRlKCk7CgoJCQkvLyBBYnNvcmIgdGhlIG1hc3RlciBtZWFzdXJlbWVudHMKCQkJbWUubWF4V2lkdGggPSBtYXhXaWR0aDsKCQkJbWUubWF4SGVpZ2h0ID0gbWF4SGVpZ2h0OwoJCQltZS5tYXJnaW5zID0gaGVscGVycy5leHRlbmQoewoJCQkJbGVmdDogMCwKCQkJCXJpZ2h0OiAwLAoJCQkJdG9wOiAwLAoJCQkJYm90dG9tOiAwCgkJCX0sIG1hcmdpbnMpOwoJCQltZS5sb25nZXN0VGV4dENhY2hlID0gbWUubG9uZ2VzdFRleHRDYWNoZSB8fCB7fTsKCgkJCS8vIERpbWVuc2lvbnMKCQkJbWUuYmVmb3JlU2V0RGltZW5zaW9ucygpOwoJCQltZS5zZXREaW1lbnNpb25zKCk7CgkJCW1lLmFmdGVyU2V0RGltZW5zaW9ucygpOwoKCQkJLy8gRGF0YSBtaW4vbWF4CgkJCW1lLmJlZm9yZURhdGFMaW1pdHMoKTsKCQkJbWUuZGV0ZXJtaW5lRGF0YUxpbWl0cygpOwoJCQltZS5hZnRlckRhdGFMaW1pdHMoKTsKCgkJCS8vIFRpY2tzIC0gYHRoaXMudGlja3NgIGlzIG5vdyBERVBSRUNBVEVEIQoJCQkvLyBJbnRlcm5hbCB0aWNrcyBhcmUgbm93IHN0b3JlZCBhcyBvYmplY3RzIGluIHRoZSBQUklWQVRFIGB0aGlzLl90aWNrc2AgbWVtYmVyCgkJCS8vIGFuZCBtdXN0IG5vdCBiZSBhY2Nlc3NlZCBkaXJlY3RseSBmcm9tIG91dHNpZGUgdGhpcyBjbGFzcy4gYHRoaXMudGlja3NgIGJlaW5nCgkJCS8vIGFyb3VuZCBmb3IgbG9uZyB0aW1lIGFuZCBub3QgbWFya2VkIGFzIHByaXZhdGUsIHdlIGNhbid0IGNoYW5nZSBpdHMgc3RydWN0dXJlCgkJCS8vIHdpdGhvdXQgdW5leHBlY3RlZCBicmVha2luZyBjaGFuZ2VzLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNjYWxlIHRpY2tzLAoJCQkvLyB1c2Ugc2NhbGUuZ2V0VGlja3MoKSBpbnN0ZWFkLgoKCQkJbWUuYmVmb3JlQnVpbGRUaWNrcygpOwoKCQkJLy8gTmV3IGltcGxlbWVudGF0aW9ucyBzaG91bGQgcmV0dXJuIGFuIGFycmF5IG9mIG9iamVjdHMgYnV0IGZvciBCQUNLV0FSRCBDT01QQVQsCgkJCS8vIHdlIHN0aWxsIHN1cHBvcnQgbm8gcmV0dXJuIChgdGhpcy50aWNrc2AgaW50ZXJuYWxseSBzZXQgYnkgY2FsbGluZyB0aGlzIG1ldGhvZCkuCgkJCXRpY2tzID0gbWUuYnVpbGRUaWNrcygpIHx8IFtdOwoKCQkJbWUuYWZ0ZXJCdWlsZFRpY2tzKCk7CgoJCQltZS5iZWZvcmVUaWNrVG9MYWJlbENvbnZlcnNpb24oKTsKCgkJCS8vIE5ldyBpbXBsZW1lbnRhdGlvbnMgc2hvdWxkIHJldHVybiB0aGUgZm9ybWF0dGVkIHRpY2sgbGFiZWxzIGJ1dCBmb3IgQkFDS1dBUkQKCQkJLy8gQ09NUEFULCB3ZSBzdGlsbCBzdXBwb3J0IG5vIHJldHVybiAoYHRoaXMudGlja3NgIGludGVybmFsbHkgY2hhbmdlZCBieSBjYWxsaW5nCgkJCS8vIHRoaXMgbWV0aG9kIGFuZCBzdXBwb3NlZCB0byBjb250YWluIG9ubHkgc3RyaW5nIHZhbHVlcykuCgkJCWxhYmVscyA9IG1lLmNvbnZlcnRUaWNrc1RvTGFiZWxzKHRpY2tzKSB8fCBtZS50aWNrczsKCgkJCW1lLmFmdGVyVGlja1RvTGFiZWxDb252ZXJzaW9uKCk7CgoJCQltZS50aWNrcyA9IGxhYmVsczsgICAvLyBCQUNLV0FSRCBDT01QQVRJQklMSVRZCgoJCQkvLyBJTVBPUlRBTlQ6IGZyb20gdGhpcyBwb2ludCwgd2UgY29uc2lkZXIgdGhhdCBgdGhpcy50aWNrc2Agd2lsbCBORVZFUiBjaGFuZ2UhCgoJCQkvLyBCQUNLV0FSRCBDT01QQVQ6IHN5bmNocm9uaXplIGBfdGlja3NgIHdpdGggbGFiZWxzIChzbyBwb3RlbnRpYWxseSBgdGhpcy50aWNrc2ApCgkJCWZvciAoaSA9IDAsIGlsZW4gPSBsYWJlbHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQlsYWJlbCA9IGxhYmVsc1tpXTsKCQkJCXRpY2sgPSB0aWNrc1tpXTsKCQkJCWlmICghdGljaykgewoJCQkJCXRpY2tzLnB1c2godGljayA9IHsKCQkJCQkJbGFiZWw6IGxhYmVsLAoJCQkJCQltYWpvcjogZmFsc2UKCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGljay5sYWJlbCA9IGxhYmVsOwoJCQkJfQoJCQl9CgoJCQltZS5fdGlja3MgPSB0aWNrczsKCgkJCS8vIFRpY2sgUm90YXRpb24KCQkJbWUuYmVmb3JlQ2FsY3VsYXRlVGlja1JvdGF0aW9uKCk7CgkJCW1lLmNhbGN1bGF0ZVRpY2tSb3RhdGlvbigpOwoJCQltZS5hZnRlckNhbGN1bGF0ZVRpY2tSb3RhdGlvbigpOwoJCQkvLyBGaXQKCQkJbWUuYmVmb3JlRml0KCk7CgkJCW1lLmZpdCgpOwoJCQltZS5hZnRlckZpdCgpOwoJCQkvLwoJCQltZS5hZnRlclVwZGF0ZSgpOwoKCQkJcmV0dXJuIG1lLm1pblNpemU7CgoJCX0sCgkJYWZ0ZXJVcGRhdGU6IGZ1bmN0aW9uKCkgewoJCQloZWxwZXJzLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5hZnRlclVwZGF0ZSwgW3RoaXNdKTsKCQl9LAoKCQkvLwoKCQliZWZvcmVTZXREaW1lbnNpb25zOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYmVmb3JlU2V0RGltZW5zaW9ucywgW3RoaXNdKTsKCQl9LAoJCXNldERpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQkvLyBTZXQgdGhlIHVuY29uc3RyYWluZWQgZGltZW5zaW9uIGJlZm9yZSBsYWJlbCByb3RhdGlvbgoJCQlpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKCQkJCS8vIFJlc2V0IHBvc2l0aW9uIGJlZm9yZSBjYWxjdWxhdGluZyByb3RhdGlvbgoJCQkJbWUud2lkdGggPSBtZS5tYXhXaWR0aDsKCQkJCW1lLmxlZnQgPSAwOwoJCQkJbWUucmlnaHQgPSBtZS53aWR0aDsKCQkJfSBlbHNlIHsKCQkJCW1lLmhlaWdodCA9IG1lLm1heEhlaWdodDsKCgkJCQkvLyBSZXNldCBwb3NpdGlvbiBiZWZvcmUgY2FsY3VsYXRpbmcgcm90YXRpb24KCQkJCW1lLnRvcCA9IDA7CgkJCQltZS5ib3R0b20gPSBtZS5oZWlnaHQ7CgkJCX0KCgkJCS8vIFJlc2V0IHBhZGRpbmcKCQkJbWUucGFkZGluZ0xlZnQgPSAwOwoJCQltZS5wYWRkaW5nVG9wID0gMDsKCQkJbWUucGFkZGluZ1JpZ2h0ID0gMDsKCQkJbWUucGFkZGluZ0JvdHRvbSA9IDA7CgkJfSwKCQlhZnRlclNldERpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewoJCQloZWxwZXJzLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5hZnRlclNldERpbWVuc2lvbnMsIFt0aGlzXSk7CgkJfSwKCgkJLy8gRGF0YSBsaW1pdHMKCQliZWZvcmVEYXRhTGltaXRzOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYmVmb3JlRGF0YUxpbWl0cywgW3RoaXNdKTsKCQl9LAoJCWRldGVybWluZURhdGFMaW1pdHM6IGhlbHBlcnMubm9vcCwKCQlhZnRlckRhdGFMaW1pdHM6IGZ1bmN0aW9uKCkgewoJCQloZWxwZXJzLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5hZnRlckRhdGFMaW1pdHMsIFt0aGlzXSk7CgkJfSwKCgkJLy8KCQliZWZvcmVCdWlsZFRpY2tzOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYmVmb3JlQnVpbGRUaWNrcywgW3RoaXNdKTsKCQl9LAoJCWJ1aWxkVGlja3M6IGhlbHBlcnMubm9vcCwKCQlhZnRlckJ1aWxkVGlja3M6IGZ1bmN0aW9uKCkgewoJCQloZWxwZXJzLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5hZnRlckJ1aWxkVGlja3MsIFt0aGlzXSk7CgkJfSwKCgkJYmVmb3JlVGlja1RvTGFiZWxDb252ZXJzaW9uOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYmVmb3JlVGlja1RvTGFiZWxDb252ZXJzaW9uLCBbdGhpc10pOwoJCX0sCgkJY29udmVydFRpY2tzVG9MYWJlbHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQkvLyBDb252ZXJ0IHRpY2tzIHRvIHN0cmluZ3MKCQkJdmFyIHRpY2tPcHRzID0gbWUub3B0aW9ucy50aWNrczsKCQkJbWUudGlja3MgPSBtZS50aWNrcy5tYXAodGlja09wdHMudXNlckNhbGxiYWNrIHx8IHRpY2tPcHRzLmNhbGxiYWNrLCB0aGlzKTsKCQl9LAoJCWFmdGVyVGlja1RvTGFiZWxDb252ZXJzaW9uOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYWZ0ZXJUaWNrVG9MYWJlbENvbnZlcnNpb24sIFt0aGlzXSk7CgkJfSwKCgkJLy8KCgkJYmVmb3JlQ2FsY3VsYXRlVGlja1JvdGF0aW9uOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYmVmb3JlQ2FsY3VsYXRlVGlja1JvdGF0aW9uLCBbdGhpc10pOwoJCX0sCgkJY2FsY3VsYXRlVGlja1JvdGF0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNvbnRleHQgPSBtZS5jdHg7CgkJCXZhciB0aWNrT3B0cyA9IG1lLm9wdGlvbnMudGlja3M7CgkJCXZhciBsYWJlbHMgPSBsYWJlbHNGcm9tVGlja3MobWUuX3RpY2tzKTsKCgkJCS8vIEdldCB0aGUgd2lkdGggb2YgZWFjaCBncmlkIGJ5IGNhbGN1bGF0aW5nIHRoZSBkaWZmZXJlbmNlCgkJCS8vIGJldHdlZW4geCBvZmZzZXRzIGJldHdlZW4gMCBhbmQgMS4KCQkJdmFyIHRpY2tGb250ID0gcGFyc2VGb250T3B0aW9ucyh0aWNrT3B0cyk7CgkJCWNvbnRleHQuZm9udCA9IHRpY2tGb250LmZvbnQ7CgoJCQl2YXIgbGFiZWxSb3RhdGlvbiA9IHRpY2tPcHRzLm1pblJvdGF0aW9uIHx8IDA7CgoJCQlpZiAobGFiZWxzLmxlbmd0aCAmJiBtZS5vcHRpb25zLmRpc3BsYXkgJiYgbWUuaXNIb3Jpem9udGFsKCkpIHsKCQkJCXZhciBvcmlnaW5hbExhYmVsV2lkdGggPSBoZWxwZXJzLmxvbmdlc3RUZXh0KGNvbnRleHQsIHRpY2tGb250LmZvbnQsIGxhYmVscywgbWUubG9uZ2VzdFRleHRDYWNoZSk7CgkJCQl2YXIgbGFiZWxXaWR0aCA9IG9yaWdpbmFsTGFiZWxXaWR0aDsKCQkJCXZhciBjb3NSb3RhdGlvbiwgc2luUm90YXRpb247CgoJCQkJLy8gQWxsb3cgMyBwaXhlbHMgeDIgcGFkZGluZyBlaXRoZXIgc2lkZSBmb3IgbGFiZWwgcmVhZGFiaWxpdHkKCQkJCXZhciB0aWNrV2lkdGggPSBtZS5nZXRQaXhlbEZvclRpY2soMSkgLSBtZS5nZXRQaXhlbEZvclRpY2soMCkgLSA2OwoKCQkJCS8vIE1heCBsYWJlbCByb3RhdGlvbiBjYW4gYmUgc2V0IG9yIGRlZmF1bHQgdG8gOTAgLSBhbHNvIGFjdCBhcyBhIGxvb3AgY291bnRlcgoJCQkJd2hpbGUgKGxhYmVsV2lkdGggPiB0aWNrV2lkdGggJiYgbGFiZWxSb3RhdGlvbiA8IHRpY2tPcHRzLm1heFJvdGF0aW9uKSB7CgkJCQkJdmFyIGFuZ2xlUmFkaWFucyA9IGhlbHBlcnMudG9SYWRpYW5zKGxhYmVsUm90YXRpb24pOwoJCQkJCWNvc1JvdGF0aW9uID0gTWF0aC5jb3MoYW5nbGVSYWRpYW5zKTsKCQkJCQlzaW5Sb3RhdGlvbiA9IE1hdGguc2luKGFuZ2xlUmFkaWFucyk7CgoJCQkJCWlmIChzaW5Sb3RhdGlvbiAqIG9yaWdpbmFsTGFiZWxXaWR0aCA+IG1lLm1heEhlaWdodCkgewoJCQkJCQkvLyBnbyBiYWNrIG9uZSBzdGVwCgkJCQkJCWxhYmVsUm90YXRpb24tLTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQlsYWJlbFJvdGF0aW9uKys7CgkJCQkJbGFiZWxXaWR0aCA9IGNvc1JvdGF0aW9uICogb3JpZ2luYWxMYWJlbFdpZHRoOwoJCQkJfQoJCQl9CgoJCQltZS5sYWJlbFJvdGF0aW9uID0gbGFiZWxSb3RhdGlvbjsKCQl9LAoJCWFmdGVyQ2FsY3VsYXRlVGlja1JvdGF0aW9uOiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYWZ0ZXJDYWxjdWxhdGVUaWNrUm90YXRpb24sIFt0aGlzXSk7CgkJfSwKCgkJLy8KCgkJYmVmb3JlRml0OiBmdW5jdGlvbigpIHsKCQkJaGVscGVycy5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYmVmb3JlRml0LCBbdGhpc10pOwoJCX0sCgkJZml0OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJLy8gUmVzZXQKCQkJdmFyIG1pblNpemUgPSBtZS5taW5TaXplID0gewoJCQkJd2lkdGg6IDAsCgkJCQloZWlnaHQ6IDAKCQkJfTsKCgkJCXZhciBsYWJlbHMgPSBsYWJlbHNGcm9tVGlja3MobWUuX3RpY2tzKTsKCgkJCXZhciBvcHRzID0gbWUub3B0aW9uczsKCQkJdmFyIHRpY2tPcHRzID0gb3B0cy50aWNrczsKCQkJdmFyIHNjYWxlTGFiZWxPcHRzID0gb3B0cy5zY2FsZUxhYmVsOwoJCQl2YXIgZ3JpZExpbmVPcHRzID0gb3B0cy5ncmlkTGluZXM7CgkJCXZhciBkaXNwbGF5ID0gb3B0cy5kaXNwbGF5OwoJCQl2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgoJCQl2YXIgdGlja0ZvbnQgPSBwYXJzZUZvbnRPcHRpb25zKHRpY2tPcHRzKTsKCQkJdmFyIHRpY2tNYXJrTGVuZ3RoID0gb3B0cy5ncmlkTGluZXMudGlja01hcmtMZW5ndGg7CgoJCQkvLyBXaWR0aAoJCQlpZiAoaXNIb3Jpem9udGFsKSB7CgkJCQkvLyBzdWJ0cmFjdCB0aGUgbWFyZ2lucyB0byBsaW5lIHVwIHdpdGggdGhlIGNoYXJ0QXJlYSBpZiB3ZSBhcmUgYSBmdWxsIHdpZHRoIHNjYWxlCgkJCQltaW5TaXplLndpZHRoID0gbWUuaXNGdWxsV2lkdGgoKSA/IG1lLm1heFdpZHRoIC0gbWUubWFyZ2lucy5sZWZ0IC0gbWUubWFyZ2lucy5yaWdodCA6IG1lLm1heFdpZHRoOwoJCQl9IGVsc2UgewoJCQkJbWluU2l6ZS53aWR0aCA9IGRpc3BsYXkgJiYgZ3JpZExpbmVPcHRzLmRyYXdUaWNrcyA/IHRpY2tNYXJrTGVuZ3RoIDogMDsKCQkJfQoKCQkJLy8gaGVpZ2h0CgkJCWlmIChpc0hvcml6b250YWwpIHsKCQkJCW1pblNpemUuaGVpZ2h0ID0gZGlzcGxheSAmJiBncmlkTGluZU9wdHMuZHJhd1RpY2tzID8gdGlja01hcmtMZW5ndGggOiAwOwoJCQl9IGVsc2UgewoJCQkJbWluU2l6ZS5oZWlnaHQgPSBtZS5tYXhIZWlnaHQ7IC8vIGZpbGwgYWxsIHRoZSBoZWlnaHQKCQkJfQoKCQkJLy8gQXJlIHdlIHNob3dpbmcgYSB0aXRsZSBmb3IgdGhlIHNjYWxlPwoJCQlpZiAoc2NhbGVMYWJlbE9wdHMuZGlzcGxheSAmJiBkaXNwbGF5KSB7CgkJCQl2YXIgc2NhbGVMYWJlbExpbmVIZWlnaHQgPSBwYXJzZUxpbmVIZWlnaHQoc2NhbGVMYWJlbE9wdHMpOwoJCQkJdmFyIHNjYWxlTGFiZWxQYWRkaW5nID0gaGVscGVycy5vcHRpb25zLnRvUGFkZGluZyhzY2FsZUxhYmVsT3B0cy5wYWRkaW5nKTsKCQkJCXZhciBkZWx0YUhlaWdodCA9IHNjYWxlTGFiZWxMaW5lSGVpZ2h0ICsgc2NhbGVMYWJlbFBhZGRpbmcuaGVpZ2h0OwoKCQkJCWlmIChpc0hvcml6b250YWwpIHsKCQkJCQltaW5TaXplLmhlaWdodCArPSBkZWx0YUhlaWdodDsKCQkJCX0gZWxzZSB7CgkJCQkJbWluU2l6ZS53aWR0aCArPSBkZWx0YUhlaWdodDsKCQkJCX0KCQkJfQoKCQkJLy8gRG9uJ3QgYm90aGVyIGZpdHRpbmcgdGhlIHRpY2tzIGlmIHdlIGFyZSBub3Qgc2hvd2luZyB0aGVtCgkJCWlmICh0aWNrT3B0cy5kaXNwbGF5ICYmIGRpc3BsYXkpIHsKCQkJCXZhciBsYXJnZXN0VGV4dFdpZHRoID0gaGVscGVycy5sb25nZXN0VGV4dChtZS5jdHgsIHRpY2tGb250LmZvbnQsIGxhYmVscywgbWUubG9uZ2VzdFRleHRDYWNoZSk7CgkJCQl2YXIgdGFsbGVzdExhYmVsSGVpZ2h0SW5MaW5lcyA9IGhlbHBlcnMubnVtYmVyT2ZMYWJlbExpbmVzKGxhYmVscyk7CgkJCQl2YXIgbGluZVNwYWNlID0gdGlja0ZvbnQuc2l6ZSAqIDAuNTsKCQkJCXZhciB0aWNrUGFkZGluZyA9IG1lLm9wdGlvbnMudGlja3MucGFkZGluZzsKCgkJCQlpZiAoaXNIb3Jpem9udGFsKSB7CgkJCQkJLy8gQSBob3Jpem9udGFsIGF4aXMgaXMgbW9yZSBjb25zdHJhaW5lZCBieSB0aGUgaGVpZ2h0LgoJCQkJCW1lLmxvbmdlc3RMYWJlbFdpZHRoID0gbGFyZ2VzdFRleHRXaWR0aDsKCgkJCQkJdmFyIGFuZ2xlUmFkaWFucyA9IGhlbHBlcnMudG9SYWRpYW5zKG1lLmxhYmVsUm90YXRpb24pOwoJCQkJCXZhciBjb3NSb3RhdGlvbiA9IE1hdGguY29zKGFuZ2xlUmFkaWFucyk7CgkJCQkJdmFyIHNpblJvdGF0aW9uID0gTWF0aC5zaW4oYW5nbGVSYWRpYW5zKTsKCgkJCQkJLy8gVE9ETyAtIGltcHJvdmUgdGhpcyBjYWxjdWxhdGlvbgoJCQkJCXZhciBsYWJlbEhlaWdodCA9IChzaW5Sb3RhdGlvbiAqIGxhcmdlc3RUZXh0V2lkdGgpCgkJCQkJCSsgKHRpY2tGb250LnNpemUgKiB0YWxsZXN0TGFiZWxIZWlnaHRJbkxpbmVzKQoJCQkJCQkrIChsaW5lU3BhY2UgKiAodGFsbGVzdExhYmVsSGVpZ2h0SW5MaW5lcyAtIDEpKQoJCQkJCQkrIGxpbmVTcGFjZTsgLy8gcGFkZGluZwoKCQkJCQltaW5TaXplLmhlaWdodCA9IE1hdGgubWluKG1lLm1heEhlaWdodCwgbWluU2l6ZS5oZWlnaHQgKyBsYWJlbEhlaWdodCArIHRpY2tQYWRkaW5nKTsKCgkJCQkJbWUuY3R4LmZvbnQgPSB0aWNrRm9udC5mb250OwoJCQkJCXZhciBmaXJzdExhYmVsV2lkdGggPSBjb21wdXRlVGV4dFNpemUobWUuY3R4LCBsYWJlbHNbMF0sIHRpY2tGb250LmZvbnQpOwoJCQkJCXZhciBsYXN0TGFiZWxXaWR0aCA9IGNvbXB1dGVUZXh0U2l6ZShtZS5jdHgsIGxhYmVsc1tsYWJlbHMubGVuZ3RoIC0gMV0sIHRpY2tGb250LmZvbnQpOwoKCQkJCQkvLyBFbnN1cmUgdGhhdCBvdXIgdGlja3MgYXJlIGFsd2F5cyBpbnNpZGUgdGhlIGNhbnZhcy4gV2hlbiByb3RhdGVkLCB0aWNrcyBhcmUgcmlnaHQgYWxpZ25lZAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoYXQgdGhlIHJpZ2h0IHBhZGRpbmcgaXMgZG9taW5hdGVkIGJ5IHRoZSBmb250IGhlaWdodAoJCQkJCWlmIChtZS5sYWJlbFJvdGF0aW9uICE9PSAwKSB7CgkJCQkJCW1lLnBhZGRpbmdMZWZ0ID0gb3B0cy5wb3NpdGlvbiA9PT0gJ2JvdHRvbScgPyAoY29zUm90YXRpb24gKiBmaXJzdExhYmVsV2lkdGgpICsgMyA6IChjb3NSb3RhdGlvbiAqIGxpbmVTcGFjZSkgKyAzOyAvLyBhZGQgMyBweCB0byBtb3ZlIGF3YXkgZnJvbSBjYW52YXMgZWRnZXMKCQkJCQkJbWUucGFkZGluZ1JpZ2h0ID0gb3B0cy5wb3NpdGlvbiA9PT0gJ2JvdHRvbScgPyAoY29zUm90YXRpb24gKiBsaW5lU3BhY2UpICsgMyA6IChjb3NSb3RhdGlvbiAqIGxhc3RMYWJlbFdpZHRoKSArIDM7CgkJCQkJfSBlbHNlIHsKCQkJCQkJbWUucGFkZGluZ0xlZnQgPSBmaXJzdExhYmVsV2lkdGggLyAyICsgMzsgLy8gYWRkIDMgcHggdG8gbW92ZSBhd2F5IGZyb20gY2FudmFzIGVkZ2VzCgkJCQkJCW1lLnBhZGRpbmdSaWdodCA9IGxhc3RMYWJlbFdpZHRoIC8gMiArIDM7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyBBIHZlcnRpY2FsIGF4aXMgaXMgbW9yZSBjb25zdHJhaW5lZCBieSB0aGUgd2lkdGguIExhYmVscyBhcmUgdGhlCgkJCQkJLy8gZG9taW5hbnQgZmFjdG9yIGhlcmUsIHNvIGdldCB0aGF0IGxlbmd0aCBmaXJzdCBhbmQgYWNjb3VudCBmb3IgcGFkZGluZwoJCQkJCWlmICh0aWNrT3B0cy5taXJyb3IpIHsKCQkJCQkJbGFyZ2VzdFRleHRXaWR0aCA9IDA7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gdXNlIGxpbmVTcGFjZSBmb3IgY29uc2lzdGVuY3kgd2l0aCBob3Jpem9udGFsIGF4aXMKCQkJCQkJLy8gdGlja1BhZGRpbmcgaXMgbm90IGltcGxlbWVudGVkIGZvciBob3Jpem9udGFsCgkJCQkJCWxhcmdlc3RUZXh0V2lkdGggKz0gdGlja1BhZGRpbmcgKyBsaW5lU3BhY2U7CgkJCQkJfQoKCQkJCQltaW5TaXplLndpZHRoID0gTWF0aC5taW4obWUubWF4V2lkdGgsIG1pblNpemUud2lkdGggKyBsYXJnZXN0VGV4dFdpZHRoKTsKCgkJCQkJbWUucGFkZGluZ1RvcCA9IHRpY2tGb250LnNpemUgLyAyOwoJCQkJCW1lLnBhZGRpbmdCb3R0b20gPSB0aWNrRm9udC5zaXplIC8gMjsKCQkJCX0KCQkJfQoKCQkJbWUuaGFuZGxlTWFyZ2lucygpOwoKCQkJbWUud2lkdGggPSBtaW5TaXplLndpZHRoOwoJCQltZS5oZWlnaHQgPSBtaW5TaXplLmhlaWdodDsKCQl9LAoKCQkvKioKCQkgKiBIYW5kbGUgbWFyZ2lucyBhbmQgcGFkZGluZyBpbnRlcmFjdGlvbnMKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWhhbmRsZU1hcmdpbnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQlpZiAobWUubWFyZ2lucykgewoJCQkJbWUucGFkZGluZ0xlZnQgPSBNYXRoLm1heChtZS5wYWRkaW5nTGVmdCAtIG1lLm1hcmdpbnMubGVmdCwgMCk7CgkJCQltZS5wYWRkaW5nVG9wID0gTWF0aC5tYXgobWUucGFkZGluZ1RvcCAtIG1lLm1hcmdpbnMudG9wLCAwKTsKCQkJCW1lLnBhZGRpbmdSaWdodCA9IE1hdGgubWF4KG1lLnBhZGRpbmdSaWdodCAtIG1lLm1hcmdpbnMucmlnaHQsIDApOwoJCQkJbWUucGFkZGluZ0JvdHRvbSA9IE1hdGgubWF4KG1lLnBhZGRpbmdCb3R0b20gLSBtZS5tYXJnaW5zLmJvdHRvbSwgMCk7CgkJCX0KCQl9LAoKCQlhZnRlckZpdDogZnVuY3Rpb24oKSB7CgkJCWhlbHBlcnMuY2FsbGJhY2sodGhpcy5vcHRpb25zLmFmdGVyRml0LCBbdGhpc10pOwoJCX0sCgoJCS8vIFNoYXJlZCBNZXRob2RzCgkJaXNIb3Jpem9udGFsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gJ3RvcCcgfHwgdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAnYm90dG9tJzsKCQl9LAoJCWlzRnVsbFdpZHRoOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICh0aGlzLm9wdGlvbnMuZnVsbFdpZHRoKTsKCQl9LAoKCQkvLyBHZXQgdGhlIGNvcnJlY3QgdmFsdWUuIE5hTiBiYWQgaW5wdXRzLCBJZiB0aGUgdmFsdWUgdHlwZSBpcyBvYmplY3QgZ2V0IHRoZSB4IG9yIHkgYmFzZWQgb24gd2hldGhlciB3ZSBhcmUgaG9yaXpvbnRhbCBvciBub3QKCQlnZXRSaWdodFZhbHVlOiBmdW5jdGlvbihyYXdWYWx1ZSkgewoJCQkvLyBOdWxsIGFuZCB1bmRlZmluZWQgdmFsdWVzIGZpcnN0CgkJCWlmIChoZWxwZXJzLmlzTnVsbE9yVW5kZWYocmF3VmFsdWUpKSB7CgkJCQlyZXR1cm4gTmFOOwoJCQl9CgkJCS8vIGlzTmFOKG9iamVjdCkgcmV0dXJucyB0cnVlLCBzbyBtYWtlIHN1cmUgTmFOIGlzIGNoZWNraW5nIGZvciBhIG51bWJlcjsgRGlzY2FyZCBJbmZpbml0ZSB2YWx1ZXMKCQkJaWYgKHR5cGVvZiByYXdWYWx1ZSA9PT0gJ251bWJlcicgJiYgIWlzRmluaXRlKHJhd1ZhbHVlKSkgewoJCQkJcmV0dXJuIE5hTjsKCQkJfQoJCQkvLyBJZiBpdCBpcyBpbiBmYWN0IGFuIG9iamVjdCwgZGl2ZSBpbiBvbmUgbW9yZSBsZXZlbAoJCQlpZiAocmF3VmFsdWUpIHsKCQkJCWlmICh0aGlzLmlzSG9yaXpvbnRhbCgpKSB7CgkJCQkJaWYgKHJhd1ZhbHVlLnggIT09IHVuZGVmaW5lZCkgewoJCQkJCQlyZXR1cm4gdGhpcy5nZXRSaWdodFZhbHVlKHJhd1ZhbHVlLngpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAocmF3VmFsdWUueSAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJcmV0dXJuIHRoaXMuZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZS55KTsKCQkJCX0KCQkJfQoKCQkJLy8gVmFsdWUgaXMgZ29vZCwgcmV0dXJuIGl0CgkJCXJldHVybiByYXdWYWx1ZTsKCQl9LAoKCQkvKioKCQkgKiBVc2VkIHRvIGdldCB0aGUgdmFsdWUgdG8gZGlzcGxheSBpbiB0aGUgdG9vbHRpcCBmb3IgdGhlIGRhdGEgYXQgdGhlIGdpdmVuIGluZGV4CgkJICogQHBhcmFtIGluZGV4CgkJICogQHBhcmFtIGRhdGFzZXRJbmRleAoJCSAqLwoJCWdldExhYmVsRm9ySW5kZXg6IGhlbHBlcnMubm9vcCwKCgkJLyoqCgkJICogUmV0dXJucyB0aGUgbG9jYXRpb24gb2YgdGhlIGdpdmVuIGRhdGEgcG9pbnQuIFZhbHVlIGNhbiBlaXRoZXIgYmUgYW4gaW5kZXggb3IgYSBudW1lcmljYWwgdmFsdWUKCQkgKiBUaGUgY29vcmRpbmF0ZSAoMCwgMCkgaXMgYXQgdGhlIHVwcGVyLWxlZnQgY29ybmVyIG9mIHRoZSBjYW52YXMKCQkgKiBAcGFyYW0gdmFsdWUKCQkgKiBAcGFyYW0gaW5kZXgKCQkgKiBAcGFyYW0gZGF0YXNldEluZGV4CgkJICovCgkJZ2V0UGl4ZWxGb3JWYWx1ZTogaGVscGVycy5ub29wLAoKCQkvKioKCQkgKiBVc2VkIHRvIGdldCB0aGUgZGF0YSB2YWx1ZSBmcm9tIGEgZ2l2ZW4gcGl4ZWwuIFRoaXMgaXMgdGhlIGludmVyc2Ugb2YgZ2V0UGl4ZWxGb3JWYWx1ZQoJCSAqIFRoZSBjb29yZGluYXRlICgwLCAwKSBpcyBhdCB0aGUgdXBwZXItbGVmdCBjb3JuZXIgb2YgdGhlIGNhbnZhcwoJCSAqIEBwYXJhbSBwaXhlbAoJCSAqLwoJCWdldFZhbHVlRm9yUGl4ZWw6IGhlbHBlcnMubm9vcCwKCgkJLyoqCgkJICogUmV0dXJucyB0aGUgbG9jYXRpb24gb2YgdGhlIHRpY2sgYXQgdGhlIGdpdmVuIGluZGV4CgkJICogVGhlIGNvb3JkaW5hdGUgKDAsIDApIGlzIGF0IHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgY2FudmFzCgkJICovCgkJZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbihpbmRleCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb2Zmc2V0ID0gbWUub3B0aW9ucy5vZmZzZXQ7CgkJCWlmIChtZS5pc0hvcml6b250YWwoKSkgewoJCQkJdmFyIGlubmVyV2lkdGggPSBtZS53aWR0aCAtIChtZS5wYWRkaW5nTGVmdCArIG1lLnBhZGRpbmdSaWdodCk7CgkJCQl2YXIgdGlja1dpZHRoID0gaW5uZXJXaWR0aCAvIE1hdGgubWF4KChtZS5fdGlja3MubGVuZ3RoIC0gKG9mZnNldCA/IDAgOiAxKSksIDEpOwoJCQkJdmFyIHBpeGVsID0gKHRpY2tXaWR0aCAqIGluZGV4KSArIG1lLnBhZGRpbmdMZWZ0OwoKCQkJCWlmIChvZmZzZXQpIHsKCQkJCQlwaXhlbCArPSB0aWNrV2lkdGggLyAyOwoJCQkJfQoKCQkJCXZhciBmaW5hbFZhbCA9IG1lLmxlZnQgKyBNYXRoLnJvdW5kKHBpeGVsKTsKCQkJCWZpbmFsVmFsICs9IG1lLmlzRnVsbFdpZHRoKCkgPyBtZS5tYXJnaW5zLmxlZnQgOiAwOwoJCQkJcmV0dXJuIGZpbmFsVmFsOwoJCQl9CgkJCXZhciBpbm5lckhlaWdodCA9IG1lLmhlaWdodCAtIChtZS5wYWRkaW5nVG9wICsgbWUucGFkZGluZ0JvdHRvbSk7CgkJCXJldHVybiBtZS50b3AgKyAoaW5kZXggKiAoaW5uZXJIZWlnaHQgLyAobWUuX3RpY2tzLmxlbmd0aCAtIDEpKSk7CgkJfSwKCgkJLyoqCgkJICogVXRpbGl0eSBmb3IgZ2V0dGluZyB0aGUgcGl4ZWwgbG9jYXRpb24gb2YgYSBwZXJjZW50YWdlIG9mIHNjYWxlCgkJICogVGhlIGNvb3JkaW5hdGUgKDAsIDApIGlzIGF0IHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgY2FudmFzCgkJICovCgkJZ2V0UGl4ZWxGb3JEZWNpbWFsOiBmdW5jdGlvbihkZWNpbWFsKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCWlmIChtZS5pc0hvcml6b250YWwoKSkgewoJCQkJdmFyIGlubmVyV2lkdGggPSBtZS53aWR0aCAtIChtZS5wYWRkaW5nTGVmdCArIG1lLnBhZGRpbmdSaWdodCk7CgkJCQl2YXIgdmFsdWVPZmZzZXQgPSAoaW5uZXJXaWR0aCAqIGRlY2ltYWwpICsgbWUucGFkZGluZ0xlZnQ7CgoJCQkJdmFyIGZpbmFsVmFsID0gbWUubGVmdCArIE1hdGgucm91bmQodmFsdWVPZmZzZXQpOwoJCQkJZmluYWxWYWwgKz0gbWUuaXNGdWxsV2lkdGgoKSA/IG1lLm1hcmdpbnMubGVmdCA6IDA7CgkJCQlyZXR1cm4gZmluYWxWYWw7CgkJCX0KCQkJcmV0dXJuIG1lLnRvcCArIChkZWNpbWFsICogbWUuaGVpZ2h0KTsKCQl9LAoKCQkvKioKCQkgKiBSZXR1cm5zIHRoZSBwaXhlbCBmb3IgdGhlIG1pbmltdW0gY2hhcnQgdmFsdWUKCQkgKiBUaGUgY29vcmRpbmF0ZSAoMCwgMCkgaXMgYXQgdGhlIHVwcGVyLWxlZnQgY29ybmVyIG9mIHRoZSBjYW52YXMKCQkgKi8KCQlnZXRCYXNlUGl4ZWw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5nZXRQaXhlbEZvclZhbHVlKHRoaXMuZ2V0QmFzZVZhbHVlKCkpOwoJCX0sCgoJCWdldEJhc2VWYWx1ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtaW4gPSBtZS5taW47CgkJCXZhciBtYXggPSBtZS5tYXg7CgoJCQlyZXR1cm4gbWUuYmVnaW5BdFplcm8gPyAwIDoKCQkJCW1pbiA8IDAgJiYgbWF4IDwgMCA/IG1heCA6CgkJCQltaW4gPiAwICYmIG1heCA+IDAgPyBtaW4gOgoJCQkJMDsKCQl9LAoKCQkvKioKCQkgKiBSZXR1cm5zIGEgc3Vic2V0IG9mIHRpY2tzIHRvIGJlIHBsb3R0ZWQgdG8gYXZvaWQgb3ZlcmxhcHBpbmcgbGFiZWxzLgoJCSAqIEBwcml2YXRlCgkJICovCgkJX2F1dG9Ta2lwOiBmdW5jdGlvbih0aWNrcykgewoJCQl2YXIgc2tpcFJhdGlvOwoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgkJCXZhciBvcHRpb25UaWNrcyA9IG1lLm9wdGlvbnMudGlja3MubWlub3I7CgkJCXZhciB0aWNrQ291bnQgPSB0aWNrcy5sZW5ndGg7CgkJCXZhciBsYWJlbFJvdGF0aW9uUmFkaWFucyA9IGhlbHBlcnMudG9SYWRpYW5zKG1lLmxhYmVsUm90YXRpb24pOwoJCQl2YXIgY29zUm90YXRpb24gPSBNYXRoLmNvcyhsYWJlbFJvdGF0aW9uUmFkaWFucyk7CgkJCXZhciBsb25nZXN0Um90YXRlZExhYmVsID0gbWUubG9uZ2VzdExhYmVsV2lkdGggKiBjb3NSb3RhdGlvbjsKCQkJdmFyIHJlc3VsdCA9IFtdOwoJCQl2YXIgaSwgdGljaywgc2hvdWxkU2tpcDsKCgkJCS8vIGZpZ3VyZSBvdXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIGdyaWRsaW5lcyB0byBzaG93CgkJCXZhciBtYXhUaWNrczsKCQkJaWYgKG9wdGlvblRpY2tzLm1heFRpY2tzTGltaXQpIHsKCQkJCW1heFRpY2tzID0gb3B0aW9uVGlja3MubWF4VGlja3NMaW1pdDsKCQkJfQoKCQkJaWYgKGlzSG9yaXpvbnRhbCkgewoJCQkJc2tpcFJhdGlvID0gZmFsc2U7CgoJCQkJaWYgKChsb25nZXN0Um90YXRlZExhYmVsICsgb3B0aW9uVGlja3MuYXV0b1NraXBQYWRkaW5nKSAqIHRpY2tDb3VudCA+IChtZS53aWR0aCAtIChtZS5wYWRkaW5nTGVmdCArIG1lLnBhZGRpbmdSaWdodCkpKSB7CgkJCQkJc2tpcFJhdGlvID0gMSArIE1hdGguZmxvb3IoKChsb25nZXN0Um90YXRlZExhYmVsICsgb3B0aW9uVGlja3MuYXV0b1NraXBQYWRkaW5nKSAqIHRpY2tDb3VudCkgLyAobWUud2lkdGggLSAobWUucGFkZGluZ0xlZnQgKyBtZS5wYWRkaW5nUmlnaHQpKSk7CgkJCQl9CgoJCQkJLy8gaWYgdGhleSBkZWZpbmVkIGEgbWF4IG51bWJlciBvZiBvcHRpb25UaWNrcywKCQkJCS8vIGluY3JlYXNlIHNraXBSYXRpbyB1bnRpbCB0aGF0IG51bWJlciBpcyBtZXQKCQkJCWlmIChtYXhUaWNrcyAmJiB0aWNrQ291bnQgPiBtYXhUaWNrcykgewoJCQkJCXNraXBSYXRpbyA9IE1hdGgubWF4KHNraXBSYXRpbywgTWF0aC5mbG9vcih0aWNrQ291bnQgLyBtYXhUaWNrcykpOwoJCQkJfQoJCQl9CgoJCQlmb3IgKGkgPSAwOyBpIDwgdGlja0NvdW50OyBpKyspIHsKCQkJCXRpY2sgPSB0aWNrc1tpXTsKCgkJCQkvLyBTaW5jZSB3ZSBhbHdheXMgc2hvdyB0aGUgbGFzdCB0aWNrLHdlIG5lZWQgbWF5IG5lZWQgdG8gaGlkZSB0aGUgbGFzdCBzaG93biBvbmUgYmVmb3JlCgkJCQlzaG91bGRTa2lwID0gKHNraXBSYXRpbyA+IDEgJiYgaSAlIHNraXBSYXRpbyA+IDApIHx8IChpICUgc2tpcFJhdGlvID09PSAwICYmIGkgKyBza2lwUmF0aW8gPj0gdGlja0NvdW50KTsKCQkJCWlmIChzaG91bGRTa2lwICYmIGkgIT09IHRpY2tDb3VudCAtIDEpIHsKCQkJCQkvLyBsZWF2ZSB0aWNrIGluIHBsYWNlIGJ1dCBtYWtlIHN1cmUgaXQncyBub3QgZGlzcGxheWVkICgjNDYzNSkKCQkJCQlkZWxldGUgdGljay5sYWJlbDsKCQkJCX0KCQkJCXJlc3VsdC5wdXNoKHRpY2spOwoJCQl9CgkJCXJldHVybiByZXN1bHQ7CgkJfSwKCgkJLy8gQWN0dWFsbHkgZHJhdyB0aGUgc2NhbGUgb24gdGhlIGNhbnZhcwoJCS8vIEBwYXJhbSB7cmVjdGFuZ2xlfSBjaGFydEFyZWEgOiB0aGUgYXJlYSBvZiB0aGUgY2hhcnQgdG8gZHJhdyBmdWxsIGdyaWQgbGluZXMgb24KCQlkcmF3OiBmdW5jdGlvbihjaGFydEFyZWEpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdGlvbnMgPSBtZS5vcHRpb25zOwoJCQlpZiAoIW9wdGlvbnMuZGlzcGxheSkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl2YXIgY29udGV4dCA9IG1lLmN0eDsKCQkJdmFyIGdsb2JhbERlZmF1bHRzID0gZGVmYXVsdHMuZ2xvYmFsOwoJCQl2YXIgb3B0aW9uVGlja3MgPSBvcHRpb25zLnRpY2tzLm1pbm9yOwoJCQl2YXIgb3B0aW9uTWFqb3JUaWNrcyA9IG9wdGlvbnMudGlja3MubWFqb3IgfHwgb3B0aW9uVGlja3M7CgkJCXZhciBncmlkTGluZXMgPSBvcHRpb25zLmdyaWRMaW5lczsKCQkJdmFyIHNjYWxlTGFiZWwgPSBvcHRpb25zLnNjYWxlTGFiZWw7CgoJCQl2YXIgaXNSb3RhdGVkID0gbWUubGFiZWxSb3RhdGlvbiAhPT0gMDsKCQkJdmFyIGlzSG9yaXpvbnRhbCA9IG1lLmlzSG9yaXpvbnRhbCgpOwoKCQkJdmFyIHRpY2tzID0gb3B0aW9uVGlja3MuYXV0b1NraXAgPyBtZS5fYXV0b1NraXAobWUuZ2V0VGlja3MoKSkgOiBtZS5nZXRUaWNrcygpOwoJCQl2YXIgdGlja0ZvbnRDb2xvciA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQob3B0aW9uVGlja3MuZm9udENvbG9yLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udENvbG9yKTsKCQkJdmFyIHRpY2tGb250ID0gcGFyc2VGb250T3B0aW9ucyhvcHRpb25UaWNrcyk7CgkJCXZhciBtYWpvclRpY2tGb250Q29sb3IgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KG9wdGlvbk1ham9yVGlja3MuZm9udENvbG9yLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udENvbG9yKTsKCQkJdmFyIG1ham9yVGlja0ZvbnQgPSBwYXJzZUZvbnRPcHRpb25zKG9wdGlvbk1ham9yVGlja3MpOwoKCQkJdmFyIHRsID0gZ3JpZExpbmVzLmRyYXdUaWNrcyA/IGdyaWRMaW5lcy50aWNrTWFya0xlbmd0aCA6IDA7CgoJCQl2YXIgc2NhbGVMYWJlbEZvbnRDb2xvciA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQoc2NhbGVMYWJlbC5mb250Q29sb3IsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250Q29sb3IpOwoJCQl2YXIgc2NhbGVMYWJlbEZvbnQgPSBwYXJzZUZvbnRPcHRpb25zKHNjYWxlTGFiZWwpOwoJCQl2YXIgc2NhbGVMYWJlbFBhZGRpbmcgPSBoZWxwZXJzLm9wdGlvbnMudG9QYWRkaW5nKHNjYWxlTGFiZWwucGFkZGluZyk7CgkJCXZhciBsYWJlbFJvdGF0aW9uUmFkaWFucyA9IGhlbHBlcnMudG9SYWRpYW5zKG1lLmxhYmVsUm90YXRpb24pOwoKCQkJdmFyIGl0ZW1zVG9EcmF3ID0gW107CgoJCQl2YXIgYXhpc1dpZHRoID0gbWUub3B0aW9ucy5ncmlkTGluZXMubGluZVdpZHRoOwoJCQl2YXIgeFRpY2tTdGFydCA9IG9wdGlvbnMucG9zaXRpb24gPT09ICdyaWdodCcgPyBtZS5yaWdodCA6IG1lLnJpZ2h0IC0gYXhpc1dpZHRoIC0gdGw7CgkJCXZhciB4VGlja0VuZCA9IG9wdGlvbnMucG9zaXRpb24gPT09ICdyaWdodCcgPyBtZS5yaWdodCArIHRsIDogbWUucmlnaHQ7CgkJCXZhciB5VGlja1N0YXJ0ID0gb3B0aW9ucy5wb3NpdGlvbiA9PT0gJ2JvdHRvbScgPyBtZS50b3AgKyBheGlzV2lkdGggOiBtZS5ib3R0b20gLSB0bCAtIGF4aXNXaWR0aDsKCQkJdmFyIHlUaWNrRW5kID0gb3B0aW9ucy5wb3NpdGlvbiA9PT0gJ2JvdHRvbScgPyBtZS50b3AgKyBheGlzV2lkdGggKyB0bCA6IG1lLmJvdHRvbSArIGF4aXNXaWR0aDsKCgkJCWhlbHBlcnMuZWFjaCh0aWNrcywgZnVuY3Rpb24odGljaywgaW5kZXgpIHsKCQkJCS8vIGF1dG9za2lwcGVyIHNraXBwZWQgdGhpcyB0aWNrICgjNDYzNSkKCQkJCWlmIChoZWxwZXJzLmlzTnVsbE9yVW5kZWYodGljay5sYWJlbCkpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIGxhYmVsID0gdGljay5sYWJlbDsKCQkJCXZhciBsaW5lV2lkdGgsIGxpbmVDb2xvciwgYm9yZGVyRGFzaCwgYm9yZGVyRGFzaE9mZnNldDsKCQkJCWlmIChpbmRleCA9PT0gbWUuemVyb0xpbmVJbmRleCAmJiBvcHRpb25zLm9mZnNldCA9PT0gZ3JpZExpbmVzLm9mZnNldEdyaWRMaW5lcykgewoJCQkJCS8vIERyYXcgdGhlIGZpcnN0IGluZGV4IHNwZWNpYWxseQoJCQkJCWxpbmVXaWR0aCA9IGdyaWRMaW5lcy56ZXJvTGluZVdpZHRoOwoJCQkJCWxpbmVDb2xvciA9IGdyaWRMaW5lcy56ZXJvTGluZUNvbG9yOwoJCQkJCWJvcmRlckRhc2ggPSBncmlkTGluZXMuemVyb0xpbmVCb3JkZXJEYXNoOwoJCQkJCWJvcmRlckRhc2hPZmZzZXQgPSBncmlkTGluZXMuemVyb0xpbmVCb3JkZXJEYXNoT2Zmc2V0OwoJCQkJfSBlbHNlIHsKCQkJCQlsaW5lV2lkdGggPSBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdChncmlkTGluZXMubGluZVdpZHRoLCBpbmRleCk7CgkJCQkJbGluZUNvbG9yID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZ3JpZExpbmVzLmNvbG9yLCBpbmRleCk7CgkJCQkJYm9yZGVyRGFzaCA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQoZ3JpZExpbmVzLmJvcmRlckRhc2gsIGdsb2JhbERlZmF1bHRzLmJvcmRlckRhc2gpOwoJCQkJCWJvcmRlckRhc2hPZmZzZXQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KGdyaWRMaW5lcy5ib3JkZXJEYXNoT2Zmc2V0LCBnbG9iYWxEZWZhdWx0cy5ib3JkZXJEYXNoT2Zmc2V0KTsKCQkJCX0KCgkJCQkvLyBDb21tb24gcHJvcGVydGllcwoJCQkJdmFyIHR4MSwgdHkxLCB0eDIsIHR5MiwgeDEsIHkxLCB4MiwgeTIsIGxhYmVsWCwgbGFiZWxZOwoJCQkJdmFyIHRleHRBbGlnbiA9ICdtaWRkbGUnOwoJCQkJdmFyIHRleHRCYXNlbGluZSA9ICdtaWRkbGUnOwoJCQkJdmFyIHRpY2tQYWRkaW5nID0gb3B0aW9uVGlja3MucGFkZGluZzsKCgkJCQlpZiAoaXNIb3Jpem9udGFsKSB7CgkJCQkJdmFyIGxhYmVsWU9mZnNldCA9IHRsICsgdGlja1BhZGRpbmc7CgoJCQkJCWlmIChvcHRpb25zLnBvc2l0aW9uID09PSAnYm90dG9tJykgewoJCQkJCQkvLyBib3R0b20KCQkJCQkJdGV4dEJhc2VsaW5lID0gIWlzUm90YXRlZCA/ICd0b3AnIDogJ21pZGRsZSc7CgkJCQkJCXRleHRBbGlnbiA9ICFpc1JvdGF0ZWQgPyAnY2VudGVyJyA6ICdyaWdodCc7CgkJCQkJCWxhYmVsWSA9IG1lLnRvcCArIGxhYmVsWU9mZnNldDsKCQkJCQl9IGVsc2UgewoJCQkJCQkvLyB0b3AKCQkJCQkJdGV4dEJhc2VsaW5lID0gIWlzUm90YXRlZCA/ICdib3R0b20nIDogJ21pZGRsZSc7CgkJCQkJCXRleHRBbGlnbiA9ICFpc1JvdGF0ZWQgPyAnY2VudGVyJyA6ICdsZWZ0JzsKCQkJCQkJbGFiZWxZID0gbWUuYm90dG9tIC0gbGFiZWxZT2Zmc2V0OwoJCQkJCX0KCgkJCQkJdmFyIHhMaW5lVmFsdWUgPSBnZXRMaW5lVmFsdWUobWUsIGluZGV4LCBncmlkTGluZXMub2Zmc2V0R3JpZExpbmVzICYmIHRpY2tzLmxlbmd0aCA+IDEpOwoJCQkJCWlmICh4TGluZVZhbHVlIDwgbWUubGVmdCkgewoJCQkJCQlsaW5lQ29sb3IgPSAncmdiYSgwLDAsMCwwKSc7CgkJCQkJfQoJCQkJCXhMaW5lVmFsdWUgKz0gaGVscGVycy5hbGlhc1BpeGVsKGxpbmVXaWR0aCk7CgoJCQkJCWxhYmVsWCA9IG1lLmdldFBpeGVsRm9yVGljayhpbmRleCkgKyBvcHRpb25UaWNrcy5sYWJlbE9mZnNldDsgLy8geCB2YWx1ZXMgZm9yIG9wdGlvblRpY2tzIChuZWVkIHRvIGNvbnNpZGVyIG9mZnNldExhYmVsIG9wdGlvbikKCgkJCQkJdHgxID0gdHgyID0geDEgPSB4MiA9IHhMaW5lVmFsdWU7CgkJCQkJdHkxID0geVRpY2tTdGFydDsKCQkJCQl0eTIgPSB5VGlja0VuZDsKCQkJCQl5MSA9IGNoYXJ0QXJlYS50b3A7CgkJCQkJeTIgPSBjaGFydEFyZWEuYm90dG9tICsgYXhpc1dpZHRoOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgaXNMZWZ0ID0gb3B0aW9ucy5wb3NpdGlvbiA9PT0gJ2xlZnQnOwoJCQkJCXZhciBsYWJlbFhPZmZzZXQ7CgoJCQkJCWlmIChvcHRpb25UaWNrcy5taXJyb3IpIHsKCQkJCQkJdGV4dEFsaWduID0gaXNMZWZ0ID8gJ2xlZnQnIDogJ3JpZ2h0JzsKCQkJCQkJbGFiZWxYT2Zmc2V0ID0gdGlja1BhZGRpbmc7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGV4dEFsaWduID0gaXNMZWZ0ID8gJ3JpZ2h0JyA6ICdsZWZ0JzsKCQkJCQkJbGFiZWxYT2Zmc2V0ID0gdGwgKyB0aWNrUGFkZGluZzsKCQkJCQl9CgoJCQkJCWxhYmVsWCA9IGlzTGVmdCA/IG1lLnJpZ2h0IC0gbGFiZWxYT2Zmc2V0IDogbWUubGVmdCArIGxhYmVsWE9mZnNldDsKCgkJCQkJdmFyIHlMaW5lVmFsdWUgPSBnZXRMaW5lVmFsdWUobWUsIGluZGV4LCBncmlkTGluZXMub2Zmc2V0R3JpZExpbmVzICYmIHRpY2tzLmxlbmd0aCA+IDEpOwoJCQkJCWlmICh5TGluZVZhbHVlIDwgbWUudG9wKSB7CgkJCQkJCWxpbmVDb2xvciA9ICdyZ2JhKDAsMCwwLDApJzsKCQkJCQl9CgkJCQkJeUxpbmVWYWx1ZSArPSBoZWxwZXJzLmFsaWFzUGl4ZWwobGluZVdpZHRoKTsKCgkJCQkJbGFiZWxZID0gbWUuZ2V0UGl4ZWxGb3JUaWNrKGluZGV4KSArIG9wdGlvblRpY2tzLmxhYmVsT2Zmc2V0OwoKCQkJCQl0eDEgPSB4VGlja1N0YXJ0OwoJCQkJCXR4MiA9IHhUaWNrRW5kOwoJCQkJCXgxID0gY2hhcnRBcmVhLmxlZnQ7CgkJCQkJeDIgPSBjaGFydEFyZWEucmlnaHQgKyBheGlzV2lkdGg7CgkJCQkJdHkxID0gdHkyID0geTEgPSB5MiA9IHlMaW5lVmFsdWU7CgkJCQl9CgoJCQkJaXRlbXNUb0RyYXcucHVzaCh7CgkJCQkJdHgxOiB0eDEsCgkJCQkJdHkxOiB0eTEsCgkJCQkJdHgyOiB0eDIsCgkJCQkJdHkyOiB0eTIsCgkJCQkJeDE6IHgxLAoJCQkJCXkxOiB5MSwKCQkJCQl4MjogeDIsCgkJCQkJeTI6IHkyLAoJCQkJCWxhYmVsWDogbGFiZWxYLAoJCQkJCWxhYmVsWTogbGFiZWxZLAoJCQkJCWdsV2lkdGg6IGxpbmVXaWR0aCwKCQkJCQlnbENvbG9yOiBsaW5lQ29sb3IsCgkJCQkJZ2xCb3JkZXJEYXNoOiBib3JkZXJEYXNoLAoJCQkJCWdsQm9yZGVyRGFzaE9mZnNldDogYm9yZGVyRGFzaE9mZnNldCwKCQkJCQlyb3RhdGlvbjogLTEgKiBsYWJlbFJvdGF0aW9uUmFkaWFucywKCQkJCQlsYWJlbDogbGFiZWwsCgkJCQkJbWFqb3I6IHRpY2subWFqb3IsCgkJCQkJdGV4dEJhc2VsaW5lOiB0ZXh0QmFzZWxpbmUsCgkJCQkJdGV4dEFsaWduOiB0ZXh0QWxpZ24KCQkJCX0pOwoJCQl9KTsKCgkJCS8vIERyYXcgYWxsIG9mIHRoZSB0aWNrIGxhYmVscywgdGljayBtYXJrcywgYW5kIGdyaWQgbGluZXMgYXQgdGhlIGNvcnJlY3QgcGxhY2VzCgkJCWhlbHBlcnMuZWFjaChpdGVtc1RvRHJhdywgZnVuY3Rpb24oaXRlbVRvRHJhdykgewoJCQkJaWYgKGdyaWRMaW5lcy5kaXNwbGF5KSB7CgkJCQkJY29udGV4dC5zYXZlKCk7CgkJCQkJY29udGV4dC5saW5lV2lkdGggPSBpdGVtVG9EcmF3LmdsV2lkdGg7CgkJCQkJY29udGV4dC5zdHJva2VTdHlsZSA9IGl0ZW1Ub0RyYXcuZ2xDb2xvcjsKCQkJCQlpZiAoY29udGV4dC5zZXRMaW5lRGFzaCkgewoJCQkJCQljb250ZXh0LnNldExpbmVEYXNoKGl0ZW1Ub0RyYXcuZ2xCb3JkZXJEYXNoKTsKCQkJCQkJY29udGV4dC5saW5lRGFzaE9mZnNldCA9IGl0ZW1Ub0RyYXcuZ2xCb3JkZXJEYXNoT2Zmc2V0OwoJCQkJCX0KCgkJCQkJY29udGV4dC5iZWdpblBhdGgoKTsKCgkJCQkJaWYgKGdyaWRMaW5lcy5kcmF3VGlja3MpIHsKCQkJCQkJY29udGV4dC5tb3ZlVG8oaXRlbVRvRHJhdy50eDEsIGl0ZW1Ub0RyYXcudHkxKTsKCQkJCQkJY29udGV4dC5saW5lVG8oaXRlbVRvRHJhdy50eDIsIGl0ZW1Ub0RyYXcudHkyKTsKCQkJCQl9CgoJCQkJCWlmIChncmlkTGluZXMuZHJhd09uQ2hhcnRBcmVhKSB7CgkJCQkJCWNvbnRleHQubW92ZVRvKGl0ZW1Ub0RyYXcueDEsIGl0ZW1Ub0RyYXcueTEpOwoJCQkJCQljb250ZXh0LmxpbmVUbyhpdGVtVG9EcmF3LngyLCBpdGVtVG9EcmF3LnkyKTsKCQkJCQl9CgoJCQkJCWNvbnRleHQuc3Ryb2tlKCk7CgkJCQkJY29udGV4dC5yZXN0b3JlKCk7CgkJCQl9CgoJCQkJaWYgKG9wdGlvblRpY2tzLmRpc3BsYXkpIHsKCQkJCQkvLyBNYWtlIHN1cmUgd2UgZHJhdyB0ZXh0IGluIHRoZSBjb3JyZWN0IGNvbG9yIGFuZCBmb250CgkJCQkJY29udGV4dC5zYXZlKCk7CgkJCQkJY29udGV4dC50cmFuc2xhdGUoaXRlbVRvRHJhdy5sYWJlbFgsIGl0ZW1Ub0RyYXcubGFiZWxZKTsKCQkJCQljb250ZXh0LnJvdGF0ZShpdGVtVG9EcmF3LnJvdGF0aW9uKTsKCQkJCQljb250ZXh0LmZvbnQgPSBpdGVtVG9EcmF3Lm1ham9yID8gbWFqb3JUaWNrRm9udC5mb250IDogdGlja0ZvbnQuZm9udDsKCQkJCQljb250ZXh0LmZpbGxTdHlsZSA9IGl0ZW1Ub0RyYXcubWFqb3IgPyBtYWpvclRpY2tGb250Q29sb3IgOiB0aWNrRm9udENvbG9yOwoJCQkJCWNvbnRleHQudGV4dEJhc2VsaW5lID0gaXRlbVRvRHJhdy50ZXh0QmFzZWxpbmU7CgkJCQkJY29udGV4dC50ZXh0QWxpZ24gPSBpdGVtVG9EcmF3LnRleHRBbGlnbjsKCgkJCQkJdmFyIGxhYmVsID0gaXRlbVRvRHJhdy5sYWJlbDsKCQkJCQlpZiAoaGVscGVycy5pc0FycmF5KGxhYmVsKSkgewoJCQkJCQl2YXIgbGluZUNvdW50ID0gbGFiZWwubGVuZ3RoOwoJCQkJCQl2YXIgbGluZUhlaWdodCA9IHRpY2tGb250LnNpemUgKiAxLjU7CgkJCQkJCXZhciB5ID0gbWUuaXNIb3Jpem9udGFsKCkgPyAwIDogLWxpbmVIZWlnaHQgKiAobGluZUNvdW50IC0gMSkgLyAyOwoKCQkJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lQ291bnQ7ICsraSkgewoJCQkJCQkJLy8gV2UganVzdCBtYWtlIHN1cmUgdGhlIG11bHRpbGluZSBlbGVtZW50IGlzIGEgc3RyaW5nIGhlcmUuLgoJCQkJCQkJY29udGV4dC5maWxsVGV4dCgnJyArIGxhYmVsW2ldLCAwLCB5KTsKCQkJCQkJCS8vIGFwcGx5IHNhbWUgbGluZVNwYWNpbmcgYXMgY2FsY3VsYXRlZCBAIEwjMzIwCgkJCQkJCQl5ICs9IGxpbmVIZWlnaHQ7CgkJCQkJCX0KCQkJCQl9IGVsc2UgewoJCQkJCQljb250ZXh0LmZpbGxUZXh0KGxhYmVsLCAwLCAwKTsKCQkJCQl9CgkJCQkJY29udGV4dC5yZXN0b3JlKCk7CgkJCQl9CgkJCX0pOwoKCQkJaWYgKHNjYWxlTGFiZWwuZGlzcGxheSkgewoJCQkJLy8gRHJhdyB0aGUgc2NhbGUgbGFiZWwKCQkJCXZhciBzY2FsZUxhYmVsWDsKCQkJCXZhciBzY2FsZUxhYmVsWTsKCQkJCXZhciByb3RhdGlvbiA9IDA7CgkJCQl2YXIgaGFsZkxpbmVIZWlnaHQgPSBwYXJzZUxpbmVIZWlnaHQoc2NhbGVMYWJlbCkgLyAyOwoKCQkJCWlmIChpc0hvcml6b250YWwpIHsKCQkJCQlzY2FsZUxhYmVsWCA9IG1lLmxlZnQgKyAoKG1lLnJpZ2h0IC0gbWUubGVmdCkgLyAyKTsgLy8gbWlkcG9pbnQgb2YgdGhlIHdpZHRoCgkJCQkJc2NhbGVMYWJlbFkgPSBvcHRpb25zLnBvc2l0aW9uID09PSAnYm90dG9tJwoJCQkJCQk/IG1lLmJvdHRvbSAtIGhhbGZMaW5lSGVpZ2h0IC0gc2NhbGVMYWJlbFBhZGRpbmcuYm90dG9tCgkJCQkJCTogbWUudG9wICsgaGFsZkxpbmVIZWlnaHQgKyBzY2FsZUxhYmVsUGFkZGluZy50b3A7CgkJCQl9IGVsc2UgewoJCQkJCXZhciBpc0xlZnQgPSBvcHRpb25zLnBvc2l0aW9uID09PSAnbGVmdCc7CgkJCQkJc2NhbGVMYWJlbFggPSBpc0xlZnQKCQkJCQkJPyBtZS5sZWZ0ICsgaGFsZkxpbmVIZWlnaHQgKyBzY2FsZUxhYmVsUGFkZGluZy50b3AKCQkJCQkJOiBtZS5yaWdodCAtIGhhbGZMaW5lSGVpZ2h0IC0gc2NhbGVMYWJlbFBhZGRpbmcudG9wOwoJCQkJCXNjYWxlTGFiZWxZID0gbWUudG9wICsgKChtZS5ib3R0b20gLSBtZS50b3ApIC8gMik7CgkJCQkJcm90YXRpb24gPSBpc0xlZnQgPyAtMC41ICogTWF0aC5QSSA6IDAuNSAqIE1hdGguUEk7CgkJCQl9CgoJCQkJY29udGV4dC5zYXZlKCk7CgkJCQljb250ZXh0LnRyYW5zbGF0ZShzY2FsZUxhYmVsWCwgc2NhbGVMYWJlbFkpOwoJCQkJY29udGV4dC5yb3RhdGUocm90YXRpb24pOwoJCQkJY29udGV4dC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKCQkJCWNvbnRleHQudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CgkJCQljb250ZXh0LmZpbGxTdHlsZSA9IHNjYWxlTGFiZWxGb250Q29sb3I7IC8vIHJlbmRlciBpbiBjb3JyZWN0IGNvbG91cgoJCQkJY29udGV4dC5mb250ID0gc2NhbGVMYWJlbEZvbnQuZm9udDsKCQkJCWNvbnRleHQuZmlsbFRleHQoc2NhbGVMYWJlbC5sYWJlbFN0cmluZywgMCwgMCk7CgkJCQljb250ZXh0LnJlc3RvcmUoKTsKCQkJfQoKCQkJaWYgKGdyaWRMaW5lcy5kcmF3Qm9yZGVyKSB7CgkJCQkvLyBEcmF3IHRoZSBsaW5lIGF0IHRoZSBlZGdlIG9mIHRoZSBheGlzCgkJCQljb250ZXh0LmxpbmVXaWR0aCA9IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGdyaWRMaW5lcy5saW5lV2lkdGgsIDApOwoJCQkJY29udGV4dC5zdHJva2VTdHlsZSA9IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGdyaWRMaW5lcy5jb2xvciwgMCk7CgkJCQl2YXIgeDEgPSBtZS5sZWZ0OwoJCQkJdmFyIHgyID0gbWUucmlnaHQgKyBheGlzV2lkdGg7CgkJCQl2YXIgeTEgPSBtZS50b3A7CgkJCQl2YXIgeTIgPSBtZS5ib3R0b20gKyBheGlzV2lkdGg7CgoJCQkJdmFyIGFsaWFzUGl4ZWwgPSBoZWxwZXJzLmFsaWFzUGl4ZWwoY29udGV4dC5saW5lV2lkdGgpOwoJCQkJaWYgKGlzSG9yaXpvbnRhbCkgewoJCQkJCXkxID0geTIgPSBvcHRpb25zLnBvc2l0aW9uID09PSAndG9wJyA/IG1lLmJvdHRvbSA6IG1lLnRvcDsKCQkJCQl5MSArPSBhbGlhc1BpeGVsOwoJCQkJCXkyICs9IGFsaWFzUGl4ZWw7CgkJCQl9IGVsc2UgewoJCQkJCXgxID0geDIgPSBvcHRpb25zLnBvc2l0aW9uID09PSAnbGVmdCcgPyBtZS5yaWdodCA6IG1lLmxlZnQ7CgkJCQkJeDEgKz0gYWxpYXNQaXhlbDsKCQkJCQl4MiArPSBhbGlhc1BpeGVsOwoJCQkJfQoKCQkJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgkJCQljb250ZXh0Lm1vdmVUbyh4MSwgeTEpOwoJCQkJY29udGV4dC5saW5lVG8oeDIsIHkyKTsKCQkJCWNvbnRleHQuc3Ryb2tlKCk7CgkJCX0KCQl9Cgl9KTsKfTsKCn0seyIyNSI6MjUsIjI2IjoyNiwiMzQiOjM0LCI0NSI6NDV9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgbGF5b3V0cyA9IHJlcXVpcmUoMzApOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCUNoYXJ0LnNjYWxlU2VydmljZSA9IHsKCQkvLyBTY2FsZSByZWdpc3RyYXRpb24gb2JqZWN0LiBFeHRlbnNpb25zIGNhbiByZWdpc3RlciBuZXcgc2NhbGUgdHlwZXMgKHN1Y2ggYXMgbG9nIG9yIERCIHNjYWxlcykgYW5kIHRoZW4KCQkvLyB1c2UgdGhlIG5ldyBjaGFydCBvcHRpb25zIHRvIGdyYWIgdGhlIGNvcnJlY3Qgc2NhbGUKCQljb25zdHJ1Y3RvcnM6IHt9LAoJCS8vIFVzZSBhIHJlZ2lzdHJhdGlvbiBmdW5jdGlvbiBzbyB0aGF0IHdlIGNhbiBtb3ZlIHRvIGFuIEVTNiBtYXAgd2hlbiB3ZSBubyBsb25nZXIgbmVlZCB0byBzdXBwb3J0CgkJLy8gb2xkIGJyb3dzZXJzCgoJCS8vIFNjYWxlIGNvbmZpZyBkZWZhdWx0cwoJCWRlZmF1bHRzOiB7fSwKCQlyZWdpc3RlclNjYWxlVHlwZTogZnVuY3Rpb24odHlwZSwgc2NhbGVDb25zdHJ1Y3Rvciwgc2NhbGVEZWZhdWx0cykgewoJCQl0aGlzLmNvbnN0cnVjdG9yc1t0eXBlXSA9IHNjYWxlQ29uc3RydWN0b3I7CgkJCXRoaXMuZGVmYXVsdHNbdHlwZV0gPSBoZWxwZXJzLmNsb25lKHNjYWxlRGVmYXVsdHMpOwoJCX0sCgkJZ2V0U2NhbGVDb25zdHJ1Y3RvcjogZnVuY3Rpb24odHlwZSkgewoJCQlyZXR1cm4gdGhpcy5jb25zdHJ1Y3RvcnMuaGFzT3duUHJvcGVydHkodHlwZSkgPyB0aGlzLmNvbnN0cnVjdG9yc1t0eXBlXSA6IHVuZGVmaW5lZDsKCQl9LAoJCWdldFNjYWxlRGVmYXVsdHM6IGZ1bmN0aW9uKHR5cGUpIHsKCQkJLy8gUmV0dXJuIHRoZSBzY2FsZSBkZWZhdWx0cyBtZXJnZWQgd2l0aCB0aGUgZ2xvYmFsIHNldHRpbmdzIHNvIHRoYXQgd2UgYWx3YXlzIHVzZSB0aGUgbGF0ZXN0IG9uZXMKCQkJcmV0dXJuIHRoaXMuZGVmYXVsdHMuaGFzT3duUHJvcGVydHkodHlwZSkgPyBoZWxwZXJzLm1lcmdlKHt9LCBbZGVmYXVsdHMuc2NhbGUsIHRoaXMuZGVmYXVsdHNbdHlwZV1dKSA6IHt9OwoJCX0sCgkJdXBkYXRlU2NhbGVEZWZhdWx0czogZnVuY3Rpb24odHlwZSwgYWRkaXRpb25zKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCWlmIChtZS5kZWZhdWx0cy5oYXNPd25Qcm9wZXJ0eSh0eXBlKSkgewoJCQkJbWUuZGVmYXVsdHNbdHlwZV0gPSBoZWxwZXJzLmV4dGVuZChtZS5kZWZhdWx0c1t0eXBlXSwgYWRkaXRpb25zKTsKCQkJfQoJCX0sCgkJYWRkU2NhbGVzVG9MYXlvdXQ6IGZ1bmN0aW9uKGNoYXJ0KSB7CgkJCS8vIEFkZHMgZWFjaCBzY2FsZSB0byB0aGUgY2hhcnQuYm94ZXMgYXJyYXkgdG8gYmUgc2l6ZWQgYWNjb3JkaW5nbHkKCQkJaGVscGVycy5lYWNoKGNoYXJ0LnNjYWxlcywgZnVuY3Rpb24oc2NhbGUpIHsKCQkJCS8vIFNldCBJTGF5b3V0SXRlbSBwYXJhbWV0ZXJzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJCQkJc2NhbGUuZnVsbFdpZHRoID0gc2NhbGUub3B0aW9ucy5mdWxsV2lkdGg7CgkJCQlzY2FsZS5wb3NpdGlvbiA9IHNjYWxlLm9wdGlvbnMucG9zaXRpb247CgkJCQlzY2FsZS53ZWlnaHQgPSBzY2FsZS5vcHRpb25zLndlaWdodDsKCQkJCWxheW91dHMuYWRkQm94KGNoYXJ0LCBzY2FsZSk7CgkJCX0pOwoJCX0KCX07Cn07Cgp9LHsiMjUiOjI1LCIzMCI6MzAsIjQ1Ijo0NX1dLDM0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCi8qKgogKiBOYW1lc3BhY2UgdG8gaG9sZCBzdGF0aWMgdGljayBnZW5lcmF0aW9uIGZ1bmN0aW9ucwogKiBAbmFtZXNwYWNlIENoYXJ0LlRpY2tzCiAqLwptb2R1bGUuZXhwb3J0cyA9IHsKCS8qKgoJICogTmFtZXNwYWNlIHRvIGhvbGQgZm9ybWF0dGVycyBmb3IgZGlmZmVyZW50IHR5cGVzIG9mIHRpY2tzCgkgKiBAbmFtZXNwYWNlIENoYXJ0LlRpY2tzLmZvcm1hdHRlcnMKCSAqLwoJZm9ybWF0dGVyczogewoJCS8qKgoJCSAqIEZvcm1hdHRlciBmb3IgdmFsdWUgbGFiZWxzCgkJICogQG1ldGhvZCBDaGFydC5UaWNrcy5mb3JtYXR0ZXJzLnZhbHVlcwoJCSAqIEBwYXJhbSB2YWx1ZSB0aGUgdmFsdWUgdG8gZGlzcGxheQoJCSAqIEByZXR1cm4ge1N0cmluZ3xBcnJheX0gdGhlIGxhYmVsIHRvIGRpc3BsYXkKCQkgKi8KCQl2YWx1ZXM6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCXJldHVybiBoZWxwZXJzLmlzQXJyYXkodmFsdWUpID8gdmFsdWUgOiAnJyArIHZhbHVlOwoJCX0sCgoJCS8qKgoJCSAqIEZvcm1hdHRlciBmb3IgbGluZWFyIG51bWVyaWMgdGlja3MKCQkgKiBAbWV0aG9kIENoYXJ0LlRpY2tzLmZvcm1hdHRlcnMubGluZWFyCgkJICogQHBhcmFtIHRpY2tWYWx1ZSB7TnVtYmVyfSB0aGUgdmFsdWUgdG8gYmUgZm9ybWF0dGVkCgkJICogQHBhcmFtIGluZGV4IHtOdW1iZXJ9IHRoZSBwb3NpdGlvbiBvZiB0aGUgdGlja1ZhbHVlIHBhcmFtZXRlciBpbiB0aGUgdGlja3MgYXJyYXkKCQkgKiBAcGFyYW0gdGlja3Mge0FycmF5PE51bWJlcj59IHRoZSBsaXN0IG9mIHRpY2tzIGJlaW5nIGNvbnZlcnRlZAoJCSAqIEByZXR1cm4ge1N0cmluZ30gc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSB0aWNrVmFsdWUgcGFyYW1ldGVyCgkJICovCgkJbGluZWFyOiBmdW5jdGlvbih0aWNrVmFsdWUsIGluZGV4LCB0aWNrcykgewoJCQkvLyBJZiB3ZSBoYXZlIGxvdHMgb2YgdGlja3MsIGRvbid0IHVzZSB0aGUgb25lcwoJCQl2YXIgZGVsdGEgPSB0aWNrcy5sZW5ndGggPiAzID8gdGlja3NbMl0gLSB0aWNrc1sxXSA6IHRpY2tzWzFdIC0gdGlja3NbMF07CgoJCQkvLyBJZiB3ZSBoYXZlIGEgbnVtYmVyIGxpa2UgMi41IGFzIHRoZSBkZWx0YSwgZmlndXJlIG91dCBob3cgbWFueSBkZWNpbWFsIHBsYWNlcyB3ZSBuZWVkCgkJCWlmIChNYXRoLmFicyhkZWx0YSkgPiAxKSB7CgkJCQlpZiAodGlja1ZhbHVlICE9PSBNYXRoLmZsb29yKHRpY2tWYWx1ZSkpIHsKCQkJCQkvLyBub3QgYW4gaW50ZWdlcgoJCQkJCWRlbHRhID0gdGlja1ZhbHVlIC0gTWF0aC5mbG9vcih0aWNrVmFsdWUpOwoJCQkJfQoJCQl9CgoJCQl2YXIgbG9nRGVsdGEgPSBoZWxwZXJzLmxvZzEwKE1hdGguYWJzKGRlbHRhKSk7CgkJCXZhciB0aWNrU3RyaW5nID0gJyc7CgoJCQlpZiAodGlja1ZhbHVlICE9PSAwKSB7CgkJCQl2YXIgbnVtRGVjaW1hbCA9IC0xICogTWF0aC5mbG9vcihsb2dEZWx0YSk7CgkJCQludW1EZWNpbWFsID0gTWF0aC5tYXgoTWF0aC5taW4obnVtRGVjaW1hbCwgMjApLCAwKTsgLy8gdG9GaXhlZCBoYXMgYSBtYXggb2YgMjAgZGVjaW1hbCBwbGFjZXMKCQkJCXRpY2tTdHJpbmcgPSB0aWNrVmFsdWUudG9GaXhlZChudW1EZWNpbWFsKTsKCQkJfSBlbHNlIHsKCQkJCXRpY2tTdHJpbmcgPSAnMCc7IC8vIG5ldmVyIHNob3cgZGVjaW1hbCBwbGFjZXMgZm9yIDAKCQkJfQoKCQkJcmV0dXJuIHRpY2tTdHJpbmc7CgkJfSwKCgkJbG9nYXJpdGhtaWM6IGZ1bmN0aW9uKHRpY2tWYWx1ZSwgaW5kZXgsIHRpY2tzKSB7CgkJCXZhciByZW1haW4gPSB0aWNrVmFsdWUgLyAoTWF0aC5wb3coMTAsIE1hdGguZmxvb3IoaGVscGVycy5sb2cxMCh0aWNrVmFsdWUpKSkpOwoKCQkJaWYgKHRpY2tWYWx1ZSA9PT0gMCkgewoJCQkJcmV0dXJuICcwJzsKCQkJfSBlbHNlIGlmIChyZW1haW4gPT09IDEgfHwgcmVtYWluID09PSAyIHx8IHJlbWFpbiA9PT0gNSB8fCBpbmRleCA9PT0gMCB8fCBpbmRleCA9PT0gdGlja3MubGVuZ3RoIC0gMSkgewoJCQkJcmV0dXJuIHRpY2tWYWx1ZS50b0V4cG9uZW50aWFsKCk7CgkJCX0KCQkJcmV0dXJuICcnOwoJCX0KCX0KfTsKCn0seyI0NSI6NDV9XSwzNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgRWxlbWVudCA9IHJlcXVpcmUoMjYpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewoJdG9vbHRpcHM6IHsKCQllbmFibGVkOiB0cnVlLAoJCWN1c3RvbTogbnVsbCwKCQltb2RlOiAnbmVhcmVzdCcsCgkJcG9zaXRpb246ICdhdmVyYWdlJywKCQlpbnRlcnNlY3Q6IHRydWUsCgkJYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLDAsMCwwLjgpJywKCQl0aXRsZUZvbnRTdHlsZTogJ2JvbGQnLAoJCXRpdGxlU3BhY2luZzogMiwKCQl0aXRsZU1hcmdpbkJvdHRvbTogNiwKCQl0aXRsZUZvbnRDb2xvcjogJyNmZmYnLAoJCXRpdGxlQWxpZ246ICdsZWZ0JywKCQlib2R5U3BhY2luZzogMiwKCQlib2R5Rm9udENvbG9yOiAnI2ZmZicsCgkJYm9keUFsaWduOiAnbGVmdCcsCgkJZm9vdGVyRm9udFN0eWxlOiAnYm9sZCcsCgkJZm9vdGVyU3BhY2luZzogMiwKCQlmb290ZXJNYXJnaW5Ub3A6IDYsCgkJZm9vdGVyRm9udENvbG9yOiAnI2ZmZicsCgkJZm9vdGVyQWxpZ246ICdsZWZ0JywKCQl5UGFkZGluZzogNiwKCQl4UGFkZGluZzogNiwKCQljYXJldFBhZGRpbmc6IDIsCgkJY2FyZXRTaXplOiA1LAoJCWNvcm5lclJhZGl1czogNiwKCQltdWx0aUtleUJhY2tncm91bmQ6ICcjZmZmJywKCQlkaXNwbGF5Q29sb3JzOiB0cnVlLAoJCWJvcmRlckNvbG9yOiAncmdiYSgwLDAsMCwwKScsCgkJYm9yZGVyV2lkdGg6IDAsCgkJY2FsbGJhY2tzOiB7CgkJCS8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW1zLCBkYXRhKQoJCQliZWZvcmVUaXRsZTogaGVscGVycy5ub29wLAoJCQl0aXRsZTogZnVuY3Rpb24odG9vbHRpcEl0ZW1zLCBkYXRhKSB7CgkJCQkvLyBQaWNrIGZpcnN0IHhMYWJlbCBmb3Igbm93CgkJCQl2YXIgdGl0bGUgPSAnJzsKCQkJCXZhciBsYWJlbHMgPSBkYXRhLmxhYmVsczsKCQkJCXZhciBsYWJlbENvdW50ID0gbGFiZWxzID8gbGFiZWxzLmxlbmd0aCA6IDA7CgoJCQkJaWYgKHRvb2x0aXBJdGVtcy5sZW5ndGggPiAwKSB7CgkJCQkJdmFyIGl0ZW0gPSB0b29sdGlwSXRlbXNbMF07CgoJCQkJCWlmIChpdGVtLnhMYWJlbCkgewoJCQkJCQl0aXRsZSA9IGl0ZW0ueExhYmVsOwoJCQkJCX0gZWxzZSBpZiAobGFiZWxDb3VudCA+IDAgJiYgaXRlbS5pbmRleCA8IGxhYmVsQ291bnQpIHsKCQkJCQkJdGl0bGUgPSBsYWJlbHNbaXRlbS5pbmRleF07CgkJCQkJfQoJCQkJfQoKCQkJCXJldHVybiB0aXRsZTsKCQkJfSwKCQkJYWZ0ZXJUaXRsZTogaGVscGVycy5ub29wLAoKCQkJLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbXMsIGRhdGEpCgkJCWJlZm9yZUJvZHk6IGhlbHBlcnMubm9vcCwKCgkJCS8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW0sIGRhdGEpCgkJCWJlZm9yZUxhYmVsOiBoZWxwZXJzLm5vb3AsCgkJCWxhYmVsOiBmdW5jdGlvbih0b29sdGlwSXRlbSwgZGF0YSkgewoJCQkJdmFyIGxhYmVsID0gZGF0YS5kYXRhc2V0c1t0b29sdGlwSXRlbS5kYXRhc2V0SW5kZXhdLmxhYmVsIHx8ICcnOwoKCQkJCWlmIChsYWJlbCkgewoJCQkJCWxhYmVsICs9ICc6ICc7CgkJCQl9CgkJCQlsYWJlbCArPSB0b29sdGlwSXRlbS55TGFiZWw7CgkJCQlyZXR1cm4gbGFiZWw7CgkJCX0sCgkJCWxhYmVsQ29sb3I6IGZ1bmN0aW9uKHRvb2x0aXBJdGVtLCBjaGFydCkgewoJCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YSh0b29sdGlwSXRlbS5kYXRhc2V0SW5kZXgpOwoJCQkJdmFyIGFjdGl2ZUVsZW1lbnQgPSBtZXRhLmRhdGFbdG9vbHRpcEl0ZW0uaW5kZXhdOwoJCQkJdmFyIHZpZXcgPSBhY3RpdmVFbGVtZW50Ll92aWV3OwoJCQkJcmV0dXJuIHsKCQkJCQlib3JkZXJDb2xvcjogdmlldy5ib3JkZXJDb2xvciwKCQkJCQliYWNrZ3JvdW5kQ29sb3I6IHZpZXcuYmFja2dyb3VuZENvbG9yCgkJCQl9OwoJCQl9LAoJCQlsYWJlbFRleHRDb2xvcjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fb3B0aW9ucy5ib2R5Rm9udENvbG9yOwoJCQl9LAoJCQlhZnRlckxhYmVsOiBoZWxwZXJzLm5vb3AsCgoJCQkvLyBBcmdzIGFyZTogKHRvb2x0aXBJdGVtcywgZGF0YSkKCQkJYWZ0ZXJCb2R5OiBoZWxwZXJzLm5vb3AsCgoJCQkvLyBBcmdzIGFyZTogKHRvb2x0aXBJdGVtcywgZGF0YSkKCQkJYmVmb3JlRm9vdGVyOiBoZWxwZXJzLm5vb3AsCgkJCWZvb3RlcjogaGVscGVycy5ub29wLAoJCQlhZnRlckZvb3RlcjogaGVscGVycy5ub29wCgkJfQoJfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCgkvKioKIAkgKiBIZWxwZXIgbWV0aG9kIHRvIG1lcmdlIHRoZSBvcGFjaXR5IGludG8gYSBjb2xvcgogCSAqLwoJZnVuY3Rpb24gbWVyZ2VPcGFjaXR5KGNvbG9yU3RyaW5nLCBvcGFjaXR5KSB7CgkJdmFyIGNvbG9yID0gaGVscGVycy5jb2xvcihjb2xvclN0cmluZyk7CgkJcmV0dXJuIGNvbG9yLmFscGhhKG9wYWNpdHkgKiBjb2xvci5hbHBoYSgpKS5yZ2JhU3RyaW5nKCk7Cgl9CgoJLy8gSGVscGVyIHRvIHB1c2ggb3IgY29uY2F0IGJhc2VkIG9uIGlmIHRoZSAybmQgcGFyYW1ldGVyIGlzIGFuIGFycmF5IG9yIG5vdAoJZnVuY3Rpb24gcHVzaE9yQ29uY2F0KGJhc2UsIHRvUHVzaCkgewoJCWlmICh0b1B1c2gpIHsKCQkJaWYgKGhlbHBlcnMuaXNBcnJheSh0b1B1c2gpKSB7CgkJCQkvLyBiYXNlID0gYmFzZS5jb25jYXQodG9QdXNoKTsKCQkJCUFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KGJhc2UsIHRvUHVzaCk7CgkJCX0gZWxzZSB7CgkJCQliYXNlLnB1c2godG9QdXNoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIGJhc2U7Cgl9CgoJLy8gUHJpdmF0ZSBoZWxwZXIgdG8gY3JlYXRlIGEgdG9vbHRpcCBpdGVtIG1vZGVsCgkvLyBAcGFyYW0gZWxlbWVudCA6IHRoZSBjaGFydCBlbGVtZW50IChwb2ludCwgYXJjLCBiYXIpIHRvIGNyZWF0ZSB0aGUgdG9vbHRpcCBpdGVtIGZvcgoJLy8gQHJldHVybiA6IG5ldyB0b29sdGlwIGl0ZW0KCWZ1bmN0aW9uIGNyZWF0ZVRvb2x0aXBJdGVtKGVsZW1lbnQpIHsKCQl2YXIgeFNjYWxlID0gZWxlbWVudC5feFNjYWxlOwoJCXZhciB5U2NhbGUgPSBlbGVtZW50Ll95U2NhbGUgfHwgZWxlbWVudC5fc2NhbGU7IC8vIGhhbmRsZSByYWRhciB8fCBwb2xhckFyZWEgY2hhcnRzCgkJdmFyIGluZGV4ID0gZWxlbWVudC5faW5kZXg7CgkJdmFyIGRhdGFzZXRJbmRleCA9IGVsZW1lbnQuX2RhdGFzZXRJbmRleDsKCgkJcmV0dXJuIHsKCQkJeExhYmVsOiB4U2NhbGUgPyB4U2NhbGUuZ2V0TGFiZWxGb3JJbmRleChpbmRleCwgZGF0YXNldEluZGV4KSA6ICcnLAoJCQl5TGFiZWw6IHlTY2FsZSA/IHlTY2FsZS5nZXRMYWJlbEZvckluZGV4KGluZGV4LCBkYXRhc2V0SW5kZXgpIDogJycsCgkJCWluZGV4OiBpbmRleCwKCQkJZGF0YXNldEluZGV4OiBkYXRhc2V0SW5kZXgsCgkJCXg6IGVsZW1lbnQuX21vZGVsLngsCgkJCXk6IGVsZW1lbnQuX21vZGVsLnkKCQl9OwoJfQoKCS8qKgoJICogSGVscGVyIHRvIGdldCB0aGUgcmVzZXQgbW9kZWwgZm9yIHRoZSB0b29sdGlwCgkgKiBAcGFyYW0gdG9vbHRpcE9wdHMge09iamVjdH0gdGhlIHRvb2x0aXAgb3B0aW9ucwoJICovCglmdW5jdGlvbiBnZXRCYXNlTW9kZWwodG9vbHRpcE9wdHMpIHsKCQl2YXIgZ2xvYmFsRGVmYXVsdHMgPSBkZWZhdWx0cy5nbG9iYWw7CgkJdmFyIHZhbHVlT3JEZWZhdWx0ID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdDsKCgkJcmV0dXJuIHsKCQkJLy8gUG9zaXRpb25pbmcKCQkJeFBhZGRpbmc6IHRvb2x0aXBPcHRzLnhQYWRkaW5nLAoJCQl5UGFkZGluZzogdG9vbHRpcE9wdHMueVBhZGRpbmcsCgkJCXhBbGlnbjogdG9vbHRpcE9wdHMueEFsaWduLAoJCQl5QWxpZ246IHRvb2x0aXBPcHRzLnlBbGlnbiwKCgkJCS8vIEJvZHkKCQkJYm9keUZvbnRDb2xvcjogdG9vbHRpcE9wdHMuYm9keUZvbnRDb2xvciwKCQkJX2JvZHlGb250RmFtaWx5OiB2YWx1ZU9yRGVmYXVsdCh0b29sdGlwT3B0cy5ib2R5Rm9udEZhbWlseSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRGYW1pbHkpLAoJCQlfYm9keUZvbnRTdHlsZTogdmFsdWVPckRlZmF1bHQodG9vbHRpcE9wdHMuYm9keUZvbnRTdHlsZSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRTdHlsZSksCgkJCV9ib2R5QWxpZ246IHRvb2x0aXBPcHRzLmJvZHlBbGlnbiwKCQkJYm9keUZvbnRTaXplOiB2YWx1ZU9yRGVmYXVsdCh0b29sdGlwT3B0cy5ib2R5Rm9udFNpemUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U2l6ZSksCgkJCWJvZHlTcGFjaW5nOiB0b29sdGlwT3B0cy5ib2R5U3BhY2luZywKCgkJCS8vIFRpdGxlCgkJCXRpdGxlRm9udENvbG9yOiB0b29sdGlwT3B0cy50aXRsZUZvbnRDb2xvciwKCQkJX3RpdGxlRm9udEZhbWlseTogdmFsdWVPckRlZmF1bHQodG9vbHRpcE9wdHMudGl0bGVGb250RmFtaWx5LCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udEZhbWlseSksCgkJCV90aXRsZUZvbnRTdHlsZTogdmFsdWVPckRlZmF1bHQodG9vbHRpcE9wdHMudGl0bGVGb250U3R5bGUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U3R5bGUpLAoJCQl0aXRsZUZvbnRTaXplOiB2YWx1ZU9yRGVmYXVsdCh0b29sdGlwT3B0cy50aXRsZUZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpLAoJCQlfdGl0bGVBbGlnbjogdG9vbHRpcE9wdHMudGl0bGVBbGlnbiwKCQkJdGl0bGVTcGFjaW5nOiB0b29sdGlwT3B0cy50aXRsZVNwYWNpbmcsCgkJCXRpdGxlTWFyZ2luQm90dG9tOiB0b29sdGlwT3B0cy50aXRsZU1hcmdpbkJvdHRvbSwKCgkJCS8vIEZvb3RlcgoJCQlmb290ZXJGb250Q29sb3I6IHRvb2x0aXBPcHRzLmZvb3RlckZvbnRDb2xvciwKCQkJX2Zvb3RlckZvbnRGYW1pbHk6IHZhbHVlT3JEZWZhdWx0KHRvb2x0aXBPcHRzLmZvb3RlckZvbnRGYW1pbHksIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250RmFtaWx5KSwKCQkJX2Zvb3RlckZvbnRTdHlsZTogdmFsdWVPckRlZmF1bHQodG9vbHRpcE9wdHMuZm9vdGVyRm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFN0eWxlKSwKCQkJZm9vdGVyRm9udFNpemU6IHZhbHVlT3JEZWZhdWx0KHRvb2x0aXBPcHRzLmZvb3RlckZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpLAoJCQlfZm9vdGVyQWxpZ246IHRvb2x0aXBPcHRzLmZvb3RlckFsaWduLAoJCQlmb290ZXJTcGFjaW5nOiB0b29sdGlwT3B0cy5mb290ZXJTcGFjaW5nLAoJCQlmb290ZXJNYXJnaW5Ub3A6IHRvb2x0aXBPcHRzLmZvb3Rlck1hcmdpblRvcCwKCgkJCS8vIEFwcGVhcmFuY2UKCQkJY2FyZXRTaXplOiB0b29sdGlwT3B0cy5jYXJldFNpemUsCgkJCWNvcm5lclJhZGl1czogdG9vbHRpcE9wdHMuY29ybmVyUmFkaXVzLAoJCQliYWNrZ3JvdW5kQ29sb3I6IHRvb2x0aXBPcHRzLmJhY2tncm91bmRDb2xvciwKCQkJb3BhY2l0eTogMCwKCQkJbGVnZW5kQ29sb3JCYWNrZ3JvdW5kOiB0b29sdGlwT3B0cy5tdWx0aUtleUJhY2tncm91bmQsCgkJCWRpc3BsYXlDb2xvcnM6IHRvb2x0aXBPcHRzLmRpc3BsYXlDb2xvcnMsCgkJCWJvcmRlckNvbG9yOiB0b29sdGlwT3B0cy5ib3JkZXJDb2xvciwKCQkJYm9yZGVyV2lkdGg6IHRvb2x0aXBPcHRzLmJvcmRlcldpZHRoCgkJfTsKCX0KCgkvKioKCSAqIEdldCB0aGUgc2l6ZSBvZiB0aGUgdG9vbHRpcAoJICovCglmdW5jdGlvbiBnZXRUb29sdGlwU2l6ZSh0b29sdGlwLCBtb2RlbCkgewoJCXZhciBjdHggPSB0b29sdGlwLl9jaGFydC5jdHg7CgoJCXZhciBoZWlnaHQgPSBtb2RlbC55UGFkZGluZyAqIDI7IC8vIFRvb2x0aXAgUGFkZGluZwoJCXZhciB3aWR0aCA9IDA7CgoJCS8vIENvdW50IG9mIGFsbCBsaW5lcyBpbiB0aGUgYm9keQoJCXZhciBib2R5ID0gbW9kZWwuYm9keTsKCQl2YXIgY29tYmluZWRCb2R5TGVuZ3RoID0gYm9keS5yZWR1Y2UoZnVuY3Rpb24oY291bnQsIGJvZHlJdGVtKSB7CgkJCXJldHVybiBjb3VudCArIGJvZHlJdGVtLmJlZm9yZS5sZW5ndGggKyBib2R5SXRlbS5saW5lcy5sZW5ndGggKyBib2R5SXRlbS5hZnRlci5sZW5ndGg7CgkJfSwgMCk7CgkJY29tYmluZWRCb2R5TGVuZ3RoICs9IG1vZGVsLmJlZm9yZUJvZHkubGVuZ3RoICsgbW9kZWwuYWZ0ZXJCb2R5Lmxlbmd0aDsKCgkJdmFyIHRpdGxlTGluZUNvdW50ID0gbW9kZWwudGl0bGUubGVuZ3RoOwoJCXZhciBmb290ZXJMaW5lQ291bnQgPSBtb2RlbC5mb290ZXIubGVuZ3RoOwoJCXZhciB0aXRsZUZvbnRTaXplID0gbW9kZWwudGl0bGVGb250U2l6ZTsKCQl2YXIgYm9keUZvbnRTaXplID0gbW9kZWwuYm9keUZvbnRTaXplOwoJCXZhciBmb290ZXJGb250U2l6ZSA9IG1vZGVsLmZvb3RlckZvbnRTaXplOwoKCQloZWlnaHQgKz0gdGl0bGVMaW5lQ291bnQgKiB0aXRsZUZvbnRTaXplOyAvLyBUaXRsZSBMaW5lcwoJCWhlaWdodCArPSB0aXRsZUxpbmVDb3VudCA/ICh0aXRsZUxpbmVDb3VudCAtIDEpICogbW9kZWwudGl0bGVTcGFjaW5nIDogMDsgLy8gVGl0bGUgTGluZSBTcGFjaW5nCgkJaGVpZ2h0ICs9IHRpdGxlTGluZUNvdW50ID8gbW9kZWwudGl0bGVNYXJnaW5Cb3R0b20gOiAwOyAvLyBUaXRsZSdzIGJvdHRvbSBNYXJnaW4KCQloZWlnaHQgKz0gY29tYmluZWRCb2R5TGVuZ3RoICogYm9keUZvbnRTaXplOyAvLyBCb2R5IExpbmVzCgkJaGVpZ2h0ICs9IGNvbWJpbmVkQm9keUxlbmd0aCA/IChjb21iaW5lZEJvZHlMZW5ndGggLSAxKSAqIG1vZGVsLmJvZHlTcGFjaW5nIDogMDsgLy8gQm9keSBMaW5lIFNwYWNpbmcKCQloZWlnaHQgKz0gZm9vdGVyTGluZUNvdW50ID8gbW9kZWwuZm9vdGVyTWFyZ2luVG9wIDogMDsgLy8gRm9vdGVyIE1hcmdpbgoJCWhlaWdodCArPSBmb290ZXJMaW5lQ291bnQgKiAoZm9vdGVyRm9udFNpemUpOyAvLyBGb290ZXIgTGluZXMKCQloZWlnaHQgKz0gZm9vdGVyTGluZUNvdW50ID8gKGZvb3RlckxpbmVDb3VudCAtIDEpICogbW9kZWwuZm9vdGVyU3BhY2luZyA6IDA7IC8vIEZvb3RlciBMaW5lIFNwYWNpbmcKCgkJLy8gVGl0bGUgd2lkdGgKCQl2YXIgd2lkdGhQYWRkaW5nID0gMDsKCQl2YXIgbWF4TGluZVdpZHRoID0gZnVuY3Rpb24obGluZSkgewoJCQl3aWR0aCA9IE1hdGgubWF4KHdpZHRoLCBjdHgubWVhc3VyZVRleHQobGluZSkud2lkdGggKyB3aWR0aFBhZGRpbmcpOwoJCX07CgoJCWN0eC5mb250ID0gaGVscGVycy5mb250U3RyaW5nKHRpdGxlRm9udFNpemUsIG1vZGVsLl90aXRsZUZvbnRTdHlsZSwgbW9kZWwuX3RpdGxlRm9udEZhbWlseSk7CgkJaGVscGVycy5lYWNoKG1vZGVsLnRpdGxlLCBtYXhMaW5lV2lkdGgpOwoKCQkvLyBCb2R5IHdpZHRoCgkJY3R4LmZvbnQgPSBoZWxwZXJzLmZvbnRTdHJpbmcoYm9keUZvbnRTaXplLCBtb2RlbC5fYm9keUZvbnRTdHlsZSwgbW9kZWwuX2JvZHlGb250RmFtaWx5KTsKCQloZWxwZXJzLmVhY2gobW9kZWwuYmVmb3JlQm9keS5jb25jYXQobW9kZWwuYWZ0ZXJCb2R5KSwgbWF4TGluZVdpZHRoKTsKCgkJLy8gQm9keSBsaW5lcyBtYXkgaW5jbHVkZSBzb21lIGV4dHJhIHdpZHRoIGR1ZSB0byB0aGUgY29sb3IgYm94CgkJd2lkdGhQYWRkaW5nID0gbW9kZWwuZGlzcGxheUNvbG9ycyA/IChib2R5Rm9udFNpemUgKyAyKSA6IDA7CgkJaGVscGVycy5lYWNoKGJvZHksIGZ1bmN0aW9uKGJvZHlJdGVtKSB7CgkJCWhlbHBlcnMuZWFjaChib2R5SXRlbS5iZWZvcmUsIG1heExpbmVXaWR0aCk7CgkJCWhlbHBlcnMuZWFjaChib2R5SXRlbS5saW5lcywgbWF4TGluZVdpZHRoKTsKCQkJaGVscGVycy5lYWNoKGJvZHlJdGVtLmFmdGVyLCBtYXhMaW5lV2lkdGgpOwoJCX0pOwoKCQkvLyBSZXNldCBiYWNrIHRvIDAKCQl3aWR0aFBhZGRpbmcgPSAwOwoKCQkvLyBGb290ZXIgd2lkdGgKCQljdHguZm9udCA9IGhlbHBlcnMuZm9udFN0cmluZyhmb290ZXJGb250U2l6ZSwgbW9kZWwuX2Zvb3RlckZvbnRTdHlsZSwgbW9kZWwuX2Zvb3RlckZvbnRGYW1pbHkpOwoJCWhlbHBlcnMuZWFjaChtb2RlbC5mb290ZXIsIG1heExpbmVXaWR0aCk7CgoJCS8vIEFkZCBwYWRkaW5nCgkJd2lkdGggKz0gMiAqIG1vZGVsLnhQYWRkaW5nOwoKCQlyZXR1cm4gewoJCQl3aWR0aDogd2lkdGgsCgkJCWhlaWdodDogaGVpZ2h0CgkJfTsKCX0KCgkvKioKCSAqIEhlbHBlciB0byBnZXQgdGhlIGFsaWdubWVudCBvZiBhIHRvb2x0aXAgZ2l2ZW4gdGhlIHNpemUKCSAqLwoJZnVuY3Rpb24gZGV0ZXJtaW5lQWxpZ25tZW50KHRvb2x0aXAsIHNpemUpIHsKCQl2YXIgbW9kZWwgPSB0b29sdGlwLl9tb2RlbDsKCQl2YXIgY2hhcnQgPSB0b29sdGlwLl9jaGFydDsKCQl2YXIgY2hhcnRBcmVhID0gdG9vbHRpcC5fY2hhcnQuY2hhcnRBcmVhOwoJCXZhciB4QWxpZ24gPSAnY2VudGVyJzsKCQl2YXIgeUFsaWduID0gJ2NlbnRlcic7CgoJCWlmIChtb2RlbC55IDwgc2l6ZS5oZWlnaHQpIHsKCQkJeUFsaWduID0gJ3RvcCc7CgkJfSBlbHNlIGlmIChtb2RlbC55ID4gKGNoYXJ0LmhlaWdodCAtIHNpemUuaGVpZ2h0KSkgewoJCQl5QWxpZ24gPSAnYm90dG9tJzsKCQl9CgoJCXZhciBsZiwgcmY7IC8vIGZ1bmN0aW9ucyB0byBkZXRlcm1pbmUgbGVmdCwgcmlnaHQgYWxpZ25tZW50CgkJdmFyIG9sZiwgb3JmOyAvLyBmdW5jdGlvbnMgdG8gZGV0ZXJtaW5lIGlmIGxlZnQvcmlnaHQgYWxpZ25tZW50IGNhdXNlcyB0b29sdGlwIHRvIGdvIG91dHNpZGUgY2hhcnQKCQl2YXIgeWY7IC8vIGZ1bmN0aW9uIHRvIGdldCB0aGUgeSBhbGlnbm1lbnQgaWYgdGhlIHRvb2x0aXAgZ29lcyBvdXRzaWRlIG9mIHRoZSBsZWZ0IG9yIHJpZ2h0IGVkZ2VzCgkJdmFyIG1pZFggPSAoY2hhcnRBcmVhLmxlZnQgKyBjaGFydEFyZWEucmlnaHQpIC8gMjsKCQl2YXIgbWlkWSA9IChjaGFydEFyZWEudG9wICsgY2hhcnRBcmVhLmJvdHRvbSkgLyAyOwoKCQlpZiAoeUFsaWduID09PSAnY2VudGVyJykgewoJCQlsZiA9IGZ1bmN0aW9uKHgpIHsKCQkJCXJldHVybiB4IDw9IG1pZFg7CgkJCX07CgkJCXJmID0gZnVuY3Rpb24oeCkgewoJCQkJcmV0dXJuIHggPiBtaWRYOwoJCQl9OwoJCX0gZWxzZSB7CgkJCWxmID0gZnVuY3Rpb24oeCkgewoJCQkJcmV0dXJuIHggPD0gKHNpemUud2lkdGggLyAyKTsKCQkJfTsKCQkJcmYgPSBmdW5jdGlvbih4KSB7CgkJCQlyZXR1cm4geCA+PSAoY2hhcnQud2lkdGggLSAoc2l6ZS53aWR0aCAvIDIpKTsKCQkJfTsKCQl9CgoJCW9sZiA9IGZ1bmN0aW9uKHgpIHsKCQkJcmV0dXJuIHggKyBzaXplLndpZHRoICsgbW9kZWwuY2FyZXRTaXplICsgbW9kZWwuY2FyZXRQYWRkaW5nID4gY2hhcnQud2lkdGg7CgkJfTsKCQlvcmYgPSBmdW5jdGlvbih4KSB7CgkJCXJldHVybiB4IC0gc2l6ZS53aWR0aCAtIG1vZGVsLmNhcmV0U2l6ZSAtIG1vZGVsLmNhcmV0UGFkZGluZyA8IDA7CgkJfTsKCQl5ZiA9IGZ1bmN0aW9uKHkpIHsKCQkJcmV0dXJuIHkgPD0gbWlkWSA/ICd0b3AnIDogJ2JvdHRvbSc7CgkJfTsKCgkJaWYgKGxmKG1vZGVsLngpKSB7CgkJCXhBbGlnbiA9ICdsZWZ0JzsKCgkJCS8vIElzIHRvb2x0aXAgdG9vIHdpZGUgYW5kIGdvZXMgb3ZlciB0aGUgcmlnaHQgc2lkZSBvZiB0aGUgY2hhcnQuPwoJCQlpZiAob2xmKG1vZGVsLngpKSB7CgkJCQl4QWxpZ24gPSAnY2VudGVyJzsKCQkJCXlBbGlnbiA9IHlmKG1vZGVsLnkpOwoJCQl9CgkJfSBlbHNlIGlmIChyZihtb2RlbC54KSkgewoJCQl4QWxpZ24gPSAncmlnaHQnOwoKCQkJLy8gSXMgdG9vbHRpcCB0b28gd2lkZSBhbmQgZ29lcyBvdXRzaWRlIGxlZnQgZWRnZSBvZiBjYW52YXM/CgkJCWlmIChvcmYobW9kZWwueCkpIHsKCQkJCXhBbGlnbiA9ICdjZW50ZXInOwoJCQkJeUFsaWduID0geWYobW9kZWwueSk7CgkJCX0KCQl9CgoJCXZhciBvcHRzID0gdG9vbHRpcC5fb3B0aW9uczsKCQlyZXR1cm4gewoJCQl4QWxpZ246IG9wdHMueEFsaWduID8gb3B0cy54QWxpZ24gOiB4QWxpZ24sCgkJCXlBbGlnbjogb3B0cy55QWxpZ24gPyBvcHRzLnlBbGlnbiA6IHlBbGlnbgoJCX07Cgl9CgoJLyoqCgkgKiBASGVscGVyIHRvIGdldCB0aGUgbG9jYXRpb24gYSB0b29sdGlwIG5lZWRzIHRvIGJlIHBsYWNlZCBhdCBnaXZlbiB0aGUgaW5pdGlhbCBwb3NpdGlvbiAodmlhIHRoZSB2bSkgYW5kIHRoZSBzaXplIGFuZCBhbGlnbm1lbnQKCSAqLwoJZnVuY3Rpb24gZ2V0QmFja2dyb3VuZFBvaW50KHZtLCBzaXplLCBhbGlnbm1lbnQsIGNoYXJ0KSB7CgkJLy8gQmFja2dyb3VuZCBQb3NpdGlvbgoJCXZhciB4ID0gdm0ueDsKCQl2YXIgeSA9IHZtLnk7CgoJCXZhciBjYXJldFNpemUgPSB2bS5jYXJldFNpemU7CgkJdmFyIGNhcmV0UGFkZGluZyA9IHZtLmNhcmV0UGFkZGluZzsKCQl2YXIgY29ybmVyUmFkaXVzID0gdm0uY29ybmVyUmFkaXVzOwoJCXZhciB4QWxpZ24gPSBhbGlnbm1lbnQueEFsaWduOwoJCXZhciB5QWxpZ24gPSBhbGlnbm1lbnQueUFsaWduOwoJCXZhciBwYWRkaW5nQW5kU2l6ZSA9IGNhcmV0U2l6ZSArIGNhcmV0UGFkZGluZzsKCQl2YXIgcmFkaXVzQW5kUGFkZGluZyA9IGNvcm5lclJhZGl1cyArIGNhcmV0UGFkZGluZzsKCgkJaWYgKHhBbGlnbiA9PT0gJ3JpZ2h0JykgewoJCQl4IC09IHNpemUud2lkdGg7CgkJfSBlbHNlIGlmICh4QWxpZ24gPT09ICdjZW50ZXInKSB7CgkJCXggLT0gKHNpemUud2lkdGggLyAyKTsKCQkJaWYgKHggKyBzaXplLndpZHRoID4gY2hhcnQud2lkdGgpIHsKCQkJCXggPSBjaGFydC53aWR0aCAtIHNpemUud2lkdGg7CgkJCX0KCQkJaWYgKHggPCAwKSB7CgkJCQl4ID0gMDsKCQkJfQoJCX0KCgkJaWYgKHlBbGlnbiA9PT0gJ3RvcCcpIHsKCQkJeSArPSBwYWRkaW5nQW5kU2l6ZTsKCQl9IGVsc2UgaWYgKHlBbGlnbiA9PT0gJ2JvdHRvbScpIHsKCQkJeSAtPSBzaXplLmhlaWdodCArIHBhZGRpbmdBbmRTaXplOwoJCX0gZWxzZSB7CgkJCXkgLT0gKHNpemUuaGVpZ2h0IC8gMik7CgkJfQoKCQlpZiAoeUFsaWduID09PSAnY2VudGVyJykgewoJCQlpZiAoeEFsaWduID09PSAnbGVmdCcpIHsKCQkJCXggKz0gcGFkZGluZ0FuZFNpemU7CgkJCX0gZWxzZSBpZiAoeEFsaWduID09PSAncmlnaHQnKSB7CgkJCQl4IC09IHBhZGRpbmdBbmRTaXplOwoJCQl9CgkJfSBlbHNlIGlmICh4QWxpZ24gPT09ICdsZWZ0JykgewoJCQl4IC09IHJhZGl1c0FuZFBhZGRpbmc7CgkJfSBlbHNlIGlmICh4QWxpZ24gPT09ICdyaWdodCcpIHsKCQkJeCArPSByYWRpdXNBbmRQYWRkaW5nOwoJCX0KCgkJcmV0dXJuIHsKCQkJeDogeCwKCQkJeTogeQoJCX07Cgl9CgoJQ2hhcnQuVG9vbHRpcCA9IEVsZW1lbnQuZXh0ZW5kKHsKCQlpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fbW9kZWwgPSBnZXRCYXNlTW9kZWwodGhpcy5fb3B0aW9ucyk7CgkJCXRoaXMuX2xhc3RBY3RpdmUgPSBbXTsKCQl9LAoKCQkvLyBHZXQgdGhlIHRpdGxlCgkJLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbSwgZGF0YSkKCQlnZXRUaXRsZTogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBvcHRzID0gbWUuX29wdGlvbnM7CgkJCXZhciBjYWxsYmFja3MgPSBvcHRzLmNhbGxiYWNrczsKCgkJCXZhciBiZWZvcmVUaXRsZSA9IGNhbGxiYWNrcy5iZWZvcmVUaXRsZS5hcHBseShtZSwgYXJndW1lbnRzKTsKCQkJdmFyIHRpdGxlID0gY2FsbGJhY2tzLnRpdGxlLmFwcGx5KG1lLCBhcmd1bWVudHMpOwoJCQl2YXIgYWZ0ZXJUaXRsZSA9IGNhbGxiYWNrcy5hZnRlclRpdGxlLmFwcGx5KG1lLCBhcmd1bWVudHMpOwoKCQkJdmFyIGxpbmVzID0gW107CgkJCWxpbmVzID0gcHVzaE9yQ29uY2F0KGxpbmVzLCBiZWZvcmVUaXRsZSk7CgkJCWxpbmVzID0gcHVzaE9yQ29uY2F0KGxpbmVzLCB0aXRsZSk7CgkJCWxpbmVzID0gcHVzaE9yQ29uY2F0KGxpbmVzLCBhZnRlclRpdGxlKTsKCgkJCXJldHVybiBsaW5lczsKCQl9LAoKCQkvLyBBcmdzIGFyZTogKHRvb2x0aXBJdGVtLCBkYXRhKQoJCWdldEJlZm9yZUJvZHk6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbGluZXMgPSB0aGlzLl9vcHRpb25zLmNhbGxiYWNrcy5iZWZvcmVCb2R5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJCXJldHVybiBoZWxwZXJzLmlzQXJyYXkobGluZXMpID8gbGluZXMgOiBsaW5lcyAhPT0gdW5kZWZpbmVkID8gW2xpbmVzXSA6IFtdOwoJCX0sCgoJCS8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW0sIGRhdGEpCgkJZ2V0Qm9keTogZnVuY3Rpb24odG9vbHRpcEl0ZW1zLCBkYXRhKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBjYWxsYmFja3MgPSBtZS5fb3B0aW9ucy5jYWxsYmFja3M7CgkJCXZhciBib2R5SXRlbXMgPSBbXTsKCgkJCWhlbHBlcnMuZWFjaCh0b29sdGlwSXRlbXMsIGZ1bmN0aW9uKHRvb2x0aXBJdGVtKSB7CgkJCQl2YXIgYm9keUl0ZW0gPSB7CgkJCQkJYmVmb3JlOiBbXSwKCQkJCQlsaW5lczogW10sCgkJCQkJYWZ0ZXI6IFtdCgkJCQl9OwoJCQkJcHVzaE9yQ29uY2F0KGJvZHlJdGVtLmJlZm9yZSwgY2FsbGJhY2tzLmJlZm9yZUxhYmVsLmNhbGwobWUsIHRvb2x0aXBJdGVtLCBkYXRhKSk7CgkJCQlwdXNoT3JDb25jYXQoYm9keUl0ZW0ubGluZXMsIGNhbGxiYWNrcy5sYWJlbC5jYWxsKG1lLCB0b29sdGlwSXRlbSwgZGF0YSkpOwoJCQkJcHVzaE9yQ29uY2F0KGJvZHlJdGVtLmFmdGVyLCBjYWxsYmFja3MuYWZ0ZXJMYWJlbC5jYWxsKG1lLCB0b29sdGlwSXRlbSwgZGF0YSkpOwoKCQkJCWJvZHlJdGVtcy5wdXNoKGJvZHlJdGVtKTsKCQkJfSk7CgoJCQlyZXR1cm4gYm9keUl0ZW1zOwoJCX0sCgoJCS8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW0sIGRhdGEpCgkJZ2V0QWZ0ZXJCb2R5OiBmdW5jdGlvbigpIHsKCQkJdmFyIGxpbmVzID0gdGhpcy5fb3B0aW9ucy5jYWxsYmFja3MuYWZ0ZXJCb2R5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJCXJldHVybiBoZWxwZXJzLmlzQXJyYXkobGluZXMpID8gbGluZXMgOiBsaW5lcyAhPT0gdW5kZWZpbmVkID8gW2xpbmVzXSA6IFtdOwoJCX0sCgoJCS8vIEdldCB0aGUgZm9vdGVyIGFuZCBiZWZvcmVGb290ZXIgYW5kIGFmdGVyRm9vdGVyIGxpbmVzCgkJLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbSwgZGF0YSkKCQlnZXRGb290ZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgY2FsbGJhY2tzID0gbWUuX29wdGlvbnMuY2FsbGJhY2tzOwoKCQkJdmFyIGJlZm9yZUZvb3RlciA9IGNhbGxiYWNrcy5iZWZvcmVGb290ZXIuYXBwbHkobWUsIGFyZ3VtZW50cyk7CgkJCXZhciBmb290ZXIgPSBjYWxsYmFja3MuZm9vdGVyLmFwcGx5KG1lLCBhcmd1bWVudHMpOwoJCQl2YXIgYWZ0ZXJGb290ZXIgPSBjYWxsYmFja3MuYWZ0ZXJGb290ZXIuYXBwbHkobWUsIGFyZ3VtZW50cyk7CgoJCQl2YXIgbGluZXMgPSBbXTsKCQkJbGluZXMgPSBwdXNoT3JDb25jYXQobGluZXMsIGJlZm9yZUZvb3Rlcik7CgkJCWxpbmVzID0gcHVzaE9yQ29uY2F0KGxpbmVzLCBmb290ZXIpOwoJCQlsaW5lcyA9IHB1c2hPckNvbmNhdChsaW5lcywgYWZ0ZXJGb290ZXIpOwoKCQkJcmV0dXJuIGxpbmVzOwoJCX0sCgoJCXVwZGF0ZTogZnVuY3Rpb24oY2hhbmdlZCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0cyA9IG1lLl9vcHRpb25zOwoKCQkJLy8gTmVlZCB0byByZWdlbmVyYXRlIHRoZSBtb2RlbCBiZWNhdXNlIGl0cyBmYXN0ZXIgdGhhbiB1c2luZyBleHRlbmQgYW5kIGl0IGlzIG5lY2Vzc2FyeSBkdWUgdG8gdGhlIG9wdGltaXphdGlvbiBpbiBDaGFydC5FbGVtZW50LnRyYW5zaXRpb24KCQkJLy8gdGhhdCBkb2VzIF92aWV3ID0gX21vZGVsIGlmIGVhc2UgPT09IDEuIFRoaXMgY2F1c2VzIHRoZSAybmQgdG9vbHRpcCB1cGRhdGUgdG8gc2V0IHByb3BlcnRpZXMgaW4gYm90aCB0aGUgdmlldyBhbmQgbW9kZWwgYXQgdGhlIHNhbWUgdGltZQoJCQkvLyB3aGljaCBicmVha3MgYW55IGFuaW1hdGlvbnMuCgkJCXZhciBleGlzdGluZ01vZGVsID0gbWUuX21vZGVsOwoJCQl2YXIgbW9kZWwgPSBtZS5fbW9kZWwgPSBnZXRCYXNlTW9kZWwob3B0cyk7CgkJCXZhciBhY3RpdmUgPSBtZS5fYWN0aXZlOwoKCQkJdmFyIGRhdGEgPSBtZS5fZGF0YTsKCgkJCS8vIEluIHRoZSBjYXNlIHdoZXJlIGFjdGl2ZS5sZW5ndGggPT09IDAgd2UgbmVlZCB0byBrZWVwIHRoZXNlIGF0IGV4aXN0aW5nIHZhbHVlcyBmb3IgZ29vZCBhbmltYXRpb25zCgkJCXZhciBhbGlnbm1lbnQgPSB7CgkJCQl4QWxpZ246IGV4aXN0aW5nTW9kZWwueEFsaWduLAoJCQkJeUFsaWduOiBleGlzdGluZ01vZGVsLnlBbGlnbgoJCQl9OwoJCQl2YXIgYmFja2dyb3VuZFBvaW50ID0gewoJCQkJeDogZXhpc3RpbmdNb2RlbC54LAoJCQkJeTogZXhpc3RpbmdNb2RlbC55CgkJCX07CgkJCXZhciB0b29sdGlwU2l6ZSA9IHsKCQkJCXdpZHRoOiBleGlzdGluZ01vZGVsLndpZHRoLAoJCQkJaGVpZ2h0OiBleGlzdGluZ01vZGVsLmhlaWdodAoJCQl9OwoJCQl2YXIgdG9vbHRpcFBvc2l0aW9uID0gewoJCQkJeDogZXhpc3RpbmdNb2RlbC5jYXJldFgsCgkJCQl5OiBleGlzdGluZ01vZGVsLmNhcmV0WQoJCQl9OwoKCQkJdmFyIGksIGxlbjsKCgkJCWlmIChhY3RpdmUubGVuZ3RoKSB7CgkJCQltb2RlbC5vcGFjaXR5ID0gMTsKCgkJCQl2YXIgbGFiZWxDb2xvcnMgPSBbXTsKCQkJCXZhciBsYWJlbFRleHRDb2xvcnMgPSBbXTsKCQkJCXRvb2x0aXBQb3NpdGlvbiA9IENoYXJ0LlRvb2x0aXAucG9zaXRpb25lcnNbb3B0cy5wb3NpdGlvbl0uY2FsbChtZSwgYWN0aXZlLCBtZS5fZXZlbnRQb3NpdGlvbik7CgoJCQkJdmFyIHRvb2x0aXBJdGVtcyA9IFtdOwoJCQkJZm9yIChpID0gMCwgbGVuID0gYWN0aXZlLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CgkJCQkJdG9vbHRpcEl0ZW1zLnB1c2goY3JlYXRlVG9vbHRpcEl0ZW0oYWN0aXZlW2ldKSk7CgkJCQl9CgoJCQkJLy8gSWYgdGhlIHVzZXIgcHJvdmlkZWQgYSBmaWx0ZXIgZnVuY3Rpb24sIHVzZSBpdCB0byBtb2RpZnkgdGhlIHRvb2x0aXAgaXRlbXMKCQkJCWlmIChvcHRzLmZpbHRlcikgewoJCQkJCXRvb2x0aXBJdGVtcyA9IHRvb2x0aXBJdGVtcy5maWx0ZXIoZnVuY3Rpb24oYSkgewoJCQkJCQlyZXR1cm4gb3B0cy5maWx0ZXIoYSwgZGF0YSk7CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gSWYgdGhlIHVzZXIgcHJvdmlkZWQgYSBzb3J0aW5nIGZ1bmN0aW9uLCB1c2UgaXQgdG8gbW9kaWZ5IHRoZSB0b29sdGlwIGl0ZW1zCgkJCQlpZiAob3B0cy5pdGVtU29ydCkgewoJCQkJCXRvb2x0aXBJdGVtcyA9IHRvb2x0aXBJdGVtcy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKCQkJCQkJcmV0dXJuIG9wdHMuaXRlbVNvcnQoYSwgYiwgZGF0YSk7CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gRGV0ZXJtaW5lIGNvbG9ycyBmb3IgYm94ZXMKCQkJCWhlbHBlcnMuZWFjaCh0b29sdGlwSXRlbXMsIGZ1bmN0aW9uKHRvb2x0aXBJdGVtKSB7CgkJCQkJbGFiZWxDb2xvcnMucHVzaChvcHRzLmNhbGxiYWNrcy5sYWJlbENvbG9yLmNhbGwobWUsIHRvb2x0aXBJdGVtLCBtZS5fY2hhcnQpKTsKCQkJCQlsYWJlbFRleHRDb2xvcnMucHVzaChvcHRzLmNhbGxiYWNrcy5sYWJlbFRleHRDb2xvci5jYWxsKG1lLCB0b29sdGlwSXRlbSwgbWUuX2NoYXJ0KSk7CgkJCQl9KTsKCgoJCQkJLy8gQnVpbGQgdGhlIFRleHQgTGluZXMKCQkJCW1vZGVsLnRpdGxlID0gbWUuZ2V0VGl0bGUodG9vbHRpcEl0ZW1zLCBkYXRhKTsKCQkJCW1vZGVsLmJlZm9yZUJvZHkgPSBtZS5nZXRCZWZvcmVCb2R5KHRvb2x0aXBJdGVtcywgZGF0YSk7CgkJCQltb2RlbC5ib2R5ID0gbWUuZ2V0Qm9keSh0b29sdGlwSXRlbXMsIGRhdGEpOwoJCQkJbW9kZWwuYWZ0ZXJCb2R5ID0gbWUuZ2V0QWZ0ZXJCb2R5KHRvb2x0aXBJdGVtcywgZGF0YSk7CgkJCQltb2RlbC5mb290ZXIgPSBtZS5nZXRGb290ZXIodG9vbHRpcEl0ZW1zLCBkYXRhKTsKCgkJCQkvLyBJbml0aWFsIHBvc2l0aW9uaW5nIGFuZCBjb2xvcnMKCQkJCW1vZGVsLnggPSBNYXRoLnJvdW5kKHRvb2x0aXBQb3NpdGlvbi54KTsKCQkJCW1vZGVsLnkgPSBNYXRoLnJvdW5kKHRvb2x0aXBQb3NpdGlvbi55KTsKCQkJCW1vZGVsLmNhcmV0UGFkZGluZyA9IG9wdHMuY2FyZXRQYWRkaW5nOwoJCQkJbW9kZWwubGFiZWxDb2xvcnMgPSBsYWJlbENvbG9yczsKCQkJCW1vZGVsLmxhYmVsVGV4dENvbG9ycyA9IGxhYmVsVGV4dENvbG9yczsKCgkJCQkvLyBkYXRhIHBvaW50cwoJCQkJbW9kZWwuZGF0YVBvaW50cyA9IHRvb2x0aXBJdGVtczsKCgkJCQkvLyBXZSBuZWVkIHRvIGRldGVybWluZSBhbGlnbm1lbnQgb2YgdGhlIHRvb2x0aXAKCQkJCXRvb2x0aXBTaXplID0gZ2V0VG9vbHRpcFNpemUodGhpcywgbW9kZWwpOwoJCQkJYWxpZ25tZW50ID0gZGV0ZXJtaW5lQWxpZ25tZW50KHRoaXMsIHRvb2x0aXBTaXplKTsKCQkJCS8vIEZpbmFsIFNpemUgYW5kIFBvc2l0aW9uCgkJCQliYWNrZ3JvdW5kUG9pbnQgPSBnZXRCYWNrZ3JvdW5kUG9pbnQobW9kZWwsIHRvb2x0aXBTaXplLCBhbGlnbm1lbnQsIG1lLl9jaGFydCk7CgkJCX0gZWxzZSB7CgkJCQltb2RlbC5vcGFjaXR5ID0gMDsKCQkJfQoKCQkJbW9kZWwueEFsaWduID0gYWxpZ25tZW50LnhBbGlnbjsKCQkJbW9kZWwueUFsaWduID0gYWxpZ25tZW50LnlBbGlnbjsKCQkJbW9kZWwueCA9IGJhY2tncm91bmRQb2ludC54OwoJCQltb2RlbC55ID0gYmFja2dyb3VuZFBvaW50Lnk7CgkJCW1vZGVsLndpZHRoID0gdG9vbHRpcFNpemUud2lkdGg7CgkJCW1vZGVsLmhlaWdodCA9IHRvb2x0aXBTaXplLmhlaWdodDsKCgkJCS8vIFBvaW50IHdoZXJlIHRoZSBjYXJldCBvbiB0aGUgdG9vbHRpcCBwb2ludHMgdG8KCQkJbW9kZWwuY2FyZXRYID0gdG9vbHRpcFBvc2l0aW9uLng7CgkJCW1vZGVsLmNhcmV0WSA9IHRvb2x0aXBQb3NpdGlvbi55OwoKCQkJbWUuX21vZGVsID0gbW9kZWw7CgoJCQlpZiAoY2hhbmdlZCAmJiBvcHRzLmN1c3RvbSkgewoJCQkJb3B0cy5jdXN0b20uY2FsbChtZSwgbW9kZWwpOwoJCQl9CgoJCQlyZXR1cm4gbWU7CgkJfSwKCQlkcmF3Q2FyZXQ6IGZ1bmN0aW9uKHRvb2x0aXBQb2ludCwgc2l6ZSkgewoJCQl2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwoJCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCQl2YXIgY2FyZXRQb3NpdGlvbiA9IHRoaXMuZ2V0Q2FyZXRQb3NpdGlvbih0b29sdGlwUG9pbnQsIHNpemUsIHZtKTsKCgkJCWN0eC5saW5lVG8oY2FyZXRQb3NpdGlvbi54MSwgY2FyZXRQb3NpdGlvbi55MSk7CgkJCWN0eC5saW5lVG8oY2FyZXRQb3NpdGlvbi54MiwgY2FyZXRQb3NpdGlvbi55Mik7CgkJCWN0eC5saW5lVG8oY2FyZXRQb3NpdGlvbi54MywgY2FyZXRQb3NpdGlvbi55Myk7CgkJfSwKCQlnZXRDYXJldFBvc2l0aW9uOiBmdW5jdGlvbih0b29sdGlwUG9pbnQsIHNpemUsIHZtKSB7CgkJCXZhciB4MSwgeDIsIHgzLCB5MSwgeTIsIHkzOwoJCQl2YXIgY2FyZXRTaXplID0gdm0uY2FyZXRTaXplOwoJCQl2YXIgY29ybmVyUmFkaXVzID0gdm0uY29ybmVyUmFkaXVzOwoJCQl2YXIgeEFsaWduID0gdm0ueEFsaWduOwoJCQl2YXIgeUFsaWduID0gdm0ueUFsaWduOwoJCQl2YXIgcHRYID0gdG9vbHRpcFBvaW50Lng7CgkJCXZhciBwdFkgPSB0b29sdGlwUG9pbnQueTsKCQkJdmFyIHdpZHRoID0gc2l6ZS53aWR0aDsKCQkJdmFyIGhlaWdodCA9IHNpemUuaGVpZ2h0OwoKCQkJaWYgKHlBbGlnbiA9PT0gJ2NlbnRlcicpIHsKCQkJCXkyID0gcHRZICsgKGhlaWdodCAvIDIpOwoKCQkJCWlmICh4QWxpZ24gPT09ICdsZWZ0JykgewoJCQkJCXgxID0gcHRYOwoJCQkJCXgyID0geDEgLSBjYXJldFNpemU7CgkJCQkJeDMgPSB4MTsKCgkJCQkJeTEgPSB5MiArIGNhcmV0U2l6ZTsKCQkJCQl5MyA9IHkyIC0gY2FyZXRTaXplOwoJCQkJfSBlbHNlIHsKCQkJCQl4MSA9IHB0WCArIHdpZHRoOwoJCQkJCXgyID0geDEgKyBjYXJldFNpemU7CgkJCQkJeDMgPSB4MTsKCgkJCQkJeTEgPSB5MiAtIGNhcmV0U2l6ZTsKCQkJCQl5MyA9IHkyICsgY2FyZXRTaXplOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJaWYgKHhBbGlnbiA9PT0gJ2xlZnQnKSB7CgkJCQkJeDIgPSBwdFggKyBjb3JuZXJSYWRpdXMgKyAoY2FyZXRTaXplKTsKCQkJCQl4MSA9IHgyIC0gY2FyZXRTaXplOwoJCQkJCXgzID0geDIgKyBjYXJldFNpemU7CgkJCQl9IGVsc2UgaWYgKHhBbGlnbiA9PT0gJ3JpZ2h0JykgewoJCQkJCXgyID0gcHRYICsgd2lkdGggLSBjb3JuZXJSYWRpdXMgLSBjYXJldFNpemU7CgkJCQkJeDEgPSB4MiAtIGNhcmV0U2l6ZTsKCQkJCQl4MyA9IHgyICsgY2FyZXRTaXplOwoJCQkJfSBlbHNlIHsKCQkJCQl4MiA9IHZtLmNhcmV0WDsKCQkJCQl4MSA9IHgyIC0gY2FyZXRTaXplOwoJCQkJCXgzID0geDIgKyBjYXJldFNpemU7CgkJCQl9CgkJCQlpZiAoeUFsaWduID09PSAndG9wJykgewoJCQkJCXkxID0gcHRZOwoJCQkJCXkyID0geTEgLSBjYXJldFNpemU7CgkJCQkJeTMgPSB5MTsKCQkJCX0gZWxzZSB7CgkJCQkJeTEgPSBwdFkgKyBoZWlnaHQ7CgkJCQkJeTIgPSB5MSArIGNhcmV0U2l6ZTsKCQkJCQl5MyA9IHkxOwoJCQkJCS8vIGludmVydCBkcmF3aW5nIG9yZGVyCgkJCQkJdmFyIHRtcCA9IHgzOwoJCQkJCXgzID0geDE7CgkJCQkJeDEgPSB0bXA7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHt4MTogeDEsIHgyOiB4MiwgeDM6IHgzLCB5MTogeTEsIHkyOiB5MiwgeTM6IHkzfTsKCQl9LAoJCWRyYXdUaXRsZTogZnVuY3Rpb24ocHQsIHZtLCBjdHgsIG9wYWNpdHkpIHsKCQkJdmFyIHRpdGxlID0gdm0udGl0bGU7CgoJCQlpZiAodGl0bGUubGVuZ3RoKSB7CgkJCQljdHgudGV4dEFsaWduID0gdm0uX3RpdGxlQWxpZ247CgkJCQljdHgudGV4dEJhc2VsaW5lID0gJ3RvcCc7CgoJCQkJdmFyIHRpdGxlRm9udFNpemUgPSB2bS50aXRsZUZvbnRTaXplOwoJCQkJdmFyIHRpdGxlU3BhY2luZyA9IHZtLnRpdGxlU3BhY2luZzsKCgkJCQljdHguZmlsbFN0eWxlID0gbWVyZ2VPcGFjaXR5KHZtLnRpdGxlRm9udENvbG9yLCBvcGFjaXR5KTsKCQkJCWN0eC5mb250ID0gaGVscGVycy5mb250U3RyaW5nKHRpdGxlRm9udFNpemUsIHZtLl90aXRsZUZvbnRTdHlsZSwgdm0uX3RpdGxlRm9udEZhbWlseSk7CgoJCQkJdmFyIGksIGxlbjsKCQkJCWZvciAoaSA9IDAsIGxlbiA9IHRpdGxlLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CgkJCQkJY3R4LmZpbGxUZXh0KHRpdGxlW2ldLCBwdC54LCBwdC55KTsKCQkJCQlwdC55ICs9IHRpdGxlRm9udFNpemUgKyB0aXRsZVNwYWNpbmc7IC8vIExpbmUgSGVpZ2h0IGFuZCBzcGFjaW5nCgoJCQkJCWlmIChpICsgMSA9PT0gdGl0bGUubGVuZ3RoKSB7CgkJCQkJCXB0LnkgKz0gdm0udGl0bGVNYXJnaW5Cb3R0b20gLSB0aXRsZVNwYWNpbmc7IC8vIElmIExhc3QsIGFkZCBtYXJnaW4sIHJlbW92ZSBzcGFjaW5nCgkJCQkJfQoJCQkJfQoJCQl9CgkJfSwKCQlkcmF3Qm9keTogZnVuY3Rpb24ocHQsIHZtLCBjdHgsIG9wYWNpdHkpIHsKCQkJdmFyIGJvZHlGb250U2l6ZSA9IHZtLmJvZHlGb250U2l6ZTsKCQkJdmFyIGJvZHlTcGFjaW5nID0gdm0uYm9keVNwYWNpbmc7CgkJCXZhciBib2R5ID0gdm0uYm9keTsKCgkJCWN0eC50ZXh0QWxpZ24gPSB2bS5fYm9keUFsaWduOwoJCQljdHgudGV4dEJhc2VsaW5lID0gJ3RvcCc7CgkJCWN0eC5mb250ID0gaGVscGVycy5mb250U3RyaW5nKGJvZHlGb250U2l6ZSwgdm0uX2JvZHlGb250U3R5bGUsIHZtLl9ib2R5Rm9udEZhbWlseSk7CgoJCQkvLyBCZWZvcmUgQm9keQoJCQl2YXIgeExpbmVQYWRkaW5nID0gMDsKCQkJdmFyIGZpbGxMaW5lT2ZUZXh0ID0gZnVuY3Rpb24obGluZSkgewoJCQkJY3R4LmZpbGxUZXh0KGxpbmUsIHB0LnggKyB4TGluZVBhZGRpbmcsIHB0LnkpOwoJCQkJcHQueSArPSBib2R5Rm9udFNpemUgKyBib2R5U3BhY2luZzsKCQkJfTsKCgkJCS8vIEJlZm9yZSBib2R5IGxpbmVzCgkJCWN0eC5maWxsU3R5bGUgPSBtZXJnZU9wYWNpdHkodm0uYm9keUZvbnRDb2xvciwgb3BhY2l0eSk7CgkJCWhlbHBlcnMuZWFjaCh2bS5iZWZvcmVCb2R5LCBmaWxsTGluZU9mVGV4dCk7CgoJCQl2YXIgZHJhd0NvbG9yQm94ZXMgPSB2bS5kaXNwbGF5Q29sb3JzOwoJCQl4TGluZVBhZGRpbmcgPSBkcmF3Q29sb3JCb3hlcyA/IChib2R5Rm9udFNpemUgKyAyKSA6IDA7CgoJCQkvLyBEcmF3IGJvZHkgbGluZXMgbm93CgkJCWhlbHBlcnMuZWFjaChib2R5LCBmdW5jdGlvbihib2R5SXRlbSwgaSkgewoJCQkJdmFyIHRleHRDb2xvciA9IG1lcmdlT3BhY2l0eSh2bS5sYWJlbFRleHRDb2xvcnNbaV0sIG9wYWNpdHkpOwoJCQkJY3R4LmZpbGxTdHlsZSA9IHRleHRDb2xvcjsKCQkJCWhlbHBlcnMuZWFjaChib2R5SXRlbS5iZWZvcmUsIGZpbGxMaW5lT2ZUZXh0KTsKCgkJCQloZWxwZXJzLmVhY2goYm9keUl0ZW0ubGluZXMsIGZ1bmN0aW9uKGxpbmUpIHsKCQkJCQkvLyBEcmF3IExlZ2VuZC1saWtlIGJveGVzIGlmIG5lZWRlZAoJCQkJCWlmIChkcmF3Q29sb3JCb3hlcykgewoJCQkJCQkvLyBGaWxsIGEgd2hpdGUgcmVjdCBzbyB0aGF0IGNvbG91cnMgbWVyZ2UgbmljZWx5IGlmIHRoZSBvcGFjaXR5IGlzIDwgMQoJCQkJCQljdHguZmlsbFN0eWxlID0gbWVyZ2VPcGFjaXR5KHZtLmxlZ2VuZENvbG9yQmFja2dyb3VuZCwgb3BhY2l0eSk7CgkJCQkJCWN0eC5maWxsUmVjdChwdC54LCBwdC55LCBib2R5Rm9udFNpemUsIGJvZHlGb250U2l6ZSk7CgoJCQkJCQkvLyBCb3JkZXIKCQkJCQkJY3R4LmxpbmVXaWR0aCA9IDE7CgkJCQkJCWN0eC5zdHJva2VTdHlsZSA9IG1lcmdlT3BhY2l0eSh2bS5sYWJlbENvbG9yc1tpXS5ib3JkZXJDb2xvciwgb3BhY2l0eSk7CgkJCQkJCWN0eC5zdHJva2VSZWN0KHB0LngsIHB0LnksIGJvZHlGb250U2l6ZSwgYm9keUZvbnRTaXplKTsKCgkJCQkJCS8vIElubmVyIHNxdWFyZQoJCQkJCQljdHguZmlsbFN0eWxlID0gbWVyZ2VPcGFjaXR5KHZtLmxhYmVsQ29sb3JzW2ldLmJhY2tncm91bmRDb2xvciwgb3BhY2l0eSk7CgkJCQkJCWN0eC5maWxsUmVjdChwdC54ICsgMSwgcHQueSArIDEsIGJvZHlGb250U2l6ZSAtIDIsIGJvZHlGb250U2l6ZSAtIDIpOwoJCQkJCQljdHguZmlsbFN0eWxlID0gdGV4dENvbG9yOwoJCQkJCX0KCgkJCQkJZmlsbExpbmVPZlRleHQobGluZSk7CgkJCQl9KTsKCgkJCQloZWxwZXJzLmVhY2goYm9keUl0ZW0uYWZ0ZXIsIGZpbGxMaW5lT2ZUZXh0KTsKCQkJfSk7CgoJCQkvLyBSZXNldCBiYWNrIHRvIDAgZm9yIGFmdGVyIGJvZHkKCQkJeExpbmVQYWRkaW5nID0gMDsKCgkJCS8vIEFmdGVyIGJvZHkgbGluZXMKCQkJaGVscGVycy5lYWNoKHZtLmFmdGVyQm9keSwgZmlsbExpbmVPZlRleHQpOwoJCQlwdC55IC09IGJvZHlTcGFjaW5nOyAvLyBSZW1vdmUgbGFzdCBib2R5IHNwYWNpbmcKCQl9LAoJCWRyYXdGb290ZXI6IGZ1bmN0aW9uKHB0LCB2bSwgY3R4LCBvcGFjaXR5KSB7CgkJCXZhciBmb290ZXIgPSB2bS5mb290ZXI7CgoJCQlpZiAoZm9vdGVyLmxlbmd0aCkgewoJCQkJcHQueSArPSB2bS5mb290ZXJNYXJnaW5Ub3A7CgoJCQkJY3R4LnRleHRBbGlnbiA9IHZtLl9mb290ZXJBbGlnbjsKCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAndG9wJzsKCgkJCQljdHguZmlsbFN0eWxlID0gbWVyZ2VPcGFjaXR5KHZtLmZvb3RlckZvbnRDb2xvciwgb3BhY2l0eSk7CgkJCQljdHguZm9udCA9IGhlbHBlcnMuZm9udFN0cmluZyh2bS5mb290ZXJGb250U2l6ZSwgdm0uX2Zvb3RlckZvbnRTdHlsZSwgdm0uX2Zvb3RlckZvbnRGYW1pbHkpOwoKCQkJCWhlbHBlcnMuZWFjaChmb290ZXIsIGZ1bmN0aW9uKGxpbmUpIHsKCQkJCQljdHguZmlsbFRleHQobGluZSwgcHQueCwgcHQueSk7CgkJCQkJcHQueSArPSB2bS5mb290ZXJGb250U2l6ZSArIHZtLmZvb3RlclNwYWNpbmc7CgkJCQl9KTsKCQkJfQoJCX0sCgkJZHJhd0JhY2tncm91bmQ6IGZ1bmN0aW9uKHB0LCB2bSwgY3R4LCB0b29sdGlwU2l6ZSwgb3BhY2l0eSkgewoJCQljdHguZmlsbFN0eWxlID0gbWVyZ2VPcGFjaXR5KHZtLmJhY2tncm91bmRDb2xvciwgb3BhY2l0eSk7CgkJCWN0eC5zdHJva2VTdHlsZSA9IG1lcmdlT3BhY2l0eSh2bS5ib3JkZXJDb2xvciwgb3BhY2l0eSk7CgkJCWN0eC5saW5lV2lkdGggPSB2bS5ib3JkZXJXaWR0aDsKCQkJdmFyIHhBbGlnbiA9IHZtLnhBbGlnbjsKCQkJdmFyIHlBbGlnbiA9IHZtLnlBbGlnbjsKCQkJdmFyIHggPSBwdC54OwoJCQl2YXIgeSA9IHB0Lnk7CgkJCXZhciB3aWR0aCA9IHRvb2x0aXBTaXplLndpZHRoOwoJCQl2YXIgaGVpZ2h0ID0gdG9vbHRpcFNpemUuaGVpZ2h0OwoJCQl2YXIgcmFkaXVzID0gdm0uY29ybmVyUmFkaXVzOwoKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQljdHgubW92ZVRvKHggKyByYWRpdXMsIHkpOwoJCQlpZiAoeUFsaWduID09PSAndG9wJykgewoJCQkJdGhpcy5kcmF3Q2FyZXQocHQsIHRvb2x0aXBTaXplKTsKCQkJfQoJCQljdHgubGluZVRvKHggKyB3aWR0aCAtIHJhZGl1cywgeSk7CgkJCWN0eC5xdWFkcmF0aWNDdXJ2ZVRvKHggKyB3aWR0aCwgeSwgeCArIHdpZHRoLCB5ICsgcmFkaXVzKTsKCQkJaWYgKHlBbGlnbiA9PT0gJ2NlbnRlcicgJiYgeEFsaWduID09PSAncmlnaHQnKSB7CgkJCQl0aGlzLmRyYXdDYXJldChwdCwgdG9vbHRpcFNpemUpOwoJCQl9CgkJCWN0eC5saW5lVG8oeCArIHdpZHRoLCB5ICsgaGVpZ2h0IC0gcmFkaXVzKTsKCQkJY3R4LnF1YWRyYXRpY0N1cnZlVG8oeCArIHdpZHRoLCB5ICsgaGVpZ2h0LCB4ICsgd2lkdGggLSByYWRpdXMsIHkgKyBoZWlnaHQpOwoJCQlpZiAoeUFsaWduID09PSAnYm90dG9tJykgewoJCQkJdGhpcy5kcmF3Q2FyZXQocHQsIHRvb2x0aXBTaXplKTsKCQkJfQoJCQljdHgubGluZVRvKHggKyByYWRpdXMsIHkgKyBoZWlnaHQpOwoJCQljdHgucXVhZHJhdGljQ3VydmVUbyh4LCB5ICsgaGVpZ2h0LCB4LCB5ICsgaGVpZ2h0IC0gcmFkaXVzKTsKCQkJaWYgKHlBbGlnbiA9PT0gJ2NlbnRlcicgJiYgeEFsaWduID09PSAnbGVmdCcpIHsKCQkJCXRoaXMuZHJhd0NhcmV0KHB0LCB0b29sdGlwU2l6ZSk7CgkJCX0KCQkJY3R4LmxpbmVUbyh4LCB5ICsgcmFkaXVzKTsKCQkJY3R4LnF1YWRyYXRpY0N1cnZlVG8oeCwgeSwgeCArIHJhZGl1cywgeSk7CgkJCWN0eC5jbG9zZVBhdGgoKTsKCgkJCWN0eC5maWxsKCk7CgoJCQlpZiAodm0uYm9yZGVyV2lkdGggPiAwKSB7CgkJCQljdHguc3Ryb2tlKCk7CgkJCX0KCQl9LAoJCWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwoJCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoKCQkJaWYgKHZtLm9wYWNpdHkgPT09IDApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHRvb2x0aXBTaXplID0gewoJCQkJd2lkdGg6IHZtLndpZHRoLAoJCQkJaGVpZ2h0OiB2bS5oZWlnaHQKCQkJfTsKCQkJdmFyIHB0ID0gewoJCQkJeDogdm0ueCwKCQkJCXk6IHZtLnkKCQkJfTsKCgkJCS8vIElFMTEvRWRnZSBkb2VzIG5vdCBsaWtlIHZlcnkgc21hbGwgb3BhY2l0aWVzLCBzbyBzbmFwIHRvIDAKCQkJdmFyIG9wYWNpdHkgPSBNYXRoLmFicyh2bS5vcGFjaXR5IDwgMWUtMykgPyAwIDogdm0ub3BhY2l0eTsKCgkJCS8vIFRydXRoeS9mYWxzZXkgdmFsdWUgZm9yIGVtcHR5IHRvb2x0aXAKCQkJdmFyIGhhc1Rvb2x0aXBDb250ZW50ID0gdm0udGl0bGUubGVuZ3RoIHx8IHZtLmJlZm9yZUJvZHkubGVuZ3RoIHx8IHZtLmJvZHkubGVuZ3RoIHx8IHZtLmFmdGVyQm9keS5sZW5ndGggfHwgdm0uZm9vdGVyLmxlbmd0aDsKCgkJCWlmICh0aGlzLl9vcHRpb25zLmVuYWJsZWQgJiYgaGFzVG9vbHRpcENvbnRlbnQpIHsKCQkJCS8vIERyYXcgQmFja2dyb3VuZAoJCQkJdGhpcy5kcmF3QmFja2dyb3VuZChwdCwgdm0sIGN0eCwgdG9vbHRpcFNpemUsIG9wYWNpdHkpOwoKCQkJCS8vIERyYXcgVGl0bGUsIEJvZHksIGFuZCBGb290ZXIKCQkJCXB0LnggKz0gdm0ueFBhZGRpbmc7CgkJCQlwdC55ICs9IHZtLnlQYWRkaW5nOwoKCQkJCS8vIFRpdGxlcwoJCQkJdGhpcy5kcmF3VGl0bGUocHQsIHZtLCBjdHgsIG9wYWNpdHkpOwoKCQkJCS8vIEJvZHkKCQkJCXRoaXMuZHJhd0JvZHkocHQsIHZtLCBjdHgsIG9wYWNpdHkpOwoKCQkJCS8vIEZvb3RlcgoJCQkJdGhpcy5kcmF3Rm9vdGVyKHB0LCB2bSwgY3R4LCBvcGFjaXR5KTsKCQkJfQoJCX0sCgoJCS8qKgoJCSAqIEhhbmRsZSBhbiBldmVudAoJCSAqIEBwcml2YXRlCgkJICogQHBhcmFtIHtJRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IHRvIGhhbmRsZQoJCSAqIEByZXR1cm5zIHtCb29sZWFufSB0cnVlIGlmIHRoZSB0b29sdGlwIGNoYW5nZWQKCQkgKi8KCQloYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0aW9ucyA9IG1lLl9vcHRpb25zOwoJCQl2YXIgY2hhbmdlZCA9IGZhbHNlOwoKCQkJbWUuX2xhc3RBY3RpdmUgPSBtZS5fbGFzdEFjdGl2ZSB8fCBbXTsKCgkJCS8vIEZpbmQgQWN0aXZlIEVsZW1lbnRzIGZvciB0b29sdGlwcwoJCQlpZiAoZS50eXBlID09PSAnbW91c2VvdXQnKSB7CgkJCQltZS5fYWN0aXZlID0gW107CgkJCX0gZWxzZSB7CgkJCQltZS5fYWN0aXZlID0gbWUuX2NoYXJ0LmdldEVsZW1lbnRzQXRFdmVudEZvck1vZGUoZSwgb3B0aW9ucy5tb2RlLCBvcHRpb25zKTsKCQkJfQoKCQkJLy8gUmVtZW1iZXIgTGFzdCBBY3RpdmVzCgkJCWNoYW5nZWQgPSAhaGVscGVycy5hcnJheUVxdWFscyhtZS5fYWN0aXZlLCBtZS5fbGFzdEFjdGl2ZSk7CgoJCQkvLyBPbmx5IGhhbmRsZSB0YXJnZXQgZXZlbnQgb24gdG9vbHRpcCBjaGFuZ2UKCQkJaWYgKGNoYW5nZWQpIHsKCQkJCW1lLl9sYXN0QWN0aXZlID0gbWUuX2FjdGl2ZTsKCgkJCQlpZiAob3B0aW9ucy5lbmFibGVkIHx8IG9wdGlvbnMuY3VzdG9tKSB7CgkJCQkJbWUuX2V2ZW50UG9zaXRpb24gPSB7CgkJCQkJCXg6IGUueCwKCQkJCQkJeTogZS55CgkJCQkJfTsKCgkJCQkJbWUudXBkYXRlKHRydWUpOwoJCQkJCW1lLnBpdm90KCk7CgkJCQl9CgkJCX0KCgkJCXJldHVybiBjaGFuZ2VkOwoJCX0KCX0pOwoKCS8qKgoJICogQG5hbWVzcGFjZSBDaGFydC5Ub29sdGlwLnBvc2l0aW9uZXJzCgkgKi8KCUNoYXJ0LlRvb2x0aXAucG9zaXRpb25lcnMgPSB7CgkJLyoqCgkJICogQXZlcmFnZSBtb2RlIHBsYWNlcyB0aGUgdG9vbHRpcCBhdCB0aGUgYXZlcmFnZSBwb3NpdGlvbiBvZiB0aGUgZWxlbWVudHMgc2hvd24KCQkgKiBAZnVuY3Rpb24gQ2hhcnQuVG9vbHRpcC5wb3NpdGlvbmVycy5hdmVyYWdlCgkJICogQHBhcmFtIGVsZW1lbnRzIHtDaGFydEVsZW1lbnRbXX0gdGhlIGVsZW1lbnRzIGJlaW5nIGRpc3BsYXllZCBpbiB0aGUgdG9vbHRpcAoJCSAqIEByZXR1cm5zIHtQb2ludH0gdG9vbHRpcCBwb3NpdGlvbgoJCSAqLwoJCWF2ZXJhZ2U6IGZ1bmN0aW9uKGVsZW1lbnRzKSB7CgkJCWlmICghZWxlbWVudHMubGVuZ3RoKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCXZhciBpLCBsZW47CgkJCXZhciB4ID0gMDsKCQkJdmFyIHkgPSAwOwoJCQl2YXIgY291bnQgPSAwOwoKCQkJZm9yIChpID0gMCwgbGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKCQkJCXZhciBlbCA9IGVsZW1lbnRzW2ldOwoJCQkJaWYgKGVsICYmIGVsLmhhc1ZhbHVlKCkpIHsKCQkJCQl2YXIgcG9zID0gZWwudG9vbHRpcFBvc2l0aW9uKCk7CgkJCQkJeCArPSBwb3MueDsKCQkJCQl5ICs9IHBvcy55OwoJCQkJCSsrY291bnQ7CgkJCQl9CgkJCX0KCgkJCXJldHVybiB7CgkJCQl4OiBNYXRoLnJvdW5kKHggLyBjb3VudCksCgkJCQl5OiBNYXRoLnJvdW5kKHkgLyBjb3VudCkKCQkJfTsKCQl9LAoKCQkvKioKCQkgKiBHZXRzIHRoZSB0b29sdGlwIHBvc2l0aW9uIG5lYXJlc3Qgb2YgdGhlIGl0ZW0gbmVhcmVzdCB0byB0aGUgZXZlbnQgcG9zaXRpb24KCQkgKiBAZnVuY3Rpb24gQ2hhcnQuVG9vbHRpcC5wb3NpdGlvbmVycy5uZWFyZXN0CgkJICogQHBhcmFtIGVsZW1lbnRzIHtDaGFydC5FbGVtZW50W119IHRoZSB0b29sdGlwIGVsZW1lbnRzCgkJICogQHBhcmFtIGV2ZW50UG9zaXRpb24ge1BvaW50fSB0aGUgcG9zaXRpb24gb2YgdGhlIGV2ZW50IGluIGNhbnZhcyBjb29yZGluYXRlcwoJCSAqIEByZXR1cm5zIHtQb2ludH0gdGhlIHRvb2x0aXAgcG9zaXRpb24KCQkgKi8KCQluZWFyZXN0OiBmdW5jdGlvbihlbGVtZW50cywgZXZlbnRQb3NpdGlvbikgewoJCQl2YXIgeCA9IGV2ZW50UG9zaXRpb24ueDsKCQkJdmFyIHkgPSBldmVudFBvc2l0aW9uLnk7CgkJCXZhciBtaW5EaXN0YW5jZSA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKCQkJdmFyIGksIGxlbiwgbmVhcmVzdEVsZW1lbnQ7CgoJCQlmb3IgKGkgPSAwLCBsZW4gPSBlbGVtZW50cy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewoJCQkJdmFyIGVsID0gZWxlbWVudHNbaV07CgkJCQlpZiAoZWwgJiYgZWwuaGFzVmFsdWUoKSkgewoJCQkJCXZhciBjZW50ZXIgPSBlbC5nZXRDZW50ZXJQb2ludCgpOwoJCQkJCXZhciBkID0gaGVscGVycy5kaXN0YW5jZUJldHdlZW5Qb2ludHMoZXZlbnRQb3NpdGlvbiwgY2VudGVyKTsKCgkJCQkJaWYgKGQgPCBtaW5EaXN0YW5jZSkgewoJCQkJCQltaW5EaXN0YW5jZSA9IGQ7CgkJCQkJCW5lYXJlc3RFbGVtZW50ID0gZWw7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlpZiAobmVhcmVzdEVsZW1lbnQpIHsKCQkJCXZhciB0cCA9IG5lYXJlc3RFbGVtZW50LnRvb2x0aXBQb3NpdGlvbigpOwoJCQkJeCA9IHRwLng7CgkJCQl5ID0gdHAueTsKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCXg6IHgsCgkJCQl5OiB5CgkJCX07CgkJfQoJfTsKfTsKCn0seyIyNSI6MjUsIjI2IjoyNiwiNDUiOjQ1fV0sMzY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgZGVmYXVsdHMgPSByZXF1aXJlKDI1KTsKdmFyIEVsZW1lbnQgPSByZXF1aXJlKDI2KTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKCWVsZW1lbnRzOiB7CgkJYXJjOiB7CgkJCWJhY2tncm91bmRDb2xvcjogZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRDb2xvciwKCQkJYm9yZGVyQ29sb3I6ICcjZmZmJywKCQkJYm9yZGVyV2lkdGg6IDIKCQl9Cgl9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBFbGVtZW50LmV4dGVuZCh7CglpbkxhYmVsUmFuZ2U6IGZ1bmN0aW9uKG1vdXNlWCkgewoJCXZhciB2bSA9IHRoaXMuX3ZpZXc7CgoJCWlmICh2bSkgewoJCQlyZXR1cm4gKE1hdGgucG93KG1vdXNlWCAtIHZtLngsIDIpIDwgTWF0aC5wb3codm0ucmFkaXVzICsgdm0uaG92ZXJSYWRpdXMsIDIpKTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglpblJhbmdlOiBmdW5jdGlvbihjaGFydFgsIGNoYXJ0WSkgewoJCXZhciB2bSA9IHRoaXMuX3ZpZXc7CgoJCWlmICh2bSkgewoJCQl2YXIgcG9pbnRSZWxhdGl2ZVBvc2l0aW9uID0gaGVscGVycy5nZXRBbmdsZUZyb21Qb2ludCh2bSwge3g6IGNoYXJ0WCwgeTogY2hhcnRZfSk7CgkJCXZhcglhbmdsZSA9IHBvaW50UmVsYXRpdmVQb3NpdGlvbi5hbmdsZTsKCQkJdmFyIGRpc3RhbmNlID0gcG9pbnRSZWxhdGl2ZVBvc2l0aW9uLmRpc3RhbmNlOwoKCQkJLy8gU2FuaXRpc2UgYW5nbGUgcmFuZ2UKCQkJdmFyIHN0YXJ0QW5nbGUgPSB2bS5zdGFydEFuZ2xlOwoJCQl2YXIgZW5kQW5nbGUgPSB2bS5lbmRBbmdsZTsKCQkJd2hpbGUgKGVuZEFuZ2xlIDwgc3RhcnRBbmdsZSkgewoJCQkJZW5kQW5nbGUgKz0gMi4wICogTWF0aC5QSTsKCQkJfQoJCQl3aGlsZSAoYW5nbGUgPiBlbmRBbmdsZSkgewoJCQkJYW5nbGUgLT0gMi4wICogTWF0aC5QSTsKCQkJfQoJCQl3aGlsZSAoYW5nbGUgPCBzdGFydEFuZ2xlKSB7CgkJCQlhbmdsZSArPSAyLjAgKiBNYXRoLlBJOwoJCQl9CgoJCQkvLyBDaGVjayBpZiB3aXRoaW4gdGhlIHJhbmdlIG9mIHRoZSBvcGVuL2Nsb3NlIGFuZ2xlCgkJCXZhciBiZXR3ZWVuQW5nbGVzID0gKGFuZ2xlID49IHN0YXJ0QW5nbGUgJiYgYW5nbGUgPD0gZW5kQW5nbGUpOwoJCQl2YXIgd2l0aGluUmFkaXVzID0gKGRpc3RhbmNlID49IHZtLmlubmVyUmFkaXVzICYmIGRpc3RhbmNlIDw9IHZtLm91dGVyUmFkaXVzKTsKCgkJCXJldHVybiAoYmV0d2VlbkFuZ2xlcyAmJiB3aXRoaW5SYWRpdXMpOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCWdldENlbnRlclBvaW50OiBmdW5jdGlvbigpIHsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXZhciBoYWxmQW5nbGUgPSAodm0uc3RhcnRBbmdsZSArIHZtLmVuZEFuZ2xlKSAvIDI7CgkJdmFyIGhhbGZSYWRpdXMgPSAodm0uaW5uZXJSYWRpdXMgKyB2bS5vdXRlclJhZGl1cykgLyAyOwoJCXJldHVybiB7CgkJCXg6IHZtLnggKyBNYXRoLmNvcyhoYWxmQW5nbGUpICogaGFsZlJhZGl1cywKCQkJeTogdm0ueSArIE1hdGguc2luKGhhbGZBbmdsZSkgKiBoYWxmUmFkaXVzCgkJfTsKCX0sCgoJZ2V0QXJlYTogZnVuY3Rpb24oKSB7CgkJdmFyIHZtID0gdGhpcy5fdmlldzsKCQlyZXR1cm4gTWF0aC5QSSAqICgodm0uZW5kQW5nbGUgLSB2bS5zdGFydEFuZ2xlKSAvICgyICogTWF0aC5QSSkpICogKE1hdGgucG93KHZtLm91dGVyUmFkaXVzLCAyKSAtIE1hdGgucG93KHZtLmlubmVyUmFkaXVzLCAyKSk7Cgl9LAoKCXRvb2x0aXBQb3NpdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIHZtID0gdGhpcy5fdmlldzsKCQl2YXIgY2VudHJlQW5nbGUgPSB2bS5zdGFydEFuZ2xlICsgKCh2bS5lbmRBbmdsZSAtIHZtLnN0YXJ0QW5nbGUpIC8gMik7CgkJdmFyIHJhbmdlRnJvbUNlbnRyZSA9ICh2bS5vdXRlclJhZGl1cyAtIHZtLmlubmVyUmFkaXVzKSAvIDIgKyB2bS5pbm5lclJhZGl1czsKCgkJcmV0dXJuIHsKCQkJeDogdm0ueCArIChNYXRoLmNvcyhjZW50cmVBbmdsZSkgKiByYW5nZUZyb21DZW50cmUpLAoJCQl5OiB2bS55ICsgKE1hdGguc2luKGNlbnRyZUFuZ2xlKSAqIHJhbmdlRnJvbUNlbnRyZSkKCQl9OwoJfSwKCglkcmF3OiBmdW5jdGlvbigpIHsKCQl2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwoJCXZhciB2bSA9IHRoaXMuX3ZpZXc7CgkJdmFyIHNBID0gdm0uc3RhcnRBbmdsZTsKCQl2YXIgZUEgPSB2bS5lbmRBbmdsZTsKCgkJY3R4LmJlZ2luUGF0aCgpOwoKCQljdHguYXJjKHZtLngsIHZtLnksIHZtLm91dGVyUmFkaXVzLCBzQSwgZUEpOwoJCWN0eC5hcmModm0ueCwgdm0ueSwgdm0uaW5uZXJSYWRpdXMsIGVBLCBzQSwgdHJ1ZSk7CgoJCWN0eC5jbG9zZVBhdGgoKTsKCQljdHguc3Ryb2tlU3R5bGUgPSB2bS5ib3JkZXJDb2xvcjsKCQljdHgubGluZVdpZHRoID0gdm0uYm9yZGVyV2lkdGg7CgoJCWN0eC5maWxsU3R5bGUgPSB2bS5iYWNrZ3JvdW5kQ29sb3I7CgoJCWN0eC5maWxsKCk7CgkJY3R4LmxpbmVKb2luID0gJ2JldmVsJzsKCgkJaWYgKHZtLmJvcmRlcldpZHRoKSB7CgkJCWN0eC5zdHJva2UoKTsKCQl9Cgl9Cn0pOwoKfSx7IjI1IjoyNSwiMjYiOjI2LCI0NSI6NDV9XSwzNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgRWxlbWVudCA9IHJlcXVpcmUoMjYpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwoKdmFyIGdsb2JhbERlZmF1bHRzID0gZGVmYXVsdHMuZ2xvYmFsOwoKZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewoJZWxlbWVudHM6IHsKCQlsaW5lOiB7CgkJCXRlbnNpb246IDAuNCwKCQkJYmFja2dyb3VuZENvbG9yOiBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Q29sb3IsCgkJCWJvcmRlcldpZHRoOiAzLAoJCQlib3JkZXJDb2xvcjogZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdENvbG9yLAoJCQlib3JkZXJDYXBTdHlsZTogJ2J1dHQnLAoJCQlib3JkZXJEYXNoOiBbXSwKCQkJYm9yZGVyRGFzaE9mZnNldDogMC4wLAoJCQlib3JkZXJKb2luU3R5bGU6ICdtaXRlcicsCgkJCWNhcEJlemllclBvaW50czogdHJ1ZSwKCQkJZmlsbDogdHJ1ZSwgLy8gZG8gd2UgZmlsbCBpbiB0aGUgYXJlYSBiZXR3ZWVuIHRoZSBsaW5lIGFuZCBpdHMgYmFzZSBheGlzCgkJfQoJfQp9KTsKCm1vZHVsZS5leHBvcnRzID0gRWxlbWVudC5leHRlbmQoewoJZHJhdzogZnVuY3Rpb24oKSB7CgkJdmFyIG1lID0gdGhpczsKCQl2YXIgdm0gPSBtZS5fdmlldzsKCQl2YXIgY3R4ID0gbWUuX2NoYXJ0LmN0eDsKCQl2YXIgc3BhbkdhcHMgPSB2bS5zcGFuR2FwczsKCQl2YXIgcG9pbnRzID0gbWUuX2NoaWxkcmVuLnNsaWNlKCk7IC8vIGNsb25lIGFycmF5CgkJdmFyIGdsb2JhbE9wdGlvbkxpbmVFbGVtZW50cyA9IGdsb2JhbERlZmF1bHRzLmVsZW1lbnRzLmxpbmU7CgkJdmFyIGxhc3REcmF3bkluZGV4ID0gLTE7CgkJdmFyIGluZGV4LCBjdXJyZW50LCBwcmV2aW91cywgY3VycmVudFZNOwoKCQkvLyBJZiB3ZSBhcmUgbG9vcGluZywgYWRkaW5nIHRoZSBmaXJzdCBwb2ludCBhZ2FpbgoJCWlmIChtZS5fbG9vcCAmJiBwb2ludHMubGVuZ3RoKSB7CgkJCXBvaW50cy5wdXNoKHBvaW50c1swXSk7CgkJfQoKCQljdHguc2F2ZSgpOwoKCQkvLyBTdHJva2UgTGluZSBPcHRpb25zCgkJY3R4LmxpbmVDYXAgPSB2bS5ib3JkZXJDYXBTdHlsZSB8fCBnbG9iYWxPcHRpb25MaW5lRWxlbWVudHMuYm9yZGVyQ2FwU3R5bGU7CgoJCS8vIElFIDkgYW5kIDEwIGRvIG5vdCBzdXBwb3J0IGxpbmUgZGFzaAoJCWlmIChjdHguc2V0TGluZURhc2gpIHsKCQkJY3R4LnNldExpbmVEYXNoKHZtLmJvcmRlckRhc2ggfHwgZ2xvYmFsT3B0aW9uTGluZUVsZW1lbnRzLmJvcmRlckRhc2gpOwoJCX0KCgkJY3R4LmxpbmVEYXNoT2Zmc2V0ID0gdm0uYm9yZGVyRGFzaE9mZnNldCB8fCBnbG9iYWxPcHRpb25MaW5lRWxlbWVudHMuYm9yZGVyRGFzaE9mZnNldDsKCQljdHgubGluZUpvaW4gPSB2bS5ib3JkZXJKb2luU3R5bGUgfHwgZ2xvYmFsT3B0aW9uTGluZUVsZW1lbnRzLmJvcmRlckpvaW5TdHlsZTsKCQljdHgubGluZVdpZHRoID0gdm0uYm9yZGVyV2lkdGggfHwgZ2xvYmFsT3B0aW9uTGluZUVsZW1lbnRzLmJvcmRlcldpZHRoOwoJCWN0eC5zdHJva2VTdHlsZSA9IHZtLmJvcmRlckNvbG9yIHx8IGdsb2JhbERlZmF1bHRzLmRlZmF1bHRDb2xvcjsKCgkJLy8gU3Ryb2tlIExpbmUKCQljdHguYmVnaW5QYXRoKCk7CgkJbGFzdERyYXduSW5kZXggPSAtMTsKCgkJZm9yIChpbmRleCA9IDA7IGluZGV4IDwgcG9pbnRzLmxlbmd0aDsgKytpbmRleCkgewoJCQljdXJyZW50ID0gcG9pbnRzW2luZGV4XTsKCQkJcHJldmlvdXMgPSBoZWxwZXJzLnByZXZpb3VzSXRlbShwb2ludHMsIGluZGV4KTsKCQkJY3VycmVudFZNID0gY3VycmVudC5fdmlldzsKCgkJCS8vIEZpcnN0IHBvaW50IG1vdmVzIHRvIGl0J3Mgc3RhcnRpbmcgcG9zaXRpb24gbm8gbWF0dGVyIHdoYXQKCQkJaWYgKGluZGV4ID09PSAwKSB7CgkJCQlpZiAoIWN1cnJlbnRWTS5za2lwKSB7CgkJCQkJY3R4Lm1vdmVUbyhjdXJyZW50Vk0ueCwgY3VycmVudFZNLnkpOwoJCQkJCWxhc3REcmF3bkluZGV4ID0gaW5kZXg7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlwcmV2aW91cyA9IGxhc3REcmF3bkluZGV4ID09PSAtMSA/IHByZXZpb3VzIDogcG9pbnRzW2xhc3REcmF3bkluZGV4XTsKCgkJCQlpZiAoIWN1cnJlbnRWTS5za2lwKSB7CgkJCQkJaWYgKChsYXN0RHJhd25JbmRleCAhPT0gKGluZGV4IC0gMSkgJiYgIXNwYW5HYXBzKSB8fCBsYXN0RHJhd25JbmRleCA9PT0gLTEpIHsKCQkJCQkJLy8gVGhlcmUgd2FzIGEgZ2FwIGFuZCB0aGlzIGlzIHRoZSBmaXJzdCBwb2ludCBhZnRlciB0aGUgZ2FwCgkJCQkJCWN0eC5tb3ZlVG8oY3VycmVudFZNLngsIGN1cnJlbnRWTS55KTsKCQkJCQl9IGVsc2UgewoJCQkJCQkvLyBMaW5lIHRvIG5leHQgcG9pbnQKCQkJCQkJaGVscGVycy5jYW52YXMubGluZVRvKGN0eCwgcHJldmlvdXMuX3ZpZXcsIGN1cnJlbnQuX3ZpZXcpOwoJCQkJCX0KCQkJCQlsYXN0RHJhd25JbmRleCA9IGluZGV4OwoJCQkJfQoJCQl9CgkJfQoKCQljdHguc3Ryb2tlKCk7CgkJY3R4LnJlc3RvcmUoKTsKCX0KfSk7Cgp9LHsiMjUiOjI1LCIyNiI6MjYsIjQ1Ijo0NX1dLDM4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGRlZmF1bHRzID0gcmVxdWlyZSgyNSk7CnZhciBFbGVtZW50ID0gcmVxdWlyZSgyNik7CnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7Cgp2YXIgZGVmYXVsdENvbG9yID0gZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRDb2xvcjsKCmRlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKCWVsZW1lbnRzOiB7CgkJcG9pbnQ6IHsKCQkJcmFkaXVzOiAzLAoJCQlwb2ludFN0eWxlOiAnY2lyY2xlJywKCQkJYmFja2dyb3VuZENvbG9yOiBkZWZhdWx0Q29sb3IsCgkJCWJvcmRlckNvbG9yOiBkZWZhdWx0Q29sb3IsCgkJCWJvcmRlcldpZHRoOiAxLAoJCQkvLyBIb3ZlcgoJCQloaXRSYWRpdXM6IDEsCgkJCWhvdmVyUmFkaXVzOiA0LAoJCQlob3ZlckJvcmRlcldpZHRoOiAxCgkJfQoJfQp9KTsKCmZ1bmN0aW9uIHhSYW5nZShtb3VzZVgpIHsKCXZhciB2bSA9IHRoaXMuX3ZpZXc7CglyZXR1cm4gdm0gPyAoTWF0aC5hYnMobW91c2VYIC0gdm0ueCkgPCB2bS5yYWRpdXMgKyB2bS5oaXRSYWRpdXMpIDogZmFsc2U7Cn0KCmZ1bmN0aW9uIHlSYW5nZShtb3VzZVkpIHsKCXZhciB2bSA9IHRoaXMuX3ZpZXc7CglyZXR1cm4gdm0gPyAoTWF0aC5hYnMobW91c2VZIC0gdm0ueSkgPCB2bS5yYWRpdXMgKyB2bS5oaXRSYWRpdXMpIDogZmFsc2U7Cn0KCm1vZHVsZS5leHBvcnRzID0gRWxlbWVudC5leHRlbmQoewoJaW5SYW5nZTogZnVuY3Rpb24obW91c2VYLCBtb3VzZVkpIHsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXJldHVybiB2bSA/ICgoTWF0aC5wb3cobW91c2VYIC0gdm0ueCwgMikgKyBNYXRoLnBvdyhtb3VzZVkgLSB2bS55LCAyKSkgPCBNYXRoLnBvdyh2bS5oaXRSYWRpdXMgKyB2bS5yYWRpdXMsIDIpKSA6IGZhbHNlOwoJfSwKCglpbkxhYmVsUmFuZ2U6IHhSYW5nZSwKCWluWFJhbmdlOiB4UmFuZ2UsCglpbllSYW5nZTogeVJhbmdlLAoKCWdldENlbnRlclBvaW50OiBmdW5jdGlvbigpIHsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXJldHVybiB7CgkJCXg6IHZtLngsCgkJCXk6IHZtLnkKCQl9OwoJfSwKCglnZXRBcmVhOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gTWF0aC5QSSAqIE1hdGgucG93KHRoaXMuX3ZpZXcucmFkaXVzLCAyKTsKCX0sCgoJdG9vbHRpcFBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXJldHVybiB7CgkJCXg6IHZtLngsCgkJCXk6IHZtLnksCgkJCXBhZGRpbmc6IHZtLnJhZGl1cyArIHZtLmJvcmRlcldpZHRoCgkJfTsKCX0sCgoJZHJhdzogZnVuY3Rpb24oY2hhcnRBcmVhKSB7CgkJdmFyIHZtID0gdGhpcy5fdmlldzsKCQl2YXIgbW9kZWwgPSB0aGlzLl9tb2RlbDsKCQl2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwoJCXZhciBwb2ludFN0eWxlID0gdm0ucG9pbnRTdHlsZTsKCQl2YXIgcmFkaXVzID0gdm0ucmFkaXVzOwoJCXZhciB4ID0gdm0ueDsKCQl2YXIgeSA9IHZtLnk7CgkJdmFyIGNvbG9yID0gaGVscGVycy5jb2xvcjsKCQl2YXIgZXJyTWFyZ2luID0gMS4wMTsgLy8gMS4wMSBpcyBtYXJnaW4gZm9yIEFjY3VtdWxhdGVkIGVycm9yLiAoRXNwZWNpYWxseSBFZGdlLCBJRS4pCgkJdmFyIHJhdGlvID0gMDsKCgkJaWYgKHZtLnNraXApIHsKCQkJcmV0dXJuOwoJCX0KCgkJY3R4LnN0cm9rZVN0eWxlID0gdm0uYm9yZGVyQ29sb3IgfHwgZGVmYXVsdENvbG9yOwoJCWN0eC5saW5lV2lkdGggPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHZtLmJvcmRlcldpZHRoLCBkZWZhdWx0cy5nbG9iYWwuZWxlbWVudHMucG9pbnQuYm9yZGVyV2lkdGgpOwoJCWN0eC5maWxsU3R5bGUgPSB2bS5iYWNrZ3JvdW5kQ29sb3IgfHwgZGVmYXVsdENvbG9yOwoKCQkvLyBDbGlwaW5nIGZvciBQb2ludHMuCgkJLy8gZ29pbmcgb3V0IGZyb20gaW5uZXIgY2hhckFyZWE/CgkJaWYgKChjaGFydEFyZWEgIT09IHVuZGVmaW5lZCkgJiYgKChtb2RlbC54IDwgY2hhcnRBcmVhLmxlZnQpIHx8IChjaGFydEFyZWEucmlnaHQgKiBlcnJNYXJnaW4gPCBtb2RlbC54KSB8fCAobW9kZWwueSA8IGNoYXJ0QXJlYS50b3ApIHx8IChjaGFydEFyZWEuYm90dG9tICogZXJyTWFyZ2luIDwgbW9kZWwueSkpKSB7CgkJCS8vIFBvaW50IGZhZGUgb3V0CgkJCWlmIChtb2RlbC54IDwgY2hhcnRBcmVhLmxlZnQpIHsKCQkJCXJhdGlvID0gKHggLSBtb2RlbC54KSAvIChjaGFydEFyZWEubGVmdCAtIG1vZGVsLngpOwoJCQl9IGVsc2UgaWYgKGNoYXJ0QXJlYS5yaWdodCAqIGVyck1hcmdpbiA8IG1vZGVsLngpIHsKCQkJCXJhdGlvID0gKG1vZGVsLnggLSB4KSAvIChtb2RlbC54IC0gY2hhcnRBcmVhLnJpZ2h0KTsKCQkJfSBlbHNlIGlmIChtb2RlbC55IDwgY2hhcnRBcmVhLnRvcCkgewoJCQkJcmF0aW8gPSAoeSAtIG1vZGVsLnkpIC8gKGNoYXJ0QXJlYS50b3AgLSBtb2RlbC55KTsKCQkJfSBlbHNlIGlmIChjaGFydEFyZWEuYm90dG9tICogZXJyTWFyZ2luIDwgbW9kZWwueSkgewoJCQkJcmF0aW8gPSAobW9kZWwueSAtIHkpIC8gKG1vZGVsLnkgLSBjaGFydEFyZWEuYm90dG9tKTsKCQkJfQoJCQlyYXRpbyA9IE1hdGgucm91bmQocmF0aW8gKiAxMDApIC8gMTAwOwoJCQljdHguc3Ryb2tlU3R5bGUgPSBjb2xvcihjdHguc3Ryb2tlU3R5bGUpLmFscGhhKHJhdGlvKS5yZ2JTdHJpbmcoKTsKCQkJY3R4LmZpbGxTdHlsZSA9IGNvbG9yKGN0eC5maWxsU3R5bGUpLmFscGhhKHJhdGlvKS5yZ2JTdHJpbmcoKTsKCQl9CgoJCWhlbHBlcnMuY2FudmFzLmRyYXdQb2ludChjdHgsIHBvaW50U3R5bGUsIHJhZGl1cywgeCwgeSk7Cgl9Cn0pOwoKfSx7IjI1IjoyNSwiMjYiOjI2LCI0NSI6NDV9XSwzOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgRWxlbWVudCA9IHJlcXVpcmUoMjYpOwoKZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewoJZWxlbWVudHM6IHsKCQlyZWN0YW5nbGU6IHsKCQkJYmFja2dyb3VuZENvbG9yOiBkZWZhdWx0cy5nbG9iYWwuZGVmYXVsdENvbG9yLAoJCQlib3JkZXJDb2xvcjogZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRDb2xvciwKCQkJYm9yZGVyU2tpcHBlZDogJ2JvdHRvbScsCgkJCWJvcmRlcldpZHRoOiAwCgkJfQoJfQp9KTsKCmZ1bmN0aW9uIGlzVmVydGljYWwoYmFyKSB7CglyZXR1cm4gYmFyLl92aWV3LndpZHRoICE9PSB1bmRlZmluZWQ7Cn0KCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IHRoZSBib3VuZHMgb2YgdGhlIGJhciByZWdhcmRsZXNzIG9mIHRoZSBvcmllbnRhdGlvbgogKiBAcGFyYW0gYmFyIHtDaGFydC5FbGVtZW50LlJlY3RhbmdsZX0gdGhlIGJhcgogKiBAcmV0dXJuIHtCb3VuZHN9IGJvdW5kcyBvZiB0aGUgYmFyCiAqIEBwcml2YXRlCiAqLwpmdW5jdGlvbiBnZXRCYXJCb3VuZHMoYmFyKSB7Cgl2YXIgdm0gPSBiYXIuX3ZpZXc7Cgl2YXIgeDEsIHgyLCB5MSwgeTI7CgoJaWYgKGlzVmVydGljYWwoYmFyKSkgewoJCS8vIHZlcnRpY2FsCgkJdmFyIGhhbGZXaWR0aCA9IHZtLndpZHRoIC8gMjsKCQl4MSA9IHZtLnggLSBoYWxmV2lkdGg7CgkJeDIgPSB2bS54ICsgaGFsZldpZHRoOwoJCXkxID0gTWF0aC5taW4odm0ueSwgdm0uYmFzZSk7CgkJeTIgPSBNYXRoLm1heCh2bS55LCB2bS5iYXNlKTsKCX0gZWxzZSB7CgkJLy8gaG9yaXpvbnRhbCBiYXIKCQl2YXIgaGFsZkhlaWdodCA9IHZtLmhlaWdodCAvIDI7CgkJeDEgPSBNYXRoLm1pbih2bS54LCB2bS5iYXNlKTsKCQl4MiA9IE1hdGgubWF4KHZtLngsIHZtLmJhc2UpOwoJCXkxID0gdm0ueSAtIGhhbGZIZWlnaHQ7CgkJeTIgPSB2bS55ICsgaGFsZkhlaWdodDsKCX0KCglyZXR1cm4gewoJCWxlZnQ6IHgxLAoJCXRvcDogeTEsCgkJcmlnaHQ6IHgyLAoJCWJvdHRvbTogeTIKCX07Cn0KCm1vZHVsZS5leHBvcnRzID0gRWxlbWVudC5leHRlbmQoewoJZHJhdzogZnVuY3Rpb24oKSB7CgkJdmFyIGN0eCA9IHRoaXMuX2NoYXJ0LmN0eDsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXZhciBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHNpZ25YLCBzaWduWSwgYm9yZGVyU2tpcHBlZDsKCQl2YXIgYm9yZGVyV2lkdGggPSB2bS5ib3JkZXJXaWR0aDsKCgkJaWYgKCF2bS5ob3Jpem9udGFsKSB7CgkJCS8vIGJhcgoJCQlsZWZ0ID0gdm0ueCAtIHZtLndpZHRoIC8gMjsKCQkJcmlnaHQgPSB2bS54ICsgdm0ud2lkdGggLyAyOwoJCQl0b3AgPSB2bS55OwoJCQlib3R0b20gPSB2bS5iYXNlOwoJCQlzaWduWCA9IDE7CgkJCXNpZ25ZID0gYm90dG9tID4gdG9wID8gMSA6IC0xOwoJCQlib3JkZXJTa2lwcGVkID0gdm0uYm9yZGVyU2tpcHBlZCB8fCAnYm90dG9tJzsKCQl9IGVsc2UgewoJCQkvLyBob3Jpem9udGFsIGJhcgoJCQlsZWZ0ID0gdm0uYmFzZTsKCQkJcmlnaHQgPSB2bS54OwoJCQl0b3AgPSB2bS55IC0gdm0uaGVpZ2h0IC8gMjsKCQkJYm90dG9tID0gdm0ueSArIHZtLmhlaWdodCAvIDI7CgkJCXNpZ25YID0gcmlnaHQgPiBsZWZ0ID8gMSA6IC0xOwoJCQlzaWduWSA9IDE7CgkJCWJvcmRlclNraXBwZWQgPSB2bS5ib3JkZXJTa2lwcGVkIHx8ICdsZWZ0JzsKCQl9CgoJCS8vIENhbnZhcyBkb2Vzbid0IGFsbG93IHVzIHRvIHN0cm9rZSBpbnNpZGUgdGhlIHdpZHRoIHNvIHdlIGNhbgoJCS8vIGFkanVzdCB0aGUgc2l6ZXMgdG8gZml0IGlmIHdlJ3JlIHNldHRpbmcgYSBzdHJva2Ugb24gdGhlIGxpbmUKCQlpZiAoYm9yZGVyV2lkdGgpIHsKCQkJLy8gYm9yZGVyV2lkdGggc2hvbGQgYmUgbGVzcyB0aGFuIGJhciB3aWR0aCBhbmQgYmFyIGhlaWdodC4KCQkJdmFyIGJhclNpemUgPSBNYXRoLm1pbihNYXRoLmFicyhsZWZ0IC0gcmlnaHQpLCBNYXRoLmFicyh0b3AgLSBib3R0b20pKTsKCQkJYm9yZGVyV2lkdGggPSBib3JkZXJXaWR0aCA+IGJhclNpemUgPyBiYXJTaXplIDogYm9yZGVyV2lkdGg7CgkJCXZhciBoYWxmU3Ryb2tlID0gYm9yZGVyV2lkdGggLyAyOwoJCQkvLyBBZGp1c3QgYm9yZGVyV2lkdGggd2hlbiBiYXIgdG9wIHBvc2l0aW9uIGlzIG5lYXIgdm0uYmFzZSh6ZXJvKS4KCQkJdmFyIGJvcmRlckxlZnQgPSBsZWZ0ICsgKGJvcmRlclNraXBwZWQgIT09ICdsZWZ0JyA/IGhhbGZTdHJva2UgKiBzaWduWCA6IDApOwoJCQl2YXIgYm9yZGVyUmlnaHQgPSByaWdodCArIChib3JkZXJTa2lwcGVkICE9PSAncmlnaHQnID8gLWhhbGZTdHJva2UgKiBzaWduWCA6IDApOwoJCQl2YXIgYm9yZGVyVG9wID0gdG9wICsgKGJvcmRlclNraXBwZWQgIT09ICd0b3AnID8gaGFsZlN0cm9rZSAqIHNpZ25ZIDogMCk7CgkJCXZhciBib3JkZXJCb3R0b20gPSBib3R0b20gKyAoYm9yZGVyU2tpcHBlZCAhPT0gJ2JvdHRvbScgPyAtaGFsZlN0cm9rZSAqIHNpZ25ZIDogMCk7CgkJCS8vIG5vdCBiZWNvbWUgYSB2ZXJ0aWNhbCBsaW5lPwoJCQlpZiAoYm9yZGVyTGVmdCAhPT0gYm9yZGVyUmlnaHQpIHsKCQkJCXRvcCA9IGJvcmRlclRvcDsKCQkJCWJvdHRvbSA9IGJvcmRlckJvdHRvbTsKCQkJfQoJCQkvLyBub3QgYmVjb21lIGEgaG9yaXpvbnRhbCBsaW5lPwoJCQlpZiAoYm9yZGVyVG9wICE9PSBib3JkZXJCb3R0b20pIHsKCQkJCWxlZnQgPSBib3JkZXJMZWZ0OwoJCQkJcmlnaHQgPSBib3JkZXJSaWdodDsKCQkJfQoJCX0KCgkJY3R4LmJlZ2luUGF0aCgpOwoJCWN0eC5maWxsU3R5bGUgPSB2bS5iYWNrZ3JvdW5kQ29sb3I7CgkJY3R4LnN0cm9rZVN0eWxlID0gdm0uYm9yZGVyQ29sb3I7CgkJY3R4LmxpbmVXaWR0aCA9IGJvcmRlcldpZHRoOwoKCQkvLyBDb3JuZXIgcG9pbnRzLCBmcm9tIGJvdHRvbS1sZWZ0IHRvIGJvdHRvbS1yaWdodCBjbG9ja3dpc2UKCQkvLyB8IDEgMiB8CgkJLy8gfCAwIDMgfAoJCXZhciBjb3JuZXJzID0gWwoJCQlbbGVmdCwgYm90dG9tXSwKCQkJW2xlZnQsIHRvcF0sCgkJCVtyaWdodCwgdG9wXSwKCQkJW3JpZ2h0LCBib3R0b21dCgkJXTsKCgkJLy8gRmluZCBmaXJzdCAoc3RhcnRpbmcpIGNvcm5lciB3aXRoIGZhbGxiYWNrIHRvICdib3R0b20nCgkJdmFyIGJvcmRlcnMgPSBbJ2JvdHRvbScsICdsZWZ0JywgJ3RvcCcsICdyaWdodCddOwoJCXZhciBzdGFydENvcm5lciA9IGJvcmRlcnMuaW5kZXhPZihib3JkZXJTa2lwcGVkLCAwKTsKCQlpZiAoc3RhcnRDb3JuZXIgPT09IC0xKSB7CgkJCXN0YXJ0Q29ybmVyID0gMDsKCQl9CgoJCWZ1bmN0aW9uIGNvcm5lckF0KGluZGV4KSB7CgkJCXJldHVybiBjb3JuZXJzWyhzdGFydENvcm5lciArIGluZGV4KSAlIDRdOwoJCX0KCgkJLy8gRHJhdyByZWN0YW5nbGUgZnJvbSAnc3RhcnRDb3JuZXInCgkJdmFyIGNvcm5lciA9IGNvcm5lckF0KDApOwoJCWN0eC5tb3ZlVG8oY29ybmVyWzBdLCBjb3JuZXJbMV0pOwoKCQlmb3IgKHZhciBpID0gMTsgaSA8IDQ7IGkrKykgewoJCQljb3JuZXIgPSBjb3JuZXJBdChpKTsKCQkJY3R4LmxpbmVUbyhjb3JuZXJbMF0sIGNvcm5lclsxXSk7CgkJfQoKCQljdHguZmlsbCgpOwoJCWlmIChib3JkZXJXaWR0aCkgewoJCQljdHguc3Ryb2tlKCk7CgkJfQoJfSwKCgloZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCXZhciB2bSA9IHRoaXMuX3ZpZXc7CgkJcmV0dXJuIHZtLmJhc2UgLSB2bS55OwoJfSwKCglpblJhbmdlOiBmdW5jdGlvbihtb3VzZVgsIG1vdXNlWSkgewoJCXZhciBpblJhbmdlID0gZmFsc2U7CgoJCWlmICh0aGlzLl92aWV3KSB7CgkJCXZhciBib3VuZHMgPSBnZXRCYXJCb3VuZHModGhpcyk7CgkJCWluUmFuZ2UgPSBtb3VzZVggPj0gYm91bmRzLmxlZnQgJiYgbW91c2VYIDw9IGJvdW5kcy5yaWdodCAmJiBtb3VzZVkgPj0gYm91bmRzLnRvcCAmJiBtb3VzZVkgPD0gYm91bmRzLmJvdHRvbTsKCQl9CgoJCXJldHVybiBpblJhbmdlOwoJfSwKCglpbkxhYmVsUmFuZ2U6IGZ1bmN0aW9uKG1vdXNlWCwgbW91c2VZKSB7CgkJdmFyIG1lID0gdGhpczsKCQlpZiAoIW1lLl92aWV3KSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXZhciBpblJhbmdlID0gZmFsc2U7CgkJdmFyIGJvdW5kcyA9IGdldEJhckJvdW5kcyhtZSk7CgoJCWlmIChpc1ZlcnRpY2FsKG1lKSkgewoJCQlpblJhbmdlID0gbW91c2VYID49IGJvdW5kcy5sZWZ0ICYmIG1vdXNlWCA8PSBib3VuZHMucmlnaHQ7CgkJfSBlbHNlIHsKCQkJaW5SYW5nZSA9IG1vdXNlWSA+PSBib3VuZHMudG9wICYmIG1vdXNlWSA8PSBib3VuZHMuYm90dG9tOwoJCX0KCgkJcmV0dXJuIGluUmFuZ2U7Cgl9LAoKCWluWFJhbmdlOiBmdW5jdGlvbihtb3VzZVgpIHsKCQl2YXIgYm91bmRzID0gZ2V0QmFyQm91bmRzKHRoaXMpOwoJCXJldHVybiBtb3VzZVggPj0gYm91bmRzLmxlZnQgJiYgbW91c2VYIDw9IGJvdW5kcy5yaWdodDsKCX0sCgoJaW5ZUmFuZ2U6IGZ1bmN0aW9uKG1vdXNlWSkgewoJCXZhciBib3VuZHMgPSBnZXRCYXJCb3VuZHModGhpcyk7CgkJcmV0dXJuIG1vdXNlWSA+PSBib3VuZHMudG9wICYmIG1vdXNlWSA8PSBib3VuZHMuYm90dG9tOwoJfSwKCglnZXRDZW50ZXJQb2ludDogZnVuY3Rpb24oKSB7CgkJdmFyIHZtID0gdGhpcy5fdmlldzsKCQl2YXIgeCwgeTsKCQlpZiAoaXNWZXJ0aWNhbCh0aGlzKSkgewoJCQl4ID0gdm0ueDsKCQkJeSA9ICh2bS55ICsgdm0uYmFzZSkgLyAyOwoJCX0gZWxzZSB7CgkJCXggPSAodm0ueCArIHZtLmJhc2UpIC8gMjsKCQkJeSA9IHZtLnk7CgkJfQoKCQlyZXR1cm4ge3g6IHgsIHk6IHl9OwoJfSwKCglnZXRBcmVhOiBmdW5jdGlvbigpIHsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXJldHVybiB2bS53aWR0aCAqIE1hdGguYWJzKHZtLnkgLSB2bS5iYXNlKTsKCX0sCgoJdG9vbHRpcFBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgdm0gPSB0aGlzLl92aWV3OwoJCXJldHVybiB7CgkJCXg6IHZtLngsCgkJCXk6IHZtLnkKCQl9OwoJfQp9KTsKCn0seyIyNSI6MjUsIjI2IjoyNn1dLDQwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSB7fTsKbW9kdWxlLmV4cG9ydHMuQXJjID0gcmVxdWlyZSgzNik7Cm1vZHVsZS5leHBvcnRzLkxpbmUgPSByZXF1aXJlKDM3KTsKbW9kdWxlLmV4cG9ydHMuUG9pbnQgPSByZXF1aXJlKDM4KTsKbW9kdWxlLmV4cG9ydHMuUmVjdGFuZ2xlID0gcmVxdWlyZSgzOSk7Cgp9LHsiMzYiOjM2LCIzNyI6MzcsIjM4IjozOCwiMzkiOjM5fV0sNDE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDIpOwoKLyoqCiAqIEBuYW1lc3BhY2UgQ2hhcnQuaGVscGVycy5jYW52YXMKICovCnZhciBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSB7CgkvKioKCSAqIENsZWFycyB0aGUgZW50aXJlIGNhbnZhcyBhc3NvY2lhdGVkIHRvIHRoZSBnaXZlbiBgY2hhcnRgLgoJICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSBUaGUgY2hhcnQgZm9yIHdoaWNoIHRvIGNsZWFyIHRoZSBjYW52YXMuCgkgKi8KCWNsZWFyOiBmdW5jdGlvbihjaGFydCkgewoJCWNoYXJ0LmN0eC5jbGVhclJlY3QoMCwgMCwgY2hhcnQud2lkdGgsIGNoYXJ0LmhlaWdodCk7Cgl9LAoKCS8qKgoJICogQ3JlYXRlcyBhICJwYXRoIiBmb3IgYSByZWN0YW5nbGUgd2l0aCByb3VuZGVkIGNvcm5lcnMgYXQgcG9zaXRpb24gKHgsIHkpIHdpdGggYQoJICogZ2l2ZW4gc2l6ZSAod2lkdGgsIGhlaWdodCkgYW5kIHRoZSBzYW1lIGByYWRpdXNgIGZvciBhbGwgY29ybmVycy4KCSAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjdHggLSBUaGUgY2FudmFzIDJEIENvbnRleHQuCgkgKiBAcGFyYW0ge051bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkgKiBAcGFyYW0ge051bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkgKiBAcGFyYW0ge051bWJlcn0gd2lkdGggLSBUaGUgcmVjdGFuZ2xlJ3Mgd2lkdGguCgkgKiBAcGFyYW0ge051bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZSdzIGhlaWdodC4KCSAqIEBwYXJhbSB7TnVtYmVyfSByYWRpdXMgLSBUaGUgcm91bmRlZCBhbW91bnQgKGluIHBpeGVscykgZm9yIHRoZSBmb3VyIGNvcm5lcnMuCgkgKiBAdG9kbyBoYW5kbGUgYHJhZGl1c2AgYXMgdG9wLWxlZnQsIHRvcC1yaWdodCwgYm90dG9tLXJpZ2h0LCBib3R0b20tbGVmdCBhcnJheS9vYmplY3Q/CgkgKi8KCXJvdW5kZWRSZWN0OiBmdW5jdGlvbihjdHgsIHgsIHksIHdpZHRoLCBoZWlnaHQsIHJhZGl1cykgewoJCWlmIChyYWRpdXMpIHsKCQkJdmFyIHJ4ID0gTWF0aC5taW4ocmFkaXVzLCB3aWR0aCAvIDIpOwoJCQl2YXIgcnkgPSBNYXRoLm1pbihyYWRpdXMsIGhlaWdodCAvIDIpOwoKCQkJY3R4Lm1vdmVUbyh4ICsgcngsIHkpOwoJCQljdHgubGluZVRvKHggKyB3aWR0aCAtIHJ4LCB5KTsKCQkJY3R4LnF1YWRyYXRpY0N1cnZlVG8oeCArIHdpZHRoLCB5LCB4ICsgd2lkdGgsIHkgKyByeSk7CgkJCWN0eC5saW5lVG8oeCArIHdpZHRoLCB5ICsgaGVpZ2h0IC0gcnkpOwoJCQljdHgucXVhZHJhdGljQ3VydmVUbyh4ICsgd2lkdGgsIHkgKyBoZWlnaHQsIHggKyB3aWR0aCAtIHJ4LCB5ICsgaGVpZ2h0KTsKCQkJY3R4LmxpbmVUbyh4ICsgcngsIHkgKyBoZWlnaHQpOwoJCQljdHgucXVhZHJhdGljQ3VydmVUbyh4LCB5ICsgaGVpZ2h0LCB4LCB5ICsgaGVpZ2h0IC0gcnkpOwoJCQljdHgubGluZVRvKHgsIHkgKyByeSk7CgkJCWN0eC5xdWFkcmF0aWNDdXJ2ZVRvKHgsIHksIHggKyByeCwgeSk7CgkJfSBlbHNlIHsKCQkJY3R4LnJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgkJfQoJfSwKCglkcmF3UG9pbnQ6IGZ1bmN0aW9uKGN0eCwgc3R5bGUsIHJhZGl1cywgeCwgeSkgewoJCXZhciB0eXBlLCBlZGdlTGVuZ3RoLCB4T2Zmc2V0LCB5T2Zmc2V0LCBoZWlnaHQsIHNpemU7CgoJCWlmIChzdHlsZSAmJiB0eXBlb2Ygc3R5bGUgPT09ICdvYmplY3QnKSB7CgkJCXR5cGUgPSBzdHlsZS50b1N0cmluZygpOwoJCQlpZiAodHlwZSA9PT0gJ1tvYmplY3QgSFRNTEltYWdlRWxlbWVudF0nIHx8IHR5cGUgPT09ICdbb2JqZWN0IEhUTUxDYW52YXNFbGVtZW50XScpIHsKCQkJCWN0eC5kcmF3SW1hZ2Uoc3R5bGUsIHggLSBzdHlsZS53aWR0aCAvIDIsIHkgLSBzdHlsZS5oZWlnaHQgLyAyLCBzdHlsZS53aWR0aCwgc3R5bGUuaGVpZ2h0KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJaWYgKGlzTmFOKHJhZGl1cykgfHwgcmFkaXVzIDw9IDApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3dpdGNoIChzdHlsZSkgewoJCS8vIERlZmF1bHQgaW5jbHVkZXMgY2lyY2xlCgkJZGVmYXVsdDoKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQljdHguYXJjKHgsIHksIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwoJCQljdHguY2xvc2VQYXRoKCk7CgkJCWN0eC5maWxsKCk7CgkJCWJyZWFrOwoJCWNhc2UgJ3RyaWFuZ2xlJzoKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQllZGdlTGVuZ3RoID0gMyAqIHJhZGl1cyAvIE1hdGguc3FydCgzKTsKCQkJaGVpZ2h0ID0gZWRnZUxlbmd0aCAqIE1hdGguc3FydCgzKSAvIDI7CgkJCWN0eC5tb3ZlVG8oeCAtIGVkZ2VMZW5ndGggLyAyLCB5ICsgaGVpZ2h0IC8gMyk7CgkJCWN0eC5saW5lVG8oeCArIGVkZ2VMZW5ndGggLyAyLCB5ICsgaGVpZ2h0IC8gMyk7CgkJCWN0eC5saW5lVG8oeCwgeSAtIDIgKiBoZWlnaHQgLyAzKTsKCQkJY3R4LmNsb3NlUGF0aCgpOwoJCQljdHguZmlsbCgpOwoJCQlicmVhazsKCQljYXNlICdyZWN0JzoKCQkJc2l6ZSA9IDEgLyBNYXRoLlNRUlQyICogcmFkaXVzOwoJCQljdHguYmVnaW5QYXRoKCk7CgkJCWN0eC5maWxsUmVjdCh4IC0gc2l6ZSwgeSAtIHNpemUsIDIgKiBzaXplLCAyICogc2l6ZSk7CgkJCWN0eC5zdHJva2VSZWN0KHggLSBzaXplLCB5IC0gc2l6ZSwgMiAqIHNpemUsIDIgKiBzaXplKTsKCQkJYnJlYWs7CgkJY2FzZSAncmVjdFJvdW5kZWQnOgoJCQl2YXIgb2Zmc2V0ID0gcmFkaXVzIC8gTWF0aC5TUVJUMjsKCQkJdmFyIGxlZnRYID0geCAtIG9mZnNldDsKCQkJdmFyIHRvcFkgPSB5IC0gb2Zmc2V0OwoJCQl2YXIgc2lkZVNpemUgPSBNYXRoLlNRUlQyICogcmFkaXVzOwoJCQljdHguYmVnaW5QYXRoKCk7CgkJCXRoaXMucm91bmRlZFJlY3QoY3R4LCBsZWZ0WCwgdG9wWSwgc2lkZVNpemUsIHNpZGVTaXplLCByYWRpdXMgLyAyKTsKCQkJY3R4LmNsb3NlUGF0aCgpOwoJCQljdHguZmlsbCgpOwoJCQlicmVhazsKCQljYXNlICdyZWN0Um90JzoKCQkJc2l6ZSA9IDEgLyBNYXRoLlNRUlQyICogcmFkaXVzOwoJCQljdHguYmVnaW5QYXRoKCk7CgkJCWN0eC5tb3ZlVG8oeCAtIHNpemUsIHkpOwoJCQljdHgubGluZVRvKHgsIHkgKyBzaXplKTsKCQkJY3R4LmxpbmVUbyh4ICsgc2l6ZSwgeSk7CgkJCWN0eC5saW5lVG8oeCwgeSAtIHNpemUpOwoJCQljdHguY2xvc2VQYXRoKCk7CgkJCWN0eC5maWxsKCk7CgkJCWJyZWFrOwoJCWNhc2UgJ2Nyb3NzJzoKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQljdHgubW92ZVRvKHgsIHkgKyByYWRpdXMpOwoJCQljdHgubGluZVRvKHgsIHkgLSByYWRpdXMpOwoJCQljdHgubW92ZVRvKHggLSByYWRpdXMsIHkpOwoJCQljdHgubGluZVRvKHggKyByYWRpdXMsIHkpOwoJCQljdHguY2xvc2VQYXRoKCk7CgkJCWJyZWFrOwoJCWNhc2UgJ2Nyb3NzUm90JzoKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQl4T2Zmc2V0ID0gTWF0aC5jb3MoTWF0aC5QSSAvIDQpICogcmFkaXVzOwoJCQl5T2Zmc2V0ID0gTWF0aC5zaW4oTWF0aC5QSSAvIDQpICogcmFkaXVzOwoJCQljdHgubW92ZVRvKHggLSB4T2Zmc2V0LCB5IC0geU9mZnNldCk7CgkJCWN0eC5saW5lVG8oeCArIHhPZmZzZXQsIHkgKyB5T2Zmc2V0KTsKCQkJY3R4Lm1vdmVUbyh4IC0geE9mZnNldCwgeSArIHlPZmZzZXQpOwoJCQljdHgubGluZVRvKHggKyB4T2Zmc2V0LCB5IC0geU9mZnNldCk7CgkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJYnJlYWs7CgkJY2FzZSAnc3Rhcic6CgkJCWN0eC5iZWdpblBhdGgoKTsKCQkJY3R4Lm1vdmVUbyh4LCB5ICsgcmFkaXVzKTsKCQkJY3R4LmxpbmVUbyh4LCB5IC0gcmFkaXVzKTsKCQkJY3R4Lm1vdmVUbyh4IC0gcmFkaXVzLCB5KTsKCQkJY3R4LmxpbmVUbyh4ICsgcmFkaXVzLCB5KTsKCQkJeE9mZnNldCA9IE1hdGguY29zKE1hdGguUEkgLyA0KSAqIHJhZGl1czsKCQkJeU9mZnNldCA9IE1hdGguc2luKE1hdGguUEkgLyA0KSAqIHJhZGl1czsKCQkJY3R4Lm1vdmVUbyh4IC0geE9mZnNldCwgeSAtIHlPZmZzZXQpOwoJCQljdHgubGluZVRvKHggKyB4T2Zmc2V0LCB5ICsgeU9mZnNldCk7CgkJCWN0eC5tb3ZlVG8oeCAtIHhPZmZzZXQsIHkgKyB5T2Zmc2V0KTsKCQkJY3R4LmxpbmVUbyh4ICsgeE9mZnNldCwgeSAtIHlPZmZzZXQpOwoJCQljdHguY2xvc2VQYXRoKCk7CgkJCWJyZWFrOwoJCWNhc2UgJ2xpbmUnOgoJCQljdHguYmVnaW5QYXRoKCk7CgkJCWN0eC5tb3ZlVG8oeCAtIHJhZGl1cywgeSk7CgkJCWN0eC5saW5lVG8oeCArIHJhZGl1cywgeSk7CgkJCWN0eC5jbG9zZVBhdGgoKTsKCQkJYnJlYWs7CgkJY2FzZSAnZGFzaCc6CgkJCWN0eC5iZWdpblBhdGgoKTsKCQkJY3R4Lm1vdmVUbyh4LCB5KTsKCQkJY3R4LmxpbmVUbyh4ICsgcmFkaXVzLCB5KTsKCQkJY3R4LmNsb3NlUGF0aCgpOwoJCQlicmVhazsKCQl9CgoJCWN0eC5zdHJva2UoKTsKCX0sCgoJY2xpcEFyZWE6IGZ1bmN0aW9uKGN0eCwgYXJlYSkgewoJCWN0eC5zYXZlKCk7CgkJY3R4LmJlZ2luUGF0aCgpOwoJCWN0eC5yZWN0KGFyZWEubGVmdCwgYXJlYS50b3AsIGFyZWEucmlnaHQgLSBhcmVhLmxlZnQsIGFyZWEuYm90dG9tIC0gYXJlYS50b3ApOwoJCWN0eC5jbGlwKCk7Cgl9LAoKCXVuY2xpcEFyZWE6IGZ1bmN0aW9uKGN0eCkgewoJCWN0eC5yZXN0b3JlKCk7Cgl9LAoKCWxpbmVUbzogZnVuY3Rpb24oY3R4LCBwcmV2aW91cywgdGFyZ2V0LCBmbGlwKSB7CgkJaWYgKHRhcmdldC5zdGVwcGVkTGluZSkgewoJCQlpZiAoKHRhcmdldC5zdGVwcGVkTGluZSA9PT0gJ2FmdGVyJyAmJiAhZmxpcCkgfHwgKHRhcmdldC5zdGVwcGVkTGluZSAhPT0gJ2FmdGVyJyAmJiBmbGlwKSkgewoJCQkJY3R4LmxpbmVUbyhwcmV2aW91cy54LCB0YXJnZXQueSk7CgkJCX0gZWxzZSB7CgkJCQljdHgubGluZVRvKHRhcmdldC54LCBwcmV2aW91cy55KTsKCQkJfQoJCQljdHgubGluZVRvKHRhcmdldC54LCB0YXJnZXQueSk7CgkJCXJldHVybjsKCQl9CgoJCWlmICghdGFyZ2V0LnRlbnNpb24pIHsKCQkJY3R4LmxpbmVUbyh0YXJnZXQueCwgdGFyZ2V0LnkpOwoJCQlyZXR1cm47CgkJfQoKCQljdHguYmV6aWVyQ3VydmVUbygKCQkJZmxpcCA/IHByZXZpb3VzLmNvbnRyb2xQb2ludFByZXZpb3VzWCA6IHByZXZpb3VzLmNvbnRyb2xQb2ludE5leHRYLAoJCQlmbGlwID8gcHJldmlvdXMuY29udHJvbFBvaW50UHJldmlvdXNZIDogcHJldmlvdXMuY29udHJvbFBvaW50TmV4dFksCgkJCWZsaXAgPyB0YXJnZXQuY29udHJvbFBvaW50TmV4dFggOiB0YXJnZXQuY29udHJvbFBvaW50UHJldmlvdXNYLAoJCQlmbGlwID8gdGFyZ2V0LmNvbnRyb2xQb2ludE5leHRZIDogdGFyZ2V0LmNvbnRyb2xQb2ludFByZXZpb3VzWSwKCQkJdGFyZ2V0LngsCgkJCXRhcmdldC55KTsKCX0KfTsKCi8vIERFUFJFQ0FUSU9OUwoKLyoqCiAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy5jYW52YXMuY2xlYXIgaW5zdGVhZC4KICogQG5hbWVzcGFjZSBDaGFydC5oZWxwZXJzLmNsZWFyCiAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi43LjAKICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMwogKiBAcHJpdmF0ZQogKi8KaGVscGVycy5jbGVhciA9IGV4cG9ydHMuY2xlYXI7CgovKioKICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydC5oZWxwZXJzLmNhbnZhcy5yb3VuZGVkUmVjdCBpbnN0ZWFkLgogKiBAbmFtZXNwYWNlIENoYXJ0LmhlbHBlcnMuZHJhd1JvdW5kZWRSZWN0YW5nbGUKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjcuMAogKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCiAqIEBwcml2YXRlCiAqLwpoZWxwZXJzLmRyYXdSb3VuZGVkUmVjdGFuZ2xlID0gZnVuY3Rpb24oY3R4KSB7CgljdHguYmVnaW5QYXRoKCk7CglleHBvcnRzLnJvdW5kZWRSZWN0LmFwcGx5KGV4cG9ydHMsIGFyZ3VtZW50cyk7CgljdHguY2xvc2VQYXRoKCk7Cn07Cgp9LHsiNDIiOjQyfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovKioKICogQG5hbWVzcGFjZSBDaGFydC5oZWxwZXJzCiAqLwp2YXIgaGVscGVycyA9IHsKCS8qKgoJICogQW4gZW1wdHkgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCwgZm9yIGV4YW1wbGUsIGZvciBvcHRpb25hbCBjYWxsYmFjay4KCSAqLwoJbm9vcDogZnVuY3Rpb24oKSB7fSwKCgkvKioKCSAqIFJldHVybnMgYSB1bmlxdWUgaWQsIHNlcXVlbnRpYWxseSBnZW5lcmF0ZWQgZnJvbSBhIGdsb2JhbCB2YXJpYWJsZS4KCSAqIEByZXR1cm5zIHtOdW1iZXJ9CgkgKiBAZnVuY3Rpb24KCSAqLwoJdWlkOiAoZnVuY3Rpb24oKSB7CgkJdmFyIGlkID0gMDsKCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBpZCsrOwoJCX07Cgl9KCkpLAoKCS8qKgoJICogUmV0dXJucyB0cnVlIGlmIGB2YWx1ZWAgaXMgbmVpdGhlciBudWxsIG5vciB1bmRlZmluZWQsIGVsc2UgcmV0dXJucyBmYWxzZS4KCSAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gdGVzdC4KCSAqIEByZXR1cm5zIHtCb29sZWFufQoJICogQHNpbmNlIDIuNy4wCgkgKi8KCWlzTnVsbE9yVW5kZWY6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCc7Cgl9LAoKCS8qKgoJICogUmV0dXJucyB0cnVlIGlmIGB2YWx1ZWAgaXMgYW4gYXJyYXksIGVsc2UgcmV0dXJucyBmYWxzZS4KCSAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gdGVzdC4KCSAqIEByZXR1cm5zIHtCb29sZWFufQoJICogQGZ1bmN0aW9uCgkgKi8KCWlzQXJyYXk6IEFycmF5LmlzQXJyYXkgPyBBcnJheS5pc0FycmF5IDogZnVuY3Rpb24odmFsdWUpIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gJ1tvYmplY3QgQXJyYXldJzsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRydWUgaWYgYHZhbHVlYCBpcyBhbiBvYmplY3QgKGV4Y2x1ZGluZyBudWxsKSwgZWxzZSByZXR1cm5zIGZhbHNlLgoJICogQHBhcmFtIHsqfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byB0ZXN0LgoJICogQHJldHVybnMge0Jvb2xlYW59CgkgKiBAc2luY2UgMi43LjAKCSAqLwoJaXNPYmplY3Q6IGZ1bmN0aW9uKHZhbHVlKSB7CgkJcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT09ICdbb2JqZWN0IE9iamVjdF0nOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYHZhbHVlYCBpZiBkZWZpbmVkLCBlbHNlIHJldHVybnMgYGRlZmF1bHRWYWx1ZWAuCgkgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHJldHVybiBpZiBkZWZpbmVkLgoJICogQHBhcmFtIHsqfSBkZWZhdWx0VmFsdWUgLSBUaGUgdmFsdWUgdG8gcmV0dXJuIGlmIGB2YWx1ZWAgaXMgdW5kZWZpbmVkLgoJICogQHJldHVybnMgeyp9CgkgKi8KCXZhbHVlT3JEZWZhdWx0OiBmdW5jdGlvbih2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CgkJcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgPyBkZWZhdWx0VmFsdWUgOiB2YWx1ZTsKCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHZhbHVlIGF0IHRoZSBnaXZlbiBgaW5kZXhgIGluIGFycmF5IGlmIGRlZmluZWQsIGVsc2UgcmV0dXJucyBgZGVmYXVsdFZhbHVlYC4KCSAqIEBwYXJhbSB7QXJyYXl9IHZhbHVlIC0gVGhlIGFycmF5IHRvIGxvb2t1cCBmb3IgdmFsdWUgYXQgYGluZGV4YC4KCSAqIEBwYXJhbSB7TnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBpbiBgdmFsdWVgIHRvIGxvb2t1cCBmb3IgdmFsdWUuCgkgKiBAcGFyYW0geyp9IGRlZmF1bHRWYWx1ZSAtIFRoZSB2YWx1ZSB0byByZXR1cm4gaWYgYHZhbHVlW2luZGV4XWAgaXMgdW5kZWZpbmVkLgoJICogQHJldHVybnMgeyp9CgkgKi8KCXZhbHVlQXRJbmRleE9yRGVmYXVsdDogZnVuY3Rpb24odmFsdWUsIGluZGV4LCBkZWZhdWx0VmFsdWUpIHsKCQlyZXR1cm4gaGVscGVycy52YWx1ZU9yRGVmYXVsdChoZWxwZXJzLmlzQXJyYXkodmFsdWUpID8gdmFsdWVbaW5kZXhdIDogdmFsdWUsIGRlZmF1bHRWYWx1ZSk7Cgl9LAoKCS8qKgoJICogQ2FsbHMgYGZuYCB3aXRoIHRoZSBnaXZlbiBgYXJnc2AgaW4gdGhlIHNjb3BlIGRlZmluZWQgYnkgYHRoaXNBcmdgIGFuZCByZXR1cm5zIHRoZQoJICogdmFsdWUgcmV0dXJuZWQgYnkgYGZuYC4gSWYgYGZuYCBpcyBub3QgYSBmdW5jdGlvbiwgdGhpcyBtZXRob2QgcmV0dXJucyB1bmRlZmluZWQuCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiAtIFRoZSBmdW5jdGlvbiB0byBjYWxsLgoJICogQHBhcmFtIHtBcnJheXx1bmRlZmluZWR8bnVsbH0gYXJncyAtIFRoZSBhcmd1bWVudHMgd2l0aCB3aGljaCBgZm5gIHNob3VsZCBiZSBjYWxsZWQuCgkgKiBAcGFyYW0ge09iamVjdH0gW3RoaXNBcmddIC0gVGhlIHZhbHVlIG9mIGB0aGlzYCBwcm92aWRlZCBmb3IgdGhlIGNhbGwgdG8gYGZuYC4KCSAqIEByZXR1cm5zIHsqfQoJICovCgljYWxsYmFjazogZnVuY3Rpb24oZm4sIGFyZ3MsIHRoaXNBcmcpIHsKCQlpZiAoZm4gJiYgdHlwZW9mIGZuLmNhbGwgPT09ICdmdW5jdGlvbicpIHsKCQkJcmV0dXJuIGZuLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwoJCX0KCX0sCgoJLyoqCgkgKiBOb3RlKFNCKSBmb3IgcGVyZm9ybWFuY2Ugc2FrZSwgdGhpcyBtZXRob2Qgc2hvdWxkIG9ubHkgYmUgdXNlZCB3aGVuIGxvb3BhYmxlIHR5cGUKCSAqIGlzIHVua25vd24gb3IgaW4gbm9uZSBpbnRlbnNpdmUgY29kZSAobm90IGNhbGxlZCBvZnRlbiBhbmQgc21hbGwgbG9vcGFibGUpLiBFbHNlCgkgKiBpdCdzIHByZWZlcmFibGUgdG8gdXNlIGEgcmVndWxhciBmb3IoKSBsb29wIGFuZCBzYXZlIGV4dHJhIGZ1bmN0aW9uIGNhbGxzLgoJICogQHBhcmFtIHtPYmplY3R8QXJyYXl9IGxvb3BhYmxlIC0gVGhlIG9iamVjdCBvciBhcnJheSB0byBiZSBpdGVyYXRlZC4KCSAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIC0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgZm9yIGVhY2ggaXRlbS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBbdGhpc0FyZ10gLSBUaGUgdmFsdWUgb2YgYHRoaXNgIHByb3ZpZGVkIGZvciB0aGUgY2FsbCB0byBgZm5gLgoJICogQHBhcmFtIHtCb29sZWFufSBbcmV2ZXJzZV0gLSBJZiB0cnVlLCBpdGVyYXRlcyBiYWNrd2FyZCBvbiB0aGUgbG9vcGFibGUuCgkgKi8KCWVhY2g6IGZ1bmN0aW9uKGxvb3BhYmxlLCBmbiwgdGhpc0FyZywgcmV2ZXJzZSkgewoJCXZhciBpLCBsZW4sIGtleXM7CgkJaWYgKGhlbHBlcnMuaXNBcnJheShsb29wYWJsZSkpIHsKCQkJbGVuID0gbG9vcGFibGUubGVuZ3RoOwoJCQlpZiAocmV2ZXJzZSkgewoJCQkJZm9yIChpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJCQlmbi5jYWxsKHRoaXNBcmcsIGxvb3BhYmxlW2ldLCBpKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewoJCQkJCWZuLmNhbGwodGhpc0FyZywgbG9vcGFibGVbaV0sIGkpOwoJCQkJfQoJCQl9CgkJfSBlbHNlIGlmIChoZWxwZXJzLmlzT2JqZWN0KGxvb3BhYmxlKSkgewoJCQlrZXlzID0gT2JqZWN0LmtleXMobG9vcGFibGUpOwoJCQlsZW4gPSBrZXlzLmxlbmd0aDsKCQkJZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkJCQlmbi5jYWxsKHRoaXNBcmcsIGxvb3BhYmxlW2tleXNbaV1dLCBrZXlzW2ldKTsKCQkJfQoJCX0KCX0sCgoJLyoqCgkgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGBhMGAgYW5kIGBhMWAgYXJyYXlzIGhhdmUgdGhlIHNhbWUgY29udGVudCwgZWxzZSByZXR1cm5zIGZhbHNlLgoJICogQHNlZSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8xNDg1Mzk3NAoJICogQHBhcmFtIHtBcnJheX0gYTAgLSBUaGUgYXJyYXkgdG8gY29tcGFyZQoJICogQHBhcmFtIHtBcnJheX0gYTEgLSBUaGUgYXJyYXkgdG8gY29tcGFyZQoJICogQHJldHVybnMge0Jvb2xlYW59CgkgKi8KCWFycmF5RXF1YWxzOiBmdW5jdGlvbihhMCwgYTEpIHsKCQl2YXIgaSwgaWxlbiwgdjAsIHYxOwoKCQlpZiAoIWEwIHx8ICFhMSB8fCBhMC5sZW5ndGggIT09IGExLmxlbmd0aCkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlmb3IgKGkgPSAwLCBpbGVuID0gYTAubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCXYwID0gYTBbaV07CgkJCXYxID0gYTFbaV07CgoJCQlpZiAodjAgaW5zdGFuY2VvZiBBcnJheSAmJiB2MSBpbnN0YW5jZW9mIEFycmF5KSB7CgkJCQlpZiAoIWhlbHBlcnMuYXJyYXlFcXVhbHModjAsIHYxKSkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSBlbHNlIGlmICh2MCAhPT0gdjEpIHsKCQkJCS8vIE5PVEU6IHR3byBkaWZmZXJlbnQgb2JqZWN0IGluc3RhbmNlcyB3aWxsIG5ldmVyIGJlIGVxdWFsOiB7eDoyMH0gIT0ge3g6MjB9CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgoJCXJldHVybiB0cnVlOwoJfSwKCgkvKioKCSAqIFJldHVybnMgYSBkZWVwIGNvcHkgb2YgYHNvdXJjZWAgd2l0aG91dCBrZWVwaW5nIHJlZmVyZW5jZXMgb24gb2JqZWN0cyBhbmQgYXJyYXlzLgoJICogQHBhcmFtIHsqfSBzb3VyY2UgLSBUaGUgdmFsdWUgdG8gY2xvbmUuCgkgKiBAcmV0dXJucyB7Kn0KCSAqLwoJY2xvbmU6IGZ1bmN0aW9uKHNvdXJjZSkgewoJCWlmIChoZWxwZXJzLmlzQXJyYXkoc291cmNlKSkgewoJCQlyZXR1cm4gc291cmNlLm1hcChoZWxwZXJzLmNsb25lKTsKCQl9CgoJCWlmIChoZWxwZXJzLmlzT2JqZWN0KHNvdXJjZSkpIHsKCQkJdmFyIHRhcmdldCA9IHt9OwoJCQl2YXIga2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7CgkJCXZhciBrbGVuID0ga2V5cy5sZW5ndGg7CgkJCXZhciBrID0gMDsKCgkJCWZvciAoOyBrIDwga2xlbjsgKytrKSB7CgkJCQl0YXJnZXRba2V5c1trXV0gPSBoZWxwZXJzLmNsb25lKHNvdXJjZVtrZXlzW2tdXSk7CgkJCX0KCgkJCXJldHVybiB0YXJnZXQ7CgkJfQoKCQlyZXR1cm4gc291cmNlOwoJfSwKCgkvKioKCSAqIFRoZSBkZWZhdWx0IG1lcmdlciB3aGVuIENoYXJ0LmhlbHBlcnMubWVyZ2UgaXMgY2FsbGVkIHdpdGhvdXQgbWVyZ2VyIG9wdGlvbi4KCSAqIE5vdGUoU0IpOiB0aGlzIG1ldGhvZCBpcyBhbHNvIHVzZWQgYnkgY29uZmlnTWVyZ2UgYW5kIHNjYWxlTWVyZ2UgYXMgZmFsbGJhY2suCgkgKiBAcHJpdmF0ZQoJICovCglfbWVyZ2VyOiBmdW5jdGlvbihrZXksIHRhcmdldCwgc291cmNlLCBvcHRpb25zKSB7CgkJdmFyIHR2YWwgPSB0YXJnZXRba2V5XTsKCQl2YXIgc3ZhbCA9IHNvdXJjZVtrZXldOwoKCQlpZiAoaGVscGVycy5pc09iamVjdCh0dmFsKSAmJiBoZWxwZXJzLmlzT2JqZWN0KHN2YWwpKSB7CgkJCWhlbHBlcnMubWVyZ2UodHZhbCwgc3ZhbCwgb3B0aW9ucyk7CgkJfSBlbHNlIHsKCQkJdGFyZ2V0W2tleV0gPSBoZWxwZXJzLmNsb25lKHN2YWwpOwoJCX0KCX0sCgoJLyoqCgkgKiBNZXJnZXMgc291cmNlW2tleV0gaW4gdGFyZ2V0W2tleV0gb25seSBpZiB0YXJnZXRba2V5XSBpcyB1bmRlZmluZWQuCgkgKiBAcHJpdmF0ZQoJICovCglfbWVyZ2VySWY6IGZ1bmN0aW9uKGtleSwgdGFyZ2V0LCBzb3VyY2UpIHsKCQl2YXIgdHZhbCA9IHRhcmdldFtrZXldOwoJCXZhciBzdmFsID0gc291cmNlW2tleV07CgoJCWlmIChoZWxwZXJzLmlzT2JqZWN0KHR2YWwpICYmIGhlbHBlcnMuaXNPYmplY3Qoc3ZhbCkpIHsKCQkJaGVscGVycy5tZXJnZUlmKHR2YWwsIHN2YWwpOwoJCX0gZWxzZSBpZiAoIXRhcmdldC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CgkJCXRhcmdldFtrZXldID0gaGVscGVycy5jbG9uZShzdmFsKTsKCQl9Cgl9LAoKCS8qKgoJICogUmVjdXJzaXZlbHkgZGVlcCBjb3BpZXMgYHNvdXJjZWAgcHJvcGVydGllcyBpbnRvIGB0YXJnZXRgIHdpdGggdGhlIGdpdmVuIGBvcHRpb25zYC4KCSAqIElNUE9SVEFOVDogYHRhcmdldGAgaXMgbm90IGNsb25lZCBhbmQgd2lsbCBiZSB1cGRhdGVkIHdpdGggYHNvdXJjZWAgcHJvcGVydGllcy4KCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgLSBUaGUgdGFyZ2V0IG9iamVjdCBpbiB3aGljaCBhbGwgc291cmNlcyBhcmUgbWVyZ2VkIGludG8uCgkgKiBAcGFyYW0ge09iamVjdHxBcnJheShPYmplY3QpfSBzb3VyY2UgLSBPYmplY3QocykgdG8gbWVyZ2UgaW50byBgdGFyZ2V0YC4KCSAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gLSBNZXJnaW5nIG9wdGlvbnM6CgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbb3B0aW9ucy5tZXJnZXJdIC0gVGhlIG1lcmdlIG1ldGhvZCAoa2V5LCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucykKCSAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBgdGFyZ2V0YCBvYmplY3QuCgkgKi8KCW1lcmdlOiBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucykgewoJCXZhciBzb3VyY2VzID0gaGVscGVycy5pc0FycmF5KHNvdXJjZSkgPyBzb3VyY2UgOiBbc291cmNlXTsKCQl2YXIgaWxlbiA9IHNvdXJjZXMubGVuZ3RoOwoJCXZhciBtZXJnZSwgaSwga2V5cywga2xlbiwgazsKCgkJaWYgKCFoZWxwZXJzLmlzT2JqZWN0KHRhcmdldCkpIHsKCQkJcmV0dXJuIHRhcmdldDsKCQl9CgoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW1lcmdlID0gb3B0aW9ucy5tZXJnZXIgfHwgaGVscGVycy5fbWVyZ2VyOwoKCQlmb3IgKGkgPSAwOyBpIDwgaWxlbjsgKytpKSB7CgkJCXNvdXJjZSA9IHNvdXJjZXNbaV07CgkJCWlmICghaGVscGVycy5pc09iamVjdChzb3VyY2UpKSB7CgkJCQljb250aW51ZTsKCQkJfQoKCQkJa2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7CgkJCWZvciAoayA9IDAsIGtsZW4gPSBrZXlzLmxlbmd0aDsgayA8IGtsZW47ICsraykgewoJCQkJbWVyZ2Uoa2V5c1trXSwgdGFyZ2V0LCBzb3VyY2UsIG9wdGlvbnMpOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGFyZ2V0OwoJfSwKCgkvKioKCSAqIFJlY3Vyc2l2ZWx5IGRlZXAgY29waWVzIGBzb3VyY2VgIHByb3BlcnRpZXMgaW50byBgdGFyZ2V0YCAqb25seSogaWYgbm90IGRlZmluZWQgaW4gdGFyZ2V0LgoJICogSU1QT1JUQU5UOiBgdGFyZ2V0YCBpcyBub3QgY2xvbmVkIGFuZCB3aWxsIGJlIHVwZGF0ZWQgd2l0aCBgc291cmNlYCBwcm9wZXJ0aWVzLgoJICogQHBhcmFtIHtPYmplY3R9IHRhcmdldCAtIFRoZSB0YXJnZXQgb2JqZWN0IGluIHdoaWNoIGFsbCBzb3VyY2VzIGFyZSBtZXJnZWQgaW50by4KCSAqIEBwYXJhbSB7T2JqZWN0fEFycmF5KE9iamVjdCl9IHNvdXJjZSAtIE9iamVjdChzKSB0byBtZXJnZSBpbnRvIGB0YXJnZXRgLgoJICogQHJldHVybnMge09iamVjdH0gVGhlIGB0YXJnZXRgIG9iamVjdC4KCSAqLwoJbWVyZ2VJZjogZnVuY3Rpb24odGFyZ2V0LCBzb3VyY2UpIHsKCQlyZXR1cm4gaGVscGVycy5tZXJnZSh0YXJnZXQsIHNvdXJjZSwge21lcmdlcjogaGVscGVycy5fbWVyZ2VySWZ9KTsKCX0sCgoJLyoqCgkgKiBBcHBsaWVzIHRoZSBjb250ZW50cyBvZiB0d28gb3IgbW9yZSBvYmplY3RzIHRvZ2V0aGVyIGludG8gdGhlIGZpcnN0IG9iamVjdC4KCSAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQgLSBUaGUgdGFyZ2V0IG9iamVjdCBpbiB3aGljaCBhbGwgb2JqZWN0cyBhcmUgbWVyZ2VkIGludG8uCgkgKiBAcGFyYW0ge09iamVjdH0gYXJnMSAtIE9iamVjdCBjb250YWluaW5nIGFkZGl0aW9uYWwgcHJvcGVydGllcyB0byBtZXJnZSBpbiB0YXJnZXQuCgkgKiBAcGFyYW0ge09iamVjdH0gYXJnTiAtIEFkZGl0aW9uYWwgb2JqZWN0cyBjb250YWluaW5nIHByb3BlcnRpZXMgdG8gbWVyZ2UgaW4gdGFyZ2V0LgoJICogQHJldHVybnMge09iamVjdH0gVGhlIGB0YXJnZXRgIG9iamVjdC4KCSAqLwoJZXh0ZW5kOiBmdW5jdGlvbih0YXJnZXQpIHsKCQl2YXIgc2V0Rm4gPSBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CgkJCXRhcmdldFtrZXldID0gdmFsdWU7CgkJfTsKCQlmb3IgKHZhciBpID0gMSwgaWxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJaGVscGVycy5lYWNoKGFyZ3VtZW50c1tpXSwgc2V0Rm4pOwoJCX0KCQlyZXR1cm4gdGFyZ2V0OwoJfSwKCgkvKioKCSAqIEJhc2ljIGphdmFzY3JpcHQgaW5oZXJpdGFuY2UgYmFzZWQgb24gdGhlIG1vZGVsIGNyZWF0ZWQgaW4gQmFja2JvbmUuanMKCSAqLwoJaW5oZXJpdHM6IGZ1bmN0aW9uKGV4dGVuc2lvbnMpIHsKCQl2YXIgbWUgPSB0aGlzOwoJCXZhciBDaGFydEVsZW1lbnQgPSAoZXh0ZW5zaW9ucyAmJiBleHRlbnNpb25zLmhhc093blByb3BlcnR5KCdjb25zdHJ1Y3RvcicpKSA/IGV4dGVuc2lvbnMuY29uc3RydWN0b3IgOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIG1lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgkJfTsKCgkJdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmNvbnN0cnVjdG9yID0gQ2hhcnRFbGVtZW50OwoJCX07CgoJCVN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBtZS5wcm90b3R5cGU7CgkJQ2hhcnRFbGVtZW50LnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGUoKTsKCQlDaGFydEVsZW1lbnQuZXh0ZW5kID0gaGVscGVycy5pbmhlcml0czsKCgkJaWYgKGV4dGVuc2lvbnMpIHsKCQkJaGVscGVycy5leHRlbmQoQ2hhcnRFbGVtZW50LnByb3RvdHlwZSwgZXh0ZW5zaW9ucyk7CgkJfQoKCQlDaGFydEVsZW1lbnQuX19zdXBlcl9fID0gbWUucHJvdG90eXBlOwoJCXJldHVybiBDaGFydEVsZW1lbnQ7Cgl9Cn07Cgptb2R1bGUuZXhwb3J0cyA9IGhlbHBlcnM7CgovLyBERVBSRUNBVElPTlMKCi8qKgogKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LmhlbHBlcnMuY2FsbGJhY2sgaW5zdGVhZC4KICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuY2FsbENhbGxiYWNrCiAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi42LjAKICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMwogKiBAcHJpdmF0ZQogKi8KaGVscGVycy5jYWxsQ2FsbGJhY2sgPSBoZWxwZXJzLmNhbGxiYWNrOwoKLyoqCiAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgaW5zdGVhZC4KICogQXJyYXkucHJvdG90eXBlLmluZGV4T2YgY29tcGF0aWJpbGl0eTogQ2hyb21lLCBPcGVyYSwgU2FmYXJpLCBGRjEuNSssIElFOSsKICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuaW5kZXhPZgogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNy4wCiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCmhlbHBlcnMuaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tSW5kZXgpIHsKCXJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGFycmF5LCBpdGVtLCBmcm9tSW5kZXgpOwp9OwoKLyoqCiAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy52YWx1ZU9yRGVmYXVsdCBpbnN0ZWFkLgogKiBAZnVuY3Rpb24gQ2hhcnQuaGVscGVycy5nZXRWYWx1ZU9yRGVmYXVsdAogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNy4wCiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCmhlbHBlcnMuZ2V0VmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoKLyoqCiAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQgaW5zdGVhZC4KICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuZ2V0VmFsdWVBdEluZGV4T3JEZWZhdWx0CiAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi43LjAKICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMwogKiBAcHJpdmF0ZQogKi8KaGVscGVycy5nZXRWYWx1ZUF0SW5kZXhPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdDsKCn0se31dLDQzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQyKTsKCi8qKgogKiBFYXNpbmcgZnVuY3Rpb25zIGFkYXB0ZWQgZnJvbSBSb2JlcnQgUGVubmVyJ3MgZWFzaW5nIGVxdWF0aW9ucy4KICogQG5hbWVzcGFjZSBDaGFydC5oZWxwZXJzLmVhc2luZ0VmZmVjdHMKICogQHNlZSBodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLwogKi8KdmFyIGVmZmVjdHMgPSB7CglsaW5lYXI6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gdDsKCX0sCgoJZWFzZUluUXVhZDogZnVuY3Rpb24odCkgewoJCXJldHVybiB0ICogdDsKCX0sCgoJZWFzZU91dFF1YWQ6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gLXQgKiAodCAtIDIpOwoJfSwKCgllYXNlSW5PdXRRdWFkOiBmdW5jdGlvbih0KSB7CgkJaWYgKCh0IC89IDAuNSkgPCAxKSB7CgkJCXJldHVybiAwLjUgKiB0ICogdDsKCQl9CgkJcmV0dXJuIC0wLjUgKiAoKC0tdCkgKiAodCAtIDIpIC0gMSk7Cgl9LAoKCWVhc2VJbkN1YmljOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIHQgKiB0ICogdDsKCX0sCgoJZWFzZU91dEN1YmljOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuICh0ID0gdCAtIDEpICogdCAqIHQgKyAxOwoJfSwKCgllYXNlSW5PdXRDdWJpYzogZnVuY3Rpb24odCkgewoJCWlmICgodCAvPSAwLjUpIDwgMSkgewoJCQlyZXR1cm4gMC41ICogdCAqIHQgKiB0OwoJCX0KCQlyZXR1cm4gMC41ICogKCh0IC09IDIpICogdCAqIHQgKyAyKTsKCX0sCgoJZWFzZUluUXVhcnQ6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gdCAqIHQgKiB0ICogdDsKCX0sCgoJZWFzZU91dFF1YXJ0OiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIC0oKHQgPSB0IC0gMSkgKiB0ICogdCAqIHQgLSAxKTsKCX0sCgoJZWFzZUluT3V0UXVhcnQ6IGZ1bmN0aW9uKHQpIHsKCQlpZiAoKHQgLz0gMC41KSA8IDEpIHsKCQkJcmV0dXJuIDAuNSAqIHQgKiB0ICogdCAqIHQ7CgkJfQoJCXJldHVybiAtMC41ICogKCh0IC09IDIpICogdCAqIHQgKiB0IC0gMik7Cgl9LAoKCWVhc2VJblF1aW50OiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIHQgKiB0ICogdCAqIHQgKiB0OwoJfSwKCgllYXNlT3V0UXVpbnQ6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gKHQgPSB0IC0gMSkgKiB0ICogdCAqIHQgKiB0ICsgMTsKCX0sCgoJZWFzZUluT3V0UXVpbnQ6IGZ1bmN0aW9uKHQpIHsKCQlpZiAoKHQgLz0gMC41KSA8IDEpIHsKCQkJcmV0dXJuIDAuNSAqIHQgKiB0ICogdCAqIHQgKiB0OwoJCX0KCQlyZXR1cm4gMC41ICogKCh0IC09IDIpICogdCAqIHQgKiB0ICogdCArIDIpOwoJfSwKCgllYXNlSW5TaW5lOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIC1NYXRoLmNvcyh0ICogKE1hdGguUEkgLyAyKSkgKyAxOwoJfSwKCgllYXNlT3V0U2luZTogZnVuY3Rpb24odCkgewoJCXJldHVybiBNYXRoLnNpbih0ICogKE1hdGguUEkgLyAyKSk7Cgl9LAoKCWVhc2VJbk91dFNpbmU6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gLTAuNSAqIChNYXRoLmNvcyhNYXRoLlBJICogdCkgLSAxKTsKCX0sCgoJZWFzZUluRXhwbzogZnVuY3Rpb24odCkgewoJCXJldHVybiAodCA9PT0gMCkgPyAwIDogTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKTsKCX0sCgoJZWFzZU91dEV4cG86IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gKHQgPT09IDEpID8gMSA6IC1NYXRoLnBvdygyLCAtMTAgKiB0KSArIDE7Cgl9LAoKCWVhc2VJbk91dEV4cG86IGZ1bmN0aW9uKHQpIHsKCQlpZiAodCA9PT0gMCkgewoJCQlyZXR1cm4gMDsKCQl9CgkJaWYgKHQgPT09IDEpIHsKCQkJcmV0dXJuIDE7CgkJfQoJCWlmICgodCAvPSAwLjUpIDwgMSkgewoJCQlyZXR1cm4gMC41ICogTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKTsKCQl9CgkJcmV0dXJuIDAuNSAqICgtTWF0aC5wb3coMiwgLTEwICogLS10KSArIDIpOwoJfSwKCgllYXNlSW5DaXJjOiBmdW5jdGlvbih0KSB7CgkJaWYgKHQgPj0gMSkgewoJCQlyZXR1cm4gdDsKCQl9CgkJcmV0dXJuIC0oTWF0aC5zcXJ0KDEgLSB0ICogdCkgLSAxKTsKCX0sCgoJZWFzZU91dENpcmM6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gTWF0aC5zcXJ0KDEgLSAodCA9IHQgLSAxKSAqIHQpOwoJfSwKCgllYXNlSW5PdXRDaXJjOiBmdW5jdGlvbih0KSB7CgkJaWYgKCh0IC89IDAuNSkgPCAxKSB7CgkJCXJldHVybiAtMC41ICogKE1hdGguc3FydCgxIC0gdCAqIHQpIC0gMSk7CgkJfQoJCXJldHVybiAwLjUgKiAoTWF0aC5zcXJ0KDEgLSAodCAtPSAyKSAqIHQpICsgMSk7Cgl9LAoKCWVhc2VJbkVsYXN0aWM6IGZ1bmN0aW9uKHQpIHsKCQl2YXIgcyA9IDEuNzAxNTg7CgkJdmFyIHAgPSAwOwoJCXZhciBhID0gMTsKCQlpZiAodCA9PT0gMCkgewoJCQlyZXR1cm4gMDsKCQl9CgkJaWYgKHQgPT09IDEpIHsKCQkJcmV0dXJuIDE7CgkJfQoJCWlmICghcCkgewoJCQlwID0gMC4zOwoJCX0KCQlpZiAoYSA8IDEpIHsKCQkJYSA9IDE7CgkJCXMgPSBwIC8gNDsKCQl9IGVsc2UgewoJCQlzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oMSAvIGEpOwoJCX0KCQlyZXR1cm4gLShhICogTWF0aC5wb3coMiwgMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKTsKCX0sCgoJZWFzZU91dEVsYXN0aWM6IGZ1bmN0aW9uKHQpIHsKCQl2YXIgcyA9IDEuNzAxNTg7CgkJdmFyIHAgPSAwOwoJCXZhciBhID0gMTsKCQlpZiAodCA9PT0gMCkgewoJCQlyZXR1cm4gMDsKCQl9CgkJaWYgKHQgPT09IDEpIHsKCQkJcmV0dXJuIDE7CgkJfQoJCWlmICghcCkgewoJCQlwID0gMC4zOwoJCX0KCQlpZiAoYSA8IDEpIHsKCQkJYSA9IDE7CgkJCXMgPSBwIC8gNDsKCQl9IGVsc2UgewoJCQlzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oMSAvIGEpOwoJCX0KCQlyZXR1cm4gYSAqIE1hdGgucG93KDIsIC0xMCAqIHQpICogTWF0aC5zaW4oKHQgLSBzKSAqICgyICogTWF0aC5QSSkgLyBwKSArIDE7Cgl9LAoKCWVhc2VJbk91dEVsYXN0aWM6IGZ1bmN0aW9uKHQpIHsKCQl2YXIgcyA9IDEuNzAxNTg7CgkJdmFyIHAgPSAwOwoJCXZhciBhID0gMTsKCQlpZiAodCA9PT0gMCkgewoJCQlyZXR1cm4gMDsKCQl9CgkJaWYgKCh0IC89IDAuNSkgPT09IDIpIHsKCQkJcmV0dXJuIDE7CgkJfQoJCWlmICghcCkgewoJCQlwID0gMC40NTsKCQl9CgkJaWYgKGEgPCAxKSB7CgkJCWEgPSAxOwoJCQlzID0gcCAvIDQ7CgkJfSBlbHNlIHsKCQkJcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKDEgLyBhKTsKCQl9CgkJaWYgKHQgPCAxKSB7CgkJCXJldHVybiAtMC41ICogKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0IC0gcykgKiAoMiAqIE1hdGguUEkpIC8gcCkpOwoJCX0KCQlyZXR1cm4gYSAqIE1hdGgucG93KDIsIC0xMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0IC0gcykgKiAoMiAqIE1hdGguUEkpIC8gcCkgKiAwLjUgKyAxOwoJfSwKCWVhc2VJbkJhY2s6IGZ1bmN0aW9uKHQpIHsKCQl2YXIgcyA9IDEuNzAxNTg7CgkJcmV0dXJuIHQgKiB0ICogKChzICsgMSkgKiB0IC0gcyk7Cgl9LAoKCWVhc2VPdXRCYWNrOiBmdW5jdGlvbih0KSB7CgkJdmFyIHMgPSAxLjcwMTU4OwoJCXJldHVybiAodCA9IHQgLSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgKyBzKSArIDE7Cgl9LAoKCWVhc2VJbk91dEJhY2s6IGZ1bmN0aW9uKHQpIHsKCQl2YXIgcyA9IDEuNzAxNTg7CgkJaWYgKCh0IC89IDAuNSkgPCAxKSB7CgkJCXJldHVybiAwLjUgKiAodCAqIHQgKiAoKChzICo9ICgxLjUyNSkpICsgMSkgKiB0IC0gcykpOwoJCX0KCQlyZXR1cm4gMC41ICogKCh0IC09IDIpICogdCAqICgoKHMgKj0gKDEuNTI1KSkgKyAxKSAqIHQgKyBzKSArIDIpOwoJfSwKCgllYXNlSW5Cb3VuY2U6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gMSAtIGVmZmVjdHMuZWFzZU91dEJvdW5jZSgxIC0gdCk7Cgl9LAoKCWVhc2VPdXRCb3VuY2U6IGZ1bmN0aW9uKHQpIHsKCQlpZiAodCA8ICgxIC8gMi43NSkpIHsKCQkJcmV0dXJuIDcuNTYyNSAqIHQgKiB0OwoJCX0KCQlpZiAodCA8ICgyIC8gMi43NSkpIHsKCQkJcmV0dXJuIDcuNTYyNSAqICh0IC09ICgxLjUgLyAyLjc1KSkgKiB0ICsgMC43NTsKCQl9CgkJaWYgKHQgPCAoMi41IC8gMi43NSkpIHsKCQkJcmV0dXJuIDcuNTYyNSAqICh0IC09ICgyLjI1IC8gMi43NSkpICogdCArIDAuOTM3NTsKCQl9CgkJcmV0dXJuIDcuNTYyNSAqICh0IC09ICgyLjYyNSAvIDIuNzUpKSAqIHQgKyAwLjk4NDM3NTsKCX0sCgoJZWFzZUluT3V0Qm91bmNlOiBmdW5jdGlvbih0KSB7CgkJaWYgKHQgPCAwLjUpIHsKCQkJcmV0dXJuIGVmZmVjdHMuZWFzZUluQm91bmNlKHQgKiAyKSAqIDAuNTsKCQl9CgkJcmV0dXJuIGVmZmVjdHMuZWFzZU91dEJvdW5jZSh0ICogMiAtIDEpICogMC41ICsgMC41OwoJfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSB7CgllZmZlY3RzOiBlZmZlY3RzCn07CgovLyBERVBSRUNBVElPTlMKCi8qKgogKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LmhlbHBlcnMuZWFzaW5nLmVmZmVjdHMgaW5zdGVhZC4KICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuZWFzaW5nRWZmZWN0cwogKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNy4wCiAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMKICogQHByaXZhdGUKICovCmhlbHBlcnMuZWFzaW5nRWZmZWN0cyA9IGVmZmVjdHM7Cgp9LHsiNDIiOjQyfV0sNDQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDIpOwoKLyoqCiAqIEBhbGlhcyBDaGFydC5oZWxwZXJzLm9wdGlvbnMKICogQG5hbWVzcGFjZQogKi8KbW9kdWxlLmV4cG9ydHMgPSB7CgkvKioKCSAqIENvbnZlcnRzIHRoZSBnaXZlbiBsaW5lIGhlaWdodCBgdmFsdWVgIGluIHBpeGVscyBmb3IgYSBzcGVjaWZpYyBmb250IGBzaXplYC4KCSAqIEBwYXJhbSB7TnVtYmVyfFN0cmluZ30gdmFsdWUgLSBUaGUgbGluZUhlaWdodCB0byBwYXJzZSAoZWcuIDEuNiwgJzE0cHgnLCAnNzUlJywgJzEuNmVtJykuCgkgKiBAcGFyYW0ge051bWJlcn0gc2l6ZSAtIFRoZSBmb250IHNpemUgKGluIHBpeGVscykgdXNlZCB0byByZXNvbHZlIHJlbGF0aXZlIGB2YWx1ZWAuCgkgKiBAcmV0dXJucyB7TnVtYmVyfSBUaGUgZWZmZWN0aXZlIGxpbmUgaGVpZ2h0IGluIHBpeGVscyAoc2l6ZSAqIDEuMiBpZiB2YWx1ZSBpcyBpbnZhbGlkKS4KCSAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL2xpbmUtaGVpZ2h0CgkgKiBAc2luY2UgMi43LjAKCSAqLwoJdG9MaW5lSGVpZ2h0OiBmdW5jdGlvbih2YWx1ZSwgc2l6ZSkgewoJCXZhciBtYXRjaGVzID0gKCcnICsgdmFsdWUpLm1hdGNoKC9eKG5vcm1hbHwoXGQrKD86XC5cZCspPykocHh8ZW18JSk/KSQvKTsKCQlpZiAoIW1hdGNoZXMgfHwgbWF0Y2hlc1sxXSA9PT0gJ25vcm1hbCcpIHsKCQkJcmV0dXJuIHNpemUgKiAxLjI7CgkJfQoKCQl2YWx1ZSA9ICttYXRjaGVzWzJdOwoKCQlzd2l0Y2ggKG1hdGNoZXNbM10pIHsKCQljYXNlICdweCc6CgkJCXJldHVybiB2YWx1ZTsKCQljYXNlICclJzoKCQkJdmFsdWUgLz0gMTAwOwoJCQlicmVhazsKCQlkZWZhdWx0OgoJCQlicmVhazsKCQl9CgoJCXJldHVybiBzaXplICogdmFsdWU7Cgl9LAoKCS8qKgoJICogQ29udmVydHMgdGhlIGdpdmVuIHZhbHVlIGludG8gYSBwYWRkaW5nIG9iamVjdCB3aXRoIHByZS1jb21wdXRlZCB3aWR0aC9oZWlnaHQuCgkgKiBAcGFyYW0ge051bWJlcnxPYmplY3R9IHZhbHVlIC0gSWYgYSBudW1iZXIsIHNldCB0aGUgdmFsdWUgdG8gYWxsIFRSQkwgY29tcG9uZW50LAoJICogIGVsc2UsIGlmIGFuZCBvYmplY3QsIHVzZSBkZWZpbmVkIHByb3BlcnRpZXMgYW5kIHNldHMgdW5kZWZpbmVkIG9uZXMgdG8gMC4KCSAqIEByZXR1cm5zIHtPYmplY3R9IFRoZSBwYWRkaW5nIHZhbHVlcyAodG9wLCByaWdodCwgYm90dG9tLCBsZWZ0LCB3aWR0aCwgaGVpZ2h0KQoJICogQHNpbmNlIDIuNy4wCgkgKi8KCXRvUGFkZGluZzogZnVuY3Rpb24odmFsdWUpIHsKCQl2YXIgdCwgciwgYiwgbDsKCgkJaWYgKGhlbHBlcnMuaXNPYmplY3QodmFsdWUpKSB7CgkJCXQgPSArdmFsdWUudG9wIHx8IDA7CgkJCXIgPSArdmFsdWUucmlnaHQgfHwgMDsKCQkJYiA9ICt2YWx1ZS5ib3R0b20gfHwgMDsKCQkJbCA9ICt2YWx1ZS5sZWZ0IHx8IDA7CgkJfSBlbHNlIHsKCQkJdCA9IHIgPSBiID0gbCA9ICt2YWx1ZSB8fCAwOwoJCX0KCgkJcmV0dXJuIHsKCQkJdG9wOiB0LAoJCQlyaWdodDogciwKCQkJYm90dG9tOiBiLAoJCQlsZWZ0OiBsLAoJCQloZWlnaHQ6IHQgKyBiLAoJCQl3aWR0aDogbCArIHIKCQl9OwoJfSwKCgkvKioKCSAqIEV2YWx1YXRlcyB0aGUgZ2l2ZW4gYGlucHV0c2Agc2VxdWVudGlhbGx5IGFuZCByZXR1cm5zIHRoZSBmaXJzdCBkZWZpbmVkIHZhbHVlLgoJICogQHBhcmFtIHtBcnJheVtdfSBpbnB1dHMgLSBBbiBhcnJheSBvZiB2YWx1ZXMsIGZhbGxpbmcgYmFjayB0byB0aGUgbGFzdCB2YWx1ZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBbY29udGV4dF0gLSBJZiBkZWZpbmVkIGFuZCB0aGUgY3VycmVudCB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCB0aGUgdmFsdWUKCSAqIGlzIGNhbGxlZCB3aXRoIGBjb250ZXh0YCBhcyBmaXJzdCBhcmd1bWVudCBhbmQgdGhlIHJlc3VsdCBiZWNvbWVzIHRoZSBuZXcgaW5wdXQuCgkgKiBAcGFyYW0ge051bWJlcn0gW2luZGV4XSAtIElmIGRlZmluZWQgYW5kIHRoZSBjdXJyZW50IHZhbHVlIGlzIGFuIGFycmF5LCB0aGUgdmFsdWUKCSAqIGF0IGBpbmRleGAgYmVjb21lIHRoZSBuZXcgaW5wdXQuCgkgKiBAc2luY2UgMi43LjAKCSAqLwoJcmVzb2x2ZTogZnVuY3Rpb24oaW5wdXRzLCBjb250ZXh0LCBpbmRleCkgewoJCXZhciBpLCBpbGVuLCB2YWx1ZTsKCgkJZm9yIChpID0gMCwgaWxlbiA9IGlucHV0cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKCQkJdmFsdWUgPSBpbnB1dHNbaV07CgkJCWlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CgkJCQljb250aW51ZTsKCQkJfQoJCQlpZiAoY29udGV4dCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJdmFsdWUgPSB2YWx1ZShjb250ZXh0KTsKCQkJfQoJCQlpZiAoaW5kZXggIT09IHVuZGVmaW5lZCAmJiBoZWxwZXJzLmlzQXJyYXkodmFsdWUpKSB7CgkJCQl2YWx1ZSA9IHZhbHVlW2luZGV4XTsKCQkJfQoJCQlpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9CgkJfQoJfQp9OwoKfSx7IjQyIjo0Mn1dLDQ1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKDQyKTsKbW9kdWxlLmV4cG9ydHMuZWFzaW5nID0gcmVxdWlyZSg0Myk7Cm1vZHVsZS5leHBvcnRzLmNhbnZhcyA9IHJlcXVpcmUoNDEpOwptb2R1bGUuZXhwb3J0cy5vcHRpb25zID0gcmVxdWlyZSg0NCk7Cgp9LHsiNDEiOjQxLCI0MiI6NDIsIjQzIjo0MywiNDQiOjQ0fV0sNDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogUGxhdGZvcm0gZmFsbGJhY2sgaW1wbGVtZW50YXRpb24gKG1pbmltYWwpLgogKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL3B1bGwvNDU5MSNpc3N1ZWNvbW1lbnQtMzE5NTc1OTM5CiAqLwoKbW9kdWxlLmV4cG9ydHMgPSB7CglhY3F1aXJlQ29udGV4dDogZnVuY3Rpb24oaXRlbSkgewoJCWlmIChpdGVtICYmIGl0ZW0uY2FudmFzKSB7CgkJCS8vIFN1cHBvcnQgZm9yIGFueSBvYmplY3QgYXNzb2NpYXRlZCB0byBhIGNhbnZhcyAoaW5jbHVkaW5nIGEgY29udGV4dDJkKQoJCQlpdGVtID0gaXRlbS5jYW52YXM7CgkJfQoKCQlyZXR1cm4gaXRlbSAmJiBpdGVtLmdldENvbnRleHQoJzJkJykgfHwgbnVsbDsKCX0KfTsKCn0se31dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIENoYXJ0LlBsYXRmb3JtIGltcGxlbWVudGF0aW9uIGZvciB0YXJnZXRpbmcgYSB3ZWIgYnJvd3NlcgogKi8KCid1c2Ugc3RyaWN0JzsKCnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7Cgp2YXIgRVhQQU5ET19LRVkgPSAnJGNoYXJ0anMnOwp2YXIgQ1NTX1BSRUZJWCA9ICdjaGFydGpzLSc7CnZhciBDU1NfUkVOREVSX01PTklUT1IgPSBDU1NfUFJFRklYICsgJ3JlbmRlci1tb25pdG9yJzsKdmFyIENTU19SRU5ERVJfQU5JTUFUSU9OID0gQ1NTX1BSRUZJWCArICdyZW5kZXItYW5pbWF0aW9uJzsKdmFyIEFOSU1BVElPTl9TVEFSVF9FVkVOVFMgPSBbJ2FuaW1hdGlvbnN0YXJ0JywgJ3dlYmtpdEFuaW1hdGlvblN0YXJ0J107CgovKioKICogRE9NIGV2ZW50IHR5cGVzIC0+IENoYXJ0LmpzIGV2ZW50IHR5cGVzLgogKiBOb3RlOiBvbmx5IGV2ZW50cyB3aXRoIGRpZmZlcmVudCB0eXBlcyBhcmUgbWFwcGVkLgogKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0V2ZW50cwogKi8KdmFyIEVWRU5UX1RZUEVTID0gewoJdG91Y2hzdGFydDogJ21vdXNlZG93bicsCgl0b3VjaG1vdmU6ICdtb3VzZW1vdmUnLAoJdG91Y2hlbmQ6ICdtb3VzZXVwJywKCXBvaW50ZXJlbnRlcjogJ21vdXNlZW50ZXInLAoJcG9pbnRlcmRvd246ICdtb3VzZWRvd24nLAoJcG9pbnRlcm1vdmU6ICdtb3VzZW1vdmUnLAoJcG9pbnRlcnVwOiAnbW91c2V1cCcsCglwb2ludGVybGVhdmU6ICdtb3VzZW91dCcsCglwb2ludGVyb3V0OiAnbW91c2VvdXQnCn07CgovKioKICogVGhlICJ1c2VkIiBzaXplIGlzIHRoZSBmaW5hbCB2YWx1ZSBvZiBhIGRpbWVuc2lvbiBwcm9wZXJ0eSBhZnRlciBhbGwgY2FsY3VsYXRpb25zIGhhdmUKICogYmVlbiBwZXJmb3JtZWQuIFRoaXMgbWV0aG9kIHVzZXMgdGhlIGNvbXB1dGVkIHN0eWxlIG9mIGBlbGVtZW50YCBidXQgcmV0dXJucyB1bmRlZmluZWQKICogaWYgdGhlIGNvbXB1dGVkIHN0eWxlIGlzIG5vdCBleHByZXNzZWQgaW4gcGl4ZWxzLiBUaGF0IGNhbiBoYXBwZW4gaW4gc29tZSBjYXNlcyB3aGVyZQogKiBgZWxlbWVudGAgaGFzIGEgc2l6ZSByZWxhdGl2ZSB0byBpdHMgcGFyZW50IGFuZCB0aGlzIGxhc3Qgb25lIGlzIG5vdCB5ZXQgZGlzcGxheWVkLAogKiBmb3IgZXhhbXBsZSBiZWNhdXNlIG9mIGBkaXNwbGF5OiBub25lYCBvbiBhIHBhcmVudCBub2RlLgogKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0NTUy91c2VkX3ZhbHVlCiAqIEByZXR1cm5zIHtOdW1iZXJ9IFNpemUgaW4gcGl4ZWxzIG9yIHVuZGVmaW5lZCBpZiB1bmtub3duLgogKi8KZnVuY3Rpb24gcmVhZFVzZWRTaXplKGVsZW1lbnQsIHByb3BlcnR5KSB7Cgl2YXIgdmFsdWUgPSBoZWxwZXJzLmdldFN0eWxlKGVsZW1lbnQsIHByb3BlcnR5KTsKCXZhciBtYXRjaGVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2goL14oXGQrKShcLlxkKyk/cHgkLyk7CglyZXR1cm4gbWF0Y2hlcyA/IE51bWJlcihtYXRjaGVzWzFdKSA6IHVuZGVmaW5lZDsKfQoKLyoqCiAqIEluaXRpYWxpemVzIHRoZSBjYW52YXMgc3R5bGUgYW5kIHJlbmRlciBzaXplIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBjYW52YXMgZGlzcGxheSBzaXplLAogKiBzaW5jZSByZXNwb25zaXZlbmVzcyBpcyBoYW5kbGVkIGJ5IHRoZSBjb250cm9sbGVyLnJlc2l6ZSgpIG1ldGhvZC4gVGhlIGNvbmZpZyBpcyB1c2VkCiAqIHRvIGRldGVybWluZSB0aGUgYXNwZWN0IHJhdGlvIHRvIGFwcGx5IGluIGNhc2Ugbm8gZXhwbGljaXQgaGVpZ2h0IGhhcyBiZWVuIHNwZWNpZmllZC4KICovCmZ1bmN0aW9uIGluaXRDYW52YXMoY2FudmFzLCBjb25maWcpIHsKCXZhciBzdHlsZSA9IGNhbnZhcy5zdHlsZTsKCgkvLyBOT1RFKFNCKSBjYW52YXMuZ2V0QXR0cmlidXRlKCd3aWR0aCcpICE9PSBjYW52YXMud2lkdGg6IGluIHRoZSBmaXJzdCBjYXNlIGl0CgkvLyByZXR1cm5zIG51bGwgb3IgJycgaWYgbm8gZXhwbGljaXQgdmFsdWUgaGFzIGJlZW4gc2V0IHRvIHRoZSBjYW52YXMgYXR0cmlidXRlLgoJdmFyIHJlbmRlckhlaWdodCA9IGNhbnZhcy5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpOwoJdmFyIHJlbmRlcldpZHRoID0gY2FudmFzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKTsKCgkvLyBDaGFydC5qcyBtb2RpZmllcyBzb21lIGNhbnZhcyB2YWx1ZXMgdGhhdCB3ZSB3YW50IHRvIHJlc3RvcmUgb24gZGVzdHJveQoJY2FudmFzW0VYUEFORE9fS0VZXSA9IHsKCQlpbml0aWFsOiB7CgkJCWhlaWdodDogcmVuZGVySGVpZ2h0LAoJCQl3aWR0aDogcmVuZGVyV2lkdGgsCgkJCXN0eWxlOiB7CgkJCQlkaXNwbGF5OiBzdHlsZS5kaXNwbGF5LAoJCQkJaGVpZ2h0OiBzdHlsZS5oZWlnaHQsCgkJCQl3aWR0aDogc3R5bGUud2lkdGgKCQkJfQoJCX0KCX07CgoJLy8gRm9yY2UgY2FudmFzIHRvIGRpc3BsYXkgYXMgYmxvY2sgdG8gYXZvaWQgZXh0cmEgc3BhY2UgY2F1c2VkIGJ5IGlubGluZQoJLy8gZWxlbWVudHMsIHdoaWNoIHdvdWxkIGludGVyZmVyZSB3aXRoIHRoZSByZXNwb25zaXZlIHJlc2l6ZSBwcm9jZXNzLgoJLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzI1MzgKCXN0eWxlLmRpc3BsYXkgPSBzdHlsZS5kaXNwbGF5IHx8ICdibG9jayc7CgoJaWYgKHJlbmRlcldpZHRoID09PSBudWxsIHx8IHJlbmRlcldpZHRoID09PSAnJykgewoJCXZhciBkaXNwbGF5V2lkdGggPSByZWFkVXNlZFNpemUoY2FudmFzLCAnd2lkdGgnKTsKCQlpZiAoZGlzcGxheVdpZHRoICE9PSB1bmRlZmluZWQpIHsKCQkJY2FudmFzLndpZHRoID0gZGlzcGxheVdpZHRoOwoJCX0KCX0KCglpZiAocmVuZGVySGVpZ2h0ID09PSBudWxsIHx8IHJlbmRlckhlaWdodCA9PT0gJycpIHsKCQlpZiAoY2FudmFzLnN0eWxlLmhlaWdodCA9PT0gJycpIHsKCQkJLy8gSWYgbm8gZXhwbGljaXQgcmVuZGVyIGhlaWdodCBhbmQgc3R5bGUgaGVpZ2h0LCBsZXQncyBhcHBseSB0aGUgYXNwZWN0IHJhdGlvLAoJCQkvLyB3aGljaCBvbmUgY2FuIGJlIHNwZWNpZmllZCBieSB0aGUgdXNlciBidXQgYWxzbyBieSBjaGFydHMgYXMgZGVmYXVsdCBvcHRpb24KCQkJLy8gKGkuZS4gb3B0aW9ucy5hc3BlY3RSYXRpbykuIElmIG5vdCBzcGVjaWZpZWQsIHVzZSBjYW52YXMgYXNwZWN0IHJhdGlvIG9mIDIuCgkJCWNhbnZhcy5oZWlnaHQgPSBjYW52YXMud2lkdGggLyAoY29uZmlnLm9wdGlvbnMuYXNwZWN0UmF0aW8gfHwgMik7CgkJfSBlbHNlIHsKCQkJdmFyIGRpc3BsYXlIZWlnaHQgPSByZWFkVXNlZFNpemUoY2FudmFzLCAnaGVpZ2h0Jyk7CgkJCWlmIChkaXNwbGF5V2lkdGggIT09IHVuZGVmaW5lZCkgewoJCQkJY2FudmFzLmhlaWdodCA9IGRpc3BsYXlIZWlnaHQ7CgkJCX0KCQl9Cgl9CgoJcmV0dXJuIGNhbnZhczsKfQoKLyoqCiAqIERldGVjdHMgc3VwcG9ydCBmb3Igb3B0aW9ucyBvYmplY3QgYXJndW1lbnQgaW4gYWRkRXZlbnRMaXN0ZW5lci4KICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0V2ZW50VGFyZ2V0L2FkZEV2ZW50TGlzdGVuZXIjU2FmZWx5X2RldGVjdGluZ19vcHRpb25fc3VwcG9ydAogKiBAcHJpdmF0ZQogKi8KdmFyIHN1cHBvcnRzRXZlbnRMaXN0ZW5lck9wdGlvbnMgPSAoZnVuY3Rpb24oKSB7Cgl2YXIgc3VwcG9ydHMgPSBmYWxzZTsKCXRyeSB7CgkJdmFyIG9wdGlvbnMgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkoe30sICdwYXNzaXZlJywgewoJCQlnZXQ6IGZ1bmN0aW9uKCkgewoJCQkJc3VwcG9ydHMgPSB0cnVlOwoJCQl9CgkJfSk7CgkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2UnLCBudWxsLCBvcHRpb25zKTsKCX0gY2F0Y2ggKGUpIHsKCQkvLyBjb250aW51ZSByZWdhcmRsZXNzIG9mIGVycm9yCgl9CglyZXR1cm4gc3VwcG9ydHM7Cn0oKSk7CgovLyBEZWZhdWx0IHBhc3NpdmUgdG8gdHJ1ZSBhcyBleHBlY3RlZCBieSBDaHJvbWUgZm9yICd0b3VjaHN0YXJ0JyBhbmQgJ3RvdWNoZW5kJyBldmVudHMuCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy80Mjg3CnZhciBldmVudExpc3RlbmVyT3B0aW9ucyA9IHN1cHBvcnRzRXZlbnRMaXN0ZW5lck9wdGlvbnMgPyB7cGFzc2l2ZTogdHJ1ZX0gOiBmYWxzZTsKCmZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXIobm9kZSwgdHlwZSwgbGlzdGVuZXIpIHsKCW5vZGUuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lciwgZXZlbnRMaXN0ZW5lck9wdGlvbnMpOwp9CgpmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKG5vZGUsIHR5cGUsIGxpc3RlbmVyKSB7Cglub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIsIGV2ZW50TGlzdGVuZXJPcHRpb25zKTsKfQoKZnVuY3Rpb24gY3JlYXRlRXZlbnQodHlwZSwgY2hhcnQsIHgsIHksIG5hdGl2ZUV2ZW50KSB7CglyZXR1cm4gewoJCXR5cGU6IHR5cGUsCgkJY2hhcnQ6IGNoYXJ0LAoJCW5hdGl2ZTogbmF0aXZlRXZlbnQgfHwgbnVsbCwKCQl4OiB4ICE9PSB1bmRlZmluZWQgPyB4IDogbnVsbCwKCQl5OiB5ICE9PSB1bmRlZmluZWQgPyB5IDogbnVsbCwKCX07Cn0KCmZ1bmN0aW9uIGZyb21OYXRpdmVFdmVudChldmVudCwgY2hhcnQpIHsKCXZhciB0eXBlID0gRVZFTlRfVFlQRVNbZXZlbnQudHlwZV0gfHwgZXZlbnQudHlwZTsKCXZhciBwb3MgPSBoZWxwZXJzLmdldFJlbGF0aXZlUG9zaXRpb24oZXZlbnQsIGNoYXJ0KTsKCXJldHVybiBjcmVhdGVFdmVudCh0eXBlLCBjaGFydCwgcG9zLngsIHBvcy55LCBldmVudCk7Cn0KCmZ1bmN0aW9uIHRocm90dGxlZChmbiwgdGhpc0FyZykgewoJdmFyIHRpY2tpbmcgPSBmYWxzZTsKCXZhciBhcmdzID0gW107CgoJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCWFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoJCXRoaXNBcmcgPSB0aGlzQXJnIHx8IHRoaXM7CgoJCWlmICghdGlja2luZykgewoJCQl0aWNraW5nID0gdHJ1ZTsKCQkJaGVscGVycy5yZXF1ZXN0QW5pbUZyYW1lLmNhbGwod2luZG93LCBmdW5jdGlvbigpIHsKCQkJCXRpY2tpbmcgPSBmYWxzZTsKCQkJCWZuLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwoJCQl9KTsKCQl9Cgl9Owp9CgovLyBJbXBsZW1lbnRhdGlvbiBiYXNlZCBvbiBodHRwczovL2dpdGh1Yi5jb20vbWFyY2ovY3NzLWVsZW1lbnQtcXVlcmllcwpmdW5jdGlvbiBjcmVhdGVSZXNpemVyKGhhbmRsZXIpIHsKCXZhciByZXNpemVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7Cgl2YXIgY2xzID0gQ1NTX1BSRUZJWCArICdzaXplLW1vbml0b3InOwoJdmFyIG1heFNpemUgPSAxMDAwMDAwOwoJdmFyIHN0eWxlID0KCQkncG9zaXRpb246YWJzb2x1dGU7JyArCgkJJ2xlZnQ6MDsnICsKCQkndG9wOjA7JyArCgkJJ3JpZ2h0OjA7JyArCgkJJ2JvdHRvbTowOycgKwoJCSdvdmVyZmxvdzpoaWRkZW47JyArCgkJJ3BvaW50ZXItZXZlbnRzOm5vbmU7JyArCgkJJ3Zpc2liaWxpdHk6aGlkZGVuOycgKwoJCSd6LWluZGV4Oi0xOyc7CgoJcmVzaXplci5zdHlsZS5jc3NUZXh0ID0gc3R5bGU7CglyZXNpemVyLmNsYXNzTmFtZSA9IGNsczsKCXJlc2l6ZXIuaW5uZXJIVE1MID0KCQknPGRpdiBjbGFzcz0iJyArIGNscyArICctZXhwYW5kIiBzdHlsZT0iJyArIHN0eWxlICsgJyI+JyArCgkJCSc8ZGl2IHN0eWxlPSInICsKCQkJCSdwb3NpdGlvbjphYnNvbHV0ZTsnICsKCQkJCSd3aWR0aDonICsgbWF4U2l6ZSArICdweDsnICsKCQkJCSdoZWlnaHQ6JyArIG1heFNpemUgKyAncHg7JyArCgkJCQknbGVmdDowOycgKwoJCQkJJ3RvcDowIj4nICsKCQkJJzwvZGl2PicgKwoJCSc8L2Rpdj4nICsKCQknPGRpdiBjbGFzcz0iJyArIGNscyArICctc2hyaW5rIiBzdHlsZT0iJyArIHN0eWxlICsgJyI+JyArCgkJCSc8ZGl2IHN0eWxlPSInICsKCQkJCSdwb3NpdGlvbjphYnNvbHV0ZTsnICsKCQkJCSd3aWR0aDoyMDAlOycgKwoJCQkJJ2hlaWdodDoyMDAlOycgKwoJCQkJJ2xlZnQ6MDsgJyArCgkJCQkndG9wOjAiPicgKwoJCQknPC9kaXY+JyArCgkJJzwvZGl2Pic7CgoJdmFyIGV4cGFuZCA9IHJlc2l6ZXIuY2hpbGROb2Rlc1swXTsKCXZhciBzaHJpbmsgPSByZXNpemVyLmNoaWxkTm9kZXNbMV07CgoJcmVzaXplci5fcmVzZXQgPSBmdW5jdGlvbigpIHsKCQlleHBhbmQuc2Nyb2xsTGVmdCA9IG1heFNpemU7CgkJZXhwYW5kLnNjcm9sbFRvcCA9IG1heFNpemU7CgkJc2hyaW5rLnNjcm9sbExlZnQgPSBtYXhTaXplOwoJCXNocmluay5zY3JvbGxUb3AgPSBtYXhTaXplOwoJfTsKCXZhciBvblNjcm9sbCA9IGZ1bmN0aW9uKCkgewoJCXJlc2l6ZXIuX3Jlc2V0KCk7CgkJaGFuZGxlcigpOwoJfTsKCglhZGRFdmVudExpc3RlbmVyKGV4cGFuZCwgJ3Njcm9sbCcsIG9uU2Nyb2xsLmJpbmQoZXhwYW5kLCAnZXhwYW5kJykpOwoJYWRkRXZlbnRMaXN0ZW5lcihzaHJpbmssICdzY3JvbGwnLCBvblNjcm9sbC5iaW5kKHNocmluaywgJ3NocmluaycpKTsKCglyZXR1cm4gcmVzaXplcjsKfQoKLy8gaHR0cHM6Ly9kYXZpZHdhbHNoLm5hbWUvZGV0ZWN0LW5vZGUtaW5zZXJ0aW9uCmZ1bmN0aW9uIHdhdGNoRm9yUmVuZGVyKG5vZGUsIGhhbmRsZXIpIHsKCXZhciBleHBhbmRvID0gbm9kZVtFWFBBTkRPX0tFWV0gfHwgKG5vZGVbRVhQQU5ET19LRVldID0ge30pOwoJdmFyIHByb3h5ID0gZXhwYW5kby5yZW5kZXJQcm94eSA9IGZ1bmN0aW9uKGUpIHsKCQlpZiAoZS5hbmltYXRpb25OYW1lID09PSBDU1NfUkVOREVSX0FOSU1BVElPTikgewoJCQloYW5kbGVyKCk7CgkJfQoJfTsKCgloZWxwZXJzLmVhY2goQU5JTUFUSU9OX1NUQVJUX0VWRU5UUywgZnVuY3Rpb24odHlwZSkgewoJCWFkZEV2ZW50TGlzdGVuZXIobm9kZSwgdHlwZSwgcHJveHkpOwoJfSk7CgoJLy8gIzQ3Mzc6IENocm9tZSBtaWdodCBza2lwIHRoZSBDU1MgYW5pbWF0aW9uIHdoZW4gdGhlIENTU19SRU5ERVJfTU9OSVRPUiBjbGFzcwoJLy8gaXMgcmVtb3ZlZCB0aGVuIGFkZGVkIGJhY2sgaW1tZWRpYXRlbHkgKHNhbWUgYW5pbWF0aW9uIGZyYW1lPykuIEFjY2Vzc2luZyB0aGUKCS8vIGBvZmZzZXRQYXJlbnRgIHByb3BlcnR5IHdpbGwgZm9yY2UgYSByZWZsb3cgYW5kIHJlLWV2YWx1YXRlIHRoZSBDU1MgYW5pbWF0aW9uLgoJLy8gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vcGF1bGlyaXNoLzVkNTJmYjA4MWIzNTcwYzgxZTNhI2JveC1tZXRyaWNzCgkvLyBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvNDczNwoJZXhwYW5kby5yZWZsb3cgPSAhIW5vZGUub2Zmc2V0UGFyZW50OwoKCW5vZGUuY2xhc3NMaXN0LmFkZChDU1NfUkVOREVSX01PTklUT1IpOwp9CgpmdW5jdGlvbiB1bndhdGNoRm9yUmVuZGVyKG5vZGUpIHsKCXZhciBleHBhbmRvID0gbm9kZVtFWFBBTkRPX0tFWV0gfHwge307Cgl2YXIgcHJveHkgPSBleHBhbmRvLnJlbmRlclByb3h5OwoKCWlmIChwcm94eSkgewoJCWhlbHBlcnMuZWFjaChBTklNQVRJT05fU1RBUlRfRVZFTlRTLCBmdW5jdGlvbih0eXBlKSB7CgkJCXJlbW92ZUV2ZW50TGlzdGVuZXIobm9kZSwgdHlwZSwgcHJveHkpOwoJCX0pOwoKCQlkZWxldGUgZXhwYW5kby5yZW5kZXJQcm94eTsKCX0KCglub2RlLmNsYXNzTGlzdC5yZW1vdmUoQ1NTX1JFTkRFUl9NT05JVE9SKTsKfQoKZnVuY3Rpb24gYWRkUmVzaXplTGlzdGVuZXIobm9kZSwgbGlzdGVuZXIsIGNoYXJ0KSB7Cgl2YXIgZXhwYW5kbyA9IG5vZGVbRVhQQU5ET19LRVldIHx8IChub2RlW0VYUEFORE9fS0VZXSA9IHt9KTsKCgkvLyBMZXQncyBrZWVwIHRyYWNrIG9mIHRoaXMgYWRkZWQgcmVzaXplciBhbmQgdGh1cyBhdm9pZCBET00gcXVlcnkgd2hlbiByZW1vdmluZyBpdC4KCXZhciByZXNpemVyID0gZXhwYW5kby5yZXNpemVyID0gY3JlYXRlUmVzaXplcih0aHJvdHRsZWQoZnVuY3Rpb24oKSB7CgkJaWYgKGV4cGFuZG8ucmVzaXplcikgewoJCQlyZXR1cm4gbGlzdGVuZXIoY3JlYXRlRXZlbnQoJ3Jlc2l6ZScsIGNoYXJ0KSk7CgkJfQoJfSkpOwoKCS8vIFRoZSByZXNpemVyIG5lZWRzIHRvIGJlIGF0dGFjaGVkIHRvIHRoZSBub2RlIHBhcmVudCwgc28gd2UgZmlyc3QgbmVlZCB0byBiZQoJLy8gc3VyZSB0aGF0IGBub2RlYCBpcyBhdHRhY2hlZCB0byB0aGUgRE9NIGJlZm9yZSBpbmplY3RpbmcgdGhlIHJlc2l6ZXIgZWxlbWVudC4KCXdhdGNoRm9yUmVuZGVyKG5vZGUsIGZ1bmN0aW9uKCkgewoJCWlmIChleHBhbmRvLnJlc2l6ZXIpIHsKCQkJdmFyIGNvbnRhaW5lciA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKGNvbnRhaW5lciAmJiBjb250YWluZXIgIT09IHJlc2l6ZXIucGFyZW50Tm9kZSkgewoJCQkJY29udGFpbmVyLmluc2VydEJlZm9yZShyZXNpemVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CgkJCX0KCgkJCS8vIFRoZSBjb250YWluZXIgc2l6ZSBtaWdodCBoYXZlIGNoYW5nZWQsIGxldCdzIHJlc2V0IHRoZSByZXNpemVyIHN0YXRlLgoJCQlyZXNpemVyLl9yZXNldCgpOwoJCX0KCX0pOwp9CgpmdW5jdGlvbiByZW1vdmVSZXNpemVMaXN0ZW5lcihub2RlKSB7Cgl2YXIgZXhwYW5kbyA9IG5vZGVbRVhQQU5ET19LRVldIHx8IHt9OwoJdmFyIHJlc2l6ZXIgPSBleHBhbmRvLnJlc2l6ZXI7CgoJZGVsZXRlIGV4cGFuZG8ucmVzaXplcjsKCXVud2F0Y2hGb3JSZW5kZXIobm9kZSk7CgoJaWYgKHJlc2l6ZXIgJiYgcmVzaXplci5wYXJlbnROb2RlKSB7CgkJcmVzaXplci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHJlc2l6ZXIpOwoJfQp9CgpmdW5jdGlvbiBpbmplY3RDU1MocGxhdGZvcm0sIGNzcykgewoJLy8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3EvMzkyMjEzOQoJdmFyIHN0eWxlID0gcGxhdGZvcm0uX3N0eWxlIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CglpZiAoIXBsYXRmb3JtLl9zdHlsZSkgewoJCXBsYXRmb3JtLl9zdHlsZSA9IHN0eWxlOwoJCWNzcyA9ICcvKiBDaGFydC5qcyAqL1xuJyArIGNzczsKCQlzdHlsZS5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9jc3MnKTsKCQlkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdLmFwcGVuZENoaWxkKHN0eWxlKTsKCX0KCglzdHlsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3MpKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CgkvKioKCSAqIFRoaXMgcHJvcGVydHkgaG9sZHMgd2hldGhlciB0aGlzIHBsYXRmb3JtIGlzIGVuYWJsZWQgZm9yIHRoZSBjdXJyZW50IGVudmlyb25tZW50LgoJICogQ3VycmVudGx5IHVzZWQgYnkgcGxhdGZvcm0uanMgdG8gc2VsZWN0IHRoZSBwcm9wZXIgaW1wbGVtZW50YXRpb24uCgkgKiBAcHJpdmF0ZQoJICovCglfZW5hYmxlZDogdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJywKCglpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQl2YXIga2V5ZnJhbWVzID0gJ2Zyb217b3BhY2l0eTowLjk5fXRve29wYWNpdHk6MX0nOwoKCQlpbmplY3RDU1ModGhpcywKCQkJLy8gRE9NIHJlbmRlcmluZyBkZXRlY3Rpb24KCQkJLy8gaHR0cHM6Ly9kYXZpZHdhbHNoLm5hbWUvZGV0ZWN0LW5vZGUtaW5zZXJ0aW9uCgkJCSdALXdlYmtpdC1rZXlmcmFtZXMgJyArIENTU19SRU5ERVJfQU5JTUFUSU9OICsgJ3snICsga2V5ZnJhbWVzICsgJ30nICsKCQkJJ0BrZXlmcmFtZXMgJyArIENTU19SRU5ERVJfQU5JTUFUSU9OICsgJ3snICsga2V5ZnJhbWVzICsgJ30nICsKCQkJJy4nICsgQ1NTX1JFTkRFUl9NT05JVE9SICsgJ3snICsKCQkJCSctd2Via2l0LWFuaW1hdGlvbjonICsgQ1NTX1JFTkRFUl9BTklNQVRJT04gKyAnIDAuMDAxczsnICsKCQkJCSdhbmltYXRpb246JyArIENTU19SRU5ERVJfQU5JTUFUSU9OICsgJyAwLjAwMXM7JyArCgkJCSd9JwoJCSk7Cgl9LAoKCWFjcXVpcmVDb250ZXh0OiBmdW5jdGlvbihpdGVtLCBjb25maWcpIHsKCQlpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7CgkJCWl0ZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpdGVtKTsKCQl9IGVsc2UgaWYgKGl0ZW0ubGVuZ3RoKSB7CgkJCS8vIFN1cHBvcnQgZm9yIGFycmF5IGJhc2VkIHF1ZXJpZXMgKHN1Y2ggYXMgalF1ZXJ5KQoJCQlpdGVtID0gaXRlbVswXTsKCQl9CgoJCWlmIChpdGVtICYmIGl0ZW0uY2FudmFzKSB7CgkJCS8vIFN1cHBvcnQgZm9yIGFueSBvYmplY3QgYXNzb2NpYXRlZCB0byBhIGNhbnZhcyAoaW5jbHVkaW5nIGEgY29udGV4dDJkKQoJCQlpdGVtID0gaXRlbS5jYW52YXM7CgkJfQoKCQkvLyBUbyBwcmV2ZW50IGNhbnZhcyBmaW5nZXJwcmludGluZywgc29tZSBhZGQtb25zIHVuZGVmaW5lIHRoZSBnZXRDb250ZXh0CgkJLy8gbWV0aG9kLCBmb3IgZXhhbXBsZTogaHR0cHM6Ly9naXRodWIuY29tL2trYXBzbmVyL0NhbnZhc0Jsb2NrZXIKCQkvLyBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvMjgwNwoJCXZhciBjb250ZXh0ID0gaXRlbSAmJiBpdGVtLmdldENvbnRleHQgJiYgaXRlbS5nZXRDb250ZXh0KCcyZCcpOwoKCQkvLyBgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudC9DYW52YXNSZW5kZXJpbmdDb250ZXh0MkRgIGZhaWxzIHdoZW4gdGhlIGl0ZW0gaXMKCQkvLyBpbnNpZGUgYW4gaWZyYW1lIG9yIHdoZW4gcnVubmluZyBpbiBhIHByb3RlY3RlZCBlbnZpcm9ubWVudC4gV2UgY291bGQgZ3Vlc3MgdGhlCgkJLy8gdHlwZXMgZnJvbSB0aGVpciB0b1N0cmluZygpIHZhbHVlIGJ1dCBsZXQncyBrZWVwIHRoaW5ncyBmbGV4aWJsZSBhbmQgYXNzdW1lIGl0J3MKCQkvLyBhIHN1ZmZpY2llbnQgY29uZGl0aW9uIGlmIHRoZSBpdGVtIGhhcyBhIGNvbnRleHQyRCB3aGljaCBoYXMgaXRlbSBhcyBgY2FudmFzYC4KCQkvLyBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvMzg4NwoJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy80MTAyCgkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzQxNTIKCQlpZiAoY29udGV4dCAmJiBjb250ZXh0LmNhbnZhcyA9PT0gaXRlbSkgewoJCQlpbml0Q2FudmFzKGl0ZW0sIGNvbmZpZyk7CgkJCXJldHVybiBjb250ZXh0OwoJCX0KCgkJcmV0dXJuIG51bGw7Cgl9LAoKCXJlbGVhc2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CgkJdmFyIGNhbnZhcyA9IGNvbnRleHQuY2FudmFzOwoJCWlmICghY2FudmFzW0VYUEFORE9fS0VZXSkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgaW5pdGlhbCA9IGNhbnZhc1tFWFBBTkRPX0tFWV0uaW5pdGlhbDsKCQlbJ2hlaWdodCcsICd3aWR0aCddLmZvckVhY2goZnVuY3Rpb24ocHJvcCkgewoJCQl2YXIgdmFsdWUgPSBpbml0aWFsW3Byb3BdOwoJCQlpZiAoaGVscGVycy5pc051bGxPclVuZGVmKHZhbHVlKSkgewoJCQkJY2FudmFzLnJlbW92ZUF0dHJpYnV0ZShwcm9wKTsKCQkJfSBlbHNlIHsKCQkJCWNhbnZhcy5zZXRBdHRyaWJ1dGUocHJvcCwgdmFsdWUpOwoJCQl9CgkJfSk7CgoJCWhlbHBlcnMuZWFjaChpbml0aWFsLnN0eWxlIHx8IHt9LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CgkJCWNhbnZhcy5zdHlsZVtrZXldID0gdmFsdWU7CgkJfSk7CgoJCS8vIFRoZSBjYW52YXMgcmVuZGVyIHNpemUgbWlnaHQgaGF2ZSBiZWVuIGNoYW5nZWQgKGFuZCB0aHVzIHRoZSBzdGF0ZSBzdGFjayBkaXNjYXJkZWQpLAoJCS8vIHdlIGNhbid0IHVzZSBzYXZlKCkgYW5kIHJlc3RvcmUoKSB0byByZXN0b3JlIHRoZSBpbml0aWFsIHN0YXRlLiBTbyBtYWtlIHN1cmUgdGhhdCBhdAoJCS8vIGxlYXN0IHRoZSBjYW52YXMgY29udGV4dCBpcyByZXNldCB0byB0aGUgZGVmYXVsdCBzdGF0ZSBieSBzZXR0aW5nIHRoZSBjYW52YXMgd2lkdGguCgkJLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSLzIwMTEvV0QtaHRtbDUtMjAxMTA1MjUvdGhlLWNhbnZhcy1lbGVtZW50Lmh0bWwKCQljYW52YXMud2lkdGggPSBjYW52YXMud2lkdGg7CgoJCWRlbGV0ZSBjYW52YXNbRVhQQU5ET19LRVldOwoJfSwKCglhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbihjaGFydCwgdHlwZSwgbGlzdGVuZXIpIHsKCQl2YXIgY2FudmFzID0gY2hhcnQuY2FudmFzOwoJCWlmICh0eXBlID09PSAncmVzaXplJykgewoJCQkvLyBOb3RlOiB0aGUgcmVzaXplIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgb24gYWxsIGJyb3dzZXJzLgoJCQlhZGRSZXNpemVMaXN0ZW5lcihjYW52YXMsIGxpc3RlbmVyLCBjaGFydCk7CgkJCXJldHVybjsKCQl9CgoJCXZhciBleHBhbmRvID0gbGlzdGVuZXJbRVhQQU5ET19LRVldIHx8IChsaXN0ZW5lcltFWFBBTkRPX0tFWV0gPSB7fSk7CgkJdmFyIHByb3hpZXMgPSBleHBhbmRvLnByb3hpZXMgfHwgKGV4cGFuZG8ucHJveGllcyA9IHt9KTsKCQl2YXIgcHJveHkgPSBwcm94aWVzW2NoYXJ0LmlkICsgJ18nICsgdHlwZV0gPSBmdW5jdGlvbihldmVudCkgewoJCQlsaXN0ZW5lcihmcm9tTmF0aXZlRXZlbnQoZXZlbnQsIGNoYXJ0KSk7CgkJfTsKCgkJYWRkRXZlbnRMaXN0ZW5lcihjYW52YXMsIHR5cGUsIHByb3h5KTsKCX0sCgoJcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24oY2hhcnQsIHR5cGUsIGxpc3RlbmVyKSB7CgkJdmFyIGNhbnZhcyA9IGNoYXJ0LmNhbnZhczsKCQlpZiAodHlwZSA9PT0gJ3Jlc2l6ZScpIHsKCQkJLy8gTm90ZTogdGhlIHJlc2l6ZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG9uIGFsbCBicm93c2Vycy4KCQkJcmVtb3ZlUmVzaXplTGlzdGVuZXIoY2FudmFzLCBsaXN0ZW5lcik7CgkJCXJldHVybjsKCQl9CgoJCXZhciBleHBhbmRvID0gbGlzdGVuZXJbRVhQQU5ET19LRVldIHx8IHt9OwoJCXZhciBwcm94aWVzID0gZXhwYW5kby5wcm94aWVzIHx8IHt9OwoJCXZhciBwcm94eSA9IHByb3hpZXNbY2hhcnQuaWQgKyAnXycgKyB0eXBlXTsKCQlpZiAoIXByb3h5KSB7CgkJCXJldHVybjsKCQl9CgoJCXJlbW92ZUV2ZW50TGlzdGVuZXIoY2FudmFzLCB0eXBlLCBwcm94eSk7Cgl9Cn07CgovLyBERVBSRUNBVElPTlMKCi8qKgogKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIEV2ZW50VGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIgaW5zdGVhZC4KICogRXZlbnRUYXJnZXQuYWRkRXZlbnRMaXN0ZW5lciBjb21wYXRpYmlsaXR5OiBDaHJvbWUsIE9wZXJhIDcsIFNhZmFyaSwgRkYxLjUrLCBJRTkrCiAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0V2ZW50VGFyZ2V0L2FkZEV2ZW50TGlzdGVuZXIKICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuYWRkRXZlbnQKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjcuMAogKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCiAqIEBwcml2YXRlCiAqLwpoZWxwZXJzLmFkZEV2ZW50ID0gYWRkRXZlbnRMaXN0ZW5lcjsKCi8qKgogKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIEV2ZW50VGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIgaW5zdGVhZC4KICogRXZlbnRUYXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lciBjb21wYXRpYmlsaXR5OiBDaHJvbWUsIE9wZXJhIDcsIFNhZmFyaSwgRkYxLjUrLCBJRTkrCiAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0V2ZW50VGFyZ2V0L3JlbW92ZUV2ZW50TGlzdGVuZXIKICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMucmVtb3ZlRXZlbnQKICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjcuMAogKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzCiAqIEBwcml2YXRlCiAqLwpoZWxwZXJzLnJlbW92ZUV2ZW50ID0gcmVtb3ZlRXZlbnRMaXN0ZW5lcjsKCn0seyI0NSI6NDV9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7CnZhciBiYXNpYyA9IHJlcXVpcmUoNDYpOwp2YXIgZG9tID0gcmVxdWlyZSg0Nyk7CgovLyBAVE9ETyBNYWtlIHBvc3NpYmxlIHRvIHNlbGVjdCBhbm90aGVyIHBsYXRmb3JtIGF0IGJ1aWxkIHRpbWUuCnZhciBpbXBsZW1lbnRhdGlvbiA9IGRvbS5fZW5hYmxlZCA/IGRvbSA6IGJhc2ljOwoKLyoqCiAqIEBuYW1lc3BhY2UgQ2hhcnQucGxhdGZvcm0KICogQHNlZSBodHRwczovL2NoYXJ0anMuZ2l0Ym9va3MuaW8vcHJvcG9zYWxzL2NvbnRlbnQvUGxhdGZvcm0uaHRtbAogKiBAc2luY2UgMi40LjAKICovCm1vZHVsZS5leHBvcnRzID0gaGVscGVycy5leHRlbmQoewoJLyoqCgkgKiBAc2luY2UgMi43LjAKCSAqLwoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSwKCgkvKioKCSAqIENhbGxlZCBhdCBjaGFydCBjb25zdHJ1Y3Rpb24gdGltZSwgcmV0dXJucyBhIGNvbnRleHQyZCBpbnN0YW5jZSBpbXBsZW1lbnRpbmcKCSAqIHRoZSBbVzNDIENhbnZhcyAyRCBDb250ZXh0IEFQSSBzdGFuZGFyZF17QGxpbmsgaHR0cHM6Ly93d3cudzMub3JnL1RSLzJkY29udGV4dC99LgoJICogQHBhcmFtIHsqfSBpdGVtIC0gVGhlIG5hdGl2ZSBpdGVtIGZyb20gd2hpY2ggdG8gYWNxdWlyZSBjb250ZXh0IChwbGF0Zm9ybSBzcGVjaWZpYykKCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIGNoYXJ0IG9wdGlvbnMKCSAqIEByZXR1cm5zIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQyZCBpbnN0YW5jZQoJICovCglhY3F1aXJlQ29udGV4dDogZnVuY3Rpb24oKSB7fSwKCgkvKioKCSAqIENhbGxlZCBhdCBjaGFydCBkZXN0cnVjdGlvbiB0aW1lLCByZWxlYXNlcyBhbnkgcmVzb3VyY2VzIGFzc29jaWF0ZWQgdG8gdGhlIGNvbnRleHQKCSAqIHByZXZpb3VzbHkgcmV0dXJuZWQgYnkgdGhlIGFjcXVpcmVDb250ZXh0KCkgbWV0aG9kLgoJICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgY29udGV4dDJkIGluc3RhbmNlCgkgKiBAcmV0dXJucyB7Qm9vbGVhbn0gdHJ1ZSBpZiB0aGUgbWV0aG9kIHN1Y2NlZWRlZCwgZWxzZSBmYWxzZQoJICovCglyZWxlYXNlQ29udGV4dDogZnVuY3Rpb24oKSB7fSwKCgkvKioKCSAqIFJlZ2lzdGVycyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyIG9uIHRoZSBnaXZlbiBjaGFydC4KCSAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gQ2hhcnQgZnJvbSB3aGljaCB0byBsaXN0ZW4gZm9yIGV2ZW50CgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSAtIFRoZSAoe0BsaW5rIElFdmVudH0pIHR5cGUgdG8gbGlzdGVuIGZvcgoJICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgLSBSZWNlaXZlcyBhIG5vdGlmaWNhdGlvbiAoYW4gb2JqZWN0IHRoYXQgaW1wbGVtZW50cwoJICogdGhlIHtAbGluayBJRXZlbnR9IGludGVyZmFjZSkgd2hlbiBhbiBldmVudCBvZiB0aGUgc3BlY2lmaWVkIHR5cGUgb2NjdXJzLgoJICovCglhZGRFdmVudExpc3RlbmVyOiBmdW5jdGlvbigpIHt9LAoKCS8qKgoJICogUmVtb3ZlcyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCB3aXRoIGFkZEV2ZW50TGlzdGVuZXIuCgkgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtQ2hhcnQgZnJvbSB3aGljaCB0byByZW1vdmUgdGhlIGxpc3RlbmVyCgkgKiBAcGFyYW0ge1N0cmluZ30gdHlwZSAtIFRoZSAoe0BsaW5rIElFdmVudH0pIHR5cGUgdG8gcmVtb3ZlCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFRoZSBsaXN0ZW5lciBmdW5jdGlvbiB0byByZW1vdmUgZnJvbSB0aGUgZXZlbnQgdGFyZ2V0LgoJICovCglyZW1vdmVFdmVudExpc3RlbmVyOiBmdW5jdGlvbigpIHt9Cgp9LCBpbXBsZW1lbnRhdGlvbik7CgovKioKICogQGludGVyZmFjZSBJUGxhdGZvcm0KICogQWxsb3dzIGFic3RyYWN0aW5nIHBsYXRmb3JtIGRlcGVuZGVuY2llcyBhd2F5IGZyb20gdGhlIGNoYXJ0CiAqIEBib3Jyb3dzIENoYXJ0LnBsYXRmb3JtLmFjcXVpcmVDb250ZXh0IGFzIGFjcXVpcmVDb250ZXh0CiAqIEBib3Jyb3dzIENoYXJ0LnBsYXRmb3JtLnJlbGVhc2VDb250ZXh0IGFzIHJlbGVhc2VDb250ZXh0CiAqIEBib3Jyb3dzIENoYXJ0LnBsYXRmb3JtLmFkZEV2ZW50TGlzdGVuZXIgYXMgYWRkRXZlbnRMaXN0ZW5lcgogKiBAYm9ycm93cyBDaGFydC5wbGF0Zm9ybS5yZW1vdmVFdmVudExpc3RlbmVyIGFzIHJlbW92ZUV2ZW50TGlzdGVuZXIKICovCgovKioKICogQGludGVyZmFjZSBJRXZlbnQKICogQHByb3Age1N0cmluZ30gdHlwZSAtIFRoZSBldmVudCB0eXBlIG5hbWUsIHBvc3NpYmxlIHZhbHVlcyBhcmU6CiAqICdjb250ZXh0bWVudScsICdtb3VzZWVudGVyJywgJ21vdXNlZG93bicsICdtb3VzZW1vdmUnLCAnbW91c2V1cCcsICdtb3VzZW91dCcsCiAqICdjbGljaycsICdkYmxjbGljaycsICdrZXlkb3duJywgJ2tleXByZXNzJywgJ2tleXVwJyBhbmQgJ3Jlc2l6ZScKICogQHByb3Ageyp9IG5hdGl2ZSAtIFRoZSBvcmlnaW5hbCBuYXRpdmUgZXZlbnQgKG51bGwgZm9yIGVtdWxhdGVkIGV2ZW50cywgZS5nLiAncmVzaXplJykKICogQHByb3Age051bWJlcn0geCAtIFRoZSBtb3VzZSB4IHBvc2l0aW9uLCByZWxhdGl2ZSB0byB0aGUgY2FudmFzIChudWxsIGZvciBpbmNvbXBhdGlibGUgZXZlbnRzKQogKiBAcHJvcCB7TnVtYmVyfSB5IC0gVGhlIG1vdXNlIHkgcG9zaXRpb24sIHJlbGF0aXZlIHRvIHRoZSBjYW52YXMgKG51bGwgZm9yIGluY29tcGF0aWJsZSBldmVudHMpCiAqLwoKfSx7IjQ1Ijo0NSwiNDYiOjQ2LCI0NyI6NDd9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0ge307Cm1vZHVsZS5leHBvcnRzLmZpbGxlciA9IHJlcXVpcmUoNTApOwptb2R1bGUuZXhwb3J0cy5sZWdlbmQgPSByZXF1aXJlKDUxKTsKbW9kdWxlLmV4cG9ydHMudGl0bGUgPSByZXF1aXJlKDUyKTsKCn0seyI1MCI6NTAsIjUxIjo1MSwiNTIiOjUyfV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogUGx1Z2luIGJhc2VkIG9uIGRpc2N1c3Npb24gZnJvbSB0aGUgZm9sbG93aW5nIENoYXJ0LmpzIGlzc3VlczoKICogQHNlZSBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvMjM4MCNpc3N1ZWNvbW1lbnQtMjc5OTYxNTY5CiAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzI0NDAjaXNzdWVjb21tZW50LTI1NjQ2MTg5NwogKi8KCid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgZWxlbWVudHMgPSByZXF1aXJlKDQwKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCmRlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKCXBsdWdpbnM6IHsKCQlmaWxsZXI6IHsKCQkJcHJvcGFnYXRlOiB0cnVlCgkJfQoJfQp9KTsKCnZhciBtYXBwZXJzID0gewoJZGF0YXNldDogZnVuY3Rpb24oc291cmNlKSB7CgkJdmFyIGluZGV4ID0gc291cmNlLmZpbGw7CgkJdmFyIGNoYXJ0ID0gc291cmNlLmNoYXJ0OwoJCXZhciBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaW5kZXgpOwoJCXZhciB2aXNpYmxlID0gbWV0YSAmJiBjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGluZGV4KTsKCQl2YXIgcG9pbnRzID0gKHZpc2libGUgJiYgbWV0YS5kYXRhc2V0Ll9jaGlsZHJlbikgfHwgW107CgkJdmFyIGxlbmd0aCA9IHBvaW50cy5sZW5ndGggfHwgMDsKCgkJcmV0dXJuICFsZW5ndGggPyBudWxsIDogZnVuY3Rpb24ocG9pbnQsIGkpIHsKCQkJcmV0dXJuIChpIDwgbGVuZ3RoICYmIHBvaW50c1tpXS5fdmlldykgfHwgbnVsbDsKCQl9OwoJfSwKCglib3VuZGFyeTogZnVuY3Rpb24oc291cmNlKSB7CgkJdmFyIGJvdW5kYXJ5ID0gc291cmNlLmJvdW5kYXJ5OwoJCXZhciB4ID0gYm91bmRhcnkgPyBib3VuZGFyeS54IDogbnVsbDsKCQl2YXIgeSA9IGJvdW5kYXJ5ID8gYm91bmRhcnkueSA6IG51bGw7CgoJCXJldHVybiBmdW5jdGlvbihwb2ludCkgewoJCQlyZXR1cm4gewoJCQkJeDogeCA9PT0gbnVsbCA/IHBvaW50LnggOiB4LAoJCQkJeTogeSA9PT0gbnVsbCA/IHBvaW50LnkgOiB5LAoJCQl9OwoJCX07Cgl9Cn07CgovLyBAdG9kbyBpZiAoZmlsbFswXSA9PT0gJyMnKQpmdW5jdGlvbiBkZWNvZGVGaWxsKGVsLCBpbmRleCwgY291bnQpIHsKCXZhciBtb2RlbCA9IGVsLl9tb2RlbCB8fCB7fTsKCXZhciBmaWxsID0gbW9kZWwuZmlsbDsKCXZhciB0YXJnZXQ7CgoJaWYgKGZpbGwgPT09IHVuZGVmaW5lZCkgewoJCWZpbGwgPSAhIW1vZGVsLmJhY2tncm91bmRDb2xvcjsKCX0KCglpZiAoZmlsbCA9PT0gZmFsc2UgfHwgZmlsbCA9PT0gbnVsbCkgewoJCXJldHVybiBmYWxzZTsKCX0KCglpZiAoZmlsbCA9PT0gdHJ1ZSkgewoJCXJldHVybiAnb3JpZ2luJzsKCX0KCgl0YXJnZXQgPSBwYXJzZUZsb2F0KGZpbGwsIDEwKTsKCWlmIChpc0Zpbml0ZSh0YXJnZXQpICYmIE1hdGguZmxvb3IodGFyZ2V0KSA9PT0gdGFyZ2V0KSB7CgkJaWYgKGZpbGxbMF0gPT09ICctJyB8fCBmaWxsWzBdID09PSAnKycpIHsKCQkJdGFyZ2V0ID0gaW5kZXggKyB0YXJnZXQ7CgkJfQoKCQlpZiAodGFyZ2V0ID09PSBpbmRleCB8fCB0YXJnZXQgPCAwIHx8IHRhcmdldCA+PSBjb3VudCkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlyZXR1cm4gdGFyZ2V0OwoJfQoKCXN3aXRjaCAoZmlsbCkgewoJLy8gY29tcGF0aWJpbGl0eQoJY2FzZSAnYm90dG9tJzoKCQlyZXR1cm4gJ3N0YXJ0JzsKCWNhc2UgJ3RvcCc6CgkJcmV0dXJuICdlbmQnOwoJY2FzZSAnemVybyc6CgkJcmV0dXJuICdvcmlnaW4nOwoJLy8gc3VwcG9ydGVkIGJvdW5kYXJpZXMKCWNhc2UgJ29yaWdpbic6CgljYXNlICdzdGFydCc6CgljYXNlICdlbmQnOgoJCXJldHVybiBmaWxsOwoJLy8gaW52YWxpZCBmaWxsIHZhbHVlcwoJZGVmYXVsdDoKCQlyZXR1cm4gZmFsc2U7Cgl9Cn0KCmZ1bmN0aW9uIGNvbXB1dGVCb3VuZGFyeShzb3VyY2UpIHsKCXZhciBtb2RlbCA9IHNvdXJjZS5lbC5fbW9kZWwgfHwge307Cgl2YXIgc2NhbGUgPSBzb3VyY2UuZWwuX3NjYWxlIHx8IHt9OwoJdmFyIGZpbGwgPSBzb3VyY2UuZmlsbDsKCXZhciB0YXJnZXQgPSBudWxsOwoJdmFyIGhvcml6b250YWw7CgoJaWYgKGlzRmluaXRlKGZpbGwpKSB7CgkJcmV0dXJuIG51bGw7Cgl9CgoJLy8gQmFja3dhcmQgY29tcGF0aWJpbGl0eTogdW50aWwgdjMsIHdlIHN0aWxsIG5lZWQgdG8gc3VwcG9ydCBib3VuZGFyeSB2YWx1ZXMgc2V0IG9uCgkvLyB0aGUgbW9kZWwgKHNjYWxlVG9wLCBzY2FsZUJvdHRvbSBhbmQgc2NhbGVaZXJvKSBiZWNhdXNlIHNvbWUgZXh0ZXJuYWwgcGx1Z2lucyBhbmQKCS8vIGNvbnRyb2xsZXJzIG1pZ2h0IHN0aWxsIHVzZSBpdCAoZS5nLiB0aGUgU21pdGggY2hhcnQpLgoKCWlmIChmaWxsID09PSAnc3RhcnQnKSB7CgkJdGFyZ2V0ID0gbW9kZWwuc2NhbGVCb3R0b20gPT09IHVuZGVmaW5lZCA/IHNjYWxlLmJvdHRvbSA6IG1vZGVsLnNjYWxlQm90dG9tOwoJfSBlbHNlIGlmIChmaWxsID09PSAnZW5kJykgewoJCXRhcmdldCA9IG1vZGVsLnNjYWxlVG9wID09PSB1bmRlZmluZWQgPyBzY2FsZS50b3AgOiBtb2RlbC5zY2FsZVRvcDsKCX0gZWxzZSBpZiAobW9kZWwuc2NhbGVaZXJvICE9PSB1bmRlZmluZWQpIHsKCQl0YXJnZXQgPSBtb2RlbC5zY2FsZVplcm87Cgl9IGVsc2UgaWYgKHNjYWxlLmdldEJhc2VQb3NpdGlvbikgewoJCXRhcmdldCA9IHNjYWxlLmdldEJhc2VQb3NpdGlvbigpOwoJfSBlbHNlIGlmIChzY2FsZS5nZXRCYXNlUGl4ZWwpIHsKCQl0YXJnZXQgPSBzY2FsZS5nZXRCYXNlUGl4ZWwoKTsKCX0KCglpZiAodGFyZ2V0ICE9PSB1bmRlZmluZWQgJiYgdGFyZ2V0ICE9PSBudWxsKSB7CgkJaWYgKHRhcmdldC54ICE9PSB1bmRlZmluZWQgJiYgdGFyZ2V0LnkgIT09IHVuZGVmaW5lZCkgewoJCQlyZXR1cm4gdGFyZ2V0OwoJCX0KCgkJaWYgKHR5cGVvZiB0YXJnZXQgPT09ICdudW1iZXInICYmIGlzRmluaXRlKHRhcmdldCkpIHsKCQkJaG9yaXpvbnRhbCA9IHNjYWxlLmlzSG9yaXpvbnRhbCgpOwoJCQlyZXR1cm4gewoJCQkJeDogaG9yaXpvbnRhbCA/IHRhcmdldCA6IG51bGwsCgkJCQl5OiBob3Jpem9udGFsID8gbnVsbCA6IHRhcmdldAoJCQl9OwoJCX0KCX0KCglyZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gcmVzb2x2ZVRhcmdldChzb3VyY2VzLCBpbmRleCwgcHJvcGFnYXRlKSB7Cgl2YXIgc291cmNlID0gc291cmNlc1tpbmRleF07Cgl2YXIgZmlsbCA9IHNvdXJjZS5maWxsOwoJdmFyIHZpc2l0ZWQgPSBbaW5kZXhdOwoJdmFyIHRhcmdldDsKCglpZiAoIXByb3BhZ2F0ZSkgewoJCXJldHVybiBmaWxsOwoJfQoKCXdoaWxlIChmaWxsICE9PSBmYWxzZSAmJiB2aXNpdGVkLmluZGV4T2YoZmlsbCkgPT09IC0xKSB7CgkJaWYgKCFpc0Zpbml0ZShmaWxsKSkgewoJCQlyZXR1cm4gZmlsbDsKCQl9CgoJCXRhcmdldCA9IHNvdXJjZXNbZmlsbF07CgkJaWYgKCF0YXJnZXQpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKHRhcmdldC52aXNpYmxlKSB7CgkJCXJldHVybiBmaWxsOwoJCX0KCgkJdmlzaXRlZC5wdXNoKGZpbGwpOwoJCWZpbGwgPSB0YXJnZXQuZmlsbDsKCX0KCglyZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIGNyZWF0ZU1hcHBlcihzb3VyY2UpIHsKCXZhciBmaWxsID0gc291cmNlLmZpbGw7Cgl2YXIgdHlwZSA9ICdkYXRhc2V0JzsKCglpZiAoZmlsbCA9PT0gZmFsc2UpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCglpZiAoIWlzRmluaXRlKGZpbGwpKSB7CgkJdHlwZSA9ICdib3VuZGFyeSc7Cgl9CgoJcmV0dXJuIG1hcHBlcnNbdHlwZV0oc291cmNlKTsKfQoKZnVuY3Rpb24gaXNEcmF3YWJsZShwb2ludCkgewoJcmV0dXJuIHBvaW50ICYmICFwb2ludC5za2lwOwp9CgpmdW5jdGlvbiBkcmF3QXJlYShjdHgsIGN1cnZlMCwgY3VydmUxLCBsZW4wLCBsZW4xKSB7Cgl2YXIgaTsKCglpZiAoIWxlbjAgfHwgIWxlbjEpIHsKCQlyZXR1cm47Cgl9CgoJLy8gYnVpbGRpbmcgZmlyc3QgYXJlYSBjdXJ2ZSAobm9ybWFsKQoJY3R4Lm1vdmVUbyhjdXJ2ZTBbMF0ueCwgY3VydmUwWzBdLnkpOwoJZm9yIChpID0gMTsgaSA8IGxlbjA7ICsraSkgewoJCWhlbHBlcnMuY2FudmFzLmxpbmVUbyhjdHgsIGN1cnZlMFtpIC0gMV0sIGN1cnZlMFtpXSk7Cgl9CgoJLy8gam9pbmluZyB0aGUgdHdvIGFyZWEgY3VydmVzCgljdHgubGluZVRvKGN1cnZlMVtsZW4xIC0gMV0ueCwgY3VydmUxW2xlbjEgLSAxXS55KTsKCgkvLyBidWlsZGluZyBvcHBvc2l0ZSBhcmVhIGN1cnZlIChyZXZlcnNlKQoJZm9yIChpID0gbGVuMSAtIDE7IGkgPiAwOyAtLWkpIHsKCQloZWxwZXJzLmNhbnZhcy5saW5lVG8oY3R4LCBjdXJ2ZTFbaV0sIGN1cnZlMVtpIC0gMV0sIHRydWUpOwoJfQp9CgpmdW5jdGlvbiBkb0ZpbGwoY3R4LCBwb2ludHMsIG1hcHBlciwgdmlldywgY29sb3IsIGxvb3ApIHsKCXZhciBjb3VudCA9IHBvaW50cy5sZW5ndGg7Cgl2YXIgc3BhbiA9IHZpZXcuc3BhbkdhcHM7Cgl2YXIgY3VydmUwID0gW107Cgl2YXIgY3VydmUxID0gW107Cgl2YXIgbGVuMCA9IDA7Cgl2YXIgbGVuMSA9IDA7Cgl2YXIgaSwgaWxlbiwgaW5kZXgsIHAwLCBwMSwgZDAsIGQxOwoKCWN0eC5iZWdpblBhdGgoKTsKCglmb3IgKGkgPSAwLCBpbGVuID0gKGNvdW50ICsgISFsb29wKTsgaSA8IGlsZW47ICsraSkgewoJCWluZGV4ID0gaSAlIGNvdW50OwoJCXAwID0gcG9pbnRzW2luZGV4XS5fdmlldzsKCQlwMSA9IG1hcHBlcihwMCwgaW5kZXgsIHZpZXcpOwoJCWQwID0gaXNEcmF3YWJsZShwMCk7CgkJZDEgPSBpc0RyYXdhYmxlKHAxKTsKCgkJaWYgKGQwICYmIGQxKSB7CgkJCWxlbjAgPSBjdXJ2ZTAucHVzaChwMCk7CgkJCWxlbjEgPSBjdXJ2ZTEucHVzaChwMSk7CgkJfSBlbHNlIGlmIChsZW4wICYmIGxlbjEpIHsKCQkJaWYgKCFzcGFuKSB7CgkJCQlkcmF3QXJlYShjdHgsIGN1cnZlMCwgY3VydmUxLCBsZW4wLCBsZW4xKTsKCQkJCWxlbjAgPSBsZW4xID0gMDsKCQkJCWN1cnZlMCA9IFtdOwoJCQkJY3VydmUxID0gW107CgkJCX0gZWxzZSB7CgkJCQlpZiAoZDApIHsKCQkJCQljdXJ2ZTAucHVzaChwMCk7CgkJCQl9CgkJCQlpZiAoZDEpIHsKCQkJCQljdXJ2ZTEucHVzaChwMSk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJZHJhd0FyZWEoY3R4LCBjdXJ2ZTAsIGN1cnZlMSwgbGVuMCwgbGVuMSk7CgoJY3R4LmNsb3NlUGF0aCgpOwoJY3R4LmZpbGxTdHlsZSA9IGNvbG9yOwoJY3R4LmZpbGwoKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CglpZDogJ2ZpbGxlcicsCgoJYWZ0ZXJEYXRhc2V0c1VwZGF0ZTogZnVuY3Rpb24oY2hhcnQsIG9wdGlvbnMpIHsKCQl2YXIgY291bnQgPSAoY2hhcnQuZGF0YS5kYXRhc2V0cyB8fCBbXSkubGVuZ3RoOwoJCXZhciBwcm9wYWdhdGUgPSBvcHRpb25zLnByb3BhZ2F0ZTsKCQl2YXIgc291cmNlcyA9IFtdOwoJCXZhciBtZXRhLCBpLCBlbCwgc291cmNlOwoKCQlmb3IgKGkgPSAwOyBpIDwgY291bnQ7ICsraSkgewoJCQltZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaSk7CgkJCWVsID0gbWV0YS5kYXRhc2V0OwoJCQlzb3VyY2UgPSBudWxsOwoKCQkJaWYgKGVsICYmIGVsLl9tb2RlbCAmJiBlbCBpbnN0YW5jZW9mIGVsZW1lbnRzLkxpbmUpIHsKCQkJCXNvdXJjZSA9IHsKCQkJCQl2aXNpYmxlOiBjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGkpLAoJCQkJCWZpbGw6IGRlY29kZUZpbGwoZWwsIGksIGNvdW50KSwKCQkJCQljaGFydDogY2hhcnQsCgkJCQkJZWw6IGVsCgkJCQl9OwoJCQl9CgoJCQltZXRhLiRmaWxsZXIgPSBzb3VyY2U7CgkJCXNvdXJjZXMucHVzaChzb3VyY2UpOwoJCX0KCgkJZm9yIChpID0gMDsgaSA8IGNvdW50OyArK2kpIHsKCQkJc291cmNlID0gc291cmNlc1tpXTsKCQkJaWYgKCFzb3VyY2UpIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzb3VyY2UuZmlsbCA9IHJlc29sdmVUYXJnZXQoc291cmNlcywgaSwgcHJvcGFnYXRlKTsKCQkJc291cmNlLmJvdW5kYXJ5ID0gY29tcHV0ZUJvdW5kYXJ5KHNvdXJjZSk7CgkJCXNvdXJjZS5tYXBwZXIgPSBjcmVhdGVNYXBwZXIoc291cmNlKTsKCQl9Cgl9LAoKCWJlZm9yZURhdGFzZXREcmF3OiBmdW5jdGlvbihjaGFydCwgYXJncykgewoJCXZhciBtZXRhID0gYXJncy5tZXRhLiRmaWxsZXI7CgkJaWYgKCFtZXRhKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBjdHggPSBjaGFydC5jdHg7CgkJdmFyIGVsID0gbWV0YS5lbDsKCQl2YXIgdmlldyA9IGVsLl92aWV3OwoJCXZhciBwb2ludHMgPSBlbC5fY2hpbGRyZW4gfHwgW107CgkJdmFyIG1hcHBlciA9IG1ldGEubWFwcGVyOwoJCXZhciBjb2xvciA9IHZpZXcuYmFja2dyb3VuZENvbG9yIHx8IGRlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Q29sb3I7CgoJCWlmIChtYXBwZXIgJiYgY29sb3IgJiYgcG9pbnRzLmxlbmd0aCkgewoJCQloZWxwZXJzLmNhbnZhcy5jbGlwQXJlYShjdHgsIGNoYXJ0LmNoYXJ0QXJlYSk7CgkJCWRvRmlsbChjdHgsIHBvaW50cywgbWFwcGVyLCB2aWV3LCBjb2xvciwgZWwuX2xvb3ApOwoJCQloZWxwZXJzLmNhbnZhcy51bmNsaXBBcmVhKGN0eCk7CgkJfQoJfQp9OwoKfSx7IjI1IjoyNSwiNDAiOjQwLCI0NSI6NDV9XSw1MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgRWxlbWVudCA9IHJlcXVpcmUoMjYpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgbGF5b3V0cyA9IHJlcXVpcmUoMzApOwoKdmFyIG5vb3AgPSBoZWxwZXJzLm5vb3A7CgpkZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CglsZWdlbmQ6IHsKCQlkaXNwbGF5OiB0cnVlLAoJCXBvc2l0aW9uOiAndG9wJywKCQlmdWxsV2lkdGg6IHRydWUsCgkJcmV2ZXJzZTogZmFsc2UsCgkJd2VpZ2h0OiAxMDAwLAoKCQkvLyBhIGNhbGxiYWNrIHRoYXQgd2lsbCBoYW5kbGUKCQlvbkNsaWNrOiBmdW5jdGlvbihlLCBsZWdlbmRJdGVtKSB7CgkJCXZhciBpbmRleCA9IGxlZ2VuZEl0ZW0uZGF0YXNldEluZGV4OwoJCQl2YXIgY2kgPSB0aGlzLmNoYXJ0OwoJCQl2YXIgbWV0YSA9IGNpLmdldERhdGFzZXRNZXRhKGluZGV4KTsKCgkJCS8vIFNlZSBjb250cm9sbGVyLmlzRGF0YXNldFZpc2libGUgY29tbWVudAoJCQltZXRhLmhpZGRlbiA9IG1ldGEuaGlkZGVuID09PSBudWxsID8gIWNpLmRhdGEuZGF0YXNldHNbaW5kZXhdLmhpZGRlbiA6IG51bGw7CgoJCQkvLyBXZSBoaWQgYSBkYXRhc2V0IC4uLiByZXJlbmRlciB0aGUgY2hhcnQKCQkJY2kudXBkYXRlKCk7CgkJfSwKCgkJb25Ib3ZlcjogbnVsbCwKCgkJbGFiZWxzOiB7CgkJCWJveFdpZHRoOiA0MCwKCQkJcGFkZGluZzogMTAsCgkJCS8vIEdlbmVyYXRlcyBsYWJlbHMgc2hvd24gaW4gdGhlIGxlZ2VuZAoJCQkvLyBWYWxpZCBwcm9wZXJ0aWVzIHRvIHJldHVybjoKCQkJLy8gdGV4dCA6IHRleHQgdG8gZGlzcGxheQoJCQkvLyBmaWxsU3R5bGUgOiBmaWxsIG9mIGNvbG91cmVkIGJveAoJCQkvLyBzdHJva2VTdHlsZTogc3Ryb2tlIG9mIGNvbG91cmVkIGJveAoJCQkvLyBoaWRkZW4gOiBpZiB0aGlzIGxlZ2VuZCBpdGVtIHJlZmVycyB0byBhIGhpZGRlbiBpdGVtCgkJCS8vIGxpbmVDYXAgOiBjYXAgc3R5bGUgZm9yIGxpbmUKCQkJLy8gbGluZURhc2gKCQkJLy8gbGluZURhc2hPZmZzZXQgOgoJCQkvLyBsaW5lSm9pbiA6CgkJCS8vIGxpbmVXaWR0aCA6CgkJCWdlbmVyYXRlTGFiZWxzOiBmdW5jdGlvbihjaGFydCkgewoJCQkJdmFyIGRhdGEgPSBjaGFydC5kYXRhOwoJCQkJcmV0dXJuIGhlbHBlcnMuaXNBcnJheShkYXRhLmRhdGFzZXRzKSA/IGRhdGEuZGF0YXNldHMubWFwKGZ1bmN0aW9uKGRhdGFzZXQsIGkpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQl0ZXh0OiBkYXRhc2V0LmxhYmVsLAoJCQkJCQlmaWxsU3R5bGU6ICghaGVscGVycy5pc0FycmF5KGRhdGFzZXQuYmFja2dyb3VuZENvbG9yKSA/IGRhdGFzZXQuYmFja2dyb3VuZENvbG9yIDogZGF0YXNldC5iYWNrZ3JvdW5kQ29sb3JbMF0pLAoJCQkJCQloaWRkZW46ICFjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGkpLAoJCQkJCQlsaW5lQ2FwOiBkYXRhc2V0LmJvcmRlckNhcFN0eWxlLAoJCQkJCQlsaW5lRGFzaDogZGF0YXNldC5ib3JkZXJEYXNoLAoJCQkJCQlsaW5lRGFzaE9mZnNldDogZGF0YXNldC5ib3JkZXJEYXNoT2Zmc2V0LAoJCQkJCQlsaW5lSm9pbjogZGF0YXNldC5ib3JkZXJKb2luU3R5bGUsCgkJCQkJCWxpbmVXaWR0aDogZGF0YXNldC5ib3JkZXJXaWR0aCwKCQkJCQkJc3Ryb2tlU3R5bGU6IGRhdGFzZXQuYm9yZGVyQ29sb3IsCgkJCQkJCXBvaW50U3R5bGU6IGRhdGFzZXQucG9pbnRTdHlsZSwKCgkJCQkJCS8vIEJlbG93IGlzIGV4dHJhIGRhdGEgdXNlZCBmb3IgdG9nZ2xpbmcgdGhlIGRhdGFzZXRzCgkJCQkJCWRhdGFzZXRJbmRleDogaQoJCQkJCX07CgkJCQl9LCB0aGlzKSA6IFtdOwoJCQl9CgkJfQoJfSwKCglsZWdlbmRDYWxsYmFjazogZnVuY3Rpb24oY2hhcnQpIHsKCQl2YXIgdGV4dCA9IFtdOwoJCXRleHQucHVzaCgnPHVsIGNsYXNzPSInICsgY2hhcnQuaWQgKyAnLWxlZ2VuZCI+Jyk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBjaGFydC5kYXRhLmRhdGFzZXRzLmxlbmd0aDsgaSsrKSB7CgkJCXRleHQucHVzaCgnPGxpPjxzcGFuIHN0eWxlPSJiYWNrZ3JvdW5kLWNvbG9yOicgKyBjaGFydC5kYXRhLmRhdGFzZXRzW2ldLmJhY2tncm91bmRDb2xvciArICciPjwvc3Bhbj4nKTsKCQkJaWYgKGNoYXJ0LmRhdGEuZGF0YXNldHNbaV0ubGFiZWwpIHsKCQkJCXRleHQucHVzaChjaGFydC5kYXRhLmRhdGFzZXRzW2ldLmxhYmVsKTsKCQkJfQoJCQl0ZXh0LnB1c2goJzwvbGk+Jyk7CgkJfQoJCXRleHQucHVzaCgnPC91bD4nKTsKCQlyZXR1cm4gdGV4dC5qb2luKCcnKTsKCX0KfSk7CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRvIGdldCB0aGUgYm94IHdpZHRoIGJhc2VkIG9uIHRoZSB1c2VQb2ludFN0eWxlIG9wdGlvbgogKiBAcGFyYW0gbGFiZWxvcHRzIHtPYmplY3R9IHRoZSBsYWJlbCBvcHRpb25zIG9uIHRoZSBsZWdlbmQKICogQHBhcmFtIGZvbnRTaXplIHtOdW1iZXJ9IHRoZSBsYWJlbCBmb250IHNpemUKICogQHJldHVybiB7TnVtYmVyfSB3aWR0aCBvZiB0aGUgY29sb3IgYm94IGFyZWEKICovCmZ1bmN0aW9uIGdldEJveFdpZHRoKGxhYmVsT3B0cywgZm9udFNpemUpIHsKCXJldHVybiBsYWJlbE9wdHMudXNlUG9pbnRTdHlsZSA/CgkJZm9udFNpemUgKiBNYXRoLlNRUlQyIDoKCQlsYWJlbE9wdHMuYm94V2lkdGg7Cn0KCi8qKgogKiBJTVBPUlRBTlQ6IHRoaXMgY2xhc3MgaXMgZXhwb3NlZCBwdWJsaWNseSBhcyBDaGFydC5MZWdlbmQsIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgcmVxdWlyZWQhCiAqLwp2YXIgTGVnZW5kID0gRWxlbWVudC5leHRlbmQoewoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGNvbmZpZykgewoJCWhlbHBlcnMuZXh0ZW5kKHRoaXMsIGNvbmZpZyk7CgoJCS8vIENvbnRhaW5zIGhpdCBib3hlcyBmb3IgZWFjaCBkYXRhc2V0IChpbiBkYXRhc2V0IG9yZGVyKQoJCXRoaXMubGVnZW5kSGl0Qm94ZXMgPSBbXTsKCgkJLy8gQXJlIHdlIGluIGRvdWdobnV0IG1vZGUgd2hpY2ggaGFzIGEgZGlmZmVyZW50IGRhdGEgdHlwZQoJCXRoaXMuZG91Z2hudXRNb2RlID0gZmFsc2U7Cgl9LAoKCS8vIFRoZXNlIG1ldGhvZHMgYXJlIG9yZGVyZWQgYnkgbGlmZWN5Y2xlLiBVdGlsaXRpZXMgdGhlbiBmb2xsb3cuCgkvLyBBbnkgZnVuY3Rpb24gZGVmaW5lZCBoZXJlIGlzIGluaGVyaXRlZCBieSBhbGwgbGVnZW5kIHR5cGVzLgoJLy8gQW55IGZ1bmN0aW9uIGNhbiBiZSBleHRlbmRlZCBieSB0aGUgbGVnZW5kIHR5cGUKCgliZWZvcmVVcGRhdGU6IG5vb3AsCgl1cGRhdGU6IGZ1bmN0aW9uKG1heFdpZHRoLCBtYXhIZWlnaHQsIG1hcmdpbnMpIHsKCQl2YXIgbWUgPSB0aGlzOwoKCQkvLyBVcGRhdGUgTGlmZWN5Y2xlIC0gUHJvYmFibHkgZG9uJ3Qgd2FudCB0byBldmVyIGV4dGVuZCBvciBvdmVyd3JpdGUgdGhpcyBmdW5jdGlvbiA7KQoJCW1lLmJlZm9yZVVwZGF0ZSgpOwoKCQkvLyBBYnNvcmIgdGhlIG1hc3RlciBtZWFzdXJlbWVudHMKCQltZS5tYXhXaWR0aCA9IG1heFdpZHRoOwoJCW1lLm1heEhlaWdodCA9IG1heEhlaWdodDsKCQltZS5tYXJnaW5zID0gbWFyZ2luczsKCgkJLy8gRGltZW5zaW9ucwoJCW1lLmJlZm9yZVNldERpbWVuc2lvbnMoKTsKCQltZS5zZXREaW1lbnNpb25zKCk7CgkJbWUuYWZ0ZXJTZXREaW1lbnNpb25zKCk7CgkJLy8gTGFiZWxzCgkJbWUuYmVmb3JlQnVpbGRMYWJlbHMoKTsKCQltZS5idWlsZExhYmVscygpOwoJCW1lLmFmdGVyQnVpbGRMYWJlbHMoKTsKCgkJLy8gRml0CgkJbWUuYmVmb3JlRml0KCk7CgkJbWUuZml0KCk7CgkJbWUuYWZ0ZXJGaXQoKTsKCQkvLwoJCW1lLmFmdGVyVXBkYXRlKCk7CgoJCXJldHVybiBtZS5taW5TaXplOwoJfSwKCWFmdGVyVXBkYXRlOiBub29wLAoKCS8vCgoJYmVmb3JlU2V0RGltZW5zaW9uczogbm9vcCwKCXNldERpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBtZSA9IHRoaXM7CgkJLy8gU2V0IHRoZSB1bmNvbnN0cmFpbmVkIGRpbWVuc2lvbiBiZWZvcmUgbGFiZWwgcm90YXRpb24KCQlpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKCQkJLy8gUmVzZXQgcG9zaXRpb24gYmVmb3JlIGNhbGN1bGF0aW5nIHJvdGF0aW9uCgkJCW1lLndpZHRoID0gbWUubWF4V2lkdGg7CgkJCW1lLmxlZnQgPSAwOwoJCQltZS5yaWdodCA9IG1lLndpZHRoOwoJCX0gZWxzZSB7CgkJCW1lLmhlaWdodCA9IG1lLm1heEhlaWdodDsKCgkJCS8vIFJlc2V0IHBvc2l0aW9uIGJlZm9yZSBjYWxjdWxhdGluZyByb3RhdGlvbgoJCQltZS50b3AgPSAwOwoJCQltZS5ib3R0b20gPSBtZS5oZWlnaHQ7CgkJfQoKCQkvLyBSZXNldCBwYWRkaW5nCgkJbWUucGFkZGluZ0xlZnQgPSAwOwoJCW1lLnBhZGRpbmdUb3AgPSAwOwoJCW1lLnBhZGRpbmdSaWdodCA9IDA7CgkJbWUucGFkZGluZ0JvdHRvbSA9IDA7CgoJCS8vIFJlc2V0IG1pblNpemUKCQltZS5taW5TaXplID0gewoJCQl3aWR0aDogMCwKCQkJaGVpZ2h0OiAwCgkJfTsKCX0sCglhZnRlclNldERpbWVuc2lvbnM6IG5vb3AsCgoJLy8KCgliZWZvcmVCdWlsZExhYmVsczogbm9vcCwKCWJ1aWxkTGFiZWxzOiBmdW5jdGlvbigpIHsKCQl2YXIgbWUgPSB0aGlzOwoJCXZhciBsYWJlbE9wdHMgPSBtZS5vcHRpb25zLmxhYmVscyB8fCB7fTsKCQl2YXIgbGVnZW5kSXRlbXMgPSBoZWxwZXJzLmNhbGxiYWNrKGxhYmVsT3B0cy5nZW5lcmF0ZUxhYmVscywgW21lLmNoYXJ0XSwgbWUpIHx8IFtdOwoKCQlpZiAobGFiZWxPcHRzLmZpbHRlcikgewoJCQlsZWdlbmRJdGVtcyA9IGxlZ2VuZEl0ZW1zLmZpbHRlcihmdW5jdGlvbihpdGVtKSB7CgkJCQlyZXR1cm4gbGFiZWxPcHRzLmZpbHRlcihpdGVtLCBtZS5jaGFydC5kYXRhKTsKCQkJfSk7CgkJfQoKCQlpZiAobWUub3B0aW9ucy5yZXZlcnNlKSB7CgkJCWxlZ2VuZEl0ZW1zLnJldmVyc2UoKTsKCQl9CgoJCW1lLmxlZ2VuZEl0ZW1zID0gbGVnZW5kSXRlbXM7Cgl9LAoJYWZ0ZXJCdWlsZExhYmVsczogbm9vcCwKCgkvLwoKCWJlZm9yZUZpdDogbm9vcCwKCWZpdDogZnVuY3Rpb24oKSB7CgkJdmFyIG1lID0gdGhpczsKCQl2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CgkJdmFyIGxhYmVsT3B0cyA9IG9wdHMubGFiZWxzOwoJCXZhciBkaXNwbGF5ID0gb3B0cy5kaXNwbGF5OwoKCQl2YXIgY3R4ID0gbWUuY3R4OwoKCQl2YXIgZ2xvYmFsRGVmYXVsdCA9IGRlZmF1bHRzLmdsb2JhbDsKCQl2YXIgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoJCXZhciBmb250U2l6ZSA9IHZhbHVlT3JEZWZhdWx0KGxhYmVsT3B0cy5mb250U2l6ZSwgZ2xvYmFsRGVmYXVsdC5kZWZhdWx0Rm9udFNpemUpOwoJCXZhciBmb250U3R5bGUgPSB2YWx1ZU9yRGVmYXVsdChsYWJlbE9wdHMuZm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0LmRlZmF1bHRGb250U3R5bGUpOwoJCXZhciBmb250RmFtaWx5ID0gdmFsdWVPckRlZmF1bHQobGFiZWxPcHRzLmZvbnRGYW1pbHksIGdsb2JhbERlZmF1bHQuZGVmYXVsdEZvbnRGYW1pbHkpOwoJCXZhciBsYWJlbEZvbnQgPSBoZWxwZXJzLmZvbnRTdHJpbmcoZm9udFNpemUsIGZvbnRTdHlsZSwgZm9udEZhbWlseSk7CgoJCS8vIFJlc2V0IGhpdCBib3hlcwoJCXZhciBoaXRib3hlcyA9IG1lLmxlZ2VuZEhpdEJveGVzID0gW107CgoJCXZhciBtaW5TaXplID0gbWUubWluU2l6ZTsKCQl2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgoJCWlmIChpc0hvcml6b250YWwpIHsKCQkJbWluU2l6ZS53aWR0aCA9IG1lLm1heFdpZHRoOyAvLyBmaWxsIGFsbCB0aGUgd2lkdGgKCQkJbWluU2l6ZS5oZWlnaHQgPSBkaXNwbGF5ID8gMTAgOiAwOwoJCX0gZWxzZSB7CgkJCW1pblNpemUud2lkdGggPSBkaXNwbGF5ID8gMTAgOiAwOwoJCQltaW5TaXplLmhlaWdodCA9IG1lLm1heEhlaWdodDsgLy8gZmlsbCBhbGwgdGhlIGhlaWdodAoJCX0KCgkJLy8gSW5jcmVhc2Ugc2l6ZXMgaGVyZQoJCWlmIChkaXNwbGF5KSB7CgkJCWN0eC5mb250ID0gbGFiZWxGb250OwoKCQkJaWYgKGlzSG9yaXpvbnRhbCkgewoJCQkJLy8gTGFiZWxzCgoJCQkJLy8gV2lkdGggb2YgZWFjaCBsaW5lIG9mIGxlZ2VuZCBib3hlcy4gTGFiZWxzIHdyYXAgb250byBtdWx0aXBsZSBsaW5lcyB3aGVuIHRoZXJlIGFyZSB0b28gbWFueSB0byBmaXQgb24gb25lCgkJCQl2YXIgbGluZVdpZHRocyA9IG1lLmxpbmVXaWR0aHMgPSBbMF07CgkJCQl2YXIgdG90YWxIZWlnaHQgPSBtZS5sZWdlbmRJdGVtcy5sZW5ndGggPyBmb250U2l6ZSArIChsYWJlbE9wdHMucGFkZGluZykgOiAwOwoKCQkJCWN0eC50ZXh0QWxpZ24gPSAnbGVmdCc7CgkJCQljdHgudGV4dEJhc2VsaW5lID0gJ3RvcCc7CgoJCQkJaGVscGVycy5lYWNoKG1lLmxlZ2VuZEl0ZW1zLCBmdW5jdGlvbihsZWdlbmRJdGVtLCBpKSB7CgkJCQkJdmFyIGJveFdpZHRoID0gZ2V0Qm94V2lkdGgobGFiZWxPcHRzLCBmb250U2l6ZSk7CgkJCQkJdmFyIHdpZHRoID0gYm94V2lkdGggKyAoZm9udFNpemUgLyAyKSArIGN0eC5tZWFzdXJlVGV4dChsZWdlbmRJdGVtLnRleHQpLndpZHRoOwoKCQkJCQlpZiAobGluZVdpZHRoc1tsaW5lV2lkdGhzLmxlbmd0aCAtIDFdICsgd2lkdGggKyBsYWJlbE9wdHMucGFkZGluZyA+PSBtZS53aWR0aCkgewoJCQkJCQl0b3RhbEhlaWdodCArPSBmb250U2l6ZSArIChsYWJlbE9wdHMucGFkZGluZyk7CgkJCQkJCWxpbmVXaWR0aHNbbGluZVdpZHRocy5sZW5ndGhdID0gbWUubGVmdDsKCQkJCQl9CgoJCQkJCS8vIFN0b3JlIHRoZSBoaXRib3ggd2lkdGggYW5kIGhlaWdodCBoZXJlLiBGaW5hbCBwb3NpdGlvbiB3aWxsIGJlIHVwZGF0ZWQgaW4gYGRyYXdgCgkJCQkJaGl0Ym94ZXNbaV0gPSB7CgkJCQkJCWxlZnQ6IDAsCgkJCQkJCXRvcDogMCwKCQkJCQkJd2lkdGg6IHdpZHRoLAoJCQkJCQloZWlnaHQ6IGZvbnRTaXplCgkJCQkJfTsKCgkJCQkJbGluZVdpZHRoc1tsaW5lV2lkdGhzLmxlbmd0aCAtIDFdICs9IHdpZHRoICsgbGFiZWxPcHRzLnBhZGRpbmc7CgkJCQl9KTsKCgkJCQltaW5TaXplLmhlaWdodCArPSB0b3RhbEhlaWdodDsKCgkJCX0gZWxzZSB7CgkJCQl2YXIgdlBhZGRpbmcgPSBsYWJlbE9wdHMucGFkZGluZzsKCQkJCXZhciBjb2x1bW5XaWR0aHMgPSBtZS5jb2x1bW5XaWR0aHMgPSBbXTsKCQkJCXZhciB0b3RhbFdpZHRoID0gbGFiZWxPcHRzLnBhZGRpbmc7CgkJCQl2YXIgY3VycmVudENvbFdpZHRoID0gMDsKCQkJCXZhciBjdXJyZW50Q29sSGVpZ2h0ID0gMDsKCQkJCXZhciBpdGVtSGVpZ2h0ID0gZm9udFNpemUgKyB2UGFkZGluZzsKCgkJCQloZWxwZXJzLmVhY2gobWUubGVnZW5kSXRlbXMsIGZ1bmN0aW9uKGxlZ2VuZEl0ZW0sIGkpIHsKCQkJCQl2YXIgYm94V2lkdGggPSBnZXRCb3hXaWR0aChsYWJlbE9wdHMsIGZvbnRTaXplKTsKCQkJCQl2YXIgaXRlbVdpZHRoID0gYm94V2lkdGggKyAoZm9udFNpemUgLyAyKSArIGN0eC5tZWFzdXJlVGV4dChsZWdlbmRJdGVtLnRleHQpLndpZHRoOwoKCQkJCQkvLyBJZiB0b28gdGFsbCwgZ28gdG8gbmV3IGNvbHVtbgoJCQkJCWlmIChjdXJyZW50Q29sSGVpZ2h0ICsgaXRlbUhlaWdodCA+IG1pblNpemUuaGVpZ2h0KSB7CgkJCQkJCXRvdGFsV2lkdGggKz0gY3VycmVudENvbFdpZHRoICsgbGFiZWxPcHRzLnBhZGRpbmc7CgkJCQkJCWNvbHVtbldpZHRocy5wdXNoKGN1cnJlbnRDb2xXaWR0aCk7IC8vIHByZXZpb3VzIGNvbHVtbiB3aWR0aAoKCQkJCQkJY3VycmVudENvbFdpZHRoID0gMDsKCQkJCQkJY3VycmVudENvbEhlaWdodCA9IDA7CgkJCQkJfQoKCQkJCQkvLyBHZXQgbWF4IHdpZHRoCgkJCQkJY3VycmVudENvbFdpZHRoID0gTWF0aC5tYXgoY3VycmVudENvbFdpZHRoLCBpdGVtV2lkdGgpOwoJCQkJCWN1cnJlbnRDb2xIZWlnaHQgKz0gaXRlbUhlaWdodDsKCgkJCQkJLy8gU3RvcmUgdGhlIGhpdGJveCB3aWR0aCBhbmQgaGVpZ2h0IGhlcmUuIEZpbmFsIHBvc2l0aW9uIHdpbGwgYmUgdXBkYXRlZCBpbiBgZHJhd2AKCQkJCQloaXRib3hlc1tpXSA9IHsKCQkJCQkJbGVmdDogMCwKCQkJCQkJdG9wOiAwLAoJCQkJCQl3aWR0aDogaXRlbVdpZHRoLAoJCQkJCQloZWlnaHQ6IGZvbnRTaXplCgkJCQkJfTsKCQkJCX0pOwoKCQkJCXRvdGFsV2lkdGggKz0gY3VycmVudENvbFdpZHRoOwoJCQkJY29sdW1uV2lkdGhzLnB1c2goY3VycmVudENvbFdpZHRoKTsKCQkJCW1pblNpemUud2lkdGggKz0gdG90YWxXaWR0aDsKCQkJfQoJCX0KCgkJbWUud2lkdGggPSBtaW5TaXplLndpZHRoOwoJCW1lLmhlaWdodCA9IG1pblNpemUuaGVpZ2h0OwoJfSwKCWFmdGVyRml0OiBub29wLAoKCS8vIFNoYXJlZCBNZXRob2RzCglpc0hvcml6b250YWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm9wdGlvbnMucG9zaXRpb24gPT09ICd0b3AnIHx8IHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gJ2JvdHRvbSc7Cgl9LAoKCS8vIEFjdHVhbGx5IGRyYXcgdGhlIGxlZ2VuZCBvbiB0aGUgY2FudmFzCglkcmF3OiBmdW5jdGlvbigpIHsKCQl2YXIgbWUgPSB0aGlzOwoJCXZhciBvcHRzID0gbWUub3B0aW9uczsKCQl2YXIgbGFiZWxPcHRzID0gb3B0cy5sYWJlbHM7CgkJdmFyIGdsb2JhbERlZmF1bHQgPSBkZWZhdWx0cy5nbG9iYWw7CgkJdmFyIGxpbmVEZWZhdWx0ID0gZ2xvYmFsRGVmYXVsdC5lbGVtZW50cy5saW5lOwoJCXZhciBsZWdlbmRXaWR0aCA9IG1lLndpZHRoOwoJCXZhciBsaW5lV2lkdGhzID0gbWUubGluZVdpZHRoczsKCgkJaWYgKG9wdHMuZGlzcGxheSkgewoJCQl2YXIgY3R4ID0gbWUuY3R4OwoJCQl2YXIgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoJCQl2YXIgZm9udENvbG9yID0gdmFsdWVPckRlZmF1bHQobGFiZWxPcHRzLmZvbnRDb2xvciwgZ2xvYmFsRGVmYXVsdC5kZWZhdWx0Rm9udENvbG9yKTsKCQkJdmFyIGZvbnRTaXplID0gdmFsdWVPckRlZmF1bHQobGFiZWxPcHRzLmZvbnRTaXplLCBnbG9iYWxEZWZhdWx0LmRlZmF1bHRGb250U2l6ZSk7CgkJCXZhciBmb250U3R5bGUgPSB2YWx1ZU9yRGVmYXVsdChsYWJlbE9wdHMuZm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0LmRlZmF1bHRGb250U3R5bGUpOwoJCQl2YXIgZm9udEZhbWlseSA9IHZhbHVlT3JEZWZhdWx0KGxhYmVsT3B0cy5mb250RmFtaWx5LCBnbG9iYWxEZWZhdWx0LmRlZmF1bHRGb250RmFtaWx5KTsKCQkJdmFyIGxhYmVsRm9udCA9IGhlbHBlcnMuZm9udFN0cmluZyhmb250U2l6ZSwgZm9udFN0eWxlLCBmb250RmFtaWx5KTsKCQkJdmFyIGN1cnNvcjsKCgkJCS8vIENhbnZhcyBzZXR1cAoJCQljdHgudGV4dEFsaWduID0gJ2xlZnQnOwoJCQljdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CgkJCWN0eC5saW5lV2lkdGggPSAwLjU7CgkJCWN0eC5zdHJva2VTdHlsZSA9IGZvbnRDb2xvcjsgLy8gZm9yIHN0cmlrZXRocm91Z2ggZWZmZWN0CgkJCWN0eC5maWxsU3R5bGUgPSBmb250Q29sb3I7IC8vIHJlbmRlciBpbiBjb3JyZWN0IGNvbG91cgoJCQljdHguZm9udCA9IGxhYmVsRm9udDsKCgkJCXZhciBib3hXaWR0aCA9IGdldEJveFdpZHRoKGxhYmVsT3B0cywgZm9udFNpemUpOwoJCQl2YXIgaGl0Ym94ZXMgPSBtZS5sZWdlbmRIaXRCb3hlczsKCgkJCS8vIGN1cnJlbnQgcG9zaXRpb24KCQkJdmFyIGRyYXdMZWdlbmRCb3ggPSBmdW5jdGlvbih4LCB5LCBsZWdlbmRJdGVtKSB7CgkJCQlpZiAoaXNOYU4oYm94V2lkdGgpIHx8IGJveFdpZHRoIDw9IDApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gU2V0IHRoZSBjdHggZm9yIHRoZSBib3gKCQkJCWN0eC5zYXZlKCk7CgoJCQkJY3R4LmZpbGxTdHlsZSA9IHZhbHVlT3JEZWZhdWx0KGxlZ2VuZEl0ZW0uZmlsbFN0eWxlLCBnbG9iYWxEZWZhdWx0LmRlZmF1bHRDb2xvcik7CgkJCQljdHgubGluZUNhcCA9IHZhbHVlT3JEZWZhdWx0KGxlZ2VuZEl0ZW0ubGluZUNhcCwgbGluZURlZmF1bHQuYm9yZGVyQ2FwU3R5bGUpOwoJCQkJY3R4LmxpbmVEYXNoT2Zmc2V0ID0gdmFsdWVPckRlZmF1bHQobGVnZW5kSXRlbS5saW5lRGFzaE9mZnNldCwgbGluZURlZmF1bHQuYm9yZGVyRGFzaE9mZnNldCk7CgkJCQljdHgubGluZUpvaW4gPSB2YWx1ZU9yRGVmYXVsdChsZWdlbmRJdGVtLmxpbmVKb2luLCBsaW5lRGVmYXVsdC5ib3JkZXJKb2luU3R5bGUpOwoJCQkJY3R4LmxpbmVXaWR0aCA9IHZhbHVlT3JEZWZhdWx0KGxlZ2VuZEl0ZW0ubGluZVdpZHRoLCBsaW5lRGVmYXVsdC5ib3JkZXJXaWR0aCk7CgkJCQljdHguc3Ryb2tlU3R5bGUgPSB2YWx1ZU9yRGVmYXVsdChsZWdlbmRJdGVtLnN0cm9rZVN0eWxlLCBnbG9iYWxEZWZhdWx0LmRlZmF1bHRDb2xvcik7CgkJCQl2YXIgaXNMaW5lV2lkdGhaZXJvID0gKHZhbHVlT3JEZWZhdWx0KGxlZ2VuZEl0ZW0ubGluZVdpZHRoLCBsaW5lRGVmYXVsdC5ib3JkZXJXaWR0aCkgPT09IDApOwoKCQkJCWlmIChjdHguc2V0TGluZURhc2gpIHsKCQkJCQkvLyBJRSA5IGFuZCAxMCBkbyBub3Qgc3VwcG9ydCBsaW5lIGRhc2gKCQkJCQljdHguc2V0TGluZURhc2godmFsdWVPckRlZmF1bHQobGVnZW5kSXRlbS5saW5lRGFzaCwgbGluZURlZmF1bHQuYm9yZGVyRGFzaCkpOwoJCQkJfQoKCQkJCWlmIChvcHRzLmxhYmVscyAmJiBvcHRzLmxhYmVscy51c2VQb2ludFN0eWxlKSB7CgkJCQkJLy8gUmVjYWxjdWxhdGUgeCBhbmQgeSBmb3IgZHJhd1BvaW50KCkgYmVjYXVzZSBpdHMgZXhwZWN0aW5nCgkJCQkJLy8geCBhbmQgeSB0byBiZSBjZW50ZXIgb2YgZmlndXJlIChpbnN0ZWFkIG9mIHRvcCBsZWZ0KQoJCQkJCXZhciByYWRpdXMgPSBmb250U2l6ZSAqIE1hdGguU1FSVDIgLyAyOwoJCQkJCXZhciBvZmZTZXQgPSByYWRpdXMgLyBNYXRoLlNRUlQyOwoJCQkJCXZhciBjZW50ZXJYID0geCArIG9mZlNldDsKCQkJCQl2YXIgY2VudGVyWSA9IHkgKyBvZmZTZXQ7CgoJCQkJCS8vIERyYXcgcG9pbnRTdHlsZSBhcyBsZWdlbmQgc3ltYm9sCgkJCQkJaGVscGVycy5jYW52YXMuZHJhd1BvaW50KGN0eCwgbGVnZW5kSXRlbS5wb2ludFN0eWxlLCByYWRpdXMsIGNlbnRlclgsIGNlbnRlclkpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBEcmF3IGJveCBhcyBsZWdlbmQgc3ltYm9sCgkJCQkJaWYgKCFpc0xpbmVXaWR0aFplcm8pIHsKCQkJCQkJY3R4LnN0cm9rZVJlY3QoeCwgeSwgYm94V2lkdGgsIGZvbnRTaXplKTsKCQkJCQl9CgkJCQkJY3R4LmZpbGxSZWN0KHgsIHksIGJveFdpZHRoLCBmb250U2l6ZSk7CgkJCQl9CgoJCQkJY3R4LnJlc3RvcmUoKTsKCQkJfTsKCQkJdmFyIGZpbGxUZXh0ID0gZnVuY3Rpb24oeCwgeSwgbGVnZW5kSXRlbSwgdGV4dFdpZHRoKSB7CgkJCQl2YXIgaGFsZkZvbnRTaXplID0gZm9udFNpemUgLyAyOwoJCQkJdmFyIHhMZWZ0ID0gYm94V2lkdGggKyBoYWxmRm9udFNpemUgKyB4OwoJCQkJdmFyIHlNaWRkbGUgPSB5ICsgaGFsZkZvbnRTaXplOwoKCQkJCWN0eC5maWxsVGV4dChsZWdlbmRJdGVtLnRleHQsIHhMZWZ0LCB5TWlkZGxlKTsKCgkJCQlpZiAobGVnZW5kSXRlbS5oaWRkZW4pIHsKCQkJCQkvLyBTdHJpa2V0aHJvdWdoIHRoZSB0ZXh0IGlmIGhpZGRlbgoJCQkJCWN0eC5iZWdpblBhdGgoKTsKCQkJCQljdHgubGluZVdpZHRoID0gMjsKCQkJCQljdHgubW92ZVRvKHhMZWZ0LCB5TWlkZGxlKTsKCQkJCQljdHgubGluZVRvKHhMZWZ0ICsgdGV4dFdpZHRoLCB5TWlkZGxlKTsKCQkJCQljdHguc3Ryb2tlKCk7CgkJCQl9CgkJCX07CgoJCQkvLyBIb3Jpem9udGFsCgkJCXZhciBpc0hvcml6b250YWwgPSBtZS5pc0hvcml6b250YWwoKTsKCQkJaWYgKGlzSG9yaXpvbnRhbCkgewoJCQkJY3Vyc29yID0gewoJCQkJCXg6IG1lLmxlZnQgKyAoKGxlZ2VuZFdpZHRoIC0gbGluZVdpZHRoc1swXSkgLyAyKSwKCQkJCQl5OiBtZS50b3AgKyBsYWJlbE9wdHMucGFkZGluZywKCQkJCQlsaW5lOiAwCgkJCQl9OwoJCQl9IGVsc2UgewoJCQkJY3Vyc29yID0gewoJCQkJCXg6IG1lLmxlZnQgKyBsYWJlbE9wdHMucGFkZGluZywKCQkJCQl5OiBtZS50b3AgKyBsYWJlbE9wdHMucGFkZGluZywKCQkJCQlsaW5lOiAwCgkJCQl9OwoJCQl9CgoJCQl2YXIgaXRlbUhlaWdodCA9IGZvbnRTaXplICsgbGFiZWxPcHRzLnBhZGRpbmc7CgkJCWhlbHBlcnMuZWFjaChtZS5sZWdlbmRJdGVtcywgZnVuY3Rpb24obGVnZW5kSXRlbSwgaSkgewoJCQkJdmFyIHRleHRXaWR0aCA9IGN0eC5tZWFzdXJlVGV4dChsZWdlbmRJdGVtLnRleHQpLndpZHRoOwoJCQkJdmFyIHdpZHRoID0gYm94V2lkdGggKyAoZm9udFNpemUgLyAyKSArIHRleHRXaWR0aDsKCQkJCXZhciB4ID0gY3Vyc29yLng7CgkJCQl2YXIgeSA9IGN1cnNvci55OwoKCQkJCWlmIChpc0hvcml6b250YWwpIHsKCQkJCQlpZiAoeCArIHdpZHRoID49IGxlZ2VuZFdpZHRoKSB7CgkJCQkJCXkgPSBjdXJzb3IueSArPSBpdGVtSGVpZ2h0OwoJCQkJCQljdXJzb3IubGluZSsrOwoJCQkJCQl4ID0gY3Vyc29yLnggPSBtZS5sZWZ0ICsgKChsZWdlbmRXaWR0aCAtIGxpbmVXaWR0aHNbY3Vyc29yLmxpbmVdKSAvIDIpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoeSArIGl0ZW1IZWlnaHQgPiBtZS5ib3R0b20pIHsKCQkJCQl4ID0gY3Vyc29yLnggPSB4ICsgbWUuY29sdW1uV2lkdGhzW2N1cnNvci5saW5lXSArIGxhYmVsT3B0cy5wYWRkaW5nOwoJCQkJCXkgPSBjdXJzb3IueSA9IG1lLnRvcCArIGxhYmVsT3B0cy5wYWRkaW5nOwoJCQkJCWN1cnNvci5saW5lKys7CgkJCQl9CgoJCQkJZHJhd0xlZ2VuZEJveCh4LCB5LCBsZWdlbmRJdGVtKTsKCgkJCQloaXRib3hlc1tpXS5sZWZ0ID0geDsKCQkJCWhpdGJveGVzW2ldLnRvcCA9IHk7CgoJCQkJLy8gRmlsbCB0aGUgYWN0dWFsIGxhYmVsCgkJCQlmaWxsVGV4dCh4LCB5LCBsZWdlbmRJdGVtLCB0ZXh0V2lkdGgpOwoKCQkJCWlmIChpc0hvcml6b250YWwpIHsKCQkJCQljdXJzb3IueCArPSB3aWR0aCArIChsYWJlbE9wdHMucGFkZGluZyk7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnNvci55ICs9IGl0ZW1IZWlnaHQ7CgkJCQl9CgoJCQl9KTsKCQl9Cgl9LAoKCS8qKgoJICogSGFuZGxlIGFuIGV2ZW50CgkgKiBAcHJpdmF0ZQoJICogQHBhcmFtIHtJRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IHRvIGhhbmRsZQoJICogQHJldHVybiB7Qm9vbGVhbn0gdHJ1ZSBpZiBhIGNoYW5nZSBvY2N1cmVkCgkgKi8KCWhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CgkJdmFyIG1lID0gdGhpczsKCQl2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CgkJdmFyIHR5cGUgPSBlLnR5cGUgPT09ICdtb3VzZXVwJyA/ICdjbGljaycgOiBlLnR5cGU7CgkJdmFyIGNoYW5nZWQgPSBmYWxzZTsKCgkJaWYgKHR5cGUgPT09ICdtb3VzZW1vdmUnKSB7CgkJCWlmICghb3B0cy5vbkhvdmVyKSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9IGVsc2UgaWYgKHR5cGUgPT09ICdjbGljaycpIHsKCQkJaWYgKCFvcHRzLm9uQ2xpY2spIHsKCQkJCXJldHVybjsKCQkJfQoJCX0gZWxzZSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIENoYXJ0IGV2ZW50IGFscmVhZHkgaGFzIHJlbGF0aXZlIHBvc2l0aW9uIGluIGl0CgkJdmFyIHggPSBlLng7CgkJdmFyIHkgPSBlLnk7CgoJCWlmICh4ID49IG1lLmxlZnQgJiYgeCA8PSBtZS5yaWdodCAmJiB5ID49IG1lLnRvcCAmJiB5IDw9IG1lLmJvdHRvbSkgewoJCQkvLyBTZWUgaWYgd2UgYXJlIHRvdWNoaW5nIG9uZSBvZiB0aGUgZGF0YXNldCBib3hlcwoJCQl2YXIgbGggPSBtZS5sZWdlbmRIaXRCb3hlczsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBsaC5sZW5ndGg7ICsraSkgewoJCQkJdmFyIGhpdEJveCA9IGxoW2ldOwoKCQkJCWlmICh4ID49IGhpdEJveC5sZWZ0ICYmIHggPD0gaGl0Qm94LmxlZnQgKyBoaXRCb3gud2lkdGggJiYgeSA+PSBoaXRCb3gudG9wICYmIHkgPD0gaGl0Qm94LnRvcCArIGhpdEJveC5oZWlnaHQpIHsKCQkJCQkvLyBUb3VjaGluZyBhbiBlbGVtZW50CgkJCQkJaWYgKHR5cGUgPT09ICdjbGljaycpIHsKCQkJCQkJLy8gdXNlIGUubmF0aXZlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJCQkJCQlvcHRzLm9uQ2xpY2suY2FsbChtZSwgZS5uYXRpdmUsIG1lLmxlZ2VuZEl0ZW1zW2ldKTsKCQkJCQkJY2hhbmdlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0gZWxzZSBpZiAodHlwZSA9PT0gJ21vdXNlbW92ZScpIHsKCQkJCQkJLy8gdXNlIGUubmF0aXZlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQoJCQkJCQlvcHRzLm9uSG92ZXIuY2FsbChtZSwgZS5uYXRpdmUsIG1lLmxlZ2VuZEl0ZW1zW2ldKTsKCQkJCQkJY2hhbmdlZCA9IHRydWU7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGNoYW5nZWQ7Cgl9Cn0pOwoKZnVuY3Rpb24gY3JlYXRlTmV3TGVnZW5kQW5kQXR0YWNoKGNoYXJ0LCBsZWdlbmRPcHRzKSB7Cgl2YXIgbGVnZW5kID0gbmV3IExlZ2VuZCh7CgkJY3R4OiBjaGFydC5jdHgsCgkJb3B0aW9uczogbGVnZW5kT3B0cywKCQljaGFydDogY2hhcnQKCX0pOwoKCWxheW91dHMuY29uZmlndXJlKGNoYXJ0LCBsZWdlbmQsIGxlZ2VuZE9wdHMpOwoJbGF5b3V0cy5hZGRCb3goY2hhcnQsIGxlZ2VuZCk7CgljaGFydC5sZWdlbmQgPSBsZWdlbmQ7Cn0KCm1vZHVsZS5leHBvcnRzID0gewoJaWQ6ICdsZWdlbmQnLAoKCS8qKgoJICogQmFja3dhcmQgY29tcGF0aWJpbGl0eTogc2luY2UgMi4xLjUsIHRoZSBsZWdlbmQgaXMgcmVnaXN0ZXJlZCBhcyBhIHBsdWdpbiwgbWFraW5nCgkgKiBDaGFydC5MZWdlbmQgb2Jzb2xldGUuIFRvIGF2b2lkIGEgYnJlYWtpbmcgY2hhbmdlLCB3ZSBleHBvcnQgdGhlIExlZ2VuZCBhcyBwYXJ0IG9mCgkgKiB0aGUgcGx1Z2luLCB3aGljaCBvbmUgd2lsbCBiZSByZS1leHBvc2VkIGluIHRoZSBjaGFydC5qcyBmaWxlLgoJICogaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvcHVsbC8yNjQwCgkgKiBAcHJpdmF0ZQoJICovCglfZWxlbWVudDogTGVnZW5kLAoKCWJlZm9yZUluaXQ6IGZ1bmN0aW9uKGNoYXJ0KSB7CgkJdmFyIGxlZ2VuZE9wdHMgPSBjaGFydC5vcHRpb25zLmxlZ2VuZDsKCgkJaWYgKGxlZ2VuZE9wdHMpIHsKCQkJY3JlYXRlTmV3TGVnZW5kQW5kQXR0YWNoKGNoYXJ0LCBsZWdlbmRPcHRzKTsKCQl9Cgl9LAoKCWJlZm9yZVVwZGF0ZTogZnVuY3Rpb24oY2hhcnQpIHsKCQl2YXIgbGVnZW5kT3B0cyA9IGNoYXJ0Lm9wdGlvbnMubGVnZW5kOwoJCXZhciBsZWdlbmQgPSBjaGFydC5sZWdlbmQ7CgoJCWlmIChsZWdlbmRPcHRzKSB7CgkJCWhlbHBlcnMubWVyZ2VJZihsZWdlbmRPcHRzLCBkZWZhdWx0cy5nbG9iYWwubGVnZW5kKTsKCgkJCWlmIChsZWdlbmQpIHsKCQkJCWxheW91dHMuY29uZmlndXJlKGNoYXJ0LCBsZWdlbmQsIGxlZ2VuZE9wdHMpOwoJCQkJbGVnZW5kLm9wdGlvbnMgPSBsZWdlbmRPcHRzOwoJCQl9IGVsc2UgewoJCQkJY3JlYXRlTmV3TGVnZW5kQW5kQXR0YWNoKGNoYXJ0LCBsZWdlbmRPcHRzKTsKCQkJfQoJCX0gZWxzZSBpZiAobGVnZW5kKSB7CgkJCWxheW91dHMucmVtb3ZlQm94KGNoYXJ0LCBsZWdlbmQpOwoJCQlkZWxldGUgY2hhcnQubGVnZW5kOwoJCX0KCX0sCgoJYWZ0ZXJFdmVudDogZnVuY3Rpb24oY2hhcnQsIGUpIHsKCQl2YXIgbGVnZW5kID0gY2hhcnQubGVnZW5kOwoJCWlmIChsZWdlbmQpIHsKCQkJbGVnZW5kLmhhbmRsZUV2ZW50KGUpOwoJCX0KCX0KfTsKCn0seyIyNSI6MjUsIjI2IjoyNiwiMzAiOjMwLCI0NSI6NDV9XSw1MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgRWxlbWVudCA9IHJlcXVpcmUoMjYpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgbGF5b3V0cyA9IHJlcXVpcmUoMzApOwoKdmFyIG5vb3AgPSBoZWxwZXJzLm5vb3A7CgpkZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7Cgl0aXRsZTogewoJCWRpc3BsYXk6IGZhbHNlLAoJCWZvbnRTdHlsZTogJ2JvbGQnLAoJCWZ1bGxXaWR0aDogdHJ1ZSwKCQlsaW5lSGVpZ2h0OiAxLjIsCgkJcGFkZGluZzogMTAsCgkJcG9zaXRpb246ICd0b3AnLAoJCXRleHQ6ICcnLAoJCXdlaWdodDogMjAwMCAgICAgICAgIC8vIGJ5IGRlZmF1bHQgZ3JlYXRlciB0aGFuIGxlZ2VuZCAoMTAwMCkgdG8gYmUgYWJvdmUKCX0KfSk7CgovKioKICogSU1QT1JUQU5UOiB0aGlzIGNsYXNzIGlzIGV4cG9zZWQgcHVibGljbHkgYXMgQ2hhcnQuTGVnZW5kLCBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IHJlcXVpcmVkIQogKi8KdmFyIFRpdGxlID0gRWxlbWVudC5leHRlbmQoewoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oY29uZmlnKSB7CgkJdmFyIG1lID0gdGhpczsKCQloZWxwZXJzLmV4dGVuZChtZSwgY29uZmlnKTsKCgkJLy8gQ29udGFpbnMgaGl0IGJveGVzIGZvciBlYWNoIGRhdGFzZXQgKGluIGRhdGFzZXQgb3JkZXIpCgkJbWUubGVnZW5kSGl0Qm94ZXMgPSBbXTsKCX0sCgoJLy8gVGhlc2UgbWV0aG9kcyBhcmUgb3JkZXJlZCBieSBsaWZlY3ljbGUuIFV0aWxpdGllcyB0aGVuIGZvbGxvdy4KCgliZWZvcmVVcGRhdGU6IG5vb3AsCgl1cGRhdGU6IGZ1bmN0aW9uKG1heFdpZHRoLCBtYXhIZWlnaHQsIG1hcmdpbnMpIHsKCQl2YXIgbWUgPSB0aGlzOwoKCQkvLyBVcGRhdGUgTGlmZWN5Y2xlIC0gUHJvYmFibHkgZG9uJ3Qgd2FudCB0byBldmVyIGV4dGVuZCBvciBvdmVyd3JpdGUgdGhpcyBmdW5jdGlvbiA7KQoJCW1lLmJlZm9yZVVwZGF0ZSgpOwoKCQkvLyBBYnNvcmIgdGhlIG1hc3RlciBtZWFzdXJlbWVudHMKCQltZS5tYXhXaWR0aCA9IG1heFdpZHRoOwoJCW1lLm1heEhlaWdodCA9IG1heEhlaWdodDsKCQltZS5tYXJnaW5zID0gbWFyZ2luczsKCgkJLy8gRGltZW5zaW9ucwoJCW1lLmJlZm9yZVNldERpbWVuc2lvbnMoKTsKCQltZS5zZXREaW1lbnNpb25zKCk7CgkJbWUuYWZ0ZXJTZXREaW1lbnNpb25zKCk7CgkJLy8gTGFiZWxzCgkJbWUuYmVmb3JlQnVpbGRMYWJlbHMoKTsKCQltZS5idWlsZExhYmVscygpOwoJCW1lLmFmdGVyQnVpbGRMYWJlbHMoKTsKCgkJLy8gRml0CgkJbWUuYmVmb3JlRml0KCk7CgkJbWUuZml0KCk7CgkJbWUuYWZ0ZXJGaXQoKTsKCQkvLwoJCW1lLmFmdGVyVXBkYXRlKCk7CgoJCXJldHVybiBtZS5taW5TaXplOwoKCX0sCglhZnRlclVwZGF0ZTogbm9vcCwKCgkvLwoKCWJlZm9yZVNldERpbWVuc2lvbnM6IG5vb3AsCglzZXREaW1lbnNpb25zOiBmdW5jdGlvbigpIHsKCQl2YXIgbWUgPSB0aGlzOwoJCS8vIFNldCB0aGUgdW5jb25zdHJhaW5lZCBkaW1lbnNpb24gYmVmb3JlIGxhYmVsIHJvdGF0aW9uCgkJaWYgKG1lLmlzSG9yaXpvbnRhbCgpKSB7CgkJCS8vIFJlc2V0IHBvc2l0aW9uIGJlZm9yZSBjYWxjdWxhdGluZyByb3RhdGlvbgoJCQltZS53aWR0aCA9IG1lLm1heFdpZHRoOwoJCQltZS5sZWZ0ID0gMDsKCQkJbWUucmlnaHQgPSBtZS53aWR0aDsKCQl9IGVsc2UgewoJCQltZS5oZWlnaHQgPSBtZS5tYXhIZWlnaHQ7CgoJCQkvLyBSZXNldCBwb3NpdGlvbiBiZWZvcmUgY2FsY3VsYXRpbmcgcm90YXRpb24KCQkJbWUudG9wID0gMDsKCQkJbWUuYm90dG9tID0gbWUuaGVpZ2h0OwoJCX0KCgkJLy8gUmVzZXQgcGFkZGluZwoJCW1lLnBhZGRpbmdMZWZ0ID0gMDsKCQltZS5wYWRkaW5nVG9wID0gMDsKCQltZS5wYWRkaW5nUmlnaHQgPSAwOwoJCW1lLnBhZGRpbmdCb3R0b20gPSAwOwoKCQkvLyBSZXNldCBtaW5TaXplCgkJbWUubWluU2l6ZSA9IHsKCQkJd2lkdGg6IDAsCgkJCWhlaWdodDogMAoJCX07Cgl9LAoJYWZ0ZXJTZXREaW1lbnNpb25zOiBub29wLAoKCS8vCgoJYmVmb3JlQnVpbGRMYWJlbHM6IG5vb3AsCglidWlsZExhYmVsczogbm9vcCwKCWFmdGVyQnVpbGRMYWJlbHM6IG5vb3AsCgoJLy8KCgliZWZvcmVGaXQ6IG5vb3AsCglmaXQ6IGZ1bmN0aW9uKCkgewoJCXZhciBtZSA9IHRoaXM7CgkJdmFyIHZhbHVlT3JEZWZhdWx0ID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdDsKCQl2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CgkJdmFyIGRpc3BsYXkgPSBvcHRzLmRpc3BsYXk7CgkJdmFyIGZvbnRTaXplID0gdmFsdWVPckRlZmF1bHQob3B0cy5mb250U2l6ZSwgZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRGb250U2l6ZSk7CgkJdmFyIG1pblNpemUgPSBtZS5taW5TaXplOwoJCXZhciBsaW5lQ291bnQgPSBoZWxwZXJzLmlzQXJyYXkob3B0cy50ZXh0KSA/IG9wdHMudGV4dC5sZW5ndGggOiAxOwoJCXZhciBsaW5lSGVpZ2h0ID0gaGVscGVycy5vcHRpb25zLnRvTGluZUhlaWdodChvcHRzLmxpbmVIZWlnaHQsIGZvbnRTaXplKTsKCQl2YXIgdGV4dFNpemUgPSBkaXNwbGF5ID8gKGxpbmVDb3VudCAqIGxpbmVIZWlnaHQpICsgKG9wdHMucGFkZGluZyAqIDIpIDogMDsKCgkJaWYgKG1lLmlzSG9yaXpvbnRhbCgpKSB7CgkJCW1pblNpemUud2lkdGggPSBtZS5tYXhXaWR0aDsgLy8gZmlsbCBhbGwgdGhlIHdpZHRoCgkJCW1pblNpemUuaGVpZ2h0ID0gdGV4dFNpemU7CgkJfSBlbHNlIHsKCQkJbWluU2l6ZS53aWR0aCA9IHRleHRTaXplOwoJCQltaW5TaXplLmhlaWdodCA9IG1lLm1heEhlaWdodDsgLy8gZmlsbCBhbGwgdGhlIGhlaWdodAoJCX0KCgkJbWUud2lkdGggPSBtaW5TaXplLndpZHRoOwoJCW1lLmhlaWdodCA9IG1pblNpemUuaGVpZ2h0OwoKCX0sCglhZnRlckZpdDogbm9vcCwKCgkvLyBTaGFyZWQgTWV0aG9kcwoJaXNIb3Jpem9udGFsOiBmdW5jdGlvbigpIHsKCQl2YXIgcG9zID0gdGhpcy5vcHRpb25zLnBvc2l0aW9uOwoJCXJldHVybiBwb3MgPT09ICd0b3AnIHx8IHBvcyA9PT0gJ2JvdHRvbSc7Cgl9LAoKCS8vIEFjdHVhbGx5IGRyYXcgdGhlIHRpdGxlIGJsb2NrIG9uIHRoZSBjYW52YXMKCWRyYXc6IGZ1bmN0aW9uKCkgewoJCXZhciBtZSA9IHRoaXM7CgkJdmFyIGN0eCA9IG1lLmN0eDsKCQl2YXIgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoJCXZhciBvcHRzID0gbWUub3B0aW9uczsKCQl2YXIgZ2xvYmFsRGVmYXVsdHMgPSBkZWZhdWx0cy5nbG9iYWw7CgoJCWlmIChvcHRzLmRpc3BsYXkpIHsKCQkJdmFyIGZvbnRTaXplID0gdmFsdWVPckRlZmF1bHQob3B0cy5mb250U2l6ZSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRTaXplKTsKCQkJdmFyIGZvbnRTdHlsZSA9IHZhbHVlT3JEZWZhdWx0KG9wdHMuZm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFN0eWxlKTsKCQkJdmFyIGZvbnRGYW1pbHkgPSB2YWx1ZU9yRGVmYXVsdChvcHRzLmZvbnRGYW1pbHksIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250RmFtaWx5KTsKCQkJdmFyIHRpdGxlRm9udCA9IGhlbHBlcnMuZm9udFN0cmluZyhmb250U2l6ZSwgZm9udFN0eWxlLCBmb250RmFtaWx5KTsKCQkJdmFyIGxpbmVIZWlnaHQgPSBoZWxwZXJzLm9wdGlvbnMudG9MaW5lSGVpZ2h0KG9wdHMubGluZUhlaWdodCwgZm9udFNpemUpOwoJCQl2YXIgb2Zmc2V0ID0gbGluZUhlaWdodCAvIDIgKyBvcHRzLnBhZGRpbmc7CgkJCXZhciByb3RhdGlvbiA9IDA7CgkJCXZhciB0b3AgPSBtZS50b3A7CgkJCXZhciBsZWZ0ID0gbWUubGVmdDsKCQkJdmFyIGJvdHRvbSA9IG1lLmJvdHRvbTsKCQkJdmFyIHJpZ2h0ID0gbWUucmlnaHQ7CgkJCXZhciBtYXhXaWR0aCwgdGl0bGVYLCB0aXRsZVk7CgoJCQljdHguZmlsbFN0eWxlID0gdmFsdWVPckRlZmF1bHQob3B0cy5mb250Q29sb3IsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250Q29sb3IpOyAvLyByZW5kZXIgaW4gY29ycmVjdCBjb2xvdXIKCQkJY3R4LmZvbnQgPSB0aXRsZUZvbnQ7CgoJCQkvLyBIb3Jpem9udGFsCgkJCWlmIChtZS5pc0hvcml6b250YWwoKSkgewoJCQkJdGl0bGVYID0gbGVmdCArICgocmlnaHQgLSBsZWZ0KSAvIDIpOyAvLyBtaWRwb2ludCBvZiB0aGUgd2lkdGgKCQkJCXRpdGxlWSA9IHRvcCArIG9mZnNldDsKCQkJCW1heFdpZHRoID0gcmlnaHQgLSBsZWZ0OwoJCQl9IGVsc2UgewoJCQkJdGl0bGVYID0gb3B0cy5wb3NpdGlvbiA9PT0gJ2xlZnQnID8gbGVmdCArIG9mZnNldCA6IHJpZ2h0IC0gb2Zmc2V0OwoJCQkJdGl0bGVZID0gdG9wICsgKChib3R0b20gLSB0b3ApIC8gMik7CgkJCQltYXhXaWR0aCA9IGJvdHRvbSAtIHRvcDsKCQkJCXJvdGF0aW9uID0gTWF0aC5QSSAqIChvcHRzLnBvc2l0aW9uID09PSAnbGVmdCcgPyAtMC41IDogMC41KTsKCQkJfQoKCQkJY3R4LnNhdmUoKTsKCQkJY3R4LnRyYW5zbGF0ZSh0aXRsZVgsIHRpdGxlWSk7CgkJCWN0eC5yb3RhdGUocm90YXRpb24pOwoJCQljdHgudGV4dEFsaWduID0gJ2NlbnRlcic7CgkJCWN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJzsKCgkJCXZhciB0ZXh0ID0gb3B0cy50ZXh0OwoJCQlpZiAoaGVscGVycy5pc0FycmF5KHRleHQpKSB7CgkJCQl2YXIgeSA9IDA7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IHRleHQubGVuZ3RoOyArK2kpIHsKCQkJCQljdHguZmlsbFRleHQodGV4dFtpXSwgMCwgeSwgbWF4V2lkdGgpOwoJCQkJCXkgKz0gbGluZUhlaWdodDsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWN0eC5maWxsVGV4dCh0ZXh0LCAwLCAwLCBtYXhXaWR0aCk7CgkJCX0KCgkJCWN0eC5yZXN0b3JlKCk7CgkJfQoJfQp9KTsKCmZ1bmN0aW9uIGNyZWF0ZU5ld1RpdGxlQmxvY2tBbmRBdHRhY2goY2hhcnQsIHRpdGxlT3B0cykgewoJdmFyIHRpdGxlID0gbmV3IFRpdGxlKHsKCQljdHg6IGNoYXJ0LmN0eCwKCQlvcHRpb25zOiB0aXRsZU9wdHMsCgkJY2hhcnQ6IGNoYXJ0Cgl9KTsKCglsYXlvdXRzLmNvbmZpZ3VyZShjaGFydCwgdGl0bGUsIHRpdGxlT3B0cyk7CglsYXlvdXRzLmFkZEJveChjaGFydCwgdGl0bGUpOwoJY2hhcnQudGl0bGVCbG9jayA9IHRpdGxlOwp9Cgptb2R1bGUuZXhwb3J0cyA9IHsKCWlkOiAndGl0bGUnLAoKCS8qKgoJICogQmFja3dhcmQgY29tcGF0aWJpbGl0eTogc2luY2UgMi4xLjUsIHRoZSB0aXRsZSBpcyByZWdpc3RlcmVkIGFzIGEgcGx1Z2luLCBtYWtpbmcKCSAqIENoYXJ0LlRpdGxlIG9ic29sZXRlLiBUbyBhdm9pZCBhIGJyZWFraW5nIGNoYW5nZSwgd2UgZXhwb3J0IHRoZSBUaXRsZSBhcyBwYXJ0IG9mCgkgKiB0aGUgcGx1Z2luLCB3aGljaCBvbmUgd2lsbCBiZSByZS1leHBvc2VkIGluIHRoZSBjaGFydC5qcyBmaWxlLgoJICogaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvcHVsbC8yNjQwCgkgKiBAcHJpdmF0ZQoJICovCglfZWxlbWVudDogVGl0bGUsCgoJYmVmb3JlSW5pdDogZnVuY3Rpb24oY2hhcnQpIHsKCQl2YXIgdGl0bGVPcHRzID0gY2hhcnQub3B0aW9ucy50aXRsZTsKCgkJaWYgKHRpdGxlT3B0cykgewoJCQljcmVhdGVOZXdUaXRsZUJsb2NrQW5kQXR0YWNoKGNoYXJ0LCB0aXRsZU9wdHMpOwoJCX0KCX0sCgoJYmVmb3JlVXBkYXRlOiBmdW5jdGlvbihjaGFydCkgewoJCXZhciB0aXRsZU9wdHMgPSBjaGFydC5vcHRpb25zLnRpdGxlOwoJCXZhciB0aXRsZUJsb2NrID0gY2hhcnQudGl0bGVCbG9jazsKCgkJaWYgKHRpdGxlT3B0cykgewoJCQloZWxwZXJzLm1lcmdlSWYodGl0bGVPcHRzLCBkZWZhdWx0cy5nbG9iYWwudGl0bGUpOwoKCQkJaWYgKHRpdGxlQmxvY2spIHsKCQkJCWxheW91dHMuY29uZmlndXJlKGNoYXJ0LCB0aXRsZUJsb2NrLCB0aXRsZU9wdHMpOwoJCQkJdGl0bGVCbG9jay5vcHRpb25zID0gdGl0bGVPcHRzOwoJCQl9IGVsc2UgewoJCQkJY3JlYXRlTmV3VGl0bGVCbG9ja0FuZEF0dGFjaChjaGFydCwgdGl0bGVPcHRzKTsKCQkJfQoJCX0gZWxzZSBpZiAodGl0bGVCbG9jaykgewoJCQlsYXlvdXRzLnJlbW92ZUJveChjaGFydCwgdGl0bGVCbG9jayk7CgkJCWRlbGV0ZSBjaGFydC50aXRsZUJsb2NrOwoJCX0KCX0KfTsKCn0seyIyNSI6MjUsIjI2IjoyNiwiMzAiOjMwLCI0NSI6NDV9XSw1MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCgkvLyBEZWZhdWx0IGNvbmZpZyBmb3IgYSBjYXRlZ29yeSBzY2FsZQoJdmFyIGRlZmF1bHRDb25maWcgPSB7CgkJcG9zaXRpb246ICdib3R0b20nCgl9OwoKCXZhciBEYXRhc2V0U2NhbGUgPSBDaGFydC5TY2FsZS5leHRlbmQoewoJCS8qKgoJCSogSW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2V0IHRoZSBjb3JyZWN0IGxhYmVscy4gSWYgZGF0YS54TGFiZWxzIG9yIGRhdGEueUxhYmVscyBhcmUgZGVmaW5lZCwgdXNlIHRob3NlCgkJKiBlbHNlIGZhbGwgYmFjayB0byBkYXRhLmxhYmVscwoJCSogQHByaXZhdGUKCQkqLwoJCWdldExhYmVsczogZnVuY3Rpb24oKSB7CgkJCXZhciBkYXRhID0gdGhpcy5jaGFydC5kYXRhOwoJCQlyZXR1cm4gdGhpcy5vcHRpb25zLmxhYmVscyB8fCAodGhpcy5pc0hvcml6b250YWwoKSA/IGRhdGEueExhYmVscyA6IGRhdGEueUxhYmVscykgfHwgZGF0YS5sYWJlbHM7CgkJfSwKCgkJZGV0ZXJtaW5lRGF0YUxpbWl0czogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBsYWJlbHMgPSBtZS5nZXRMYWJlbHMoKTsKCQkJbWUubWluSW5kZXggPSAwOwoJCQltZS5tYXhJbmRleCA9IGxhYmVscy5sZW5ndGggLSAxOwoJCQl2YXIgZmluZEluZGV4OwoKCQkJaWYgKG1lLm9wdGlvbnMudGlja3MubWluICE9PSB1bmRlZmluZWQpIHsKCQkJCS8vIHVzZXIgc3BlY2lmaWVkIG1pbiB2YWx1ZQoJCQkJZmluZEluZGV4ID0gbGFiZWxzLmluZGV4T2YobWUub3B0aW9ucy50aWNrcy5taW4pOwoJCQkJbWUubWluSW5kZXggPSBmaW5kSW5kZXggIT09IC0xID8gZmluZEluZGV4IDogbWUubWluSW5kZXg7CgkJCX0KCgkJCWlmIChtZS5vcHRpb25zLnRpY2tzLm1heCAhPT0gdW5kZWZpbmVkKSB7CgkJCQkvLyB1c2VyIHNwZWNpZmllZCBtYXggdmFsdWUKCQkJCWZpbmRJbmRleCA9IGxhYmVscy5pbmRleE9mKG1lLm9wdGlvbnMudGlja3MubWF4KTsKCQkJCW1lLm1heEluZGV4ID0gZmluZEluZGV4ICE9PSAtMSA/IGZpbmRJbmRleCA6IG1lLm1heEluZGV4OwoJCQl9CgoJCQltZS5taW4gPSBsYWJlbHNbbWUubWluSW5kZXhdOwoJCQltZS5tYXggPSBsYWJlbHNbbWUubWF4SW5kZXhdOwoJCX0sCgoJCWJ1aWxkVGlja3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbGFiZWxzID0gbWUuZ2V0TGFiZWxzKCk7CgkJCS8vIElmIHdlIGFyZSB2aWV3aW5nIHNvbWUgc3Vic2V0IG9mIGxhYmVscywgc2xpY2UgdGhlIG9yaWdpbmFsIGFycmF5CgkJCW1lLnRpY2tzID0gKG1lLm1pbkluZGV4ID09PSAwICYmIG1lLm1heEluZGV4ID09PSBsYWJlbHMubGVuZ3RoIC0gMSkgPyBsYWJlbHMgOiBsYWJlbHMuc2xpY2UobWUubWluSW5kZXgsIG1lLm1heEluZGV4ICsgMSk7CgkJfSwKCgkJZ2V0TGFiZWxGb3JJbmRleDogZnVuY3Rpb24oaW5kZXgsIGRhdGFzZXRJbmRleCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgZGF0YSA9IG1lLmNoYXJ0LmRhdGE7CgkJCXZhciBpc0hvcml6b250YWwgPSBtZS5pc0hvcml6b250YWwoKTsKCgkJCWlmIChkYXRhLnlMYWJlbHMgJiYgIWlzSG9yaXpvbnRhbCkgewoJCQkJcmV0dXJuIG1lLmdldFJpZ2h0VmFsdWUoZGF0YS5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLmRhdGFbaW5kZXhdKTsKCQkJfQoJCQlyZXR1cm4gbWUudGlja3NbaW5kZXggLSBtZS5taW5JbmRleF07CgkJfSwKCgkJLy8gVXNlZCB0byBnZXQgZGF0YSB2YWx1ZSBsb2NhdGlvbnMuICBWYWx1ZSBjYW4gZWl0aGVyIGJlIGFuIGluZGV4IG9yIGEgbnVtZXJpY2FsIHZhbHVlCgkJZ2V0UGl4ZWxGb3JWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBvZmZzZXQgPSBtZS5vcHRpb25zLm9mZnNldDsKCQkJLy8gMSBpcyBhZGRlZCBiZWNhdXNlIHdlIG5lZWQgdGhlIGxlbmd0aCBidXQgd2UgaGF2ZSB0aGUgaW5kZXhlcwoJCQl2YXIgb2Zmc2V0QW10ID0gTWF0aC5tYXgoKG1lLm1heEluZGV4ICsgMSAtIG1lLm1pbkluZGV4IC0gKG9mZnNldCA/IDAgOiAxKSksIDEpOwoKCQkJLy8gSWYgdmFsdWUgaXMgYSBkYXRhIG9iamVjdCwgdGhlbiBpbmRleCBpcyB0aGUgaW5kZXggaW4gdGhlIGRhdGEgYXJyYXksCgkJCS8vIG5vdCB0aGUgaW5kZXggb2YgdGhlIHNjYWxlLiBXZSBuZWVkIHRvIGNoYW5nZSB0aGF0LgoJCQl2YXIgdmFsdWVDYXRlZ29yeTsKCQkJaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHsKCQkJCXZhbHVlQ2F0ZWdvcnkgPSBtZS5pc0hvcml6b250YWwoKSA/IHZhbHVlLnggOiB2YWx1ZS55OwoJCQl9CgkJCWlmICh2YWx1ZUNhdGVnb3J5ICE9PSB1bmRlZmluZWQgfHwgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgaXNOYU4oaW5kZXgpKSkgewoJCQkJdmFyIGxhYmVscyA9IG1lLmdldExhYmVscygpOwoJCQkJdmFsdWUgPSB2YWx1ZUNhdGVnb3J5IHx8IHZhbHVlOwoJCQkJdmFyIGlkeCA9IGxhYmVscy5pbmRleE9mKHZhbHVlKTsKCQkJCWluZGV4ID0gaWR4ICE9PSAtMSA/IGlkeCA6IGluZGV4OwoJCQl9CgoJCQlpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKCQkJCXZhciB2YWx1ZVdpZHRoID0gbWUud2lkdGggLyBvZmZzZXRBbXQ7CgkJCQl2YXIgd2lkdGhPZmZzZXQgPSAodmFsdWVXaWR0aCAqIChpbmRleCAtIG1lLm1pbkluZGV4KSk7CgoJCQkJaWYgKG9mZnNldCkgewoJCQkJCXdpZHRoT2Zmc2V0ICs9ICh2YWx1ZVdpZHRoIC8gMik7CgkJCQl9CgoJCQkJcmV0dXJuIG1lLmxlZnQgKyBNYXRoLnJvdW5kKHdpZHRoT2Zmc2V0KTsKCQkJfQoJCQl2YXIgdmFsdWVIZWlnaHQgPSBtZS5oZWlnaHQgLyBvZmZzZXRBbXQ7CgkJCXZhciBoZWlnaHRPZmZzZXQgPSAodmFsdWVIZWlnaHQgKiAoaW5kZXggLSBtZS5taW5JbmRleCkpOwoKCQkJaWYgKG9mZnNldCkgewoJCQkJaGVpZ2h0T2Zmc2V0ICs9ICh2YWx1ZUhlaWdodCAvIDIpOwoJCQl9CgoJCQlyZXR1cm4gbWUudG9wICsgTWF0aC5yb3VuZChoZWlnaHRPZmZzZXQpOwoJCX0sCgkJZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbihpbmRleCkgewoJCQlyZXR1cm4gdGhpcy5nZXRQaXhlbEZvclZhbHVlKHRoaXMudGlja3NbaW5kZXhdLCBpbmRleCArIHRoaXMubWluSW5kZXgsIG51bGwpOwoJCX0sCgkJZ2V0VmFsdWVGb3JQaXhlbDogZnVuY3Rpb24ocGl4ZWwpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9mZnNldCA9IG1lLm9wdGlvbnMub2Zmc2V0OwoJCQl2YXIgdmFsdWU7CgkJCXZhciBvZmZzZXRBbXQgPSBNYXRoLm1heCgobWUuX3RpY2tzLmxlbmd0aCAtIChvZmZzZXQgPyAwIDogMSkpLCAxKTsKCQkJdmFyIGhvcnogPSBtZS5pc0hvcml6b250YWwoKTsKCQkJdmFyIHZhbHVlRGltZW5zaW9uID0gKGhvcnogPyBtZS53aWR0aCA6IG1lLmhlaWdodCkgLyBvZmZzZXRBbXQ7CgoJCQlwaXhlbCAtPSBob3J6ID8gbWUubGVmdCA6IG1lLnRvcDsKCgkJCWlmIChvZmZzZXQpIHsKCQkJCXBpeGVsIC09ICh2YWx1ZURpbWVuc2lvbiAvIDIpOwoJCQl9CgoJCQlpZiAocGl4ZWwgPD0gMCkgewoJCQkJdmFsdWUgPSAwOwoJCQl9IGVsc2UgewoJCQkJdmFsdWUgPSBNYXRoLnJvdW5kKHBpeGVsIC8gdmFsdWVEaW1lbnNpb24pOwoJCQl9CgoJCQlyZXR1cm4gdmFsdWUgKyBtZS5taW5JbmRleDsKCQl9LAoJCWdldEJhc2VQaXhlbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmJvdHRvbTsKCQl9Cgl9KTsKCglDaGFydC5zY2FsZVNlcnZpY2UucmVnaXN0ZXJTY2FsZVR5cGUoJ2NhdGVnb3J5JywgRGF0YXNldFNjYWxlLCBkZWZhdWx0Q29uZmlnKTsKCn07Cgp9LHt9XSw1NDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBkZWZhdWx0cyA9IHJlcXVpcmUoMjUpOwp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgVGlja3MgPSByZXF1aXJlKDM0KTsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oQ2hhcnQpIHsKCgl2YXIgZGVmYXVsdENvbmZpZyA9IHsKCQlwb3NpdGlvbjogJ2xlZnQnLAoJCXRpY2tzOiB7CgkJCWNhbGxiYWNrOiBUaWNrcy5mb3JtYXR0ZXJzLmxpbmVhcgoJCX0KCX07CgoJdmFyIExpbmVhclNjYWxlID0gQ2hhcnQuTGluZWFyU2NhbGVCYXNlLmV4dGVuZCh7CgoJCWRldGVybWluZURhdGFMaW1pdHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CgkJCXZhciBjaGFydCA9IG1lLmNoYXJ0OwoJCQl2YXIgZGF0YSA9IGNoYXJ0LmRhdGE7CgkJCXZhciBkYXRhc2V0cyA9IGRhdGEuZGF0YXNldHM7CgkJCXZhciBpc0hvcml6b250YWwgPSBtZS5pc0hvcml6b250YWwoKTsKCQkJdmFyIERFRkFVTFRfTUlOID0gMDsKCQkJdmFyIERFRkFVTFRfTUFYID0gMTsKCgkJCWZ1bmN0aW9uIElETWF0Y2hlcyhtZXRhKSB7CgkJCQlyZXR1cm4gaXNIb3Jpem9udGFsID8gbWV0YS54QXhpc0lEID09PSBtZS5pZCA6IG1ldGEueUF4aXNJRCA9PT0gbWUuaWQ7CgkJCX0KCgkJCS8vIEZpcnN0IENhbGN1bGF0ZSB0aGUgcmFuZ2UKCQkJbWUubWluID0gbnVsbDsKCQkJbWUubWF4ID0gbnVsbDsKCgkJCXZhciBoYXNTdGFja3MgPSBvcHRzLnN0YWNrZWQ7CgkJCWlmIChoYXNTdGFja3MgPT09IHVuZGVmaW5lZCkgewoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXRzLCBmdW5jdGlvbihkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHsKCQkJCQlpZiAoaGFzU3RhY2tzKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXZhciBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsKCQkJCQlpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShkYXRhc2V0SW5kZXgpICYmIElETWF0Y2hlcyhtZXRhKSAmJgoJCQkJCQltZXRhLnN0YWNrICE9PSB1bmRlZmluZWQpIHsKCQkJCQkJaGFzU3RhY2tzID0gdHJ1ZTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJaWYgKG9wdHMuc3RhY2tlZCB8fCBoYXNTdGFja3MpIHsKCQkJCXZhciB2YWx1ZXNQZXJTdGFjayA9IHt9OwoKCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7CgkJCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoJCQkJCXZhciBrZXkgPSBbCgkJCQkJCW1ldGEudHlwZSwKCQkJCQkJLy8gd2UgaGF2ZSBhIHNlcGFyYXRlIHN0YWNrIGZvciBzdGFjaz11bmRlZmluZWQgZGF0YXNldHMgd2hlbiB0aGUgb3B0cy5zdGFja2VkIGlzIHVuZGVmaW5lZAoJCQkJCQkoKG9wdHMuc3RhY2tlZCA9PT0gdW5kZWZpbmVkICYmIG1ldGEuc3RhY2sgPT09IHVuZGVmaW5lZCkgPyBkYXRhc2V0SW5kZXggOiAnJyksCgkJCQkJCW1ldGEuc3RhY2sKCQkJCQldLmpvaW4oJy4nKTsKCgkJCQkJaWYgKHZhbHVlc1BlclN0YWNrW2tleV0gPT09IHVuZGVmaW5lZCkgewoJCQkJCQl2YWx1ZXNQZXJTdGFja1trZXldID0gewoJCQkJCQkJcG9zaXRpdmVWYWx1ZXM6IFtdLAoJCQkJCQkJbmVnYXRpdmVWYWx1ZXM6IFtdCgkJCQkJCX07CgkJCQkJfQoKCQkJCQkvLyBTdG9yZSB0aGVzZSBwZXIgdHlwZQoJCQkJCXZhciBwb3NpdGl2ZVZhbHVlcyA9IHZhbHVlc1BlclN0YWNrW2tleV0ucG9zaXRpdmVWYWx1ZXM7CgkJCQkJdmFyIG5lZ2F0aXZlVmFsdWVzID0gdmFsdWVzUGVyU3RhY2tba2V5XS5uZWdhdGl2ZVZhbHVlczsKCgkJCQkJaWYgKGNoYXJ0LmlzRGF0YXNldFZpc2libGUoZGF0YXNldEluZGV4KSAmJiBJRE1hdGNoZXMobWV0YSkpIHsKCQkJCQkJaGVscGVycy5lYWNoKGRhdGFzZXQuZGF0YSwgZnVuY3Rpb24ocmF3VmFsdWUsIGluZGV4KSB7CgkJCQkJCQl2YXIgdmFsdWUgPSArbWUuZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZSk7CgkJCQkJCQlpZiAoaXNOYU4odmFsdWUpIHx8IG1ldGEuZGF0YVtpbmRleF0uaGlkZGVuKSB7CgkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJfQoKCQkJCQkJCXBvc2l0aXZlVmFsdWVzW2luZGV4XSA9IHBvc2l0aXZlVmFsdWVzW2luZGV4XSB8fCAwOwoJCQkJCQkJbmVnYXRpdmVWYWx1ZXNbaW5kZXhdID0gbmVnYXRpdmVWYWx1ZXNbaW5kZXhdIHx8IDA7CgoJCQkJCQkJaWYgKG9wdHMucmVsYXRpdmVQb2ludHMpIHsKCQkJCQkJCQlwb3NpdGl2ZVZhbHVlc1tpbmRleF0gPSAxMDA7CgkJCQkJCQl9IGVsc2UgaWYgKHZhbHVlIDwgMCkgewoJCQkJCQkJCW5lZ2F0aXZlVmFsdWVzW2luZGV4XSArPSB2YWx1ZTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcG9zaXRpdmVWYWx1ZXNbaW5kZXhdICs9IHZhbHVlOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCgkJCQloZWxwZXJzLmVhY2godmFsdWVzUGVyU3RhY2ssIGZ1bmN0aW9uKHZhbHVlc0ZvclR5cGUpIHsKCQkJCQl2YXIgdmFsdWVzID0gdmFsdWVzRm9yVHlwZS5wb3NpdGl2ZVZhbHVlcy5jb25jYXQodmFsdWVzRm9yVHlwZS5uZWdhdGl2ZVZhbHVlcyk7CgkJCQkJdmFyIG1pblZhbCA9IGhlbHBlcnMubWluKHZhbHVlcyk7CgkJCQkJdmFyIG1heFZhbCA9IGhlbHBlcnMubWF4KHZhbHVlcyk7CgkJCQkJbWUubWluID0gbWUubWluID09PSBudWxsID8gbWluVmFsIDogTWF0aC5taW4obWUubWluLCBtaW5WYWwpOwoJCQkJCW1lLm1heCA9IG1lLm1heCA9PT0gbnVsbCA/IG1heFZhbCA6IE1hdGgubWF4KG1lLm1heCwgbWF4VmFsKTsKCQkJCX0pOwoKCQkJfSBlbHNlIHsKCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7CgkJCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoJCQkJCWlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgJiYgSURNYXRjaGVzKG1ldGEpKSB7CgkJCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0LmRhdGEsIGZ1bmN0aW9uKHJhd1ZhbHVlLCBpbmRleCkgewoJCQkJCQkJdmFyIHZhbHVlID0gK21lLmdldFJpZ2h0VmFsdWUocmF3VmFsdWUpOwoJCQkJCQkJaWYgKGlzTmFOKHZhbHVlKSB8fCBtZXRhLmRhdGFbaW5kZXhdLmhpZGRlbikgewoJCQkJCQkJCXJldHVybjsKCQkJCQkJCX0KCgkJCQkJCQlpZiAobWUubWluID09PSBudWxsKSB7CgkJCQkJCQkJbWUubWluID0gdmFsdWU7CgkJCQkJCQl9IGVsc2UgaWYgKHZhbHVlIDwgbWUubWluKSB7CgkJCQkJCQkJbWUubWluID0gdmFsdWU7CgkJCQkJCQl9CgoJCQkJCQkJaWYgKG1lLm1heCA9PT0gbnVsbCkgewoJCQkJCQkJCW1lLm1heCA9IHZhbHVlOwoJCQkJCQkJfSBlbHNlIGlmICh2YWx1ZSA+IG1lLm1heCkgewoJCQkJCQkJCW1lLm1heCA9IHZhbHVlOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJbWUubWluID0gaXNGaW5pdGUobWUubWluKSAmJiAhaXNOYU4obWUubWluKSA/IG1lLm1pbiA6IERFRkFVTFRfTUlOOwoJCQltZS5tYXggPSBpc0Zpbml0ZShtZS5tYXgpICYmICFpc05hTihtZS5tYXgpID8gbWUubWF4IDogREVGQVVMVF9NQVg7CgoJCQkvLyBDb21tb24gYmFzZSBpbXBsZW1lbnRhdGlvbiB0byBoYW5kbGUgdGlja3MubWluLCB0aWNrcy5tYXgsIHRpY2tzLmJlZ2luQXRaZXJvCgkJCXRoaXMuaGFuZGxlVGlja1JhbmdlT3B0aW9ucygpOwoJCX0sCgkJZ2V0VGlja0xpbWl0OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1heFRpY2tzOwoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgdGlja09wdHMgPSBtZS5vcHRpb25zLnRpY2tzOwoKCQkJaWYgKG1lLmlzSG9yaXpvbnRhbCgpKSB7CgkJCQltYXhUaWNrcyA9IE1hdGgubWluKHRpY2tPcHRzLm1heFRpY2tzTGltaXQgPyB0aWNrT3B0cy5tYXhUaWNrc0xpbWl0IDogMTEsIE1hdGguY2VpbChtZS53aWR0aCAvIDUwKSk7CgkJCX0gZWxzZSB7CgkJCQkvLyBUaGUgZmFjdG9yIG9mIDIgdXNlZCB0byBzY2FsZSB0aGUgZm9udCBzaXplIGhhcyBiZWVuIGV4cGVyaW1lbnRhbGx5IGRldGVybWluZWQuCgkJCQl2YXIgdGlja0ZvbnRTaXplID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdCh0aWNrT3B0cy5mb250U2l6ZSwgZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRGb250U2l6ZSk7CgkJCQltYXhUaWNrcyA9IE1hdGgubWluKHRpY2tPcHRzLm1heFRpY2tzTGltaXQgPyB0aWNrT3B0cy5tYXhUaWNrc0xpbWl0IDogMTEsIE1hdGguY2VpbChtZS5oZWlnaHQgLyAoMiAqIHRpY2tGb250U2l6ZSkpKTsKCQkJfQoKCQkJcmV0dXJuIG1heFRpY2tzOwoJCX0sCgkJLy8gQ2FsbGVkIGFmdGVyIHRoZSB0aWNrcyBhcmUgYnVpbHQuIFdlIG5lZWQKCQloYW5kbGVEaXJlY3Rpb25hbENoYW5nZXM6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIXRoaXMuaXNIb3Jpem9udGFsKCkpIHsKCQkJCS8vIFdlIGFyZSBpbiBhIHZlcnRpY2FsIG9yaWVudGF0aW9uLiBUaGUgdG9wIHZhbHVlIGlzIHRoZSBoaWdoZXN0LiBTbyByZXZlcnNlIHRoZSBhcnJheQoJCQkJdGhpcy50aWNrcy5yZXZlcnNlKCk7CgkJCX0KCQl9LAoJCWdldExhYmVsRm9ySW5kZXg6IGZ1bmN0aW9uKGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKCQkJcmV0dXJuICt0aGlzLmdldFJpZ2h0VmFsdWUodGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uZGF0YVtpbmRleF0pOwoJCX0sCgkJLy8gVXRpbHMKCQlnZXRQaXhlbEZvclZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewoJCQkvLyBUaGlzIG11c3QgYmUgY2FsbGVkIGFmdGVyIGZpdCBoYXMgYmVlbiBydW4gc28gdGhhdAoJCQkvLyB0aGlzLmxlZnQsIHRoaXMudG9wLCB0aGlzLnJpZ2h0LCBhbmQgdGhpcy5ib3R0b20gaGF2ZSBiZWVuIGRlZmluZWQKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIHN0YXJ0ID0gbWUuc3RhcnQ7CgoJCQl2YXIgcmlnaHRWYWx1ZSA9ICttZS5nZXRSaWdodFZhbHVlKHZhbHVlKTsKCQkJdmFyIHBpeGVsOwoJCQl2YXIgcmFuZ2UgPSBtZS5lbmQgLSBzdGFydDsKCgkJCWlmIChtZS5pc0hvcml6b250YWwoKSkgewoJCQkJcGl4ZWwgPSBtZS5sZWZ0ICsgKG1lLndpZHRoIC8gcmFuZ2UgKiAocmlnaHRWYWx1ZSAtIHN0YXJ0KSk7CgkJCX0gZWxzZSB7CgkJCQlwaXhlbCA9IG1lLmJvdHRvbSAtIChtZS5oZWlnaHQgLyByYW5nZSAqIChyaWdodFZhbHVlIC0gc3RhcnQpKTsKCQkJfQoJCQlyZXR1cm4gcGl4ZWw7CgkJfSwKCQlnZXRWYWx1ZUZvclBpeGVsOiBmdW5jdGlvbihwaXhlbCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgkJCXZhciBpbm5lckRpbWVuc2lvbiA9IGlzSG9yaXpvbnRhbCA/IG1lLndpZHRoIDogbWUuaGVpZ2h0OwoJCQl2YXIgb2Zmc2V0ID0gKGlzSG9yaXpvbnRhbCA/IHBpeGVsIC0gbWUubGVmdCA6IG1lLmJvdHRvbSAtIHBpeGVsKSAvIGlubmVyRGltZW5zaW9uOwoJCQlyZXR1cm4gbWUuc3RhcnQgKyAoKG1lLmVuZCAtIG1lLnN0YXJ0KSAqIG9mZnNldCk7CgkJfSwKCQlnZXRQaXhlbEZvclRpY2s6IGZ1bmN0aW9uKGluZGV4KSB7CgkJCXJldHVybiB0aGlzLmdldFBpeGVsRm9yVmFsdWUodGhpcy50aWNrc0FzTnVtYmVyc1tpbmRleF0pOwoJCX0KCX0pOwoJQ2hhcnQuc2NhbGVTZXJ2aWNlLnJlZ2lzdGVyU2NhbGVUeXBlKCdsaW5lYXInLCBMaW5lYXJTY2FsZSwgZGVmYXVsdENvbmZpZyk7Cgp9OwoKfSx7IjI1IjoyNSwiMzQiOjM0LCI0NSI6NDV9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7CgovKioKICogR2VuZXJhdGUgYSBzZXQgb2YgbGluZWFyIHRpY2tzCiAqIEBwYXJhbSBnZW5lcmF0aW9uT3B0aW9ucyB0aGUgb3B0aW9ucyB1c2VkIHRvIGdlbmVyYXRlIHRoZSB0aWNrcwogKiBAcGFyYW0gZGF0YVJhbmdlIHRoZSByYW5nZSBvZiB0aGUgZGF0YQogKiBAcmV0dXJucyB7QXJyYXk8TnVtYmVyPn0gYXJyYXkgb2YgdGljayB2YWx1ZXMKICovCmZ1bmN0aW9uIGdlbmVyYXRlVGlja3MoZ2VuZXJhdGlvbk9wdGlvbnMsIGRhdGFSYW5nZSkgewoJdmFyIHRpY2tzID0gW107CgkvLyBUbyBnZXQgYSAibmljZSIgdmFsdWUgZm9yIHRoZSB0aWNrIHNwYWNpbmcsIHdlIHdpbGwgdXNlIHRoZSBhcHByb3ByaWF0ZWx5IG5hbWVkCgkvLyAibmljZSBudW1iZXIiIGFsZ29yaXRobS4gU2VlIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvODUwNjg4MS9uaWNlLWxhYmVsLWFsZ29yaXRobS1mb3ItY2hhcnRzLXdpdGgtbWluaW11bS10aWNrcwoJLy8gZm9yIGRldGFpbHMuCgoJdmFyIHNwYWNpbmc7CglpZiAoZ2VuZXJhdGlvbk9wdGlvbnMuc3RlcFNpemUgJiYgZ2VuZXJhdGlvbk9wdGlvbnMuc3RlcFNpemUgPiAwKSB7CgkJc3BhY2luZyA9IGdlbmVyYXRpb25PcHRpb25zLnN0ZXBTaXplOwoJfSBlbHNlIHsKCQl2YXIgbmljZVJhbmdlID0gaGVscGVycy5uaWNlTnVtKGRhdGFSYW5nZS5tYXggLSBkYXRhUmFuZ2UubWluLCBmYWxzZSk7CgkJc3BhY2luZyA9IGhlbHBlcnMubmljZU51bShuaWNlUmFuZ2UgLyAoZ2VuZXJhdGlvbk9wdGlvbnMubWF4VGlja3MgLSAxKSwgdHJ1ZSk7Cgl9Cgl2YXIgbmljZU1pbiA9IE1hdGguZmxvb3IoZGF0YVJhbmdlLm1pbiAvIHNwYWNpbmcpICogc3BhY2luZzsKCXZhciBuaWNlTWF4ID0gTWF0aC5jZWlsKGRhdGFSYW5nZS5tYXggLyBzcGFjaW5nKSAqIHNwYWNpbmc7CgoJLy8gSWYgbWluLCBtYXggYW5kIHN0ZXBTaXplIGlzIHNldCBhbmQgdGhleSBtYWtlIGFuIGV2ZW5seSBzcGFjZWQgc2NhbGUgdXNlIGl0LgoJaWYgKGdlbmVyYXRpb25PcHRpb25zLm1pbiAmJiBnZW5lcmF0aW9uT3B0aW9ucy5tYXggJiYgZ2VuZXJhdGlvbk9wdGlvbnMuc3RlcFNpemUpIHsKCQkvLyBJZiB2ZXJ5IGNsb3NlIHRvIG91ciB3aG9sZSBudW1iZXIsIHVzZSBpdC4KCQlpZiAoaGVscGVycy5hbG1vc3RXaG9sZSgoZ2VuZXJhdGlvbk9wdGlvbnMubWF4IC0gZ2VuZXJhdGlvbk9wdGlvbnMubWluKSAvIGdlbmVyYXRpb25PcHRpb25zLnN0ZXBTaXplLCBzcGFjaW5nIC8gMTAwMCkpIHsKCQkJbmljZU1pbiA9IGdlbmVyYXRpb25PcHRpb25zLm1pbjsKCQkJbmljZU1heCA9IGdlbmVyYXRpb25PcHRpb25zLm1heDsKCQl9Cgl9CgoJdmFyIG51bVNwYWNlcyA9IChuaWNlTWF4IC0gbmljZU1pbikgLyBzcGFjaW5nOwoJLy8gSWYgdmVyeSBjbG9zZSB0byBvdXIgcm91bmRlZCB2YWx1ZSwgdXNlIGl0LgoJaWYgKGhlbHBlcnMuYWxtb3N0RXF1YWxzKG51bVNwYWNlcywgTWF0aC5yb3VuZChudW1TcGFjZXMpLCBzcGFjaW5nIC8gMTAwMCkpIHsKCQludW1TcGFjZXMgPSBNYXRoLnJvdW5kKG51bVNwYWNlcyk7Cgl9IGVsc2UgewoJCW51bVNwYWNlcyA9IE1hdGguY2VpbChudW1TcGFjZXMpOwoJfQoKCXZhciBwcmVjaXNpb24gPSAxOwoJaWYgKHNwYWNpbmcgPCAxKSB7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHNwYWNpbmcudG9TdHJpbmcoKS5sZW5ndGggLSAyKTsKCQluaWNlTWluID0gTWF0aC5yb3VuZChuaWNlTWluICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCQluaWNlTWF4ID0gTWF0aC5yb3VuZChuaWNlTWF4ICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0KCXRpY2tzLnB1c2goZ2VuZXJhdGlvbk9wdGlvbnMubWluICE9PSB1bmRlZmluZWQgPyBnZW5lcmF0aW9uT3B0aW9ucy5taW4gOiBuaWNlTWluKTsKCWZvciAodmFyIGogPSAxOyBqIDwgbnVtU3BhY2VzOyArK2opIHsKCQl0aWNrcy5wdXNoKE1hdGgucm91bmQoKG5pY2VNaW4gKyBqICogc3BhY2luZykgKiBwcmVjaXNpb24pIC8gcHJlY2lzaW9uKTsKCX0KCXRpY2tzLnB1c2goZ2VuZXJhdGlvbk9wdGlvbnMubWF4ICE9PSB1bmRlZmluZWQgPyBnZW5lcmF0aW9uT3B0aW9ucy5tYXggOiBuaWNlTWF4KTsKCglyZXR1cm4gdGlja3M7Cn0KCgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7CgoJdmFyIG5vb3AgPSBoZWxwZXJzLm5vb3A7CgoJQ2hhcnQuTGluZWFyU2NhbGVCYXNlID0gQ2hhcnQuU2NhbGUuZXh0ZW5kKHsKCQlnZXRSaWdodFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewoJCQlpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewoJCQkJcmV0dXJuICt2YWx1ZTsKCQkJfQoJCQlyZXR1cm4gQ2hhcnQuU2NhbGUucHJvdG90eXBlLmdldFJpZ2h0VmFsdWUuY2FsbCh0aGlzLCB2YWx1ZSk7CgkJfSwKCgkJaGFuZGxlVGlja1JhbmdlT3B0aW9uczogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBvcHRzID0gbWUub3B0aW9uczsKCQkJdmFyIHRpY2tPcHRzID0gb3B0cy50aWNrczsKCgkJCS8vIElmIHdlIGFyZSBmb3JjaW5nIGl0IHRvIGJlZ2luIGF0IDAsIGJ1dCAwIHdpbGwgYWxyZWFkeSBiZSByZW5kZXJlZCBvbiB0aGUgY2hhcnQsCgkJCS8vIGRvIG5vdGhpbmcgc2luY2UgdGhhdCB3b3VsZCBtYWtlIHRoZSBjaGFydCB3ZWlyZC4gSWYgdGhlIHVzZXIgcmVhbGx5IHdhbnRzIGEgd2VpcmQgY2hhcnQKCQkJLy8gYXhpcywgdGhleSBjYW4gbWFudWFsbHkgb3ZlcnJpZGUgaXQKCQkJaWYgKHRpY2tPcHRzLmJlZ2luQXRaZXJvKSB7CgkJCQl2YXIgbWluU2lnbiA9IGhlbHBlcnMuc2lnbihtZS5taW4pOwoJCQkJdmFyIG1heFNpZ24gPSBoZWxwZXJzLnNpZ24obWUubWF4KTsKCgkJCQlpZiAobWluU2lnbiA8IDAgJiYgbWF4U2lnbiA8IDApIHsKCQkJCQkvLyBtb3ZlIHRoZSB0b3AgdXAgdG8gMAoJCQkJCW1lLm1heCA9IDA7CgkJCQl9IGVsc2UgaWYgKG1pblNpZ24gPiAwICYmIG1heFNpZ24gPiAwKSB7CgkJCQkJLy8gbW92ZSB0aGUgYm90dG9tIGRvd24gdG8gMAoJCQkJCW1lLm1pbiA9IDA7CgkJCQl9CgkJCX0KCgkJCXZhciBzZXRNaW4gPSB0aWNrT3B0cy5taW4gIT09IHVuZGVmaW5lZCB8fCB0aWNrT3B0cy5zdWdnZXN0ZWRNaW4gIT09IHVuZGVmaW5lZDsKCQkJdmFyIHNldE1heCA9IHRpY2tPcHRzLm1heCAhPT0gdW5kZWZpbmVkIHx8IHRpY2tPcHRzLnN1Z2dlc3RlZE1heCAhPT0gdW5kZWZpbmVkOwoKCQkJaWYgKHRpY2tPcHRzLm1pbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQltZS5taW4gPSB0aWNrT3B0cy5taW47CgkJCX0gZWxzZSBpZiAodGlja09wdHMuc3VnZ2VzdGVkTWluICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmIChtZS5taW4gPT09IG51bGwpIHsKCQkJCQltZS5taW4gPSB0aWNrT3B0cy5zdWdnZXN0ZWRNaW47CgkJCQl9IGVsc2UgewoJCQkJCW1lLm1pbiA9IE1hdGgubWluKG1lLm1pbiwgdGlja09wdHMuc3VnZ2VzdGVkTWluKTsKCQkJCX0KCQkJfQoKCQkJaWYgKHRpY2tPcHRzLm1heCAhPT0gdW5kZWZpbmVkKSB7CgkJCQltZS5tYXggPSB0aWNrT3B0cy5tYXg7CgkJCX0gZWxzZSBpZiAodGlja09wdHMuc3VnZ2VzdGVkTWF4ICE9PSB1bmRlZmluZWQpIHsKCQkJCWlmIChtZS5tYXggPT09IG51bGwpIHsKCQkJCQltZS5tYXggPSB0aWNrT3B0cy5zdWdnZXN0ZWRNYXg7CgkJCQl9IGVsc2UgewoJCQkJCW1lLm1heCA9IE1hdGgubWF4KG1lLm1heCwgdGlja09wdHMuc3VnZ2VzdGVkTWF4KTsKCQkJCX0KCQkJfQoKCQkJaWYgKHNldE1pbiAhPT0gc2V0TWF4KSB7CgkJCQkvLyBXZSBzZXQgdGhlIG1pbiBvciB0aGUgbWF4IGJ1dCBub3QgYm90aC4KCQkJCS8vIFNvIGVuc3VyZSB0aGF0IG91ciByYW5nZSBpcyBnb29kCgkJCQkvLyBJbnZlcnRlZCBvciAwIGxlbmd0aCByYW5nZSBjYW4gaGFwcGVuIHdoZW4KCQkJCS8vIHRpY2tzLm1pbiBpcyBzZXQsIGFuZCBubyBkYXRhc2V0cyBhcmUgdmlzaWJsZQoJCQkJaWYgKG1lLm1pbiA+PSBtZS5tYXgpIHsKCQkJCQlpZiAoc2V0TWluKSB7CgkJCQkJCW1lLm1heCA9IG1lLm1pbiArIDE7CgkJCQkJfSBlbHNlIHsKCQkJCQkJbWUubWluID0gbWUubWF4IC0gMTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCWlmIChtZS5taW4gPT09IG1lLm1heCkgewoJCQkJbWUubWF4Kys7CgoJCQkJaWYgKCF0aWNrT3B0cy5iZWdpbkF0WmVybykgewoJCQkJCW1lLm1pbi0tOwoJCQkJfQoJCQl9CgkJfSwKCQlnZXRUaWNrTGltaXQ6IG5vb3AsCgkJaGFuZGxlRGlyZWN0aW9uYWxDaGFuZ2VzOiBub29wLAoKCQlidWlsZFRpY2tzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdHMgPSBtZS5vcHRpb25zOwoJCQl2YXIgdGlja09wdHMgPSBvcHRzLnRpY2tzOwoKCQkJLy8gRmlndXJlIG91dCB3aGF0IHRoZSBtYXggbnVtYmVyIG9mIHRpY2tzIHdlIGNhbiBzdXBwb3J0IGl0IGlzIGJhc2VkIG9uIHRoZSBzaXplIG9mCgkJCS8vIHRoZSBheGlzIGFyZWEuIEZvciBub3csIHdlIHNheSB0aGF0IHRoZSBtaW5pbXVtIHRpY2sgc3BhY2luZyBpbiBwaXhlbHMgbXVzdCBiZSA1MAoJCQkvLyBXZSBhbHNvIGxpbWl0IHRoZSBtYXhpbXVtIG51bWJlciBvZiB0aWNrcyB0byAxMSB3aGljaCBnaXZlcyBhIG5pY2UgMTAgc3F1YXJlcyBvbgoJCQkvLyB0aGUgZ3JhcGguIE1ha2Ugc3VyZSB3ZSBhbHdheXMgaGF2ZSBhdCBsZWFzdCAyIHRpY2tzCgkJCXZhciBtYXhUaWNrcyA9IG1lLmdldFRpY2tMaW1pdCgpOwoJCQltYXhUaWNrcyA9IE1hdGgubWF4KDIsIG1heFRpY2tzKTsKCgkJCXZhciBudW1lcmljR2VuZXJhdG9yT3B0aW9ucyA9IHsKCQkJCW1heFRpY2tzOiBtYXhUaWNrcywKCQkJCW1pbjogdGlja09wdHMubWluLAoJCQkJbWF4OiB0aWNrT3B0cy5tYXgsCgkJCQlzdGVwU2l6ZTogaGVscGVycy52YWx1ZU9yRGVmYXVsdCh0aWNrT3B0cy5maXhlZFN0ZXBTaXplLCB0aWNrT3B0cy5zdGVwU2l6ZSkKCQkJfTsKCQkJdmFyIHRpY2tzID0gbWUudGlja3MgPSBnZW5lcmF0ZVRpY2tzKG51bWVyaWNHZW5lcmF0b3JPcHRpb25zLCBtZSk7CgoJCQltZS5oYW5kbGVEaXJlY3Rpb25hbENoYW5nZXMoKTsKCgkJCS8vIEF0IHRoaXMgcG9pbnQsIHdlIG5lZWQgdG8gdXBkYXRlIG91ciBtYXggYW5kIG1pbiBnaXZlbiB0aGUgdGljayB2YWx1ZXMgc2luY2Ugd2UgaGF2ZSBleHBhbmRlZCB0aGUKCQkJLy8gcmFuZ2Ugb2YgdGhlIHNjYWxlCgkJCW1lLm1heCA9IGhlbHBlcnMubWF4KHRpY2tzKTsKCQkJbWUubWluID0gaGVscGVycy5taW4odGlja3MpOwoKCQkJaWYgKHRpY2tPcHRzLnJldmVyc2UpIHsKCQkJCXRpY2tzLnJldmVyc2UoKTsKCgkJCQltZS5zdGFydCA9IG1lLm1heDsKCQkJCW1lLmVuZCA9IG1lLm1pbjsKCQkJfSBlbHNlIHsKCQkJCW1lLnN0YXJ0ID0gbWUubWluOwoJCQkJbWUuZW5kID0gbWUubWF4OwoJCQl9CgkJfSwKCQljb252ZXJ0VGlja3NUb0xhYmVsczogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCW1lLnRpY2tzQXNOdW1iZXJzID0gbWUudGlja3Muc2xpY2UoKTsKCQkJbWUuemVyb0xpbmVJbmRleCA9IG1lLnRpY2tzLmluZGV4T2YoMCk7CgoJCQlDaGFydC5TY2FsZS5wcm90b3R5cGUuY29udmVydFRpY2tzVG9MYWJlbHMuY2FsbChtZSk7CgkJfQoJfSk7Cn07Cgp9LHsiNDUiOjQ1fV0sNTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgp2YXIgaGVscGVycyA9IHJlcXVpcmUoNDUpOwp2YXIgVGlja3MgPSByZXF1aXJlKDM0KTsKCi8qKgogKiBHZW5lcmF0ZSBhIHNldCBvZiBsb2dhcml0aG1pYyB0aWNrcwogKiBAcGFyYW0gZ2VuZXJhdGlvbk9wdGlvbnMgdGhlIG9wdGlvbnMgdXNlZCB0byBnZW5lcmF0ZSB0aGUgdGlja3MKICogQHBhcmFtIGRhdGFSYW5nZSB0aGUgcmFuZ2Ugb2YgdGhlIGRhdGEKICogQHJldHVybnMge0FycmF5PE51bWJlcj59IGFycmF5IG9mIHRpY2sgdmFsdWVzCiAqLwpmdW5jdGlvbiBnZW5lcmF0ZVRpY2tzKGdlbmVyYXRpb25PcHRpb25zLCBkYXRhUmFuZ2UpIHsKCXZhciB0aWNrcyA9IFtdOwoJdmFyIHZhbHVlT3JEZWZhdWx0ID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdDsKCgkvLyBGaWd1cmUgb3V0IHdoYXQgdGhlIG1heCBudW1iZXIgb2YgdGlja3Mgd2UgY2FuIHN1cHBvcnQgaXQgaXMgYmFzZWQgb24gdGhlIHNpemUgb2YKCS8vIHRoZSBheGlzIGFyZWEuIEZvciBub3csIHdlIHNheSB0aGF0IHRoZSBtaW5pbXVtIHRpY2sgc3BhY2luZyBpbiBwaXhlbHMgbXVzdCBiZSA1MAoJLy8gV2UgYWxzbyBsaW1pdCB0aGUgbWF4aW11bSBudW1iZXIgb2YgdGlja3MgdG8gMTEgd2hpY2ggZ2l2ZXMgYSBuaWNlIDEwIHNxdWFyZXMgb24KCS8vIHRoZSBncmFwaAoJdmFyIHRpY2tWYWwgPSB2YWx1ZU9yRGVmYXVsdChnZW5lcmF0aW9uT3B0aW9ucy5taW4sIE1hdGgucG93KDEwLCBNYXRoLmZsb29yKGhlbHBlcnMubG9nMTAoZGF0YVJhbmdlLm1pbikpKSk7CgoJdmFyIGVuZEV4cCA9IE1hdGguZmxvb3IoaGVscGVycy5sb2cxMChkYXRhUmFuZ2UubWF4KSk7Cgl2YXIgZW5kU2lnbmlmaWNhbmQgPSBNYXRoLmNlaWwoZGF0YVJhbmdlLm1heCAvIE1hdGgucG93KDEwLCBlbmRFeHApKTsKCXZhciBleHAsIHNpZ25pZmljYW5kOwoKCWlmICh0aWNrVmFsID09PSAwKSB7CgkJZXhwID0gTWF0aC5mbG9vcihoZWxwZXJzLmxvZzEwKGRhdGFSYW5nZS5taW5Ob3RaZXJvKSk7CgkJc2lnbmlmaWNhbmQgPSBNYXRoLmZsb29yKGRhdGFSYW5nZS5taW5Ob3RaZXJvIC8gTWF0aC5wb3coMTAsIGV4cCkpOwoKCQl0aWNrcy5wdXNoKHRpY2tWYWwpOwoJCXRpY2tWYWwgPSBzaWduaWZpY2FuZCAqIE1hdGgucG93KDEwLCBleHApOwoJfSBlbHNlIHsKCQlleHAgPSBNYXRoLmZsb29yKGhlbHBlcnMubG9nMTAodGlja1ZhbCkpOwoJCXNpZ25pZmljYW5kID0gTWF0aC5mbG9vcih0aWNrVmFsIC8gTWF0aC5wb3coMTAsIGV4cCkpOwoJfQoJdmFyIHByZWNpc2lvbiA9IGV4cCA8IDAgPyBNYXRoLnBvdygxMCwgTWF0aC5hYnMoZXhwKSkgOiAxOwoKCWRvIHsKCQl0aWNrcy5wdXNoKHRpY2tWYWwpOwoKCQkrK3NpZ25pZmljYW5kOwoJCWlmIChzaWduaWZpY2FuZCA9PT0gMTApIHsKCQkJc2lnbmlmaWNhbmQgPSAxOwoJCQkrK2V4cDsKCQkJcHJlY2lzaW9uID0gZXhwID49IDAgPyAxIDogcHJlY2lzaW9uOwoJCX0KCgkJdGlja1ZhbCA9IE1hdGgucm91bmQoc2lnbmlmaWNhbmQgKiBNYXRoLnBvdygxMCwgZXhwKSAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9IHdoaWxlIChleHAgPCBlbmRFeHAgfHwgKGV4cCA9PT0gZW5kRXhwICYmIHNpZ25pZmljYW5kIDwgZW5kU2lnbmlmaWNhbmQpKTsKCgl2YXIgbGFzdFRpY2sgPSB2YWx1ZU9yRGVmYXVsdChnZW5lcmF0aW9uT3B0aW9ucy5tYXgsIHRpY2tWYWwpOwoJdGlja3MucHVzaChsYXN0VGljayk7CgoJcmV0dXJuIHRpY2tzOwp9CgoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCXZhciBkZWZhdWx0Q29uZmlnID0gewoJCXBvc2l0aW9uOiAnbGVmdCcsCgoJCS8vIGxhYmVsIHNldHRpbmdzCgkJdGlja3M6IHsKCQkJY2FsbGJhY2s6IFRpY2tzLmZvcm1hdHRlcnMubG9nYXJpdGhtaWMKCQl9Cgl9OwoKCXZhciBMb2dhcml0aG1pY1NjYWxlID0gQ2hhcnQuU2NhbGUuZXh0ZW5kKHsKCQlkZXRlcm1pbmVEYXRhTGltaXRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdHMgPSBtZS5vcHRpb25zOwoJCQl2YXIgY2hhcnQgPSBtZS5jaGFydDsKCQkJdmFyIGRhdGEgPSBjaGFydC5kYXRhOwoJCQl2YXIgZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzOwoJCQl2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgkJCWZ1bmN0aW9uIElETWF0Y2hlcyhtZXRhKSB7CgkJCQlyZXR1cm4gaXNIb3Jpem9udGFsID8gbWV0YS54QXhpc0lEID09PSBtZS5pZCA6IG1ldGEueUF4aXNJRCA9PT0gbWUuaWQ7CgkJCX0KCgkJCS8vIENhbGN1bGF0ZSBSYW5nZQoJCQltZS5taW4gPSBudWxsOwoJCQltZS5tYXggPSBudWxsOwoJCQltZS5taW5Ob3RaZXJvID0gbnVsbDsKCgkJCXZhciBoYXNTdGFja3MgPSBvcHRzLnN0YWNrZWQ7CgkJCWlmIChoYXNTdGFja3MgPT09IHVuZGVmaW5lZCkgewoJCQkJaGVscGVycy5lYWNoKGRhdGFzZXRzLCBmdW5jdGlvbihkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHsKCQkJCQlpZiAoaGFzU3RhY2tzKSB7CgkJCQkJCXJldHVybjsKCQkJCQl9CgoJCQkJCXZhciBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsKCQkJCQlpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShkYXRhc2V0SW5kZXgpICYmIElETWF0Y2hlcyhtZXRhKSAmJgoJCQkJCQltZXRhLnN0YWNrICE9PSB1bmRlZmluZWQpIHsKCQkJCQkJaGFzU3RhY2tzID0gdHJ1ZTsKCQkJCQl9CgkJCQl9KTsKCQkJfQoKCQkJaWYgKG9wdHMuc3RhY2tlZCB8fCBoYXNTdGFja3MpIHsKCQkJCXZhciB2YWx1ZXNQZXJTdGFjayA9IHt9OwoKCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7CgkJCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoJCQkJCXZhciBrZXkgPSBbCgkJCQkJCW1ldGEudHlwZSwKCQkJCQkJLy8gd2UgaGF2ZSBhIHNlcGFyYXRlIHN0YWNrIGZvciBzdGFjaz11bmRlZmluZWQgZGF0YXNldHMgd2hlbiB0aGUgb3B0cy5zdGFja2VkIGlzIHVuZGVmaW5lZAoJCQkJCQkoKG9wdHMuc3RhY2tlZCA9PT0gdW5kZWZpbmVkICYmIG1ldGEuc3RhY2sgPT09IHVuZGVmaW5lZCkgPyBkYXRhc2V0SW5kZXggOiAnJyksCgkJCQkJCW1ldGEuc3RhY2sKCQkJCQldLmpvaW4oJy4nKTsKCgkJCQkJaWYgKGNoYXJ0LmlzRGF0YXNldFZpc2libGUoZGF0YXNldEluZGV4KSAmJiBJRE1hdGNoZXMobWV0YSkpIHsKCQkJCQkJaWYgKHZhbHVlc1BlclN0YWNrW2tleV0gPT09IHVuZGVmaW5lZCkgewoJCQkJCQkJdmFsdWVzUGVyU3RhY2tba2V5XSA9IFtdOwoJCQkJCQl9CgoJCQkJCQloZWxwZXJzLmVhY2goZGF0YXNldC5kYXRhLCBmdW5jdGlvbihyYXdWYWx1ZSwgaW5kZXgpIHsKCQkJCQkJCXZhciB2YWx1ZXMgPSB2YWx1ZXNQZXJTdGFja1trZXldOwoJCQkJCQkJdmFyIHZhbHVlID0gK21lLmdldFJpZ2h0VmFsdWUocmF3VmFsdWUpOwoJCQkJCQkJLy8gaW52YWxpZCwgaGlkZGVuIGFuZCBuZWdhdGl2ZSB2YWx1ZXMgYXJlIGlnbm9yZWQKCQkJCQkJCWlmIChpc05hTih2YWx1ZSkgfHwgbWV0YS5kYXRhW2luZGV4XS5oaWRkZW4gfHwgdmFsdWUgPCAwKSB7CgkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJfQoJCQkJCQkJdmFsdWVzW2luZGV4XSA9IHZhbHVlc1tpbmRleF0gfHwgMDsKCQkJCQkJCXZhbHVlc1tpbmRleF0gKz0gdmFsdWU7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoKCQkJCWhlbHBlcnMuZWFjaCh2YWx1ZXNQZXJTdGFjaywgZnVuY3Rpb24odmFsdWVzRm9yVHlwZSkgewoJCQkJCWlmICh2YWx1ZXNGb3JUeXBlLmxlbmd0aCA+IDApIHsKCQkJCQkJdmFyIG1pblZhbCA9IGhlbHBlcnMubWluKHZhbHVlc0ZvclR5cGUpOwoJCQkJCQl2YXIgbWF4VmFsID0gaGVscGVycy5tYXgodmFsdWVzRm9yVHlwZSk7CgkJCQkJCW1lLm1pbiA9IG1lLm1pbiA9PT0gbnVsbCA/IG1pblZhbCA6IE1hdGgubWluKG1lLm1pbiwgbWluVmFsKTsKCQkJCQkJbWUubWF4ID0gbWUubWF4ID09PSBudWxsID8gbWF4VmFsIDogTWF0aC5tYXgobWUubWF4LCBtYXhWYWwpOwoJCQkJCX0KCQkJCX0pOwoKCQkJfSBlbHNlIHsKCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7CgkJCQkJdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoJCQkJCWlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgJiYgSURNYXRjaGVzKG1ldGEpKSB7CgkJCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0LmRhdGEsIGZ1bmN0aW9uKHJhd1ZhbHVlLCBpbmRleCkgewoJCQkJCQkJdmFyIHZhbHVlID0gK21lLmdldFJpZ2h0VmFsdWUocmF3VmFsdWUpOwoJCQkJCQkJLy8gaW52YWxpZCwgaGlkZGVuIGFuZCBuZWdhdGl2ZSB2YWx1ZXMgYXJlIGlnbm9yZWQKCQkJCQkJCWlmIChpc05hTih2YWx1ZSkgfHwgbWV0YS5kYXRhW2luZGV4XS5oaWRkZW4gfHwgdmFsdWUgPCAwKSB7CgkJCQkJCQkJcmV0dXJuOwoJCQkJCQkJfQoKCQkJCQkJCWlmIChtZS5taW4gPT09IG51bGwpIHsKCQkJCQkJCQltZS5taW4gPSB2YWx1ZTsKCQkJCQkJCX0gZWxzZSBpZiAodmFsdWUgPCBtZS5taW4pIHsKCQkJCQkJCQltZS5taW4gPSB2YWx1ZTsKCQkJCQkJCX0KCgkJCQkJCQlpZiAobWUubWF4ID09PSBudWxsKSB7CgkJCQkJCQkJbWUubWF4ID0gdmFsdWU7CgkJCQkJCQl9IGVsc2UgaWYgKHZhbHVlID4gbWUubWF4KSB7CgkJCQkJCQkJbWUubWF4ID0gdmFsdWU7CgkJCQkJCQl9CgoJCQkJCQkJaWYgKHZhbHVlICE9PSAwICYmIChtZS5taW5Ob3RaZXJvID09PSBudWxsIHx8IHZhbHVlIDwgbWUubWluTm90WmVybykpIHsKCQkJCQkJCQltZS5taW5Ob3RaZXJvID0gdmFsdWU7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCQl9CgoJCQkvLyBDb21tb24gYmFzZSBpbXBsZW1lbnRhdGlvbiB0byBoYW5kbGUgdGlja3MubWluLCB0aWNrcy5tYXgKCQkJdGhpcy5oYW5kbGVUaWNrUmFuZ2VPcHRpb25zKCk7CgkJfSwKCQloYW5kbGVUaWNrUmFuZ2VPcHRpb25zOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdHMgPSBtZS5vcHRpb25zOwoJCQl2YXIgdGlja09wdHMgPSBvcHRzLnRpY2tzOwoJCQl2YXIgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoJCQl2YXIgREVGQVVMVF9NSU4gPSAxOwoJCQl2YXIgREVGQVVMVF9NQVggPSAxMDsKCgkJCW1lLm1pbiA9IHZhbHVlT3JEZWZhdWx0KHRpY2tPcHRzLm1pbiwgbWUubWluKTsKCQkJbWUubWF4ID0gdmFsdWVPckRlZmF1bHQodGlja09wdHMubWF4LCBtZS5tYXgpOwoKCQkJaWYgKG1lLm1pbiA9PT0gbWUubWF4KSB7CgkJCQlpZiAobWUubWluICE9PSAwICYmIG1lLm1pbiAhPT0gbnVsbCkgewoJCQkJCW1lLm1pbiA9IE1hdGgucG93KDEwLCBNYXRoLmZsb29yKGhlbHBlcnMubG9nMTAobWUubWluKSkgLSAxKTsKCQkJCQltZS5tYXggPSBNYXRoLnBvdygxMCwgTWF0aC5mbG9vcihoZWxwZXJzLmxvZzEwKG1lLm1heCkpICsgMSk7CgkJCQl9IGVsc2UgewoJCQkJCW1lLm1pbiA9IERFRkFVTFRfTUlOOwoJCQkJCW1lLm1heCA9IERFRkFVTFRfTUFYOwoJCQkJfQoJCQl9CgkJCWlmIChtZS5taW4gPT09IG51bGwpIHsKCQkJCW1lLm1pbiA9IE1hdGgucG93KDEwLCBNYXRoLmZsb29yKGhlbHBlcnMubG9nMTAobWUubWF4KSkgLSAxKTsKCQkJfQoJCQlpZiAobWUubWF4ID09PSBudWxsKSB7CgkJCQltZS5tYXggPSBtZS5taW4gIT09IDAKCQkJCQk/IE1hdGgucG93KDEwLCBNYXRoLmZsb29yKGhlbHBlcnMubG9nMTAobWUubWluKSkgKyAxKQoJCQkJCTogREVGQVVMVF9NQVg7CgkJCX0KCQkJaWYgKG1lLm1pbk5vdFplcm8gPT09IG51bGwpIHsKCQkJCWlmIChtZS5taW4gPiAwKSB7CgkJCQkJbWUubWluTm90WmVybyA9IG1lLm1pbjsKCQkJCX0gZWxzZSBpZiAobWUubWF4IDwgMSkgewoJCQkJCW1lLm1pbk5vdFplcm8gPSBNYXRoLnBvdygxMCwgTWF0aC5mbG9vcihoZWxwZXJzLmxvZzEwKG1lLm1heCkpKTsKCQkJCX0gZWxzZSB7CgkJCQkJbWUubWluTm90WmVybyA9IERFRkFVTFRfTUlOOwoJCQkJfQoJCQl9CgkJfSwKCQlidWlsZFRpY2tzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdHMgPSBtZS5vcHRpb25zOwoJCQl2YXIgdGlja09wdHMgPSBvcHRzLnRpY2tzOwoJCQl2YXIgcmV2ZXJzZSA9ICFtZS5pc0hvcml6b250YWwoKTsKCgkJCXZhciBnZW5lcmF0aW9uT3B0aW9ucyA9IHsKCQkJCW1pbjogdGlja09wdHMubWluLAoJCQkJbWF4OiB0aWNrT3B0cy5tYXgKCQkJfTsKCQkJdmFyIHRpY2tzID0gbWUudGlja3MgPSBnZW5lcmF0ZVRpY2tzKGdlbmVyYXRpb25PcHRpb25zLCBtZSk7CgoJCQkvLyBBdCB0aGlzIHBvaW50LCB3ZSBuZWVkIHRvIHVwZGF0ZSBvdXIgbWF4IGFuZCBtaW4gZ2l2ZW4gdGhlIHRpY2sgdmFsdWVzIHNpbmNlIHdlIGhhdmUgZXhwYW5kZWQgdGhlCgkJCS8vIHJhbmdlIG9mIHRoZSBzY2FsZQoJCQltZS5tYXggPSBoZWxwZXJzLm1heCh0aWNrcyk7CgkJCW1lLm1pbiA9IGhlbHBlcnMubWluKHRpY2tzKTsKCgkJCWlmICh0aWNrT3B0cy5yZXZlcnNlKSB7CgkJCQlyZXZlcnNlID0gIXJldmVyc2U7CgkJCQltZS5zdGFydCA9IG1lLm1heDsKCQkJCW1lLmVuZCA9IG1lLm1pbjsKCQkJfSBlbHNlIHsKCQkJCW1lLnN0YXJ0ID0gbWUubWluOwoJCQkJbWUuZW5kID0gbWUubWF4OwoJCQl9CgkJCWlmIChyZXZlcnNlKSB7CgkJCQl0aWNrcy5yZXZlcnNlKCk7CgkJCX0KCQl9LAoJCWNvbnZlcnRUaWNrc1RvTGFiZWxzOiBmdW5jdGlvbigpIHsKCQkJdGhpcy50aWNrVmFsdWVzID0gdGhpcy50aWNrcy5zbGljZSgpOwoKCQkJQ2hhcnQuU2NhbGUucHJvdG90eXBlLmNvbnZlcnRUaWNrc1RvTGFiZWxzLmNhbGwodGhpcyk7CgkJfSwKCQkvLyBHZXQgdGhlIGNvcnJlY3QgdG9vbHRpcCBsYWJlbAoJCWdldExhYmVsRm9ySW5kZXg6IGZ1bmN0aW9uKGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKCQkJcmV0dXJuICt0aGlzLmdldFJpZ2h0VmFsdWUodGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uZGF0YVtpbmRleF0pOwoJCX0sCgkJZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbihpbmRleCkgewoJCQlyZXR1cm4gdGhpcy5nZXRQaXhlbEZvclZhbHVlKHRoaXMudGlja1ZhbHVlc1tpbmRleF0pOwoJCX0sCgkJLyoqCgkJICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIGZpcnN0IHRpY2suCgkJICogQHBhcmFtIHtOdW1iZXJ9IHZhbHVlIC0gVGhlIG1pbmltdW0gbm90IHplcm8gdmFsdWUuCgkJICogQHJldHVybiB7TnVtYmVyfSBUaGUgZmlyc3QgdGljayB2YWx1ZS4KCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCV9nZXRGaXJzdFRpY2tWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKCQkJdmFyIGV4cCA9IE1hdGguZmxvb3IoaGVscGVycy5sb2cxMCh2YWx1ZSkpOwoJCQl2YXIgc2lnbmlmaWNhbmQgPSBNYXRoLmZsb29yKHZhbHVlIC8gTWF0aC5wb3coMTAsIGV4cCkpOwoKCQkJcmV0dXJuIHNpZ25pZmljYW5kICogTWF0aC5wb3coMTAsIGV4cCk7CgkJfSwKCQlnZXRQaXhlbEZvclZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgcmV2ZXJzZSA9IG1lLm9wdGlvbnMudGlja3MucmV2ZXJzZTsKCQkJdmFyIGxvZzEwID0gaGVscGVycy5sb2cxMDsKCQkJdmFyIGZpcnN0VGlja1ZhbHVlID0gbWUuX2dldEZpcnN0VGlja1ZhbHVlKG1lLm1pbk5vdFplcm8pOwoJCQl2YXIgb2Zmc2V0ID0gMDsKCQkJdmFyIGlubmVyRGltZW5zaW9uLCBwaXhlbCwgc3RhcnQsIGVuZCwgc2lnbjsKCgkJCXZhbHVlID0gK21lLmdldFJpZ2h0VmFsdWUodmFsdWUpOwoJCQlpZiAocmV2ZXJzZSkgewoJCQkJc3RhcnQgPSBtZS5lbmQ7CgkJCQllbmQgPSBtZS5zdGFydDsKCQkJCXNpZ24gPSAtMTsKCQkJfSBlbHNlIHsKCQkJCXN0YXJ0ID0gbWUuc3RhcnQ7CgkJCQllbmQgPSBtZS5lbmQ7CgkJCQlzaWduID0gMTsKCQkJfQoJCQlpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKCQkJCWlubmVyRGltZW5zaW9uID0gbWUud2lkdGg7CgkJCQlwaXhlbCA9IHJldmVyc2UgPyBtZS5yaWdodCA6IG1lLmxlZnQ7CgkJCX0gZWxzZSB7CgkJCQlpbm5lckRpbWVuc2lvbiA9IG1lLmhlaWdodDsKCQkJCXNpZ24gKj0gLTE7IC8vIGludmVydCwgc2luY2UgdGhlIHVwcGVyLWxlZnQgY29ybmVyIG9mIHRoZSBjYW52YXMgaXMgYXQgcGl4ZWwgKDAsIDApCgkJCQlwaXhlbCA9IHJldmVyc2UgPyBtZS50b3AgOiBtZS5ib3R0b207CgkJCX0KCQkJaWYgKHZhbHVlICE9PSBzdGFydCkgewoJCQkJaWYgKHN0YXJ0ID09PSAwKSB7IC8vIGluY2x1ZGUgemVybyB0aWNrCgkJCQkJb2Zmc2V0ID0gaGVscGVycy5nZXRWYWx1ZU9yRGVmYXVsdCgKCQkJCQkJbWUub3B0aW9ucy50aWNrcy5mb250U2l6ZSwKCQkJCQkJQ2hhcnQuZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRGb250U2l6ZQoJCQkJCSk7CgkJCQkJaW5uZXJEaW1lbnNpb24gLT0gb2Zmc2V0OwoJCQkJCXN0YXJ0ID0gZmlyc3RUaWNrVmFsdWU7CgkJCQl9CgkJCQlpZiAodmFsdWUgIT09IDApIHsKCQkJCQlvZmZzZXQgKz0gaW5uZXJEaW1lbnNpb24gLyAobG9nMTAoZW5kKSAtIGxvZzEwKHN0YXJ0KSkgKiAobG9nMTAodmFsdWUpIC0gbG9nMTAoc3RhcnQpKTsKCQkJCX0KCQkJCXBpeGVsICs9IHNpZ24gKiBvZmZzZXQ7CgkJCX0KCQkJcmV0dXJuIHBpeGVsOwoJCX0sCgkJZ2V0VmFsdWVGb3JQaXhlbDogZnVuY3Rpb24ocGl4ZWwpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIHJldmVyc2UgPSBtZS5vcHRpb25zLnRpY2tzLnJldmVyc2U7CgkJCXZhciBsb2cxMCA9IGhlbHBlcnMubG9nMTA7CgkJCXZhciBmaXJzdFRpY2tWYWx1ZSA9IG1lLl9nZXRGaXJzdFRpY2tWYWx1ZShtZS5taW5Ob3RaZXJvKTsKCQkJdmFyIGlubmVyRGltZW5zaW9uLCBzdGFydCwgZW5kLCB2YWx1ZTsKCgkJCWlmIChyZXZlcnNlKSB7CgkJCQlzdGFydCA9IG1lLmVuZDsKCQkJCWVuZCA9IG1lLnN0YXJ0OwoJCQl9IGVsc2UgewoJCQkJc3RhcnQgPSBtZS5zdGFydDsKCQkJCWVuZCA9IG1lLmVuZDsKCQkJfQoJCQlpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKCQkJCWlubmVyRGltZW5zaW9uID0gbWUud2lkdGg7CgkJCQl2YWx1ZSA9IHJldmVyc2UgPyBtZS5yaWdodCAtIHBpeGVsIDogcGl4ZWwgLSBtZS5sZWZ0OwoJCQl9IGVsc2UgewoJCQkJaW5uZXJEaW1lbnNpb24gPSBtZS5oZWlnaHQ7CgkJCQl2YWx1ZSA9IHJldmVyc2UgPyBwaXhlbCAtIG1lLnRvcCA6IG1lLmJvdHRvbSAtIHBpeGVsOwoJCQl9CgkJCWlmICh2YWx1ZSAhPT0gc3RhcnQpIHsKCQkJCWlmIChzdGFydCA9PT0gMCkgeyAvLyBpbmNsdWRlIHplcm8gdGljawoJCQkJCXZhciBvZmZzZXQgPSBoZWxwZXJzLmdldFZhbHVlT3JEZWZhdWx0KAoJCQkJCQltZS5vcHRpb25zLnRpY2tzLmZvbnRTaXplLAoJCQkJCQlDaGFydC5kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdEZvbnRTaXplCgkJCQkJKTsKCQkJCQl2YWx1ZSAtPSBvZmZzZXQ7CgkJCQkJaW5uZXJEaW1lbnNpb24gLT0gb2Zmc2V0OwoJCQkJCXN0YXJ0ID0gZmlyc3RUaWNrVmFsdWU7CgkJCQl9CgkJCQl2YWx1ZSAqPSBsb2cxMChlbmQpIC0gbG9nMTAoc3RhcnQpOwoJCQkJdmFsdWUgLz0gaW5uZXJEaW1lbnNpb247CgkJCQl2YWx1ZSA9IE1hdGgucG93KDEwLCBsb2cxMChzdGFydCkgKyB2YWx1ZSk7CgkJCX0KCQkJcmV0dXJuIHZhbHVlOwoJCX0KCX0pOwoJQ2hhcnQuc2NhbGVTZXJ2aWNlLnJlZ2lzdGVyU2NhbGVUeXBlKCdsb2dhcml0aG1pYycsIExvZ2FyaXRobWljU2NhbGUsIGRlZmF1bHRDb25maWcpOwoKfTsKCn0seyIzNCI6MzQsIjQ1Ijo0NX1dLDU3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIGRlZmF1bHRzID0gcmVxdWlyZSgyNSk7CnZhciBoZWxwZXJzID0gcmVxdWlyZSg0NSk7CnZhciBUaWNrcyA9IHJlcXVpcmUoMzQpOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCXZhciBnbG9iYWxEZWZhdWx0cyA9IGRlZmF1bHRzLmdsb2JhbDsKCgl2YXIgZGVmYXVsdENvbmZpZyA9IHsKCQlkaXNwbGF5OiB0cnVlLAoKCQkvLyBCb29sZWFuIC0gV2hldGhlciB0byBhbmltYXRlIHNjYWxpbmcgdGhlIGNoYXJ0IGZyb20gdGhlIGNlbnRyZQoJCWFuaW1hdGU6IHRydWUsCgkJcG9zaXRpb246ICdjaGFydEFyZWEnLAoKCQlhbmdsZUxpbmVzOiB7CgkJCWRpc3BsYXk6IHRydWUsCgkJCWNvbG9yOiAncmdiYSgwLCAwLCAwLCAwLjEpJywKCQkJbGluZVdpZHRoOiAxCgkJfSwKCgkJZ3JpZExpbmVzOiB7CgkJCWNpcmN1bGFyOiBmYWxzZQoJCX0sCgoJCS8vIGxhYmVsIHNldHRpbmdzCgkJdGlja3M6IHsKCQkJLy8gQm9vbGVhbiAtIFNob3cgYSBiYWNrZHJvcCB0byB0aGUgc2NhbGUgbGFiZWwKCQkJc2hvd0xhYmVsQmFja2Ryb3A6IHRydWUsCgoJCQkvLyBTdHJpbmcgLSBUaGUgY29sb3VyIG9mIHRoZSBsYWJlbCBiYWNrZHJvcAoJCQliYWNrZHJvcENvbG9yOiAncmdiYSgyNTUsMjU1LDI1NSwwLjc1KScsCgoJCQkvLyBOdW1iZXIgLSBUaGUgYmFja2Ryb3AgcGFkZGluZyBhYm92ZSAmIGJlbG93IHRoZSBsYWJlbCBpbiBwaXhlbHMKCQkJYmFja2Ryb3BQYWRkaW5nWTogMiwKCgkJCS8vIE51bWJlciAtIFRoZSBiYWNrZHJvcCBwYWRkaW5nIHRvIHRoZSBzaWRlIG9mIHRoZSBsYWJlbCBpbiBwaXhlbHMKCQkJYmFja2Ryb3BQYWRkaW5nWDogMiwKCgkJCWNhbGxiYWNrOiBUaWNrcy5mb3JtYXR0ZXJzLmxpbmVhcgoJCX0sCgoJCXBvaW50TGFiZWxzOiB7CgkJCS8vIEJvb2xlYW4gLSBpZiB0cnVlLCBzaG93IHBvaW50IGxhYmVscwoJCQlkaXNwbGF5OiB0cnVlLAoKCQkJLy8gTnVtYmVyIC0gUG9pbnQgbGFiZWwgZm9udCBzaXplIGluIHBpeGVscwoJCQlmb250U2l6ZTogMTAsCgoJCQkvLyBGdW5jdGlvbiAtIFVzZWQgdG8gY29udmVydCBwb2ludCBsYWJlbHMKCQkJY2FsbGJhY2s6IGZ1bmN0aW9uKGxhYmVsKSB7CgkJCQlyZXR1cm4gbGFiZWw7CgkJCX0KCQl9Cgl9OwoKCWZ1bmN0aW9uIGdldFZhbHVlQ291bnQoc2NhbGUpIHsKCQl2YXIgb3B0cyA9IHNjYWxlLm9wdGlvbnM7CgkJcmV0dXJuIG9wdHMuYW5nbGVMaW5lcy5kaXNwbGF5IHx8IG9wdHMucG9pbnRMYWJlbHMuZGlzcGxheSA/IHNjYWxlLmNoYXJ0LmRhdGEubGFiZWxzLmxlbmd0aCA6IDA7Cgl9CgoJZnVuY3Rpb24gZ2V0UG9pbnRMYWJlbEZvbnRPcHRpb25zKHNjYWxlKSB7CgkJdmFyIHBvaW50TGFiZWxPcHRpb25zID0gc2NhbGUub3B0aW9ucy5wb2ludExhYmVsczsKCQl2YXIgZm9udFNpemUgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHBvaW50TGFiZWxPcHRpb25zLmZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpOwoJCXZhciBmb250U3R5bGUgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHBvaW50TGFiZWxPcHRpb25zLmZvbnRTdHlsZSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRTdHlsZSk7CgkJdmFyIGZvbnRGYW1pbHkgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHBvaW50TGFiZWxPcHRpb25zLmZvbnRGYW1pbHksIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250RmFtaWx5KTsKCQl2YXIgZm9udCA9IGhlbHBlcnMuZm9udFN0cmluZyhmb250U2l6ZSwgZm9udFN0eWxlLCBmb250RmFtaWx5KTsKCgkJcmV0dXJuIHsKCQkJc2l6ZTogZm9udFNpemUsCgkJCXN0eWxlOiBmb250U3R5bGUsCgkJCWZhbWlseTogZm9udEZhbWlseSwKCQkJZm9udDogZm9udAoJCX07Cgl9CgoJZnVuY3Rpb24gbWVhc3VyZUxhYmVsU2l6ZShjdHgsIGZvbnRTaXplLCBsYWJlbCkgewoJCWlmIChoZWxwZXJzLmlzQXJyYXkobGFiZWwpKSB7CgkJCXJldHVybiB7CgkJCQl3OiBoZWxwZXJzLmxvbmdlc3RUZXh0KGN0eCwgY3R4LmZvbnQsIGxhYmVsKSwKCQkJCWg6IChsYWJlbC5sZW5ndGggKiBmb250U2l6ZSkgKyAoKGxhYmVsLmxlbmd0aCAtIDEpICogMS41ICogZm9udFNpemUpCgkJCX07CgkJfQoKCQlyZXR1cm4gewoJCQl3OiBjdHgubWVhc3VyZVRleHQobGFiZWwpLndpZHRoLAoJCQloOiBmb250U2l6ZQoJCX07Cgl9CgoJZnVuY3Rpb24gZGV0ZXJtaW5lTGltaXRzKGFuZ2xlLCBwb3MsIHNpemUsIG1pbiwgbWF4KSB7CgkJaWYgKGFuZ2xlID09PSBtaW4gfHwgYW5nbGUgPT09IG1heCkgewoJCQlyZXR1cm4gewoJCQkJc3RhcnQ6IHBvcyAtIChzaXplIC8gMiksCgkJCQllbmQ6IHBvcyArIChzaXplIC8gMikKCQkJfTsKCQl9IGVsc2UgaWYgKGFuZ2xlIDwgbWluIHx8IGFuZ2xlID4gbWF4KSB7CgkJCXJldHVybiB7CgkJCQlzdGFydDogcG9zIC0gc2l6ZSAtIDUsCgkJCQllbmQ6IHBvcwoJCQl9OwoJCX0KCgkJcmV0dXJuIHsKCQkJc3RhcnQ6IHBvcywKCQkJZW5kOiBwb3MgKyBzaXplICsgNQoJCX07Cgl9CgoJLyoqCgkgKiBIZWxwZXIgZnVuY3Rpb24gdG8gZml0IGEgcmFkaWFsIGxpbmVhciBzY2FsZSB3aXRoIHBvaW50IGxhYmVscwoJICovCglmdW5jdGlvbiBmaXRXaXRoUG9pbnRMYWJlbHMoc2NhbGUpIHsKCQkvKgoJCSAqIFJpZ2h0LCB0aGlzIGlzIHJlYWxseSBjb25mdXNpbmcgYW5kIHRoZXJlIGlzIGEgbG90IG9mIG1hdGhzIGdvaW5nIG9uIGhlcmUKCQkgKiBUaGUgZ2lzdCBvZiB0aGUgcHJvYmxlbSBpcyBoZXJlOiBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9ubm5pY2svNjk2Y2M5YzU1ZjRiMGJlYjhmZTkKCQkgKgoJCSAqIFJlYWN0aW9uOiBodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vdS8zNDYwMTM2My90b29tdWNoc2NpZW5jZS5naWYKCQkgKgoJCSAqIFNvbHV0aW9uOgoJCSAqCgkJICogV2UgYXNzdW1lIHRoZSByYWRpdXMgb2YgdGhlIHBvbHlnb24gaXMgaGFsZiB0aGUgc2l6ZSBvZiB0aGUgY2FudmFzIGF0IGZpcnN0CgkJICogYXQgZWFjaCBpbmRleCB3ZSBjaGVjayBpZiB0aGUgdGV4dCBvdmVybGFwcy4KCQkgKgoJCSAqIFdoZXJlIGl0IGRvZXMsIHdlIHN0b3JlIHRoYXQgYW5nbGUgYW5kIHRoYXQgaW5kZXguCgkJICoKCQkgKiBBZnRlciBmaW5kaW5nIHRoZSBsYXJnZXN0IGluZGV4IGFuZCBhbmdsZSB3ZSBjYWxjdWxhdGUgaG93IG11Y2ggd2UgbmVlZCB0byByZW1vdmUKCQkgKiBmcm9tIHRoZSBzaGFwZSByYWRpdXMgdG8gbW92ZSB0aGUgcG9pbnQgaW53YXJkcyBieSB0aGF0IHguCgkJICoKCQkgKiBXZSBhdmVyYWdlIHRoZSBsZWZ0IGFuZCByaWdodCBkaXN0YW5jZXMgdG8gZ2V0IHRoZSBtYXhpbXVtIHNoYXBlIHJhZGl1cyB0aGF0IGNhbiBmaXQgaW4gdGhlIGJveAoJCSAqIGFsb25nIHdpdGggbGFiZWxzLgoJCSAqCgkJICogT25jZSB3ZSBoYXZlIHRoYXQsIHdlIGNhbiBmaW5kIHRoZSBjZW50cmUgcG9pbnQgZm9yIHRoZSBjaGFydCwgYnkgdGFraW5nIHRoZSB4IHRleHQgcHJvdHJ1c2lvbgoJCSAqIG9uIGVhY2ggc2lkZSwgcmVtb3ZpbmcgdGhhdCBmcm9tIHRoZSBzaXplLCBoYWx2aW5nIGl0IGFuZCBhZGRpbmcgdGhlIGxlZnQgeCBwcm90cnVzaW9uIHdpZHRoLgoJCSAqCgkJICogVGhpcyB3aWxsIG1lYW4gd2UgaGF2ZSBhIHNoYXBlIGZpdHRlZCB0byB0aGUgY2FudmFzLCBhcyBsYXJnZSBhcyBpdCBjYW4gYmUgd2l0aCB0aGUgbGFiZWxzCgkJICogYW5kIHBvc2l0aW9uIGl0IGluIHRoZSBtb3N0IHNwYWNlIGVmZmljaWVudCBtYW5uZXIKCQkgKgoJCSAqIGh0dHBzOi8vZGwuZHJvcGJveHVzZXJjb250ZW50LmNvbS91LzM0NjAxMzYzL3llYWhzY2llbmNlLmdpZgoJCSAqLwoKCQl2YXIgcGxGb250ID0gZ2V0UG9pbnRMYWJlbEZvbnRPcHRpb25zKHNjYWxlKTsKCgkJLy8gR2V0IG1heGltdW0gcmFkaXVzIG9mIHRoZSBwb2x5Z29uLiBFaXRoZXIgaGFsZiB0aGUgaGVpZ2h0IChtaW51cyB0aGUgdGV4dCB3aWR0aCkgb3IgaGFsZiB0aGUgd2lkdGguCgkJLy8gVXNlIHRoaXMgdG8gY2FsY3VsYXRlIHRoZSBvZmZzZXQgKyBjaGFuZ2UuIC0gTWFrZSBzdXJlIEwvUiBwcm90cnVzaW9uIGlzIGF0IGxlYXN0IDAgdG8gc3RvcCBpc3N1ZXMgd2l0aCBjZW50cmUgcG9pbnRzCgkJdmFyIGxhcmdlc3RQb3NzaWJsZVJhZGl1cyA9IE1hdGgubWluKHNjYWxlLmhlaWdodCAvIDIsIHNjYWxlLndpZHRoIC8gMik7CgkJdmFyIGZ1cnRoZXN0TGltaXRzID0gewoJCQlyOiBzY2FsZS53aWR0aCwKCQkJbDogMCwKCQkJdDogc2NhbGUuaGVpZ2h0LAoJCQliOiAwCgkJfTsKCQl2YXIgZnVydGhlc3RBbmdsZXMgPSB7fTsKCQl2YXIgaSwgdGV4dFNpemUsIHBvaW50UG9zaXRpb247CgoJCXNjYWxlLmN0eC5mb250ID0gcGxGb250LmZvbnQ7CgkJc2NhbGUuX3BvaW50TGFiZWxTaXplcyA9IFtdOwoKCQl2YXIgdmFsdWVDb3VudCA9IGdldFZhbHVlQ291bnQoc2NhbGUpOwoJCWZvciAoaSA9IDA7IGkgPCB2YWx1ZUNvdW50OyBpKyspIHsKCQkJcG9pbnRQb3NpdGlvbiA9IHNjYWxlLmdldFBvaW50UG9zaXRpb24oaSwgbGFyZ2VzdFBvc3NpYmxlUmFkaXVzKTsKCQkJdGV4dFNpemUgPSBtZWFzdXJlTGFiZWxTaXplKHNjYWxlLmN0eCwgcGxGb250LnNpemUsIHNjYWxlLnBvaW50TGFiZWxzW2ldIHx8ICcnKTsKCQkJc2NhbGUuX3BvaW50TGFiZWxTaXplc1tpXSA9IHRleHRTaXplOwoKCQkJLy8gQWRkIHF1YXJ0ZXIgY2lyY2xlIHRvIG1ha2UgZGVncmVlIDAgbWVhbiB0b3Agb2YgY2lyY2xlCgkJCXZhciBhbmdsZVJhZGlhbnMgPSBzY2FsZS5nZXRJbmRleEFuZ2xlKGkpOwoJCQl2YXIgYW5nbGUgPSBoZWxwZXJzLnRvRGVncmVlcyhhbmdsZVJhZGlhbnMpICUgMzYwOwoJCQl2YXIgaExpbWl0cyA9IGRldGVybWluZUxpbWl0cyhhbmdsZSwgcG9pbnRQb3NpdGlvbi54LCB0ZXh0U2l6ZS53LCAwLCAxODApOwoJCQl2YXIgdkxpbWl0cyA9IGRldGVybWluZUxpbWl0cyhhbmdsZSwgcG9pbnRQb3NpdGlvbi55LCB0ZXh0U2l6ZS5oLCA5MCwgMjcwKTsKCgkJCWlmIChoTGltaXRzLnN0YXJ0IDwgZnVydGhlc3RMaW1pdHMubCkgewoJCQkJZnVydGhlc3RMaW1pdHMubCA9IGhMaW1pdHMuc3RhcnQ7CgkJCQlmdXJ0aGVzdEFuZ2xlcy5sID0gYW5nbGVSYWRpYW5zOwoJCQl9CgoJCQlpZiAoaExpbWl0cy5lbmQgPiBmdXJ0aGVzdExpbWl0cy5yKSB7CgkJCQlmdXJ0aGVzdExpbWl0cy5yID0gaExpbWl0cy5lbmQ7CgkJCQlmdXJ0aGVzdEFuZ2xlcy5yID0gYW5nbGVSYWRpYW5zOwoJCQl9CgoJCQlpZiAodkxpbWl0cy5zdGFydCA8IGZ1cnRoZXN0TGltaXRzLnQpIHsKCQkJCWZ1cnRoZXN0TGltaXRzLnQgPSB2TGltaXRzLnN0YXJ0OwoJCQkJZnVydGhlc3RBbmdsZXMudCA9IGFuZ2xlUmFkaWFuczsKCQkJfQoKCQkJaWYgKHZMaW1pdHMuZW5kID4gZnVydGhlc3RMaW1pdHMuYikgewoJCQkJZnVydGhlc3RMaW1pdHMuYiA9IHZMaW1pdHMuZW5kOwoJCQkJZnVydGhlc3RBbmdsZXMuYiA9IGFuZ2xlUmFkaWFuczsKCQkJfQoJCX0KCgkJc2NhbGUuc2V0UmVkdWN0aW9ucyhsYXJnZXN0UG9zc2libGVSYWRpdXMsIGZ1cnRoZXN0TGltaXRzLCBmdXJ0aGVzdEFuZ2xlcyk7Cgl9CgoJLyoqCgkgKiBIZWxwZXIgZnVuY3Rpb24gdG8gZml0IGEgcmFkaWFsIGxpbmVhciBzY2FsZSB3aXRoIG5vIHBvaW50IGxhYmVscwoJICovCglmdW5jdGlvbiBmaXQoc2NhbGUpIHsKCQl2YXIgbGFyZ2VzdFBvc3NpYmxlUmFkaXVzID0gTWF0aC5taW4oc2NhbGUuaGVpZ2h0IC8gMiwgc2NhbGUud2lkdGggLyAyKTsKCQlzY2FsZS5kcmF3aW5nQXJlYSA9IE1hdGgucm91bmQobGFyZ2VzdFBvc3NpYmxlUmFkaXVzKTsKCQlzY2FsZS5zZXRDZW50ZXJQb2ludCgwLCAwLCAwLCAwKTsKCX0KCglmdW5jdGlvbiBnZXRUZXh0QWxpZ25Gb3JBbmdsZShhbmdsZSkgewoJCWlmIChhbmdsZSA9PT0gMCB8fCBhbmdsZSA9PT0gMTgwKSB7CgkJCXJldHVybiAnY2VudGVyJzsKCQl9IGVsc2UgaWYgKGFuZ2xlIDwgMTgwKSB7CgkJCXJldHVybiAnbGVmdCc7CgkJfQoKCQlyZXR1cm4gJ3JpZ2h0JzsKCX0KCglmdW5jdGlvbiBmaWxsVGV4dChjdHgsIHRleHQsIHBvc2l0aW9uLCBmb250U2l6ZSkgewoJCWlmIChoZWxwZXJzLmlzQXJyYXkodGV4dCkpIHsKCQkJdmFyIHkgPSBwb3NpdGlvbi55OwoJCQl2YXIgc3BhY2luZyA9IDEuNSAqIGZvbnRTaXplOwoKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCB0ZXh0Lmxlbmd0aDsgKytpKSB7CgkJCQljdHguZmlsbFRleHQodGV4dFtpXSwgcG9zaXRpb24ueCwgeSk7CgkJCQl5ICs9IHNwYWNpbmc7CgkJCX0KCQl9IGVsc2UgewoJCQljdHguZmlsbFRleHQodGV4dCwgcG9zaXRpb24ueCwgcG9zaXRpb24ueSk7CgkJfQoJfQoKCWZ1bmN0aW9uIGFkanVzdFBvaW50UG9zaXRpb25Gb3JMYWJlbEhlaWdodChhbmdsZSwgdGV4dFNpemUsIHBvc2l0aW9uKSB7CgkJaWYgKGFuZ2xlID09PSA5MCB8fCBhbmdsZSA9PT0gMjcwKSB7CgkJCXBvc2l0aW9uLnkgLT0gKHRleHRTaXplLmggLyAyKTsKCQl9IGVsc2UgaWYgKGFuZ2xlID4gMjcwIHx8IGFuZ2xlIDwgOTApIHsKCQkJcG9zaXRpb24ueSAtPSB0ZXh0U2l6ZS5oOwoJCX0KCX0KCglmdW5jdGlvbiBkcmF3UG9pbnRMYWJlbHMoc2NhbGUpIHsKCQl2YXIgY3R4ID0gc2NhbGUuY3R4OwoJCXZhciBvcHRzID0gc2NhbGUub3B0aW9uczsKCQl2YXIgYW5nbGVMaW5lT3B0cyA9IG9wdHMuYW5nbGVMaW5lczsKCQl2YXIgcG9pbnRMYWJlbE9wdHMgPSBvcHRzLnBvaW50TGFiZWxzOwoKCQljdHgubGluZVdpZHRoID0gYW5nbGVMaW5lT3B0cy5saW5lV2lkdGg7CgkJY3R4LnN0cm9rZVN0eWxlID0gYW5nbGVMaW5lT3B0cy5jb2xvcjsKCgkJdmFyIG91dGVyRGlzdGFuY2UgPSBzY2FsZS5nZXREaXN0YW5jZUZyb21DZW50ZXJGb3JWYWx1ZShvcHRzLnRpY2tzLnJldmVyc2UgPyBzY2FsZS5taW4gOiBzY2FsZS5tYXgpOwoKCQkvLyBQb2ludCBMYWJlbCBGb250CgkJdmFyIHBsRm9udCA9IGdldFBvaW50TGFiZWxGb250T3B0aW9ucyhzY2FsZSk7CgoJCWN0eC50ZXh0QmFzZWxpbmUgPSAndG9wJzsKCgkJZm9yICh2YXIgaSA9IGdldFZhbHVlQ291bnQoc2NhbGUpIC0gMTsgaSA+PSAwOyBpLS0pIHsKCQkJaWYgKGFuZ2xlTGluZU9wdHMuZGlzcGxheSkgewoJCQkJdmFyIG91dGVyUG9zaXRpb24gPSBzY2FsZS5nZXRQb2ludFBvc2l0aW9uKGksIG91dGVyRGlzdGFuY2UpOwoJCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQkJY3R4Lm1vdmVUbyhzY2FsZS54Q2VudGVyLCBzY2FsZS55Q2VudGVyKTsKCQkJCWN0eC5saW5lVG8ob3V0ZXJQb3NpdGlvbi54LCBvdXRlclBvc2l0aW9uLnkpOwoJCQkJY3R4LnN0cm9rZSgpOwoJCQkJY3R4LmNsb3NlUGF0aCgpOwoJCQl9CgoJCQlpZiAocG9pbnRMYWJlbE9wdHMuZGlzcGxheSkgewoJCQkJLy8gRXh0cmEgM3B4IG91dCBmb3Igc29tZSBsYWJlbCBzcGFjaW5nCgkJCQl2YXIgcG9pbnRMYWJlbFBvc2l0aW9uID0gc2NhbGUuZ2V0UG9pbnRQb3NpdGlvbihpLCBvdXRlckRpc3RhbmNlICsgNSk7CgoJCQkJLy8gS2VlcCB0aGlzIGluIGxvb3Agc2luY2Ugd2UgbWF5IHN1cHBvcnQgYXJyYXkgcHJvcGVydGllcyBoZXJlCgkJCQl2YXIgcG9pbnRMYWJlbEZvbnRDb2xvciA9IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KHBvaW50TGFiZWxPcHRzLmZvbnRDb2xvciwgaSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRDb2xvcik7CgkJCQljdHguZm9udCA9IHBsRm9udC5mb250OwoJCQkJY3R4LmZpbGxTdHlsZSA9IHBvaW50TGFiZWxGb250Q29sb3I7CgoJCQkJdmFyIGFuZ2xlUmFkaWFucyA9IHNjYWxlLmdldEluZGV4QW5nbGUoaSk7CgkJCQl2YXIgYW5nbGUgPSBoZWxwZXJzLnRvRGVncmVlcyhhbmdsZVJhZGlhbnMpOwoJCQkJY3R4LnRleHRBbGlnbiA9IGdldFRleHRBbGlnbkZvckFuZ2xlKGFuZ2xlKTsKCQkJCWFkanVzdFBvaW50UG9zaXRpb25Gb3JMYWJlbEhlaWdodChhbmdsZSwgc2NhbGUuX3BvaW50TGFiZWxTaXplc1tpXSwgcG9pbnRMYWJlbFBvc2l0aW9uKTsKCQkJCWZpbGxUZXh0KGN0eCwgc2NhbGUucG9pbnRMYWJlbHNbaV0gfHwgJycsIHBvaW50TGFiZWxQb3NpdGlvbiwgcGxGb250LnNpemUpOwoJCQl9CgkJfQoJfQoKCWZ1bmN0aW9uIGRyYXdSYWRpdXNMaW5lKHNjYWxlLCBncmlkTGluZU9wdHMsIHJhZGl1cywgaW5kZXgpIHsKCQl2YXIgY3R4ID0gc2NhbGUuY3R4OwoJCWN0eC5zdHJva2VTdHlsZSA9IGhlbHBlcnMudmFsdWVBdEluZGV4T3JEZWZhdWx0KGdyaWRMaW5lT3B0cy5jb2xvciwgaW5kZXggLSAxKTsKCQljdHgubGluZVdpZHRoID0gaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQoZ3JpZExpbmVPcHRzLmxpbmVXaWR0aCwgaW5kZXggLSAxKTsKCgkJaWYgKHNjYWxlLm9wdGlvbnMuZ3JpZExpbmVzLmNpcmN1bGFyKSB7CgkJCS8vIERyYXcgY2lyY3VsYXIgYXJjcyBiZXR3ZWVuIHRoZSBwb2ludHMKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQljdHguYXJjKHNjYWxlLnhDZW50ZXIsIHNjYWxlLnlDZW50ZXIsIHJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwoJCQljdHguY2xvc2VQYXRoKCk7CgkJCWN0eC5zdHJva2UoKTsKCQl9IGVsc2UgewoJCQkvLyBEcmF3IHN0cmFpZ2h0IGxpbmVzIGNvbm5lY3RpbmcgZWFjaCBpbmRleAoJCQl2YXIgdmFsdWVDb3VudCA9IGdldFZhbHVlQ291bnQoc2NhbGUpOwoKCQkJaWYgKHZhbHVlQ291bnQgPT09IDApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJY3R4LmJlZ2luUGF0aCgpOwoJCQl2YXIgcG9pbnRQb3NpdGlvbiA9IHNjYWxlLmdldFBvaW50UG9zaXRpb24oMCwgcmFkaXVzKTsKCQkJY3R4Lm1vdmVUbyhwb2ludFBvc2l0aW9uLngsIHBvaW50UG9zaXRpb24ueSk7CgoJCQlmb3IgKHZhciBpID0gMTsgaSA8IHZhbHVlQ291bnQ7IGkrKykgewoJCQkJcG9pbnRQb3NpdGlvbiA9IHNjYWxlLmdldFBvaW50UG9zaXRpb24oaSwgcmFkaXVzKTsKCQkJCWN0eC5saW5lVG8ocG9pbnRQb3NpdGlvbi54LCBwb2ludFBvc2l0aW9uLnkpOwoJCQl9CgoJCQljdHguY2xvc2VQYXRoKCk7CgkJCWN0eC5zdHJva2UoKTsKCQl9Cgl9CgoJZnVuY3Rpb24gbnVtYmVyT3JaZXJvKHBhcmFtKSB7CgkJcmV0dXJuIGhlbHBlcnMuaXNOdW1iZXIocGFyYW0pID8gcGFyYW0gOiAwOwoJfQoKCXZhciBMaW5lYXJSYWRpYWxTY2FsZSA9IENoYXJ0LkxpbmVhclNjYWxlQmFzZS5leHRlbmQoewoJCXNldERpbWVuc2lvbnM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CgkJCXZhciB0aWNrT3B0cyA9IG9wdHMudGlja3M7CgkJCS8vIFNldCB0aGUgdW5jb25zdHJhaW5lZCBkaW1lbnNpb24gYmVmb3JlIGxhYmVsIHJvdGF0aW9uCgkJCW1lLndpZHRoID0gbWUubWF4V2lkdGg7CgkJCW1lLmhlaWdodCA9IG1lLm1heEhlaWdodDsKCQkJbWUueENlbnRlciA9IE1hdGgucm91bmQobWUud2lkdGggLyAyKTsKCQkJbWUueUNlbnRlciA9IE1hdGgucm91bmQobWUuaGVpZ2h0IC8gMik7CgoJCQl2YXIgbWluU2l6ZSA9IGhlbHBlcnMubWluKFttZS5oZWlnaHQsIG1lLndpZHRoXSk7CgkJCXZhciB0aWNrRm9udFNpemUgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHRpY2tPcHRzLmZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpOwoJCQltZS5kcmF3aW5nQXJlYSA9IG9wdHMuZGlzcGxheSA/IChtaW5TaXplIC8gMikgLSAodGlja0ZvbnRTaXplIC8gMiArIHRpY2tPcHRzLmJhY2tkcm9wUGFkZGluZ1kpIDogKG1pblNpemUgLyAyKTsKCQl9LAoJCWRldGVybWluZURhdGFMaW1pdHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgY2hhcnQgPSBtZS5jaGFydDsKCQkJdmFyIG1pbiA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKCQkJdmFyIG1heCA9IE51bWJlci5ORUdBVElWRV9JTkZJTklUWTsKCgkJCWhlbHBlcnMuZWFjaChjaGFydC5kYXRhLmRhdGFzZXRzLCBmdW5jdGlvbihkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHsKCQkJCWlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkpIHsKCQkJCQl2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7CgoJCQkJCWhlbHBlcnMuZWFjaChkYXRhc2V0LmRhdGEsIGZ1bmN0aW9uKHJhd1ZhbHVlLCBpbmRleCkgewoJCQkJCQl2YXIgdmFsdWUgPSArbWUuZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZSk7CgkJCQkJCWlmIChpc05hTih2YWx1ZSkgfHwgbWV0YS5kYXRhW2luZGV4XS5oaWRkZW4pIHsKCQkJCQkJCXJldHVybjsKCQkJCQkJfQoKCQkJCQkJbWluID0gTWF0aC5taW4odmFsdWUsIG1pbik7CgkJCQkJCW1heCA9IE1hdGgubWF4KHZhbHVlLCBtYXgpOwoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCgkJCW1lLm1pbiA9IChtaW4gPT09IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSA/IDAgOiBtaW4pOwoJCQltZS5tYXggPSAobWF4ID09PSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgPyAwIDogbWF4KTsKCgkJCS8vIENvbW1vbiBiYXNlIGltcGxlbWVudGF0aW9uIHRvIGhhbmRsZSB0aWNrcy5taW4sIHRpY2tzLm1heCwgdGlja3MuYmVnaW5BdFplcm8KCQkJbWUuaGFuZGxlVGlja1JhbmdlT3B0aW9ucygpOwoJCX0sCgkJZ2V0VGlja0xpbWl0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHRpY2tPcHRzID0gdGhpcy5vcHRpb25zLnRpY2tzOwoJCQl2YXIgdGlja0ZvbnRTaXplID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdCh0aWNrT3B0cy5mb250U2l6ZSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRTaXplKTsKCQkJcmV0dXJuIE1hdGgubWluKHRpY2tPcHRzLm1heFRpY2tzTGltaXQgPyB0aWNrT3B0cy5tYXhUaWNrc0xpbWl0IDogMTEsIE1hdGguY2VpbCh0aGlzLmRyYXdpbmdBcmVhIC8gKDEuNSAqIHRpY2tGb250U2l6ZSkpKTsKCQl9LAoJCWNvbnZlcnRUaWNrc1RvTGFiZWxzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCgkJCUNoYXJ0LkxpbmVhclNjYWxlQmFzZS5wcm90b3R5cGUuY29udmVydFRpY2tzVG9MYWJlbHMuY2FsbChtZSk7CgoJCQkvLyBQb2ludCBsYWJlbHMKCQkJbWUucG9pbnRMYWJlbHMgPSBtZS5jaGFydC5kYXRhLmxhYmVscy5tYXAobWUub3B0aW9ucy5wb2ludExhYmVscy5jYWxsYmFjaywgbWUpOwoJCX0sCgkJZ2V0TGFiZWxGb3JJbmRleDogZnVuY3Rpb24oaW5kZXgsIGRhdGFzZXRJbmRleCkgewoJCQlyZXR1cm4gK3RoaXMuZ2V0UmlnaHRWYWx1ZSh0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhW2luZGV4XSk7CgkJfSwKCQlmaXQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAodGhpcy5vcHRpb25zLnBvaW50TGFiZWxzLmRpc3BsYXkpIHsKCQkJCWZpdFdpdGhQb2ludExhYmVscyh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCWZpdCh0aGlzKTsKCQkJfQoJCX0sCgkJLyoqCgkJICogU2V0IHJhZGl1cyByZWR1Y3Rpb25zIGFuZCBkZXRlcm1pbmUgbmV3IHJhZGl1cyBhbmQgY2VudGVyIHBvaW50CgkJICogQHByaXZhdGUKCQkgKi8KCQlzZXRSZWR1Y3Rpb25zOiBmdW5jdGlvbihsYXJnZXN0UG9zc2libGVSYWRpdXMsIGZ1cnRoZXN0TGltaXRzLCBmdXJ0aGVzdEFuZ2xlcykgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgcmFkaXVzUmVkdWN0aW9uTGVmdCA9IGZ1cnRoZXN0TGltaXRzLmwgLyBNYXRoLnNpbihmdXJ0aGVzdEFuZ2xlcy5sKTsKCQkJdmFyIHJhZGl1c1JlZHVjdGlvblJpZ2h0ID0gTWF0aC5tYXgoZnVydGhlc3RMaW1pdHMuciAtIG1lLndpZHRoLCAwKSAvIE1hdGguc2luKGZ1cnRoZXN0QW5nbGVzLnIpOwoJCQl2YXIgcmFkaXVzUmVkdWN0aW9uVG9wID0gLWZ1cnRoZXN0TGltaXRzLnQgLyBNYXRoLmNvcyhmdXJ0aGVzdEFuZ2xlcy50KTsKCQkJdmFyIHJhZGl1c1JlZHVjdGlvbkJvdHRvbSA9IC1NYXRoLm1heChmdXJ0aGVzdExpbWl0cy5iIC0gbWUuaGVpZ2h0LCAwKSAvIE1hdGguY29zKGZ1cnRoZXN0QW5nbGVzLmIpOwoKCQkJcmFkaXVzUmVkdWN0aW9uTGVmdCA9IG51bWJlck9yWmVybyhyYWRpdXNSZWR1Y3Rpb25MZWZ0KTsKCQkJcmFkaXVzUmVkdWN0aW9uUmlnaHQgPSBudW1iZXJPclplcm8ocmFkaXVzUmVkdWN0aW9uUmlnaHQpOwoJCQlyYWRpdXNSZWR1Y3Rpb25Ub3AgPSBudW1iZXJPclplcm8ocmFkaXVzUmVkdWN0aW9uVG9wKTsKCQkJcmFkaXVzUmVkdWN0aW9uQm90dG9tID0gbnVtYmVyT3JaZXJvKHJhZGl1c1JlZHVjdGlvbkJvdHRvbSk7CgoJCQltZS5kcmF3aW5nQXJlYSA9IE1hdGgubWluKAoJCQkJTWF0aC5yb3VuZChsYXJnZXN0UG9zc2libGVSYWRpdXMgLSAocmFkaXVzUmVkdWN0aW9uTGVmdCArIHJhZGl1c1JlZHVjdGlvblJpZ2h0KSAvIDIpLAoJCQkJTWF0aC5yb3VuZChsYXJnZXN0UG9zc2libGVSYWRpdXMgLSAocmFkaXVzUmVkdWN0aW9uVG9wICsgcmFkaXVzUmVkdWN0aW9uQm90dG9tKSAvIDIpKTsKCQkJbWUuc2V0Q2VudGVyUG9pbnQocmFkaXVzUmVkdWN0aW9uTGVmdCwgcmFkaXVzUmVkdWN0aW9uUmlnaHQsIHJhZGl1c1JlZHVjdGlvblRvcCwgcmFkaXVzUmVkdWN0aW9uQm90dG9tKTsKCQl9LAoJCXNldENlbnRlclBvaW50OiBmdW5jdGlvbihsZWZ0TW92ZW1lbnQsIHJpZ2h0TW92ZW1lbnQsIHRvcE1vdmVtZW50LCBib3R0b21Nb3ZlbWVudCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbWF4UmlnaHQgPSBtZS53aWR0aCAtIHJpZ2h0TW92ZW1lbnQgLSBtZS5kcmF3aW5nQXJlYTsKCQkJdmFyIG1heExlZnQgPSBsZWZ0TW92ZW1lbnQgKyBtZS5kcmF3aW5nQXJlYTsKCQkJdmFyIG1heFRvcCA9IHRvcE1vdmVtZW50ICsgbWUuZHJhd2luZ0FyZWE7CgkJCXZhciBtYXhCb3R0b20gPSBtZS5oZWlnaHQgLSBib3R0b21Nb3ZlbWVudCAtIG1lLmRyYXdpbmdBcmVhOwoKCQkJbWUueENlbnRlciA9IE1hdGgucm91bmQoKChtYXhMZWZ0ICsgbWF4UmlnaHQpIC8gMikgKyBtZS5sZWZ0KTsKCQkJbWUueUNlbnRlciA9IE1hdGgucm91bmQoKChtYXhUb3AgKyBtYXhCb3R0b20pIC8gMikgKyBtZS50b3ApOwoJCX0sCgoJCWdldEluZGV4QW5nbGU6IGZ1bmN0aW9uKGluZGV4KSB7CgkJCXZhciBhbmdsZU11bHRpcGxpZXIgPSAoTWF0aC5QSSAqIDIpIC8gZ2V0VmFsdWVDb3VudCh0aGlzKTsKCQkJdmFyIHN0YXJ0QW5nbGUgPSB0aGlzLmNoYXJ0Lm9wdGlvbnMgJiYgdGhpcy5jaGFydC5vcHRpb25zLnN0YXJ0QW5nbGUgPwoJCQkJdGhpcy5jaGFydC5vcHRpb25zLnN0YXJ0QW5nbGUgOgoJCQkJMDsKCgkJCXZhciBzdGFydEFuZ2xlUmFkaWFucyA9IHN0YXJ0QW5nbGUgKiBNYXRoLlBJICogMiAvIDM2MDsKCgkJCS8vIFN0YXJ0IGZyb20gdGhlIHRvcCBpbnN0ZWFkIG9mIHJpZ2h0LCBzbyByZW1vdmUgYSBxdWFydGVyIG9mIHRoZSBjaXJjbGUKCQkJcmV0dXJuIGluZGV4ICogYW5nbGVNdWx0aXBsaWVyICsgc3RhcnRBbmdsZVJhZGlhbnM7CgkJfSwKCQlnZXREaXN0YW5jZUZyb21DZW50ZXJGb3JWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKCQkJdmFyIG1lID0gdGhpczsKCgkJCWlmICh2YWx1ZSA9PT0gbnVsbCkgewoJCQkJcmV0dXJuIDA7IC8vIG51bGwgYWx3YXlzIGluIGNlbnRlcgoJCQl9CgoJCQkvLyBUYWtlIGludG8gYWNjb3VudCBoYWxmIGZvbnQgc2l6ZSArIHRoZSB5UGFkZGluZyBvZiB0aGUgdG9wIHZhbHVlCgkJCXZhciBzY2FsaW5nRmFjdG9yID0gbWUuZHJhd2luZ0FyZWEgLyAobWUubWF4IC0gbWUubWluKTsKCQkJaWYgKG1lLm9wdGlvbnMudGlja3MucmV2ZXJzZSkgewoJCQkJcmV0dXJuIChtZS5tYXggLSB2YWx1ZSkgKiBzY2FsaW5nRmFjdG9yOwoJCQl9CgkJCXJldHVybiAodmFsdWUgLSBtZS5taW4pICogc2NhbGluZ0ZhY3RvcjsKCQl9LAoJCWdldFBvaW50UG9zaXRpb246IGZ1bmN0aW9uKGluZGV4LCBkaXN0YW5jZUZyb21DZW50ZXIpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIHRoaXNBbmdsZSA9IG1lLmdldEluZGV4QW5nbGUoaW5kZXgpIC0gKE1hdGguUEkgLyAyKTsKCQkJcmV0dXJuIHsKCQkJCXg6IE1hdGgucm91bmQoTWF0aC5jb3ModGhpc0FuZ2xlKSAqIGRpc3RhbmNlRnJvbUNlbnRlcikgKyBtZS54Q2VudGVyLAoJCQkJeTogTWF0aC5yb3VuZChNYXRoLnNpbih0aGlzQW5nbGUpICogZGlzdGFuY2VGcm9tQ2VudGVyKSArIG1lLnlDZW50ZXIKCQkJfTsKCQl9LAoJCWdldFBvaW50UG9zaXRpb25Gb3JWYWx1ZTogZnVuY3Rpb24oaW5kZXgsIHZhbHVlKSB7CgkJCXJldHVybiB0aGlzLmdldFBvaW50UG9zaXRpb24oaW5kZXgsIHRoaXMuZ2V0RGlzdGFuY2VGcm9tQ2VudGVyRm9yVmFsdWUodmFsdWUpKTsKCQl9LAoKCQlnZXRCYXNlUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgbWUgPSB0aGlzOwoJCQl2YXIgbWluID0gbWUubWluOwoJCQl2YXIgbWF4ID0gbWUubWF4OwoKCQkJcmV0dXJuIG1lLmdldFBvaW50UG9zaXRpb25Gb3JWYWx1ZSgwLAoJCQkJbWUuYmVnaW5BdFplcm8gPyAwIDoKCQkJCW1pbiA8IDAgJiYgbWF4IDwgMCA/IG1heCA6CgkJCQltaW4gPiAwICYmIG1heCA+IDAgPyBtaW4gOgoJCQkJMCk7CgkJfSwKCgkJZHJhdzogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBvcHRzID0gbWUub3B0aW9uczsKCQkJdmFyIGdyaWRMaW5lT3B0cyA9IG9wdHMuZ3JpZExpbmVzOwoJCQl2YXIgdGlja09wdHMgPSBvcHRzLnRpY2tzOwoJCQl2YXIgdmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0OwoKCQkJaWYgKG9wdHMuZGlzcGxheSkgewoJCQkJdmFyIGN0eCA9IG1lLmN0eDsKCQkJCXZhciBzdGFydEFuZ2xlID0gdGhpcy5nZXRJbmRleEFuZ2xlKDApOwoKCQkJCS8vIFRpY2sgRm9udAoJCQkJdmFyIHRpY2tGb250U2l6ZSA9IHZhbHVlT3JEZWZhdWx0KHRpY2tPcHRzLmZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpOwoJCQkJdmFyIHRpY2tGb250U3R5bGUgPSB2YWx1ZU9yRGVmYXVsdCh0aWNrT3B0cy5mb250U3R5bGUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U3R5bGUpOwoJCQkJdmFyIHRpY2tGb250RmFtaWx5ID0gdmFsdWVPckRlZmF1bHQodGlja09wdHMuZm9udEZhbWlseSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRGYW1pbHkpOwoJCQkJdmFyIHRpY2tMYWJlbEZvbnQgPSBoZWxwZXJzLmZvbnRTdHJpbmcodGlja0ZvbnRTaXplLCB0aWNrRm9udFN0eWxlLCB0aWNrRm9udEZhbWlseSk7CgoJCQkJaGVscGVycy5lYWNoKG1lLnRpY2tzLCBmdW5jdGlvbihsYWJlbCwgaW5kZXgpIHsKCQkJCQkvLyBEb24ndCBkcmF3IGEgY2VudHJlIHZhbHVlIChpZiBpdCBpcyBtaW5pbXVtKQoJCQkJCWlmIChpbmRleCA+IDAgfHwgdGlja09wdHMucmV2ZXJzZSkgewoJCQkJCQl2YXIgeUNlbnRlck9mZnNldCA9IG1lLmdldERpc3RhbmNlRnJvbUNlbnRlckZvclZhbHVlKG1lLnRpY2tzQXNOdW1iZXJzW2luZGV4XSk7CgoJCQkJCQkvLyBEcmF3IGNpcmN1bGFyIGxpbmVzIGFyb3VuZCB0aGUgc2NhbGUKCQkJCQkJaWYgKGdyaWRMaW5lT3B0cy5kaXNwbGF5ICYmIGluZGV4ICE9PSAwKSB7CgkJCQkJCQlkcmF3UmFkaXVzTGluZShtZSwgZ3JpZExpbmVPcHRzLCB5Q2VudGVyT2Zmc2V0LCBpbmRleCk7CgkJCQkJCX0KCgkJCQkJCWlmICh0aWNrT3B0cy5kaXNwbGF5KSB7CgkJCQkJCQl2YXIgdGlja0ZvbnRDb2xvciA9IHZhbHVlT3JEZWZhdWx0KHRpY2tPcHRzLmZvbnRDb2xvciwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRDb2xvcik7CgkJCQkJCQljdHguZm9udCA9IHRpY2tMYWJlbEZvbnQ7CgoJCQkJCQkJY3R4LnNhdmUoKTsKCQkJCQkJCWN0eC50cmFuc2xhdGUobWUueENlbnRlciwgbWUueUNlbnRlcik7CgkJCQkJCQljdHgucm90YXRlKHN0YXJ0QW5nbGUpOwoKCQkJCQkJCWlmICh0aWNrT3B0cy5zaG93TGFiZWxCYWNrZHJvcCkgewoJCQkJCQkJCXZhciBsYWJlbFdpZHRoID0gY3R4Lm1lYXN1cmVUZXh0KGxhYmVsKS53aWR0aDsKCQkJCQkJCQljdHguZmlsbFN0eWxlID0gdGlja09wdHMuYmFja2Ryb3BDb2xvcjsKCQkJCQkJCQljdHguZmlsbFJlY3QoCgkJCQkJCQkJCS1sYWJlbFdpZHRoIC8gMiAtIHRpY2tPcHRzLmJhY2tkcm9wUGFkZGluZ1gsCgkJCQkJCQkJCS15Q2VudGVyT2Zmc2V0IC0gdGlja0ZvbnRTaXplIC8gMiAtIHRpY2tPcHRzLmJhY2tkcm9wUGFkZGluZ1ksCgkJCQkJCQkJCWxhYmVsV2lkdGggKyB0aWNrT3B0cy5iYWNrZHJvcFBhZGRpbmdYICogMiwKCQkJCQkJCQkJdGlja0ZvbnRTaXplICsgdGlja09wdHMuYmFja2Ryb3BQYWRkaW5nWSAqIDIKCQkJCQkJCQkpOwoJCQkJCQkJfQoKCQkJCQkJCWN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKCQkJCQkJCWN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJzsKCQkJCQkJCWN0eC5maWxsU3R5bGUgPSB0aWNrRm9udENvbG9yOwoJCQkJCQkJY3R4LmZpbGxUZXh0KGxhYmVsLCAwLCAteUNlbnRlck9mZnNldCk7CgkJCQkJCQljdHgucmVzdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgoJCQkJaWYgKG9wdHMuYW5nbGVMaW5lcy5kaXNwbGF5IHx8IG9wdHMucG9pbnRMYWJlbHMuZGlzcGxheSkgewoJCQkJCWRyYXdQb2ludExhYmVscyhtZSk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCUNoYXJ0LnNjYWxlU2VydmljZS5yZWdpc3RlclNjYWxlVHlwZSgncmFkaWFsTGluZWFyJywgTGluZWFyUmFkaWFsU2NhbGUsIGRlZmF1bHRDb25maWcpOwoKfTsKCn0seyIyNSI6MjUsIjM0IjozNCwiNDUiOjQ1fV0sNTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiBnbG9iYWwgd2luZG93OiBmYWxzZSAqLwondXNlIHN0cmljdCc7Cgp2YXIgbW9tZW50ID0gcmVxdWlyZSg2KTsKbW9tZW50ID0gdHlwZW9mIG1vbWVudCA9PT0gJ2Z1bmN0aW9uJyA/IG1vbWVudCA6IHdpbmRvdy5tb21lbnQ7Cgp2YXIgZGVmYXVsdHMgPSByZXF1aXJlKDI1KTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKDQ1KTsKCi8vIEludGVnZXIgY29uc3RhbnRzIGFyZSBmcm9tIHRoZSBFUzYgc3BlYy4KdmFyIE1JTl9JTlRFR0VSID0gTnVtYmVyLk1JTl9TQUZFX0lOVEVHRVIgfHwgLTkwMDcxOTkyNTQ3NDA5OTE7CnZhciBNQVhfSU5URUdFUiA9IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSIHx8IDkwMDcxOTkyNTQ3NDA5OTE7Cgp2YXIgSU5URVJWQUxTID0gewoJbWlsbGlzZWNvbmQ6IHsKCQljb21tb246IHRydWUsCgkJc2l6ZTogMSwKCQlzdGVwczogWzEsIDIsIDUsIDEwLCAyMCwgNTAsIDEwMCwgMjUwLCA1MDBdCgl9LAoJc2Vjb25kOiB7CgkJY29tbW9uOiB0cnVlLAoJCXNpemU6IDEwMDAsCgkJc3RlcHM6IFsxLCAyLCA1LCAxMCwgMzBdCgl9LAoJbWludXRlOiB7CgkJY29tbW9uOiB0cnVlLAoJCXNpemU6IDYwMDAwLAoJCXN0ZXBzOiBbMSwgMiwgNSwgMTAsIDMwXQoJfSwKCWhvdXI6IHsKCQljb21tb246IHRydWUsCgkJc2l6ZTogMzYwMDAwMCwKCQlzdGVwczogWzEsIDIsIDMsIDYsIDEyXQoJfSwKCWRheTogewoJCWNvbW1vbjogdHJ1ZSwKCQlzaXplOiA4NjQwMDAwMCwKCQlzdGVwczogWzEsIDIsIDVdCgl9LAoJd2VlazogewoJCWNvbW1vbjogZmFsc2UsCgkJc2l6ZTogNjA0ODAwMDAwLAoJCXN0ZXBzOiBbMSwgMiwgMywgNF0KCX0sCgltb250aDogewoJCWNvbW1vbjogdHJ1ZSwKCQlzaXplOiAyLjYyOGU5LAoJCXN0ZXBzOiBbMSwgMiwgM10KCX0sCglxdWFydGVyOiB7CgkJY29tbW9uOiBmYWxzZSwKCQlzaXplOiA3Ljg4NGU5LAoJCXN0ZXBzOiBbMSwgMiwgMywgNF0KCX0sCgl5ZWFyOiB7CgkJY29tbW9uOiB0cnVlLAoJCXNpemU6IDMuMTU0ZTEwCgl9Cn07Cgp2YXIgVU5JVFMgPSBPYmplY3Qua2V5cyhJTlRFUlZBTFMpOwoKZnVuY3Rpb24gc29ydGVyKGEsIGIpIHsKCXJldHVybiBhIC0gYjsKfQoKZnVuY3Rpb24gYXJyYXlVbmlxdWUoaXRlbXMpIHsKCXZhciBoYXNoID0ge307Cgl2YXIgb3V0ID0gW107Cgl2YXIgaSwgaWxlbiwgaXRlbTsKCglmb3IgKGkgPSAwLCBpbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJaXRlbSA9IGl0ZW1zW2ldOwoJCWlmICghaGFzaFtpdGVtXSkgewoJCQloYXNoW2l0ZW1dID0gdHJ1ZTsKCQkJb3V0LnB1c2goaXRlbSk7CgkJfQoJfQoKCXJldHVybiBvdXQ7Cn0KCi8qKgogKiBSZXR1cm5zIGFuIGFycmF5IG9mIHt0aW1lLCBwb3N9IG9iamVjdHMgdXNlZCB0byBpbnRlcnBvbGF0ZSBhIHNwZWNpZmljIGB0aW1lYCBvciBwb3NpdGlvbgogKiAoYHBvc2ApIG9uIHRoZSBzY2FsZSwgYnkgc2VhcmNoaW5nIGVudHJpZXMgYmVmb3JlIGFuZCBhZnRlciB0aGUgcmVxdWVzdGVkIHZhbHVlLiBgcG9zYCBpcwogKiBhIGRlY2ltYWwgYmV0d2VlbiAwIGFuZCAxOiAwIGJlaW5nIHRoZSBzdGFydCBvZiB0aGUgc2NhbGUgKGxlZnQgb3IgdG9wKSBhbmQgMSB0aGUgb3RoZXIKICogZXh0cmVtaXR5IChsZWZ0ICsgd2lkdGggb3IgdG9wICsgaGVpZ2h0KS4gTm90ZSB0aGF0IGl0IHdvdWxkIGJlIG1vcmUgb3B0aW1pemVkIHRvIGRpcmVjdGx5CiAqIHN0b3JlIHByZS1jb21wdXRlZCBwaXhlbHMsIGJ1dCB0aGUgc2NhbGUgZGltZW5zaW9ucyBhcmUgbm90IGd1YXJhbnRlZWQgYXQgdGhlIHRpbWUgd2UgbmVlZAogKiB0byBjcmVhdGUgdGhlIGxvb2t1cCB0YWJsZS4gVGhlIHRhYmxlIEFMV0FZUyBjb250YWlucyBhdCBsZWFzdCB0d28gaXRlbXM6IG1pbiBhbmQgbWF4LgogKgogKiBAcGFyYW0ge051bWJlcltdfSB0aW1lc3RhbXBzIC0gdGltZXN0YW1wcyBzb3J0ZWQgZnJvbSBsb3dlc3QgdG8gaGlnaGVzdC4KICogQHBhcmFtIHtTdHJpbmd9IGRpc3RyaWJ1dGlvbiAtIElmICdsaW5lYXInLCB0aW1lc3RhbXBzIHdpbGwgYmUgc3ByZWFkIGxpbmVhcmx5IGFsb25nIHRoZSBtaW4KICogYW5kIG1heCByYW5nZSwgc28gYmFzaWNhbGx5LCB0aGUgdGFibGUgd2lsbCBjb250YWlucyBvbmx5IHR3byBpdGVtczoge21pbiwgMH0gYW5kIHttYXgsIDF9LgogKiBJZiAnc2VyaWVzJywgdGltZXN0YW1wcyB3aWxsIGJlIHBvc2l0aW9uZWQgYXQgdGhlIHNhbWUgZGlzdGFuY2UgZnJvbSBlYWNoIG90aGVyLiBJbiB0aGlzCiAqIGNhc2UsIG9ubHkgdGltZXN0YW1wcyB0aGF0IGJyZWFrIHRoZSB0aW1lIGxpbmVhcml0eSBhcmUgcmVnaXN0ZXJlZCwgbWVhbmluZyB0aGF0IGluIHRoZQogKiBiZXN0IGNhc2UsIGFsbCB0aW1lc3RhbXBzIGFyZSBsaW5lYXIsIHRoZSB0YWJsZSBjb250YWlucyBvbmx5IG1pbiBhbmQgbWF4LgogKi8KZnVuY3Rpb24gYnVpbGRMb29rdXBUYWJsZSh0aW1lc3RhbXBzLCBtaW4sIG1heCwgZGlzdHJpYnV0aW9uKSB7CglpZiAoZGlzdHJpYnV0aW9uID09PSAnbGluZWFyJyB8fCAhdGltZXN0YW1wcy5sZW5ndGgpIHsKCQlyZXR1cm4gWwoJCQl7dGltZTogbWluLCBwb3M6IDB9LAoJCQl7dGltZTogbWF4LCBwb3M6IDF9CgkJXTsKCX0KCgl2YXIgdGFibGUgPSBbXTsKCXZhciBpdGVtcyA9IFttaW5dOwoJdmFyIGksIGlsZW4sIHByZXYsIGN1cnIsIG5leHQ7CgoJZm9yIChpID0gMCwgaWxlbiA9IHRpbWVzdGFtcHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJY3VyciA9IHRpbWVzdGFtcHNbaV07CgkJaWYgKGN1cnIgPiBtaW4gJiYgY3VyciA8IG1heCkgewoJCQlpdGVtcy5wdXNoKGN1cnIpOwoJCX0KCX0KCglpdGVtcy5wdXNoKG1heCk7CgoJZm9yIChpID0gMCwgaWxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCW5leHQgPSBpdGVtc1tpICsgMV07CgkJcHJldiA9IGl0ZW1zW2kgLSAxXTsKCQljdXJyID0gaXRlbXNbaV07CgoJCS8vIG9ubHkgYWRkIHBvaW50cyB0aGF0IGJyZWFrcyB0aGUgc2NhbGUgbGluZWFyaXR5CgkJaWYgKHByZXYgPT09IHVuZGVmaW5lZCB8fCBuZXh0ID09PSB1bmRlZmluZWQgfHwgTWF0aC5yb3VuZCgobmV4dCArIHByZXYpIC8gMikgIT09IGN1cnIpIHsKCQkJdGFibGUucHVzaCh7dGltZTogY3VyciwgcG9zOiBpIC8gKGlsZW4gLSAxKX0pOwoJCX0KCX0KCglyZXR1cm4gdGFibGU7Cn0KCi8vIEBzZWUgYWRhcHRlZCBmcm9tIGh0dHA6Ly93d3cuYW51amdha2hhci5jb20vMjAxNC8wMy8wMS9iaW5hcnktc2VhcmNoLWluLWphdmFzY3JpcHQvCmZ1bmN0aW9uIGxvb2t1cCh0YWJsZSwga2V5LCB2YWx1ZSkgewoJdmFyIGxvID0gMDsKCXZhciBoaSA9IHRhYmxlLmxlbmd0aCAtIDE7Cgl2YXIgbWlkLCBpMCwgaTE7CgoJd2hpbGUgKGxvID49IDAgJiYgbG8gPD0gaGkpIHsKCQltaWQgPSAobG8gKyBoaSkgPj4gMTsKCQlpMCA9IHRhYmxlW21pZCAtIDFdIHx8IG51bGw7CgkJaTEgPSB0YWJsZVttaWRdOwoKCQlpZiAoIWkwKSB7CgkJCS8vIGdpdmVuIHZhbHVlIGlzIG91dHNpZGUgdGFibGUgKGJlZm9yZSBmaXJzdCBpdGVtKQoJCQlyZXR1cm4ge2xvOiBudWxsLCBoaTogaTF9OwoJCX0gZWxzZSBpZiAoaTFba2V5XSA8IHZhbHVlKSB7CgkJCWxvID0gbWlkICsgMTsKCQl9IGVsc2UgaWYgKGkwW2tleV0gPiB2YWx1ZSkgewoJCQloaSA9IG1pZCAtIDE7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHtsbzogaTAsIGhpOiBpMX07CgkJfQoJfQoKCS8vIGdpdmVuIHZhbHVlIGlzIG91dHNpZGUgdGFibGUgKGFmdGVyIGxhc3QgaXRlbSkKCXJldHVybiB7bG86IGkxLCBoaTogbnVsbH07Cn0KCi8qKgogKiBMaW5lYXJseSBpbnRlcnBvbGF0ZXMgdGhlIGdpdmVuIHNvdXJjZSBgdmFsdWVgIHVzaW5nIHRoZSB0YWJsZSBpdGVtcyBgc2tleWAgdmFsdWVzIGFuZAogKiByZXR1cm5zIHRoZSBhc3NvY2lhdGVkIGB0a2V5YCB2YWx1ZS4gRm9yIGV4YW1wbGUsIGludGVycG9sYXRlKHRhYmxlLCAndGltZScsIDQyLCAncG9zJykKICogcmV0dXJucyB0aGUgcG9zaXRpb24gZm9yIGEgdGltZXN0YW1wIGVxdWFsIHRvIDQyLiBJZiB2YWx1ZSBpcyBvdXQgb2YgYm91bmRzLCB2YWx1ZXMgYXQKICogaW5kZXggWzAsIDFdIG9yIFtuIC0gMSwgbl0gYXJlIHVzZWQgZm9yIHRoZSBpbnRlcnBvbGF0aW9uLgogKi8KZnVuY3Rpb24gaW50ZXJwb2xhdGUodGFibGUsIHNrZXksIHN2YWwsIHRrZXkpIHsKCXZhciByYW5nZSA9IGxvb2t1cCh0YWJsZSwgc2tleSwgc3ZhbCk7CgoJLy8gTm90ZTogdGhlIGxvb2t1cCB0YWJsZSBBTFdBWVMgY29udGFpbnMgYXQgbGVhc3QgMiBpdGVtcyAobWluIGFuZCBtYXgpCgl2YXIgcHJldiA9ICFyYW5nZS5sbyA/IHRhYmxlWzBdIDogIXJhbmdlLmhpID8gdGFibGVbdGFibGUubGVuZ3RoIC0gMl0gOiByYW5nZS5sbzsKCXZhciBuZXh0ID0gIXJhbmdlLmxvID8gdGFibGVbMV0gOiAhcmFuZ2UuaGkgPyB0YWJsZVt0YWJsZS5sZW5ndGggLSAxXSA6IHJhbmdlLmhpOwoKCXZhciBzcGFuID0gbmV4dFtza2V5XSAtIHByZXZbc2tleV07Cgl2YXIgcmF0aW8gPSBzcGFuID8gKHN2YWwgLSBwcmV2W3NrZXldKSAvIHNwYW4gOiAwOwoJdmFyIG9mZnNldCA9IChuZXh0W3RrZXldIC0gcHJldlt0a2V5XSkgKiByYXRpbzsKCglyZXR1cm4gcHJldlt0a2V5XSArIG9mZnNldDsKfQoKLyoqCiAqIENvbnZlcnQgdGhlIGdpdmVuIHZhbHVlIHRvIGEgbW9tZW50IG9iamVjdCB1c2luZyB0aGUgZ2l2ZW4gdGltZSBvcHRpb25zLgogKiBAc2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZG9jcy8jL3BhcnNpbmcvCiAqLwpmdW5jdGlvbiBtb21lbnRpZnkodmFsdWUsIG9wdGlvbnMpIHsKCXZhciBwYXJzZXIgPSBvcHRpb25zLnBhcnNlcjsKCXZhciBmb3JtYXQgPSBvcHRpb25zLnBhcnNlciB8fCBvcHRpb25zLmZvcm1hdDsKCglpZiAodHlwZW9mIHBhcnNlciA9PT0gJ2Z1bmN0aW9uJykgewoJCXJldHVybiBwYXJzZXIodmFsdWUpOwoJfQoKCWlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBmb3JtYXQgPT09ICdzdHJpbmcnKSB7CgkJcmV0dXJuIG1vbWVudCh2YWx1ZSwgZm9ybWF0KTsKCX0KCglpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIG1vbWVudCkpIHsKCQl2YWx1ZSA9IG1vbWVudCh2YWx1ZSk7Cgl9CgoJaWYgKHZhbHVlLmlzVmFsaWQoKSkgewoJCXJldHVybiB2YWx1ZTsKCX0KCgkvLyBMYWJlbHMgYXJlIGluIGFuIGluY29tcGF0aWJsZSBtb21lbnQgZm9ybWF0IGFuZCBubyBgcGFyc2VyYCBoYXMgYmVlbiBwcm92aWRlZC4KCS8vIFRoZSB1c2VyIG1pZ2h0IHN0aWxsIHVzZSB0aGUgZGVwcmVjYXRlZCBgZm9ybWF0YCBvcHRpb24gdG8gY29udmVydCBoaXMgaW5wdXRzLgoJaWYgKHR5cGVvZiBmb3JtYXQgPT09ICdmdW5jdGlvbicpIHsKCQlyZXR1cm4gZm9ybWF0KHZhbHVlKTsKCX0KCglyZXR1cm4gdmFsdWU7Cn0KCmZ1bmN0aW9uIHBhcnNlKGlucHV0LCBzY2FsZSkgewoJaWYgKGhlbHBlcnMuaXNOdWxsT3JVbmRlZihpbnB1dCkpIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgl2YXIgb3B0aW9ucyA9IHNjYWxlLm9wdGlvbnMudGltZTsKCXZhciB2YWx1ZSA9IG1vbWVudGlmeShzY2FsZS5nZXRSaWdodFZhbHVlKGlucHV0KSwgb3B0aW9ucyk7CglpZiAoIXZhbHVlLmlzVmFsaWQoKSkgewoJCXJldHVybiBudWxsOwoJfQoKCWlmIChvcHRpb25zLnJvdW5kKSB7CgkJdmFsdWUuc3RhcnRPZihvcHRpb25zLnJvdW5kKTsKCX0KCglyZXR1cm4gdmFsdWUudmFsdWVPZigpOwp9CgovKioKICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIHVuaXQgdG8gc2tpcCB0byBiZSBhYmxlIHRvIGRpc3BsYXkgdXAgdG8gYGNhcGFjaXR5YCBudW1iZXIgb2YgdGlja3MKICogaW4gYHVuaXRgIGZvciB0aGUgZ2l2ZW4gYG1pbmAgLyBgbWF4YCByYW5nZSBhbmQgcmVzcGVjdGluZyB0aGUgaW50ZXJ2YWwgc3RlcHMgY29uc3RyYWludHMuCiAqLwpmdW5jdGlvbiBkZXRlcm1pbmVTdGVwU2l6ZShtaW4sIG1heCwgdW5pdCwgY2FwYWNpdHkpIHsKCXZhciByYW5nZSA9IG1heCAtIG1pbjsKCXZhciBpbnRlcnZhbCA9IElOVEVSVkFMU1t1bml0XTsKCXZhciBtaWxsaXNlY29uZHMgPSBpbnRlcnZhbC5zaXplOwoJdmFyIHN0ZXBzID0gaW50ZXJ2YWwuc3RlcHM7Cgl2YXIgaSwgaWxlbiwgZmFjdG9yOwoKCWlmICghc3RlcHMpIHsKCQlyZXR1cm4gTWF0aC5jZWlsKHJhbmdlIC8gKGNhcGFjaXR5ICogbWlsbGlzZWNvbmRzKSk7Cgl9CgoJZm9yIChpID0gMCwgaWxlbiA9IHN0ZXBzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCWZhY3RvciA9IHN0ZXBzW2ldOwoJCWlmIChNYXRoLmNlaWwocmFuZ2UgLyAobWlsbGlzZWNvbmRzICogZmFjdG9yKSkgPD0gY2FwYWNpdHkpIHsKCQkJYnJlYWs7CgkJfQoJfQoKCXJldHVybiBmYWN0b3I7Cn0KCi8qKgogKiBGaWd1cmVzIG91dCB3aGF0IHVuaXQgcmVzdWx0cyBpbiBhbiBhcHByb3ByaWF0ZSBudW1iZXIgb2YgYXV0by1nZW5lcmF0ZWQgdGlja3MKICovCmZ1bmN0aW9uIGRldGVybWluZVVuaXRGb3JBdXRvVGlja3MobWluVW5pdCwgbWluLCBtYXgsIGNhcGFjaXR5KSB7Cgl2YXIgaWxlbiA9IFVOSVRTLmxlbmd0aDsKCXZhciBpLCBpbnRlcnZhbCwgZmFjdG9yOwoKCWZvciAoaSA9IFVOSVRTLmluZGV4T2YobWluVW5pdCk7IGkgPCBpbGVuIC0gMTsgKytpKSB7CgkJaW50ZXJ2YWwgPSBJTlRFUlZBTFNbVU5JVFNbaV1dOwoJCWZhY3RvciA9IGludGVydmFsLnN0ZXBzID8gaW50ZXJ2YWwuc3RlcHNbaW50ZXJ2YWwuc3RlcHMubGVuZ3RoIC0gMV0gOiBNQVhfSU5URUdFUjsKCgkJaWYgKGludGVydmFsLmNvbW1vbiAmJiBNYXRoLmNlaWwoKG1heCAtIG1pbikgLyAoZmFjdG9yICogaW50ZXJ2YWwuc2l6ZSkpIDw9IGNhcGFjaXR5KSB7CgkJCXJldHVybiBVTklUU1tpXTsKCQl9Cgl9CgoJcmV0dXJuIFVOSVRTW2lsZW4gLSAxXTsKfQoKLyoqCiAqIEZpZ3VyZXMgb3V0IHdoYXQgdW5pdCB0byBmb3JtYXQgYSBzZXQgb2YgdGlja3Mgd2l0aAogKi8KZnVuY3Rpb24gZGV0ZXJtaW5lVW5pdEZvckZvcm1hdHRpbmcodGlja3MsIG1pblVuaXQsIG1pbiwgbWF4KSB7Cgl2YXIgZHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24obW9tZW50KG1heCkuZGlmZihtb21lbnQobWluKSkpOwoJdmFyIGlsZW4gPSBVTklUUy5sZW5ndGg7Cgl2YXIgaSwgdW5pdDsKCglmb3IgKGkgPSBpbGVuIC0gMTsgaSA+PSBVTklUUy5pbmRleE9mKG1pblVuaXQpOyBpLS0pIHsKCQl1bml0ID0gVU5JVFNbaV07CgkJaWYgKElOVEVSVkFMU1t1bml0XS5jb21tb24gJiYgZHVyYXRpb24uYXModW5pdCkgPj0gdGlja3MubGVuZ3RoKSB7CgkJCXJldHVybiB1bml0OwoJCX0KCX0KCglyZXR1cm4gVU5JVFNbbWluVW5pdCA/IFVOSVRTLmluZGV4T2YobWluVW5pdCkgOiAwXTsKfQoKZnVuY3Rpb24gZGV0ZXJtaW5lTWFqb3JVbml0KHVuaXQpIHsKCWZvciAodmFyIGkgPSBVTklUUy5pbmRleE9mKHVuaXQpICsgMSwgaWxlbiA9IFVOSVRTLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCWlmIChJTlRFUlZBTFNbVU5JVFNbaV1dLmNvbW1vbikgewoJCQlyZXR1cm4gVU5JVFNbaV07CgkJfQoJfQp9CgovKioKICogR2VuZXJhdGVzIGEgbWF4aW11bSBvZiBgY2FwYWNpdHlgIHRpbWVzdGFtcHMgYmV0d2VlbiBtaW4gYW5kIG1heCwgcm91bmRlZCB0byB0aGUKICogYG1pbm9yYCB1bml0LCBhbGlnbmVkIG9uIHRoZSBgbWFqb3JgIHVuaXQgYW5kIHVzaW5nIHRoZSBnaXZlbiBzY2FsZSB0aW1lIGBvcHRpb25zYC4KICogSW1wb3J0YW50OiB0aGlzIG1ldGhvZCBjYW4gcmV0dXJuIHRpY2tzIG91dHNpZGUgdGhlIG1pbiBhbmQgbWF4IHJhbmdlLCBpdCdzIHRoZQogKiByZXNwb25zaWJpbGl0eSBvZiB0aGUgY2FsbGluZyBjb2RlIHRvIGNsYW1wIHZhbHVlcyBpZiBuZWVkZWQuCiAqLwpmdW5jdGlvbiBnZW5lcmF0ZShtaW4sIG1heCwgY2FwYWNpdHksIG9wdGlvbnMpIHsKCXZhciB0aW1lT3B0cyA9IG9wdGlvbnMudGltZTsKCXZhciBtaW5vciA9IHRpbWVPcHRzLnVuaXQgfHwgZGV0ZXJtaW5lVW5pdEZvckF1dG9UaWNrcyh0aW1lT3B0cy5taW5Vbml0LCBtaW4sIG1heCwgY2FwYWNpdHkpOwoJdmFyIG1ham9yID0gZGV0ZXJtaW5lTWFqb3JVbml0KG1pbm9yKTsKCXZhciBzdGVwU2l6ZSA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQodGltZU9wdHMuc3RlcFNpemUsIHRpbWVPcHRzLnVuaXRTdGVwU2l6ZSk7Cgl2YXIgd2Vla2RheSA9IG1pbm9yID09PSAnd2VlaycgPyB0aW1lT3B0cy5pc29XZWVrZGF5IDogZmFsc2U7Cgl2YXIgbWFqb3JUaWNrc0VuYWJsZWQgPSBvcHRpb25zLnRpY2tzLm1ham9yLmVuYWJsZWQ7Cgl2YXIgaW50ZXJ2YWwgPSBJTlRFUlZBTFNbbWlub3JdOwoJdmFyIGZpcnN0ID0gbW9tZW50KG1pbik7Cgl2YXIgbGFzdCA9IG1vbWVudChtYXgpOwoJdmFyIHRpY2tzID0gW107Cgl2YXIgdGltZTsKCglpZiAoIXN0ZXBTaXplKSB7CgkJc3RlcFNpemUgPSBkZXRlcm1pbmVTdGVwU2l6ZShtaW4sIG1heCwgbWlub3IsIGNhcGFjaXR5KTsKCX0KCgkvLyBGb3IgJ3dlZWsnIHVuaXQsIGhhbmRsZSB0aGUgZmlyc3QgZGF5IG9mIHdlZWsgb3B0aW9uCglpZiAod2Vla2RheSkgewoJCWZpcnN0ID0gZmlyc3QuaXNvV2Vla2RheSh3ZWVrZGF5KTsKCQlsYXN0ID0gbGFzdC5pc29XZWVrZGF5KHdlZWtkYXkpOwoJfQoKCS8vIEFsaWduIGZpcnN0L2xhc3QgdGlja3Mgb24gdW5pdAoJZmlyc3QgPSBmaXJzdC5zdGFydE9mKHdlZWtkYXkgPyAnZGF5JyA6IG1pbm9yKTsKCWxhc3QgPSBsYXN0LnN0YXJ0T2Yod2Vla2RheSA/ICdkYXknIDogbWlub3IpOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBsYXN0IHRpY2sgaW5jbHVkZSBtYXgKCWlmIChsYXN0IDwgbWF4KSB7CgkJbGFzdC5hZGQoMSwgbWlub3IpOwoJfQoKCXRpbWUgPSBtb21lbnQoZmlyc3QpOwoKCWlmIChtYWpvclRpY2tzRW5hYmxlZCAmJiBtYWpvciAmJiAhd2Vla2RheSAmJiAhdGltZU9wdHMucm91bmQpIHsKCQkvLyBBbGlnbiB0aGUgZmlyc3QgdGljayBvbiB0aGUgcHJldmlvdXMgYG1pbm9yYCB1bml0IGFsaWduZWQgb24gdGhlIGBtYWpvcmAgdW5pdDoKCQkvLyB3ZSBmaXJzdCBhbGlnbmVkIHRpbWUgb24gdGhlIHByZXZpb3VzIGBtYWpvcmAgdW5pdCB0aGVuIGFkZCB0aGUgbnVtYmVyIG9mIGZ1bGwKCQkvLyBzdGVwU2l6ZSB0aGVyZSBpcyBiZXR3ZWVuIGZpcnN0IGFuZCB0aGUgcHJldmlvdXMgbWFqb3IgdGltZS4KCQl0aW1lLnN0YXJ0T2YobWFqb3IpOwoJCXRpbWUuYWRkKH5+KChmaXJzdCAtIHRpbWUpIC8gKGludGVydmFsLnNpemUgKiBzdGVwU2l6ZSkpICogc3RlcFNpemUsIG1pbm9yKTsKCX0KCglmb3IgKDsgdGltZSA8IGxhc3Q7IHRpbWUuYWRkKHN0ZXBTaXplLCBtaW5vcikpIHsKCQl0aWNrcy5wdXNoKCt0aW1lKTsKCX0KCgl0aWNrcy5wdXNoKCt0aW1lKTsKCglyZXR1cm4gdGlja3M7Cn0KCi8qKgogKiBSZXR1cm5zIHRoZSByaWdodCBhbmQgbGVmdCBvZmZzZXRzIGZyb20gZWRnZXMgaW4gdGhlIGZvcm0gb2Yge2xlZnQsIHJpZ2h0fS4KICogT2Zmc2V0cyBhcmUgYWRkZWQgd2hlbiB0aGUgYG9mZnNldGAgb3B0aW9uIGlzIHRydWUuCiAqLwpmdW5jdGlvbiBjb21wdXRlT2Zmc2V0cyh0YWJsZSwgdGlja3MsIG1pbiwgbWF4LCBvcHRpb25zKSB7Cgl2YXIgbGVmdCA9IDA7Cgl2YXIgcmlnaHQgPSAwOwoJdmFyIHVwcGVyLCBsb3dlcjsKCglpZiAob3B0aW9ucy5vZmZzZXQgJiYgdGlja3MubGVuZ3RoKSB7CgkJaWYgKCFvcHRpb25zLnRpbWUubWluKSB7CgkJCXVwcGVyID0gdGlja3MubGVuZ3RoID4gMSA/IHRpY2tzWzFdIDogbWF4OwoJCQlsb3dlciA9IHRpY2tzWzBdOwoJCQlsZWZ0ID0gKAoJCQkJaW50ZXJwb2xhdGUodGFibGUsICd0aW1lJywgdXBwZXIsICdwb3MnKSAtCgkJCQlpbnRlcnBvbGF0ZSh0YWJsZSwgJ3RpbWUnLCBsb3dlciwgJ3BvcycpCgkJCSkgLyAyOwoJCX0KCQlpZiAoIW9wdGlvbnMudGltZS5tYXgpIHsKCQkJdXBwZXIgPSB0aWNrc1t0aWNrcy5sZW5ndGggLSAxXTsKCQkJbG93ZXIgPSB0aWNrcy5sZW5ndGggPiAxID8gdGlja3NbdGlja3MubGVuZ3RoIC0gMl0gOiBtaW47CgkJCXJpZ2h0ID0gKAoJCQkJaW50ZXJwb2xhdGUodGFibGUsICd0aW1lJywgdXBwZXIsICdwb3MnKSAtCgkJCQlpbnRlcnBvbGF0ZSh0YWJsZSwgJ3RpbWUnLCBsb3dlciwgJ3BvcycpCgkJCSkgLyAyOwoJCX0KCX0KCglyZXR1cm4ge2xlZnQ6IGxlZnQsIHJpZ2h0OiByaWdodH07Cn0KCmZ1bmN0aW9uIHRpY2tzRnJvbVRpbWVzdGFtcHModmFsdWVzLCBtYWpvclVuaXQpIHsKCXZhciB0aWNrcyA9IFtdOwoJdmFyIGksIGlsZW4sIHZhbHVlLCBtYWpvcjsKCglmb3IgKGkgPSAwLCBpbGVuID0gdmFsdWVzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCXZhbHVlID0gdmFsdWVzW2ldOwoJCW1ham9yID0gbWFqb3JVbml0ID8gdmFsdWUgPT09ICttb21lbnQodmFsdWUpLnN0YXJ0T2YobWFqb3JVbml0KSA6IGZhbHNlOwoKCQl0aWNrcy5wdXNoKHsKCQkJdmFsdWU6IHZhbHVlLAoJCQltYWpvcjogbWFqb3IKCQl9KTsKCX0KCglyZXR1cm4gdGlja3M7Cn0KCmZ1bmN0aW9uIGRldGVybWluZUxhYmVsRm9ybWF0KGRhdGEsIHRpbWVPcHRzKSB7Cgl2YXIgaSwgbW9tZW50RGF0ZSwgaGFzVGltZTsKCXZhciBpbGVuID0gZGF0YS5sZW5ndGg7CgoJLy8gZmluZCB0aGUgbGFiZWwgd2l0aCB0aGUgbW9zdCBwYXJ0cyAobWlsbGlzZWNvbmRzLCBtaW51dGVzLCBldGMuKQoJLy8gZm9ybWF0IGFsbCBsYWJlbHMgd2l0aCB0aGUgc2FtZSBsZXZlbCBvZiBkZXRhaWwgYXMgdGhlIG1vc3Qgc3BlY2lmaWMgbGFiZWwKCWZvciAoaSA9IDA7IGkgPCBpbGVuOyBpKyspIHsKCQltb21lbnREYXRlID0gbW9tZW50aWZ5KGRhdGFbaV0sIHRpbWVPcHRzKTsKCQlpZiAobW9tZW50RGF0ZS5taWxsaXNlY29uZCgpICE9PSAwKSB7CgkJCXJldHVybiAnTU1NIEQsIFlZWVkgaDptbTpzcy5TU1MgYSc7CgkJfQoJCWlmIChtb21lbnREYXRlLnNlY29uZCgpICE9PSAwIHx8IG1vbWVudERhdGUubWludXRlKCkgIT09IDAgfHwgbW9tZW50RGF0ZS5ob3VyKCkgIT09IDApIHsKCQkJaGFzVGltZSA9IHRydWU7CgkJfQoJfQoJaWYgKGhhc1RpbWUpIHsKCQlyZXR1cm4gJ01NTSBELCBZWVlZIGg6bW06c3MgYSc7Cgl9CglyZXR1cm4gJ01NTSBELCBZWVlZJzsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkgewoKCXZhciBkZWZhdWx0Q29uZmlnID0gewoJCXBvc2l0aW9uOiAnYm90dG9tJywKCgkJLyoqCgkJICogRGF0YSBkaXN0cmlidXRpb24gYWxvbmcgdGhlIHNjYWxlOgoJCSAqIC0gJ2xpbmVhcic6IGRhdGEgYXJlIHNwcmVhZCBhY2NvcmRpbmcgdG8gdGhlaXIgdGltZSAoZGlzdGFuY2VzIGNhbiB2YXJ5KSwKCQkgKiAtICdzZXJpZXMnOiBkYXRhIGFyZSBzcHJlYWQgYXQgdGhlIHNhbWUgZGlzdGFuY2UgZnJvbSBlYWNoIG90aGVyLgoJCSAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvcHVsbC80NTA3CgkJICogQHNpbmNlIDIuNy4wCgkJICovCgkJZGlzdHJpYnV0aW9uOiAnbGluZWFyJywKCgkJLyoqCgkJICogU2NhbGUgYm91bmRhcnkgc3RyYXRlZ3kgKGJ5cGFzc2VkIGJ5IG1pbi9tYXggdGltZSBvcHRpb25zKQoJCSAqIC0gYGRhdGFgOiBtYWtlIHN1cmUgZGF0YSBhcmUgZnVsbHkgdmlzaWJsZSwgdGlja3Mgb3V0c2lkZSBhcmUgcmVtb3ZlZAoJCSAqIC0gYHRpY2tzYDogbWFrZSBzdXJlIHRpY2tzIGFyZSBmdWxseSB2aXNpYmxlLCBkYXRhIG91dHNpZGUgYXJlIHRydW5jYXRlZAoJCSAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvcHVsbC80NTU2CgkJICogQHNpbmNlIDIuNy4wCgkJICovCgkJYm91bmRzOiAnZGF0YScsCgoJCXRpbWU6IHsKCQkJcGFyc2VyOiBmYWxzZSwgLy8gZmFsc2UgPT0gYSBwYXR0ZXJuIHN0cmluZyBmcm9tIGh0dHA6Ly9tb21lbnRqcy5jb20vZG9jcy8jL3BhcnNpbmcvc3RyaW5nLWZvcm1hdC8gb3IgYSBjdXN0b20gY2FsbGJhY2sgdGhhdCBjb252ZXJ0cyBpdHMgYXJndW1lbnQgdG8gYSBtb21lbnQKCQkJZm9ybWF0OiBmYWxzZSwgLy8gREVQUkVDQVRFRCBmYWxzZSA9PSBkYXRlIG9iamVjdHMsIG1vbWVudCBvYmplY3QsIGNhbGxiYWNrIG9yIGEgcGF0dGVybiBzdHJpbmcgZnJvbSBodHRwOi8vbW9tZW50anMuY29tL2RvY3MvIy9wYXJzaW5nL3N0cmluZy1mb3JtYXQvCgkJCXVuaXQ6IGZhbHNlLCAvLyBmYWxzZSA9PSBhdXRvbWF0aWMgb3Igb3ZlcnJpZGUgd2l0aCB3ZWVrLCBtb250aCwgeWVhciwgZXRjLgoJCQlyb3VuZDogZmFsc2UsIC8vIG5vbmUsIG9yIG92ZXJyaWRlIHdpdGggd2VlaywgbW9udGgsIHllYXIsIGV0Yy4KCQkJZGlzcGxheUZvcm1hdDogZmFsc2UsIC8vIERFUFJFQ0FURUQKCQkJaXNvV2Vla2RheTogZmFsc2UsIC8vIG92ZXJyaWRlIHdlZWsgc3RhcnQgZGF5IC0gc2VlIGh0dHA6Ly9tb21lbnRqcy5jb20vZG9jcy8jL2dldC1zZXQvaXNvLXdlZWtkYXkvCgkJCW1pblVuaXQ6ICdtaWxsaXNlY29uZCcsCgoJCQkvLyBkZWZhdWx0cyB0byB1bml0J3MgY29ycmVzcG9uZGluZyB1bml0Rm9ybWF0IGJlbG93IG9yIG92ZXJyaWRlIHVzaW5nIHBhdHRlcm4gc3RyaW5nIGZyb20gaHR0cDovL21vbWVudGpzLmNvbS9kb2NzLyMvZGlzcGxheWluZy9mb3JtYXQvCgkJCWRpc3BsYXlGb3JtYXRzOiB7CgkJCQltaWxsaXNlY29uZDogJ2g6bW06c3MuU1NTIGEnLCAvLyAxMToyMDowMS4xMjMgQU0sCgkJCQlzZWNvbmQ6ICdoOm1tOnNzIGEnLCAvLyAxMToyMDowMSBBTQoJCQkJbWludXRlOiAnaDptbSBhJywgLy8gMTE6MjAgQU0KCQkJCWhvdXI6ICdoQScsIC8vIDVQTQoJCQkJZGF5OiAnTU1NIEQnLCAvLyBTZXAgNAoJCQkJd2VlazogJ2xsJywgLy8gV2VlayA0Niwgb3IgbWF5YmUgIltXXVdXIC0gWVlZWSIgPwoJCQkJbW9udGg6ICdNTU0gWVlZWScsIC8vIFNlcHQgMjAxNQoJCQkJcXVhcnRlcjogJ1tRXVEgLSBZWVlZJywgLy8gUTMKCQkJCXllYXI6ICdZWVlZJyAvLyAyMDE1CgkJCX0sCgkJfSwKCQl0aWNrczogewoJCQlhdXRvU2tpcDogZmFsc2UsCgoJCQkvKioKCQkJICogVGlja3MgZ2VuZXJhdGlvbiBpbnB1dCB2YWx1ZXM6CgkJCSAqIC0gJ2F1dG8nOiBnZW5lcmF0ZXMgIm9wdGltYWwiIHRpY2tzIGJhc2VkIG9uIHNjYWxlIHNpemUgYW5kIHRpbWUgb3B0aW9ucy4KCQkJICogLSAnZGF0YSc6IGdlbmVyYXRlcyB0aWNrcyBmcm9tIGRhdGEgKGluY2x1ZGluZyBsYWJlbHMgZnJvbSBkYXRhIHt0fHh8eX0gb2JqZWN0cykuCgkJCSAqIC0gJ2xhYmVscyc6IGdlbmVyYXRlcyB0aWNrcyBmcm9tIHVzZXIgZ2l2ZW4gYGRhdGEubGFiZWxzYCB2YWx1ZXMgT05MWS4KCQkJICogQHNlZSBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9wdWxsLzQ1MDcKCQkJICogQHNpbmNlIDIuNy4wCgkJCSAqLwoJCQlzb3VyY2U6ICdhdXRvJywKCgkJCW1ham9yOiB7CgkJCQllbmFibGVkOiBmYWxzZQoJCQl9CgkJfQoJfTsKCgl2YXIgVGltZVNjYWxlID0gQ2hhcnQuU2NhbGUuZXh0ZW5kKHsKCQlpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCQkJaWYgKCFtb21lbnQpIHsKCQkJCXRocm93IG5ldyBFcnJvcignQ2hhcnQuanMgLSBNb21lbnQuanMgY291bGQgbm90IGJlIGZvdW5kISBZb3UgbXVzdCBpbmNsdWRlIGl0IGJlZm9yZSBDaGFydC5qcyB0byB1c2UgdGhlIHRpbWUgc2NhbGUuIERvd25sb2FkIGF0IGh0dHBzOi8vbW9tZW50anMuY29tJyk7CgkJCX0KCgkJCXRoaXMubWVyZ2VUaWNrc09wdGlvbnMoKTsKCgkJCUNoYXJ0LlNjYWxlLnByb3RvdHlwZS5pbml0aWFsaXplLmNhbGwodGhpcyk7CgkJfSwKCgkJdXBkYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdGlvbnMgPSBtZS5vcHRpb25zOwoKCQkJLy8gREVQUkVDQVRJT05TOiBvdXRwdXQgYSBtZXNzYWdlIG9ubHkgb25lIHRpbWUgcGVyIHVwZGF0ZQoJCQlpZiAob3B0aW9ucy50aW1lICYmIG9wdGlvbnMudGltZS5mb3JtYXQpIHsKCQkJCWNvbnNvbGUud2Fybignb3B0aW9ucy50aW1lLmZvcm1hdCBpcyBkZXByZWNhdGVkIGFuZCByZXBsYWNlZCBieSBvcHRpb25zLnRpbWUucGFyc2VyLicpOwoJCQl9CgoJCQlyZXR1cm4gQ2hhcnQuU2NhbGUucHJvdG90eXBlLnVwZGF0ZS5hcHBseShtZSwgYXJndW1lbnRzKTsKCQl9LAoKCQkvKioKCQkgKiBBbGxvd3MgZGF0YSB0byBiZSByZWZlcmVuY2VkIHZpYSAndCcgYXR0cmlidXRlCgkJICovCgkJZ2V0UmlnaHRWYWx1ZTogZnVuY3Rpb24ocmF3VmFsdWUpIHsKCQkJaWYgKHJhd1ZhbHVlICYmIHJhd1ZhbHVlLnQgIT09IHVuZGVmaW5lZCkgewoJCQkJcmF3VmFsdWUgPSByYXdWYWx1ZS50OwoJCQl9CgkJCXJldHVybiBDaGFydC5TY2FsZS5wcm90b3R5cGUuZ2V0UmlnaHRWYWx1ZS5jYWxsKHRoaXMsIHJhd1ZhbHVlKTsKCQl9LAoKCQlkZXRlcm1pbmVEYXRhTGltaXRzOiBmdW5jdGlvbigpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgkJCXZhciB0aW1lT3B0cyA9IG1lLm9wdGlvbnMudGltZTsKCQkJdmFyIHVuaXQgPSB0aW1lT3B0cy51bml0IHx8ICdkYXknOwoJCQl2YXIgbWluID0gTUFYX0lOVEVHRVI7CgkJCXZhciBtYXggPSBNSU5fSU5URUdFUjsKCQkJdmFyIHRpbWVzdGFtcHMgPSBbXTsKCQkJdmFyIGRhdGFzZXRzID0gW107CgkJCXZhciBsYWJlbHMgPSBbXTsKCQkJdmFyIGksIGosIGlsZW4sIGpsZW4sIGRhdGEsIHRpbWVzdGFtcDsKCgkJCS8vIENvbnZlcnQgbGFiZWxzIHRvIHRpbWVzdGFtcHMKCQkJZm9yIChpID0gMCwgaWxlbiA9IGNoYXJ0LmRhdGEubGFiZWxzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCQkJbGFiZWxzLnB1c2gocGFyc2UoY2hhcnQuZGF0YS5sYWJlbHNbaV0sIG1lKSk7CgkJCX0KCgkJCS8vIENvbnZlcnQgZGF0YSB0byB0aW1lc3RhbXBzCgkJCWZvciAoaSA9IDAsIGlsZW4gPSAoY2hhcnQuZGF0YS5kYXRhc2V0cyB8fCBbXSkubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQlpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShpKSkgewoJCQkJCWRhdGEgPSBjaGFydC5kYXRhLmRhdGFzZXRzW2ldLmRhdGE7CgoJCQkJCS8vIExldCdzIGNvbnNpZGVyIHRoYXQgYWxsIGRhdGEgaGF2ZSB0aGUgc2FtZSBmb3JtYXQuCgkJCQkJaWYgKGhlbHBlcnMuaXNPYmplY3QoZGF0YVswXSkpIHsKCQkJCQkJZGF0YXNldHNbaV0gPSBbXTsKCgkJCQkJCWZvciAoaiA9IDAsIGpsZW4gPSBkYXRhLmxlbmd0aDsgaiA8IGpsZW47ICsraikgewoJCQkJCQkJdGltZXN0YW1wID0gcGFyc2UoZGF0YVtqXSwgbWUpOwoJCQkJCQkJdGltZXN0YW1wcy5wdXNoKHRpbWVzdGFtcCk7CgkJCQkJCQlkYXRhc2V0c1tpXVtqXSA9IHRpbWVzdGFtcDsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCXRpbWVzdGFtcHMucHVzaC5hcHBseSh0aW1lc3RhbXBzLCBsYWJlbHMpOwoJCQkJCQlkYXRhc2V0c1tpXSA9IGxhYmVscy5zbGljZSgwKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWRhdGFzZXRzW2ldID0gW107CgkJCQl9CgkJCX0KCgkJCWlmIChsYWJlbHMubGVuZ3RoKSB7CgkJCQkvLyBTb3J0IGxhYmVscyAqKmFmdGVyKiogZGF0YSBoYXZlIGJlZW4gY29udmVydGVkCgkJCQlsYWJlbHMgPSBhcnJheVVuaXF1ZShsYWJlbHMpLnNvcnQoc29ydGVyKTsKCQkJCW1pbiA9IE1hdGgubWluKG1pbiwgbGFiZWxzWzBdKTsKCQkJCW1heCA9IE1hdGgubWF4KG1heCwgbGFiZWxzW2xhYmVscy5sZW5ndGggLSAxXSk7CgkJCX0KCgkJCWlmICh0aW1lc3RhbXBzLmxlbmd0aCkgewoJCQkJdGltZXN0YW1wcyA9IGFycmF5VW5pcXVlKHRpbWVzdGFtcHMpLnNvcnQoc29ydGVyKTsKCQkJCW1pbiA9IE1hdGgubWluKG1pbiwgdGltZXN0YW1wc1swXSk7CgkJCQltYXggPSBNYXRoLm1heChtYXgsIHRpbWVzdGFtcHNbdGltZXN0YW1wcy5sZW5ndGggLSAxXSk7CgkJCX0KCgkJCW1pbiA9IHBhcnNlKHRpbWVPcHRzLm1pbiwgbWUpIHx8IG1pbjsKCQkJbWF4ID0gcGFyc2UodGltZU9wdHMubWF4LCBtZSkgfHwgbWF4OwoKCQkJLy8gSW4gY2FzZSB0aGVyZSBpcyBubyB2YWxpZCBtaW4vbWF4LCBzZXQgbGltaXRzIGJhc2VkIG9uIHVuaXQgdGltZSBvcHRpb24KCQkJbWluID0gbWluID09PSBNQVhfSU5URUdFUiA/ICttb21lbnQoKS5zdGFydE9mKHVuaXQpIDogbWluOwoJCQltYXggPSBtYXggPT09IE1JTl9JTlRFR0VSID8gK21vbWVudCgpLmVuZE9mKHVuaXQpICsgMSA6IG1heDsKCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IG1heCBpcyBzdHJpY3RseSBoaWdoZXIgdGhhbiBtaW4gKHJlcXVpcmVkIGJ5IHRoZSBsb29rdXAgdGFibGUpCgkJCW1lLm1pbiA9IE1hdGgubWluKG1pbiwgbWF4KTsKCQkJbWUubWF4ID0gTWF0aC5tYXgobWluICsgMSwgbWF4KTsKCgkJCS8vIFBSSVZBVEUKCQkJbWUuX2hvcml6b250YWwgPSBtZS5pc0hvcml6b250YWwoKTsKCQkJbWUuX3RhYmxlID0gW107CgkJCW1lLl90aW1lc3RhbXBzID0gewoJCQkJZGF0YTogdGltZXN0YW1wcywKCQkJCWRhdGFzZXRzOiBkYXRhc2V0cywKCQkJCWxhYmVsczogbGFiZWxzCgkJCX07CgkJfSwKCgkJYnVpbGRUaWNrczogZnVuY3Rpb24oKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBtaW4gPSBtZS5taW47CgkJCXZhciBtYXggPSBtZS5tYXg7CgkJCXZhciBvcHRpb25zID0gbWUub3B0aW9uczsKCQkJdmFyIHRpbWVPcHRzID0gb3B0aW9ucy50aW1lOwoJCQl2YXIgdGltZXN0YW1wcyA9IFtdOwoJCQl2YXIgdGlja3MgPSBbXTsKCQkJdmFyIGksIGlsZW4sIHRpbWVzdGFtcDsKCgkJCXN3aXRjaCAob3B0aW9ucy50aWNrcy5zb3VyY2UpIHsKCQkJY2FzZSAnZGF0YSc6CgkJCQl0aW1lc3RhbXBzID0gbWUuX3RpbWVzdGFtcHMuZGF0YTsKCQkJCWJyZWFrOwoJCQljYXNlICdsYWJlbHMnOgoJCQkJdGltZXN0YW1wcyA9IG1lLl90aW1lc3RhbXBzLmxhYmVsczsKCQkJCWJyZWFrOwoJCQljYXNlICdhdXRvJzoKCQkJZGVmYXVsdDoKCQkJCXRpbWVzdGFtcHMgPSBnZW5lcmF0ZShtaW4sIG1heCwgbWUuZ2V0TGFiZWxDYXBhY2l0eShtaW4pLCBvcHRpb25zKTsKCQkJfQoKCQkJaWYgKG9wdGlvbnMuYm91bmRzID09PSAndGlja3MnICYmIHRpbWVzdGFtcHMubGVuZ3RoKSB7CgkJCQltaW4gPSB0aW1lc3RhbXBzWzBdOwoJCQkJbWF4ID0gdGltZXN0YW1wc1t0aW1lc3RhbXBzLmxlbmd0aCAtIDFdOwoJCQl9CgoJCQkvLyBFbmZvcmNlIGxpbWl0cyB3aXRoIHVzZXIgbWluL21heCBvcHRpb25zCgkJCW1pbiA9IHBhcnNlKHRpbWVPcHRzLm1pbiwgbWUpIHx8IG1pbjsKCQkJbWF4ID0gcGFyc2UodGltZU9wdHMubWF4LCBtZSkgfHwgbWF4OwoKCQkJLy8gUmVtb3ZlIHRpY2tzIG91dHNpZGUgdGhlIG1pbi9tYXggcmFuZ2UKCQkJZm9yIChpID0gMCwgaWxlbiA9IHRpbWVzdGFtcHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CgkJCQl0aW1lc3RhbXAgPSB0aW1lc3RhbXBzW2ldOwoJCQkJaWYgKHRpbWVzdGFtcCA+PSBtaW4gJiYgdGltZXN0YW1wIDw9IG1heCkgewoJCQkJCXRpY2tzLnB1c2godGltZXN0YW1wKTsKCQkJCX0KCQkJfQoKCQkJbWUubWluID0gbWluOwoJCQltZS5tYXggPSBtYXg7CgoJCQkvLyBQUklWQVRFCgkJCW1lLl91bml0ID0gdGltZU9wdHMudW5pdCB8fCBkZXRlcm1pbmVVbml0Rm9yRm9ybWF0dGluZyh0aWNrcywgdGltZU9wdHMubWluVW5pdCwgbWUubWluLCBtZS5tYXgpOwoJCQltZS5fbWFqb3JVbml0ID0gZGV0ZXJtaW5lTWFqb3JVbml0KG1lLl91bml0KTsKCQkJbWUuX3RhYmxlID0gYnVpbGRMb29rdXBUYWJsZShtZS5fdGltZXN0YW1wcy5kYXRhLCBtaW4sIG1heCwgb3B0aW9ucy5kaXN0cmlidXRpb24pOwoJCQltZS5fb2Zmc2V0cyA9IGNvbXB1dGVPZmZzZXRzKG1lLl90YWJsZSwgdGlja3MsIG1pbiwgbWF4LCBvcHRpb25zKTsKCQkJbWUuX2xhYmVsRm9ybWF0ID0gZGV0ZXJtaW5lTGFiZWxGb3JtYXQobWUuX3RpbWVzdGFtcHMuZGF0YSwgdGltZU9wdHMpOwoKCQkJcmV0dXJuIHRpY2tzRnJvbVRpbWVzdGFtcHModGlja3MsIG1lLl9tYWpvclVuaXQpOwoJCX0sCgoJCWdldExhYmVsRm9ySW5kZXg6IGZ1bmN0aW9uKGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIGRhdGEgPSBtZS5jaGFydC5kYXRhOwoJCQl2YXIgdGltZU9wdHMgPSBtZS5vcHRpb25zLnRpbWU7CgkJCXZhciBsYWJlbCA9IGRhdGEubGFiZWxzICYmIGluZGV4IDwgZGF0YS5sYWJlbHMubGVuZ3RoID8gZGF0YS5sYWJlbHNbaW5kZXhdIDogJyc7CgkJCXZhciB2YWx1ZSA9IGRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhW2luZGV4XTsKCgkJCWlmIChoZWxwZXJzLmlzT2JqZWN0KHZhbHVlKSkgewoJCQkJbGFiZWwgPSBtZS5nZXRSaWdodFZhbHVlKHZhbHVlKTsKCQkJfQoJCQlpZiAodGltZU9wdHMudG9vbHRpcEZvcm1hdCkgewoJCQkJcmV0dXJuIG1vbWVudGlmeShsYWJlbCwgdGltZU9wdHMpLmZvcm1hdCh0aW1lT3B0cy50b29sdGlwRm9ybWF0KTsKCQkJfQoJCQlpZiAodHlwZW9mIGxhYmVsID09PSAnc3RyaW5nJykgewoJCQkJcmV0dXJuIGxhYmVsOwoJCQl9CgoJCQlyZXR1cm4gbW9tZW50aWZ5KGxhYmVsLCB0aW1lT3B0cykuZm9ybWF0KG1lLl9sYWJlbEZvcm1hdCk7CgkJfSwKCgkJLyoqCgkJICogRnVuY3Rpb24gdG8gZm9ybWF0IGFuIGluZGl2aWR1YWwgdGljayBtYXJrCgkJICogQHByaXZhdGUKCQkgKi8KCQl0aWNrRm9ybWF0RnVuY3Rpb246IGZ1bmN0aW9uKHRpY2ssIGluZGV4LCB0aWNrcywgZm9ybWF0T3ZlcnJpZGUpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIG9wdGlvbnMgPSBtZS5vcHRpb25zOwoJCQl2YXIgdGltZSA9IHRpY2sudmFsdWVPZigpOwoJCQl2YXIgZm9ybWF0cyA9IG9wdGlvbnMudGltZS5kaXNwbGF5Rm9ybWF0czsKCQkJdmFyIG1pbm9yRm9ybWF0ID0gZm9ybWF0c1ttZS5fdW5pdF07CgkJCXZhciBtYWpvclVuaXQgPSBtZS5fbWFqb3JVbml0OwoJCQl2YXIgbWFqb3JGb3JtYXQgPSBmb3JtYXRzW21ham9yVW5pdF07CgkJCXZhciBtYWpvclRpbWUgPSB0aWNrLmNsb25lKCkuc3RhcnRPZihtYWpvclVuaXQpLnZhbHVlT2YoKTsKCQkJdmFyIG1ham9yVGlja09wdHMgPSBvcHRpb25zLnRpY2tzLm1ham9yOwoJCQl2YXIgbWFqb3IgPSBtYWpvclRpY2tPcHRzLmVuYWJsZWQgJiYgbWFqb3JVbml0ICYmIG1ham9yRm9ybWF0ICYmIHRpbWUgPT09IG1ham9yVGltZTsKCQkJdmFyIGxhYmVsID0gdGljay5mb3JtYXQoZm9ybWF0T3ZlcnJpZGUgPyBmb3JtYXRPdmVycmlkZSA6IG1ham9yID8gbWFqb3JGb3JtYXQgOiBtaW5vckZvcm1hdCk7CgkJCXZhciB0aWNrT3B0cyA9IG1ham9yID8gbWFqb3JUaWNrT3B0cyA6IG9wdGlvbnMudGlja3MubWlub3I7CgkJCXZhciBmb3JtYXR0ZXIgPSBoZWxwZXJzLnZhbHVlT3JEZWZhdWx0KHRpY2tPcHRzLmNhbGxiYWNrLCB0aWNrT3B0cy51c2VyQ2FsbGJhY2spOwoKCQkJcmV0dXJuIGZvcm1hdHRlciA/IGZvcm1hdHRlcihsYWJlbCwgaW5kZXgsIHRpY2tzKSA6IGxhYmVsOwoJCX0sCgoJCWNvbnZlcnRUaWNrc1RvTGFiZWxzOiBmdW5jdGlvbih0aWNrcykgewoJCQl2YXIgbGFiZWxzID0gW107CgkJCXZhciBpLCBpbGVuOwoKCQkJZm9yIChpID0gMCwgaWxlbiA9IHRpY2tzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewoJCQkJbGFiZWxzLnB1c2godGhpcy50aWNrRm9ybWF0RnVuY3Rpb24obW9tZW50KHRpY2tzW2ldLnZhbHVlKSwgaSwgdGlja3MpKTsKCQkJfQoKCQkJcmV0dXJuIGxhYmVsczsKCQl9LAoKCQkvKioKCQkgKiBAcHJpdmF0ZQoJCSAqLwoJCWdldFBpeGVsRm9yT2Zmc2V0OiBmdW5jdGlvbih0aW1lKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBzaXplID0gbWUuX2hvcml6b250YWwgPyBtZS53aWR0aCA6IG1lLmhlaWdodDsKCQkJdmFyIHN0YXJ0ID0gbWUuX2hvcml6b250YWwgPyBtZS5sZWZ0IDogbWUudG9wOwoJCQl2YXIgcG9zID0gaW50ZXJwb2xhdGUobWUuX3RhYmxlLCAndGltZScsIHRpbWUsICdwb3MnKTsKCgkJCXJldHVybiBzdGFydCArIHNpemUgKiAobWUuX29mZnNldHMubGVmdCArIHBvcykgLyAobWUuX29mZnNldHMubGVmdCArIDEgKyBtZS5fb2Zmc2V0cy5yaWdodCk7CgkJfSwKCgkJZ2V0UGl4ZWxGb3JWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIHRpbWUgPSBudWxsOwoKCQkJaWYgKGluZGV4ICE9PSB1bmRlZmluZWQgJiYgZGF0YXNldEluZGV4ICE9PSB1bmRlZmluZWQpIHsKCQkJCXRpbWUgPSBtZS5fdGltZXN0YW1wcy5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdW2luZGV4XTsKCQkJfQoKCQkJaWYgKHRpbWUgPT09IG51bGwpIHsKCQkJCXRpbWUgPSBwYXJzZSh2YWx1ZSwgbWUpOwoJCQl9CgoJCQlpZiAodGltZSAhPT0gbnVsbCkgewoJCQkJcmV0dXJuIG1lLmdldFBpeGVsRm9yT2Zmc2V0KHRpbWUpOwoJCQl9CgkJfSwKCgkJZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbihpbmRleCkgewoJCQl2YXIgdGlja3MgPSB0aGlzLmdldFRpY2tzKCk7CgkJCXJldHVybiBpbmRleCA+PSAwICYmIGluZGV4IDwgdGlja3MubGVuZ3RoID8KCQkJCXRoaXMuZ2V0UGl4ZWxGb3JPZmZzZXQodGlja3NbaW5kZXhdLnZhbHVlKSA6CgkJCQludWxsOwoJCX0sCgoJCWdldFZhbHVlRm9yUGl4ZWw6IGZ1bmN0aW9uKHBpeGVsKSB7CgkJCXZhciBtZSA9IHRoaXM7CgkJCXZhciBzaXplID0gbWUuX2hvcml6b250YWwgPyBtZS53aWR0aCA6IG1lLmhlaWdodDsKCQkJdmFyIHN0YXJ0ID0gbWUuX2hvcml6b250YWwgPyBtZS5sZWZ0IDogbWUudG9wOwoJCQl2YXIgcG9zID0gKHNpemUgPyAocGl4ZWwgLSBzdGFydCkgLyBzaXplIDogMCkgKiAobWUuX29mZnNldHMubGVmdCArIDEgKyBtZS5fb2Zmc2V0cy5sZWZ0KSAtIG1lLl9vZmZzZXRzLnJpZ2h0OwoJCQl2YXIgdGltZSA9IGludGVycG9sYXRlKG1lLl90YWJsZSwgJ3BvcycsIHBvcywgJ3RpbWUnKTsKCgkJCXJldHVybiBtb21lbnQodGltZSk7CgkJfSwKCgkJLyoqCgkJICogQ3J1ZGUgYXBwcm94aW1hdGlvbiBvZiB3aGF0IHRoZSBsYWJlbCB3aWR0aCBtaWdodCBiZQoJCSAqIEBwcml2YXRlCgkJICovCgkJZ2V0TGFiZWxXaWR0aDogZnVuY3Rpb24obGFiZWwpIHsKCQkJdmFyIG1lID0gdGhpczsKCQkJdmFyIHRpY2tzT3B0cyA9IG1lLm9wdGlvbnMudGlja3M7CgkJCXZhciB0aWNrTGFiZWxXaWR0aCA9IG1lLmN0eC5tZWFzdXJlVGV4dChsYWJlbCkud2lkdGg7CgkJCXZhciBhbmdsZSA9IGhlbHBlcnMudG9SYWRpYW5zKHRpY2tzT3B0cy5tYXhSb3RhdGlvbik7CgkJCXZhciBjb3NSb3RhdGlvbiA9IE1hdGguY29zKGFuZ2xlKTsKCQkJdmFyIHNpblJvdGF0aW9uID0gTWF0aC5zaW4oYW5nbGUpOwoJCQl2YXIgdGlja0ZvbnRTaXplID0gaGVscGVycy52YWx1ZU9yRGVmYXVsdCh0aWNrc09wdHMuZm9udFNpemUsIGRlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Rm9udFNpemUpOwoKCQkJcmV0dXJuICh0aWNrTGFiZWxXaWR0aCAqIGNvc1JvdGF0aW9uKSArICh0aWNrRm9udFNpemUgKiBzaW5Sb3RhdGlvbik7CgkJfSwKCgkJLyoqCgkJICogQHByaXZhdGUKCQkgKi8KCQlnZXRMYWJlbENhcGFjaXR5OiBmdW5jdGlvbihleGFtcGxlVGltZSkgewoJCQl2YXIgbWUgPSB0aGlzOwoKCQkJdmFyIGZvcm1hdE92ZXJyaWRlID0gbWUub3B0aW9ucy50aW1lLmRpc3BsYXlGb3JtYXRzLm1pbGxpc2Vjb25kOwkvLyBQaWNrIHRoZSBsb25nZXN0IGZvcm1hdCBmb3IgZ3Vlc3RpbWF0aW9uCgoJCQl2YXIgZXhhbXBsZUxhYmVsID0gbWUudGlja0Zvcm1hdEZ1bmN0aW9uKG1vbWVudChleGFtcGxlVGltZSksIDAsIFtdLCBmb3JtYXRPdmVycmlkZSk7CgkJCXZhciB0aWNrTGFiZWxXaWR0aCA9IG1lLmdldExhYmVsV2lkdGgoZXhhbXBsZUxhYmVsKTsKCQkJdmFyIGlubmVyV2lkdGggPSBtZS5pc0hvcml6b250YWwoKSA/IG1lLndpZHRoIDogbWUuaGVpZ2h0OwoKCQkJdmFyIGNhcGFjaXR5ID0gTWF0aC5mbG9vcihpbm5lcldpZHRoIC8gdGlja0xhYmVsV2lkdGgpOwoJCQlyZXR1cm4gY2FwYWNpdHkgPiAwID8gY2FwYWNpdHkgOiAxOwoJCX0KCX0pOwoKCUNoYXJ0LnNjYWxlU2VydmljZS5yZWdpc3RlclNjYWxlVHlwZSgndGltZScsIFRpbWVTY2FsZSwgZGVmYXVsdENvbmZpZyk7Cn07Cgp9LHsiMjUiOjI1LCI0NSI6NDUsIjYiOjZ9XX0se30sWzddKSg3KQp9KTs="></script>
<!--<script type="text/javascript" src="./Chart.PieceLabel.min.js"></script> https://github.com/emn178/Chart.PieceLabel.js-->
<script type="text/javascript" src="data:text/javascript;base64,LyoqCiAqIFtDaGFydC5QaWVjZUxhYmVsLmpzXXtAbGluayBodHRwczovL2dpdGh1Yi5jb20vZW1uMTc4L0NoYXJ0LlBpZWNlTGFiZWwuanN9CiAqCiAqIEB2ZXJzaW9uIDAuOS4wCiAqIEBhdXRob3IgQ2hlbiwgWWktQ3l1YW4gW2VtbjE3OEBnbWFpbC5jb21dCiAqIEBjb3B5cmlnaHQgQ2hlbiwgWWktQ3l1YW4gMjAxNwogKiBAbGljZW5zZSBNSVQKICovCihmdW5jdGlvbigpe2Z1bmN0aW9uIGMoKXt0aGlzLmRyYXdEYXRhc2V0PXRoaXMuZHJhd0RhdGFzZXQuYmluZCh0aGlzKX0idW5kZWZpbmVkIj09PXR5cGVvZiBDaGFydD9jb25zb2xlLndhcm4oIkNhbiBub3QgZmluZCBDaGFydCBvYmplY3QuIik6KGMucHJvdG90eXBlLmJlZm9yZURhdGFzZXRzVXBkYXRlPWZ1bmN0aW9uKGEpe2lmKHRoaXMucGFyc2VPcHRpb25zKGEpJiYib3V0c2lkZSI9PT10aGlzLnBvc2l0aW9uKXt2YXIgYj0xLjUqdGhpcy5mb250U2l6ZSsyO2EuY2hhcnRBcmVhLnRvcCs9YjthLmNoYXJ0QXJlYS5ib3R0b20tPWJ9fSxjLnByb3RvdHlwZS5hZnRlckRhdGFzZXRzRHJhdz1mdW5jdGlvbihhKXt0aGlzLnBhcnNlT3B0aW9ucyhhKSYmKHRoaXMubGFiZWxCb3VuZHM9W10sYS5jb25maWcuZGF0YS5kYXRhc2V0cy5mb3JFYWNoKHRoaXMuZHJhd0RhdGFzZXQpKX0sYy5wcm90b3R5cGUuZHJhd0RhdGFzZXQ9ZnVuY3Rpb24oYSl7Zm9yKHZhciBiPXRoaXMuY3R4LHA9dGhpcy5jaGFydEluc3RhbmNlLApsPWEuX21ldGFbT2JqZWN0LmtleXMoYS5fbWV0YSlbMF1dLGg9MCxmPTA7ZjxsLmRhdGEubGVuZ3RoO2YrKyl7dmFyIGc9bC5kYXRhW2ZdLGQ9Zy5fdmlldztpZigwIT09ZC5jaXJjdW1mZXJlbmNlfHx0aGlzLnNob3daZXJvKXtzd2l0Y2godGhpcy5yZW5kZXIpe2Nhc2UgInZhbHVlIjp2YXIgZT1hLmRhdGFbZl07dGhpcy5mb3JtYXQmJihlPXRoaXMuZm9ybWF0KGUpKTtlPWUudG9TdHJpbmcoKTticmVhaztjYXNlICJsYWJlbCI6ZT1wLmNvbmZpZy5kYXRhLmxhYmVsc1tmXTticmVhaztjYXNlICJpbWFnZSI6ZT10aGlzLmltYWdlc1tmXT90aGlzLmxvYWRJbWFnZSh0aGlzLmltYWdlc1tmXSk6IiI7YnJlYWs7ZGVmYXVsdDp2YXIgcT1kLmNpcmN1bWZlcmVuY2UvdGhpcy5vcHRpb25zLmNpcmN1bWZlcmVuY2UqMTAwO3E9cGFyc2VGbG9hdChxLnRvRml4ZWQodGhpcy5wcmVjaXNpb24pKTt0aGlzLnNob3dBY3R1YWxQZXJjZW50YWdlc3x8KGgrPXEsMTAwPGgmJihxLT1oLTEwMCxxPXBhcnNlRmxvYXQocS50b0ZpeGVkKHRoaXMucHJlY2lzaW9uKSkpKTsKZT1xKyIlIn0iZnVuY3Rpb24iPT09dHlwZW9mIHRoaXMucmVuZGVyJiYoZT10aGlzLnJlbmRlcih7bGFiZWw6cC5jb25maWcuZGF0YS5sYWJlbHNbZl0sdmFsdWU6YS5kYXRhW2ZdLHBlcmNlbnRhZ2U6cSxkYXRhc2V0OmEsaW5kZXg6Zn0pLCJvYmplY3QiPT09dHlwZW9mIGUmJihlPXRoaXMubG9hZEltYWdlKGUpKSk7aWYoIWUpYnJlYWs7Yi5zYXZlKCk7Yi5iZWdpblBhdGgoKTtiLmZvbnQ9Q2hhcnQuaGVscGVycy5mb250U3RyaW5nKHRoaXMuZm9udFNpemUsdGhpcy5mb250U3R5bGUsdGhpcy5mb250RmFtaWx5KTtpZigib3V0c2lkZSI9PT10aGlzLnBvc2l0aW9ufHwiYm9yZGVyIj09PXRoaXMucG9zaXRpb24mJiJwaWUiPT09cC5jb25maWcudHlwZSl7dmFyIGs9ZC5vdXRlclJhZGl1cy8yO3ZhciBjLG09dGhpcy5mb250U2l6ZSsyO3ZhciBuPWQuc3RhcnRBbmdsZSsoZC5lbmRBbmdsZS1kLnN0YXJ0QW5nbGUpLzI7ImJvcmRlciI9PT10aGlzLnBvc2l0aW9uP2M9KGQub3V0ZXJSYWRpdXMtCmspLzIrazoib3V0c2lkZSI9PT10aGlzLnBvc2l0aW9uJiYoYz1kLm91dGVyUmFkaXVzLWsrayttKTtuPXt4OmQueCtNYXRoLmNvcyhuKSpjLHk6ZC55K01hdGguc2luKG4pKmN9O2lmKCJvdXRzaWRlIj09PXRoaXMucG9zaXRpb24pe24ueD1uLng8ZC54P24ueC1tOm4ueCttO3ZhciByPWQub3V0ZXJSYWRpdXMrbX19ZWxzZSBrPWQuaW5uZXJSYWRpdXMsbj1nLnRvb2x0aXBQb3NpdGlvbigpO209dGhpcy5mb250Q29sb3I7ImZ1bmN0aW9uIj09PXR5cGVvZiBtP209bSh7bGFiZWw6cC5jb25maWcuZGF0YS5sYWJlbHNbZl0sdmFsdWU6YS5kYXRhW2ZdLHBlcmNlbnRhZ2U6cSx0ZXh0OmUsYmFja2dyb3VuZENvbG9yOmEuYmFja2dyb3VuZENvbG9yW2ZdLGRhdGFzZXQ6YSxpbmRleDpmfSk6InN0cmluZyIhPT10eXBlb2YgbSYmKG09bVtmXXx8dGhpcy5vcHRpb25zLmRlZmF1bHRGb250Q29sb3IpO2lmKHRoaXMuYXJjKXJ8fChyPShrK2Qub3V0ZXJSYWRpdXMpLzIpLGIuZmlsbFN0eWxlPQptLGIudGV4dEJhc2VsaW5lPSJtaWRkbGUiLHRoaXMuZHJhd0FyY1RleHQoZSxyLGQsdGhpcy5vdmVybGFwKTtlbHNle2s9dGhpcy5tZWFzdXJlVGV4dChlKTtkPW4ueC1rLndpZHRoLzI7az1uLngray53aWR0aC8yO3ZhciB0PW4ueS10aGlzLmZvbnRTaXplLzIsdT1uLnkrdGhpcy5mb250U2l6ZS8yOyh0aGlzLm92ZXJsYXB8fCgib3V0c2lkZSI9PT10aGlzLnBvc2l0aW9uP3RoaXMuY2hlY2tUZXh0Qm91bmQoZCxrLHQsdSk6Zy5pblJhbmdlKGQsdCkmJmcuaW5SYW5nZShkLHUpJiZnLmluUmFuZ2Uoayx0KSYmZy5pblJhbmdlKGssdSkpKSYmdGhpcy5maWxsVGV4dChlLG4sbSl9Yi5yZXN0b3JlKCl9fX0sYy5wcm90b3R5cGUucGFyc2VPcHRpb25zPWZ1bmN0aW9uKGEpe3ZhciBiPWEub3B0aW9ucy5waWVjZUxhYmVsO3JldHVybiBiPyh0aGlzLmNoYXJ0SW5zdGFuY2U9YSx0aGlzLmN0eD1hLmNoYXJ0LmN0eCx0aGlzLm9wdGlvbnM9YS5jb25maWcub3B0aW9ucyx0aGlzLnJlbmRlcj0KYi5yZW5kZXJ8fGIubW9kZSx0aGlzLnBvc2l0aW9uPWIucG9zaXRpb258fCJkZWZhdWx0Iix0aGlzLmFyYz1iLmFyYyx0aGlzLmZvcm1hdD1iLmZvcm1hdCx0aGlzLnByZWNpc2lvbj1iLnByZWNpc2lvbnx8MCx0aGlzLmZvbnRTaXplPWIuZm9udFNpemV8fHRoaXMub3B0aW9ucy5kZWZhdWx0Rm9udFNpemUsdGhpcy5mb250Q29sb3I9Yi5mb250Q29sb3J8fHRoaXMub3B0aW9ucy5kZWZhdWx0Rm9udENvbG9yLHRoaXMuZm9udFN0eWxlPWIuZm9udFN0eWxlfHx0aGlzLm9wdGlvbnMuZGVmYXVsdEZvbnRTdHlsZSx0aGlzLmZvbnRGYW1pbHk9Yi5mb250RmFtaWx5fHx0aGlzLm9wdGlvbnMuZGVmYXVsdEZvbnRGYW1pbHksdGhpcy5oYXNUb29sdGlwPWEudG9vbHRpcC5fYWN0aXZlJiZhLnRvb2x0aXAuX2FjdGl2ZS5sZW5ndGgsdGhpcy5zaG93WmVybz1iLnNob3daZXJvLHRoaXMub3ZlcmxhcD1iLm92ZXJsYXAsdGhpcy5pbWFnZXM9Yi5pbWFnZXN8fFtdLHRoaXMuc2hvd0FjdHVhbFBlcmNlbnRhZ2VzPQpiLnNob3dBY3R1YWxQZXJjZW50YWdlc3x8ITEsITApOiExfSxjLnByb3RvdHlwZS5jaGVja1RleHRCb3VuZD1mdW5jdGlvbihhLGIscCxsKXtmb3IodmFyIGg9dGhpcy5sYWJlbEJvdW5kcyxmPTA7ZjxoLmxlbmd0aDsrK2Ype2Zvcih2YXIgZz1oW2ZdLGQ9W1thLHBdLFthLGxdLFtiLHBdLFtiLGxdXSxlPTA7ZTxkLmxlbmd0aDsrK2Upe3ZhciBjPWRbZV1bMF0saz1kW2VdWzFdO2lmKGM+PWcubGVmdCYmYzw9Zy5yaWdodCYmaz49Zy50b3AmJms8PWcuYm90dG9tKXJldHVybiExfWQ9W1tnLmxlZnQsZy50b3BdLFtnLmxlZnQsZy5ib3R0b21dLFtnLnJpZ2h0LGcudG9wXSxbZy5yaWdodCxnLmJvdHRvbV1dO2ZvcihlPTA7ZTxkLmxlbmd0aDsrK2UpaWYoYz1kW2VdWzBdLGs9ZFtlXVsxXSxjPj1hJiZjPD1iJiZrPj1wJiZrPD1sKXJldHVybiExfWgucHVzaCh7bGVmdDphLHJpZ2h0OmIsdG9wOnAsYm90dG9tOmx9KTtyZXR1cm4hMH0sYy5wcm90b3R5cGUubWVhc3VyZVRleHQ9ZnVuY3Rpb24oYSl7cmV0dXJuIm9iamVjdCI9PT0KdHlwZW9mIGE/e3dpZHRoOmEud2lkdGgsaGVpZ2h0OmEuaGVpZ2h0fTp0aGlzLmN0eC5tZWFzdXJlVGV4dChhKX0sYy5wcm90b3R5cGUuZmlsbFRleHQ9ZnVuY3Rpb24oYSxiLHApe3ZhciBjPXRoaXMuY3R4OyJvYmplY3QiPT09dHlwZW9mIGE/Yy5kcmF3SW1hZ2UoYSxiLngtYS53aWR0aC8yLGIueS1hLmhlaWdodC8yLGEud2lkdGgsYS5oZWlnaHQpOihjLmZpbGxTdHlsZT1wLGMudGV4dEJhc2VsaW5lPSJ0b3AiLGMudGV4dEFsaWduPSJjZW50ZXIiLGMuZmlsbFRleHQoYSxiLngsYi55LXRoaXMuZm9udFNpemUvMikpfSxjLnByb3RvdHlwZS5sb2FkSW1hZ2U9ZnVuY3Rpb24oYSl7dmFyIGI9bmV3IEltYWdlO2Iuc3JjPWEuc3JjO2Iud2lkdGg9YS53aWR0aDtiLmhlaWdodD1hLmhlaWdodDtyZXR1cm4gYn0sYy5wcm90b3R5cGUuZHJhd0FyY1RleHQ9ZnVuY3Rpb24oYSxiLGMsbCl7dmFyIGg9dGhpcy5jdHgsZj1jLngsZz1jLnksZD1jLnN0YXJ0QW5nbGU7Yz1jLmVuZEFuZ2xlO2guc2F2ZSgpOwpoLnRyYW5zbGF0ZShmLGcpO2c9Yy1kO2QrPU1hdGguUEkvMjtjKz1NYXRoLlBJLzI7dmFyIGU9ZDtmPXRoaXMubWVhc3VyZVRleHQoYSk7ZCs9KGMtKGYud2lkdGgvYitkKSkvMjtpZihsfHwhKGMtZD5nKSlpZigic3RyaW5nIj09PXR5cGVvZiBhKWZvcihoLnJvdGF0ZShkKSxsPTA7bDxhLmxlbmd0aDtsKyspZD1hLmNoYXJBdChsKSxmPWgubWVhc3VyZVRleHQoZCksaC5zYXZlKCksaC50cmFuc2xhdGUoMCwtMSpiKSxoLmZpbGxUZXh0KGQsMCwwKSxoLnJlc3RvcmUoKSxoLnJvdGF0ZShmLndpZHRoL2IpO2Vsc2UgaC5yb3RhdGUoKGUrYykvMiksaC50cmFuc2xhdGUoMCwtMSpiKSx0aGlzLmZpbGxUZXh0KGEse3g6MCx5OjB9KTtoLnJlc3RvcmUoKX0sQ2hhcnQucGx1Z2luU2VydmljZS5yZWdpc3Rlcih7YmVmb3JlSW5pdDpmdW5jdGlvbihhKXthLnBpZWNlTGFiZWw9bmV3IGN9LGJlZm9yZURhdGFzZXRzVXBkYXRlOmZ1bmN0aW9uKGEpe2EucGllY2VMYWJlbC5iZWZvcmVEYXRhc2V0c1VwZGF0ZShhKX0sCmFmdGVyRGF0YXNldHNEcmF3OmZ1bmN0aW9uKGEpe2EucGllY2VMYWJlbC5hZnRlckRhdGFzZXRzRHJhdyhhKX19KSl9KSgpOwo="></script>
<script type="text/javascript">
function hexToRgb(hex) {
	if( hex.indexOf('rgb(') !== -1 ){
		result = hex.split('(')[1].split(')')[0].split(',');
		return {
			'r': parseInt(result[0], 10),
			'g': parseInt(result[1], 10),
			'b': parseInt(result[2], 10)		
		};
	}
	// Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
	var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
	hex = hex.replace(shorthandRegex, function (m, r, g, b) {
		return r + r + g + g + b + b;
	});
	var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
	return result ? {
		'r': parseInt(result[1], 16),
		'g': parseInt(result[2], 16),
		'b': parseInt(result[3], 16)
	} : null;
}
	
var stats = "%STATS%";// A REMPLACER
if( stats === '%STATS%' )
	stats = {"global": {"link": 0, "nb": 191, "open": 24, "vba": 18, "form": 0}, "group1": {"DIRECTION DES RISQUES": {"link": 0, "nb": 108, "open": 3, "vba": 0, "form": 0}, "DIRECTION  INTERNATIONAL - STRATEGIE - ETUDES ET DEVELOPPEMENT": {"link": 0, "nb": 53, "open": 3, "vba": 0, "form": 0}, "COMPTABILITE": {"link": 0, "nb": 30, "open": 0, "vba": 0, "form": 0}}, "group3": {}, "group2": {"Bpifrance Fin.": {"link": 0, "nb": 138, "open": 4, "vba": 0, "form": 0}, "Bpifrance Invest.": {"link": 0, "nb": 33, "open": 2, "vba": 0, "form": 0}, "Bpif Assurance Exp": {"link": 0, "nb": 20, "open": 0, "vba": 0, "form": 0}}};

window.chartColors = {
	red: 'rgb(255, 99, 132)',
	orange: 'rgb(255, 159, 64)',
	yellow: 'rgb(255, 205, 86)',
	green: 'rgb(75, 192, 192)',
	blue: 'rgb(54, 162, 235)',
	purple: 'rgb(153, 102, 255)',
	grey: 'rgb(201, 203, 207)'
};
window.chartColorsGreyFirst = [
	window.chartColors.grey,
	window.chartColors.red,
	window.chartColors.orange,
	window.chartColors.yellow
];
window.chartColorsRedFirst = [
	window.chartColors.blue,
	window.chartColors.red,
	window.chartColors.orange,
	window.chartColors.yellow
];


function createPie( ctx, data, labels, color )
{
	ctx = document.querySelector(ctx);
	if( !ctx )
		return ;

	var total = data.reduce((pv, cv) => pv+cv, 0);
		
	if( total === 0 ){
		ctx.parentNode.parentNode.removeChild(ctx.parentNode);
		return ;
	}

	function makeLabels( i )
	{
		if( i >= data.length )
			return ;
		if( data[i] > 0 ) {
			//var tmp = data[i]*100/total;
			//labels[i] = tmp.toFixed(1)+'% ('+data[i]+'/'+total+') '+labels[i];
			labels[i] = data[i]+'/'+total+' - '+labels[i];
		}else{
			data.splice(i,1);
			labels.splice(i,1);
			makeLabels(i);
		}
	}
	for( var i=0; i<data.length; ++i )
		makeLabels(i);
		
	if( data.length <= 1 ){
		ctx.parentNode.parentNode.removeChild(ctx.parentNode);
		return ;
	}

	// Ajustement de la taille du cadre
	ctx.parentNode.style.width = window.colSize;

	var config = {
		type: 'pie',
		data: {
			datasets: [{
				data: data,
				backgroundColor: color,
				label: 'Dataset 1'
			}],
			labels: labels
		},
		options: {
			responsive: true,
			cutoutPercentage: 50,
			legend: {
				position: 'top',
			},
			pieceLabel: {
				render: 'percentage',
				//render: function (args) {
				//	total = args.dataset.data.reduce((pv, cv) => pv+cv, 0);
				//	return args.percentage+'% ('+args.value+'/'+total+')';
				//},
				fontColor: function (data) {
					var rgb = hexToRgb(data.dataset.backgroundColor[data.index]);
					var threshold = 140;
					var luminance = 0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b;
					return luminance > threshold ? 'black' : 'white';
				},
				fontStyle: 'bold',
				precision: 2,
				overlap: true,// Autoriser le dépassement du cercle ?
				//position: 'outside'
			}
		},
		
	};
	new Chart(ctx.getContext('2d'), config);
}


String.prototype.strip = function( delim )
{
	return this.replace(new RegExp('['+delim+']+$','ig'),'').replace(new RegExp('^['+delim+']+','ig'),'');
};
String.prototype.title = function()
{
	return this.charAt(0).toUpperCase() + this.toLowerCase().slice(1);
};


window.onload = function() {
	// Global
	switch((stats['global']['open']>0?1:0) + (stats['global']['link']>0?1:0) + (stats['global']['form']>0?1:0) + (stats['global']['vba']>0?1:0)){
		case 1:
			window.colSize = '100%';
			break;
		case 2:
			window.colSize = '48%';
			break;
		case 3:
			window.colSize = '30%';
			break;
		case 4:
			window.colSize = '23%';
			break;	
	}

	createPie('#global-pie .chart_vba', [stats['global']['nb']-stats['global']['vba'], stats['global']['vba']], ['Utilisateur n\'ayant pas ouvert le document', 'Victime ayant executé un code malveillant'], window.chartColorsGreyFirst);
	createPie('#global-pie .chart_open', [stats['global']['nb']-stats['global']['open'], stats['global']['open']], ['Utilisateur n\'ayant pas ouvert l\'email', 'Victime ayant ouvert l\'email malveillant'], window.chartColorsGreyFirst);
	createPie('#global-pie .chart_link', [stats['global']['nb']-stats['global']['link'], stats['global']['link']], ['Utilisateur n\'ayant pas ouvert le(s) lien(s)', 'Victime ayant ouvert le(s) lien(s) malveillant'], window.chartColorsGreyFirst);
	createPie('#global-pie .chart_form', [stats['global']['nb']-stats['global']['form'], stats['global']['form']], ['Utilisateur n\'ayant pas remplis le formulaire', 'Victime ayant remplis le formulaire malveillant'], window.chartColorsGreyFirst);
	createPie('#global-pie .chart_ratio_vbaVSopen', [stats['global']['open']-stats['global']['vba'], stats['global']['vba']], ['Utilisateur ayant ouvert l\'email mais pas le document', 'Victime ayant ouvert l\'email et executé un code malveillant'], window.chartColorsGreyFirst);

	for( var i=1; i<=3; ++i )
	{
		var k = Object.keys(stats['group'+i]);
		if( k.length ){
			var titles = '';
			var victim = [];
			var nbVictim = {
				'open':[],
				'link':[],
				'form':[],
				'vba' :[]
			};
			var sum = {
				'open':0,
				'link':0,
				'form':0,
				'vba' :0
			};
			for( var l=0; l<k.length; ++l )
			{
				var cleanTitle = k[l].strip('\r\n\t \.\,\;\!\:\?').title();
				if( cleanTitle === 'Null' || cleanTitle === '' )
					cleanTitle = 'Hors groupe';
				victim.push(cleanTitle);
				nbVictim['open'].push(stats['group'+i][k[l]]['open']);
				sum['open'] += stats['group'+i][k[l]]['open'];
				nbVictim['link'].push(stats['group'+i][k[l]]['link']);
				sum['link'] += stats['group'+i][k[l]]['link'];
				nbVictim['form'].push(stats['group'+i][k[l]]['form']);
				sum['form'] += stats['group'+i][k[l]]['form'];
				nbVictim['vba'].push(stats['group'+i][k[l]]['vba']);
				sum['vba'] += stats['group'+i][k[l]]['vba'];
				titles += cleanTitle+' / ';
			}
			document.querySelector('#group'+i+'-pie .listGroup').innerText = titles.strip('/ ');
			
			createPie('#group'+i+'-pie .chart_open', nbVictim['open'], victim, window.chartColorsRedFirst);
			createPie('#group'+i+'-pie .chart_link', nbVictim['link'], victim, window.chartColorsRedFirst);
			createPie('#group'+i+'-pie .chart_form', nbVictim['form'], victim, window.chartColorsRedFirst);
			createPie('#group'+i+'-pie .chart_vba',  nbVictim['vba'] , victim, window.chartColorsRedFirst);
		}else{
			var ctx;
			if( (ctx = document.querySelector('#group'+i+'-pie')) )
				ctx.parentNode.removeChild(ctx);
			if( (ctx = document.querySelector('#group'+i+'-time')) )			
				ctx.parentNode.removeChild(ctx);
			if( (ctx = document.querySelector('.group'+i+'-pageBreak')) )
				ctx.parentNode.removeChild(ctx);
		}
	}
	
	
	// Génération des pages breaker pour le PDF
	var mainLogo = document.querySelector('.header')
	var data = mainLogo.outerHTML;
	var elt = document.querySelectorAll('.pageBreak');
	for( var i=0,len=elt.length; i<len; ++i )
		elt[i].innerHTML = data.replace('%i', i+2).replace('%j', len+1);
	mainLogo.outerHTML = data.replace('%i', 1).replace('%j', elt.length+1);
	
	
	window.onbeforeprint = function(){
		return ;
		for( var id in Chart.instances )
			Chart.instances[id].resize();
	};
};

</script>


<style type="text/css">
.tbl {
	padding-right: -400px;
}
html, body {
	margin: 0px;
	padding: 0px;

	color: #707070;
	font-size: 16px;
	line-height: 26px;
	font-style: normal;
	font-weight: 400;
}
body {
	width: 75%;
	margin: auto;
}
.pageBreak {
	display: none;
}

@media print {
	body {
		width: 100%;
		margin: 0px;
	}
	.pageBreak {
		page-break-before: always;
		display:block;
	}
	.info {
		margin-top:130px !important;
	}
	hr {
		display: none;
	}
}

.logo {
	color: #ffffff;
	font-size: 320%;
	line-height: 100%;
	font-family: 'Open Sans', sans-serif;
	font-style: italic;
	font-weight: 300;
	text-shadow: none;
	letter-spacing: 0px;
	text-transform: uppercase;
    text-shadow: #000 1px 0 10pt;
	width:100%;
	height:400px;
	overflow:hidden;
	background:url(https://www.cc-jarnac.fr/wp-content/uploads/2018/12/google-et-facebook-escroquerie-phishing-100-millions-dollars.jpg);
	background-position-y: 40%;
}
.header img {
	display: block;
	position: absolute;
}


/* Logo spécial impression */
.pageBreak .logo {
    background-position-y: -350px !important;
	height: 50px !important;
}
.pageBreak .info {
    margin-top: 0px !important;
}
.pageBreak .title {
	display: none;
}
.pageBreak .title_underline {
	display: none;
}
.pageBreak .header img {
	display:none !important;
}
.pageBreak .whitespace {
	display:none !important;
}


.title {
	margin-left:5%;
	margin-top:10%;
}
.title_underline {
	width:20%;
	border-top:5px solid #0093d2;
	margin-left:5%;
	margin-top:2%;
}
@media screen and (max-width:950px) {
	.logo {
		height:150px !important;
	}
	.title {
		margin-left:5%;
		margin-top:5%;
	}
}

.tbl {
	display: block;
	float: left;
	width: 48%;
	/*width: 23%;*/
	
	text-align:center;
	font-weight: bolder;
	box-shadow: 0px 0px 40px -8px rgba(0,0,0,0.75);
	border-radius: 2px;
	margin-left: 15px;
	padding-bottom: 15px;
	margin-bottom: 15px;
}
.tbl:nth-child(odd) {
	float: right;
}
br, h1, hr {
	clear: both;
}
hr {
	margin-bottom: 100px;
}
.title_l2 {
	font-size: 200%;
	font-weight: bolder;
	text-decoration: underline;
	line-height: 210%;
}
.info {
	font-size:10pt;
	margin-top:105px;
}

.container {
	width: 95%;
	margin: auto;
}
</style>
</head><body>
<div class="header">
	<img style="max-width: 200px;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAaAAAADOCAYAAAB4v9bHAAAACXBIWXMAAA9hAAAPYQGoP6dpAAAgAElEQVR4nO3de1xUZeI/8M/5bte1WttM12wzNVMJ1DRX3S0tljRqDUlUctQJkBEQcPCOXCIQRU1E5CKDgKhDiLRIbrIqskoXMy+pENoNNWu/q1bb/hJr2+/u8/uDYAfmnDPD9cDM5/16+Xo55zm3GWbmM+d5nvM8ABERERERERERERERERERERERERERERERERF1dZI9K42fMEl09IkQEZFjOVp5QDVj/qezToSIiMgSA4iIiDTBACIiIk0wgIiISBMMICIi0sRNbdnYzdWlvc6DiIi6qarqmlZt16YAAgBTRopdXbmJiMjxGEKMrb5Nh1VwRESkCQYQERFpggFERESaYAAREZEmGEBERKQJBhAREWmCAURERJpgABERkSYYQEREpAkGEBERaYIBREREmmAAERGRJhhARESkCQYQERFpggFERESaYAAREZEmGEBERKQJBhAREWmCAURERJpgABERkSYYQEREpAkGEBERaYIBREREmmAAERGRJhhARESkCQYQERFpggFERESaYAAREZEmGEBERKQJBhAREWmCAURERJpgABERkSYYQEREpAkGEBERaYIBREREmmAAERGRJhhARESkCQYQERFpggFERESaYAAREZEmGEBERKQJBhAREWmCAURERJpgABERkSZu0voEiNpbxeFKERW7SrYsMT4a7k9OkDr5lJo4feasCA5bIlu2MHQ+fGdM0/T8WiJ9y1axs6BItmx7TgY2bErHlrSN3eb5UOfiFRAREWmCAURERJpgABERkSYYQEREpAl2QiDqZCNHDFdslD9aeaAzT4VIU7wCIiIiTTCAiIhIEwwgIiLSBNuAFLhP9hIzpnnht+N/g/kLFjUpy81KxdvvHsMbfyrD3pJC3mTXDqJiE8SzzzyNBx64HzNm+TcuL9yRjbPVNdj75n6YMlLa/bWeqfMX3l7PYeQIN/gFhjYpM2/LwrnzH2Pf/nKkb1rfLf/OYcZl4skJv8Pghwbh7l/2bPLaNti1MwfXvvoaNefO40/7DmCXObdDnqv7ZC/xnOfTeHLC7xBqXN6krKggF5cvf4kjb72DyGWL2nR898le4plJ7hg/bgz69e0L3UvzrdbJz8nAJ598hkOHK5G8LrHD/7YNz/2J341D376/kv07FBXk4sqVq9hu3oXU5LXd8v3WUk4VQFGxCaLi8FuyZTvytiB5UzoyUjdIL8evEboXp0MfEIL8nYVW6/rPDwcA7MzbgrFjRovolUtl3yxhxmUiIjxY9gMAAOtWx+GJx3/bojdaUGiEWLxwAeYGhMiWx0Uvx+RJv+8Sb161O/7n6mYieH6A5Be4QPjNnYXlUa9A7m/jOyew8f+v7SoW2bk7ULG/tF2eX2ZWjvjDc5NlvwwANPm7teTYau8zW9prJISX49eIqc8/h5DwJThx6rTqujNnBzR5fOStt0VRcWm7hm7E0pUiQD8bgSFGFP/xDatyy7/B0ffeF6acfORlp7fo+O6TvYR+9kw8NfEJzJwdgJLSNxXX1Vt8fqqra8TuP5bildhIu4+3NDJWhAbPg+/seVZlzUeAWBmTIHQv+mBe0ELZ596g4TVwf/IJe0+j23OqKrj//Oc/imVz/IJwd8+e2LAxTczzn9PkDapktl8Q9HN8kbB6vZAr35yyTvrk01rF7fvd1xdhxmWy2ypxc31EMXwA4PjJD1qyuw6l9nrffXdPGEKMwhgWhOVRr9i1v9R0E4INfu1ybruLS8R28y7F8OnIY3e0gsLd4kD5XxASLh/+tqyIisfyxeHYsDGtRe9NJQmr1wtjWBACQ4x2rb9oWTRCgwMxU+dv9/Ejlq4UqRvWYEv2NqtAtSUwxIgD5X9BQeFuu4938tQZ/OPb/ydbNjcgBIMHDQJQ/9znB+oxL2hhi87JWThVAP39229Vy+/vdx+8pz5n95cSAMzQBWDmdG/FIFELBN1L8zFihKvdxwKA4a4uimVZ6ck4faaqRfvrSAsWLlMsu/322zBXNxNBoYtbtM/kTRnINOW26Ysx05QrklMzW7xd8qYMrFmX3C5fyh2lsOh1sTkju837mTk7AMUlbyA1PatNz7dP796YOd1b9kpBTahxGWb5TrNr3Zfj14iwkEC7A07J5oxs7H59j13Pt2J/qfTVN98olg8aNKC+evf551r83J2JUwWQLR7uE6HTy1eXqdEHhMB76h9kyyoOv4WUV1crbjvCzRXuk73setOHGZeJfvf1VSw/W/Uhigvzu0T1my3Dhg7B0siXW7Wtx1MTEBQa0aovxltvuaVNVRyP/3Zcq7ftaMuj4sT4cWNsrpeTlYq0lHXIyUq1ue7kp91b/VoD9Z8pe2oT5Lg94mKzhiDMuEzoXpyu+rndnpOBl6OXYbFxARJficJr25UDOnlTBtIyTHY936tXrymW9ev7K/h4T2lzKDo6BpAFy6qtoMCXcPvtt+No5QGp1z2/xPLF4arbRsWuwqo1r1q9cSv2l0rvvve+4nZ9et+LsWNG2XV+bq4uiu1J5m1ZOPb+Sbv20xVYfimtjo/B0CGDcbTygHS08oDk88Lzql8ScwNCMPlp91Yd9557fomX5i1ofJy6YQ3mzvbFs888jRVLF6oeFwD69esL4+JI1S+o//v3v7Ejb0urzq8txv1mtOKv7fVrXoGbqwuOVh6QXIYNlUaPGim5DBsqHa08IE144rfIzkyR3e6leQtaHbq33HIzlq2Ma3y8bWs6FobOxySPpxBs8MOWtA2q29tTQ+D1/LOKAbdrZw58Z7yAwYMfkp6Z5CH5vOAluT81UfKfH46QIOVqut8/NQF+gQtshtDX3/xdsaxnz1/g0ZHDbe3C6TlVJwR7zZ3tC/2cWY1XEntLCqW9JYXY/foekbwpQ3G7MaMflV3+zrvHkJWebNWbDqiv6lgYat9V17ChDyuWXfz8MjanrOsWVz+WEl+JQsKaV5s07i82hko3bnwvisw5mKGT/6IYNnQI/AIXiJY2VDf0dCvcuRUFhcUYM2Z0k+1n6vxFWso6hBrlqw91+vl4caZ61dDaxDhpbWKcYrla54zWcp/sJQYNGCBbtnXLJsQnrlfs3bY2MU66UXdD7MjNxBz/YKvyR1yGwX2yl2hp5w/LDiRLjAsQHLbEqhOHrc/Ug/0fUCxbsy5ZxMQp1y6YC3fL9qir2F8qVewvxfadr4lMU57Vdv7zw7EgKAB52emK+wbUr4CU2mkTX4nCwUOHsWbVy1bnFb5oufhVnz745NPPVI/rSHgF1ExifDSCDf6yH7R9fz6IXJVqiwceuB/6gGCrX07FhfnS2aoPFbdzGTYEPr56m1UNatVvZ85Wq23eJW3PyUDR63tke5bFrFwqVdecV9zWLzAUri7DWn3s10v2yn457TLnSpVvv6u6ba97ftnq43aUhwcPxO233yZbduXqNZtdq5t3mMnPyUBayjq8HL0Mp89U4Zd392z1ucVGLcW0F7wkub/zvj8fRF52muK2asdVuzKLi15uszv3th2FSE1Oki0b7vaIzc/kje+/R+HOrWqrNMrOTMG4sY/B/amJklz4AEBq8lpp5fJFUkt/VHVnDKBm3j2qXF2Wl50unf/4E8Vyf0MYhjz8kGzZsfdPwrwtS7Zs/oJFGDnCTfW81KrfstKT8c67x1S374qqa86pTlZ28tQZ1e0HDZL/xW/LutVxWLRwgeJxP6w5j/wc5V/ld/ds/ZexFu7u2dOudkbPZ56WGqpBHx78kDR61EjpmUkekp9eJ7W2bdG8LQv7yg4qludlp0tffPlXxfLbb78d4ydMsjp3Wz/Iqj88Z/PcKvaXSmeq5H+4zV+wCOPHqrenfffdd/jxnz/aPE5+Tgaysrdh4/rVThMs9mIAWchIfVX2XhRL585/rFp+f7/7ZJfb6pLt+oj6r3m16rfu1PnA0qkPzqqWnz5Tpdg2AdQ39LaGrftitm5Jla5fv65Yfuttt7bquFoJCV+CiPAguzu7tKdPPq21WTWsVpV1089+Jrt88OBBij/IduRtwWcXLth1fp99dgFFBbmyZQ/8up9d+7Dl9ZI3umX1eGdgAFn429+u2LzR8Isv/6rawHxvr16KZWpdsocOGazY8GlcHCn69ZP/tbdrZw4+VKmq6qpyTZvx+eUvVNcpLsyXvvrqa8XyO+68Q7bKU82OvC121bF/+w/5ezy6qo8/qcX1uhuK5avXbkR+TjoOH3lLJG9KFy25x6Ytai9ctLnO37/9R4v327dPb8WyH374AVevfmXXfv7+7bf44fsfZMvuU7nCsldifHSbR3ZwZOyEYOHaV7bftFevfoUffpB/wwJQrIcH6rtkpyYnIXzRCqsyv8BQzPCZKrudq+swxW6mlz6/LNug2dVd/+468nMybZ63WhDcfPPN6NHj5y077vXryEjd0O1eL1sq9pdKF0PmqYZK8/vbxk+YJDZtWI3zH32CQ3+ptOvv0VJq1WttcU+vexTLAoPruz7LVd01d+bsh4odBn7xi7vg46sXbaldeO/Y8dZu6hQYQBa+u15nc53iwnwpOnKx4hu7Z89fKG5bsb9U+mC6t+K2I4bLdzkdNkS5+s1WdZKc1vbCaj7ESFt8V2f7tQagGvZz/IJafE9PncpVQndX8Ze3oNSTTcnCxSsb/1974YKoqq7Bm2UH22XcPXN+FlLTTG3djayev7irQ/Zr6dZbbkGvXq3vcJJr2oyk9cpVyMQquE539NhxxV4/Dz7wa6sb74yLI0Xfvn1k18/OTOmWnQ+09M8fbTcad1ebU9ZJZQcOtXp7nX4+ktZvQlV1DY4fPykWLFzapmq6f//fv/HDP5V/QLTF//xPx3913XLrLbjzzjtbvf2VK1c75KrSkTCALPz1r//b4cfIy06Xzp3/SLZM99J8uDUbaket+u2TTz/rlp0PAPWGZ2q9sBCD9NwzT2NnG2+EDV8ciVMfnMFmO0cFcES+s+fhlptvbvX2f7tytR3PxjGxCs5CH5WGzfb0/vFT2LUzR3bQxEdchjZ5PHDAg7L72LUzB5km+d473UEvlTp8apvolUulY8dPivAFBoz9zehWDS/VYOoUT3z77XoRozDie1e0IzcTp9vhvrgff/wRBw8dbtP2pI4BZOFnCl0+29uaVS9Lzz7ztOwvy759+8C4OFKkbFgj6QOCRd9fyVe/ddfOBw06owrFmTWM3gH8d06gIUMGNzbQ22uGLgDpm9bhzNm2Nca3t3/9+C/Fsut1dfB5wUvzc7WnTdnZ8VvAwq233mJzHR9fvbjpJuXc/tbOLqVKnQd0+vlwGTYEADDk4YfgbwiTXc/W/Uhd3a232H6tAeC225R7Fe7I22JzhHOqbxua9oKX5PqIi3S08oD0u/FjERYSiE0blIexsbRg4TKbN2V2NrVOLD1+/vM2DaBKnYdXQBZ63WO7Wqh3716qX4rfK9xT0Jza+HAPPTQQgHL1W152Gta+usmu48gZOWJ4q34dDh4sP8pDa9jbxVWtt9O//vUvh+7V1lFeXZvQ5DVftCxKvDj9BYQvjlTcpr1uymwvam2It91+W7cbrcJZ8QrIgj131t/f7z7M8QtSLLfnXiJAfXy4vr/qA31AsBg04EHZ8nPnP2rxbJFdzZ133oEBA/qrruPjqxdqbUX23ktE6pLXJUpjxoyWlkSEKq6jdt+NFr78UrnD0IxZ/q0epok6FwPIQp8+vREZ/YrqpbvakDhAy268Uxofzt8Qht+MGY17FO5BsDWETXfgO3seRrg9orrOyBFuqm0WX/7v39r7tJzaqQ/Ux97rSj757DNsVxmvb0g7Xq1Tx2EAWZg5OwDjxj6mXK7zFw1T7crJNW3GRx9/avfx1MaHGzncVbb3UmpyEt5RGTC1Oxk53E112mU3V/Xx8T77zL7xvhzdFG9fsTwqTmSacsWb+/aLk6dOi4sXL4nxEyaJwqLX26UtRG16dS1sSdso1V64pFi+bGWcXbPXmrZuE+MnTGr8V3PuvDh56rR46513RXtNSU7KGEDNjBo5HAmr18u+8XxeeF51hsPPP/+ixVVCSuPDLVkRK7v8g9NnbY5X110Ehhjh88LzsmUJq9eLUSoTeuVlp6G6xvaIx86gV6974Dd3FrbvLMSqpA0INS7Di3Pr5+J5bNRIm7OKNlC7uu+Me+RaSm1sRQCY5v286nMPMy4TT058vMmygPnhCDUuw7LIONymMqwWtQ92Qmhmhi4Au3bm4K677hQLQ4MkoP4X5hzdTKhNnAXY/kDIURsfrrm2dj7oipI3ZeBPb/5ZZG3dhr0lhRIAJK1PETN8vBQnowO6ZjtY2f6DIj5xvc311IZB2pSWpTqG2Y68LcjO3Y61iXGNzz0vO12a4TNVdps5/sHIyUpFnz69RXTkEtnXa4q3r5g+zQvpW3Jkj1m4Ixub0jtmSJ22iI5cIpVXHFaclE4fEIL8nAyr5+4+2Ut4TfHElOcmK94jlfLqakTGJHTMiVMjXgHJmDk7AIVFf0TDZflXX3+DjamZqtskxkdD6QOupmJ/qfTBafvadC5dutzlvnTbQ+LaZHz19TeNr3fp3n2qN09uz8nA/oMVnXiG9rn11o6fpmGOX5DsFAUHDx2GOV9+vqmA+eF4s+wAxk+YJGprL4iTp06Lk6dOi9NnzorPP78svvr6G8jNDNrg9NlqJK9L7JLvu9I39qnO3aQPCGl87ufOnRcXL14S33//PQqL/qj4HivcuRV/LP2Tw9Q0dGW8ArIQu3Ip4lfb/gXbXH5OBja34Rdiw/hwDdNFK2nNFVZX9WpSPHr1ugcvzVvQ4m3L/1LZLgOiOpLkdYnS4IcG2axqU5pDR0layjqs26A8C7DWNqesk3r3vlcU7twK39nzVNf1nx9uc39F5hzsfG13kytM6ji8ArJQe/ESFi2UH5pdSZE5B7t2l7Rpwim18eEapCYn2Zwsrzv5548/oqh4D4rM8tU+ShYtDFGcMt3ZBRv8Jb+5s9ptf0mJsVi3IdXmdN5ai1m5VMrKzkdOVtuCMicrFZmmbZy/pxMxgJrJNOUh2OBn17r5ORnING1De4yTdeLkadUv43PnP3K4KoGYlUulrXk7VatQLAUFvoTp06Y61GvQ3gzzXpJGPToCyetWtXof27amw+eF5zHxicelrh4+DVYnxEjLV8Zh+WLbVznN7dqZA2NYEJavjMPqhJhu8XwdhV0vtlKjqJurS7vMG9JZgkIjxJmz8jd/AsDsWTOwIGieBAB+gQuE1x88MdztEatqi6z0ZLx79H0UvV7abqGwMTVDFBXvkS0zb8vCxtTMbjetr1pjemJ8NNyfnCAB9Y3CM6Z54bfjf2M1MoR5WxbOVn2I0j+VOWT7V0eaqfMX7k8+geFuj6BP73sVq9+KCnLx92++xYVLl3DkrXe7bHuPvaZ4+4onJzyOcWMfQ7/7+jb2CLRk3paFi5c+x4lTp/HnAxUO9+OuMxlCjKKquka27GjlAdXXlW1ACvKy06W87HTZsuFu8hPHtcVjo0ZCKYA++bS224VPS1TsL5Uq9pfKlg0cyDvaW2uXOVfaZbY9Yvqv77+/E86m81gOxKqE76uugVVwXUBk9Cui/wO/Viw/+UHLZz0lIurqGEAac5/sJSZ5uMvODQTUdz4or6js5LMiIup4DCCNBRv8sDJW+YY3Rxr5gIjIEtuAOsmyyJfFzTf/9+W+66474eE+EaHG5YrbpG9ah9VrN3bG6RERdToGUCd5ZvLvERXbtGvsnjf2qW5zuPIddKVZKImI2hMDqItaEhGKad7PM3yIyGGxDagLWh0fg23bC7Q+DSKiDsUroC5mSUQoEta8yo4HROTwGECd5Pp31xXLzNuyUPVhDd4sO8hqNyJyGk4VQLZGUD5aeaDDjv38lGcVj+2od2WrDcPh/mTHvdZE1D2wDYiIiDTBACIiIk0wgIiISBMMICIi0gQDiIiINMEAIiIiTTCAiIhIEwwgIiLSBAOIiIg0wQAiIiJNMICIiEgTDCAiItIEA4iIiDTBACIiIk0wgIiISBMMICIi0gQDiIiINMEAIiIiTTCAiIhIEwwgIiLSBAOIiIg0wQAiIiJNMICIiEgTDCAiItIEA4iIiDRxk9YnQNQdTPXRid733tv4eODA/ujRo0fj47q6OtTWXmp8fPXaNewpNkudepJE3QwDiMjCVB+dGDCgPwYOeBDDXV3Qo8fPERaxAleuXsOVq9ca16v6sMbmvsZPmCQ2b0xCXd0NnK2uQe2Fi7hw4RKDiegnDCByah6e3mLc2Mcw3NUFbq4u8DeE4crVa3jv2AkUtMP+wyJWWC07d/4jUVVdg7PVNXjv2AmUl5UwkMgpMYDI6Xh4egsP9wnwcJ+IsIgVOFRxBIcqjnTa8f0NYU0enzh5SpRXHEF5RSXDiJwKOyGQ0zCEGEVRcYmoq6tD6d4y2asTLYRFrEDp3jLU1dWhqLhEGEKMQutzIuoMvAIihxcdlyimTvFEWMQKVFXbbruxlJedhitXr6K29hLq6uoAANfrbqD2wkWrdQcOeBB39Pg5AKBHjx4YOLA/+vTuDb/AULuPtzE1EwBwpPJtcbDiCFbFRfGKiBwWA4gcliHEKCLCg+FvCLOrii0tZS1qay/+1GHgEsz5JmnokIfb5Vx0eoMYOKA/hru6YODABxFqXK66/oroeAD11XOmnO0wZaQwiMjhMIDI4Uz10YnAgLlYtWaDVXtLc0mJsTj63gm8d+w4Ro96tMO+5M35pib7nuqjE+PGjsH4cY9hRVS84nYN1YRvlu0XG1O3sI2IHAoDiByKIcQoYiIXY4YuQHGdvOw0lB86jPKKI5j4xOOafKHvKTZLe4rNAOrDyMN9Ijx+/6Ridd2qNRtQZM5Bwpr+gldD5CgYQORQhru6KIZPXnYazK/txtAhD3epL3DLMIqJSxS6F6fLBtEMXQB0vj6dfXpEHYa94MjhFRXkwmvKsxg65GEpoYs36ifERUlDhzwseU15FkUFuVqfDlGH4hUQObww4/JuN/rAiqVG6b1jx9kdmxwaA4gcnj3hE7F0pXBzdcGgAQ/iel0dai9cwnvHTlh1HmgNnd4gxo19DAMH9McdP40fd+XqNdReuIj3jp1QPL89xWZp/IRJDCFyWAwgcmrRcYlC5+sDf0MY3jt2wqr83PmPRHbOdiSvT2xxEC1aGiUCA+bC3xAme99Qg9z8naKg8HX2cCOnwzYgckoent7izbL94lDFEdWu2v6GMBw9dhxFxSUtuhIpKi4RR48dl913UmIskhJjkZedBgDIztmOpFUx8PD05tUOORUGEDkdD09vkbQqBqvWbABQfwOqztcHOl8fGAL0so3/G1Mz7Q6houIS0TCigaWYyCXo0/teTHzicWniE49LQ4c8LLm5uiAtZS0GDngQEeFBbXtiRN0MA4icTkzkYgwc8GBjIIwe9agUGmKQQkMMkp9eJ/kFhsEQoLfabmNqJvLyzaohlJdvlg0fD/eJeNZzktS8vceUkSKNHvWoVLq3DOPHjsGipVG8CiKnwQAip5KWYRJ9+vTGiuh42UAAgPKyEslPr5M83CdabW/KyVcMiUVLo4QpJ99quYf7RNjq/u2n10kbUzMxy3ea/U+GqJtjAJHTmOqjEwAQalxu19hqCXFRktyVkFJVmdzyReHBNsPH8nile8ug0xt4FUROgQFETuN63Q2EhhiklvQ289PrpLSUtU2WzdAFWHUYmOqjE81HYEhLWYvpPt4t6tmWEBclWc68SuTIGEDkNFrbzTl5U9M2naTEWKt97Sk2S0mJsarb2YvdsclZ8D4gcnoent5i4IP9Gx9fvXatyc2h5nyTpNMbhIf7RFy5eg0JqzfI7idh9QZ4TXkWfXrfi/KKI7IjYPe+997Gx7UXLzFsyKkxgMhpGUKMQufrgxXR8aj6sOlEdefOfyTMhcWNE8KZ802SOd+kur/yshKpvKzEarnlza7Nq9feLNsvSveWcb4fckqsgiOnVFRcIqqqaxonfmuuYRK7EydPidbeIOrh6S1OnDylerPrqjUbUFVd0+IbXYkcAQOInJK9lxuS1LYLE3u35+UPOSMGEDml6T7ekpurC2Iil8iWp6WshYf7RIwe9WiLes1ZKi8rkUaPelTycJ/YOOxOczGRS+Dm6tLi3nJEjoBtQOS0TBkpkikjpb4TwgCLTghXr7Xr9NwJcVFSQlxUfSeE3hadEC5cwrOekxg85LQYQOT0OqsnWnebk4ioo7EKjoiINMEAIiIiTbSpCu6nIezZfZRa7Gx1DcJCDKyS6iI2Z5jEcFcXrU+Duiml2xlsaVMAtfagRLN8fbQ+BWqGn2fqbKyCIyIiTTCAiIhIEwwgIiLSBAOIiIg0YVcnBDYYU3dmCDGK5qNNp2WYxJ69ZV1iOgQPT28xdYonQpv1CjSEGEVVdY3SZu2On3Nqb0crD6iW2xVA7C5LjubosRPIM6UiYU1/q3DqTIYQo4iJXIywiBVanQIAfsZJGxyKhxzKWZkrhj4W4681MOebJA/3iSJpVSzcXF1ES76AY+ISRXnFEavlHu4TkfDT/EH22JxhEjpfHxQUFssO03NHjx5W28g9P6Luim1A5FDq6m5YLRs/dozsuubCYtTduIGCwmIcqXzbrnl/lMIHAMorjiAmLtHmPjw8vcWRyrdFQWExrl77Cnv2lsmu58YbQ8nBMYDIoZjzTVLzqQ/cXIfJrlteViKZtuYDqL8JM8+UCkOIUTFA1MKncZ82QsgQYhR5ptTGmz5NW/MV26Hkzpszp5Ij4ZuZHM7u4hKRnJrZZJla9diRt94WK6L+OwrALF8fqzYRe8LH1vE2Z5hEQWFx4+OkxFhMfOJx2XPy8PQWdXV1TZaprU/UHbENiByOXDuJ1xRPJMRFya5v2rq9yeOGKjnza/VhMXBgf5QqVJMpKa84gqT1G0Vt7SUAgO5FH6uhbpof19LUKZ4wW4QVAFRVsf2HHAt/TZFDOv/Rx8IvMMKDVCsAAAPaSURBVLTJMjdXF8UqrLx8szDl5HfKuQGAIUAPP71O8fN3+fJlMUMX0GRZn973ck4hcihsAyKHVH7osNWyiPBgKHU0MBcWo6ggt6NPCwBQVJBrdXVjKWl9ilX4JCXGMnzI4TCAyCHt2VtmFSj+hjBMneIpu75lhwR7FRXkwsN9YouDS63jgYent9D5TrNaXvpGy6oAiboD/qIih5W0PkWU7t1ntVytKq55hwQlRQW5WBEVD3O+SdLpDSIpMRYzZvnbPicbHQnkOlCkpazF6FGP8rNKDodvanJocoFSZM5BWMQK2Sotnd4gxo99zOZ+jx47AXO+qXH71m5nSamnnVpgEnVnfFOTQ9PpDaL2wkWr5Zs3JmFFdEKXGAsOqD/PpFUxaN72syg8GNN9vLvEORK1N7YBkUP7acgdq+VhESuQtCpGsVNCZ/Lw9BYR4UFW4VNUkIusHOWu2kTdHX9ZkVOQa1sBtL8S8vD0FkmrYmQHI2XVGzk6vrnJaZw89YEINS63Wq5VCKmFj87Xx2p6BiJHwzc4OQ0PT2+xNjEWSiG0MXWLYgeB5vLyzWLggP6Nj2svXFK9sbQ5nd4goiMXw98QZlXGdh8iIgfk4ektTp76QIyfMMnq3+XLl4XaYKSWjrz1dpNtj7z1tt1tSYYQo7h8+bLsOewuLtG8TYqos7ATAjmV8rISaXlUPNJS1lqVzdAFoKq6BpszTB0WApszTKKqusaqwwHAKx9yPgwgcjrlZSXS6FGPSovCg2XLWzI/kL2m+uga5wCSw/AhZ8QAIqc13cdbMgToZcsa5gdatDSqzSGUtH6jqO/oID/CgiFAz/Ahp8QAIqfmp9dJSuO5zdAF4Oix43izbL+Y6qNrcRDp9AZxpPJtUbq3TLbKraggF+PHjmlR5wUiR8IAIqeXEBclrVBoFwKAVWs2YPPGJLvbhjw8vUVRcYmovXBR8aonLWUtVkTFI3l9IsOHnBYnpCNC/YgJV65eE4YAPeTmBWq4gjl3/iORrTA6gYent/Ca4ompUzxlr3gaGAL0WB4V32WGASLSCj8ARM0YQoxi0cIQNJ/QTk2ROQcAVIMnLzsNyZsyOLoB0U/4QSCSUT8vj4/s1VBLFRXkovSNfRzZgKgZfiCIVOj0BmGYNxf2zBEkZ1F4MMyFxZzNlEgGPxREdoiJSxS6F6fbXS2XlBgL82vFrG4jUsEPB5GdPDy9xdQpnvB6/lnF2U8XhQfjYMURBg8REbU/D09vkZZhEpe/+KJ+DLkvvhB5+eZW3StERETUYh6e3nYPXkpERERERERERERERERERERERB3k/wMWb0cQHHdfwwAAAABJRU5ErkJggg==" />
	<div class="logo">
		<span class="whitespace">&nbsp;</span>
		<div class="title" style="text-decoration:underline;">Phishing statistics</div>
		<div class="info">%client% - %date% - %from%<span class="pdfOnly"> - page %i/%j<span></div>
	</div>
</div>

<div id="global-pie" class="container">
	<div class="title_l2">Statistiques globales tout groupes confondus:</div>
	<div class="tbl">Nombre d'email ouvert<canvas class="chart_open"></canvas></div>
	<div class="tbl">Nombre de click sur les liens<canvas class="chart_link"></canvas></div>
	<div class="tbl">Nombre de formulaire remplis<canvas class="chart_form"></canvas></div>
	<div class="tbl">Nombre d'execution de macro VBA<canvas class="chart_vba"></canvas></div>
	<div class="tbl">Nombre d'execution de macro VBA vis &agrave; vis du nombre d'ouverture d'emails<canvas class="chart_ratio_vbaVSopen"></canvas></div>
	<hr />
</div>

<div class="pageBreak group1-pageBreak"></div>
<div id="group1-pie" class="container">
	<div><span class="title_l2">Statistiques pour les groupes:</span> <span class="listGroup">XXX,YYY,ZZZZ</span></div>
	<div class="tbl">Nombre d'email ouvert<canvas class="chart_open"></canvas></div>
	<div class="tbl">Nombre de click sur les liens<canvas class="chart_link"></canvas></div>
	<div class="tbl">Nombre de formulaire remplis<canvas class="chart_form"></canvas></div>
	<div class="tbl">Nombre d'execution de macro VBA<canvas class="chart_vba"></canvas></div>
	<hr />
</div>

<div class="pageBreak group2-pageBreak"></div>
<div id="group2-pie" class="container">
	<div><span class="title_l2">Statistiques pour les groupes:</span> <span class="listGroup">XXX,YYY,ZZZZ</span></div>
	<div class="tbl">Nombre d'email ouvert<canvas class="chart_open"></canvas></div>
	<div class="tbl">Nombre de click sur les liens<canvas class="chart_link"></canvas></div>
	<div class="tbl">Nombre de formulaire remplis<canvas class="chart_form"></canvas></div>
	<div class="tbl">Nombre d'execution de macro VBA<canvas class="chart_vba"></canvas></div>
	<hr />
</div>

<div class="pageBreak group3-pageBreak"></div>
<div id="group3-pie" class="container">
	<div><span class="title_l2">Statistiques pour les groupes:</span> <span class="listGroup">XXX,YYY,ZZZZ</span></div>
	<div class="tbl">Nombre d'email ouvert<canvas class="chart_open"></canvas></div>
	<div class="tbl">Nombre de click sur les liens<canvas class="chart_link"></canvas></div>
	<div class="tbl">Nombre de formulaire remplis<canvas class="chart_form"></canvas></div>
	<div class="tbl">Nombre d'execution de macro VBA<canvas class="chart_vba"></canvas></div>
	<hr />
</div>

	<!--
	<div id="global-time">
	<h1 style="font-size:26px">Evolution de la propagation tout groupes confondus:</h1>
	<img src="time lap 10h/j 4 courbes" />
	</div>
	
	<div id="group1-time">
		<h1 style="font-size:26px">Evolution de la propagation pour le groupe <span class="listGroup">XXX,YYY,ZZZZ</span>:</h1>
		<img src="time lap 10h/j 4 courbes" />
	</div>
	
	<div id="group2-time">
		<h1 style="font-size:26px">Evolution de la propagation pour le groupe <span class="listGroup">XXX,YYY,ZZZZ</span>:</h1>
		<img src="time lap 10h/j 4 courbes" />
	</div>
	
	<div id="group3-time">
		<h1 style="font-size:26px">Evolution de la propagation pour le groupe <span class="listGroup">XXX,YYY,ZZZZ</span>:</h1>
		<img src="time lap 10h/j 4 courbes" />
	</div>
	-->
</div>
</body></html>